{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - My Projects{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'dashboard/css/ux-enhancements.css' %}">
{% endblock %}

{% block content %}
<section class="dashboard-section">

  <!-- ========== FASE 2.1: ANALYTICS & STATISTICS (Collapsible) ========== -->
  <div class="mb-4">
    <!-- Toggle Button for Analytics -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">
        <i class="fas fa-chart-line"></i> Analytics & Statistics
      </h5>
      <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#analyticsSection" aria-expanded="false" aria-controls="analyticsSection">
        <i class="fas fa-chevron-down" id="analyticsChevron"></i> <span id="analyticsToggleText">Tampilkan</span>
      </button>
    </div>

    <!-- Collapsible Analytics Content (Default Hidden) -->
    <div class="collapse" id="analyticsSection">
      <!-- Summary Cards -->
      <div class="row g-3 mb-4">
      <!-- Total Projects -->
      <div class="col-md-3">
        <div class="card border-primary shadow-sm h-100">
          <div class="card-body text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
              <i class="fas fa-project-diagram fa-2x text-primary me-2"></i>
              <h3 class="mb-0 text-primary">{{ analytics.total_projects }}</h3>
            </div>
            <p class="text-muted mb-0 small">Total Projects</p>
          </div>
        </div>
      </div>

      <!-- Total Budget -->
      <div class="col-md-3">
        <div class="card border-success shadow-sm h-100">
          <div class="card-body text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
              <i class="fas fa-money-bill-wave fa-2x text-success me-2"></i>
              <h3 class="mb-0 text-success">Rp {{ analytics.total_anggaran|floatformat:0|intcomma }}</h3>
            </div>
            <p class="text-muted mb-0 small">Total Anggaran</p>
          </div>
        </div>
      </div>

      <!-- Projects This Year -->
      <div class="col-md-3">
        <div class="card border-info shadow-sm h-100">
          <div class="card-body text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
              <i class="fas fa-calendar-alt fa-2x text-info me-2"></i>
              <h3 class="mb-0 text-info">{{ analytics.projects_this_year }}</h3>
            </div>
            <p class="text-muted mb-0 small">Projects Tahun Ini</p>
          </div>
        </div>
      </div>

      <!-- Active Projects -->
      <div class="col-md-3">
        <div class="card border-warning shadow-sm h-100">
          <div class="card-body text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
              <i class="fas fa-tasks fa-2x text-warning me-2"></i>
              <h3 class="mb-0 text-warning">{{ analytics.active_projects_count }}</h3>
            </div>
            <p class="text-muted mb-0 small">Projects Aktif</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3 mb-4">
      <!-- Projects by Year Chart -->
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Projects per Tahun</h6>
          </div>
          <div class="card-body">
            <canvas id="projectsByYearChart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Projects by Sumber Dana Chart -->
      <div class="col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Projects per Sumber Dana</h6>
          </div>
          <div class="card-body">
            <canvas id="projectsBySumberChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts Row -->
    <div class="row g-3 mb-4">
      <!-- Upcoming Deadlines -->
      {% if analytics.upcoming_deadlines %}
      <div class="col-lg-6">
        <div class="card border-warning shadow-sm">
          <div class="card-header bg-warning text-dark">
            <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Deadline Terdekat (7 Hari)</h6>
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              {% for project in analytics.upcoming_deadlines %}
              <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div>
                  <a href="{% url 'dashboard:project_detail' project.pk %}" class="text-decoration-none">
                    <strong>{{ project.nama|truncatewords:5 }}</strong>
                  </a>
                  <br>
                  <small class="text-muted">{{ project.tanggal_selesai|date:"d M Y" }}</small>
                </div>
                <span class="badge bg-warning text-dark">{{ project.tanggal_selesai|timeuntil }}</span>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Overdue Projects -->
      {% if analytics.overdue_projects %}
      <div class="col-lg-6">
        <div class="card border-danger shadow-sm">
          <div class="card-header bg-danger text-white">
            <h6 class="mb-0"><i class="fas fa-clock"></i> Projects Terlambat</h6>
          </div>
          <div class="card-body">
            <div class="list-group list-group-flush">
              {% for project in analytics.overdue_projects %}
              <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <div>
                  <a href="{% url 'dashboard:project_detail' project.pk %}" class="text-decoration-none">
                    <strong>{{ project.nama|truncatewords:5 }}</strong>
                  </a>
                  <br>
                  <small class="text-muted">Deadline: {{ project.tanggal_selesai|date:"d M Y" }}</small>
                </div>
                <span class="badge bg-danger">{{ project.tanggal_selesai|timesince }} lalu</span>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    </div><!-- End collapse -->
  </div>
  <!-- ========== END ANALYTICS & STATISTICS ========== -->

  <!-- JavaScript for Analytics Toggle -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const analyticsSection = document.getElementById('analyticsSection');
      const analyticsChevron = document.getElementById('analyticsChevron');
      const analyticsToggleText = document.getElementById('analyticsToggleText');

      analyticsSection.addEventListener('show.bs.collapse', function () {
        analyticsChevron.classList.remove('fa-chevron-down');
        analyticsChevron.classList.add('fa-chevron-up');
        analyticsToggleText.textContent = 'Sembunyikan';
      });

      analyticsSection.addEventListener('hide.bs.collapse', function () {
        analyticsChevron.classList.remove('fa-chevron-up');
        analyticsChevron.classList.add('fa-chevron-down');
        analyticsToggleText.textContent = 'Tampilkan';
      });
    });
  </script>

  <!-- FORMSET INPUT PROJECT -->
  <div class="mb-5">
    <div class="card">
      <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-plus"></i> Tambah Project Langsung</h5>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary active" id="formModeSimple">
              <i class="fas fa-list"></i> Mode Sederhana
            </button>
            <button type="button" class="btn btn-outline-primary" id="formModeFull">
              <i class="fas fa-th"></i> Mode Lengkap
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">

        <form id="project-formset-form" method="post" class="dashboard-form" novalidate autocomplete="off">
          {% csrf_token %}
          {{ formset.management_form }}

          <!-- Pastikan cabang POST di view selalu dieksekusi -->
          <input type="hidden" name="save_formset" value="1">

          {% if formset.non_form_errors %}
            <div class="alert alert-danger mb-3">
              {% for e in formset.non_form_errors %}• {{ e }}<br>{% endfor %}
            </div>
          {% endif %}

          <div class="dashboard-form-table-wrapper ux-scrollbar">
            <table class="table table-bordered align-middle text-nowrap" id="formset-table">
              <thead class="table-light dp-thead-sticky">
                <tr>
                  <th class="field-required">Nama Project <span class="text-danger">*</span></th>
                  <th class="field-required">Sumber Dana <span class="text-danger">*</span></th>
                  <th class="field-required">Lokasi Project <span class="text-danger">*</span></th>
                  <th class="field-required">Nama Client <span class="text-danger">*</span></th>
                  <th class="field-required">Anggaran Owner <span class="text-danger">*</span></th>
                  <th class="field-required">Tanggal Mulai <span class="text-danger">*</span></th>
                  <th class="field-optional">Tanggal Selesai</th>
                  <th class="field-optional">Durasi (hari)</th>
                  <th class="field-optional">Ket 1</th>
                  <th class="field-optional">Ket 2</th>
                  <th class="field-optional">Jabatan Client</th>
                  <th class="field-optional">Instansi Client</th>
                  <th class="field-optional">Nama Kontraktor</th>
                  <th class="field-optional">Instansi Kontraktor</th>
                  <th class="field-optional">Nama Konsultan Perencana</th>
                  <th class="field-optional">Instansi Konsultan Perencana</th>
                  <th class="field-optional">Nama Konsultan Pengawas</th>
                  <th class="field-optional">Instansi Konsultan Pengawas</th>
                </tr>
              </thead>

              <!-- rows yang dirender dari server -->
              <tbody id="formset-body">
                {% for form in formset %}
                  <tr class="formset-row">
                    <td class="field-required {% if form.nama.errors %}table-danger{% endif %}">
                      {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                      {{ form.nama }}
                      {% for err in form.nama.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-required {% if form.sumber_dana.errors %}table-danger{% endif %}">
                      {{ form.sumber_dana }}
                      {% for err in form.sumber_dana.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-required {% if form.lokasi_project.errors %}table-danger{% endif %}">
                      {{ form.lokasi_project }}
                      {% for err in form.lokasi_project.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-required {% if form.nama_client.errors %}table-danger{% endif %}">
                      {{ form.nama_client }}
                      {% for err in form.nama_client.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-required {% if form.anggaran_owner.errors %}table-danger{% endif %}">
                      {{ form.anggaran_owner }}
                      {% for err in form.anggaran_owner.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-required {% if form.tanggal_mulai.errors %}table-danger{% endif %}">
                      {{ form.tanggal_mulai }}
                      {% for err in form.tanggal_mulai.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-optional {% if form.tanggal_selesai.errors %}table-danger{% endif %}">
                      {{ form.tanggal_selesai }}
                      {% for err in form.tanggal_selesai.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-optional {% if form.durasi_hari.errors %}table-danger{% endif %}">
                      {{ form.durasi_hari }}
                      {% for err in form.durasi_hari.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="field-optional">{{ form.ket_project1 }}</td>
                    <td class="field-optional">{{ form.ket_project2 }}</td>
                    <td class="field-optional">{{ form.jabatan_client }}</td>
                    <td class="field-optional">{{ form.instansi_client }}</td>
                    <td class="field-optional">{{ form.nama_kontraktor }}</td>
                    <td class="field-optional">{{ form.instansi_kontraktor }}</td>
                    <td class="field-optional">{{ form.nama_konsultan_perencana }}</td>
                    <td class="field-optional">{{ form.instansi_konsultan_perencana }}</td>
                    <td class="field-optional">{{ form.nama_konsultan_pengawas }}</td>
                    <td class="field-optional">{{ form.instansi_konsultan_pengawas }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="text-end mt-3 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-danger btn-sm" id="remove-row-btn">
              <i class="fas fa-trash"></i> Hapus Baris Terakhir
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="add-row-btn">
              <i class="fas fa-plus-circle"></i> Tambah Baris
            </button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save"></i> Simpan Project
            </button>
          </div>
        </form>

        <!-- Template kosong aman (di luar <form>) -->
        <template id="empty-form-template" data-prefix="{{ formset.prefix }}">
          <tr class="formset-row">
            <td class="field-required">
              {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
              {{ formset.empty_form.nama }}
            </td>
            <td class="field-required">{{ formset.empty_form.sumber_dana }}</td>
            <td class="field-required">{{ formset.empty_form.lokasi_project }}</td>
            <td class="field-required">{{ formset.empty_form.nama_client }}</td>
            <td class="field-required">{{ formset.empty_form.anggaran_owner }}</td>
            <td class="field-required">{{ formset.empty_form.tanggal_mulai }}</td>
            <td class="field-optional">{{ formset.empty_form.tanggal_selesai }}</td>
            <td class="field-optional">{{ formset.empty_form.durasi_hari }}</td>
            <td class="field-optional">{{ formset.empty_form.ket_project1 }}</td>
            <td class="field-optional">{{ formset.empty_form.ket_project2 }}</td>
            <td class="field-optional">{{ formset.empty_form.jabatan_client }}</td>
            <td class="field-optional">{{ formset.empty_form.instansi_client }}</td>
            <td class="field-optional">{{ formset.empty_form.nama_kontraktor }}</td>
            <td class="field-optional">{{ formset.empty_form.instansi_kontraktor }}</td>
            <td class="field-optional">{{ formset.empty_form.nama_konsultan_perencana }}</td>
            <td class="field-optional">{{ formset.empty_form.instansi_konsultan_perencana }}</td>
            <td class="field-optional">{{ formset.empty_form.nama_konsultan_pengawas }}</td>
            <td class="field-optional">{{ formset.empty_form.instansi_konsultan_pengawas }}</td>
          </tr>
        </template>

      </div>
    </div>
  </div>

  <!-- TABEL & REKAP PROJECT -->
  <div class="dashboard-section-summary-table">
    {% include 'dashboard/_project_stats_and_table.html' %}
  </div>

  <!-- ========== FASE 2.4: EXPORT & UPLOAD ACTIONS ========== -->
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <!-- Export Dropdown (Left side) -->
    <div class="btn-group">
      <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-download"></i> Export Data
      </button>
      <ul class="dropdown-menu">
        <li>
          <a class="dropdown-item" href="{% url 'dashboard:export_excel' %}?{{ request.GET.urlencode }}">
            <i class="fas fa-file-excel text-success"></i> Export ke Excel (.xlsx)
          </a>
        </li>
        <li>
          <a class="dropdown-item" href="{% url 'dashboard:export_csv' %}?{{ request.GET.urlencode }}">
            <i class="fas fa-file-csv text-info"></i> Export ke CSV (.csv)
          </a>
        </li>
      </ul>
    </div>

    <!-- Upload Button (Right side) -->
    <div>
      <a href="{% url 'dashboard:project_upload' %}" class="btn btn-outline-primary btn-sm">
        <i class="fas fa-file-upload"></i> Upload dari Excel
      </a>
    </div>
  </div>
  <!-- ========== END EXPORT & UPLOAD ACTIONS ========== -->

  <!-- ========== FLOATING ACTION BUTTON (FAB) ========== -->
  <div class="quick-actions-fab">
    <button type="button" class="fab-main" id="fabMainBtn" aria-label="Quick Actions" title="Quick Actions">
      <i class="bi bi-plus-lg fab-icon"></i>
    </button>

    <!-- FAB Menu -->
    <div class="fab-menu" id="fabMenu">
      <a href="#" class="fab-action" id="fabScrollToForm" title="Tambah Project via Form">
        <i class="bi bi-file-earmark-plus"></i>
        <span class="fab-label">Tambah via Form</span>
      </a>
      <a href="{% url 'dashboard:project_upload' %}" class="fab-action" title="Upload dari Excel">
        <i class="bi bi-file-earmark-arrow-up"></i>
        <span class="fab-label">Upload Excel</span>
      </a>
      <a href="#" class="fab-action" id="fabScrollToTop" title="Kembali ke Atas">
        <i class="bi bi-arrow-up-circle"></i>
        <span class="fab-label">Ke Atas</span>
      </a>
      <button type="button" class="fab-action" id="fabToggleAnalytics" title="Toggle Analytics">
        <i class="bi bi-bar-chart-line"></i>
        <span class="fab-label">Analytics</span>
      </button>
    </div>
  </div>
  <!-- ========== END FLOATING ACTION BUTTON ========== -->

</section>
{% endblock %}

{% block extra_js %}
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- FASE 2.1: Charts -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Projects by Year Chart
      const projectsByYearData = {{ chart_data.projects_by_year|safe }};
      if (projectsByYearData && projectsByYearData.length > 0) {
        const ctx1 = document.getElementById('projectsByYearChart');
        if (ctx1) {
          new Chart(ctx1, {
            type: 'bar',
            data: {
              labels: projectsByYearData.map(item => item.tahun_project || 'N/A'),
              datasets: [{
                label: 'Jumlah Projects',
                data: projectsByYearData.map(item => item.count),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false
                },
                title: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
        }
      }

      // Projects by Sumber Dana Chart
      const projectsBySumberData = {{ chart_data.projects_by_sumber|safe }};
      if (projectsBySumberData && projectsBySumberData.length > 0) {
        const ctx2 = document.getElementById('projectsBySumberChart');
        if (ctx2) {
          // Generate random colors for each sumber dana
          const colors = projectsBySumberData.map((item, index) => {
            const hue = (index * 137.5) % 360; // Golden angle for color distribution
            return `hsla(${hue}, 70%, 60%, 0.7)`;
          });

          new Chart(ctx2, {
            type: 'pie',
            data: {
              labels: projectsBySumberData.map(item => item.sumber_dana || 'N/A'),
              datasets: [{
                data: projectsBySumberData.map(item => item.count),
                backgroundColor: colors,
                borderWidth: 1,
                borderColor: '#fff'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    boxWidth: 15,
                    font: {
                      size: 11
                    }
                  }
                }
              }
            }
          });
        }
      }
    });
  </script>

  <!-- FASE 2.2: Advanced Filter JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Auto-expand filter panel if any filter is active
      const filterForm = document.getElementById('filterForm');
      const filterPanel = document.getElementById('filterPanel');

      if (filterForm && filterPanel) {
        // Check if URL has any query parameters (excluding page)
        const urlParams = new URLSearchParams(window.location.search);
        const hasActiveFilters = Array.from(urlParams.keys()).some(key =>
          key !== 'page' && urlParams.get(key) !== ''
        );

        // Auto-expand if filters are active
        if (hasActiveFilters) {
          const collapseInstance = new bootstrap.Collapse(filterPanel, {
            toggle: false
          });
          collapseInstance.show();
        }

        // Update toggle button icon
        const toggleBtn = document.querySelector('[data-bs-target="#filterPanel"]');
        if (toggleBtn) {
          filterPanel.addEventListener('show.bs.collapse', function () {
            toggleBtn.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
          });

          filterPanel.addEventListener('hide.bs.collapse', function () {
            toggleBtn.querySelector('i').classList.replace('fa-chevron-up', 'fa-chevron-down');
          });
        }
      }

      // Optional: Save filter preferences to localStorage
      // (Can be implemented later if needed)

      // Highlight active filter count
      if (filterForm) {
        const formData = new FormData(filterForm);
        let activeFilterCount = 0;

        for (let [key, value] of formData.entries()) {
          if (value && value.trim() !== '' && key !== 'csrfmiddlewaretoken') {
            activeFilterCount++;
          }
        }

        if (activeFilterCount > 0) {
          const filterHeader = document.querySelector('.card-header h6');
          if (filterHeader && !filterHeader.querySelector('.badge')) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary ms-2';
            badge.textContent = activeFilterCount;
            filterHeader.appendChild(badge);
          }
        }
      }
    });
  </script>

  <script src="{% static 'dashboard/js/formset.js' %}" defer></script>
  <script src="{% static 'dashboard/js/dashboard.js' %}" defer></script>
  <!-- UX Enhancements JavaScript -->
  <script src="{% static 'dashboard/js/ux-enhancements.js' %}" defer></script>
  <!-- Resizable Columns JavaScript -->
  <script src="{% static 'dashboard/js/resizable-columns.js' %}" defer></script>
{% endblock %}
