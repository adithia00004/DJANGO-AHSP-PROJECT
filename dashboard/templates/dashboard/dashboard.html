{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - My Projects{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<section class="dashboard-section">

  <!-- FORMSET INPUT PROJECT -->
  <div class="mb-5">
    <div class="card">
      <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-plus"></i> Tambah Project Langsung</h5>
      </div>
      <div class="card-body">

        <form id="project-formset-form" method="post" class="dashboard-form" novalidate autocomplete="off">
          {% csrf_token %}
          {{ formset.management_form }}

          <!-- Pastikan cabang POST di view selalu dieksekusi -->
          <input type="hidden" name="save_formset" value="1">

          {% if formset.non_form_errors %}
            <div class="alert alert-danger mb-3">
              {% for e in formset.non_form_errors %}• {{ e }}<br>{% endfor %}
            </div>
          {% endif %}

          <div class="dashboard-form-table-wrapper ux-scrollbar">
            <table class="table table-bordered align-middle text-nowrap" id="formset-table">
              <thead class="table-light dp-thead-sticky">
                <tr>
                  <th>Nama Project <span class="text-danger">*</span></th>
                  <th>Tahun Project <span class="text-danger">*</span></th>
                  <th>Sumber Dana <span class="text-danger">*</span></th>
                  <th>Lokasi Project <span class="text-danger">*</span></th>
                  <th>Nama Client <span class="text-danger">*</span></th>
                  <th>Anggaran Owner <span class="text-danger">*</span></th>
                  <th>Ket 1</th>
                  <th>Ket 2</th>
                  <th>Jabatan Client</th>
                  <th>Instansi Client</th>
                  <th>Nama Kontraktor</th>
                  <th>Instansi Kontraktor</th>
                  <th>Nama Konsultan Perencana</th>
                  <th>Instansi Konsultan Perencana</th>
                  <th>Nama Konsultan Pengawas</th>
                  <th>Instansi Konsultan Pengawas</th>
                </tr>
              </thead>

              <!-- rows yang dirender dari server -->
              <tbody id="formset-body">
                {% for form in formset %}
                  <tr class="formset-row">
                    <td class="{% if form.nama.errors %}table-danger{% endif %}">
                      {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                      {{ form.nama }}
                      {% for err in form.nama.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="{% if form.tahun_project.errors %}table-danger{% endif %}">
                      {{ form.tahun_project }}
                      {% for err in form.tahun_project.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="{% if form.sumber_dana.errors %}table-danger{% endif %}">
                      {{ form.sumber_dana }}
                      {% for err in form.sumber_dana.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="{% if form.lokasi_project.errors %}table-danger{% endif %}">
                      {{ form.lokasi_project }}
                      {% for err in form.lokasi_project.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="{% if form.nama_client.errors %}table-danger{% endif %}">
                      {{ form.nama_client }}
                      {% for err in form.nama_client.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td class="{% if form.anggaran_owner.errors %}table-danger{% endif %}">
                      {{ form.anggaran_owner }}
                      {% for err in form.anggaran_owner.errors %}<div class="text-danger small">⚠️ {{ err }}</div>{% endfor %}
                    </td>
                    <td>{{ form.ket_project1 }}</td>
                    <td>{{ form.ket_project2 }}</td>
                    <td>{{ form.jabatan_client }}</td>
                    <td>{{ form.instansi_client }}</td>
                    <td>{{ form.nama_kontraktor }}</td>
                    <td>{{ form.instansi_kontraktor }}</td>
                    <td>{{ form.nama_konsultan_perencana }}</td>
                    <td>{{ form.instansi_konsultan_perencana }}</td>
                    <td>{{ form.nama_konsultan_pengawas }}</td>
                    <td>{{ form.instansi_konsultan_pengawas }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="text-end mt-3 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-danger btn-sm" id="remove-row-btn">
              <i class="fas fa-trash"></i> Hapus Baris Terakhir
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="add-row-btn">
              <i class="fas fa-plus-circle"></i> Tambah Baris
            </button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save"></i> Simpan Project
            </button>
          </div>
        </form>

        <!-- Template kosong aman (di luar <form>) -->
        <template id="empty-form-template" data-prefix="{{ formset.prefix }}">
          <tr class="formset-row">
            <td>
              {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
              {{ formset.empty_form.nama }}
            </td>
            <td>{{ formset.empty_form.tahun_project }}</td>
            <td>{{ formset.empty_form.sumber_dana }}</td>
            <td>{{ formset.empty_form.lokasi_project }}</td>
            <td>{{ formset.empty_form.nama_client }}</td>
            <td>{{ formset.empty_form.anggaran_owner }}</td>
            <td>{{ formset.empty_form.ket_project1 }}</td>
            <td>{{ formset.empty_form.ket_project2 }}</td>
            <td>{{ formset.empty_form.jabatan_client }}</td>
            <td>{{ formset.empty_form.instansi_client }}</td>
            <td>{{ formset.empty_form.nama_kontraktor }}</td>
            <td>{{ formset.empty_form.instansi_kontraktor }}</td>
            <td>{{ formset.empty_form.nama_konsultan_perencana }}</td>
            <td>{{ formset.empty_form.instansi_konsultan_perencana }}</td>
            <td>{{ formset.empty_form.nama_konsultan_pengawas }}</td>
            <td>{{ formset.empty_form.instansi_konsultan_pengawas }}</td>
          </tr>
        </template>

      </div>
    </div>
  </div>

  <!-- TABEL & REKAP PROJECT -->
  <div class="dashboard-section-summary-table">
    {% include 'dashboard/_project_stats_and_table.html' %}
  </div>

  <!-- Tombol Upload Excel -->
  <div class="mb-3 d-flex justify-content-end">
    <a href="{% url 'dashboard:project_upload' %}" class="btn btn-outline-primary btn-sm">
      <i class="fas fa-file-upload"></i> Upload dari Excel
    </a>
  </div>

</section>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'dashboard/js/formset.js' %}" defer></script>
  <script src="{% static 'dashboard/js/dashboard.js' %}" defer></script>
{% endblock %}
