{% load static %}
{% load widget_tweaks %}
{% load humanize %}

<!-- ========== ADVANCED FILTERING ========== -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-0">
        <i class="fas fa-filter"></i> Filter & Pencarian
      </h6>
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
        data-bs-target="#filterPanel" aria-expanded="false" aria-controls="filterPanel">
        <i class="fas fa-chevron-down" id="filterChevron"></i> <span id="filterToggleText">Tampilkan Filter</span>
      </button>
    </div>
  </div>
  <div class="collapse" id="filterPanel">
    <div class="card-body">
      <form method="get" action="{% url 'dashboard:dashboard' %}" id="filterForm">
        <div class="row g-3">
          <!-- Basic Search -->
          <div class="col-md-6">
            <label for="{{ filter_form.search.id_for_label }}" class="form-label">
              {{ filter_form.search.label }}
            </label>
            {{ filter_form.search }}
          </div>

          <!-- Sort By -->
          <div class="col-md-3">
            <label for="{{ filter_form.sort_by.id_for_label }}" class="form-label">
              {{ filter_form.sort_by.label }}
            </label>
            {{ filter_form.sort_by }}
          </div>

          <!-- Year Filter -->
          <div class="col-md-3">
            <label for="{{ filter_form.tahun_project.id_for_label }}" class="form-label">
              {{ filter_form.tahun_project.label }}
            </label>
            {{ filter_form.tahun_project }}
          </div>

          <!-- Sumber Dana Filter -->
          <div class="col-md-3">
            <label for="{{ filter_form.sumber_dana.id_for_label }}" class="form-label">
              {{ filter_form.sumber_dana.label }}
            </label>
            {{ filter_form.sumber_dana }}
          </div>

          <!-- Timeline Status Filter -->
          <div class="col-md-3">
            <label for="{{ filter_form.status_timeline.id_for_label }}" class="form-label">
              {{ filter_form.status_timeline.label }}
            </label>
            {{ filter_form.status_timeline }}
          </div>

          <!-- Budget Range -->
          <div class="col-md-3">
            <label class="form-label">Rentang Anggaran</label>
            <div class="input-group input-group-sm">
              {{ filter_form.anggaran_min }}
              <span class="input-group-text">s/d</span>
              {{ filter_form.anggaran_max }}
            </div>
          </div>

          <!-- Date Range -->
          <div class="col-md-6">
            <label class="form-label">Rentang Waktu Aktif</label>
            <div class="input-group input-group-sm">
              {{ filter_form.tanggal_mulai_from }}
              <span class="input-group-text">s/d</span>
              {{ filter_form.tanggal_mulai_to }}
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="col-12">
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-search"></i> Terapkan Filter
              </button>
              <a href="{% url 'dashboard:dashboard' %}" class="btn btn-outline-secondary btn-sm" id="resetFilter">
                <i class="fas fa-redo"></i> Reset
              </a>
              <small class="text-muted align-self-center ms-auto">
                Menampilkan {{ total_projects }} project
              </small>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- ========== END ADVANCED FILTERING ========== -->

<!-- ========== UNIFIED TOOLBAR ========== -->
<div class="dashboard-unified-toolbar mb-3">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
    <!-- Left: Primary Actions -->
    <div class="d-flex flex-wrap align-items-center gap-2">
      <!-- Add Project (opens modal) -->
      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProjectModal">
        <i class="fas fa-plus"></i> <span class="d-none d-sm-inline">Tambah Project</span>
      </button>

      <!-- Import JSON -->
      <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal"
        data-bs-target="#importProjectModal">
        <i class="fas fa-file-import"></i> <span class="d-none d-md-inline">Import JSON</span>
      </button>

      <!-- Upload Excel -->
      <a href="{% url 'dashboard:project_upload' %}" class="btn btn-outline-success btn-sm">
        <i class="fas fa-file-excel"></i> <span class="d-none d-md-inline">Upload Excel</span>
      </a>

      <!-- Export Filtered (New) -->
      <a href="{% url 'dashboard:export_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success btn-sm ms-1"
        title="Export data yang tampil saat ini dengan kolom lengkap">
        <i class="fas fa-file-export"></i> <span class="d-none d-md-inline">Export Full</span>
      </a>

      <div class="vr d-none d-sm-block"></div>

      <!-- Bulk Edit Toggle -->
      <button type="button" class="btn btn-outline-warning btn-sm" id="bulkModeToggleBtn"
        title="Aktifkan mode edit project">
        <i class="fas fa-tasks"></i> <span class="d-none d-md-inline">Edit Project</span>
      </button>
    </div>

    <!-- Right: Filter Toggle & Search -->
    <div class="d-flex align-items-center gap-2">
      <!-- Quick Search -->
      <div class="input-group input-group-sm" style="max-width: 250px;">
        <input type="text" class="form-control" id="quickSearchInput" placeholder="Cari project...">
        <button class="btn btn-outline-secondary" type="button" id="quickSearchBtn">
          <i class="fas fa-search"></i>
        </button>
      </div>

      <!-- Filter Toggle -->
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse"
        data-bs-target="#filterPanel" aria-expanded="false">
        <i class="fas fa-filter"></i> <span class="d-none d-md-inline">Filter</span>
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar (hidden by default, shown when bulk mode active) -->
  <div class="card shadow-sm mt-2" id="bulkActionsBar" style="display: none;">
    <div class="card-body py-2 bg-warning-subtle">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span id="selectedCount" class="badge bg-primary me-2">0</span>
          <span class="text-muted">project dipilih</span>
        </div>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-primary" id="massEditToggleBtn" title="Edit langsung di tabel">
            <i class="fas fa-edit"></i> Edit Data
          </button>
          <button type="button" class="btn btn-outline-danger" id="bulkDeleteBtn" title="Hapus project terpilih">
            <i class="fas fa-trash"></i> Hapus
          </button>
          <button type="button" class="btn btn-outline-secondary" id="bulkCancelBtn" title="Batal">
            <i class="fas fa-times"></i> Batal
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mass Edit Action Bar (hidden by default) -->
  <div class="card shadow-sm mt-2 border-warning" id="massEditActionBar" style="display: none;">
    <div class="card-body py-2 bg-warning-subtle">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <i class="fas fa-edit text-warning me-2"></i>
          <strong class="text-warning">Mode Edit Aktif</strong>
          <small class="text-muted ms-2 d-none d-md-inline">| Edit langsung di tabel</small>
        </div>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-success" id="massEditSaveAllBtn" title="Simpan semua perubahan">
            <i class="fas fa-save"></i> Simpan
          </button>
          <button type="button" class="btn btn-secondary" id="massEditCancelBtn" title="Batal">
            <i class="fas fa-times"></i> Batal
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ========== END UNIFIED TOOLBAR ========== -->

<!-- Tabel Proyek Ringkasan -->
<div class="dashboard-table-wrapper table-responsive shadow-sm ux-scrollbar">
  <!-- Desktop Table View -->
  <table class="dashboard-project-table table table-hover table-bordered align-middle">
    <thead class="table-light dp-thead-sticky">
      <tr>
        <th class="text-center checkbox-column" style="width: 40px;">
          <input type="checkbox" id="selectAll" class="form-check-input" title="Pilih semua">
        </th>
        <th style="width: 250px; min-width: 200px;">Nama Project</th>
        <th class="text-center" style="width: 160px;">Aksi</th>
        <th class="text-center" style="width: 100px;">Status</th>
        <th class="text-center" style="width: 130px;">Progress</th>
        <th>Nama Owner</th>
        <th>Anggaran</th>
        <th>Tanggal Mulai</th>
        <th>Tanggal Selesai</th>
      </tr>
    </thead>
    <tbody>
      {% for project in projects %}
      <tr data-project-id="{{ project.pk }}"
        data-search="{{ project.index_project|default:'' }} {{ project.nama|default:'' }} {{ project.tahun_project|default:'' }} {{ project.sumber_dana|default:'' }} {{ project.lokasi_project|default:'' }} {{ project.nama_client|default:'' }} {{ project.anggaran_owner|default:'' }} {{ project.tanggal_mulai|date:'Y-m-d'|default:'' }} {{ project.tanggal_selesai|date:'Y-m-d'|default:'' }} {{ project.durasi_hari|default:'' }} {{ project.ket_project1|default:'' }} {{ project.ket_project2|default:'' }} {{ project.jabatan_client|default:'' }} {{ project.instansi_client|default:'' }} {{ project.nama_kontraktor|default:'' }} {{ project.instansi_kontraktor|default:'' }} {{ project.nama_konsultan_perencana|default:'' }} {{ project.instansi_konsultan_perencana|default:'' }} {{ project.nama_konsultan_pengawas|default:'' }} {{ project.instansi_konsultan_pengawas|default:'' }} {{ project.deskripsi|default:'' }} {{ project.kategori|default:'' }}"
        data-nama="{{ project.nama|default:'' }}" data-sumber-dana="{{ project.sumber_dana|default:'' }}"
        data-lokasi-project="{{ project.lokasi_project|default:'' }}"
        data-nama-client="{{ project.nama_client|default:'' }}"
        data-anggaran-owner="{{ project.anggaran_owner|default:'' }}"
        data-tanggal-mulai="{{ project.tanggal_mulai|date:'Y-m-d'|default:'' }}"
        data-tanggal-selesai="{{ project.tanggal_selesai|date:'Y-m-d'|default:'' }}"
        data-durasi-hari="{{ project.durasi_hari|default:'' }}"
        data-ket-project1="{{ project.ket_project1|default:'' }}"
        data-ket-project2="{{ project.ket_project2|default:'' }}"
        data-jabatan-client="{{ project.jabatan_client|default:'' }}"
        data-instansi-client="{{ project.instansi_client|default:'' }}"
        data-nama-kontraktor="{{ project.nama_kontraktor|default:'' }}"
        data-instansi-kontraktor="{{ project.instansi_kontraktor|default:'' }}"
        data-nama-konsultan-perencana="{{ project.nama_konsultan_perencana|default:'' }}"
        data-instansi-konsultan-perencana="{{ project.instansi_konsultan_perencana|default:'' }}"
        data-nama-konsultan-pengawas="{{ project.nama_konsultan_pengawas|default:'' }}"
        data-instansi-konsultan-pengawas="{{ project.instansi_konsultan_pengawas|default:'' }}"
        data-deskripsi="{{ project.deskripsi|default:'' }}" data-kategori="{{ project.kategori|default:'' }}">

        <!-- Checkbox for mass edit -->
        <td class="text-center checkbox-column">
          <input type="checkbox" class="form-check-input project-checkbox" value="{{ project.pk }}"
            data-project-name="{{ project.nama }}">
        </td>

        <!-- Nama Project (wrapped text) -->
        <td style="white-space: normal; word-wrap: break-word;">
          <a href="{% url 'detail_project:list_pekerjaan' project.pk %}" class="text-decoration-none fw-medium"
            title="Lihat daftar pekerjaan">
            {{ project.nama|default:"—" }}
          </a>
        </td>

        <!-- Aksi -->
        <td class="text-center text-nowrap">
          <div class="d-inline-flex gap-1 project-action-icons">
            <a href="{% url 'detail_project:list_pekerjaan' project_id=project.pk %}"
              class="btn btn-sm btn-outline-success" title="Detail Pekerjaan" aria-label="Detail Pekerjaan">
              <i class="fas fa-list"></i>
            </a>
            <a href="{% url 'dashboard:project_edit' project.pk %}?next={{ request.get_full_path|urlencode }}"
              class="btn btn-sm btn-outline-warning" title="Edit Project" aria-label="Edit Project">
              <i class="fas fa-edit"></i>
            </a>
            <a href="/detail_project/api/project/{{ project.pk }}/export/full-backup/json/?include_progress=1"
              class="btn btn-sm btn-outline-info" title="Export Project (JSON)" aria-label="Export Project (JSON)"
              download>
              <i class="fas fa-download"></i>
            </a>
            <button type="button" class="btn btn-sm btn-outline-danger" title="Hapus Project" aria-label="Hapus Project"
              data-bs-toggle="modal" data-bs-target="#deleteModal-{{ project.pk }}">
              <i class="fas fa-trash"></i>
            </button>
          </div>

          <!-- Modal Konfirmasi Hapus -->
          <div class="modal fade" id="deleteModal-{{ project.pk }}" tabindex="-1"
            aria-labelledby="deleteModalLabel-{{ project.pk }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteModalLabel-{{ project.pk }}">Hapus Project</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                  Kamu yakin ingin menghapus project <strong>{{ project.nama }}</strong>?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                  <form method="post" action="{% url 'dashboard:project_delete' project.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="btn btn-danger">Ya, Hapus</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </td>

        <!-- Status -->
        <td class="text-center">
          {% if project.tanggal_selesai and project.tanggal_mulai %}
          {% if project.tanggal_selesai|date:"Y-m-d" < today_str %} <span class="badge bg-danger">Selesai</span>
            {% elif project.tanggal_selesai|date:"Y-m-d" <= deadline_threshold_str %} <span
              class="badge bg-warning text-dark">Deadline</span>
              {% elif project.tanggal_mulai|date:"Y-m-d" > today_str %}
              <span class="badge bg-secondary">Belum Mulai</span>
              {% else %}
              <span class="badge bg-success">Berjalan</span>
              {% endif %}
              {% else %}
              <span class="badge bg-light text-dark">—</span>
              {% endif %}
        </td>

        <!-- Progress Realisasi -->
        <td class="text-center">
          <div class="progress position-relative" style="height: 22px; min-width: 90px;"
            title="Progress Realisasi: {{ project.progress_realisasi|floatformat:1 }}%">
            <div
              class="progress-bar {% if project.progress_realisasi >= 100 %}bg-success{% elif project.progress_realisasi >= 50 %}bg-info{% elif project.progress_realisasi > 0 %}bg-warning{% else %}bg-secondary{% endif %}"
              role="progressbar" style="width: {{ project.progress_realisasi|floatformat:0 }}%"
              aria-valuenow="{{ project.progress_realisasi|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100">
            </div>
            <span class="position-absolute w-100 text-center fw-bold progress-text"
              style="top: 50%; left: 0; transform: translateY(-50%); font-size: 11px; z-index: 2; mix-blend-mode: difference; color: #fff;">
              {{ project.progress_realisasi|floatformat:1 }}%
            </span>
          </div>
        </td>

        <!-- Nama Client -->
        <td>{{ project.nama_client|default:"—" }}</td>

        <!-- Anggaran -->
        <td class="text-nowrap">Rp{{ project.anggaran_owner|default:0|floatformat:0|intcomma }}</td>

        <!-- Tanggal Mulai -->
        <td class="text-nowrap">{{ project.tanggal_mulai|date:"d M Y"|default:"—" }}</td>

        <!-- Tanggal Selesai -->
        <td class="text-nowrap">{{ project.tanggal_selesai|date:"d M Y"|default:"—" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="text-center text-muted">Belum ada proyek yang ditambahkan.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Mobile Card View (shows on screens < 992px) -->
  {% for project in projects %}
  <div class="project-mobile-card" style="display: none;"
    data-search="{{ project.index_project|default:'' }} {{ project.nama|default:'' }} {{ project.tahun_project|default:'' }} {{ project.sumber_dana|default:'' }} {{ project.lokasi_project|default:'' }} {{ project.nama_client|default:'' }} {{ project.anggaran_owner|default:'' }} {{ project.tanggal_mulai|date:'Y-m-d'|default:'' }} {{ project.tanggal_selesai|date:'Y-m-d'|default:'' }} {{ project.durasi_hari|default:'' }} {{ project.ket_project1|default:'' }} {{ project.ket_project2|default:'' }} {{ project.jabatan_client|default:'' }} {{ project.instansi_client|default:'' }} {{ project.nama_kontraktor|default:'' }} {{ project.instansi_kontraktor|default:'' }} {{ project.nama_konsultan_perencana|default:'' }} {{ project.instansi_konsultan_perencana|default:'' }} {{ project.nama_konsultan_pengawas|default:'' }} {{ project.instansi_konsultan_pengawas|default:'' }} {{ project.deskripsi|default:'' }} {{ project.kategori|default:'' }}">
    <!-- Card Header -->
    <div class="card-header-mobile">
      <div class="card-title-mobile">
        <h5>
          <a href="{% url 'detail_project:list_pekerjaan' project.pk %}" class="text-decoration-none text-dark">
            {{ project.nama|default:"—" }}
          </a>
        </h5>
      </div>
      <div class="card-checkbox-mobile">
        <input type="checkbox" class="form-check-input project-checkbox" value="{{ project.pk }}"
          data-project-name="{{ project.nama }}">
      </div>
    </div>

    <!-- Card Body -->
    <div class="card-body-mobile">
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-info-circle"></i> Status:</span>
        <span class="value">
          {% if project.tanggal_selesai and project.tanggal_mulai %}
          {% if project.tanggal_selesai|date:"Y-m-d" < today_str %} <span class="badge bg-danger">Selesai</span>
        {% elif project.tanggal_selesai|date:"Y-m-d" <= deadline_threshold_str %} <span
          class="badge bg-warning text-dark">Deadline</span>
          {% elif project.tanggal_mulai|date:"Y-m-d" > today_str %}
          <span class="badge bg-secondary">Belum Mulai</span>
          {% else %}
          <span class="badge bg-success">Berjalan</span>
          {% endif %}
          {% else %}
          <span class="badge bg-light text-dark">—</span>
          {% endif %}
          </span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-tasks"></i> Progress:</span>
        <span class="value">
          <div class="progress" style="height: 16px; width: 100px; display: inline-block;">
            <div
              class="progress-bar {% if project.progress_realisasi >= 100 %}bg-success{% elif project.progress_realisasi >= 50 %}bg-info{% elif project.progress_realisasi > 0 %}bg-warning{% else %}bg-secondary{% endif %}"
              style="width: {{ project.progress_realisasi|floatformat:0 }}%">
              <small>{{ project.progress_realisasi|floatformat:1 }}%</small>
            </div>
          </div>
        </span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-user"></i> Client:</span>
        <span class="value">{{ project.nama_client|default:"—" }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-coins"></i> Anggaran:</span>
        <span class="value">Rp {{ project.anggaran_owner|default:0|floatformat:0|intcomma }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-calendar"></i> Mulai:</span>
        <span class="value">{{ project.tanggal_mulai|date:"d M Y"|default:"—" }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-calendar-check"></i> Selesai:</span>
        <span class="value">{{ project.tanggal_selesai|date:"d M Y"|default:"—" }}</span>
      </div>
    </div>

    <!-- Card Actions -->
    <div class="card-actions-mobile">
      <div class="d-flex flex-wrap gap-1 project-action-icons">
        <a href="{% url 'detail_project:list_pekerjaan' project_id=project.pk %}" class="btn btn-sm btn-outline-success"
          title="Detail Pekerjaan" aria-label="Detail Pekerjaan">
          <i class="fas fa-list"></i>
        </a>
        <a href="{% url 'dashboard:project_edit' project.pk %}?next={{ request.get_full_path|urlencode }}"
          class="btn btn-sm btn-outline-warning" title="Edit Project" aria-label="Edit Project">
          <i class="fas fa-edit"></i>
        </a>
        <a href="/detail_project/api/project/{{ project.pk }}/export/full-backup/json/?include_progress=1"
          class="btn btn-sm btn-outline-info" title="Export Project (JSON)" aria-label="Export Project (JSON)" download>
          <i class="fas fa-download"></i>
        </a>
        <button type="button" class="btn btn-sm btn-outline-danger" title="Hapus Project" aria-label="Hapus Project"
          data-bs-toggle="modal" data-bs-target="#deleteModal-{{ project.pk }}">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>

    <!-- Delete Modal (reuse from table) -->
    <div class="modal fade" id="deleteModal-{{ project.pk }}-mobile" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Hapus Project</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
          </div>
          <div class="modal-body">
            Kamu yakin ingin menghapus project <strong>{{ project.nama }}</strong>?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
            <form method="post" action="{% url 'dashboard:project_delete' project.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn btn-danger">Ya, Hapus</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="project-mobile-card" style="display: none;">
    <div class="empty-state">
      <i class="fas fa-folder-open"></i>
      <h5>Belum Ada Project</h5>
      <p>Belum ada proyek yang ditambahkan. Mulai dengan menambahkan project baru!</p>
    </div>
  </div>
  {% endfor %}
</div>

<!-- === PERFORMANCE OPTIMIZATION: Pagination to eliminate 116s outliers === -->
{% if page_obj %}
<nav aria-label="Project pagination" class="mt-3">
  <ul class="pagination pagination-sm justify-content-center">
    <!-- First Page -->
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link"
        href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
        aria-label="First">
        <span aria-hidden="true">&laquo;&laquo;</span>
      </a>
    </li>
    <!-- Previous Page -->
    <li class="page-item">
      <a class="page-link"
        href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
        aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">&laquo;&laquo;</span>
    </li>
    <li class="page-item disabled">
      <span class="page-link">&laquo;</span>
    </li>
    {% endif %}

    <!-- Page Numbers -->
    {% for num in page_obj.paginator.page_range %}
    {% if page_obj.number == num %}
    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item"><a
        class="page-link"
        href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{
        num }}</a></li>
      {% endif %}
      {% endfor %}

      <!-- Next Page -->
      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
          href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
          aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
      <!-- Last Page -->
      <li class="page-item">
        <a class="page-link"
          href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
          aria-label="Last">
          <span aria-hidden="true">&raquo;&raquo;</span>
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">&raquo;</span>
      </li>
      <li class="page-item disabled">
        <span class="page-link">&raquo;&raquo;</span>
      </li>
      {% endif %}
  </ul>

  <!-- Pagination Info -->
  <div class="text-center text-muted small mt-2">
    Halaman {{ page_obj.number }} dari {{ page_obj.paginator.num_pages }}
    ({{ page_obj.start_index }}-{{ page_obj.end_index }} dari {{ page_obj.paginator.count }} project)
  </div>
</nav>
{% endif %}

<!-- Confirmation Modal (global for dashboard actions) -->
<div class="modal fade" id="dpConfirmModal" tabindex="-1" aria-labelledby="dpConfirmTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning-subtle">
        <h5 class="modal-title" id="dpConfirmTitle">Konfirmasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
      </div>
      <div class="modal-body" id="dpConfirmBody">
        Anda yakin ingin melanjutkan?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="dpConfirmCancelBtn" data-bs-dismiss="modal">
          Batal
        </button>
        <button type="button" class="btn btn-warning" id="dpConfirmOkBtn">
          Lanjutkan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- FASE 2.3: Bulk Actions JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const selectAllCheckbox = document.getElementById('selectAll');
    const desktopTable = document.querySelector('.dashboard-project-table');
    const tableWrapper = document.querySelector('.dashboard-table-wrapper');
    const bulkModeToggleBtn = document.getElementById('bulkModeToggleBtn');
    const bulkCancelBtn = document.getElementById('bulkCancelBtn');

    // Only get checkboxes from desktop table to avoid counting mobile duplicates
    const projectCheckboxes = desktopTable ? desktopTable.querySelectorAll('.project-checkbox') : [];
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCountSpan = document.getElementById('selectedCount');

    const toast = (message, type = 'info', duration) => {
      if (window.DP?.toast?.show) {
        window.DP.toast.show({ message, type, duration });
        return;
      }
      if (window.showToast) {
        window.showToast(message, type, duration || 3000);
      }
    };

    const confirmAction = (options) => {
      if (window.DPConfirm) {
        return window.DPConfirm(options);
      }
      return Promise.resolve(false);
    };

    // === BULK MODE TOGGLE ===
    let bulkModeActive = false;

    function toggleBulkMode(enable) {
      bulkModeActive = enable;

      if (enable) {
        tableWrapper.classList.add('bulk-mode-active');
        bulkModeToggleBtn.classList.add('active');
        bulkActionsBar.style.display = 'block';
      } else {
        tableWrapper.classList.remove('bulk-mode-active');
        bulkModeToggleBtn.classList.remove('active');
        bulkActionsBar.style.display = 'none';
        // Uncheck all when exiting bulk mode
        projectCheckboxes.forEach(cb => cb.checked = false);
        if (selectAllCheckbox) selectAllCheckbox.checked = false;
        updateBulkActionsUI();
      }
    }

    if (bulkModeToggleBtn) {
      bulkModeToggleBtn.addEventListener('click', function () {
        toggleBulkMode(!bulkModeActive);
      });
    }

    if (bulkCancelBtn) {
      bulkCancelBtn.addEventListener('click', function () {
        toggleBulkMode(false);
      });
    }

    // Function to update UI based on selection
    function updateBulkActionsUI() {
      // Only count checked boxes in desktop table
      const checkedBoxes = desktopTable ? desktopTable.querySelectorAll('.project-checkbox:checked') : [];
      const count = checkedBoxes.length;

      selectedCountSpan.textContent = count;

      if (count > 0) {
        bulkActionsBar.style.display = 'block';
      } else {
        bulkActionsBar.style.display = 'none';
      }

      // Update "Select All" checkbox state
      if (count === projectCheckboxes.length && projectCheckboxes.length > 0) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (count > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    // Select All functionality
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function () {
        const isChecked = this.checked;
        projectCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
        updateBulkActionsUI();
      });
    }

    // Individual checkbox change
    projectCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateBulkActionsUI);
    });

    // Get selected project IDs
    function getSelectedProjectIds() {
      const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
      return Array.from(checkedBoxes).map(cb => cb.value);
    }

    // Get CSRF token
    function getCSRFToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value ||
        document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    // Bulk Delete
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    if (bulkDeleteBtn) {
      bulkDeleteBtn.addEventListener('click', async function () {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) {
          toast('Pilih minimal satu project untuk dihapus.', 'warning');
          return;
        }

        const confirmed = await confirmAction({
          title: 'Konfirmasi Hapus',
          message: `Yakin ingin menghapus ${selectedIds.length} project terpilih? Project akan di-archive (soft delete).`,
          confirmText: 'Hapus',
          confirmClass: 'btn-danger'
        });
        if (!confirmed) return;

        fetch('{% url "dashboard:bulk_delete" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify({ project_ids: selectedIds })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              toast(`Berhasil menghapus ${data.deleted_count} project.`, 'success');
              setTimeout(() => window.location.reload(), 1000);
            } else {
              toast(data.error || 'Terjadi kesalahan saat menghapus project.', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            toast('Terjadi kesalahan saat menghapus project.', 'error');
          });
      });
    }

    // Bulk Archive
    const bulkArchiveBtn = document.getElementById('bulkArchiveBtn');
    if (bulkArchiveBtn) {
      bulkArchiveBtn.addEventListener('click', async function () {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) {
          toast('Pilih minimal satu project untuk di-archive.', 'warning');
          return;
        }

        const confirmed = await confirmAction({
          title: 'Konfirmasi Archive',
          message: `Yakin ingin meng-archive ${selectedIds.length} project terpilih?`,
          confirmText: 'Archive',
          confirmClass: 'btn-warning'
        });
        if (!confirmed) return;

        fetch('{% url "dashboard:bulk_archive" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify({ project_ids: selectedIds })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              toast(`Berhasil meng-archive ${data.archived_count} project.`, 'success');
              setTimeout(() => window.location.reload(), 1000);
            } else {
              toast(data.error || 'Terjadi kesalahan saat meng-archive project.', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            toast('Terjadi kesalahan saat meng-archive project.', 'error');
          });
      });
    }

    // Bulk Unarchive
    const bulkUnarchiveBtn = document.getElementById('bulkUnarchiveBtn');
    if (bulkUnarchiveBtn) {
      bulkUnarchiveBtn.addEventListener('click', async function () {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) {
          toast('Pilih minimal satu project untuk diaktifkan.', 'warning');
          return;
        }

        const confirmed = await confirmAction({
          title: 'Konfirmasi Aktifkan',
          message: `Yakin ingin mengaktifkan kembali ${selectedIds.length} project terpilih?`,
          confirmText: 'Aktifkan',
          confirmClass: 'btn-success'
        });
        if (!confirmed) return;

        fetch('{% url "dashboard:bulk_unarchive" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
          },
          body: JSON.stringify({ project_ids: selectedIds })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              toast(`Berhasil mengaktifkan ${data.unarchived_count} project.`, 'success');
              setTimeout(() => window.location.reload(), 1000);
            } else {
              toast(data.error || 'Terjadi kesalahan saat mengaktifkan project.', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            toast('Terjadi kesalahan saat mengaktifkan project.', 'error');
          });
      });
    }

    // Bulk Export (removed from toolbar but kept handler for backwards compatibility)
    const bulkExportBtn = document.getElementById('bulkExportBtn');
    if (bulkExportBtn) {
      bulkExportBtn.addEventListener('click', function () {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) return;

        const idsParam = selectedIds.map(id => `ids=${id}`).join('&');
        const exportUrl = `{% url 'dashboard:bulk_export_excel' %}?${idsParam}`;
        window.location.href = exportUrl;
      });
    }
  });

  // ============================================================================
  // Scroll Detection for Better UX (Added 2025-11-06)
  // ============================================================================
  document.addEventListener('DOMContentLoaded', function () {
    // Detect horizontal scroll and add visual indicators
    function setupScrollDetection() {
      const scrollableElements = document.querySelectorAll('.ux-scrollbar');

      scrollableElements.forEach(element => {
        function checkScroll() {
          const hasHorizontalScroll = element.scrollWidth > element.clientWidth;
          const isScrolled = element.scrollLeft > 0;
          const isAtEnd = element.scrollLeft >= (element.scrollWidth - element.clientWidth - 5);

          if (hasHorizontalScroll && !isAtEnd) {
            element.classList.add('has-scroll');
          } else {
            element.classList.remove('has-scroll');
          }
        }

        // Check on load
        checkScroll();

        // Check on scroll
        element.addEventListener('scroll', checkScroll);

        // Check on resize
        window.addEventListener('resize', checkScroll);
      });
    }

    setupScrollDetection();

    // Smooth scroll for table navigation
    const tableWrapper = document.querySelector('.dashboard-table-wrapper');
    if (tableWrapper) {
      tableWrapper.style.scrollBehavior = 'smooth';
    }

    // Add keyboard navigation for table
    const table = document.querySelector('.dashboard-project-table');
    if (table) {
      table.addEventListener('keydown', function (e) {
        if (e.key === 'ArrowRight' && tableWrapper) {
          tableWrapper.scrollLeft += 50;
        } else if (e.key === 'ArrowLeft' && tableWrapper) {
          tableWrapper.scrollLeft -= 50;
        }
      });
    }

    // Filter Panel Toggle
    const filterPanel = document.getElementById('filterPanel');
    const filterChevron = document.getElementById('filterChevron');
    const filterToggleText = document.getElementById('filterToggleText');

    if (filterPanel && filterChevron && filterToggleText) {
      filterPanel.addEventListener('show.bs.collapse', function () {
        filterChevron.classList.remove('fa-chevron-down');
        filterChevron.classList.add('fa-chevron-up');
        filterToggleText.textContent = 'Sembunyikan Filter';
      });

      filterPanel.addEventListener('hide.bs.collapse', function () {
        filterChevron.classList.remove('fa-chevron-up');
        filterChevron.classList.add('fa-chevron-down');
        filterToggleText.textContent = 'Tampilkan Filter';
      });

      // Auto-expand filter panel if any filter is active
      const urlParams = new URLSearchParams(window.location.search);
      const hasActiveFilters = Array.from(urlParams.keys()).some(key =>
        key !== 'page' && urlParams.get(key) !== ''
      );

      if (hasActiveFilters) {
        const collapseInstance = new bootstrap.Collapse(filterPanel, {
          toggle: false
        });
        collapseInstance.show();
      }
    }
  });
</script>