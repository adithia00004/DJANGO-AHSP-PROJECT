{% load static %}
{% load widget_tweaks %}
{% load humanize %}

<!-- Filter dan Search -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <strong><i class="fas fa-filter"></i> Filter Project</strong>
  </div>
  <div class="card-body">
    <form method="get" class="row g-3 dashboard-filter-form">
      <div class="col-md-6">
        {{ filter_form.search|add_class:"form-control" }}
      </div>
      <div class="col-md-4">
        {{ filter_form.sort_by|add_class:"form-select" }}
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary w-100">
          <i class="fas fa-search"></i> Cari
        </button>
      </div>
    </form>
  </div>
</div>

<!-- FASE 2.3: Bulk Actions Bar -->
<div class="card shadow-sm mb-3" id="bulkActionsBar" style="display: none;">
  <div class="card-body py-2">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <span id="selectedCount" class="badge bg-primary me-2">0</span>
        <span class="text-muted">project dipilih</span>
      </div>
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-danger" id="bulkDeleteBtn" title="Hapus project terpilih">
          <i class="fas fa-trash"></i> Hapus
        </button>
        <button type="button" class="btn btn-outline-warning" id="bulkArchiveBtn" title="Archive project terpilih">
          <i class="fas fa-archive"></i> Archive
        </button>
        <button type="button" class="btn btn-outline-success" id="bulkUnarchiveBtn" title="Aktifkan kembali project terpilih">
          <i class="fas fa-check-circle"></i> Aktifkan
        </button>
        <button type="button" class="btn btn-outline-info" id="bulkExportBtn" title="Export project terpilih">
          <i class="fas fa-file-excel"></i> Export
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Tabel Proyek Ringkasan -->
<div class="dashboard-table-wrapper table-responsive shadow-sm ux-scrollbar">
  <!-- Desktop Table View -->
  <table class="dashboard-project-table table table-hover table-bordered align-middle text-nowrap">
    <thead class="table-light dp-thead-sticky">
      <tr>
        <th class="text-center" style="width: 40px;">
          <input type="checkbox" id="selectAll" class="form-check-input" title="Pilih semua">
        </th>
        <th>Kode</th>
        <th>Nama Project</th>
        <th>Tahun</th>
        <th>Sumber Dana</th>
        <th>Lokasi</th>
        <th>Nama Client</th>
        <th>Anggaran</th>
        <th>Tanggal Mulai</th>
        <th>Tanggal Selesai</th>
        <th>Durasi (hari)</th>
        <th>Status</th>
        <th class="text-center">Aksi</th>
      </tr>
    </thead>
    <tbody>
      {% for project in projects %}
      <tr>
        <td class="text-center">
          <input type="checkbox" class="form-check-input project-checkbox" value="{{ project.pk }}" data-project-name="{{ project.nama }}">
        </td>
        <td>
          <a href="{% url 'detail_project:list_pekerjaan' project.pk %}" class="text-decoration-none fw-bold text-primary" title="Lihat daftar pekerjaan">
            {{ project.index_project|default:"—" }}
          </a>
        </td>
        <td>
          <a href="{% url 'detail_project:list_pekerjaan' project.pk %}" class="text-decoration-none" title="Lihat daftar pekerjaan">
            {{ project.nama|default:"—" }}
          </a>
        </td>
        <td>{{ project.tahun_project|default:"—" }}</td>
        <td>{{ project.sumber_dana|default:"—" }}</td>
        <td>{{ project.lokasi_project|default:"—" }}</td>
        <td>{{ project.nama_client|default:"—" }}</td>
        <td>Rp{{ project.anggaran_owner|default:0|floatformat:0|intcomma }}</td>
        <td>{{ project.tanggal_mulai|date:"d M Y"|default:"—" }}</td>
        <td>{{ project.tanggal_selesai|date:"d M Y"|default:"—" }}</td>
        <td class="text-center">{{ project.durasi_hari|default:"—" }}</td>
        <td>
          {% load tz %}
          {% now "Y-m-d" as today_str %}
          {% if project.tanggal_selesai and project.tanggal_mulai %}
            {% if project.tanggal_selesai|date:"Y-m-d" < today_str %}
              <span class="badge bg-danger">Terlambat</span>
            {% elif project.tanggal_mulai|date:"Y-m-d" > today_str %}
              <span class="badge bg-secondary">Belum Mulai</span>
            {% else %}
              <span class="badge bg-success">Berjalan</span>
            {% endif %}
          {% else %}
            <span class="badge bg-light text-dark">—</span>
          {% endif %}
        </td>
        <td class="text-center">
          <!-- Detail (dashboard) -->
          <a href="{% url 'dashboard:project_detail' project.pk %}" class="btn btn-sm btn-outline-info" title="Lihat Detail">
            <i class="fas fa-eye"></i>
          </a>
          <!-- Masuk ke Detail Pekerjaan -->
          <a href="{% url 'detail_project:list_pekerjaan' project_id=project.pk %}" class="btn btn-sm btn-outline-success" title="Detail Pekerjaan">
            <i class="fas fa-list"></i>
          </a>
          <!-- Edit -->
          <a href="{% url 'dashboard:project_edit' project.pk %}?next={{ request.get_full_path|urlencode }}"
            class="btn btn-sm btn-outline-warning" title="Edit Project">
            <i class="fas fa-edit"></i>
          </a>

          <!-- Duplicate -->
          <a href="{% url 'dashboard:project_duplicate' project.pk %}?next={{ request.get_full_path|urlencode }}"
            class="btn btn-sm btn-outline-secondary" title="Duplikat Project">
            <i class="fas fa-clone"></i>
          </a>
          <!-- Delete (POST via modal) -->
          <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ project.pk }}" title="Hapus Project">
            <i class="fas fa-trash"></i>
          </button>

          <!-- Modal Konfirmasi Hapus -->
          <div class="modal fade" id="deleteModal-{{ project.pk }}" tabindex="-1" aria-labelledby="deleteModalLabel-{{ project.pk }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteModalLabel-{{ project.pk }}">Hapus Project</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
                </div>
                <div class="modal-body">
                  Kamu yakin ingin menghapus project <strong>{{ project.nama }}</strong>?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                  <form method="post" action="{% url 'dashboard:project_delete' project.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="btn btn-danger">Ya, Hapus</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="13" class="text-center text-muted">Belum ada proyek yang ditambahkan.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Mobile Card View (shows on screens < 992px) -->
  {% for project in projects %}
  <div class="project-mobile-card" style="display: none;">
    <!-- Card Header -->
    <div class="card-header-mobile">
      <div class="card-title-mobile">
        <h5>
          <a href="{% url 'detail_project:list_pekerjaan' project.pk %}" class="text-decoration-none text-dark">
            {{ project.nama|default:"—" }}
          </a>
        </h5>
        <div class="project-code">
          <i class="fas fa-hashtag"></i> {{ project.index_project|default:"—" }}
        </div>
      </div>
      <div class="card-checkbox-mobile">
        <input type="checkbox" class="form-check-input project-checkbox" value="{{ project.pk }}" data-project-name="{{ project.nama }}">
      </div>
    </div>

    <!-- Card Body -->
    <div class="card-body-mobile">
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-calendar"></i> Tahun:</span>
        <span class="value">{{ project.tahun_project|default:"—" }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-money-bill"></i> Sumber Dana:</span>
        <span class="value">{{ project.sumber_dana|default:"—" }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-map-marker-alt"></i> Lokasi:</span>
        <span class="value">{{ project.lokasi_project|default:"—" }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-user"></i> Client:</span>
        <span class="value">{{ project.nama_client|default:"—" }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-coins"></i> Anggaran:</span>
        <span class="value">Rp {{ project.anggaran_owner|default:0|floatformat:0|intcomma }}</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-clock"></i> Durasi:</span>
        <span class="value">{{ project.durasi_hari|default:"—" }} hari</span>
      </div>
      <div class="info-row-mobile">
        <span class="label"><i class="fas fa-info-circle"></i> Status:</span>
        <span class="value">
          {% load tz %}
          {% now "Y-m-d" as today_str %}
          {% if project.tanggal_selesai and project.tanggal_mulai %}
            {% if project.tanggal_selesai|date:"Y-m-d" < today_str %}
              <span class="badge bg-danger">Terlambat</span>
            {% elif project.tanggal_mulai|date:"Y-m-d" > today_str %}
              <span class="badge bg-secondary">Belum Mulai</span>
            {% else %}
              <span class="badge bg-success">Berjalan</span>
            {% endif %}
          {% else %}
            <span class="badge bg-light text-dark">—</span>
          {% endif %}
        </span>
      </div>
    </div>

    <!-- Card Actions -->
    <div class="card-actions-mobile">
      <a href="{% url 'dashboard:project_detail' project.pk %}" class="btn btn-sm btn-outline-info">
        <i class="fas fa-eye"></i> Detail
      </a>
      <a href="{% url 'detail_project:list_pekerjaan' project_id=project.pk %}" class="btn btn-sm btn-outline-success">
        <i class="fas fa-list"></i> Pekerjaan
      </a>
      <a href="{% url 'dashboard:project_edit' project.pk %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-warning">
        <i class="fas fa-edit"></i> Edit
      </a>
      <a href="{% url 'dashboard:project_duplicate' project.pk %}?next={{ request.get_full_path|urlencode }}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-clone"></i> Duplikat
      </a>
      <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ project.pk }}">
        <i class="fas fa-trash"></i> Hapus
      </button>
    </div>

    <!-- Delete Modal (reuse from table) -->
    <div class="modal fade" id="deleteModal-{{ project.pk }}-mobile" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Hapus Project</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
          </div>
          <div class="modal-body">
            Kamu yakin ingin menghapus project <strong>{{ project.nama }}</strong>?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
            <form method="post" action="{% url 'dashboard:project_delete' project.pk %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn btn-danger">Ya, Hapus</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="project-mobile-card" style="display: none;">
    <div class="empty-state">
      <i class="fas fa-folder-open"></i>
      <h5>Belum Ada Project</h5>
      <p>Belum ada proyek yang ditambahkan. Mulai dengan menambahkan project baru!</p>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Pagination -->
{% if projects.paginator.num_pages > 1 %}
{% with pnum=projects.number|stringformat:"s" %}
<nav aria-label="Pagination" class="mt-2">
  <ul class="pagination pagination-sm justify-content-end mb-0">
    {% if projects.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ projects.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|default:''|cut:'page='|cut:pnum }}{% endif %}"
           aria-label="Previous">&laquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
    {% endif %}

    {% for num in projects.paginator.page_range %}
      {% if num == projects.number %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num >= projects.number|add:-2 and num <= projects.number|add:2 %}
        <li class="page-item">
          <a class="page-link"
             href="?page={{ num }}{% if request.GET %}&{{ request.GET.urlencode|default:''|cut:'page='|cut:pnum }}{% endif %}">{{ num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if projects.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ projects.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|default:''|cut:'page='|cut:pnum }}{% endif %}"
           aria-label="Next">&raquo;</a>
      </li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
    {% endif %}
  </ul>
</nav>
{% endwith %}
{% endif %}

<!-- FASE 2.3: Bulk Actions JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const projectCheckboxes = document.querySelectorAll('.project-checkbox');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCountSpan = document.getElementById('selectedCount');

    // Function to update UI based on selection
    function updateBulkActionsUI() {
        const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
        const count = checkedBoxes.length;

        selectedCountSpan.textContent = count;

        if (count > 0) {
            bulkActionsBar.style.display = 'block';
        } else {
            bulkActionsBar.style.display = 'none';
        }

        // Update "Select All" checkbox state
        if (count === projectCheckboxes.length && projectCheckboxes.length > 0) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (count > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }

    // Select All functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            projectCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            updateBulkActionsUI();
        });
    }

    // Individual checkbox change
    projectCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionsUI);
    });

    // Get selected project IDs
    function getSelectedProjectIds() {
        const checkedBoxes = document.querySelectorAll('.project-checkbox:checked');
        return Array.from(checkedBoxes).map(cb => cb.value);
    }

    // Get CSRF token
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value ||
               document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    // Bulk Delete
    document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) return;

        if (confirm(`Yakin ingin menghapus ${selectedIds.length} project terpilih? Project akan di-archive (soft delete).`)) {
            fetch('{% url "dashboard:bulk_delete" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ project_ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Berhasil menghapus ${data.deleted_count} project.`);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat menghapus project.');
            });
        }
    });

    // Bulk Archive
    document.getElementById('bulkArchiveBtn').addEventListener('click', function() {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) return;

        if (confirm(`Yakin ingin meng-archive ${selectedIds.length} project terpilih?`)) {
            fetch('{% url "dashboard:bulk_archive" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ project_ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Berhasil meng-archive ${data.archived_count} project.`);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat meng-archive project.');
            });
        }
    });

    // Bulk Unarchive
    document.getElementById('bulkUnarchiveBtn').addEventListener('click', function() {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) return;

        if (confirm(`Yakin ingin mengaktifkan kembali ${selectedIds.length} project terpilih?`)) {
            fetch('{% url "dashboard:bulk_unarchive" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ project_ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Berhasil mengaktifkan ${data.unarchived_count} project.`);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat mengaktifkan project.');
            });
        }
    });

    // Bulk Export
    document.getElementById('bulkExportBtn').addEventListener('click', function() {
        const selectedIds = getSelectedProjectIds();
        if (selectedIds.length === 0) return;

        // Build export URL with selected IDs as query parameters
        const idsParam = selectedIds.map(id => `ids=${id}`).join('&');
        const exportUrl = `{% url 'dashboard:bulk_export_excel' %}?${idsParam}`;

        // Open in new window to trigger download
        window.location.href = exportUrl;
    });
});

// ============================================================================
// Scroll Detection for Better UX (Added 2025-11-06)
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    // Detect horizontal scroll and add visual indicators
    function setupScrollDetection() {
        const scrollableElements = document.querySelectorAll('.ux-scrollbar');

        scrollableElements.forEach(element => {
            function checkScroll() {
                const hasHorizontalScroll = element.scrollWidth > element.clientWidth;
                const isScrolled = element.scrollLeft > 0;
                const isAtEnd = element.scrollLeft >= (element.scrollWidth - element.clientWidth - 5);

                if (hasHorizontalScroll && !isAtEnd) {
                    element.classList.add('has-scroll');
                } else {
                    element.classList.remove('has-scroll');
                }
            }

            // Check on load
            checkScroll();

            // Check on scroll
            element.addEventListener('scroll', checkScroll);

            // Check on resize
            window.addEventListener('resize', checkScroll);
        });
    }

    setupScrollDetection();

    // Smooth scroll for table navigation
    const tableWrapper = document.querySelector('.dashboard-table-wrapper');
    if (tableWrapper) {
        tableWrapper.style.scrollBehavior = 'smooth';
    }

    // Add keyboard navigation for table
    const table = document.querySelector('.dashboard-project-table');
    if (table) {
        table.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight' && tableWrapper) {
                tableWrapper.scrollLeft += 50;
            } else if (e.key === 'ArrowLeft' && tableWrapper) {
                tableWrapper.scrollLeft -= 50;
            }
        });
    }
});
</script>
