{% extends "detail_project/base_detail.html" %}
{% load static vite %}

{% block body_attrs %}data-page="jadwal_pekerjaan"{% endblock %}

{% block title %}Jadwal Pekerjaan - {{ project.nama }}{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_css %}
<!-- Core Styles -->
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan_grid.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/validation-enhancements.css' %}">

<!-- AG Grid CSS (always load, minimal overhead) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-theme-alpine.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-theme-alpine-dark.css">

<!-- Chart Libraries CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
{% endblock %}

{% block dp_content %}
<!-- Toolbar -->
<div id="kt-toolbar" class="grid-toolbar dp-sticky-topbar dp-layer-toolbar bg-body border-bottom">
  <div class="toolbar-left">
    <h1 class="toolbar-title">Jadwal Pekerjaan (Modern)</h1>
    <span class="toolbar-subtitle">{{ project.nama }}</span>
  </div>

  <div class="toolbar-right">
    <!-- Time Scale Selector -->
    <div class="btn-group btn-group-sm time-scale-selector" role="group">
      <input type="radio" class="btn-check" name="timeScale" id="scale-daily" value="daily">
      <label class="btn btn-outline-primary" for="scale-daily">Daily</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-weekly" value="weekly" checked>
      <label class="btn btn-outline-primary" for="scale-weekly">Weekly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-monthly" value="monthly">
      <label class="btn btn-outline-primary" for="scale-monthly">Monthly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-custom" value="custom">
      <label class="btn btn-outline-primary" for="scale-custom">Custom</label>
    </div>

    <!-- Display Mode Toggle -->
    <div class="btn-group btn-group-sm display-mode-toggle ms-2" role="group">
      <input type="radio" class="btn-check" name="displayMode" id="mode-percentage" value="percentage" checked>
      <label class="btn btn-outline-success" for="mode-percentage">
        <i class="bi bi-percent"></i> %
      </label>

      <input type="radio" class="btn-check" name="displayMode" id="mode-volume" value="volume">
      <label class="btn btn-outline-success" for="mode-volume">
        <i class="bi bi-123"></i> Vol
      </label>
    </div>

    {% with start_day=project.week_start_day|default:0 end_day=project.week_end_day|default:6 %}
    <!-- Week Boundary Controls -->
    <div class="d-flex align-items-end ms-3 gap-2 week-boundary-controls">
      <div>
        <label for="week-start-day-select" class="form-label text-muted mb-1 small">Week Start</label>
        <select class="form-select form-select-sm" id="week-start-day-select">
          <option value="0" {% if start_day == 0 %}selected{% endif %}>Senin</option>
          <option value="1" {% if start_day == 1 %}selected{% endif %}>Selasa</option>
          <option value="2" {% if start_day == 2 %}selected{% endif %}>Rabu</option>
          <option value="3" {% if start_day == 3 %}selected{% endif %}>Kamis</option>
          <option value="4" {% if start_day == 4 %}selected{% endif %}>Jumat</option>
          <option value="5" {% if start_day == 5 %}selected{% endif %}>Sabtu</option>
          <option value="6" {% if start_day == 6 %}selected{% endif %}>Minggu</option>
        </select>
      </div>
      <div>
        <label for="week-end-day-select" class="form-label text-muted mb-1 small">Week End</label>
        <select class="form-select form-select-sm" id="week-end-day-select">
          <option value="0" {% if end_day == 0 %}selected{% endif %}>Senin</option>
          <option value="1" {% if end_day == 1 %}selected{% endif %}>Selasa</option>
          <option value="2" {% if end_day == 2 %}selected{% endif %}>Rabu</option>
          <option value="3" {% if end_day == 3 %}selected{% endif %}>Kamis</option>
          <option value="4" {% if end_day == 4 %}selected{% endif %}>Jumat</option>
          <option value="5" {% if end_day == 5 %}selected{% endif %}>Sabtu</option>
          <option value="6" {% if end_day == 6 %}selected{% endif %}>Minggu</option>
        </select>
      </div>
    </div>
    {% endwith %}

    <!-- Action Buttons -->
    <button type="button" class="btn btn-danger btn-sm ms-2" id="btn-reset-progress" title="Reset all progress to 0">
      <i class="bi bi-arrow-counterclockwise"></i>
    </button>
    <button type="button" class="btn btn-primary btn-sm" id="btn-export-excel" title="Export to Excel">
      <i class="bi bi-file-earmark-excel"></i>
    </button>
    <button type="button" class="btn btn-success btn-sm" id="save-button" title="Save all changes">
      <i class="bi bi-save"></i> Save
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-button" title="Refresh data from server">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>
</div>

<!-- Main App Container -->
<div id="tahapan-grid-app"
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/"
     data-api-tahapan="{% url 'detail_project:api_list_create_tahapan' project.id %}"
     data-api-list-pekerjaan="{% url 'detail_project:api_get_list_pekerjaan_tree' project.id %}"
     data-api-volume="{% url 'detail_project:api_list_volume_pekerjaan' project.id %}"
     data-api-assignments-base="/detail_project/api/project/{{ project.id }}/pekerjaan/"
     data-api-save="{% url 'detail_project:api_v2_assign_weekly' project.id %}"
     data-enable-ag-grid="{% if enable_ag_grid %}true{% else %}false{% endif %}"
     data-project-name="{{ project.nama|escape }}"
     data-project-start="{{ project.tanggal_mulai|date:'Y-m-d'|default:'' }}"
     data-project-end="{{ project.tanggal_selesai|date:'Y-m-d'|default:'' }}"
     data-default-time-scale="weekly"
     data-default-input-mode="percentage"
     data-week-start-day="{{ project.week_start_day|default:0 }}"
     data-week-end-day="{{ project.week_end_day|default:6 }}"
     data-api-week-boundary="{% url 'detail_project:api_update_week_boundaries' project.id %}">

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mt-3" id="viewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab" aria-controls="grid-view" aria-selected="true">
        <i class="bi bi-grid-3x3-gap"></i> Grid View
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="gantt-tab" data-bs-toggle="tab" data-bs-target="#gantt-view" type="button" role="tab" aria-controls="gantt-view" aria-selected="false">
        <i class="bi bi-calendar3"></i> Gantt
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="scurve-tab" data-bs-toggle="tab" data-bs-target="#scurve-view" type="button" role="tab" aria-controls="scurve-view" aria-selected="false">
        <i class="bi bi-graph-up"></i> S-Curve
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="viewTabsContent">
    <!-- Grid View Tab -->
    <div class="tab-pane fade show active" id="grid-view" role="tabpanel" aria-labelledby="grid-tab">
      {% if enable_ag_grid %}
        <div class="ag-grid-section">
          <div class="horizontal-scroll-wrapper" id="ag-grid-scroll-top">
            <div class="horizontal-scroll-inner" id="ag-grid-scroll-inner"></div>
          </div>
          <div id="ag-grid-container"
               class="ag-theme-alpine ag-grid-wrapper"
               style="width: 100%; min-height: 600px;">
            <!-- AG Grid mounts here -->
          </div>
        </div>
      {% else %}
        <!-- Legacy Grid Fallback -->
        <div class="grid-container legacy-grid-wrapper">
          <div class="split-panel-wrapper">
            <div class="left-panel-wrapper">
              <div class="left-panel-scroll">
                <table class="grid-table">
                  <thead id="left-thead">
                    <tr>
                      <th class="col-uraian">Klasifikasi / Sub-Klasifikasi / Pekerjaan</th>
                      <th class="col-volume text-center">Volume</th>
                      <th class="col-satuan text-center">Satuan</th>
                    </tr>
                  </thead>
                  <tbody id="left-tbody">
                    <!-- Render oleh JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>

            <div class="right-panel-wrapper">
              <div class="right-panel-scroll">
                <table class="grid-table">
                  <thead id="right-thead">
                    <tr id="time-header-row">
                      <!-- Render oleh JavaScript -->
                    </tr>
                  </thead>
                  <tbody id="right-tbody">
                    <!-- Render oleh JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-left">
          <span id="status-info">Ready</span>
        </div>
        <div class="status-right">
          <span>Modified: <strong id="status-modified">0</strong></span>
          <span class="ms-3">Rows: <strong id="status-rows">0</strong></span>
        </div>
      </div>
    </div>

    <!-- Gantt View Tab -->
    <div class="tab-pane fade" id="gantt-view" role="tabpanel" aria-labelledby="gantt-tab">
      <div id="gantt-container" style="overflow: auto; padding: 20px; min-height: 600px;">
        <!-- Gantt chart rendered by JavaScript -->
      </div>
    </div>

    <!-- S-Curve View Tab -->
    <div class="tab-pane fade" id="scurve-view" role="tabpanel" aria-labelledby="scurve-tab">
      <div id="scurve-container" style="height: 600px; padding: 20px;">
        <!-- S-Curve chart rendered by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Konfirmasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirm-message">Anda yakin?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="confirm-action">Ya, Lanjutkan</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">
          <i class="bi bi-check-circle"></i> Sukses
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="success-message">Operasi berhasil!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart Libraries (CDN with fallback) -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"
        onerror="window.__loadLocalEcharts && window.__loadLocalEcharts();"></script>
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

<script>
  // ECharts fallback loader
  window.__loadLocalEcharts = function() {
    if (window.__echartsFallbackLoaded) return;
    window.__echartsFallbackLoaded = true;

    const script = document.createElement('script');
    script.src = "{% static 'detail_project/js/vendor/echarts.min.js' %}";
    script.onload = () => console.info('[Jadwal] ECharts loaded from fallback');
    script.onerror = () => console.error('[Jadwal] ECharts fallback failed');
    document.head.appendChild(script);
  };

  if (typeof window.echarts === 'undefined') {
    window.__loadLocalEcharts();
  }
</script>

<!-- MODERN VITE MODULE LOADING -->
{% if DEBUG and use_vite_dev_server %}
  {# Development mode: Load from Vite dev server with HMR #}
  <script type="module" src="http://localhost:5175/@vite/client"></script>
  <script type="module" src="http://localhost:5175/js/src/jadwal_kegiatan_app.js"></script>
  <script>
    console.log('%cdYs? VITE DEV MODE', 'background: #646cff; color: white; padding: 4px 8px; border-radius: 3px;');
    console.log('Hot Module Replacement (HMR) enabled');
    console.log('Dev server: http://localhost:5175');
  </script>
{% else %}
  {# Production mode: Load built assets via manifest #}
  {% vite_asset 'assets/js/jadwal-kegiatan.js' as jadwal_asset %}
  <script type="module" src="{% static jadwal_asset %}"></script>
  <script>
    console.log('%cdY"? PRODUCTION MODE', 'background: #42b983; color: white; padding: 4px 8px; border-radius: 3px;');
    console.log('Using built assets from static/dist/ (manifest resolved)');
  </script>
{% endif %}

{% comment %}
=============================================================================
MIGRATION NOTE (2025-11-19):

This template ONLY loads modern Vite-based modules.
Legacy scripts (kelola_tahapan_page_bootstrap.js, etc.) are NOT loaded.

If you need to rollback to legacy:
1. Change view to use: kelola_tahapan_grid_LEGACY.html
2. Or set: ENABLE_AG_GRID = False and USE_VITE_DEV_SERVER = False

Modern stack provides:
- ✅ ES6 modules with tree-shaking
- ✅ Hot Module Replacement (HMR) in dev
- ✅ Code splitting & lazy loading
- ✅ Better performance (28% smaller bundle)
- ✅ Modern debugging with source maps
- ✅ No memory leaks (event delegation)
=============================================================================
{% endcomment %}

{% endblock %}
