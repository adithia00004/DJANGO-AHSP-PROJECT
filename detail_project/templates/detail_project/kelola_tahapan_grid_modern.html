{% extends "detail_project/base_detail.html" %}
{% load static vite %}

{% block body_attrs %}data-page="jadwal_pekerjaan"{% endblock %}

{% block title %}Jadwal Pekerjaan - {{ project.nama }}{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_css %}
<!-- Core Styles -->
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan_grid.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/toolbar-responsive.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/validation-enhancements.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/loading-skeleton.css' %}">

<!-- NEW: Redesigned Gantt CSS -->
<link rel="stylesheet" href="{% static 'detail_project/css/gantt-chart-redesign.css' %}">
<!-- Fullscreen Mode -->
<link rel="stylesheet" href="{% static 'detail_project/css/fullscreen-mode.css' %}">
{% endblock %}

{% block dp_content %}
{% include "detail_project/kelola_tahapan/_skeleton_grid.html" %}
{% include "detail_project/kelola_tahapan/_skeleton_gantt.html" %}
{% include "detail_project/kelola_tahapan/_skeleton_kurva.html" %}

<!-- Toolbar - Responsive Redesign (Phase 2E.1+) -->
<div id="kt-toolbar" class="toolbar-container dp-sticky-topbar dp-layer-toolbar">
  <!-- Primary Row (Always Visible - All Modes) -->
  <div class="toolbar-primary">
    <div class="toolbar-left">
      <h1 class="toolbar-title">Jadwal Pekerjaan</h1>
      <div class="toolbar-subtitle-row">
        <span class="toolbar-subtitle">{{ project.nama }}</span>
        <span id="progress-mode-indicator" class="badge bg-info">
          Mode: Rencana
        </span>
      </div>
    </div>

    <!-- Primary Action Buttons (Grouped) -->
    <div class="toolbar-actions">
      <button type="button" class="btn btn-primary btn-sm btn-save" id="save-button" aria-label="Save all changes"
        title="Save all changes">
        <i class="bi bi-save" aria-hidden="true"></i>
        <span class="btn-text">Save</span>
      </button>

      <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-button"
        aria-label="Refresh data from server" title="Refresh data">
        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
      </button>

      <button type="button" class="btn btn-outline-danger btn-sm" id="btn-reset-progress"
        title="Reset progress (mode aktif) ke 0% - data mode lain tetap aman">
        <i class="bi bi-arrow-counterclockwise"></i>
        <span class="btn-text d-none d-md-inline">Reset</span>
      </button>

      <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#exportModal">
        <i class="bi bi-download"></i>
        <span class="btn-text d-none d-md-inline">Export</span>
      </button>

      <!-- More Menu (Mobile/Tablet) -->
      <div class="dropdown toolbar-more d-lg-none">
        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"
          aria-expanded="false" aria-label="More options">
          <i class="bi bi-three-dots-vertical" aria-hidden="true"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm" style="min-width: 260px;">
          <li class="dropdown-header">Actions</li>
          <li>
            <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-reset-progress-mobile">
              <i class="bi bi-arrow-counterclockwise text-danger"></i> Reset Progress
            </button>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>

          <li class="dropdown-header">Time Scale</li>
          <li class="px-3 py-1">
            <div class="btn-group btn-group-sm w-100" role="group">
              <input type="radio" class="btn-check" name="timeScale" id="scale-weekly-mobile" value="weekly" checked>
              <label class="btn btn-outline-primary" for="scale-weekly-mobile">Weekly</label>

              <input type="radio" class="btn-check" name="timeScale" id="scale-monthly-mobile" value="monthly">
              <label class="btn btn-outline-primary" for="scale-monthly-mobile">Monthly</label>
            </div>
          </li>

          <li>
            <hr class="dropdown-divider">
          </li>

          <li class="dropdown-header">Week Boundaries</li>
          <li class="px-3 py-1 pb-3">
            <div class="d-flex align-items-center gap-2">
              <div class="w-50">
                <label class="form-label small text-muted mb-1" style="font-size: 0.7rem;">Start</label>
                <select class="form-select form-select-sm"
                  onchange="var elStart=document.getElementById('week-start-day-select'); if(elStart){ elStart.value=this.value; elStart.dispatchEvent(new Event('change')); }">
                  <option value="0" {% if project.week_start_day|default:0 == 0 %}selected{% endif %}>Sen</option>
                  <option value="1" {% if project.week_start_day|default:0 == 1 %}selected{% endif %}>Sel</option>
                  <option value="2" {% if project.week_start_day|default:0 == 2 %}selected{% endif %}>Rab</option>
                  <option value="3" {% if project.week_start_day|default:0 == 3 %}selected{% endif %}>Kam</option>
                  <option value="4" {% if project.week_start_day|default:0 == 4 %}selected{% endif %}>Jum</option>
                  <option value="5" {% if project.week_start_day|default:0 == 5 %}selected{% endif %}>Sab</option>
                  <option value="6" {% if project.week_start_day|default:0 == 6 %}selected{% endif %}>Min</option>
                </select>
              </div>
              <div class="text-muted mt-3">–</div>
              <div class="w-50">
                <label class="form-label small text-muted mb-1" style="font-size: 0.7rem;">End</label>
                <select class="form-select form-select-sm"
                  onchange="var elEnd=document.getElementById('week-end-day-select'); if(elEnd){ elEnd.value=this.value; elEnd.dispatchEvent(new Event('change')); }">
                  <option value="0" {% if project.week_end_day|default:6 == 0 %}selected{% endif %}>Sen</option>
                  <option value="1" {% if project.week_end_day|default:6 == 1 %}selected{% endif %}>Sel</option>
                  <option value="2" {% if project.week_end_day|default:6 == 2 %}selected{% endif %}>Rab</option>
                  <option value="3" {% if project.week_end_day|default:6 == 3 %}selected{% endif %}>Kam</option>
                  <option value="4" {% if project.week_end_day|default:6 == 4 %}selected{% endif %}>Jum</option>
                  <option value="5" {% if project.week_end_day|default:6 == 5 %}selected{% endif %}>Sab</option>
                  <option value="6" {% if project.week_end_day|default:6 == 6 %}selected{% endif %}>Min</option>
                </select>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>

  </div>
</div>

<!-- Secondary Row (Grid View Only - Advanced Options) - NOT Sticky -->
<div id="toolbar-advanced-wrapper">
  <div class="toolbar-secondary collapse show" id="toolbarSecondary" data-grid-view-only="true">
    <div class="toolbar-controls-group">
      <!-- Progress Mode Tabs (Grid View Only) -->
      <div class="control-group">
        <label class="control-label">Mode</label>
        <div class="btn-group btn-group-sm progress-mode-tabs" role="tablist" aria-label="Progress Mode Selection">
          <input type="radio" class="btn-check" name="progressMode" id="mode-planned" value="planned" checked>
          <label class="btn btn-outline-info" for="mode-planned" role="tab" aria-selected="true"
            aria-controls="grid-content" title="Mode Perencanaan: Input progress yang direncanakan">
            <i class="bi bi-calendar-check" aria-hidden="true"></i>
            <span class="btn-text">Rencana</span>
          </label>

          <input type="radio" class="btn-check" name="progressMode" id="mode-actual" value="actual">
          <label class="btn btn-outline-warning" for="mode-actual" role="tab" aria-selected="false"
            aria-controls="grid-content" title="Mode Realisasi: Input progress yang sudah terealisasi">
            <i class="bi bi-clipboard-data" aria-hidden="true"></i>
            <span class="btn-text">Realisasi</span>
          </label>
        </div>
      </div>

      <!-- Time Scale (Advanced Toolbar) -->
      <div class="control-group">
        <label class="control-label">Time Scale</label>
        <div class="btn-group btn-group-sm time-scale-selector" role="group">
          <input type="radio" class="btn-check" name="timeScale" id="scale-weekly" value="weekly" checked>
          <label class="btn btn-outline-primary" for="scale-weekly">Weekly</label>

          <input type="radio" class="btn-check" name="timeScale" id="scale-monthly" value="monthly">
          <label class="btn btn-outline-primary" for="scale-monthly">Monthly</label>
        </div>
      </div>

      <!-- Week Boundaries (Advanced Toolbar) -->
      <div class="control-group week-boundary-controls">
        <label class="control-label">Week Boundaries</label>
        {% with start_day=project.week_start_day|default:0 end_day=project.week_end_day|default:6 %}
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm" id="week-start-day-select" aria-label="Week start day">
            <option value="0" {% if start_day == 0 %}selected{% endif %}>Sen</option>
            <option value="1" {% if start_day == 1 %}selected{% endif %}>Sel</option>
            <option value="2" {% if start_day == 2 %}selected{% endif %}>Rab</option>
            <option value="3" {% if start_day == 3 %}selected{% endif %}>Kam</option>
            <option value="4" {% if start_day == 4 %}selected{% endif %}>Jum</option>
            <option value="5" {% if start_day == 5 %}selected{% endif %}>Sab</option>
            <option value="6" {% if start_day == 6 %}selected{% endif %}>Min</option>
          </select>
          <span class="align-self-center text-muted">-</span>
          <select class="form-select form-select-sm" id="week-end-day-select" aria-label="Week end day">
            <option value="0" {% if end_day == 0 %}selected{% endif %}>Sen</option>
            <option value="1" {% if end_day == 1 %}selected{% endif %}>Sel</option>
            <option value="2" {% if end_day == 2 %}selected{% endif %}>Rab</option>
            <option value="3" {% if end_day == 3 %}selected{% endif %}>Kam</option>
            <option value="4" {% if end_day == 4 %}selected{% endif %}>Jum</option>
            <option value="5" {% if end_day == 5 %}selected{% endif %}>Sab</option>
            <option value="6" {% if end_day == 6 %}selected{% endif %}>Min</option>
          </select>
        </div>
        {% endwith %}
      </div>

      <!-- Display Mode Toggle (Grid View Only) -->
      <div class="control-group">
        <label class="control-label">Display</label>
        <div class="btn-group btn-group-sm display-mode-toggle" role="group">
          <input type="radio" class="btn-check" name="displayMode" id="mode-percentage" value="percentage" checked>
          <label class="btn btn-outline-success" for="mode-percentage" title="Show as percentage">
            <i class="bi bi-percent" aria-hidden="true"></i>
            <span class="btn-text d-none d-md-inline">%</span>
          </label>

          <input type="radio" class="btn-check" name="displayMode" id="mode-volume" value="volume">
          <label class="btn btn-outline-success" for="mode-volume" title="Show as volume">
            <i class="bi bi-123" aria-hidden="true"></i>
            <span class="btn-text d-none d-md-inline">Vol</span>
          </label>

          <input type="radio" class="btn-check" name="displayMode" id="mode-cost" value="cost" disabled>
          <label class="btn btn-outline-success" for="mode-cost" title="Aktifkan Realisasi untuk input biaya">
            <i class="bi bi-cash-coin" aria-hidden="true"></i>
            <span class="btn-text d-none d-md-inline">Cost</span>
          </label>
        </div>
      </div>

    </div>
  </div>

  <!-- Toggle Button for Secondary Row (Grid View Only) -->
  <button class="btn btn-link btn-sm toolbar-toggle d-none d-lg-block" id="toolbar-toggle-btn" data-bs-toggle="collapse"
    data-bs-target="#toolbarSecondary" aria-expanded="true" aria-controls="toolbarSecondary">
    <i class="bi bi-chevron-up"></i>
    <span class="toggle-text">Hide Advanced Options</span>
  </button>
</div>
<!-- End toolbar-advanced-wrapper -->

<!-- Main App Container -->
<div id="tahapan-grid-app" data-project-id="{{ project.id }}"
  data-api-base="{% url 'detail_project:api_list_create_tahapan' project.id %}"
  data-api-tahapan="{% url 'detail_project:api_list_create_tahapan' project.id %}"
  data-api-list-pekerjaan="{% url 'detail_project:api_get_list_pekerjaan_tree' project.id %}"
  data-api-volume="{% url 'detail_project:api_list_volume_pekerjaan' project.id %}"
  data-api-assignments-base="/detail_project/api/project/{{ project.id }}/pekerjaan/"
  data-api-save="{% url 'detail_project:api_v2_assign_weekly' project.id %}" data-enable-uplot-kurva="true"
  data-project-name="{{ project.nama|escape }}" data-project-start="{{ project.tanggal_mulai|date:'Y-m-d'|default:'' }}"
  data-project-end="{{ project.tanggal_selesai|date:'Y-m-d'|default:'' }}" data-default-time-scale="weekly"
  data-default-input-mode="percentage" data-week-start-day="{{ project.week_start_day|default:0 }}"
  data-week-end-day="{{ project.week_end_day|default:6 }}"
  data-api-week-boundary="{% url 'detail_project:api_update_week_boundaries' project.id %}"
  data-api-regenerate-tahapan="{% url 'detail_project:api_v2_regenerate_tahapan' project.id %}"
  data-api-reset-progress="{% url 'detail_project:api_v2_reset_progress' project.id %}">

  <!-- Tab Navigation - unified container, mode switching via JS -->
  <ul class="nav nav-tabs mt-3" id="viewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="grid-tab" data-mode="grid" type="button" role="tab">
        <i class="bi bi-grid-3x3-gap"></i> Grid View
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="gantt-tab" data-mode="gantt" type="button" role="tab">
        <i class="bi bi-calendar3"></i> Gantt Chart
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="scurve-tab" data-mode="kurva" type="button" role="tab">
        <i class="bi bi-graph-up"></i> Kurva S
      </button>
    </li>
  </ul>

  <!-- UNIFIED Tab Content - ONE container for ALL modes -->
  <div class="tab-content" id="viewTabsContent">
    <div class="tab-pane fade show active" id="unified-view" role="tabpanel">
      <div class="tanstack-grid-section" id="tanstack-grid-section">
        <div id="tanstack-grid-container" class="tanstack-grid-container chart-view-container">
          <div class="tanstack-grid-body" id="tanstack-grid-body"></div>
        </div>
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-left">
          <span id="status-info">Ready</span>
          <span id="current-mode-label" class="badge bg-primary ms-2">Grid</span>
        </div>
        <div class="status-right">
          <span>Modified: <strong id="status-modified">0</strong></span>
          <span class="ms-3">Rows: <strong id="status-rows">0</strong></span>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Konfirmasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirm-message">Anda yakin?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="confirm-action">Ya, Lanjutkan</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">
          <i class="bi bi-check-circle"></i> Sukses
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="success-message">Operasi berhasil!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="exportModalLabel">
          <i class="bi bi-download"></i> Export Jadwal Pekerjaan
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Report Type Selection -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-file-earmark-text"></i> Jenis Laporan
          </label>
          <div class="list-group">
            <label class="list-group-item list-group-item-action d-flex align-items-start">
              <input class="form-check-input me-3 mt-1 flex-shrink-0" type="radio" name="reportType" value="full"
                id="reportTypeFull" checked>
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold">A. Rekap Laporan (Full Report)</h6>
                <small class="text-muted">
                  Laporan lengkap semua minggu:<br>
                  • Grid Views Full (Weekly Mode)<br>
                  • Gantt Chart Full<br>
                  • Kurva S Full (Weekly Granularity)
                </small>
              </div>
            </label>
            <label class="list-group-item list-group-item-action d-flex align-items-start">
              <input class="form-check-input me-3 mt-1 flex-shrink-0" type="radio" name="reportType" value="monthly"
                id="reportTypeMonthly">
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold">B. Laporan Bulanan (Monthly Report)</h6>
                <small class="text-muted">
                  Progress per bulan (4 minggu agregasi):<br>
                  • Grid Bulanan (M1, M2, M3...)<br>
                  • Kurva S Bulanan (Month Boundaries)
                </small>
              </div>
            </label>
            <label class="list-group-item list-group-item-action d-flex align-items-start">
              <input class="form-check-input me-3 mt-1 flex-shrink-0" type="radio" name="reportType" value="weekly"
                id="reportTypeWeekly">
              <div class="flex-grow-1">
                <h6 class="mb-1 fw-bold">C. Laporan Mingguan (Weekly Report)</h6>
                <small class="text-muted">
                  Progress per minggu dengan rentang tanggal:<br>
                  • Grid Mingguan (W1, W2, W3... dengan date ranges)<br>
                  • Kurva S Mingguan (Weekly Granularity)
                </small>
              </div>
            </label>
          </div>
        </div>

        <!-- Format Selection -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-filetype-pdf"></i> Format Export
          </label>
          <div class="btn-group w-100" role="group" aria-label="Export format selection">
            <input type="radio" class="btn-check" name="exportFormat" id="formatPdf" value="pdf" checked>
            <label class="btn btn-outline-danger" for="formatPdf">
              <i class="bi bi-file-earmark-pdf"></i> PDF
            </label>

            <!-- Word format disabled due to performance issues
            <input type="radio" class="btn-check" name="exportFormat" id="formatWord" value="word">
            <label class="btn btn-outline-primary" for="formatWord">
              <i class="bi bi-file-earmark-word"></i> Word
            </label>
            -->

            <input type="radio" class="btn-check" name="exportFormat" id="formatExcel" value="xlsx">
            <label class="btn btn-outline-success" for="formatExcel">
              <i class="bi bi-file-earmark-excel"></i> Excel
            </label>

            <input type="radio" class="btn-check" name="exportFormat" id="formatCsv" value="csv">
            <label class="btn btn-outline-secondary" for="formatCsv">
              <i class="bi bi-file-spreadsheet"></i> CSV
            </label>
          </div>
        </div>

        <!-- Chart Inclusion Options -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-bar-chart"></i> Sertakan Chart
          </label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="includeGantt" checked>
            <label class="form-check-label" for="includeGantt">
              <i class="bi bi-calendar3 text-primary"></i> Gantt Chart
              <small class="text-muted">(Hanya untuk Rekap Laporan)</small>
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="includeKurvaS" checked>
            <label class="form-check-label" for="includeKurvaS">
              <i class="bi bi-graph-up text-success"></i> Kurva S
              <small class="text-muted">(Granularity sesuai jenis laporan)</small>
            </label>
          </div>
        </div>

        <!-- Professional Report Format (Always Enabled for PDF/Word) -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-file-earmark-richtext"></i> Format Laporan
          </label>
          <!-- Hidden input - professional format is always enabled for PDF/Word -->
          <input type="hidden" id="useProfessionalFormat" value="true">
          <div class="alert alert-success py-2 px-3 small mb-0">
            <i class="bi bi-check-circle-fill text-success"></i>
            <strong>Laporan Tertulis Profesional</strong>
            <small class="text-muted d-block mt-1">
              Format resmi dengan Cover Page, Ringkasan Eksekutif, Grid Terpisah (Rencana vs Realisasi), dan Lembar
              Pengesahan.
            </small>
          </div>
          <div class="alert alert-warning mt-2 py-2 px-3 small" id="professionalFormatNote" style="display: none;">
            <i class="bi bi-info-circle"></i>
            Format profesional hanya tersedia untuk <strong>PDF</strong>.
            Untuk XLSX/CSV, akan menggunakan format data tabel standar.
          </div>
        </div>


        <!-- Period Selection for Monthly/Weekly (visible when using Professional + Monthly/Weekly) -->
        <div class="mb-4" id="periodSelectionSection" style="display: none;">
          <label class="form-label fw-bold">
            <i class="bi bi-calendar-range"></i> Pilih Periode
          </label>

          <!-- Single Period Input (for weekly) -->
          <div id="singlePeriodInput" class="row g-2">
            <div class="col-6">
              <label class="form-label small text-muted" id="periodLabel">Minggu ke-</label>
              <input type="number" class="form-control" id="periodNumber" min="1" value="1" placeholder="1">
            </div>
            <div class="col-6">
              <small class="text-muted d-block mt-4 pt-2">
                <i class="bi bi-info-circle"></i> Akan dibandingkan dengan periode sebelumnya
              </small>
            </div>
          </div>

          <!-- Multi-Month Selection (for monthly only) -->
          <div id="multiMonthInput" style="display: none;">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <label class="form-label small text-muted mb-0">Pilih bulan (bisa lebih dari satu)</label>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnSelectAllMonths">Semua</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClearMonths">Reset</button>
              </div>
            </div>
            <!-- Scrollable container for dynamic month checkboxes -->
            <div class="month-checkbox-grid d-flex flex-wrap gap-2" id="monthCheckboxGrid"
              style="max-height: 200px; overflow-y: auto; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
              <!-- Will be dynamically populated by initializeMonthCheckboxes() -->
              <span class="text-muted small">Loading months...</span>
            </div>
            <small class="text-muted d-block mt-2">
              <i class="bi bi-info-circle"></i> Setiap bulan akan memiliki Cover Page, Progress Pelaksanaan, dan Kurva S
              tersendiri dalam satu PDF.
            </small>
          </div>

          <!-- Multi-Week Selection (for weekly only) -->
          <div id="multiWeekInput" style="display: none;">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <label class="form-label small text-muted mb-0">Pilih minggu (bisa lebih dari satu)</label>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnSelectAllWeeks">Semua</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClearWeeks">Reset</button>
              </div>
            </div>
            <!-- Scrollable container for dynamic week checkboxes -->
            <div class="week-checkbox-grid d-flex flex-wrap gap-2" id="weekCheckboxGrid"
              style="max-height: 200px; overflow-y: auto; padding: 8px; border: 1px solid #dee2e6; border-radius: 6px;">
              <!-- Will be dynamically populated by initializeWeekCheckboxes() -->
              <span class="text-muted small">Loading weeks...</span>
            </div>
            <small class="text-muted d-block mt-2">
              <i class="bi bi-info-circle"></i> Setiap minggu akan memiliki Cover Page dan Progress Pelaksanaan. Semua
              minggu digabung dalam satu PDF.
            </small>
          </div>
        </div>


        <!-- Export Preview/Info -->
        <div class="alert alert-info mb-0" role="alert">
          <h6 class="alert-heading">
            <i class="bi bi-info-circle"></i> Informasi Export
          </h6>
          <p class="mb-2 small" id="exportPreviewText">
            <strong>Laporan:</strong> Rekap Laporan (Full Report)<br>
            <strong>Format:</strong> PDF<br>
            <strong>Charts:</strong> Gantt Chart, Kurva S<br>
            <strong>Halaman:</strong> Auto-paginated (smart splitting)
          </p>
          <hr>
          <p class="mb-0 small">
            <i class="bi bi-lightbulb text-warning"></i>
            Sistem akan otomatis memotong kolom/baris yang terlalu banyak dengan pengelompokan semantik
            (month boundaries, hierarchy-aware splitting).
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Batal
        </button>
        <button type="button" class="btn btn-primary" id="btnConfirmExport">
          <i class="bi bi-download"></i> Export Sekarang
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Export Progress Modal -->
<div class="modal fade" id="exportProgressModal" tabindex="-1" aria-labelledby="exportProgressLabel" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="exportProgressLabel">
          <i class="bi bi-hourglass-split"></i> Memproses Export...
        </h5>
      </div>
      <div class="modal-body text-center py-4">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-2 fw-bold" id="exportProgressStatus">Mempersiapkan data...</p>
        <p class="small text-muted mb-0" id="exportProgressDetail">Harap tunggu, proses mungkin memakan waktu beberapa
          detik.</p>
      </div>
    </div>
  </div>
</div>

<!-- Export Modal Preview Update Script -->
<script>
  (function () {
    'use strict';

    document.addEventListener('DOMContentLoaded', function () {
      const exportModal = document.getElementById('exportModal');
      if (!exportModal) return;

      const reportTypeInputs = exportModal.querySelectorAll('input[name="reportType"]');
      const formatInputs = exportModal.querySelectorAll('input[name="exportFormat"]');
      const includeGanttCheckbox = exportModal.querySelector('#includeGantt');
      const includeKurvaSCheckbox = exportModal.querySelector('#includeKurvaS');
      const exportPreviewText = exportModal.querySelector('#exportPreviewText');
      const useProfessionalCheckbox = exportModal.querySelector('#useProfessionalFormat');
      const professionalFormatNote = exportModal.querySelector('#professionalFormatNote');
      const periodSelectionSection = exportModal.querySelector('#periodSelectionSection');
      const periodLabel = exportModal.querySelector('#periodLabel');

      // Multi-month elements
      const singlePeriodInput = exportModal.querySelector('#singlePeriodInput');
      const multiMonthInput = exportModal.querySelector('#multiMonthInput');
      let monthCheckboxes = exportModal.querySelectorAll('input[name="months"]');
      const btnSelectAllMonths = exportModal.querySelector('#btnSelectAllMonths');
      const btnClearMonths = exportModal.querySelector('#btnClearMonths');
      const monthCheckboxGrid = exportModal.querySelector('#monthCheckboxGrid');

      // Multi-week elements
      const multiWeekInput = exportModal.querySelector('#multiWeekInput');
      let weekCheckboxes = exportModal.querySelectorAll('input[name="weeks"]');
      const btnSelectAllWeeks = exportModal.querySelector('#btnSelectAllWeeks');
      const btnClearWeeks = exportModal.querySelector('#btnClearWeeks');
      const weekCheckboxGrid = exportModal.querySelector('#weekCheckboxGrid');

      // Initialize week checkboxes dynamically based on project data
      function initializeWeekCheckboxes() {
        if (!weekCheckboxGrid) return;

        // Primary source: Django template variable (server-side calculated)
        // Note: Django evaluates {{ total_weeks|default:12 }} to an integer at render time
        let totalWeeks = parseInt('{{ total_weeks|default:12 }}', 10) || 12;

        // Fallback: Try to get from window.__JADWAL_APP_STATE__ (set by TanStackGridManager)
        if (window.__JADWAL_APP_STATE__ && window.__JADWAL_APP_STATE__.weekColumns) {
          const jsWeeks = window.__JADWAL_APP_STATE__.weekColumns.length;
          if (jsWeeks > totalWeeks) {
            totalWeeks = jsWeeks;
          }
        }

        // Minimum 4 weeks, max 200 weeks
        totalWeeks = Math.max(4, Math.min(200, totalWeeks));

        // Clear existing content
        weekCheckboxGrid.innerHTML = '';

        // Create checkboxes dynamically
        for (let w = 1; w <= totalWeeks; w++) {
          const label = document.createElement('label');
          label.className = 'btn btn-outline-info btn-sm week-checkbox';
          label.innerHTML = `<input type="checkbox" name="weeks" value="${w}" class="d-none"> Minggu ${w}`;
          weekCheckboxGrid.appendChild(label);
        }

        // Refresh the weekCheckboxes reference
        weekCheckboxes = exportModal.querySelectorAll('input[name="weeks"]');

        // Add event listeners to new checkboxes
        weekCheckboxes.forEach(cb => {
          cb.addEventListener('change', () => {
            updateWeekCheckboxStyling();
            updatePreview();
          });
        });

        console.log('[ExportModal] Initialized ' + totalWeeks + ' week checkboxes');
      }

      // Initialize month checkboxes dynamically based on project data
      function initializeMonthCheckboxes() {
        if (!monthCheckboxGrid) return;

        // Primary source: Django template variable (server-side calculated)
        let totalMonths = parseInt('{{ total_months|default:12 }}', 10) || 12;

        // Fallback: calculate from weeks if available
        if (window.__JADWAL_APP_STATE__ && window.__JADWAL_APP_STATE__.weekColumns) {
          const jsWeeks = window.__JADWAL_APP_STATE__.weekColumns.length;
          const jsMonths = Math.ceil(jsWeeks / 4);
          if (jsMonths > totalMonths) {
            totalMonths = jsMonths;
          }
        }

        // Minimum 1 month, max 50 months
        totalMonths = Math.max(1, Math.min(50, totalMonths));

        // Clear existing content
        monthCheckboxGrid.innerHTML = '';

        // Create checkboxes dynamically
        for (let m = 1; m <= totalMonths; m++) {
          const label = document.createElement('label');
          label.className = 'btn btn-outline-primary btn-sm month-checkbox';
          label.innerHTML = `<input type="checkbox" name="months" value="${m}" class="d-none"> Bulan ${m}`;
          monthCheckboxGrid.appendChild(label);
        }

        // Refresh the monthCheckboxes reference
        monthCheckboxes = exportModal.querySelectorAll('input[name="months"]');

        // Add event listeners to new checkboxes
        monthCheckboxes.forEach(cb => {
          cb.addEventListener('change', () => {
            updateMonthCheckboxStyling();
            updatePreview();
          });
        });

        console.log('[ExportModal] Initialized ' + totalMonths + ' month checkboxes');
      }

      const reportTypeLabels = {
        'full': 'Rekap Laporan (Full Report)',
        'monthly': 'Laporan Bulanan (Monthly Report)',
        'weekly': 'Laporan Mingguan (Weekly Report)'
      };

      const formatLabels = {
        'pdf': 'PDF',
        'word': 'Word (DOCX)',
        'xlsx': 'Excel (XLSX)',
        'csv': 'CSV'
      };


      // Update checkbox button styling for months
      function updateMonthCheckboxStyling() {
        monthCheckboxes.forEach(cb => {
          const label = cb.closest('label');
          if (label) {
            if (cb.checked) {
              label.classList.remove('btn-outline-primary');
              label.classList.add('btn-primary', 'active');
            } else {
              label.classList.remove('btn-primary', 'active');
              label.classList.add('btn-outline-primary');
            }
          }
        });
      }

      // Update checkbox button styling for weeks
      function updateWeekCheckboxStyling() {
        weekCheckboxes.forEach(cb => {
          const label = cb.closest('label');
          if (label) {
            if (cb.checked) {
              label.classList.remove('btn-outline-info');
              label.classList.add('btn-info', 'active');
            } else {
              label.classList.remove('btn-info', 'active');
              label.classList.add('btn-outline-info');
            }
          }
        });
      }

      // Get selected months array
      function getSelectedMonths() {
        const selected = [];
        monthCheckboxes.forEach(cb => {
          if (cb.checked) {
            selected.push(parseInt(cb.value, 10));
          }
        });
        return selected.sort((a, b) => a - b);
      }

      // Get selected weeks array
      function getSelectedWeeks() {
        const selected = [];
        weekCheckboxes.forEach(cb => {
          if (cb.checked) {
            selected.push(parseInt(cb.value, 10));
          }
        });
        return selected.sort((a, b) => a - b);
      }

      function updatePreview() {
        const selectedReportType = exportModal.querySelector('input[name="reportType"]:checked')?.value || 'full';
        const selectedFormat = exportModal.querySelector('input[name="exportFormat"]:checked')?.value || 'pdf';
        const includeGantt = includeGanttCheckbox?.checked;
        const includeKurvaS = includeKurvaSCheckbox?.checked;
        // Professional format is always enabled for PDF (Word disabled)
        const isPdf = (selectedFormat === 'pdf');
        const useProfessional = useProfessionalCheckbox?.type === 'checkbox'
          ? useProfessionalCheckbox.checked
          : (useProfessionalCheckbox?.value === 'true' || isPdf);

        // Show/hide period selection based on report type
        if (periodSelectionSection) {
          const showPeriod = useProfessional && (selectedReportType === 'monthly' || selectedReportType === 'weekly');
          periodSelectionSection.style.display = showPeriod ? 'block' : 'none';

          // Toggle between multi-month (monthly) and multi-week (weekly)
          if (singlePeriodInput && multiMonthInput && multiWeekInput) {
            singlePeriodInput.style.display = 'none'; // Never show single input anymore
            if (selectedReportType === 'monthly') {
              multiMonthInput.style.display = 'block';
              multiWeekInput.style.display = 'none';
            } else if (selectedReportType === 'weekly') {
              multiMonthInput.style.display = 'none';
              multiWeekInput.style.display = 'block';
            } else {
              multiMonthInput.style.display = 'none';
              multiWeekInput.style.display = 'none';
            }
          }
        }


        // Show warning if XLSX/CSV selected (professional not available for those)
        if (professionalFormatNote) {
          const showWarning = !isPdf;
          professionalFormatNote.style.display = showWarning ? 'block' : 'none';
        }


        const charts = [];
        if (includeGantt && selectedReportType === 'full') {
          charts.push('Gantt Chart');
        }
        if (includeKurvaS) {
          charts.push('Kurva S');
        }

        const chartsText = charts.length > 0 ? charts.join(', ') : 'Tidak ada chart';

        // Build preview text
        let previewHtml = `
          <strong>Laporan:</strong> ${reportTypeLabels[selectedReportType]}<br>
          <strong>Format:</strong> ${formatLabels[selectedFormat]}<br>
          <strong>Charts:</strong> ${chartsText}<br>
        `;

        if (useProfessional) {
          previewHtml += `<strong>Mode:</strong> <span class="text-success">Laporan Tertulis Profesional ✓</span><br>`;
          previewHtml += `<strong>Fitur:</strong> Cover Page, `;
          if (selectedReportType === 'full') {
            previewHtml += `Daftar Isi, Grid Terpisah (Rencana/Realisasi)`;
          } else if (selectedReportType === 'monthly') {
            // Show selected months info
            const selectedMonths = getSelectedMonths();
            if (selectedMonths.length > 0) {
              if (selectedMonths.length === 1) {
                previewHtml += `Bulan ${selectedMonths[0]}`;
              } else {
                previewHtml += `Bulan ${selectedMonths[0]}-${selectedMonths[selectedMonths.length - 1]} (${selectedMonths.length} bulan)`;
              }
            } else {
              previewHtml += `<span class="text-warning">Pilih minimal 1 bulan</span>`;
            }
          } else if (selectedReportType === 'weekly') {
            // Show selected weeks info
            const selectedWeeks = getSelectedWeeks();
            if (selectedWeeks.length > 0) {
              if (selectedWeeks.length === 1) {
                previewHtml += `Minggu ${selectedWeeks[0]}`;
              } else {
                previewHtml += `Minggu ${selectedWeeks[0]}-${selectedWeeks[selectedWeeks.length - 1]} (${selectedWeeks.length} minggu)`;
              }
            } else {
              previewHtml += `<span class="text-warning">Pilih minimal 1 minggu</span>`;
            }
          } else {
          }
        } else {
          previewHtml += `<strong>Halaman:</strong> Auto-paginated (smart splitting)`;
        }

        if (exportPreviewText) {
          exportPreviewText.innerHTML = previewHtml;
        }

        // Disable/enable Gantt checkbox based on report type
        if (includeGanttCheckbox) {
          if (selectedReportType !== 'full') {
            includeGanttCheckbox.checked = false;
            includeGanttCheckbox.disabled = true;
            includeGanttCheckbox.parentElement.classList.add('text-muted');
          } else {
            includeGanttCheckbox.disabled = false;
            includeGanttCheckbox.parentElement.classList.remove('text-muted');
          }
        }
      }

      // Listen to changes
      reportTypeInputs.forEach(input => input.addEventListener('change', updatePreview));
      formatInputs.forEach(input => input.addEventListener('change', updatePreview));
      if (includeGanttCheckbox) includeGanttCheckbox.addEventListener('change', updatePreview);
      if (includeKurvaSCheckbox) includeKurvaSCheckbox.addEventListener('change', updatePreview);
      if (useProfessionalCheckbox) useProfessionalCheckbox.addEventListener('change', updatePreview);

      // Month checkbox event listeners
      monthCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          updateMonthCheckboxStyling();
          updatePreview();
        });
      });

      // Select All / Reset buttons
      if (btnSelectAllMonths) {
        btnSelectAllMonths.addEventListener('click', () => {
          monthCheckboxes.forEach(cb => cb.checked = true);
          updateMonthCheckboxStyling();
          updatePreview();
        });
      }

      if (btnClearMonths) {
        btnClearMonths.addEventListener('click', () => {
          monthCheckboxes.forEach(cb => cb.checked = false);
          updateMonthCheckboxStyling();
          updatePreview();
        });
      }

      // Week checkbox event listeners
      weekCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          updateWeekCheckboxStyling();
          updatePreview();
        });
      });

      // Select All / Reset buttons for weeks
      if (btnSelectAllWeeks) {
        btnSelectAllWeeks.addEventListener('click', () => {
          weekCheckboxes.forEach(cb => cb.checked = true);
          updateWeekCheckboxStyling();
          updatePreview();
        });
      }

      if (btnClearWeeks) {
        btnClearWeeks.addEventListener('click', () => {
          weekCheckboxes.forEach(cb => cb.checked = false);
          updateWeekCheckboxStyling();
          updatePreview();
        });
      }

      // Initial preview update
      updatePreview();

      // Initialize month checkboxes dynamically on load
      initializeMonthCheckboxes();
      updateMonthCheckboxStyling();

      // Initialize week checkboxes dynamically on load
      initializeWeekCheckboxes();
      updateWeekCheckboxStyling();

      // Reinitialize checkboxes when modal is shown (in case app state updated)
      exportModal.addEventListener('show.bs.modal', function () {
        // Re-check week/month count from latest app state
        initializeMonthCheckboxes();
        initializeWeekCheckboxes();
        updateMonthCheckboxStyling();
        updateWeekCheckboxStyling();
        updatePreview();
      });
    });
  })();
</script>

{% endblock %}

{% block extra_js %}
<!-- html2canvas for full view capture (Grid + Chart overlay) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Unified Export Manager -->
<script src="{% static 'detail_project/js/export/ExportManager.js' %}"></script>

<!-- Tab-based Advanced Options Toggle -->
<script>
  (function () {
    'use strict';

    document.addEventListener('DOMContentLoaded', function () {
      const toolbarSecondary = document.getElementById('toolbarSecondary');
      const toolbarToggleBtn = document.getElementById('toolbar-toggle-btn');
      const viewTabs = document.getElementById('viewTabs');

      if (!toolbarSecondary || !viewTabs) return;
      /**        * Show/hide Advanced Options based on active tab        * - Grid View: Show Advanced Options        * - Gantt/S-Curve: Hide Advanced Options        */
      function updateAdvancedOptionsVisibility(activeTabId) {
        const isGridView = activeTabId === 'grid-tab';

        if (isGridView) {
          // Show Advanced Options for Grid View
          toolbarSecondary.classList.remove('d-none');
          if (toolbarToggleBtn) toolbarToggleBtn.classList.remove('d-none');
        } else {
          // Hide Advanced Options for Gantt/S-Curve
          toolbarSecondary.classList.add('d-none');
          if (toolbarToggleBtn) toolbarToggleBtn.classList.add('d-none');
        }
      }

      // Listen for tab clicks (unified container - no Bootstrap tab switching)
      viewTabs.addEventListener('click', function (event) {
        const tabBtn = event.target.closest('[data-mode]');
        if (tabBtn) {
          updateAdvancedOptionsVisibility(tabBtn.id);
        }
      });

      // Set initial state based on active tab
      const activeTab = viewTabs.querySelector('.nav-link.active');
      if (activeTab) {
        updateAdvancedOptionsVisibility(activeTab.id);
      }
    });
  })();
</script>


<!-- MODERN VITE MODULE LOADING -->
{% if DEBUG and use_vite_dev_server %}
{# Development mode: Load from Vite dev server with HMR #}
<script type="module" src="http://localhost:5173/@vite/client"></script>
<script type="module" src="http://localhost:5173/js/src/jadwal_kegiatan_app.js"></script>
<script>
  console.log('%c🔥 VITE DEV MODE', 'background: #646cff; color: white; padding: 4px 8px; border-radius: 3px;');
  console.log('Hot Module Replacement (HMR) enabled');
  console.log('Dev server: http://localhost:5173');
</script>
{% else %}
{# Production mode: Load built assets via manifest (JS + CSS) #}
{% vite_entry 'assets/js/jadwal-kegiatan.js' as jadwal_entry %}
{% for css_asset in jadwal_entry.css %}
<link rel="stylesheet" href="{% static css_asset %}">
{% endfor %}
<script type="module" src="{% static jadwal_entry.file %}"></script>
<script>le.log('%cdY"? PRODUCTION MODE', 'background: #42b983; color: white; padding: 4px 8px; border-radius: 3px;');
  console.log('Using built assets from static/dist/ (manifest resolved)');
</script>
{% endif %}

{% comment %}
=============================================================================
MIGRATION NOTE (2025-11-19):

This template ONLY loads modern Vite-based modules.
Legacy scripts (kelola_tahapan_page_bootstrap.js, etc.) are NOT loaded.

If you need to rollback ke stack lama:
1. Ubah view untuk merender `kelola_tahapan_grid_LEGACY.html`.
2. Nonaktifkan Vite dev server dan gunakan bundel statis lama (build manual diperlukan).

Modern stack provides:
- ✅ ES6 modules with tree-shaking
- ✅ Hot Module Replacement (HMR) in dev
- ✅ Code splitting & lazy loading
- ✅ Better performance (28% smaller bundle)
- ✅ Modern debugging with source maps
- ✅ No memory leaks (event delegation)
=============================================================================
{% endcomment %}

{% endblock %}