{% extends "detail_project/base_detail.html" %}
{% load static vite %}

{% block body_attrs %}data-page="jadwal_pekerjaan"{% endblock %}

{% block title %}Jadwal Pekerjaan - {{ project.nama }}{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_css %}
<!-- Core Styles -->
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan_grid.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/toolbar-responsive.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/validation-enhancements.css' %}">

<!-- AG Grid CSS (always load, minimal overhead) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-theme-alpine.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-theme-alpine-dark.css">

<!-- Chart Libraries CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
<!-- NEW: Redesigned Gantt CSS -->
<link rel="stylesheet" href="{% static 'detail_project/css/gantt-chart-redesign.css' %}">
{% endblock %}

{% block dp_content %}
<!-- Toolbar - Responsive Redesign (Phase 2E.1+) -->
<div id="kt-toolbar" class="toolbar-container dp-sticky-topbar dp-layer-toolbar">
  <!-- Primary Row (Always Visible) -->
  <div class="toolbar-primary">
    <div class="toolbar-left">
      <h1 class="toolbar-title">Jadwal Pekerjaan</h1>
      <div class="toolbar-subtitle-row">
        <span class="toolbar-subtitle">{{ project.nama }}</span>
        <span id="progress-mode-indicator" class="badge bg-info">
          Mode: Perencanaan
        </span>
      </div>
    </div>

      <!-- Progress Mode Tabs (Phase 2E.1 - Always Visible) -->
      <div class="btn-group btn-group-sm progress-mode-tabs" role="tablist" aria-label="Progress Mode Selection">
        <input type="radio" class="btn-check" name="progressMode" id="mode-planned" value="planned" checked>
        <label class="btn btn-outline-info" for="mode-planned"
               role="tab" aria-selected="true" aria-controls="grid-content"
               title="Mode Perencanaan: Input progress yang direncanakan">
          <i class="bi bi-calendar-check" aria-hidden="true"></i>
          <span class="btn-text">Perencanaan</span>
        </label>

        <input type="radio" class="btn-check" name="progressMode" id="mode-actual" value="actual">
        <label class="btn btn-outline-warning" for="mode-actual"
               role="tab" aria-selected="false" aria-controls="grid-content"
               title="Mode Realisasi: Input progress yang sudah terealisasi">
          <i class="bi bi-clipboard-data" aria-hidden="true"></i>
          <span class="btn-text">Realisasi</span>
        </label>
      </div>

      <!-- Display Mode Toggle -->
      <div class="btn-group btn-group-sm display-mode-toggle" role="group">
        <input type="radio" class="btn-check" name="displayMode" id="mode-percentage" value="percentage" checked>
        <label class="btn btn-outline-success" for="mode-percentage" title="Show as percentage">
          <i class="bi bi-percent" aria-hidden="true"></i>
          <span class="btn-text d-none d-md-inline">%</span>
        </label>

        <input type="radio" class="btn-check" name="displayMode" id="mode-volume" value="volume">
        <label class="btn btn-outline-success" for="mode-volume" title="Show as volume">
          <i class="bi bi-123" aria-hidden="true"></i>
          <span class="btn-text d-none d-md-inline">Vol</span>
        </label>

        <input type="radio" class="btn-check" name="displayMode" id="mode-cost" value="cost" disabled>
        <label class="btn btn-outline-success" for="mode-cost" title="Aktifkan Realisasi untuk input biaya">
          <i class="bi bi-cash-coin" aria-hidden="true"></i>
          <span class="btn-text d-none d-md-inline">Cost</span>
        </label>
      </div>

      <!-- Primary Action Buttons -->
      <button type="button" class="btn btn-primary btn-sm btn-save" id="save-button"
              aria-label="Save all changes" title="Save all changes">
        <i class="bi bi-save" aria-hidden="true"></i>
        <span class="btn-text">Save</span>
      </button>

      <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-button"
              aria-label="Refresh data from server" title="Refresh data">
        <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
      </button>

      <!-- More Menu (Mobile/Tablet) -->
      <div class="dropdown toolbar-more">
        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle"
                data-bs-toggle="dropdown" aria-expanded="false" aria-label="More options">
          <i class="bi bi-three-dots-vertical" aria-hidden="true"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
          <li class="dropdown-header">Actions</li>
          <li>
            <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-reset-progress-mobile">
              <i class="bi bi-arrow-counterclockwise text-danger"></i> Reset Progress
            </button>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li class="dropdown-header">Export</li>
          <li>
            <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-csv">
              <i class="bi bi-file-earmark-spreadsheet text-success"></i> Export CSV
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-xlsx">
              <i class="bi bi-file-earmark-excel text-success"></i> Export XLSX
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-pdf">
              <i class="bi bi-file-earmark-pdf text-danger"></i> Export PDF
            </button>
          </li>
          <li>
            <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-word">
              <i class="bi bi-file-earmark-word text-primary"></i> Export Word
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Secondary Row (Collapsible - Desktop Only) -->
  <div class="toolbar-secondary collapse show" id="toolbarSecondary">
    <div class="toolbar-controls-group">
      <!-- Time Scale Selector -->
      <div class="control-group">
        <label class="control-label">Time Scale</label>
        <div class="btn-group btn-group-sm time-scale-selector" role="group">
          <input type="radio" class="btn-check" name="timeScale" id="scale-daily" value="daily">
          <label class="btn btn-outline-primary" for="scale-daily">Daily</label>

          <input type="radio" class="btn-check" name="timeScale" id="scale-weekly" value="weekly" checked>
          <label class="btn btn-outline-primary" for="scale-weekly">Weekly</label>

          <input type="radio" class="btn-check" name="timeScale" id="scale-monthly" value="monthly">
          <label class="btn btn-outline-primary" for="scale-monthly">Monthly</label>

          <input type="radio" class="btn-check" name="timeScale" id="scale-custom" value="custom">
          <label class="btn btn-outline-primary" for="scale-custom">Custom</label>
        </div>
      </div>

      {% with start_day=project.week_start_day|default:0 end_day=project.week_end_day|default:6 %}
      <!-- Week Boundary Controls -->
      <div class="control-group week-boundary-controls">
        <label class="control-label">Week Boundaries</label>
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm" id="week-start-day-select" aria-label="Week start day">
            <option value="0" {% if start_day == 0 %}selected{% endif %}>Sen</option>
            <option value="1" {% if start_day == 1 %}selected{% endif %}>Sel</option>
            <option value="2" {% if start_day == 2 %}selected{% endif %}>Rab</option>
            <option value="3" {% if start_day == 3 %}selected{% endif %}>Kam</option>
            <option value="4" {% if start_day == 4 %}selected{% endif %}>Jum</option>
            <option value="5" {% if start_day == 5 %}selected{% endif %}>Sab</option>
            <option value="6" {% if start_day == 6 %}selected{% endif %}>Min</option>
          </select>
          <span class="align-self-center text-muted">–</span>
          <select class="form-select form-select-sm" id="week-end-day-select" aria-label="Week end day">
            <option value="0" {% if end_day == 0 %}selected{% endif %}>Sen</option>
            <option value="1" {% if end_day == 1 %}selected{% endif %}>Sel</option>
            <option value="2" {% if end_day == 2 %}selected{% endif %}>Rab</option>
            <option value="3" {% if end_day == 3 %}selected{% endif %}>Kam</option>
            <option value="4" {% if end_day == 4 %}selected{% endif %}>Jum</option>
            <option value="5" {% if end_day == 5 %}selected{% endif %}>Sab</option>
            <option value="6" {% if end_day == 6 %}selected{% endif %}>Min</option>
          </select>
        </div>
      </div>
      {% endwith %}

      <!-- Secondary Actions -->
      <div class="control-group ms-auto">
        <button type="button" class="btn btn-danger btn-sm" id="btn-reset-progress"
                title="Reset progress (mode aktif) ke 0% - data mode lain tetap aman">
          <i class="bi bi-arrow-counterclockwise"></i>
          <span class="btn-text">Reset</span>
        </button>

        <div class="btn-group">
          <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle"
                  data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-download"></i>
            <span class="btn-text">Export</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm">
            <li>
              <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-csv-alt">
                <i class="bi bi-file-earmark-spreadsheet text-success"></i> Export CSV
              </button>
            </li>
            <li>
              <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-xlsx-alt">
                <i class="bi bi-file-earmark-excel text-success"></i> Export XLSX
              </button>
            </li>
            <li>
              <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-pdf-alt">
                <i class="bi bi-file-earmark-pdf text-danger"></i> Export PDF
              </button>
            </li>
            <li>
              <button class="dropdown-item d-flex align-items-center gap-2" type="button" id="btn-export-word-alt">
                <i class="bi bi-file-earmark-word text-primary"></i> Export Word
              </button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Toggle Button for Secondary Row -->
  <button class="btn btn-link btn-sm toolbar-toggle d-none d-lg-block"
          data-bs-toggle="collapse"
          data-bs-target="#toolbarSecondary"
          aria-expanded="true"
          aria-controls="toolbarSecondary">
    <i class="bi bi-chevron-up"></i>
    <span class="toggle-text">Hide Advanced Options</span>
  </button>
</div>

<!-- Main App Container -->
<div id="tahapan-grid-app"
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/"
     data-api-tahapan="{% url 'detail_project:api_list_create_tahapan' project.id %}"
     data-api-list-pekerjaan="{% url 'detail_project:api_get_list_pekerjaan_tree' project.id %}"
     data-api-volume="{% url 'detail_project:api_list_volume_pekerjaan' project.id %}"
     data-api-assignments-base="/detail_project/api/project/{{ project.id }}/pekerjaan/"
     data-api-save="{% url 'detail_project:api_v2_assign_weekly' project.id %}"
     data-enable-ag-grid="{% if enable_ag_grid %}true{% else %}false{% endif %}"
     data-project-name="{{ project.nama|escape }}"
     data-project-start="{{ project.tanggal_mulai|date:'Y-m-d'|default:'' }}"
     data-project-end="{{ project.tanggal_selesai|date:'Y-m-d'|default:'' }}"
     data-default-time-scale="weekly"
     data-default-input-mode="percentage"
     data-week-start-day="{{ project.week_start_day|default:0 }}"
     data-week-end-day="{{ project.week_end_day|default:6 }}"
     data-api-week-boundary="{% url 'detail_project:api_update_week_boundaries' project.id %}"
     data-api-regenerate-tahapan="{% url 'detail_project:api_v2_regenerate_tahapan' project.id %}"
     data-api-reset-progress="{% url 'detail_project:api_v2_reset_progress' project.id %}">

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mt-3" id="viewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab" aria-controls="grid-view" aria-selected="true">
        <i class="bi bi-grid-3x3-gap"></i> Grid View
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="gantt-tab" data-bs-toggle="tab" data-bs-target="#gantt-view" type="button" role="tab" aria-controls="gantt-view" aria-selected="false">
        <i class="bi bi-calendar3"></i> Gantt
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="scurve-tab" data-bs-toggle="tab" data-bs-target="#scurve-view" type="button" role="tab" aria-controls="scurve-view" aria-selected="false">
        <i class="bi bi-graph-up"></i> S-Curve
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="viewTabsContent">
    <!-- Grid View Tab -->
    <div class="tab-pane fade show active" id="grid-view" role="tabpanel" aria-labelledby="grid-tab">
        <div class="ag-grid-section">
          <div class="horizontal-scroll-wrapper" id="ag-grid-scroll-top">
            <div class="horizontal-scroll-inner" id="ag-grid-scroll-inner"></div>
          </div>
          <div id="ag-grid-container"
               class="ag-theme-alpine ag-grid-wrapper"
               style="width: 100%; min-height: 600px;">
            <!-- AG Grid mounts here -->
          </div>
          {% if not enable_ag_grid %}
            <div class="alert alert-warning mt-3">
              AG Grid dinonaktifkan melalui <code>ENABLE_AG_GRID=False</code>.
              Legacy grid telah dipensiunkan di Phase 4 sehingga kontainer di atas
              tidak akan terinisialisasi sampai Anda mengaktifkannya kembali.
            </div>
          {% endif %}
        </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-left">
          <span id="status-info">Ready</span>
        </div>
        <div class="status-right">
          <span>Modified: <strong id="status-modified">0</strong></span>
          <span class="ms-3">Rows: <strong id="status-rows">0</strong></span>
        </div>
      </div>
    </div>

    <!-- Gantt View Tab - REDESIGNED -->
    <div class="tab-pane fade" id="gantt-view" role="tabpanel" aria-labelledby="gantt-tab">
      {# NEW Gantt Chart Redesign - Modern split-view layout #}
      <div id="gantt-redesign-container" class="gantt-redesign-wrapper">
        {# Initial loading state #}
        <div class="gantt-initial-loader">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading Gantt Chart...</span>
          </div>
          <p class="mt-3 text-muted">Initializing Gantt Chart...</p>
        </div>
      </div>

      {# OLD Gantt Chart - COMPLETELY HIDDEN (fallback only) #}
      <div style="display: none !important; visibility: hidden !important;">
        <div id="gantt-container" class="gantt-container">
          <div class="gantt-chart-panel">
            <div class="gantt-toolbar">
              <div class="gantt-toolbar-left">
                <h6 class="gantt-title mb-0">Gantt Chart (Perencanaan &amp; Realisasi)</h6>
              </div>
              <div class="gantt-legend" id="gantt-legend">
                <span class="gantt-legend-item">
                  <span class="legend-dot legend-dot-planned"></span> Rencana
                </span>
                <span class="gantt-legend-item">
                  <span class="legend-dot legend-dot-actual"></span> Realisasi
                </span>
              </div>
            </div>
            <div class="gantt-layout">
              <div class="gantt-tree-panel" id="gantt-tree-panel">
                <div class="gantt-tree-header">
                  <span>Klasifikasi &amp; Pekerjaan</span>
                </div>
                <div class="gantt-tree-scroll" id="gantt-tree-scroll">
                  <div class="gantt-tree-body" id="gantt-tree-body">
                    <div class="text-muted text-center py-3">Menyiapkan data...</div>
                  </div>
                </div>
              </div>
              <div class="gantt-chart-wrapper" id="gantt-chart-wrapper">
                <div id="gantt-chart" style="min-height: 520px;"></div>
              </div>
            </div>
          </div>
          <div class="gantt-summary mt-4">
            <div class="gantt-summary-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Ringkasan Pekerjaan</h6>
              <span class="text-muted" id="gantt-summary-total"></span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-striped gantt-summary-table" id="gantt-summary-table">
                <thead>
                  <tr>
                    <th style="width: 60px;">#</th>
                    <th>Pekerjaan</th>
                    <th style="width: 220px;">Rencana</th>
                    <th style="width: 220px;">Realisasi</th>
                    <th style="width: 120px;">Deviasi</th>
                  </tr>
                </thead>
                <tbody id="gantt-summary-body">
                  <tr>
                    <td colspan="5" class="text-muted text-center">Menunggu data Gantt...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- S-Curve View Tab -->
    <div class="tab-pane fade" id="scurve-view" role="tabpanel" aria-labelledby="scurve-tab">
      <div id="scurve-container" style="height: 600px; padding: 20px;">
        <div id="scurve-chart" style="width: 100%; height: 560px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Konfirmasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="confirm-message">Anda yakin?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="confirm-action">Ya, Lanjutkan</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">
          <i class="bi bi-check-circle"></i> Sukses
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="success-message">Operasi berhasil!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart Libraries (CDN with fallback) -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"
        onerror="window.__loadLocalEcharts && window.__loadLocalEcharts();"></script>
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

<script>
  // ECharts fallback loader
  window.__loadLocalEcharts = function() {
    if (window.__echartsFallbackLoaded) return;
    window.__echartsFallbackLoaded = true;

    const script = document.createElement('script');
    script.src = "{% static 'detail_project/js/vendor/echarts.min.js' %}";
    script.onload = () => console.info('[Jadwal] ECharts loaded from fallback');
    script.onerror = () => console.error('[Jadwal] ECharts fallback failed');
    document.head.appendChild(script);
  };

  if (typeof window.echarts === 'undefined') {
    window.__loadLocalEcharts();
  }
</script>

<!-- Unified Export Manager -->
<script src="{% static 'detail_project/js/export/ExportManager.js' %}"></script>

<!-- MODERN VITE MODULE LOADING -->
{% if DEBUG and use_vite_dev_server %}
  {# Development mode: Load from Vite dev server with HMR #}
  <script type="module" src="http://localhost:5173/@vite/client"></script>
  <script type="module" src="http://localhost:5173/js/src/jadwal_kegiatan_app.js"></script>
  <script>
    console.log('%cdYs? VITE DEV MODE', 'background: #646cff; color: white; padding: 4px 8px; border-radius: 3px;');
    console.log('Hot Module Replacement (HMR) enabled');
    console.log('Dev server: http://localhost:5173');
  </script>
{% else %}
  {# Production mode: Load built assets via manifest (JS + CSS) #}
  {% vite_entry 'assets/js/jadwal-kegiatan.js' as jadwal_entry %}
  {% for css_asset in jadwal_entry.css %}
    <link rel="stylesheet" href="{% static css_asset %}">
  {% endfor %}
  <script type="module" src="{% static jadwal_entry.file %}"></script>
  <script>
    console.log('%cdY"? PRODUCTION MODE', 'background: #42b983; color: white; padding: 4px 8px; border-radius: 3px;');
    console.log('Using built assets from static/dist/ (manifest resolved)');
  </script>
{% endif %}

{% comment %}
=============================================================================
MIGRATION NOTE (2025-11-19):

This template ONLY loads modern Vite-based modules.
Legacy scripts (kelola_tahapan_page_bootstrap.js, etc.) are NOT loaded.

If you need to rollback to legacy:
1. Change view to use: kelola_tahapan_grid_LEGACY.html
2. Or set: ENABLE_AG_GRID = False and USE_VITE_DEV_SERVER = False

Modern stack provides:
- ✅ ES6 modules with tree-shaking
- ✅ Hot Module Replacement (HMR) in dev
- ✅ Code splitting & lazy loading
- ✅ Better performance (28% smaller bundle)
- ✅ Modern debugging with source maps
- ✅ No memory leaks (event delegation)
=============================================================================
{% endcomment %}

{% endblock %}
