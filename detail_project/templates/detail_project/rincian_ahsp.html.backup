{% extends "detail_project/base_detail.html" %}
{% load static %}

{% block title %}Rincian AHSP — {{ project.nama }}{% endblock %}
{% block body_attrs %}data-page="rincian_ahsp"{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_head %}
  {{ block.super }}
  {# Selaraskan UI/UX dengan Template AHSP; hindari harga_items.css untuk mencegah konflik gaya #}
  <link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
  <link rel="stylesheet" href="{% static 'detail_project/css/template_ahsp_enhanced.css' %}">
  <link rel="stylesheet" href="{% static 'detail_project/css/rincian_ahsp.css' %}">
{% endblock %}

{# Gunakan toolbar di dalam konten agar parity dengan template_ahsp #}
{% block dp_toolbar %}{% endblock %}

{% block dp_content %}
<div id="rekap-app"
     class="ta-app"
     data-project-id="{{ project.id }}"
     data-ep-rekap="{% url 'detail_project:api_get_rekap_rab' project.id %}"
     data-ep-pricing="{% url 'detail_project:api_project_pricing' project.id %}"
     data-ep-detail-prefix="{% url 'detail_project:api_get_detail_ahsp' project.id 0 %}"
     data-ep-pricing-item-prefix="{% url 'detail_project:api_pekerjaan_pricing' project.id 0 %}"
     data-ep-reset-prefix="{% url 'detail_project:api_reset_detail_ahsp_to_ref' project.id 0 %}"
     data-locale="id-ID">

  <!-- Header (parity) -->
  <header class="ta-page-header">
    <h1 class="ta-title">Rincian AHSP</h1>
    <p class="ta-subtitle">Detail komponen AHSP per pekerjaan (dengan harga dan total).</p>
  </header>

  <!-- Toolbar (sticky, konsisten SSOT) -->
  <div id="ra-toolbar" class="ta-toolbar dp-toolbar d-flex align-items-center gap-2 flex-wrap mb-3 dp-sticky-topbar dp-layer-toolbar ux-toolbar-inputs" role="toolbar" aria-label="Toolbar Rincian AHSP">
    <!-- Searchbar (adapt lp-toolbar-search) -->
    <div class="ta-combobox ta-searchbar flex-grow-1" role="search">
      <div class="input-group dp-toolbar-search ta-toolbar-search">
        <span class="input-group-text" id="ra-search-addon">
          <i class="bi bi-search" aria-hidden="true"></i>
        </span>
        <input id="ra-job-search"
               type="search"
               class="form-control ux-focusable"
               placeholder="Cari pekerjaan…"
               autocomplete="off"
               aria-label="Cari pekerjaan"
               aria-describedby="ra-search-addon">
        <button id="ra-toolbar-find"
                class="btn btn-primary dp-btn dp-btn-sm btn-neon ms-1"
                type="button"
                title="Cari">
          <i class="bi bi-search"></i> Cari
        </button>
      </div>
    </div>


    {# Hint keyboard dihapus sesuai permintaan #}

    <!-- Export (dropdown, konsisten dengan Rekap) -->
    <div class="btn-group dp-btn-group ux-dropdown">
      <button type="button" class="btn btn-outline-primary dp-btn dp-btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Export options">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Export</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><button class="dropdown-item" type="button" id="ra-btn-export"><i class="bi bi-file-earmark-spreadsheet text-success me-2"></i>Export CSV</button></li>
        <li><button class="dropdown-item" type="button" id="ra-btn-export-pdf"><i class="bi bi-file-earmark-pdf text-danger me-2"></i>Export PDF</button></li>
        <li><button class="dropdown-item" type="button" id="ra-btn-export-word"><i class="bi bi-file-earmark-word text-primary me-2"></i>Export Word</button></li>
      </ul>
    </div>

    <!-- Metrics (BUK & Grand Total - spesifik untuk Rincian AHSP) -->
    <div class="d-inline-flex align-items-center gap-2">
      <span class="badge text-bg-light" id="rk-badge-buk" title="Biaya Umum &amp; Keuntungan proyek">BUK: 10.00%</span>
      <div id="rk-grand" class="ux-mono small text-muted" aria-live="polite">Grand Total: Rp 0,00</div>
    </div>

    <!-- Dirty indicator -->
    <div class="ta-dirty-indicator d-inline-flex align-items-center small text-muted" aria-live="polite">
      <span id="ra-dirty-dot" class="dot me-1" hidden>●</span>
      <span id="ra-dirty-text" hidden>Belum disimpan</span>
    </div>

    <button type="button" class="btn btn-outline-secondary dp-btn dp-btn-sm" data-bs-toggle="modal" data-bs-target="#raHelpModal" aria-label="Buka bantuan">
      <i class="bi bi-question-circle"></i>
      <span class="d-none d-sm-inline">Bantuan</span>
    </button>

    <!-- Simpan -->
    <button id="ra-btn-save" class="btn btn-success dp-btn dp-btn-sm d-inline-flex align-items-center gap-2" type="button" disabled>
      <span class="spinner-border spinner-border-sm" id="ra-btn-save-spin" role="status" aria-hidden="true" hidden></span>
      <i class="bi bi-save" aria-hidden="true"></i>
      <span class="d-none d-sm-inline">Simpan</span>
    </button>
  </div>

  <!-- Body grid: LEFT (list) | RESIZER | RIGHT (detail) -->
  <div class="ta-body">
    <!-- LEFT: daftar pekerjaan -->
    <aside class="rk-left ta-sidebar" aria-label="Daftar pekerjaan">
      <ul id="rk-list" class="ta-job-list" role="listbox" aria-label="Pekerjaan">
        <li class="rk-item ta-job-item"><div class="row-note">Memuat…</div></li>
      </ul>
    </aside>

    <!-- RESIZER -->
    <div id="rk-resizer" class="rk-resizer ux-resizer" role="separator" aria-orientation="vertical" aria-label="Resize panel" tabindex="0"></div>

    <!-- RIGHT: header + tabel detail satu pekerjaan -->
    <section class="rk-right ta-editor" aria-label="Detail pekerjaan terpilih">
      <!-- Header pekerjaan (parity feel) -->
      <div class="rk-right-header ta-seg-header">
        <div class="rk-right-head-main">
          <div class="ux-mono mono small text-muted rk-right-meta">
            <span id="rk-pkj-kode">-</span> &middot;
            <span id="rk-pkj-sat">—</span>
            &nbsp;&nbsp;<span id="rk-pkj-source" class="rk-chip ta-chip">—</span>
          </div>
          <div id="rk-pkj-uraian" class="rk-right-title ta-title">Pilih pekerjaan di kiri</div>
        </div>

        <!-- Pricing efektif + override -->
        <div class="rk-right-actions d-flex align-items-center gap-2">
          <span id="rk-eff" class="rk-chip ta-chip ux-mono mono" title="BUK efektif">
            <i class="bi bi-lightning-charge"></i>&nbsp;Efektif: —%
          </span>
          <span id="rk-pkj-ovr-chip" class="rk-chip ta-chip-warn ux-mono mono" hidden>
            <i class="bi bi-sliders"></i>&nbsp;Override
          </span>
          <div class="input-group input-group-sm" style="width:160px">
            <span class="input-group-text ux-mono mono">%</span>
            <input id="rk-ovr-input" type="text" inputmode="decimal" class="form-control ux-mono mono" placeholder="Override" aria-label="Override BUK">
          </div>
          <div class="btn-group btn-group-sm">
            <button id="rk-ovr-apply" class="btn btn-primary btn-neon d-inline-flex align-items-center gap-1" type="button">
              <i class="bi bi-check2"></i><span>Apply</span>
            </button>
            <button id="rk-ovr-clear" class="btn btn-outline-secondary d-inline-flex align-items-center gap-1" type="button">
              <i class="bi bi-x-lg"></i><span>Clear</span>
            </button>
            <button id="rk-btn-reset" class="btn btn-outline-warning d-inline-flex align-items-center gap-1" type="button" title="Reset ke Referensi">
              <i class="bi bi-arrow-repeat"></i><span>Reset</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Summary ringkas -->
      <div id="rk-summary" class="rk-summary d-flex flex-wrap gap-2 my-2">
        <span class="ux-badge-ref ux-mono mono" id="rk-sum-sub">Sub-Total: —</span>
        <span class="ux-badge-ref ux-mono mono" id="rk-sum-buk">BUK (—%): —</span>
        <span class="ux-badge-ref ux-mono mono" id="rk-sum-grand">Grand Total: —</span>
      </div>

      <!-- Tabel detail -->
      <div class="ta-table-wrap">
        <table id="ra-table" class="table table-sm ra-table ta-table table-hover" aria-label="Rincian AHSP (pekerjaan terpilih)">
          <colgroup>
            <col class="col-no">
            <col class="col-uraian">
            <col class="col-kode">
            <col class="col-satuan">
            <col class="col-koef">
            <col class="col-rps">
            <col class="col-rpj">
          </colgroup>
          <thead class="ta-thead-sticky">
            <tr>
              <th scope="col">No</th>
              <th scope="col">Uraian</th>
              <th scope="col">Kode</th>
              <th scope="col" class="text-center">Satuan</th>
              <th scope="col" class="text-end">Koefisien</th>
              <th scope="col" class="text-end">Harga Satuan (Rp)</th>
              <th scope="col" class="text-end">Jumlah Harga (Rp)</th>
            </tr>
          </thead>
          <tbody id="rk-tbody-detail">
            <tr><td colspan="7" class="row-note">Pilih pekerjaan untuk melihat rincian.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="rk-toast" class="rk-toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal: Bantuan Rincian AHSP -->
  <div class="modal fade" id="raHelpModal" tabindex="-1" aria-labelledby="raHelpLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="raHelpLabel">Bantuan Rincian AHSP</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">Detail komponen AHSP per pekerjaan dengan harga dan total.</p>
          <ul>
            <li>Pilih pekerjaan dari sidebar kiri untuk melihat rincian komponen.</li>
            <li>Lihat detail harga satuan dan jumlah harga untuk setiap komponen (TK, BHN, ALT, LAIN).</li>
            <li>Gunakan kontrol <strong>Override</strong> untuk mengatur BUK kustom per pekerjaan.</li>
            <li>Tombol <strong>Apply</strong> untuk menerapkan override, <strong>Clear</strong> untuk menghapus override, <strong>Reset</strong> untuk kembali ke referensi.</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'detail_project/js/rincian_ahsp.js' %}"></script>
{% endblock %}
