{% extends 'detail_project/base_detail.html' %}
{% load static %}

{# Set data-page di body #}
{% block body_attrs %}data-page="rincian_rab"{% endblock %}

{% block title %}Rincian RAB â€“ {{ project.nama }}{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'detail_project/css/core.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/rekap_rab.css' %}">
{% endblock %}

{% block dp_content %}
<div id="rincian-rab-app" class="container-fluid"
     data-project-id="{{ project.id }}"
     data-api-url="{% url 'detail_project:api_get_rincian_rab' project.id %}">

  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 mb-0">Rincian RAB</h1>
    <div class="d-flex gap-2">
      <button id="btn-refresh" class="btn btn-outline-secondary btn-sm" type="button"
              title="Muat ulang data">
        <i class="bi bi-arrow-repeat"></i> Refresh
      </button>

      <!-- Export Dropdown -->
      <div class="btn-group">
        <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle"
                data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-download"></i> Export
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="{% url 'detail_project:api_export_rincian_rab_csv' project.id %}"
               download>
              <i class="bi bi-file-earmark-spreadsheet text-success me-2"></i>Export CSV
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="input-group mb-3" style="max-width: 400px;">
    <span class="input-group-text">
      <i class="bi bi-search"></i>
    </span>
    <input id="rincian-search" type="search" class="form-control"
           placeholder="Cari pekerjaan..." autocomplete="off">
  </div>

  <!-- Table Wrapper -->
  <div class="table-responsive">
    <table class="table table-hover table-sm align-middle" id="rincian-table">
      <thead class="table-light">
        <tr>
          <th scope="col">No</th>
          <th scope="col">Uraian Pekerjaan</th>
          <th scope="col">Kode AHSP</th>
          <th scope="col" class="text-center">Satuan</th>
          <th scope="col" class="text-end">Volume</th>
          <th scope="col" class="text-end">Harga Satuan (Rp)</th>
          <th scope="col" class="text-end">Jumlah Harga (Rp)</th>
        </tr>
      </thead>
      <tbody id="rincian-tbody">
        <!-- Loading State -->
        <tr id="loading-row">
          <td colspan="7" class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm me-2" role="status">
              <span class="visually-hidden">Memuat...</span>
            </div>
            <span>Memuat data Rincian RAB...</span>
          </td>
        </tr>
      </tbody>
      <tfoot class="table-secondary">
        <tr>
          <th colspan="6" class="text-end">Total Biaya:</th>
          <th id="total-harga" class="text-end">Rp 0</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Empty State (hidden by default) -->
  <div id="empty-state" class="text-center py-5 d-none" role="status">
    <i class="bi bi-inbox display-4 text-muted"></i>
    <p class="mt-3 text-muted">Belum ada data Rincian RAB.</p>
    <p class="small text-muted">
      Pastikan data pekerjaan dan volume sudah terisi.
    </p>
  </div>

</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
(function() {
  'use strict';

  const app = document.getElementById('rincian-rab-app');
  if (!app) return;

  const projectId = app.dataset.projectId;
  const apiUrl = app.dataset.apiUrl;
  const tbody = document.getElementById('rincian-tbody');
  const loadingRow = document.getElementById('loading-row');
  const emptyState = document.getElementById('empty-state');
  const searchInput = document.getElementById('rincian-search');
  const totalEl = document.getElementById('total-harga');
  const btnRefresh = document.getElementById('btn-refresh');

  let allData = [];
  let filteredData = [];

  // Format currency
  function formatRupiah(value) {
    return 'Rp ' + new Intl.NumberFormat('id-ID', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(value || 0);
  }

  // Load data from API
  async function loadData() {
    try {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border spinner-border-sm me-2"></div>Memuat data...</td></tr>';
      emptyState.classList.add('d-none');

      const response = await fetch(apiUrl);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      allData = data.items || [];
      filteredData = [...allData];

      renderTable();

    } catch (error) {
      console.error('[Rincian RAB] Load error:', error);
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">
        <i class="bi bi-exclamation-triangle me-2"></i>
        Gagal memuat data: ${error.message}
      </td></tr>`;
    }
  }

  // Render table
  function renderTable() {
    if (filteredData.length === 0) {
      tbody.innerHTML = '';
      emptyState.classList.remove('d-none');
      totalEl.textContent = 'Rp 0';
      return;
    }

    emptyState.classList.add('d-none');

    let html = '';
    let grandTotal = 0;

    filteredData.forEach((item, index) => {
      const jumlahHarga = (item.volume || 0) * (item.harga_satuan || 0);
      grandTotal += jumlahHarga;

      html += `
        <tr>
          <td>${index + 1}</td>
          <td>${item.uraian || '-'}</td>
          <td><code class="small">${item.kode_ahsp || '-'}</code></td>
          <td class="text-center">${item.satuan || '-'}</td>
          <td class="text-end">${(item.volume || 0).toLocaleString('id-ID')}</td>
          <td class="text-end">${formatRupiah(item.harga_satuan)}</td>
          <td class="text-end fw-semibold">${formatRupiah(jumlahHarga)}</td>
        </tr>
      `;
    });

    tbody.innerHTML = html;
    totalEl.textContent = formatRupiah(grandTotal);
  }

  // Search filter
  function filterData() {
    const query = searchInput.value.toLowerCase().trim();

    if (!query) {
      filteredData = [...allData];
    } else {
      filteredData = allData.filter(item => {
        return (item.uraian || '').toLowerCase().includes(query) ||
               (item.kode_ahsp || '').toLowerCase().includes(query);
      });
    }

    renderTable();
  }

  // Event listeners
  if (searchInput) {
    searchInput.addEventListener('input', filterData);
  }

  if (btnRefresh) {
    btnRefresh.addEventListener('click', loadData);
  }

  // Initial load
  loadData();

})();
</script>
{% endblock %}
