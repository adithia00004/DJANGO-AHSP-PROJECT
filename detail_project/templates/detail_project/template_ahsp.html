{% extends "detail_project/base_detail.html" %}
{% load static i18n %}
{% block title %}Template AHSP — {{ project.nama }}{% endblock %}
{% block body_attrs %}data-page="template_ahsp"{% endblock %}

{% block detail_css %}
  <link rel="stylesheet" href="{% static 'detail_project/css/template_ahsp.css' %}">
{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
{% endblock %}

{% block extra_js_head %}
  {{ block.super }}
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
{% endblock %}

{% block dp_topbar_extra %}{% endblock %}

{% block dp_content %}
<div id="ta-app"
     class="ta-app"
     data-project-id="{{ project.id }}"
     data-locale="id-ID"
     data-endpoint-get-pattern="{% url 'detail_project:api_get_detail_ahsp' project.id 0 %}"
     data-endpoint-save-pattern="{% url 'detail_project:api_save_detail_ahsp_for_pekerjaan' project.id 0 %}"
     data-endpoint-reset-pattern="{% url 'detail_project:api_reset_detail_ahsp_to_ref' project.id 0 %}"
     data-endpoint-rekap="{% url 'detail_project:api_get_rekap_rab' project.id %}"
     data-endpoint-harga-items="{% url 'detail_project:api_list_harga_items' project.id %}"
     data-endpoint-search-ahsp="{% url 'detail_project:api_search_ahsp' project.id %}">

  <!-- Header -->
  <header class="ta-page-header">
    <h1 class="ta-title">Template AHSP</h1>
    <p class="ta-subtitle">Kelola komponen AHSP per pekerjaan. (Tanpa kolom harga)</p>
  </header>

  <!-- Toolbar (sticky, konsisten SSOT) -->
  <div id="ta-toolbar" class="ta-toolbar d-flex align-items-center gap-2 flex-wrap mb-3 dp-sticky-topbar dp-layer-toolbar border-bottom ux-toolbar-inputs" role="toolbar" aria-label="Toolbar Template AHSP">
    <!-- Searchbar (adapt lp-toolbar-search) -->
    <div class="ta-combobox ta-searchbar flex-grow-1" role="search">
      <div class="input-group lp-toolbar-search">
        <span class="input-group-text" id="ta-search-addon">
          <i class="bi bi-search" aria-hidden="true"></i>
        </span>
        <input id="ta-job-search"
               type="search"
               class="form-control ux-focusable"
               placeholder="{% trans 'Cari pekerjaan…' %}"
               autocomplete="off"
               aria-label="{% trans 'Cari pekerjaan' %}"
               aria-describedby="ta-search-addon">
        <button id="ta-toolbar-find"
                class="btn btn-primary btn-neon ms-1"
                type="button"
                title="{% trans 'Cari' %}">
          <i class="bi bi-search"></i> {% trans "Cari" %}
        </button>
      </div>
    </div>


    <div class="ta-toolbar-hint only-desktop ms-2 me-auto">
      <span class="kbd-hint"><kbd>Ctrl</kbd>+<kbd>Z</kbd> undo &middot; <kbd>Ctrl</kbd>+<kbd>Y</kbd> redo</span>
    </div>

    <!-- Export (dropdown, konsisten dengan Rekap) -->
    <div class="btn-group ux-dropdown">
      <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Export options">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Export</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><button class="dropdown-item" type="button" id="ta-btn-export"><i class="bi bi-file-earmark-spreadsheet text-success me-2"></i>Export CSV</button></li>
        <li><button class="dropdown-item" type="button" id="ta-btn-export-pdf"><i class="bi bi-file-earmark-pdf text-danger me-2"></i>Export PDF</button></li>
        <li><button class="dropdown-item" type="button" id="ta-btn-export-word"><i class="bi bi-file-earmark-word text-primary me-2"></i>Export Word</button></li>
      </ul>
    </div>

    <!-- Dirty indicator -->
    <div class="ta-dirty-indicator d-inline-flex align-items-center small text-muted" aria-live="polite">
      <span id="ta-dirty-dot" class="dot me-1" hidden>●</span>
      <span id="ta-dirty-text" hidden>Belum disimpan</span>
    </div>

    <!-- Simpan -->
    <button id="ta-btn-save" class="btn btn-success btn-sm d-inline-flex align-items-center gap-2" type="button" disabled>
      <span class="spinner-border spinner-border-sm" id="ta-btn-save-spin" role="status" aria-hidden="true" hidden></span>
      <i class="bi bi-save" aria-hidden="true"></i>
      <span class="d-none d-sm-inline">Simpan</span>
    </button>
  </div>

  <div class="ta-body">
    <!-- Sidebar pekerjaan -->
    <aside class="ta-sidebar" aria-label="Daftar pekerjaan">
      <ul id="ta-job-list" class="ta-job-list">
        {% for p in pekerjaan %}
          <li class="ta-job-item"
              tabindex="0"
              role="button"
              data-pekerjaan-id="{{ p.id }}"
              data-source-type="{{ p.source_type }}">
            <div class="primary">
              <span class="kode">{{ p.snapshot_kode|default:"-" }}</span>
              <span class="uraian">{{ p.snapshot_uraian }}</span>
            </div>
            <div class="meta">
              <span class="satuan">{{ p.snapshot_satuan }}</span>
              {% if p.source_type == 'ref' %}
                <span class="ux-badge-ref mono">REF</span>
              {% elif p.source_type == 'ref_modified' %}
                <span class="ux-badge-mod mono">MOD</span>
              {% elif p.source_type == 'custom' %}
                <span class="ux-badge-cus mono">CUS</span>
              {% endif %}
            </div>
          </li>
        {% empty %}
          <li class="ta-empty">Belum ada pekerjaan yang bisa ditampilkan.</li>
        {% endfor %}
      </ul>
    </aside>

    <!-- Resizer -->
    <div id="ta-resizer" class="ux-resizer" role="separator" aria-orientation="vertical" tabindex="0" aria-label="Resize panel"></div>

    <!-- Panel editor -->
    <main class="ta-editor" aria-label="Editor Template AHSP">
      <section class="ta-job-header">
        <div class="row">
          <div class="cell">
            <div class="label">Kode</div>
            <div id="ta-active-kode" class="value mono">—</div>
          </div>
          <div class="cell wide">
            <div class="label">Uraian</div>
            <div id="ta-active-uraian" class="value">—</div>
          </div>
          <div class="cell">
            <div class="label">Satuan</div>
            <div id="ta-active-satuan" class="value">—</div>
          </div>
          <div class="cell">
            <div class="label">Sumber</div>
            <div id="ta-active-source" class="value"><span class="badge">—</span></div>
          </div>
        </div>
      </section>

      <!-- Segmen TK -->
      <section class="ta-segment" data-seg="TK">
        <header class="ta-seg-header">
          <h2>Tenaga Kerja</h2>
          <div class="seg-tools btn-group btn-group-sm" role="group" aria-label="Aksi segmen TK">
            <button class="btn btn-primary btn-sm ta-seg-add-empty d-inline-flex align-items-center gap-1" type="button" data-target-seg="TK">
              <i class="bi bi-plus-circle"></i><span class="d-none d-sm-inline">Baris</span>
            </button>
            <button class="btn btn-outline-danger btn-sm ta-seg-del-selected d-inline-flex align-items-center gap-1" type="button" data-target-seg="TK" disabled>
              <i class="bi bi-trash"></i><span class="d-none d-sm-inline">Hapus <span class="ta-del-count" data-for="TK">0</span> baris</span>
            </button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table ux-thead" aria-label="Tabel TK">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-TK-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Segmen BHN -->
      <section class="ta-segment" data-seg="BHN">
        <header class="ta-seg-header">
          <h2>Bahan</h2>
          <div class="seg-tools btn-group btn-group-sm" role="group" aria-label="Aksi segmen BHN">
            <button class="btn btn-primary btn-sm ta-seg-add-empty d-inline-flex align-items-center gap-1" type="button" data-target-seg="BHN">
              <i class="bi bi-plus-circle"></i><span class="d-none d-sm-inline">Baris</span>
            </button>
            <button class="btn btn-outline-danger btn-sm ta-seg-del-selected d-inline-flex align-items-center gap-1" type="button" data-target-seg="BHN" disabled>
              <i class="bi bi-trash"></i><span class="d-none d-sm-inline">Hapus <span class="ta-del-count" data-for="BHN">0</span> baris</span>
            </button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table ux-thead" aria-label="Tabel BHN">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-BHN-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Segmen ALT -->
      <section class="ta-segment" data-seg="ALT">
        <header class="ta-seg-header">
          <h2>Peralatan</h2>
          <div class="seg-tools btn-group btn-group-sm" role="group" aria-label="Aksi segmen ALT">
            <button class="btn btn-primary btn-sm ta-seg-add-empty d-inline-flex align-items-center gap-1" type="button" data-target-seg="ALT">
              <i class="bi bi-plus-circle"></i><span class="d-none d-sm-inline">Baris</span>
            </button>
            <button class="btn btn-outline-danger btn-sm ta-seg-del-selected d-inline-flex align-items-center gap-1" type="button" data-target-seg="ALT" disabled>
              <i class="bi bi-trash"></i><span class="d-none d-sm-inline">Hapus <span class="ta-del-count" data-for="ALT">0</span> baris</span>
            </button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table ux-thead" aria-label="Tabel ALT">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-ALT-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Segmen LAIN -->
      <section class="ta-segment" data-seg="LAIN">
        <header class="ta-seg-header">
          <h2>Lainnya</h2>
          <div class="seg-tools btn-group btn-group-sm" role="group" aria-label="Aksi segmen LAIN">
            <button class="btn btn-primary btn-sm ta-seg-add-empty d-inline-flex align-items-center gap-1" type="button" data-target-seg="LAIN">
              <i class="bi bi-plus-circle"></i><span class="d-none d-sm-inline">Baris</span>
            </button>
            <button class="btn btn-outline-danger btn-sm ta-seg-del-selected d-inline-flex align-items-center gap-1" type="button" data-target-seg="LAIN" disabled>
              <i class="bi bi-trash"></i><span class="d-none d-sm-inline">Hapus <span class="ta-del-count" data-for="LAIN">0</span> baris</span>
            </button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table ux-thead" aria-label="Tabel LAIN">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-LAIN-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- RESET pindah ke bawah (dekat footer) -->
      <div class="ta-reset-area">
        <button id="ta-btn-reset" class="btn btn-warning btn-sm" type="button" hidden>
          Reset ke Referensi
        </button>
        <div class="hint small text-muted mt-1">
          Hanya muncul untuk pekerjaan sumber <strong>MOD</strong> (ref_modified).
        </div>
      </div>

      <footer class="ta-editor-footer">
        <div id="ta-row-stats">0 baris</div>
        <div class="hint">Tip: <kbd>Ctrl/⌘+S</kbd> Simpan; <kbd>Enter</kbd>/<kbd>Shift+Enter</kbd> pindah sel; <kbd>Del</kbd> hapus baris.</div>
      </footer>
    </main>
  </div>

  <!-- Template row -->
  <template id="ta-row-template">
    <tr class="ta-row">
      <td class="col-no"><span class="row-index">1</span></td>

      <td class="col-uraian">
        <div class="cell-wrap" contenteditable="true" data-field="uraian" spellcheck="false"></div>
      </td>

      <td class="col-kode">
        <input type="text" class="cell-input mono" data-field="kode">
        <input type="hidden" data-field="ref_ahsp_id">
      </td>

      <td class="col-satuan">
        <input type="text" class="cell-input" data-field="satuan">
      </td>

      <td class="col-koef">
        <input type="text" class="cell-input num" data-field="koefisien" inputmode="decimal">
      </td>
    </tr>
  </template>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'detail_project/js/template_ahsp.js' %}" defer></script>
{% endblock %}
