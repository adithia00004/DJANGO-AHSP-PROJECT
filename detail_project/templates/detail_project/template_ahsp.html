{% extends "detail_project/base_detail.html" %}
{% load static %}
{% block title %}Template AHSP — {{ project.nama }}{% endblock %}
{% block body_attrs %}data-page="template_ahsp"{% endblock %}

{% block detail_css %}
  {# Biarkan default css detail_ahsp dari base load #}
  <link rel="stylesheet" href="{% static 'detail_project/css/template_ahsp.css' %}">
{% endblock %}

{# Select2 (autocomplete untuk segmen LAIN) #}
{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
{% endblock %}

{% block extra_js_head %}
  {{ block.super }}
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
{% endblock %}

{% block dp_topbar_extra %}{% endblock %}

{% block dp_content %}
<div id="ta-app"
     class="ta-app"
     data-project-id="{{ project.id }}"
     data-locale="id-ID"
     data-endpoint-get-pattern="{% url 'detail_project:api_get_detail_ahsp' project.id 0 %}"      {# 0 diganti JS #}
     data-endpoint-save-pattern="{% url 'detail_project:api_save_detail_ahsp_for_pekerjaan' project.id 0 %}"
     data-endpoint-reset-pattern="{% url 'detail_project:api_reset_detail_ahsp_to_ref' project.id 0 %}"
     data-endpoint-rekap="{% url 'detail_project:api_get_rekap_rab' project.id %}"
     data-endpoint-harga-items="{% url 'detail_project:api_list_harga_items' project.id %}"
     data-endpoint-search-ahsp="{% url 'detail_project:api_search_ahsp' project.id %}">

  {# Header halaman #}
  <header class="ta-page-header">
    <h1 class="ta-title">Template AHSP</h1>
    <p class="ta-subtitle">Kelola komponen AHSP per pekerjaan. (Tanpa kolom harga)</p>
  </header>

  {# Toolbar sticky (id diperlukan untuk pengukuran tinggi oleh JS) #}
  <div id="ta-toolbar" class="ta-toolbar" role="region" aria-label="Toolbar Template AHSP">
    <div class="ta-combobox">
      <input id="ta-job-search" class="ta-input" type="text" placeholder="Cari pekerjaan…"
             aria-label="Cari pekerjaan" autocomplete="off">
    </div>

    <div class="ta-toolbar-spacer"></div>

    <button id="ta-btn-export" class="btn btn-light btn-sm" type="button">Ekspor CSV</button>

    <div class="ta-dirty-indicator" aria-live="polite">
      <span id="ta-dirty-dot" class="dot" hidden>●</span>
      <span id="ta-dirty-text" hidden>Belum disimpan</span>
    </div>

    <button id="ta-btn-reset" class="btn btn-warning btn-sm" type="button" hidden>Reset ke Referensi</button>
    <button id="ta-btn-save" class="btn btn-primary btn-sm" type="button" disabled>Simpan</button>
  </div>

  <div class="ta-body">
    {# Sidebar pekerjaan #}
    <aside class="ta-sidebar" aria-label="Daftar pekerjaan">
      <ul id="ta-job-list" class="ta-job-list">
        {% for p in pekerjaan %}
          <li class="ta-job-item"
              tabindex="0"
              role="button"
              data-pekerjaan-id="{{ p.id }}"
              data-source-type="{{ p.source_type }}">
            <div class="primary">
              <span class="kode">{{ p.snapshot_kode|default:"-" }}</span>
              <span class="uraian">{{ p.snapshot_uraian }}</span>
            </div>
            <div class="meta">
              <span class="satuan">{{ p.snapshot_satuan }}</span>
              {% if p.source_type == 'ref' %}
                <span class="badge">REF</span>
              {% elif p.source_type == 'ref_modified' %}
                <span class="badge">MOD</span>
              {% elif p.source_type == 'custom' %}
                <span class="badge">CUS</span>
              {% endif %}
            </div>
          </li>
        {% empty %}
          <li class="ta-empty">Belum ada pekerjaan yang bisa ditampilkan.</li>
        {% endfor %}
      </ul>
    </aside>

    {# Panel editor #}
    <main class="ta-editor" aria-label="Editor Template AHSP">
      <section class="ta-job-header">
        <div class="row">
          <div class="cell">
            <div class="label">Kode</div>
            <div id="ta-active-kode" class="value mono">—</div>
          </div>
          <div class="cell wide">
            <div class="label">Uraian</div>
            <div id="ta-active-uraian" class="value">—</div>
          </div>
          <div class="cell">
            <div class="label">Satuan</div>
            <div id="ta-active-satuan" class="value">—</div>
          </div>
          <div class="cell">
            <div class="label">Sumber</div>
            <div id="ta-active-source" class="value"><span class="badge">—</span></div>
          </div>
        </div>
      </section>

      {# Segmen TK — Tenaga Kerja #}
      <section class="ta-segment" data-seg="TK">
        <header class="ta-seg-header">
          <h2>Tenaga Kerja</h2>
          <div class="seg-tools">
            <button class="btn btn-light btn-sm ta-seg-add-empty" type="button" data-target-seg="TK">+ Baris kosong</button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table" aria-label="Tabel TK">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-TK-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      {# Segmen BHN — Bahan #}
      <section class="ta-segment" data-seg="BHN">
        <header class="ta-seg-header">
          <h2>Bahan</h2>
          <div class="seg-tools">
            <button class="btn btn-light btn-sm ta-seg-add-empty" type="button" data-target-seg="BHN">+ Baris kosong</button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table" aria-label="Tabel BHN">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-BHN-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      {# Segmen ALT — Peralatan #}
      <section class="ta-segment" data-seg="ALT">
        <header class="ta-seg-header">
          <h2>Peralatan</h2>
          <div class="seg-tools">
            <button class="btn btn-light btn-sm ta-seg-add-empty" type="button" data-target-seg="ALT">+ Baris kosong</button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table" aria-label="Tabel ALT">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-ALT-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      {# Segmen LAIN — Lainnya #}
      <section class="ta-segment" data-seg="LAIN">
        <header class="ta-seg-header">
          <h2>Lainnya</h2>
          <div class="seg-tools">
            <button class="btn btn-light btn-sm ta-seg-add-empty" type="button" data-target-seg="LAIN">+ Baris kosong</button>
          </div>
        </header>
        <div class="ta-table-wrap">
          <table class="ta-table" aria-label="Tabel LAIN">
            <colgroup>
              <col class="col-no">
              <col class="col-uraian">
              <col class="col-kode">
              <col class="col-satuan">
              <col class="col-koef">
            </colgroup>
            <thead class="ta-thead-sticky">
              <tr>
                <th class="col-no">No</th>
                <th class="col-uraian">Uraian</th>
                <th class="col-kode">Kode item</th>
                <th class="col-satuan">Satuan</th>
                <th class="col-koef">Koefisien</th>
              </tr>
            </thead>
            <tbody id="seg-LAIN-body">
              <tr class="ta-empty"><td colspan="5">Belum ada item.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <footer class="ta-editor-footer">
        <div id="ta-row-stats">0 baris</div>
        <div class="hint">Tip: <kbd>Ctrl/⌘+S</kbd> Simpan; <kbd>Enter</kbd>/<kbd>Shift+Enter</kbd> pindah sel; <kbd>Del</kbd> hapus baris.</div>
      </footer>
    </main>
  </div>

  {# Template row #}
  <template id="ta-row-template">
    <tr class="ta-row">
      <td class="col-no"><span class="row-index">1</span></td>

      <td class="col-uraian">
        <div class="cell-wrap" contenteditable="true" data-field="uraian" spellcheck="false"></div>
      </td>

      <td class="col-kode">
        <input type="text" class="cell-input mono" data-field="kode">
        <input type="hidden" data-field="ref_ahsp_id">  {# hidden bundle ref di kolom kode #}
      </td>

      <td class="col-satuan">
        <input type="text" class="cell-input" data-field="satuan">
      </td>

      <td class="col-koef">
        <input type="text" class="cell-input num" data-field="koefisien" inputmode="decimal">
      </td>
    </tr>
  </template>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'detail_project/js/template_ahsp.js' %}" defer></script>
{% endblock %}
