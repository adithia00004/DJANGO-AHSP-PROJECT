{% extends 'detail_project/base_detail.html' %}
{% load static i18n %}
{% block body_attrs %}data-page="list_pekerjaan"{% endblock %}

{# ===== [0] MATIKAN CSS Detail AHSP DI HALAMAN INI ===== #}
{% block detail_css %}{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/list_pekerjaan.css' %}">
{% endblock %}

{% block dp_content %}
{# ===== [A] ALERT (GLOBAL) ===== #}
{% include 'detail_project/_alert.html' %}

{# ===== [B] ROOT WRAPPER / PAGE SHELL ===== #}
<div id="lp-app" class="lp-app container-fluid list-pekerjaan ux-scrollbar ux-scroll-smooth"
  data-project-id="{{ project.id }}" data-ref-year="{{ project.tahun_project|default:'' }}" data-dom-version="lp-v2"
  data-compact-default="1">

  {# Page Title #}
  <h1 class="h5 mb-3">{% trans "List Pekerjaan" %}</h1>

  {# ===== [C] TOOLBAR (Redesigned - Consistent with other pages) ===== #}
  <div id="lp-toolbar"
    class="dp-toolbar lp-toolbar d-flex align-items-center gap-2 flex-wrap mb-3 dp-sticky-topbar dp-layer-toolbar border-bottom px-3 ux-toolbar-inputs"
    role="toolbar" aria-label="{% trans 'Toolbar List Pekerjaan' %}">

    {# Left Section: Primary Actions #}
    <div class="d-flex align-items-center gap-2">
      <button id="btn-add-klas" class="btn btn-sm btn-primary dp-btn lp-btn" type="button"
        title="{% trans 'Tambah Klasifikasi' %}">
        <i class="bi bi-plus-circle" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">{% trans "Klasifikasi" %}</span>
      </button>

      <button id="btn-compact" class="btn btn-sm btn-outline-secondary dp-btn lp-btn" type="button" data-state="off"
        title="{% trans 'Compact mode' %}">
        <i class="bi bi-aspect-ratio" aria-hidden="true"></i>
        <span class="d-none d-md-inline">{% trans "Compact" %}</span>
      </button>
    </div>

    {# Middle Section: Search (flex-grow) #}
    <div class="position-relative flex-grow-1 lp-searchbar" role="search" style="max-width: 400px;">
      <div class="input-group lp-toolbar-search">
        <span class="input-group-text"><i class="bi bi-search" aria-hidden="true"></i></span>
        <input id="lp-nav-search" type="search" class="form-control lp-nav-search ux-focusable"
          placeholder="{% trans 'Cari di navigasiâ€¦' %}" autocomplete="off" aria-label="{% trans 'Cari di navigasi' %}">
      </div>
      <span id="lp-toolbar-announce" class="dp-visually-hidden" aria-live="polite"></span>
    </div>

    {# Right Section: Template, Export, Save & Info #}
    <div class="ms-auto d-flex align-items-center gap-2">
      {# Template dropdown button - NEW #}
      <div class="btn-group">
        <button type="button" class="btn btn-sm btn-primary dp-btn lp-btn dropdown-toggle" data-bs-toggle="dropdown"
          aria-expanded="false" title="{% trans 'Template Pekerjaan' %}">
          <i class="bi bi-collection" aria-hidden="true"></i>
          <span class="d-none d-md-inline">{% trans "Template" %}</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <button class="dropdown-item" type="button" data-action="open-sidebar">
              <i class="bi bi-grid-3x3-gap"></i> {% trans "Lihat Template Library" %}
            </button>
          </li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li>
            <button id="btn-toolbar-save-template" class="dropdown-item" type="button">
              <i class="bi bi-bookmark-plus text-success"></i> {% trans "Simpan Sebagai Template" %}
            </button>
          </li>
          <li>
            <button id="btn-toolbar-import-file" class="dropdown-item" type="button">
              <i class="bi bi-upload text-primary"></i> {% trans "Import dari File" %}
            </button>
          </li>
          <li>
            <a class="dropdown-item" href="{% url 'detail_project:export_template_json' project.id %}" download>
              <i class="bi bi-download text-success"></i> {% trans "Export Template JSON" %}
            </a>
          </li>
        </ul>
      </div>

      {# Info tooltip about drag-and-drop impact #}
      <button type="button" class="btn btn-sm btn-outline-info dp-btn lp-btn" data-bs-toggle="tooltip"
        data-bs-placement="bottom" data-bs-html="true"
        title="<strong>ðŸ’¡ Drag & Drop</strong><br><small>Perubahan urutan akan mempengaruhi semua halaman terkait.</small>">
        <i class="bi bi-info-circle" aria-hidden="true"></i>
      </button>

      <button id="btn-save" class="btn btn-sm btn-success dp-btn lp-btn d-inline-flex align-items-center gap-2"
        type="button" title="{% trans 'Simpan perubahan' %}" aria-live="polite">
        <i class="bi bi-save" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">{% trans "Simpan" %}</span>
      </button>
    </div>
  </div>

  {# P2: Banner notification about cross-page impact #}
  <div class="alert alert-info alert-dismissible fade show mx-3 mb-3" role="alert">
    <div class="d-flex align-items-start gap-2">
      <i class="bi bi-lightbulb flex-shrink-0" style="font-size: 1.25rem;"></i>
      <div class="flex-grow-1 small">
        <strong>Fitur Drag & Drop Aktif</strong><br>
        Anda dapat mengubah urutan pekerjaan dengan drag & drop pada kolom nomor <span
          class="badge bg-secondary">â‹®â‹®</span>.
        Perubahan urutan akan otomatis tersinkronisasi ke semua halaman terkait setelah disimpan.
      </div>
      <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>

  {# ===== [D] LAYOUT: OVERLAY NAV + MAIN ===== #}
  <div class="position-relative">

    {# Hotspot kanan untuk membuka Overlay Nav saat hover di tepi kanan #}
    <div class="lp-overlay-hotspot" aria-hidden="true"></div>

    <!-- Sidebar Overlay (Template Library) - Positioned on RIGHT -->
    <aside id="lp-sidebar" class="dp-z-sidebar" role="dialog" aria-modal="true"
      aria-label="{% trans 'Template Pekerjaan' %}" aria-hidden="true">
      <div class="lp-sidebar-inner dp-surface dp-border">
        <!-- Header -->
        <div class="lp-sidebar-header d-flex align-items-center justify-content-between gap-2">
          <h6 class="m-0"><i class="bi bi-collection"></i> {% trans "Template Library" %}</h6>
          <button class="btn btn-sm btn-outline-secondary lp-btn" type="button" data-action="close-sidebar"
            title="{% trans 'Tutup' %}">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>

        <!-- Search & Filter -->
        <div class="lp-sidebar-search mt-3">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="template-search" type="search" class="form-control" placeholder="{% trans 'Cari template...' %}"
              autocomplete="off">
          </div>
        </div>

        <!-- Category Filter -->
        <div class="mt-2">
          <select id="template-category" class="form-select form-select-sm">
            <option value="">{% trans "Semua Kategori" %}</option>
            <option value="rumah">{% trans "Rumah" %}</option>
            <option value="ruko">{% trans "Ruko" %}</option>
            <option value="infrastruktur">{% trans "Infrastruktur" %}</option>
            <option value="utilitas">{% trans "Utilitas" %}</option>
            <option value="lainnya">{% trans "Lainnya" %}</option>
          </select>
        </div>

        <!-- Template List -->
        <div id="template-list" class="template-list mt-3">
          <div class="text-center text-muted py-3">
            <i class="bi bi-arrow-clockwise spin"></i> {% trans "Memuat template..." %}
          </div>
        </div>

        <!-- Quick Actions: Template -->
        <div class="template-actions mt-3 pt-3 border-top">
          <h6 class="small text-muted mb-2"><i class="bi bi-lightning"></i> {% trans "Aksi Template" %}</h6>

          <button id="btn-save-as-template" class="btn btn-sm btn-success w-100 mb-2" type="button"
            title="{% trans 'Simpan pekerjaan saat ini sebagai template reusable' %}">
            <i class="bi bi-bookmark-plus"></i> {% trans "Simpan Sebagai Template" %}
          </button>

          <button id="btn-import-from-file" class="btn btn-sm btn-outline-primary w-100 mb-2" type="button"
            title="{% trans 'Import template dari file JSON' %}">
            <i class="bi bi-upload"></i> {% trans "Import dari File" %}
          </button>

          <a id="btn-export-template" href="{% url 'detail_project:export_template_json' project.id %}"
            class="btn btn-sm btn-outline-success w-100" download
            title="{% trans 'Download pekerjaan sebagai template JSON' %}">
            <i class="bi bi-download"></i> {% trans "Export Template JSON" %}
          </a>
        </div>

        <!-- Hidden file input for import -->
        <input type="file" id="import-template-file" accept=".json" class="d-none">
      </div>
    </aside>

    <!-- MAIN AREA (Feel v1: kartu Klasifikasi â†’ Sub berisi tabel lokal) -->
    <main class="lp-main">
      <!-- Container utama mirip versi lama -->
      <div id="klas-list" class="vstack gap-3">
        <div class="text-muted small">
          {% trans "Mulai dengan tombol +Klasifikasi, lalu +Sub dan +Pekerjaan. Mode baris: Ref / Ref Modified /
          Custom." %}
        </div>
      </div>

      {# Simpan tabel global sebagai fallback (disembunyikan via CSS/JS) #}
      <div class="lp-table-wrap d-none" aria-hidden="true">
        <table id="lp-table" class="table lp-table table-hover ux-table-compact">
          <colgroup>
            <col class="col-num">
            <col class="col-mode">
            <col class="col-ref">
            <col class="col-urai">
            <col class="col-sat">
            <col class="col-act">
          </colgroup>
          <thead class="dp-thead-sticky">
            <tr>
              <th scope="col">#</th>
              <th scope="col">{% trans "Mode" %}</th>
              <th scope="col">{% trans "Referensi AHSP" %}</th>
              <th scope="col">{% trans "Uraian" %}</th>
              <th scope="col">{% trans "Satuan" %}</th>
              <th scope="col">{% trans "Aksi" %}</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" class="text-muted small">{% trans "Gunakan area di atas (kartu) untuk mengelola data." %}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  {# ===== [D.2] TEMPLATE PREVIEW MODAL ===== #}
  <div class="modal fade" id="templatePreviewModal" tabindex="-1" aria-labelledby="templatePreviewModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content dp-surface">
        <div class="modal-header">
          <h5 class="modal-title" id="templatePreviewModalLabel">
            <i class="bi bi-collection"></i> <span id="template-preview-name">Template</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="template-preview-desc" class="text-muted small mb-3"></div>
          <div id="template-preview-stats" class="alert alert-info py-2 px-3 small"></div>
          <h6 class="mt-3 mb-2">{% trans "Rincian Pekerjaan:" %}</h6>
          <div id="template-preview-tree" class="template-preview-tree"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x"></i> {% trans "Batal" %}
          </button>
          <button type="button" class="btn btn-success" id="btn-confirm-import">
            <i class="bi bi-check-circle"></i> {% trans "Import Template" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  {# ===== [D.3] SAVE AS TEMPLATE MODAL ===== #}
  <div class="modal fade" id="saveTemplateModal" tabindex="-1" aria-labelledby="saveTemplateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content dp-surface">
        <div class="modal-header">
          <h5 class="modal-title" id="saveTemplateModalLabel">
            <i class="bi bi-bookmark-plus"></i> {% trans "Simpan Sebagai Template" %}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="new-template-name" class="form-label">{% trans "Nama Template" %} *</label>
            <input type="text" class="form-control" id="new-template-name"
              placeholder="{% trans 'Contoh: Template Rumah Sederhana Tipe 36' %}" required>
          </div>
          <div class="mb-3">
            <label for="new-template-desc" class="form-label">{% trans "Deskripsi" %}</label>
            <textarea class="form-control" id="new-template-desc" rows="2"
              placeholder="{% trans 'Deskripsi singkat tentang template ini...' %}"></textarea>
          </div>
          <div class="mb-3">
            <label for="new-template-category" class="form-label">{% trans "Kategori" %}</label>
            <select class="form-select" id="new-template-category">
              <option value="rumah">{% trans "Rumah" %}</option>
              <option value="ruko">{% trans "Ruko" %}</option>
              <option value="infrastruktur">{% trans "Infrastruktur" %}</option>
              <option value="utilitas">{% trans "Utilitas" %}</option>
              <option value="lainnya" selected>{% trans "Lainnya" %}</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x"></i> {% trans "Batal" %}
          </button>
          <button type="button" class="btn btn-success" id="btn-confirm-save-template">
            <i class="bi bi-save"></i> {% trans "Simpan Template" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  {# ===== [E] FAB (SAVE) ===== #}
  <button id="btn-save-fab" class="btn btn-success position-fixed d-none dp-z-toolbar" type="button"
    title="{% trans 'Simpan' %}">
    <i class="bi bi-save"></i>
  </button>

  {# ===== [F] TEMPLATE BARIS ===== #}
  {% include 'detail_project/_pekerjaan_row.html' %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script defer src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script defer src="{% static 'detail_project/js/core/http.js' %}"></script>
<script defer src="{% static 'detail_project/js/core/format.js' %}"></script>
<script defer src="{% static 'detail_project/js/core/toast.js' %}"></script>
<script defer src="{% static 'detail_project/js/core/keys.js' %}"></script>

<script defer src="{% static 'detail_project/js/list_pekerjaan.js' %}"></script>
{% endblock %}