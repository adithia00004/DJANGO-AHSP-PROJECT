{% extends "detail_project/base_detail.html" %}
{% load static %}
{% block body_attrs %}data-page="rekap_kebutuhan"{% endblock %}
{% block detail_css %}{% endblock %}
{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
  <link rel="stylesheet" href="{% static 'detail_project/css/rekap_kebutuhan.css' %}">
{% endblock %}
{% block title %}Rekap Kebutuhan — {{ project.nama }}{% endblock %}

{% block dp_content %}
<div id="rk-app"
     class="dp-container"
     data-project-id="{{ project.id }}"
     data-endpoint="{% url 'detail_project:api_get_rekap_kebutuhan_enhanced' project.id %}"
     data-endpoint-export="{% url 'detail_project:api_export_rekap_kebutuhan_csv' project.id %}">
  
  <h1 class="h5 mb-3">Rekap Kebutuhan</h1>

  <!-- Filter Panel (NEW) -->
  <div class="dp-card dp-border dp-surface mb-3 rk-filter-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">
          <i class="bi bi-funnel"></i> Filter & Scope
        </h6>
        <a href="{% url 'detail_project:jadwal_pekerjaan' project.id %}"
           class="btn btn-sm btn-outline-primary">
          <i class="bi bi-calendar2-range"></i> Jadwal Pekerjaan
        </a>
      </div>
      
      <!-- Tahapan Scope Selector -->
      <div class="rk-filter-section mb-3">
        <label class="rk-filter-label">
          <i class="bi bi-bookmark"></i> Scope Tahapan:
        </label>
        <div class="rk-tahapan-selector">
          <button type="button" 
                  class="rk-tahapan-btn active" 
                  data-scope="all" 
                  data-tahapan-id="">
            <i class="bi bi-globe"></i> Keseluruhan Project
          </button>
          <!-- Tahapan buttons loaded by JS -->
          <div id="rk-tahapan-buttons"></div>
        </div>
      </div>

      <!-- Kategori Filter -->
      <div class="rk-filter-section mb-3">
        <label class="rk-filter-label">
          <i class="bi bi-tags"></i> Kategori Item:
        </label>
        <div class="rk-kategori-filter">
          <label class="rk-kategori-checkbox">
            <input type="checkbox" class="form-check-input kategori-check" value="TK" checked>
            <span>Tenaga Kerja (TK)</span>
          </label>
          <label class="rk-kategori-checkbox">
            <input type="checkbox" class="form-check-input kategori-check" value="BHN" checked>
            <span>Bahan (BHN)</span>
          </label>
          <label class="rk-kategori-checkbox">
            <input type="checkbox" class="form-check-input kategori-check" value="ALT" checked>
            <span>Alat (ALT)</span>
          </label>
          <label class="rk-kategori-checkbox">
            <input type="checkbox" class="form-check-input kategori-check" value="LAIN" checked>
            <span>Lain-lain (LAIN)</span>
          </label>
        </div>
      </div>

      <!-- Apply/Reset Buttons -->
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-primary btn-sm" id="rk-btn-apply-filter">
          <i class="bi bi-check-circle"></i> Terapkan Filter
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="rk-btn-reset-filter">
          <i class="bi bi-arrow-counterclockwise"></i> Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Scope Indicator -->
  <div id="rk-scope-indicator" class="mb-2"></div>

  <!-- Toolbar (EXISTING - Enhanced) -->
  <div id="rk-toolbar" class="dp-toolbar" role="toolbar" aria-label="Toolbar Rekap Kebutuhan">
    <!-- Unified Export Dropdown (CSV/PDF/Word) -->
    <div class="btn-group" role="group">
      <button type="button"
              class="btn btn-outline-primary dp-btn dp-btn-sm dropdown-toggle"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              aria-label="Export options">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="d-none d-md-inline">Export</span>
      </button>
      <ul class="dropdown-menu">
        <li>
          <button class="dropdown-item" type="button" id="btn-export-csv">
            <i class="bi bi-file-earmark-spreadsheet text-success me-2"></i>
            Export CSV
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="button" id="btn-export-pdf">
            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
            Export PDF
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="button" id="btn-export-word">
            <i class="bi bi-file-earmark-word text-primary me-2"></i>
            Export Word
          </button>
        </li>
      </ul>
    </div>
    
    <div class="ms-auto small text-muted rk-stats">
      TK: <span id="rk-count-TK">0</span> •
      BHN: <span id="rk-count-BHN">0</span> •
      ALT: <span id="rk-count-ALT">0</span> •
      LAIN: <span id="rk-count-LAIN">0</span>
      <span class="ms-2">(<span id="rk-nrows">0</span> baris)</span>
      <span class="ms-2" id="rk-generated" title="Generated at"></span>
      <span id="rk-filter-indicator" class="ms-2"></span>
    </div>
  </div>

  <!-- Table Card (EXISTING) -->
  <div class="dp-card dp-border dp-surface mt-3">
    <div class="card-body p-0">
      <div class="table-responsive dp-scrollbar" id="rk-tablewrap">
        <table class="rk-table table table-sm table-hover align-middle mb-0" id="rk-table">
          <thead class="table-light dp-thead-sticky">
            <tr>
              <th style="width:90px" class="text-nowrap">Kat</th>
              <th style="width:160px" class="text-nowrap">Kode</th>
              <th>Uraian</th>
              <th style="width:90px">Satuan</th>
              <th style="width:120px" class="text-end text-nowrap">Kuantitas</th>
            </tr>
          </thead>
          <tbody id="rk-tbody">
            <tr class="rk-loading-row">
              <td colspan="5" class="text-muted">Memuat…</td>
            </tr>
          </tbody>
        </table>

        <div id="rk-empty" class="text-center text-muted py-3 d-none">
          <i class="bi bi-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
          <p class="mt-2 mb-0">Tidak ada data untuk filter yang dipilih.</p>
        </div>
        <div id="rk-loading" class="text-center text-muted py-3 d-none">
          <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span class="ms-2">Memuat data...</span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <!-- Unified Export Manager -->
  <script src="{% static 'detail_project/js/export/ExportManager.js' %}"></script>
  <script src="{% static 'detail_project/js/rekap_kebutuhan.js' %}" defer></script>
{% endblock %}