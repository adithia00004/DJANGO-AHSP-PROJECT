{% extends "detail_project/base_detail.html" %}
{% load static %}
{% block body_attrs %}data-page="rekap_kebutuhan"{% endblock %}
{% block detail_css %}{% endblock %}
{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
  <link rel="stylesheet" href="{% static 'detail_project/css/rekap_kebutuhan.css' %}">
{% endblock %}
{% block title %}Rekap Kebutuhan — {{ project.nama }}{% endblock %}

{% block dp_content %}
<div id="rk-app"
     class="dp-container"
     data-project-id="{{ project.id }}"
     data-endpoint="{% url 'detail_project:api_get_rekap_kebutuhan' project.id %}"
     data-endpoint-export="{% url 'detail_project:api_export_rekap_kebutuhan_csv' project.id %}">
  <h1 class="h5 mb-2">Rekap Kebutuhan</h1>

  <div id="rk-toolbar" class="dp-toolbar" role="toolbar" aria-label="Toolbar Rekap Kebutuhan">
    <!-- Unified Export Dropdown (CSV/PDF/Word) -->
    <div class="btn-group" role="group">
      <button type="button"
              class="btn btn-outline-primary dp-btn dp-btn-sm dropdown-toggle"
              data-bs-toggle="dropdown"
              aria-expanded="false"
              aria-label="Export options">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="d-none d-md-inline">Export</span>
      </button>
      <ul class="dropdown-menu">
        <li>
          <button class="dropdown-item" type="button" id="btn-export-csv">
            <i class="bi bi-file-earmark-spreadsheet text-success me-2"></i>
            Export CSV
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="button" id="btn-export-pdf">
            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
            Export PDF
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="button" id="btn-export-word">
            <i class="bi bi-file-earmark-word text-primary me-2"></i>
            Export Word
          </button>
        </li>
      </ul>
    </div>
    
    <!-- Legacy single CSV button (kept as fallback) -->
    <button id="rk-btn-export" class="btn btn-outline-secondary dp-btn dp-btn-sm" type="button">
      Export CSV
    </button>
    <div class="ms-auto small text-muted">
      TK: <span id="rk-count-TK">0</span> •
      BHN: <span id="rk-count-BHN">0</span> •
      ALT: <span id="rk-count-ALT">0</span> •
      LAIN: <span id="rk-count-LAIN">0</span>
      <span class="ms-2">(<span id="rk-nrows">0</span> baris)</span>
      <span class="ms-2" id="rk-generated" title="Generated at"></span>
    </div>
  </div>

  <div class="dp-card dp-border dp-surface mt-3">
    <div class="card-body p-0">
      <div class="table-responsive dp-scrollbar" id="rk-tablewrap">
        <table class="rk-table table table-sm table-hover align-middle mb-0" id="rk-table">
          <thead class="table-light dp-thead-sticky">
            <tr>
              <th style="width:90px" class="text-nowrap">Kat</th>
              <th style="width:160px" class="text-nowrap">Kode</th>
              <th>Uraian</th>
              <th style="width:90px">Satuan</th>
              <th style="width:120px" class="text-end text-nowrap">Kuantitas</th>
            </tr>
          </thead>
          <tbody id="rk-tbody">
            <tr class="rk-loading-row">
              <td colspan="5" class="text-muted">Memuat…</td>
            </tr>
          </tbody>
        </table>

        <div id="rk-empty" class="text-center text-muted py-3 d-none">Belum ada data.</div>
        <div id="rk-loading" class="text-center text-muted py-3 d-none">Memuat…</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <!-- Unified Export Manager -->
  <script src="{% static 'detail_project/js/export/ExportManager.js' %}"></script>
  <script src="{% static 'detail_project/js/rekap_kebutuhan.js' %}" defer></script>
{% endblock %}
