{% extends "detail_project/base_detail.html" %}
{% load static vite %}

{% block body_attrs %}data-page="jadwal_pekerjaan"{% endblock %}

{% block title %}Jadwal Pekerjaan - {{ project.nama }}{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan_grid.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/validation-enhancements.css' %}">

{% if enable_ag_grid %}
  <!-- AG Grid Community CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31/styles/ag-theme-alpine.css">
{% endif %}

<!-- Frappe Gantt CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

{% comment %}
  Vite Integration:
  - In development: Load from Vite dev server (http://localhost:5173)
  - In production: Load from static/dist/manifest.json
{% endcomment %}

{% if enable_ag_grid %}
  {% if use_vite_dev_server %}
    {# Development mode: Vite dev server #}
    <script type="module" src="http://localhost:5173/@vite/client"></script>
    <script type="module" src="http://localhost:5173/detail_project/static/detail_project/js/src/jadwal_kegiatan_app.js"></script>
  {% else %}
    {# Production mode: Built assets via manifest #}
    {% vite_asset 'assets/js/jadwal-kegiatan.js' as jadwal_asset %}
    <script type="module" src="{% static jadwal_asset %}"></script>
  {% endif %}
{% endif %}
{% endblock %}

{% block dp_content %}
<!-- Toolbar (MOVED OUTSIDE for proper sticky behavior) -->
<div id="kt-toolbar" class="grid-toolbar dp-sticky-topbar dp-layer-toolbar bg-body border-bottom">
  <div class="toolbar-left">
    <h1 class="toolbar-title">Jadwal Pekerjaan (Enhanced)</h1>
    <span class="toolbar-subtitle">Project: {{ project.nama }}</span>
  </div>

  <div class="toolbar-right">
    <!-- Time Scale Selector -->
    <div class="btn-group btn-group-sm time-scale-selector" role="group">
      <input type="radio" class="btn-check" name="timeScale" id="scale-daily" value="daily">
      <label class="btn btn-outline-primary" for="scale-daily">Daily</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-weekly" value="weekly" checked>
      <label class="btn btn-outline-primary" for="scale-weekly">Weekly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-monthly" value="monthly">
      <label class="btn btn-outline-primary" for="scale-monthly">Monthly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-custom" value="custom">
      <label class="btn btn-outline-primary" for="scale-custom">Custom</label>
    </div>

    <!-- Display Mode Toggle -->
    <div class="btn-group btn-group-sm display-mode-toggle ms-2" role="group">
      <input type="radio" class="btn-check" name="displayMode" id="mode-percentage" value="percentage" checked>
      <label class="btn btn-outline-success" for="mode-percentage">
        <i class="bi bi-percent"></i> Percentage
      </label>

      <input type="radio" class="btn-check" name="displayMode" id="mode-volume" value="volume">
      <label class="btn btn-outline-success" for="mode-volume">
        <i class="bi bi-123"></i> Volume
      </label>
    </div>

    <!-- Action Buttons -->
    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="btn-collapse-all">
      <i class="bi bi-arrows-collapse"></i> Collapse
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-expand-all">
      <i class="bi bi-arrows-expand"></i> Expand
    </button>
    <button type="button" class="btn btn-danger btn-sm ms-2" id="btn-reset-progress" title="Reset semua progress pekerjaan ke 0">
      <i class="bi bi-arrow-counterclockwise"></i> Reset Progress
    </button>
    <button type="button" class="btn btn-primary btn-sm" id="btn-export-excel">
      <i class="bi bi-file-earmark-excel"></i> Export
    </button>
    <button type="button" class="btn btn-success btn-sm" id="save-button">
      <i class="bi bi-save"></i> Save All
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-button">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>
</div>

<!-- Main App Container -->
<div id="tahapan-grid-app"
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/"
     data-api-tahapan="{% url 'detail_project:api_list_create_tahapan' project.id %}"
     data-api-list-pekerjaan="{% url 'detail_project:api_get_list_pekerjaan_tree' project.id %}"
     data-api-volume="{% url 'detail_project:api_list_volume_pekerjaan' project.id %}"
     data-api-assignments-base="/detail_project/api/project/{{ project.id }}/pekerjaan/"
     data-api-save="{% url 'detail_project:api_v2_assign_weekly' project.id %}"
     data-enable-ag-grid="{{ enable_ag_grid|yesno:'true,false' }}"
     data-project-name="{{ project.nama|escape }}"
     data-project-start="{{ project.tanggal_mulai|date:'Y-m-d' }}"
     data-project-end="{{ project.tanggal_selesai|date:'Y-m-d' }}">

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mt-3" id="viewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab">
        <i class="bi bi-grid-3x3-gap"></i> Grid View (Enhanced)
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="gantt-tab" data-bs-toggle="tab" data-bs-target="#gantt-view" type="button" role="tab">
        <i class="bi bi-calendar3"></i> Gantt Chart
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="scurve-tab" data-bs-toggle="tab" data-bs-target="#scurve-view" type="button" role="tab">
        <i class="bi bi-graph-up"></i> Kurva S
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="viewTabsContent">
    <!-- Grid View Tab -->
    <div class="tab-pane fade show active" id="grid-view" role="tabpanel">
      {% comment %}
        Grid View container - Enhanced with event delegation and validation
        The JavaScript modules will populate this dynamically
      {% endcomment %}
    <div class="grid-container legacy-grid-wrapper {% if enable_ag_grid %}d-none{% endif %}">
      <div class="left-panel-scroll">
        <table class="grid-table">
          <thead id="left-thead">
              <tr>
                <th class="frozen-column">Pekerjaan</th>
              </tr>
            </thead>
            <tbody id="left-tbody">
              <!-- Left panel rows will be rendered by JavaScript -->
            </tbody>
          </table>
        </div>

        <div class="right-panel-scroll">
          <table class="grid-table">
            <thead id="right-thead">
              <tr id="time-header-row">
                <!-- Time column headers will be rendered by JavaScript -->
              </tr>
            </thead>
            <tbody id="right-tbody">
              <!-- Right panel rows will be rendered by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="ag-grid-container"
           class="ag-theme-alpine ag-grid-wrapper {% if not enable_ag_grid %}d-none{% endif %}"
           style="width: 100%; min-height: 600px;">
      </div>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-left">
          <span id="status-info">Ready</span>
        </div>
        <div class="status-right">
          <span>Modified: <strong id="status-modified">0</strong></span>
          <span>Total Rows: <strong id="status-rows">0</strong></span>
        </div>
      </div>
    </div>

    <!-- Gantt View Tab -->
    <div class="tab-pane fade" id="gantt-view" role="tabpanel">
      <div id="gantt-container" style="overflow: auto; padding: 20px;">
        <!-- Gantt chart will be rendered here -->
      </div>
    </div>

    <!-- S-Curve View Tab -->
    <div class="tab-pane fade" id="scurve-view" role="tabpanel">
      <div id="scurve-container" style="height: 600px; padding: 20px;">
        <!-- S-Curve chart will be rendered here -->
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Konfirmasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="confirm-message">Anda yakin?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="confirm-action">Ya, Lanjutkan</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-check-circle"></i> Sukses
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="success-message">Operasi berhasil!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- ECharts with CDN fallback -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"
        onerror="window.__loadLocalEcharts && window.__loadLocalEcharts();"></script>

<script>
  window.__loadLocalEcharts = function loadLocalEchartsFallback() {
    if (window.__echartsFallbackLoaded) {
      return;
    }
    window.__echartsFallbackLoaded = true;
    const fallbackSrc = "{% static 'detail_project/js/vendor/echarts.min.js' %}";
    const script = document.createElement('script');
    script.src = fallbackSrc;
    script.onload = function onEchartsFallbackLoaded() {
      console.info('[KelolaTahapan] ECharts loaded from local fallback.');
    };
    script.onerror = function onEchartsFallbackError() {
      console.error('[KelolaTahapan] Failed to load ECharts from CDN and local fallback.');
    };
    document.head.appendChild(script);
  };
  if (typeof window.echarts === 'undefined') {
    window.__loadLocalEcharts();
  }
</script>

<!-- Frappe Gantt CDN -->
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

{% if not enable_ag_grid %}
  <!-- Legacy Kelola Tahapan bootstrap + modules -->
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan_page_bootstrap.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/module_manifest.js' %}" defer></script>

  <!-- Core modules -->
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/data_loader_module.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/time_column_generator_module.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/validation_module.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/save_handler_module.js' %}" defer></script>

  <!-- View modules -->
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/shared_module.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/grid_module.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/gantt_module.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/kurva_s_module.js' %}" defer></script>

  <!-- Legacy orchestrators -->
  <script src="{% static 'detail_project/js/kelola_tahapan_grid.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/grid_tab.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/gantt_tab.js' %}" defer></script>
  <script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/kurva_s_tab.js' %}" defer></script>
{% endif %}

{% comment %}
  Note: The main application JavaScript is loaded via Vite in the extra_css block
  This ensures proper module loading order
{% endcomment %}

{% endblock %}
