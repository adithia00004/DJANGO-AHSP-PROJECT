{% extends "detail_project/base_detail.html" %}
{% load static %}

{% block body_attrs %}data-page="jadwal_pekerjaan"{% endblock %}

{% block title %}Jadwal Pekerjaan - {{ project.nama }}{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan_grid.css' %}">
<!-- Frappe Gantt CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
{% endblock %}

{% block dp_content %}
<!-- Toolbar (MOVED OUTSIDE for proper sticky behavior) -->
<div id="kt-toolbar" class="grid-toolbar dp-sticky-topbar dp-layer-toolbar bg-body border-bottom">
  <div class="toolbar-left">
    <h1 class="toolbar-title">Jadwal Pekerjaan</h1>
    <span class="toolbar-subtitle">Project: {{ project.nama }}</span>
  </div>

  <div class="toolbar-right">
    <!-- Time Scale Selector -->
    <div class="btn-group btn-group-sm time-scale-selector" role="group">
      <input type="radio" class="btn-check" name="timeScale" id="scale-daily" value="daily">
      <label class="btn btn-outline-primary" for="scale-daily">Daily</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-weekly" value="weekly" checked>
      <label class="btn btn-outline-primary" for="scale-weekly">Weekly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-monthly" value="monthly">
      <label class="btn btn-outline-primary" for="scale-monthly">Monthly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-custom" value="custom">
      <label class="btn btn-outline-primary" for="scale-custom">Custom</label>
    </div>

    <!-- Display Mode Toggle -->
    <div class="btn-group btn-group-sm display-mode-toggle ms-2" role="group">
      <input type="radio" class="btn-check" name="displayMode" id="mode-percentage" value="percentage" checked>
      <label class="btn btn-outline-success" for="mode-percentage">
        <i class="bi bi-percent"></i> Percentage
      </label>

      <input type="radio" class="btn-check" name="displayMode" id="mode-volume" value="volume">
      <label class="btn btn-outline-success" for="mode-volume">
        <i class="bi bi-123"></i> Volume
      </label>

      <input type="radio" class="btn-check" name="displayMode" id="mode-cost" value="cost" disabled>
      <label class="btn btn-outline-success" for="mode-cost" title="Aktif saat mode Realisasi">
        <i class="bi bi-cash-coin"></i> Cost
      </label>
    </div>

    <!-- Action Buttons -->
    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="btn-collapse-all">
      <i class="bi bi-arrows-collapse"></i> Collapse
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-expand-all">
      <i class="bi bi-arrows-expand"></i> Expand
    </button>
    <button type="button" class="btn btn-danger btn-sm ms-2" id="btn-reset-progress" title="Reset semua progress pekerjaan ke 0">
      <i class="bi bi-arrow-counterclockwise"></i> Reset Progress
    </button>
    <button type="button" class="btn btn-primary btn-sm" id="btn-export-excel">
      <i class="bi bi-file-earmark-excel"></i> Export
    </button>
    <button type="button" class="btn btn-success btn-sm" id="btn-save-all">
      <i class="bi bi-save"></i> Save All
    </button>
  </div>
</div>

<!-- Main App Container -->
<div id="tahapan-grid-app"
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/"
     data-project-name="{{ project.nama|escape }}"
     data-project-start="{{ project.tanggal_mulai|date:'Y-m-d' }}"
     data-project-end="{{ project.tanggal_selesai|date:'Y-m-d' }}"
     data-api-reset-progress="{% url 'detail_project:api_v2_reset_progress' project.id %}">

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mt-3" id="viewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab">
        <i class="bi bi-grid-3x3-gap"></i> Grid View
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="gantt-tab" data-bs-toggle="tab" data-bs-target="#gantt-view" type="button" role="tab">
        <i class="bi bi-calendar3"></i> Gantt Chart
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="scurve-tab" data-bs-toggle="tab" data-bs-target="#scurve-view" type="button" role="tab">
        <i class="bi bi-graph-up"></i> Kurva S
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content mt-3" id="viewTabsContent">
    {% include "detail_project/kelola_tahapan/_grid_tab.html" %}
    {% include "detail_project/kelola_tahapan/_gantt_tab.html" %}
    {% include "detail_project/kelola_tahapan/_kurva_s_tab.html" %}
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p id="loading-message" class="mt-2 mb-0">Processing...</p>
    <small id="loading-submessage" class="text-muted d-none"></small>
  </div>

</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="toast" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- Confirmation Modal for Reset Progress -->
<div class="modal fade" id="resetProgressModal" tabindex="-1" aria-labelledby="resetProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="resetProgressModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          Konfirmasi Reset Progress
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning d-flex align-items-start" role="alert">
          <i class="bi bi-exclamation-circle-fill fs-4 me-3 flex-shrink-0"></i>
          <div>
            <strong>Peringatan!</strong> Tindakan ini tidak dapat dibatalkan.
          </div>
        </div>
        <p class="mb-3">Apakah Anda yakin ingin mereset <strong>semua progress pekerjaan</strong> ke 0?</p>
        <ul class="text-muted small mb-0">
          <li>Semua data progress yang telah disimpan akan dihapus</li>
          <li>Data tidak dapat dikembalikan setelah direset</li>
          <li>Anda harus mengisi ulang progress dari awal</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Batal
        </button>
        <button type="button" class="btn btn-danger" id="confirmResetBtn">
          <i class="bi bi-trash-fill me-1"></i> Ya, Reset Semua Progress
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal for Save/Reset Operations -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">
          <i class="bi bi-check-circle-fill me-2"></i>
          <span id="successModalTitle">Operasi Berhasil</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
        </div>
        <h6 class="mb-2" id="successModalMessage">Operasi telah berhasil dilakukan!</h6>
        <p class="text-muted small mb-0" id="successModalDetail"></p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">
          <i class="bi bi-check-lg me-1"></i> OK
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Frappe Gantt JS -->
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

<!-- ECharts for Kurva S -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"
        onerror="window.__loadLocalEcharts && window.__loadLocalEcharts();"></script>

<script>
  window.__loadLocalEcharts = function loadLocalEchartsFallback() {
    if (window.__echartsFallbackLoaded) {
      return;
    }
    window.__echartsFallbackLoaded = true;
    const fallbackSrc = "{% static 'detail_project/js/vendor/echarts.min.js' %}";
    const script = document.createElement('script');
    script.src = fallbackSrc;
    script.onload = function onEchartsFallbackLoaded() {
      console.info('[KelolaTahapan] ECharts loaded from local fallback.');
    };
    script.onerror = function onEchartsFallbackError() {
      console.error('[KelolaTahapan] Failed to load ECharts from CDN and local fallback.');
    };
    document.head.appendChild(script);
  };
  if (typeof window.echarts === 'undefined') {
    window.__loadLocalEcharts();
  }
</script>

<!-- Kelola Tahapan Page App bootstrap -->
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan_page_bootstrap.js' %}" defer></script>

<!-- Kelola Tahapan Module manifest -->
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/module_manifest.js' %}" defer></script>

<!-- Core Data & Logic Modules (Load first - dependencies) -->
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/data_loader_module.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/time_column_generator_module.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/validation_module.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/save_handler_module.js' %}" defer></script>

<!-- View Modules (Load after core modules) -->
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/shared_module.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/grid_module.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/gantt_module.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/kurva_s_module.js' %}" defer></script>

<!-- Main Grid JS (Orchestrator - Load last) -->
<script src="{% static 'detail_project/js/kelola_tahapan_grid.js' %}" defer></script>
<!-- Tab Controllers -->
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/grid_tab.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/gantt_tab.js' %}" defer></script>
<script src="{% static 'detail_project/js/jadwal_pekerjaan/kelola_tahapan/kurva_s_tab.js' %}" defer></script>
{% endblock %}
