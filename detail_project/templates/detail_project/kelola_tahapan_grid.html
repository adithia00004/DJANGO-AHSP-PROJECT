{% extends "detail_project/base_detail.html" %}
{% load static %}

{% block body_attrs %}data-page="jadwal_pekerjaan"{% endblock %}

{% block title %}Jadwal Pekerjaan - {{ project.nama }}{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan_grid.css' %}">
<!-- Frappe Gantt CSS (Upgraded to v1.0.0 for better date parsing) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@1.0.0/dist/frappe-gantt.css">
{% endblock %}

{% block dp_content %}
<!-- Toolbar (MOVED OUTSIDE for proper sticky behavior) -->
<div id="kt-toolbar" class="grid-toolbar dp-sticky-topbar dp-layer-toolbar bg-body border-bottom">
  <div class="toolbar-left">
    <h1 class="toolbar-title">Jadwal Pekerjaan</h1>
    <span class="toolbar-subtitle">Project: {{ project.nama }}</span>
  </div>

  <div class="toolbar-right">
    <!-- Time Scale Selector -->
    <div class="btn-group btn-group-sm time-scale-selector" role="group">
      <input type="radio" class="btn-check" name="timeScale" id="scale-daily" value="daily">
      <label class="btn btn-outline-primary" for="scale-daily">Daily</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-weekly" value="weekly" checked>
      <label class="btn btn-outline-primary" for="scale-weekly">Weekly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-monthly" value="monthly">
      <label class="btn btn-outline-primary" for="scale-monthly">Monthly</label>

      <input type="radio" class="btn-check" name="timeScale" id="scale-custom" value="custom">
      <label class="btn btn-outline-primary" for="scale-custom">Custom</label>
    </div>

    <!-- Display Mode Toggle -->
    <div class="btn-group btn-group-sm display-mode-toggle ms-2" role="group">
      <input type="radio" class="btn-check" name="displayMode" id="mode-percentage" value="percentage" checked>
      <label class="btn btn-outline-success" for="mode-percentage">
        <i class="bi bi-percent"></i> Percentage
      </label>

      <input type="radio" class="btn-check" name="displayMode" id="mode-volume" value="volume">
      <label class="btn btn-outline-success" for="mode-volume">
        <i class="bi bi-123"></i> Volume
      </label>
    </div>

    <!-- Action Buttons -->
    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="btn-collapse-all">
      <i class="bi bi-arrows-collapse"></i> Collapse
    </button>
    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-expand-all">
      <i class="bi bi-arrows-expand"></i> Expand
    </button>
    <button type="button" class="btn btn-primary btn-sm ms-2" id="btn-export-excel">
      <i class="bi bi-file-earmark-excel"></i> Export
    </button>
    <button type="button" class="btn btn-success btn-sm" id="btn-save-all">
      <i class="bi bi-save"></i> Save All
    </button>
  </div>
</div>

<!-- Main App Container -->
<div id="tahapan-grid-app"
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/">

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mt-3" id="viewTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab">
        <i class="bi bi-grid-3x3-gap"></i> Grid View
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="gantt-tab" data-bs-toggle="tab" data-bs-target="#gantt-view" type="button" role="tab">
        <i class="bi bi-calendar3"></i> Gantt Chart
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="scurve-tab" data-bs-toggle="tab" data-bs-target="#scurve-view" type="button" role="tab">
        <i class="bi bi-graph-up"></i> Kurva S
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content mt-3" id="viewTabsContent">

    <!-- GRID VIEW TAB -->
    <div class="tab-pane fade show active" id="grid-view" role="tabpanel">
      <div class="grid-container">
        <!-- Split Panel Container -->
        <div class="split-panel-wrapper">

          <!-- LEFT PANEL (Frozen) -->
          <div class="left-panel-wrapper">
            <div class="left-panel-scroll">
              <table class="grid-table left-table" id="left-table">
                <thead id="left-thead">
                  <tr>
                    <th class="col-tree" style="width: 40px;"></th>
                    <th class="col-uraian" style="width: 400px;">Uraian Pekerjaan</th>
                    <th class="col-volume" style="width: 100px;">Volume</th>
                    <th class="col-satuan" style="width: 80px;">Satuan</th>
                  </tr>
                </thead>
                <tbody id="left-tbody">
                  <!-- Rows populated by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- RIGHT PANEL (Scrollable) -->
          <div class="right-panel-wrapper">
            <div class="right-panel-scroll">
              <table class="grid-table right-table" id="right-table">
                <thead id="right-thead">
                  <tr id="time-header-row">
                    <!-- Time columns dynamically inserted here -->
                  </tr>
                </thead>
                <tbody id="right-tbody">
                  <!-- Rows populated by JS -->
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Status Bar -->
        <div class="status-bar">
          <div class="status-left">
            <span id="status-message">Ready</span>
          </div>
          <div class="status-right">
            <span>Items: <strong id="item-count">0</strong></span>
            <span class="ms-3">Modified: <strong id="modified-count">0</strong></span>
            <span class="ms-3">Total Progress: <strong id="total-progress">0%</strong></span>
          </div>
        </div>
      </div>
    </div>

    <!-- GANTT VIEW TAB -->
    <div class="tab-pane fade" id="gantt-view" role="tabpanel">
      <div class="gantt-container">
        <div class="gantt-toolbar mb-3">
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary" data-gantt-view="Day">Day</button>
            <button type="button" class="btn btn-outline-secondary active" data-gantt-view="Week">Week</button>
            <button type="button" class="btn btn-outline-secondary" data-gantt-view="Month">Month</button>
          </div>
        </div>
        <svg id="gantt-chart"></svg>
      </div>
    </div>

    <!-- KURVA S TAB -->
    <div class="tab-pane fade" id="scurve-view" role="tabpanel">
      <div class="scurve-container">
        <div id="scurve-chart" style="width: 100%; height: 500px;"></div>
      </div>
    </div>

  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p id="loading-message" class="mt-2 mb-0">Processing...</p>
    <small id="loading-submessage" class="text-muted d-none"></small>
  </div>

</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="toast" class="toast align-items-center border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toast-body"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Frappe Gantt JS (Upgraded to v1.0.0 for better date parsing) -->
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@1.0.0/dist/frappe-gantt.js"></script>
<!-- ECharts for Kurva S -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- Main Grid JS -->
<script src="{% static 'detail_project/js/kelola_tahapan_grid.js' %}" defer></script>
{% endblock %}
