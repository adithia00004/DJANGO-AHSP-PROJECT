{% extends "detail_project/base_detail.html" %}
{% load static %}

{% block body_attrs %}data-page="kelola_tahapan"{% endblock %}

{% block title %}Kelola Tahapan Pelaksanaan - {{ project.nama }}{% endblock %}

{# Matikan include CSS detail_ahsp.css yang tidak ada (hindari 404) #}
{% block detail_css %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan.css' %}">
{% endblock %}

{% block dp_content %}
<div id="tahapan-app" 
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/">

  <!-- Toolbar -->
  <div id="kt-toolbar" class="dp-toolbar" role="toolbar" aria-label="Toolbar Kelola Tahapan">
    <div class="d-flex flex-column">
      <h1 class="h5 fw-semibold mb-0">Kelola Tahapan Pelaksanaan</h1>
      <small class="text-muted">Atur tahapan dan distribusi volume pekerjaan per tahap</small>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <button class="btn btn-outline-secondary dp-btn dp-btn-sm js-kt-sidebar-toggle"
              type="button"
              aria-controls="kt-sidebar"
              aria-expanded="false"
              aria-label="Buka panel kelola tahapan">
        <i class="bi bi-layout-sidebar-inset-reverse" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Kelola Tahapan</span>
      </button>
      <button type="button"
              class="btn btn-success dp-btn dp-btn-sm"
              id="btn-save-all"
              aria-label="Simpan semua perubahan">
        <i class="bi bi-save" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Simpan Semua</span>
      </button>
    </div>
  </div>

  <!-- Status Info -->
  <div id="status-info" class="alert alert-info mb-3 d-none" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-info-circle me-2"></i>
      <div class="flex-grow-1">
        <strong>Info:</strong>
        <span id="status-message"></span>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading" class="text-center py-5 d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Memuat data...</p>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="empty-state d-none" role="status">
    <i class="bi bi-inbox" aria-hidden="true"></i>
    <h2 class="h4">Belum Ada Tahapan</h2>
    <p class="text-muted">
      Anda perlu membuat tahapan terlebih dahulu sebelum dapat mengatur distribusi pekerjaan.
    </p>
    <button type="button"
            class="btn btn-primary js-kt-sidebar-toggle"
            aria-controls="kt-sidebar"
            aria-label="Buka panel untuk membuat tahapan">
      <i class="bi bi-plus-circle" aria-hidden="true"></i>
      Buka Panel Kelola Tahapan
    </button>
  </div>

  <!-- Main Table Container -->
  <div id="main-table-container" class="d-none">
    <!-- Filter & Search -->
    <div class="card mb-3">
      <div class="card-body py-2">
        <div class="row g-2 align-items-center">
          <div class="col-md-4">
            <label for="search-pekerjaan" class="visually-hidden">Cari pekerjaan</label>
            <input type="text"
                   class="form-control form-control-sm"
                   id="search-pekerjaan"
                   placeholder="Cari pekerjaan (kode/uraian)..."
                   aria-label="Cari pekerjaan berdasarkan kode atau uraian">
          </div>
          <div class="col-md-3">
            <label for="filter-klasifikasi" class="visually-hidden">Filter klasifikasi</label>
            <select class="form-select form-select-sm"
                    id="filter-klasifikasi"
                    aria-label="Filter berdasarkan klasifikasi">
              <option value="">Semua Klasifikasi</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filter-status" class="visually-hidden">Filter status</label>
            <select class="form-select form-select-sm"
                    id="filter-status"
                    aria-label="Filter berdasarkan status assignment">
              <option value="">Semua Status</option>
              <option value="assigned">Sudah Ter-assign</option>
              <option value="unassigned">Belum Ter-assign</option>
              <option value="partial">Ter-assign Parsial</option>
            </select>
          </div>
          <div class="col-md-2 text-end">
            <button type="button"
                    class="btn btn-sm btn-outline-secondary"
                    id="btn-reset-filters"
                    aria-label="Reset semua filter">
              <i class="bi bi-x-circle" aria-hidden="true"></i>
              Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Table -->
    <div class="table-responsive" style="max-height: calc(100vh - 280px); overflow: auto;">
      <table class="table table-hover table-sm align-middle dp-table" id="pekerjaan-table">
        <thead class="table-light sticky-top">
          <tr>
            <th style="width: 50px;" class="text-center">#</th>
            <th style="width: 150px;">Klasifikasi</th>
            <th style="width: 150px;">Sub-Klasifikasi</th>
            <th style="width: 100px;">Kode</th>
            <th style="min-width: 400px;">Uraian Pekerjaan</th>
            <th style="width: 100px;" class="text-end">Volume</th>
            <th style="width: 60px;">Satuan</th>
            <th style="width: 180px;">Tahapan</th>
            <th style="width: 280px;" id="dynamic-header">Detail Proporsi</th>
            <th style="width: 80px;" class="text-center">Status</th>
          </tr>
        </thead>
        <tbody id="pekerjaan-tbody">
          <tr>
            <td colspan="10" class="text-center text-muted py-4">Memuat data...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-muted small">
        Menampilkan <span id="showing-count">0</span> dari <span id="total-count">0</span> pekerjaan
      </div>
      <div id="pagination-controls">
        <!-- Pagination will be rendered here if needed -->
      </div>
    </div>
  </div>

</div>

<!-- No modals needed - all actions done inline in table and sidebar -->

<!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay d-none">
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 mb-0">Memproses...</p>
    </div>
  </div>

  <!-- Sidebar: Kelola Tahapan -->
  <aside id="kt-sidebar"
         class="dp-sidebar-overlay"
         role="complementary"
         data-side="right"
         data-align="topbar"
         data-resize-sense="east"
         aria-labelledby="ktSidebarTitle"
         aria-hidden="true">

    <div class="dp-sidebar-inner dp-scrollbar">
      <div class="dp-sidebar-header">
        <h2 class="h6 mb-0" id="ktSidebarTitle">Kelola Tahapan</h2>
        <button type="button"
                class="btn btn-sm btn-outline-secondary dp-btn-sm js-kt-sidebar-close"
                aria-label="Tutup panel">
          <i class="bi bi-x-lg" aria-hidden="true"></i>
        </button>
      </div>

      <div class="dp-sidebar-body" tabindex="-1">
        <!-- Form: Add/Edit Tahapan -->
        <div class="mb-4">
          <h3 class="h6 mb-3 d-flex align-items-center">
            <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>
            <span id="form-title">Tambah Tahapan Baru</span>
          </h3>
          <form id="form-tahapan">
            <input type="hidden" id="tahapan-id">
            <div class="mb-3">
              <label for="tahapan-nama" class="form-label">
                Nama Tahapan <span class="text-danger" aria-label="wajib">*</span>
              </label>
              <input type="text"
                     class="form-control form-control-sm"
                     id="tahapan-nama"
                     placeholder="Contoh: Tahap 1 - Persiapan"
                     required
                     aria-required="true">
              <div class="form-text small">Nama harus unik dalam project</div>
            </div>
            <div class="mb-3">
              <label for="tahapan-urutan" class="form-label">Urutan</label>
              <input type="number"
                     class="form-control form-control-sm"
                     id="tahapan-urutan"
                     placeholder="Auto"
                     min="1"
                     aria-describedby="urutan-help">
              <div id="urutan-help" class="form-text small">Kosongkan untuk urutan otomatis</div>
            </div>
            <div class="mb-3">
              <label for="tahapan-deskripsi" class="form-label">Deskripsi</label>
              <textarea class="form-control form-control-sm"
                        id="tahapan-deskripsi"
                        rows="2"
                        placeholder="Deskripsi opsional"></textarea>
            </div>
            <div class="row mb-3">
              <div class="col-6">
                <label for="tahapan-tanggal-mulai" class="form-label small">Tanggal Mulai</label>
                <input type="date"
                       class="form-control form-control-sm"
                       id="tahapan-tanggal-mulai">
              </div>
              <div class="col-6">
                <label for="tahapan-tanggal-selesai" class="form-label small">Tanggal Selesai</label>
                <input type="date"
                       class="form-control form-control-sm"
                       id="tahapan-tanggal-selesai">
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit"
                      class="btn btn-primary btn-sm flex-grow-1"
                      id="btn-save-tahapan">
                <i class="bi bi-check-circle" aria-hidden="true"></i>
                Simpan
              </button>
              <button type="button"
                      class="btn btn-outline-secondary btn-sm"
                      id="btn-reset-form"
                      aria-label="Batalkan perubahan">
                <i class="bi bi-x-circle" aria-hidden="true"></i>
                Batal
              </button>
            </div>
          </form>
        </div>

        <hr>

        <!-- Daftar Tahapan -->
        <div>
          <h3 class="h6 mb-3">
            <i class="bi bi-list-ul me-2" aria-hidden="true"></i>
            Daftar Tahapan (<span id="tahapan-count" aria-live="polite">0</span>)
          </h3>
          <div id="tahapan-list-sidebar" class="vstack gap-2" role="list">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <div class="dp-resizer" role="separator" aria-orientation="vertical" aria-label="Resize panel"></div>
    </div>

  </aside>

  <!-- Hover hotspot kanan untuk membuka sidebar -->
  <div class="vp-overlay-hotspot" aria-hidden="true"></div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="kt-toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="kt-toast-body">
          <!-- Message will be injected here -->
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'detail_project/js/kelola_tahapan.js' %}" defer></script>
{% endblock %}
