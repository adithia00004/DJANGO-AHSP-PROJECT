{% extends "detail_project/base_detail.html" %}
{% load static %}

{% block body_attrs %}data-page="kelola_tahapan"{% endblock %}

{% block title %}Kelola Tahapan Pelaksanaan - {{ project.nama }}{% endblock %}

{# Matikan include CSS detail_ahsp.css yang tidak ada (hindari 404) #}
{% block detail_css %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan.css' %}">
{% endblock %}

{% block dp_content %}
<div id="tahapan-app" 
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/">

  <!-- Toolbar (sticky) -->
  <div id="kt-toolbar" class="dp-toolbar" role="toolbar" aria-label="Toolbar Kelola Tahapan">
    <div class="d-flex flex-column">
      <span class="fw-semibold">Kelola Tahapan Pelaksanaan</span>
      <small class="text-muted">Atur tahapan konstruksi dan assign pekerjaan dengan split volume</small>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <div class="form-check form-switch me-2">
        <input class="form-check-input" type="checkbox" id="toggle-matrix-mode" aria-label="Aktifkan Matrix Mode (Beta)">
        <label class="form-check-label" for="toggle-matrix-mode">Matrix Mode (Beta)</label>
      </div>
      <button class="btn btn-outline-secondary dp-btn dp-btn-sm js-kt-sidebar-toggle" type="button" aria-controls="kt-sidebar" aria-expanded="false" aria-label="Buka Panel Tahapan">
        <i class="bi bi-layout-sidebar-inset-reverse" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Panel Tahapan</span>
      </button>
      <button type="button" class="btn btn-primary dp-btn dp-btn-sm" id="btn-add-tahapan" aria-label="Tambah Tahapan">
        <i class="bi bi-plus-circle" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Tambah Tahapan</span>
      </button>
    </div>
  </div>

  <!-- Status Warning -->
  <div id="warning-incomplete" class="alert warning-incomplete d-none" role="alert">
    <div class="d-flex align-items-center">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div class="flex-grow-1">
        <strong>Perhatian:</strong> 
        <span id="incomplete-count"></span> pekerjaan belum fully assigned ke tahapan.
      </div>
      <button type="button" class="btn btn-sm btn-warning" id="btn-show-incomplete">
        Lihat Detail
      </button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading" class="text-center py-5 d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Memuat tahapan...</p>
  </div>

  <!-- Empty State -->
  <div id="empty-state" class="empty-state d-none">
    <i class="bi bi-inbox"></i>
    <h4>Belum Ada Tahapan</h4>
    <p class="text-muted">
      Mulai dengan menambahkan tahapan pelaksanaan untuk project Anda.
    </p>
    <button type="button" class="btn btn-primary" data-trigger="add-tahapan">
      <i class="bi bi-plus-circle"></i> Tambah Tahapan Pertama
    </button>
  </div>

  <!-- Tahapan List -->
  <div id="tahapan-list" class="vstack gap-3">
    <!-- Cards will be rendered here by JavaScript -->
  </div>

  <!-- Matrix Mode Container (hidden by default) -->
  <div id="matrix-mode" class="d-none">
    <div class="alert alert-info py-2 small">
      <i class="bi bi-info-circle"></i>
      Mode tabel pivot per-tahap. Isi proporsi (%) per pekerjaan per tahapan. Σ harus 100% per baris.
    </div>
    <div class="d-flex justify-content-end mb-2">
      <button type="button" class="btn btn-sm btn-success dp-btn dp-btn-sm" id="btn-matrix-save" disabled>
        <i class="bi bi-check2-circle"></i> Simpan Perubahan (<span id="matrix-change-count">0</span>)
      </button>
    </div>
    <div class="table-responsive" id="matrix-tablewrap" style="max-height: 70vh; overflow: auto;">
      <table class="table table-sm table-hover align-middle dp-table" id="matrix-table">
        <thead class="table-light" id="matrix-thead"></thead>
        <tbody id="matrix-tbody">
          <tr><td class="text-muted">Memuat matrix…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Modal: Add/Edit Tahapan -->
<div class="modal fade" id="modal-tahapan" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-tahapan-title">Tambah Tahapan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-tahapan">
          <input type="hidden" id="tahapan-id" name="tahapan_id">
          
          <div class="mb-3">
            <label for="tahapan-nama" class="form-label">
              Nama Tahapan <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" id="tahapan-nama" required
                   placeholder="Contoh: Tahap 1 - Pekerjaan Persiapan">
            <div class="form-text">Nama harus unik dalam project</div>
          </div>

          <div class="mb-3">
            <label for="tahapan-deskripsi" class="form-label">Deskripsi</label>
            <textarea class="form-control" id="tahapan-deskripsi" rows="3"
                      placeholder="Deskripsi detail tahapan (opsional)"></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="tahapan-tanggal-mulai" class="form-label">Tanggal Mulai</label>
              <input type="date" class="form-control" id="tahapan-tanggal-mulai">
            </div>
            <div class="col-md-6 mb-3">
              <label for="tahapan-tanggal-selesai" class="form-label">Tanggal Selesai</label>
              <input type="date" class="form-control" id="tahapan-tanggal-selesai">
            </div>
          </div>

          <div class="alert alert-info small mb-0">
            <i class="bi bi-info-circle"></i>
            Setelah membuat tahapan, Anda bisa assign pekerjaan dari card tahapan.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btn-save-tahapan">
          <i class="bi bi-check-circle"></i> Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Assign Pekerjaan -->
<div class="modal fade" id="modal-assign" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Pekerjaan ke Tahapan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="assign-tahapan-info" class="alert alert-secondary mb-3">
          <strong>Tahapan:</strong> <span id="assign-tahapan-nama"></span>
        </div>

        <!-- Search/Filter -->
        <div class="mb-3">
          <input type="text" class="form-control" id="search-pekerjaan" 
                 placeholder="Cari pekerjaan...">
        </div>

        <!-- Quick Tools: filter & bulk fill -->
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="filter-unassigned-toggle">
            <label class="form-check-label" for="filter-unassigned-toggle">
              Tampilkan hanya pekerjaan belum/parsial
            </label>
          </div>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-fill-remaining">
              <i class="bi bi-magic"></i> Isi sisa 100% ke Tahapan ini
            </button>
          </div>
        </div>

        <!-- Pekerjaan List with Checkboxes -->
        <div id="pekerjaan-list" style="max-height: 400px; overflow-y: auto;">
          <!-- Will be populated by JavaScript -->
        </div>

        <div class="mt-3">
          <p class="text-muted small mb-0">
            <i class="bi bi-info-circle"></i>
            Pilih pekerjaan dan set proporsi volume (%). Total harus 100% per pekerjaan.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btn-save-assignments">
          <i class="bi bi-check-circle"></i> Simpan Assignments
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Detail Tahapan -->
<div class="modal fade" id="modal-tahapan-detail" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detail Tahapan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="tahapan-detail-body">
          <!-- Injected by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
  
</div>

<!-- Modal: Unassigned Pekerjaan -->
<div class="modal fade" id="modal-unassigned" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pekerjaan Belum Ter-assign</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="unassigned-list">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay d-none">
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 mb-0">Memproses...</p>
    </div>
  </div>

  <!-- Overlay Sidebar Kanan (mengadopsi pola Volume) -->
  <aside id="kt-sidebar"
         class="dp-sidebar-overlay"
         role="complementary"
         data-side="right"
         data-align="topbar"
         data-resize-sense="east"
         aria-labelledby="ktSidebarTitle"
         aria-hidden="true">

    <div class="dp-sidebar-inner dp-scrollbar">
      <div class="dp-sidebar-header">
        <h6 id="ktSidebarTitle">Panel Tahapan</h6>
        <button type="button" class="btn btn-sm btn-outline-secondary dp-btn-sm js-kt-sidebar-close" aria-label="Tutup">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="dp-sidebar-body" tabindex="-1">
        <div class="mb-3">
          <h6 class="mb-2">Daftar Tahapan</h6>
          <div id="offcanvas-tahapan-list" class="vstack gap-2 small">
            <!-- populated by JS -->
          </div>
        </div>
        <hr>
        <div>
          <h6 class="mb-2">Tambah / Edit Tahapan</h6>
          <form id="offcanvas-form-tahapan">
            <input type="hidden" id="oc-tahapan-id">
            <div class="mb-2">
              <label class="form-label">Nama Tahapan</label>
              <input type="text" class="form-control" id="oc-tahapan-nama" placeholder="Contoh: Tahap 1 - Persiapan" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Deskripsi</label>
              <textarea class="form-control" id="oc-tahapan-deskripsi" rows="2" placeholder="Opsional"></textarea>
            </div>
            <div class="row mb-2">
              <div class="col-6">
                <label class="form-label">Tanggal Mulai</label>
                <input type="date" class="form-control" id="oc-tahapan-mulai">
              </div>
              <div class="col-6">
                <label class="form-label">Tanggal Selesai</label>
                <input type="date" class="form-control" id="oc-tahapan-selesai">
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-sm" id="oc-btn-save">
                <i class="bi bi-check-circle"></i> Simpan
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="oc-btn-reset">Reset</button>
            </div>
          </form>
        </div>
      </div>

      <div class="dp-resizer" role="separator" aria-orientation="vertical" aria-label="Resize panel"></div>
    </div>

  </aside>

  <!-- Hover hotspot kanan untuk membuka sidebar -->
  <div class="vp-overlay-hotspot" aria-hidden="true"></div>

  <!-- Multi-toast container (optional) -->
  <div id="kt-toasts" class="toast-container position-fixed top-0 end-0 p-3 dp-layer-toast"></div>
  <!-- Single toast fallback -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" aria-live="polite" aria-atomic="true">
    <div id="kt-toast" class="toast text-bg-dark border-0" role="status" aria-live="assertive" aria-atomic="true" data-bs-delay="1600">
      <div class="toast-body" id="kt-toast-body">OK</div>
    </div>
  
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'detail_project/js/kelola_tahapan.js' %}" defer></script>
{% endblock %}
