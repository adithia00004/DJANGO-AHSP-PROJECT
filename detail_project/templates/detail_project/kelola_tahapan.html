{% extends "detail_project/base_detail.html" %}
{% load static %}

{% block body_attrs %}data-page="kelola_tahapan"{% endblock %}

{% block title %}Kelola Tahapan Pelaksanaan - {{ project.nama }}{% endblock %}

{# Matikan include CSS detail_ahsp.css yang tidak ada (hindari 404) #}
{% block detail_css %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/kelola_tahapan.css' %}">
{% endblock %}

{% block dp_content %}

<!-- ===== Toolbar (REFACTORED - Following Volume Pekerjaan Pattern) ===== -->
<div id="kt-toolbar"
     class="dp-toolbar"
     role="toolbar"
     aria-label="Toolbar Kelola Tahapan">

  <!-- Searchbar (Component Library) -->
  <div class="input-group dp-toolbar-search kt-searchbar position-relative" role="search">
    <span class="input-group-text"><i class="bi bi-search" aria-hidden="true"></i></span>
    <input id="kt-search" type="search" class="form-control"
           placeholder="Cari Pekerjaan (Kode / Uraian)..."
           autocomplete="off"
           aria-controls="kt-search-results">
    <div id="kt-search-results"
         class="dp-autocomplete kt-search-dropdown d-none dp-scrollbar"
         role="listbox"
         aria-label="Hasil pencarian"></div>
  </div>

  <!-- Expand/Collapse Controls -->
  <div class="d-flex align-items-center gap-2">
    <button id="kt-expand-all"
            class="btn btn-sm btn-outline-secondary dp-btn-sm"
            type="button"
            title="Expand semua Klasifikasi dan Sub"
            aria-label="Expand all">
      <i class="bi bi-arrows-expand" aria-hidden="true"></i>
    </button>
    <button id="kt-collapse-all"
            class="btn btn-sm btn-outline-secondary dp-btn-sm"
            type="button"
            title="Collapse semua Klasifikasi dan Sub"
            aria-label="Collapse all">
      <i class="bi bi-arrows-collapse" aria-hidden="true"></i>
    </button>
  </div>

  <!-- Actions kanan -->
  <div class="ms-auto d-flex align-items-center gap-2">
    <!-- Save Button -->
    <button id="btn-save-all"
            class="btn btn-success dp-btn dp-btn-sm"
            type="button"
            title="Simpan semua perubahan"
            aria-label="Simpan">
      <i class="bi bi-save" aria-hidden="true"></i>
      <span class="d-none d-sm-inline">Simpan</span>
    </button>

    <!-- Kelola Tahapan Sidebar Toggle -->
    <button type="button"
            id="btn-kt-sidebar-toggle"
            class="btn btn-primary dp-btn dp-btn-sm js-kt-sidebar-toggle"
            aria-controls="kt-sidebar"
            aria-expanded="false">
      <i class="bi bi-sliders2"></i>
      <span class="d-none d-sm-inline">Kelola Tahapan</span>
    </button>
  </div>
</div>

<div id="tahapan-app"
     class="dp-container ux-scrollbar ux-scroll-smooth"
     data-project-id="{{ project.id }}"
     data-api-base="/detail_project/api/project/{{ project.id }}/tahapan/">

  <!-- Loading Indicator -->
  <div id="loading" class="text-center py-5 d-none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Memuat data...</p>
  </div>

  <!-- Empty State (No Tahapan) -->
  <div id="empty-state" class="empty-state d-none">
    <i class="bi bi-inbox"></i>
    <h4>Belum Ada Tahapan</h4>
    <p class="text-muted">
      Anda perlu membuat tahapan terlebih dahulu sebelum dapat mengatur distribusi pekerjaan.
    </p>
    <button type="button" class="btn btn-primary js-kt-sidebar-toggle" aria-controls="kt-sidebar">
      <i class="bi bi-plus-circle"></i> Buka Panel Kelola Tahapan
    </button>
  </div>

  <!-- ===== Main Content: Hierarchical Cards (Like Volume Pekerjaan) ===== -->
  <div id="main-content" class="dp-card" style="display: none;">
    <div id="kt-page">
      <!-- Content will be populated by JavaScript -->
      <div id="kt-content-body">
        <!-- Dynamic hierarchical content here -->
      </div>
    </div>
  </div>

  <!-- Footer Info -->
  <div class="d-flex justify-content-between align-items-center mt-2" id="kt-footer" style="display: none !important;">
    <small class="text-muted">
      <span id="showing-info">Menampilkan <span id="showing-count">0</span> dari <span id="total-count">0</span> pekerjaan</span>
    </small>
    <div class="d-flex align-items-center gap-2">
      <span id="kt-save-status" class="text-muted small" role="status" aria-live="polite"></span>
    </div>
  </div>
</div>

<!-- No modals needed - all actions done inline in table and sidebar -->

<!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay d-none">
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 mb-0">Memproses...</p>
    </div>
  </div>

  <!-- Overlay Sidebar Kanan untuk Kelola Tahapan -->
  <aside id="kt-sidebar"
         class="dp-sidebar-overlay"
         role="complementary"
         data-side="right"
         data-align="topbar"
         data-resize-sense="east"
         aria-labelledby="ktSidebarTitle"
         aria-hidden="true">

    <div class="dp-sidebar-inner dp-scrollbar">
      <div class="dp-sidebar-header">
        <h6 id="ktSidebarTitle">Kelola Tahapan</h6>
        <button type="button" class="btn btn-sm btn-outline-secondary dp-btn-sm js-kt-sidebar-close" aria-label="Tutup">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="dp-sidebar-body" tabindex="-1">
        <!-- Form Add/Edit Tahapan -->
        <div class="mb-4">
          <h6 class="mb-3 d-flex align-items-center">
            <i class="bi bi-plus-circle me-2"></i>
            <span id="form-title">Tambah Tahapan Baru</span>
          </h6>
          <form id="form-tahapan">
            <input type="hidden" id="tahapan-id">
            <div class="mb-3">
              <label class="form-label">Nama Tahapan <span class="text-danger">*</span></label>
              <input type="text" class="form-control form-control-sm" id="tahapan-nama"
                     placeholder="Contoh: Tahap 1 - Persiapan" required>
              <div class="form-text small">Nama harus unik dalam project</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Urutan</label>
              <input type="number" class="form-control form-control-sm" id="tahapan-urutan"
                     placeholder="Auto" min="1">
              <div class="form-text small">Kosongkan untuk urutan otomatis</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Deskripsi</label>
              <textarea class="form-control form-control-sm" id="tahapan-deskripsi" rows="2"
                        placeholder="Deskripsi opsional"></textarea>
            </div>
            <div class="row mb-3">
              <div class="col-6">
                <label class="form-label small">Tanggal Mulai</label>
                <input type="date" class="form-control form-control-sm" id="tahapan-tanggal-mulai">
              </div>
              <div class="col-6">
                <label class="form-label small">Tanggal Selesai</label>
                <input type="date" class="form-control form-control-sm" id="tahapan-tanggal-selesai">
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-sm flex-grow-1" id="btn-save-tahapan">
                <i class="bi bi-check-circle"></i> Simpan
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-reset-form">
                <i class="bi bi-x-circle"></i> Batal
              </button>
            </div>
          </form>
        </div>

        <hr>

        <!-- Daftar Tahapan yang Ada -->
        <div>
          <h6 class="mb-3">
            <i class="bi bi-list-ul me-2"></i>
            Daftar Tahapan (<span id="tahapan-count">0</span>)
          </h6>
          <div id="tahapan-list-sidebar" class="vstack gap-2">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <div class="dp-resizer" role="separator" aria-orientation="vertical" aria-label="Resize panel"></div>
    </div>

  </aside>

  <!-- Hover hotspot kanan untuk membuka sidebar -->
  <div class="vp-overlay-hotspot" aria-hidden="true"></div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="kt-toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="kt-toast-body">
          <!-- Message will be injected here -->
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'detail_project/js/kelola_tahapan.js' %}" defer></script>
{% endblock %}
