{% extends "detail_project/base_detail.html" %}
{% load static %}
{% block dp_topbar_extra %}
{% include "detail_project/_sync_led.html" with scope="harga" watch="ahsp" change_status=change_status %}
{% endblock %}
{% block title %}Harga Items – {{ project.nama }}{% endblock %}
{% block body_attrs %}data-page="harga_items"{% endblock %}

{# Matikan CSS Detail AHSP di halaman ini (ikuti pola lama) #}
{% block detail_css %}{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/harga_items.css' %}">
{% endblock %}

{% block dp_content %}

<!-- Page Title -->
<h1 class="h5 mb-3">Harga Items</h1>

<!-- ===== Toolbar (sticky, konsisten SSOT) ===== -->
<div id="hi-toolbar"
  class="dp-toolbar d-flex align-items-center gap-2 flex-wrap mb-3 dp-sticky-topbar dp-layer-toolbar border-bottom px-3 ux-toolbar-inputs"
  role="toolbar" aria-label="Toolbar Harga Items">

  <!-- Searchbar -->
  <div class="position-relative flex-grow-1 me-2 hi-searchbar" role="search">
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-search" aria-hidden="true"></i></span>
      <input id="hi-filter" type="search" class="form-control ux-focusable" placeholder="Cari kode / uraian / kategori…"
        autocomplete="off" aria-label="Cari item harga">
    </div>
  </div>

  <!-- Actions -->
  <div class="ms-auto d-flex align-items-center gap-2">
    <!-- Export dropdown (CSV/PDF/Word/JSON) -->
    <div class="btn-group ux-dropdown" role="group">
      <button type="button" class="btn btn-sm btn-outline-primary dp-btn dropdown-toggle" data-bs-toggle="dropdown"
        aria-expanded="false" aria-label="Export options">
        <i class="bi bi-download" aria-hidden="true"></i>
        <span class="d-none d-sm-inline">Export</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><button class="dropdown-item" type="button" id="btn-export-xlsx"><i
              class="bi bi-file-earmark-excel text-success me-2"></i>Excel (XLSX)</button></li>
        <li><button class="dropdown-item" type="button" id="btn-export-pdf"><i
              class="bi bi-file-earmark-pdf text-danger me-2"></i>PDF</button></li>
        <li><button class="dropdown-item" type="button" id="btn-export-word"><i
              class="bi bi-file-earmark-word text-primary me-2"></i>Word</button></li>
        <li>
          <hr class="dropdown-divider">
        </li>
        <li><button class="dropdown-item" type="button" id="btn-export-json"><i
              class="bi bi-filetype-json text-warning me-2"></i>JSON</button></li>
      </ul>
    </div>

    <button id="hi-btn-save" class="btn btn-sm btn-success dp-btn d-inline-flex align-items-center gap-2" type="button"
      aria-live="polite">
      <span class="spinner-border spinner-border-sm" id="hi-save-spin" role="status" aria-hidden="true" hidden></span>
      <i class="bi bi-save" aria-hidden="true"></i>
      <span class="d-none d-sm-inline">Simpan</span>
    </button>
  </div>
</div>

<div id="hi-sync-banner" class="alert alert-warning d-flex align-items-center gap-3 d-none" role="status"
  aria-live="polite">
  <div>
    <div class="fw-semibold">Menunggu Template sinkron</div>
    <div id="hi-sync-text" class="small text-muted">Selesaikan sinkronisasi Template AHSP sebelum mengubah harga.</div>
  </div>
  <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" id="hi-sync-open-template">
    <i class="bi bi-layout-text-window me-1"></i>Buka Template
  </button>
</div>

<!-- ===== App Container ===== -->
<div id="hi-app" class="dp-container" data-project-id="{{ project.id }}"
  data-endpoint-list="{% url 'detail_project:api_list_harga_items' project.id %}"
  data-endpoint-save="{% url 'detail_project:api_save_harga_items' project.id %}"
  data-template-url="{% url 'detail_project:template_ahsp' project.id %}" data-locale="id-ID">

  <div id="hi-lock-overlay" class="hi-lock-overlay d-none" role="alert" aria-live="assertive">
    <div class="hi-lock-card">
      <h3>Harga Items terkunci</h3>
      <p class="small text-muted mb-3">Template AHSP sedang disinkronkan. Selesaikan proses tersebut sebelum mengubah
        harga.</p>
      <button type="button" class="btn btn-primary btn-sm" id="hi-lock-open-template">
        <i class="bi bi-layout-text-window me-1"></i>Buka Template AHSP
      </button>
    </div>
  </div>

  <!-- ===== Panel BUK ===== -->
  <div class="dp-card dp-border dp-surface mt-3 p-3" role="region" aria-label="Biaya Umum & Keuntungan">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <label for="hi-buk-input" class="form-label mb-0 ux-text-sm">Profit/Margin (%)</label>
      </div>
      <div class="col-auto">
        <input id="hi-buk-input" type="text" inputmode="decimal" class="form-control form-control-sm ux-focusable"
          placeholder="10,00" aria-describedby="hi-buk-help" style="width:120px">
      </div>
      <div class="col-auto">
        <span id="hi-buk-help" class="ux-text-xs text-muted">Tersimpan per proyek & dipakai di Rekap AHSP.</span>
      </div>
    </div>
  </div>

  <!-- ===== Filter Buttons ===== -->
  <div class="dp-card dp-border dp-surface mt-3 p-2" id="hi-filter-section">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="small text-body-secondary me-2">Filter:</span>
      <div class="btn-group btn-group-sm" role="group" aria-label="Filter kategori">
        <button type="button" class="btn btn-outline-secondary hi-filter-btn active" data-filter="all">
          Semua <span class="badge bg-secondary ms-1" id="hi-count-all">0</span>
        </button>
        <button type="button" class="btn btn-outline-primary hi-filter-btn" data-filter="TK">
          <i class="bi bi-people-fill"></i> TK <span class="badge bg-primary ms-1" id="hi-count-TK">0</span>
        </button>
        <button type="button" class="btn btn-outline-success hi-filter-btn" data-filter="BHN">
          <i class="bi bi-box-seam-fill"></i> BHN <span class="badge bg-success ms-1" id="hi-count-BHN">0</span>
        </button>
        <button type="button" class="btn btn-outline-warning hi-filter-btn" data-filter="ALT">
          <i class="bi bi-tools"></i> ALT <span class="badge bg-warning text-dark ms-1" id="hi-count-ALT">0</span>
        </button>
        <button type="button" class="btn btn-outline-secondary hi-filter-btn" data-filter="LAIN">
          <i class="bi bi-three-dots"></i> Lain <span class="badge bg-secondary ms-1" id="hi-count-LAIN">0</span>
        </button>
      </div>
      <div class="vr mx-2 d-none d-md-block"></div>
      <button type="button" class="btn btn-sm btn-outline-danger hi-filter-btn" data-filter="empty">
        <i class="bi bi-exclamation-circle"></i> Belum Diisi <span class="badge bg-danger ms-1"
          id="hi-count-empty">0</span>
      </button>
    </div>
  </div>

  <!-- ===== Tabel Utama ===== -->
  <div class="dp-card dp-border dp-surface mt-3">
    <div class="table-responsive">
      <table class="hi-table table table-sm table-hover ux-table-compact align-middle mb-0"
        aria-label="Daftar Harga Items proyek">
        <colgroup>
          <col class="col-no">
          <col class="col-kat">
          <col class="col-kode">
          <col class="col-urai">
          <col class="col-sat">
          <col class="col-inp">
          <col class="col-rp">
        </colgroup>

        <!-- Header sticky pakai offset global (topbar + dp-toolbar-h) -->
        <thead class="table-light dp-thead-sticky">
          <tr>
            <th class="text-center">No</th>
            <th class="text-nowrap">Kategori</th>
            <th class="font-monospace">Kode</th>
            <th>Uraian</th>
            <th class="text-nowrap">Satuan</th>
            <th class="text-nowrap">Harga</th>
            <th class="text-nowrap">Nominal</th>
          </tr>
        </thead>

        <tbody id="hi-tbody">
          <tr class="hi-empty">
            <td colspan="7">Memuat data…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center px-3 py-2 border-top">
      <div id="hi-stats" class="ux-text-sm">0 item</div>
      <div class="ux-text-xs text-muted">Tip: ketik angka bebas (., ,), sistem akan merapikan. Simpan untuk menyimpan
        perubahan.</div>
    </div>
  </div>

  <!-- ===== Modal: Konversi Harga (Option B - Compact 2-Column) ===== -->
  <div class="modal fade dp-modal ux-modal" id="hiConvModal" tabindex="-1" aria-labelledby="hiConvLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h6 class="modal-title" id="hiConvLabel">
            <i class="bi bi-calculator me-2"></i>Konversi Harga
          </h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>

        <div class="modal-body">
          <!-- Item info (compact, dark mode adaptive) -->
          <div class="hi-conv-item-box d-flex align-items-center gap-2 mb-3 p-2 rounded">
            <i class="bi bi-box-seam text-primary"></i>
            <div>
              <div id="hi-conv-item" class="fw-semibold small">—</div>
              <div class="text-body-secondary" style="font-size: 0.75rem;">
                Satuan Template: <span id="hi-conv-base" class="fw-semibold">[satuan]</span>
              </div>
            </div>
          </div>

          <!-- Row 1: Satuan beli & Harga (2 columns) -->
          <div class="row g-2 mb-3">
            <div class="col-6">
              <label class="form-label small mb-1">Satuan beli:</label>
              <select id="hi-conv-unit" class="form-select form-select-sm">
                <option value="batang">Batang</option>
                <option value="zak">Zak</option>
                <option value="dump_truck">Dump Truck</option>
                <option value="m3">m³</option>
                <option value="ton">Ton</option>
                <option value="custom">Lainnya...</option>
              </select>
              <input id="hi-conv-unit-custom" type="text" class="form-control form-control-sm mt-1 d-none"
                placeholder="Ketik satuan...">
            </div>
            <div class="col-6">
              <label class="form-label small mb-1">Harga dari supplier:</label>
              <div class="input-group input-group-sm">
                <span class="input-group-text">Rp</span>
                <input id="hi-conv-price" type="text" inputmode="decimal" class="form-control" placeholder="240.000">
              </div>
            </div>
          </div>

          <!-- Row 2: Faktor konversi (full width) -->
          <div class="mb-3">
            <label class="form-label small mb-1">Faktor konversi:</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text">1</span>
              <span class="input-group-text" id="hi-conv-unit-label">Batang</span>
              <span class="input-group-text">=</span>
              <input id="hi-conv-factor" type="text" inputmode="decimal" class="form-control" placeholder="10"
                style="max-width: 80px;">
              <span class="input-group-text" id="hi-conv-to-base">[satuan]</span>
            </div>
          </div>

          <!-- Result box (prominent, dark mode adaptive) -->
          <div class="hi-conv-result-box p-3 rounded mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="small text-body-secondary">Hasil Konversi:</div>
                <div id="hi-conv-result" class="fs-5 fw-bold hi-conv-result-value">—</div>
              </div>
              <div class="text-end">
                <div id="hi-conv-hint" class="small text-body-secondary"></div>
              </div>
            </div>
          </div>

          <!-- Hidden advanced fields (keep for JS compatibility) -->
          <div class="d-none">
            <input id="hi-conv-cap-m3" type="hidden">
            <input id="hi-conv-cap-ton" type="hidden">
            <input id="hi-conv-density" type="hidden">
          </div>

          <!-- Preference (simplified to 1 checkbox) -->
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="hi-conv-remember" checked>
            <label class="form-check-label small" for="hi-conv-remember">
              Ingat pengaturan ini untuk item serupa
            </label>
          </div>
          <!-- Hidden server checkbox (auto-enabled when remember is checked) -->
          <input type="checkbox" id="hi-conv-remember-server" class="d-none">
        </div>

        <div class="modal-footer py-2">
          <span id="hi-conv-error" class="text-danger small me-auto d-none">
            <i class="bi bi-exclamation-circle"></i> Lengkapi data yang diperlukan
          </span>
          <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Batal</button>
          <button id="hi-conv-apply" class="btn btn-primary btn-sm" disabled>
            <i class="bi bi-check-lg"></i> Terapkan
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Loading Modal -->
  {% include 'detail_project/_export_loading_modal.html' with modal_id="hiExportLoadingModal" %}

</div>
<!-- End #hi-app -->

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'detail_project/js/numeric.umd.js' %}"></script>

<!-- Export Manager (MUST load BEFORE harga_items.js) -->
<script src="{% static 'detail_project/js/export/ExportManager.js' %}"></script>

<script src="{% static 'detail_project/js/harga_items.js' %}"></script>

<script>
  // Initialize export buttons for Harga Items
  (function () {
    const projectId = document.getElementById('hi-app')?.dataset?.projectId;
    if (!projectId || typeof ExportManager === 'undefined') {
      console.warn('[HargaItems] ExportManager not available');
      return;
    }

    const exporter = new ExportManager(projectId, 'harga-items');

    // Get loading modal
    const loadingModalEl = document.getElementById('hiExportLoadingModal');
    let loadingModal = null;
    const loadingText = document.getElementById('hiExportLoadingText');

    const showLoading = (formatName) => {
      if (loadingText) loadingText.textContent = `Membuat file ${formatName}...`;
      if (loadingModalEl) {
        // Get fresh instance each time
        loadingModal = bootstrap.Modal.getOrCreateInstance(loadingModalEl);
        loadingModal.show();
      }
    };
    const hideLoading = () => {
      // Use Bootstrap's hide method if modal exists
      if (loadingModal) {
        try {
          loadingModal.hide();
        } catch (e) {
          console.warn('[HI] Modal hide error:', e);
        }
      }
      // Force cleanup after short delay
      setTimeout(() => {
        // Force remove modal show state
        if (loadingModalEl) {
          loadingModalEl.classList.remove('show');
          loadingModalEl.style.display = 'none';
          loadingModalEl.setAttribute('aria-hidden', 'true');
        }
        // Remove all backdrops
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        // Reset body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }, 150);
    };

    const btnXLSX = document.getElementById('btn-export-xlsx');
    const btnPDF = document.getElementById('btn-export-pdf');
    const btnWord = document.getElementById('btn-export-word');

    if (btnXLSX) {
      btnXLSX.addEventListener('click', async (e) => {
        e.preventDefault();
        showLoading('Excel');
        try { await exporter.exportAs('xlsx'); } finally { hideLoading(); }
      });
    }
    if (btnPDF) {
      btnPDF.addEventListener('click', async (e) => {
        e.preventDefault();
        showLoading('PDF');
        try { await exporter.exportAs('pdf'); } finally { hideLoading(); }
      });
    }
    if (btnWord) {
      btnWord.addEventListener('click', async (e) => {
        e.preventDefault();
        showLoading('Word');
        try { await exporter.exportAs('word'); } finally { hideLoading(); }
      });
    }

    const btnJSON = document.getElementById('btn-export-json');
    if (btnJSON) {
      btnJSON.addEventListener('click', async (e) => {
        e.preventDefault();
        showLoading('JSON');
        try { await exporter.exportAs('json'); } finally { hideLoading(); }
      });
    }

    console.log('[HargaItems] Export buttons initialized');
  })();
</script>
{% endblock %}