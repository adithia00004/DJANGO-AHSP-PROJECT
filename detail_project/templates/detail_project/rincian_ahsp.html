{% extends "detail_project/base_detail.html" %}
{% load static %}
{% block dp_topbar_extra %}
{% include "detail_project/_sync_led.html" with scope="rincian" watch="ahsp,harga" change_status=change_status %}
{% endblock %}
{% block title %}Rincian AHSP â€“ {{ project.nama }}{% endblock %}
{% block body_attrs %}data-page="rincian_ahsp"{% endblock %}

{% block detail_css %}{% endblock %}

{% block extra_head %}
{{ block.super }}
{# Selaraskan UI/UX dengan Template AHSP; hindari harga_items.css untuk mencegah konflik gaya #}
<link rel="stylesheet" href="{% static 'detail_project/css/components-library.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/template_ahsp_enhanced.css' %}">
<link rel="stylesheet" href="{% static 'detail_project/css/rincian_ahsp.css' %}">
{% endblock %}

{# Gunakan toolbar di dalam konten agar parity dengan template_ahsp #}
{% block dp_toolbar %}{% endblock %}

{% block dp_content %}
<div id="rekap-app" class="ra-app" data-project-id="{{ project.id }}"
  data-ep-rekap="{% url 'detail_project:api_get_rekap_rab' project.id %}"
  data-ep-pricing="{% url 'detail_project:api_project_pricing' project.id %}"
  data-ep-detail-prefix="{% url 'detail_project:api_get_detail_ahsp' project.id 0 %}"
  data-ep-pricing-item-prefix="{% url 'detail_project:api_pekerjaan_pricing' project.id 0 %}"
  data-ep-reset-prefix="{% url 'detail_project:api_reset_detail_ahsp_to_ref' project.id 0 %}" data-locale="id-ID">

  <!-- Toolbar (simplified, compact - matching Template AHSP) -->
  <div id="ra-toolbar"
    class="ra-toolbar dp-toolbar d-flex align-items-center gap-2 mb-2 dp-sticky-topbar dp-layer-toolbar" role="toolbar"
    aria-label="Toolbar Rincian AHSP">
    <!-- Search -->
    <div class="input-group input-group-sm flex-grow-1" style="max-width: 320px;">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input id="ra-job-search" type="search" class="form-control" placeholder="Cari pekerjaan..." autocomplete="off">
    </div>

    <!-- Grand Total -->
    <div id="rk-grand" class="small fw-semibold text-body-secondary" aria-live="polite">
      Grand Total: <span class="text-primary">Rp 0</span>
    </div>

    <!-- Dirty indicator -->
    <div class="ra-dirty-indicator d-inline-flex align-items-center small" aria-live="polite">
      <span id="ra-dirty-dot" class="text-warning me-1" hidden>â—</span>
      <span id="ra-dirty-text" class="text-warning small" hidden>Belum disimpan</span>
    </div>

    <div class="ms-auto d-flex align-items-center gap-1">
      <!-- Export dropdown -->
      <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown"
          aria-expanded="false" title="Export">
          <i class="bi bi-download"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item" type="button" id="ra-btn-export-xlsx"><i
                class="bi bi-file-earmark-excel text-success me-2"></i>Excel (XLSX)</button></li>
          <li><button class="dropdown-item" type="button" id="ra-btn-export-pdf"><i
                class="bi bi-file-earmark-pdf text-danger me-2"></i>PDF</button></li>
          <li><button class="dropdown-item" type="button" id="ra-btn-export-word"><i
                class="bi bi-file-earmark-word text-primary me-2"></i>Word</button></li>
        </ul>
      </div>

      <!-- Help -->
      <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
        data-bs-target="#raHelpModal" title="Bantuan">
        <i class="bi bi-question-circle"></i>
      </button>

      <!-- Save -->
      <button id="ra-btn-save" class="btn btn-success btn-sm d-inline-flex align-items-center gap-1" type="button"
        disabled>
        <span class="spinner-border spinner-border-sm" id="ra-btn-save-spin" role="status" hidden></span>
        <i class="bi bi-save"></i>
        <span class="d-none d-sm-inline">Simpan</span>
      </button>
    </div>
  </div>

  <!-- Body grid: LEFT (list) | RESIZER | RIGHT (detail) -->
  <div class="ra-body">
    <!-- LEFT: daftar pekerjaan -->
    <aside class="rk-left ra-sidebar" aria-label="Daftar pekerjaan">
      <!-- Filter header (matching Template AHSP) -->
      <div class="ra-filter-header d-flex align-items-center gap-2 mb-2 pb-2 border-bottom">
        <span class="small fw-semibold text-body-secondary">Pekerjaan</span>
        <span class="badge bg-secondary" id="ra-count-visible">0</span>

        <!-- Dropdown Filter -->
        <div class="dropdown ms-auto">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
            data-bs-auto-close="outside" aria-expanded="false">
            <i class="bi bi-funnel"></i> Filter
          </button>
          <div class="dropdown-menu dropdown-menu-end p-2" style="min-width: 160px;">
            <div class="form-check">
              <input class="form-check-input ra-filter-check" type="checkbox" value="ref" id="ra-check-ref" checked>
              <label class="form-check-label small" for="ra-check-ref">
                <span class="badge bg-info me-1">REF</span> Referensi
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input ra-filter-check" type="checkbox" value="ref_modified" id="ra-check-mod"
                checked>
              <label class="form-check-label small" for="ra-check-mod">
                <span class="badge bg-warning text-dark me-1">MOD</span> Modified
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input ra-filter-check" type="checkbox" value="custom" id="ra-check-cus" checked>
              <label class="form-check-label small" for="ra-check-cus">
                <span class="badge bg-success me-1">CUS</span> Custom
              </label>
            </div>
            <hr class="my-2">
            <button type="button" class="btn btn-sm btn-link p-0" id="ra-filter-reset">Reset filter</button>
          </div>
        </div>
      </div>
      <ul id="rk-list" class="ra-job-list" role="listbox" aria-label="Pekerjaan">
        <li class="rk-item ra-job-item">
          <div class="row-note">Memuatâ€¦</div>
        </li>
      </ul>
    </aside>

    <!-- RESIZER -->
    <div id="rk-resizer" class="rk-resizer ux-resizer" role="separator" aria-orientation="vertical"
      aria-label="Resize panel" tabindex="0"></div>

    <!-- RIGHT: header + tabel detail satu pekerjaan -->
    <section class="rk-right ra-editor" aria-label="Detail pekerjaan terpilih">
      <!-- Header pekerjaan (parity feel) -->
      <div class="rk-right-header ra-seg-header">
        <div class="rk-right-head-main">
          <div class="ux-mono mono small text-muted rk-right-meta">
            <span id="rk-pkj-kode">-</span> &middot;
            <span id="rk-pkj-sat">â€”</span>
            &nbsp;&nbsp;<span id="rk-pkj-source" class="rk-chip ra-chip">â€”</span>
          </div>
          <div id="rk-volume-alert" class="alert alert-warning rk-volume-alert d-none" role="status" aria-live="polite">
            Volume/Tahapan pekerjaan ini telah di-reset. Perbarui data di halaman Volume/Tahapan sebelum ekspor.
          </div>
          <div id="rk-pkj-uraian" class="rk-right-title ra-title">Pilih pekerjaan di kiri</div>
        </div>

        <!-- Pricing info + action buttons -->
        <div class="rk-right-actions d-flex align-items-center gap-2">
          <!-- BUK Efektif Display -->
          <span id="rk-eff" class="rk-chip ra-chip ux-mono mono" title="Profit/Margin (BUK) untuk pekerjaan ini">
            <i class="bi bi-lightning-charge" aria-hidden="true"></i>&nbsp;Profit: -%
          </span>

          <!-- Override Status Indicator -->
          <span id="rk-pkj-ovr-chip" class="rk-chip ra-chip-warn ux-mono mono" hidden
            title="Pekerjaan ini memiliki override aktif">
            <i class="bi bi-sliders" aria-hidden="true"></i>&nbsp;Override Aktif
          </span>

          <!-- Action Buttons -->
          <div class="btn-group btn-group-sm">
            <button id="rk-btn-override" class="btn btn-outline-primary d-inline-flex align-items-center gap-1"
              type="button" data-bs-toggle="modal" data-bs-target="#raOverrideModal"
              title="Atur override untuk pekerjaan ini">
              <i class="bi bi-sliders" aria-hidden="true"></i><span>Override</span>
            </button>
            <button id="rk-btn-reset" class="btn btn-outline-warning d-inline-flex align-items-center gap-1"
              type="button" title="Reset semua override ke default" disabled>
              <i class="bi bi-arrow-counterclockwise" aria-hidden="true"></i><span>Reset</span>
            </button>
          </div>
        </div>
      </div>TABEL AHSP<!-- Tabel detail -->
      <div class="ra-table-wrap">
        <table id="ra-table" class="table table-sm ra-table ra-table table-hover"
          aria-label="Rincian AHSP (pekerjaan terpilih)">
          <colgroup>
            <col class="col-no">
            <col class="col-uraian">
            <col class="col-kode">
            <col class="col-satuan">
            <col class="col-koef">
            <col class="col-rps">
            <col class="col-rpj">
          </colgroup>
          <thead class="ra-thead-sticky">
            <tr>
              <th scope="col">No</th>
              <th scope="col">Uraian</th>
              <th scope="col">Kode</th>
              <th scope="col" class="text-center">Satuan</th>
              <th scope="col" class="text-end">Koefisien</th>
              <th scope="col" class="text-end">Harga Satuan (Rp)</th>
              <th scope="col" class="text-end">Jumlah Harga (Rp)</th>
            </tr>
          </thead>
          <tbody id="rk-tbody-detail">
            <tr>
              <td colspan="7" class="row-note">Pilih pekerjaan untuk melihat rincian.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Toast -->
  <div id="rk-toast" class="rk-toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal: Override Settings -->
  <div class="modal fade" id="raOverrideModal" tabindex="-1" aria-labelledby="raOverrideLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="raOverrideLabel">
            <i class="bi bi-sliders me-2" aria-hidden="true"></i>Override Settings
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Pekerjaan Info -->
          <div class="alert alert-info d-flex align-items-start gap-2 mb-3">
            <i class="bi bi-info-circle flex-shrink-0 mt-1" aria-hidden="true"></i>
            <div class="flex-grow-1">
              <div class="fw-bold mb-1">Pekerjaan Terpilih:</div>
              <div class="small">
                <span class="badge bg-secondary" id="ovr-modal-kode">â€”</span>
                <span id="ovr-modal-uraian" class="ms-2">Pilih pekerjaan terlebih dahulu</span>
              </div>
            </div>
          </div>

          <!-- Override sederhana -->
          <div class="mb-3">
            <label for="ovr-buk-custom" class="form-label fw-bold">Override Profit/Margin (BUK) (%)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-percent" aria-hidden="true"></i></span>
              <input type="text" class="form-control" id="ovr-buk-custom" inputmode="decimal"
                placeholder="Kosongkan untuk menggunakan default" aria-label="Custom Profit/Margin (BUK)">
              <span class="input-group-text">%</span>
            </div>
            <div class="form-text">Masukkan 0â€“100. Kosongkan untuk kembali ke default proyek.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg me-1" aria-hidden="true"></i>Batal
          </button>
          <button type="button" class="btn btn-outline-danger" id="ovr-clear-btn">
            <i class="bi bi-trash me-1" aria-hidden="true"></i>Hapus Override
          </button>
          <button type="button" class="btn btn-primary" id="ovr-apply-btn">
            <i class="bi bi-check2-circle me-1" aria-hidden="true"></i>Terapkan Override
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Bantuan Rincian AHSP (TIER 4: Enhanced with keyboard shortcuts) -->
  <div class="modal fade" id="raHelpModal" tabindex="-1" aria-labelledby="raHelpLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="raHelpLabel">
            <i class="bi bi-question-circle-fill me-2" aria-hidden="true"></i>Bantuan Rincian AHSP
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Overview -->
          <h6 class="fw-bold mb-2">ğŸ“‹ Gambaran Umum</h6>
          <p class="mb-3">Halaman Rincian AHSP menampilkan detail komponen biaya per pekerjaan dengan harga satuan dan
            total. Anda dapat melihat breakdown lengkap komponen TK (Tenaga Kerja), BHN (Bahan), ALT (Peralatan), dan
            LAIN (Lainnya).</p>

          <!-- Basic Usage -->
          <h6 class="fw-bold mb-2">ğŸ’¡ Cara Penggunaan</h6>
          <ul class="mb-3">
            <li><strong>Pilih pekerjaan</strong> dari sidebar kiri untuk melihat rincian komponen.</li>
            <li><strong>Lihat detail harga</strong> satuan dan jumlah harga untuk setiap komponen.</li>
            <li><strong>Gunakan Override</strong> untuk mengatur Profit/Margin (BUK) kustom per pekerjaan.</li>
            <li><strong>Export</strong> data ke CSV, PDF, atau Word untuk analisis lebih lanjut.</li>
          </ul>

          <!-- Keyboard Shortcuts (TIER 3 Feature) -->
          <h6 class="fw-bold mb-2">âŒ¨ï¸ Keyboard Shortcuts</h6>
          <div class="table-responsive mb-3">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr>
                  <th style="width: 140px;">Shortcut</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><kbd>Ctrl</kbd> + <kbd>K</kbd></td>
                  <td>Focus ke search bar (quick find)</td>
                </tr>
                <tr>
                  <td><kbd>Shift</kbd> + <kbd>O</kbd></td>
                  <td>Buka Override Modal (jika pekerjaan sudah dipilih)</td>
                </tr>
                <tr>
                  <td><kbd>â†‘</kbd> / <kbd>â†“</kbd></td>
                  <td>Navigate pekerjaan (previous/next dengan smooth scroll)</td>
                </tr>
                <tr>
                  <td><kbd>Enter</kbd></td>
                  <td>Select pekerjaan yang difokus</td>
                </tr>
                <tr>
                  <td><kbd>Esc</kbd></td>
                  <td>Close modal / Cancel</td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="small text-muted mb-3">
            <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
            <em>Keyboard shortcuts bekerja bahkan saat tidak fokus di input field.</em>
          </p>

          <!-- Override BUK -->
          <h6 class="fw-bold mb-2">ğŸ”§ Override Profit/Margin (BUK)</h6>
          <ul class="mb-3">
            <li><strong>Apply Override:</strong> Pilih pekerjaan â†’ Klik <strong>Override</strong> â†’ Masukkan nilai
              0â€“100% â†’ Klik <strong>Terapkan Override</strong></li>
            <li><strong>Hapus Override:</strong> Klik <strong>Hapus Override</strong> untuk kembali ke default proyek
            </li>
            <li><strong>Validasi:</strong> Nilai harus antara 0â€“100%, negatif atau >100% akan ditolak</li>
            <li><strong>Indikator:</strong> Pekerjaan dengan override ditandai chip kuning pada list</li>
          </ul>

          <!-- Resizer -->
          <h6 class="fw-bold mb-2">â†”ï¸ Resize Panel</h6>
          <ul class="mb-3">
            <li><strong>Drag resizer:</strong> Klik dan drag garis vertikal antara list dan detail</li>
            <li><strong>Keyboard:</strong> Focus resizer â†’ <kbd>â†</kbd>/<kbd>â†’</kbd> untuk adjust (shift = faster)</li>
            <li><strong>Reset:</strong> Double-click resizer atau tekan <kbd>R</kbd> saat focus untuk reset ke default
            </li>
          </ul>

          <!-- Tips -->
          <h6 class="fw-bold mb-2">ğŸ’ Tips & Tricks</h6>
          <ul class="mb-3">
            <li>Gunakan <kbd>Ctrl+K</kbd> untuk quick search tanpa harus scroll ke toolbar</li>
            <li>Navigate dengan arrow keys lebih cepat untuk power users</li>
            <li>Grand Total di toolbar otomatis update saat override diterapkan</li>
            <li>Resizer width tersimpan otomatis (localStorage) untuk session berikutnya</li>
          </ul>

          <!-- Troubleshooting -->
          <h6 class="fw-bold mb-2">ğŸ”§ Troubleshooting</h6>
          <div class="alert alert-warning small mb-0">
            <p class="mb-1"><strong>Keyboard shortcuts tidak bekerja?</strong></p>
            <ul class="mb-1 ps-3">
              <li>Pastikan tidak sedang mengetik di input field</li>
              <li>Refresh halaman jika masih bermasalah</li>
            </ul>
            <p class="mb-1"><strong>Grand Total tidak update?</strong></p>
            <ul class="mb-0 ps-3">
              <li>Grand Total otomatis reload setelah override diterapkan</li>
              <li>Jika tidak update, refresh halaman</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg me-1" aria-hidden="true"></i>Tutup
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Loading Modal -->
  <div class="modal fade" id="raExportLoadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="raExportLoadingLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-body text-center py-4">
          <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <h6 class="mb-1" id="raExportLoadingLabel">Memproses Export</h6>
          <p class="text-muted small mb-0" id="raExportLoadingText">Mohon tunggu...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<!-- Export Manager (MUST load BEFORE rincian_ahsp.js) -->
<script src="{% static 'detail_project/js/export/ExportManager.js' %}"></script>

<script src="{% static 'detail_project/js/rincian_ahsp.js' %}"></script>
{% endblock %}