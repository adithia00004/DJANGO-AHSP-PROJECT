const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/chart-modules-7de66ekb.js","assets/chart-modules-Saz_VHki.css","assets/js/gantt-frozen-grid-QMnIxjuC.js"])))=>i.map(i=>d[i]);
var t=Object.defineProperty,e=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s,n=(t,n)=>{for(var o in n||(n={}))a.call(n,o)&&i(t,o,n[o]);if(e)for(var o of e(n))s.call(n,o)&&i(t,o,n[o]);return t},o=(t,e,a)=>new Promise((s,i)=>{var n=t=>{try{r(a.next(t))}catch(e){i(e)}},o=t=>{try{r(a.throw(t))}catch(e){i(e)}},r=t=>t.done?s(t.value):Promise.resolve(t.value).then(n,o);r((a=a.apply(t,e)).next())});import{_ as r}from"./vendor-export-CxtsESY6.js";import{T as l}from"./grid-modules-BPv6zKef.js";import{S as d,T as h,D as c,a as u}from"./core-modules-t2ZCVRBW.js";import{K as g,T as p,i as m,B as f}from"./chart-modules-7de66ekb.js";class y{constructor(t){var e;this.tableManager=t,this.canvas=document.createElement("canvas"),this.canvas.className="gantt-canvas-overlay",this.canvas.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      pointer-events: auto;\n      z-index: 10;\n    ",this.ctx=this.canvas.getContext("2d"),this.visible=!1,this.barData=[],this.dependencies=[],this.barRects=[],this.tooltip=null;const a=null==(e=this.tableManager)?void 0:e.bodyScroll;a&&a.addEventListener("scroll",()=>{this.visible&&this.syncWithTable()},{passive:!0}),this._bindPointerEvents()}show(){var t;if(this.visible)return;const e=null==(t=this.tableManager)?void 0:t.bodyScroll;e&&(e.style.position=e.style.position||"relative",e.appendChild(this.canvas),this.visible=!0,this.syncWithTable())}hide(){this.visible&&(this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.visible=!1,this._hideTooltip())}syncWithTable(){var t;const e=null==(t=this.tableManager)?void 0:t.bodyScroll;if(!e)return;this.canvas.width=e.scrollWidth,this.canvas.height=e.scrollHeight;const a="function"==typeof this.tableManager.getCellBoundingRects?this.tableManager.getCellBoundingRects():[];this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.barRects=[],this.ctx.strokeStyle="#e2e8f0",a.forEach(t=>{this.ctx.strokeRect(t.x,t.y,t.width,t.height)}),this._drawBars(a),this._drawDependencies(a)}renderBars(t){this.barData=Array.isArray(t)?t:[],this.visible&&this.syncWithTable()}renderDependencies(t){this.dependencies=Array.isArray(t)?t:[],this.visible&&this.syncWithTable()}_drawBars(t){Array.isArray(t)&&0!==t.length&&0!==this.barData.length&&this.barData.forEach(e=>{const a=t.find(t=>t.pekerjaanId===e.pekerjaanId&&t.columnId===e.columnId);if(!a)return;const s=a.width-8,i=a.x+4,n=a.y+6,o=Math.max(6,a.height-12),r=Number.isFinite(e.planned)?Math.max(0,Math.min(100,e.planned)):null,l=Number.isFinite(e.actual)?Math.max(0,Math.min(100,e.actual)):Math.max(0,Math.min(100,e.value||0));if(null!==r){const t=r/100*s;this.ctx.fillStyle="#e2e8f0",this.ctx.fillRect(i,n,t,o)}const d=l/100*s,h=e.color||this._resolveVarianceColor(e.variance);this.ctx.fillStyle=h,this.ctx.fillRect(i,n,d,o),this.barRects.push({x:i,y:n,width:d,height:o,pekerjaanId:e.pekerjaanId,columnId:e.columnId,value:l,planned:r,variance:e.variance,label:e.label,color:h})})}_drawDependencies(t){Array.isArray(t)&&0!==t.length&&0!==this.dependencies.length&&this.dependencies.forEach(e=>{const a=t.find(t=>t.pekerjaanId===e.fromPekerjaanId&&t.columnId===e.fromColumnId),s=t.find(t=>t.pekerjaanId===e.toPekerjaanId&&t.columnId===e.toColumnId);if(!a||!s)return;const i=a.x+a.width,n=a.y+a.height/2,o=s.x,r=s.y+s.height/2;this.ctx.strokeStyle=e.color||"#94a3b8",this.ctx.lineWidth=1.5,this.ctx.beginPath(),this.ctx.moveTo(i,n),this.ctx.lineTo(o,r),this.ctx.stroke();const l=Math.atan2(r-n,o-i);this.ctx.beginPath(),this.ctx.moveTo(o,r),this.ctx.lineTo(o-5*Math.cos(l-Math.PI/6),r-5*Math.sin(l-Math.PI/6)),this.ctx.lineTo(o-5*Math.cos(l+Math.PI/6),r-5*Math.sin(l+Math.PI/6)),this.ctx.closePath(),this.ctx.fillStyle=e.color||"#94a3b8",this.ctx.fill()})}_resolveVarianceColor(t){return Number.isFinite(t)?t<-.1?"#ef4444":t>.1?"#22c55e":"#3b82f6":"#3b82f6"}_bindPointerEvents(){this.canvas.addEventListener("mousemove",t=>{if(!this.visible||!this.barRects.length)return;const e=this.canvas.getBoundingClientRect(),a=t.clientX-e.left,s=t.clientY-e.top,i=this._hitTest(a,s);i?this._showTooltip(t.clientX,t.clientY,i):this._hideTooltip()}),this.canvas.addEventListener("mouseleave",()=>{this._hideTooltip()})}_hitTest(t,e){return this.barRects.find(a=>t>=a.x&&t<=a.x+a.width&&e>=a.y&&e<=a.y+a.height)}_ensureTooltip(){return this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.className="gantt-overlay-tooltip",this.tooltip.style.cssText="\n      position: fixed;\n      padding: 4px 8px;\n      background: rgba(17,24,39,0.85);\n      color: #f8fafc;\n      border-radius: 4px;\n      font-size: 12px;\n      pointer-events: none;\n      z-index: 20;\n      display: none;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.25);\n    ",document.body.appendChild(this.tooltip)),this.tooltip}_showTooltip(t,e,a){const s=this._ensureTooltip(),i=a.label||a.pekerjaanId,n=Number.isFinite(a.planned)?`${a.planned}%`:"-",o=Number.isFinite(a.value)?`${a.value}%`:"-",r=Number.isFinite(a.variance)?`${a.variance}%`:"-";s.innerHTML=`Pekerjaan: ${i}<br/>Kolom: ${a.columnId}<br/>Planned: ${n}<br/>Actual: ${o}<br/>Variance: ${r}`,s.style.left=`${t+10}px`,s.style.top=`${e+10}px`,s.style.display="block"}_hideTooltip(){this.tooltip&&(this.tooltip.style.display="none")}}class w{constructor(t,e={}){this.state=t||{},this.options=e,this.currentMode="grid",this.tanstackGrid=null,this.overlays={gantt:null,kurva:null}}mount(t,e={}){this.tanstackGrid=new l(this.state,this.options),this.tanstackGrid.mount(t,e),this.tanstackGrid.setCellRenderer("input")}updateData(t){this.tanstackGrid&&(this.tanstackGrid.updateData(t),this._refreshGanttOverlay(t))}switchMode(t){var e,a;if(!t||t===this.currentMode||!this.tanstackGrid)return;const s={grid:"input",gantt:"gantt",kurva:"readonly"}[t]||"input";"gantt"===this.currentMode&&this.overlays.gantt&&this.overlays.gantt.hide(),"kurva"===this.currentMode&&this.overlays.kurva&&(null==(a=(e=this.overlays.kurva).hide)||a.call(e)),this.currentMode=t,this.tanstackGrid.setCellRenderer(s),"gantt"===t&&(this.overlays.gantt||(this.overlays.gantt=new y(this.tanstackGrid)),this.overlays.gantt.show(),this._refreshGanttOverlay()),"kurva"===t&&this.overlays.kurva&&"function"==typeof this.overlays.kurva.show&&this.overlays.kurva.show()}_refreshGanttOverlay(t={}){if(!this.overlays.gantt||!this.tanstackGrid)return;const e=this._buildBarData(t),a=t.dependencies||[];this.overlays.gantt.renderBars(e),this.overlays.gantt.renderDependencies(a)}_buildBarData(t={}){var e,a,s,i,n,o,r;const l=t.tree||this.tanstackGrid.currentRows||[],d=t.timeColumns||this.tanstackGrid.currentColumns||[],h=[],c=(null==(e=this.state)?void 0:e.stateManager)||(null==(a=this.state)?void 0:a.stateManagerInstance)||(null==(s=this.options)?void 0:s.stateManager),u=(null==(n=null==(i=null==c?void 0:c.states)?void 0:i.planned)?void 0:n.assignmentMap)||new Map,g=(null==(r=null==(o=null==c?void 0:c.states)?void 0:o.actual)?void 0:r.assignmentMap)||new Map;return l.forEach(t=>{var e,a;const s=t.pekerjaanId||t.id||(null==(e=t.raw)?void 0:e.pekerjaan_id),i=t.name||(null==(a=t.raw)?void 0:a.nama)||s;s&&d.forEach(t=>{var e,a,n,o;const r=null==(e=t.meta)?void 0:e.columnMeta;if(!(null==(a=t.meta)?void 0:a.timeColumn)||!r)return;const l=t.fieldId||t.id,d=`${s}-${l}`,c=null!=(n=u.get(d))?n:this.tanstackGrid.getTimeCellValue(s,l,r),p=null!=(o=g.get(d))?o:c;if((!Number.isFinite(c)||c<=0)&&(!Number.isFinite(p)||p<=0))return;const m=(Number(p)||0)-(Number(c)||0);h.push({pekerjaanId:s,columnId:l,value:Number(p)||0,planned:Number(c)||0,actual:Number(p)||0,variance:m,label:i,color:"#4dabf7"})})}),h}}class v{constructor(){this.state=null,this.initialized=!1,this.gridManager=null,this.stateManager=d.getInstance(),this.dataLoader=null,this.timeColumnGenerator=null,this.saveHandler=null,this.unifiedManager=null,this.unifiedGanttManager=null,this.kurvaSChart=null,this.ganttChart=null,this.ganttFrozenGrid=null,this._chartModulesLoaded=!1,this._chartModulesLoading=!1,this.keyboardShortcuts=null,this._weekBoundarySaveTimer=null,this._pendingWeekBoundary=null,this._isRegeneratingTimeline=!1,this._queuedRegeneratePayload=null,this._isEnforcingWeekly=!1,this._exportManagerInstance=null,this._exportBindingsAttached=!1,this._costToggleBtn=null,this._costToggleBtnText=null,this._costToggleSpinner=null,this._costToggleBtnIcon=null,this._costViewAutoActivated=!1,this._ganttScrollSyncHandlers=null,this._stateManagerListener=null,this._suppressStateManagerEvent=!1,this._currencyFormatter=null}_getProjectDateRange(){var t,e;let a=null,s=null;if(null==(t=this.state)?void 0:t.projectStart){const t=new Date(this.state.projectStart);Number.isNaN(t.getTime())||(a=t)}if(null==(e=this.state)?void 0:e.projectEnd){const t=new Date(this.state.projectEnd);Number.isNaN(t.getTime())||(s=t)}return!a||s&&!Number.isNaN(s.getTime())||(s=new Date(a.getFullYear(),11,31)),{start:a,end:s}}_estimateExpectedWeeklyColumns(){const{start:t,end:e}=this._getProjectDateRange();if(!t||!e||Number.isNaN(t.getTime())||Number.isNaN(e.getTime()))return 0;const a=Math.max(0,Math.floor((e-t)/864e5))+1;return Math.max(1,Math.ceil(a/7))}_countWeeklyColumns(){return Array.isArray(this.state.timeColumns)?this.state.timeColumns.filter(t=>{var e;const a=(t.generationMode||t.type||"").toLowerCase();return"weekly"===a||"week"===a||"wk"===a||Number.isFinite(Number(null!=(e=t.weekNumber)?e:t.week_number))}).length:0}initialize(){return o(this,arguments,function*(t={}){if(this.initialized)console.warn("JadwalKegiatanApp already initialized");else{console.log("üöÄ Initializing Jadwal Kegiatan App (Vite Build)");try{this._setupState(t),this._setupDomRefs(t),this._attachEvents(),yield this._loadInitialData(),this.initialized=!0,console.log("‚úÖ Jadwal Kegiatan App initialized successfully"),window.JadwalKegiatanApp=this}catch(e){throw console.error("‚ùå Failed to initialize Jadwal Kegiatan App:",e),e}}})}_setupState(t){var e;const a=window.kelolaTahapanPageState||(null==(e=window.JadwalPekerjaanApp)?void 0:e.state);this.state=Object.assign({pekerjaanTree:[],timeColumns:[],tahapanList:[],timeColumnIndex:{},expandedNodes:new Set,volumeMap:new Map,isLoading:!1,error:null,domRefs:{},apiEndpoints:{},projectId:null,projectName:"",projectStart:null,projectEnd:null,useUPlotKurva:!0,timeScale:"weekly",inputMode:"percentage",saveMode:"weekly",weekStartDay:0,weekEndDay:6,displayScale:null,progressMode:"planned",displayMode:"percentage",useUnifiedTable:!t.disableUnifiedTable,keepLegacyGantt:!!t.enableLegacyGantt,dependencies:[],stateManager:this.stateManager,plannedState:{progressTotals:new Map,volumeTotals:new Map,cellVolumeOverrides:new Map,cellValidationMap:new Map,failedRows:new Set,autoWarningRows:new Set,volumeWarningRows:new Set,validationWarningRows:new Set,saveErrorRows:new Set,apiFailedRows:new Set,showCompletionWarnings:!1,isDirty:!1},actualState:{progressTotals:new Map,volumeTotals:new Map,cellVolumeOverrides:new Map,cellValidationMap:new Map,failedRows:new Set,autoWarningRows:new Set,volumeWarningRows:new Set,validationWarningRows:new Set,saveErrorRows:new Set,apiFailedRows:new Set,showCompletionWarnings:!1,isDirty:!1},progressTotals:null,volumeTotals:null,cellVolumeOverrides:null,cellValidationMap:null,failedRows:null,autoWarningRows:null,volumeWarningRows:null,validationWarningRows:null,saveErrorRows:null,apiFailedRows:null,showCompletionWarnings:!1,isDirty:!1},a||{},t.initialState||{}),window.kelolaTahapanPageState=this.state,this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),this._ensureStateCollections(),this.state.displayScale||(this.state.displayScale=this.state.timeScale||"weekly"),this._setupStateDelegation(),this._bindStateManagerEvents()}_setupStateDelegation(){const t=()=>"actual"===this.state.progressMode?this.state.actualState:this.state.plannedState;Object.defineProperty(this.state,"modifiedCells",{get:()=>{const t=this.state.progressMode;return this.stateManager.states[t].modifiedCells},configurable:!0}),Object.defineProperty(this.state,"assignmentMap",{get:()=>{const t=this.state.progressMode;return this.stateManager.states[t].assignmentMap},configurable:!0}),Object.defineProperty(this.state,"costAssignmentMap",{get:()=>{const t=this.state.progressMode;return this.stateManager.states[t].costAssignmentMap},configurable:!0}),Object.defineProperty(this.state,"costModifiedCells",{get:()=>{const t=this.state.progressMode;return this.stateManager.states[t].costModifiedCells},configurable:!0}),Object.defineProperty(this.state,"progressTotals",{get:()=>t().progressTotals,configurable:!0}),Object.defineProperty(this.state,"volumeTotals",{get:()=>t().volumeTotals,configurable:!0}),Object.defineProperty(this.state,"cellVolumeOverrides",{get:()=>t().cellVolumeOverrides,configurable:!0}),Object.defineProperty(this.state,"cellValidationMap",{get:()=>t().cellValidationMap,configurable:!0}),Object.defineProperty(this.state,"isDirty",{get:()=>t().isDirty||this.stateManager.hasUnsavedChanges(),set:e=>{t().isDirty=e},configurable:!0}),console.log("[JadwalKegiatanApp] Phase 0.3: State delegation setup with StateManager integration")}_bindStateManagerEvents(){this.stateManager&&!this._stateManagerListener&&(this._stateManagerListener=t=>this._handleStateManagerEvent(t),this.stateManager.addEventListener(this._stateManagerListener),console.log("[JadwalKegiatanApp] StateManager listener attached"))}_unbindStateManagerEvents(){this.stateManager&&this._stateManagerListener&&(this.stateManager.removeEventListener(this._stateManagerListener),this._stateManagerListener=null,console.log("[JadwalKegiatanApp] StateManager listener removed"))}_handleStateManagerEvent(t={}){if(t&&"object"==typeof t)switch(t.type){case"mode-switch":if(this._suppressStateManagerEvent)return;this._applyProgressModeSwitch(t.newMode,{showToast:!1});break;case"commit":this._handleStateCommitEvent(t);break;case"reset":this._handleStateResetEvent()}}_handleStateCommitEvent(t={}){this.gridManager&&"function"==typeof this.gridManager.refreshCells&&this.gridManager.refreshCells(),this._updateStatusBar(),this._updateCharts();const e="actual"===(t.mode||this.state.progressMode||"planned")?"Realisasi":"Perencanaan";console.log(`[StateManager] Commit event processed for mode: ${e}`)}_handleStateResetEvent(){var t;console.log("[StateManager] Reset event received, syncing UI components"),this.state.progressMode=(null==(t=this.stateManager)?void 0:t.currentMode)||"planned",this._syncToolbarRadios(),this._syncGridViews(),this._updateStatusBar("Ready"),this._updateCharts()}_getCurrentModeState(){const t="actual"===this.state.progressMode?"actual":"planned";return this.stateManager.states[t]}_updateSaveButtonState(){var t,e,a;const s=null==(e=null==(t=this.state)?void 0:t.domRefs)?void 0:e.saveButton;if(!s)return;const i=(null==(a=this.state)?void 0:a.failedRows)instanceof Set&&this.state.failedRows.size>0;s.disabled=!1,s.classList.toggle("btn-outline-danger",Boolean(i)),s.classList.toggle("btn-success",!i),i?s.setAttribute("title","Ada baris dengan peringatan (>100%/volume). Klik untuk melihat detail dan perbaiki."):s.removeAttribute("title")}_ensureStateCollections(){this.state.failedRows instanceof Set||(this.state.failedRows=new Set),this.state.autoWarningRows instanceof Set||(this.state.autoWarningRows=new Set),this.state.volumeWarningRows instanceof Set||(this.state.volumeWarningRows=new Set),this.state.validationWarningRows instanceof Set||(this.state.validationWarningRows=new Set),this.state.saveErrorRows instanceof Set||(this.state.saveErrorRows=new Set),this.state.apiFailedRows instanceof Set||(this.state.apiFailedRows=new Set),this.state.progressTotals instanceof Map||(this.state.progressTotals=new Map),this.state.volumeTotals instanceof Map||(this.state.volumeTotals=new Map),this.state.cellVolumeOverrides instanceof Map||(this.state.cellVolumeOverrides=new Map),this.state.cellValidationMap instanceof Map||(this.state.cellValidationMap=new Map)}_setupDomRefs(t){const e=Object.assign({root:document.getElementById("tahapan-grid-app"),saveButton:document.getElementById("save-button")||document.getElementById("btn-save-all"),refreshButton:document.getElementById("refresh-button"),resetButton:document.getElementById("btn-reset-progress"),tanstackGridContainer:document.getElementById("tanstack-grid-container"),tanstackGridBody:document.getElementById("tanstack-grid-body"),tanstackGridTopScroll:document.getElementById("tanstack-grid-scroll-top"),tanstackGridTopScrollInner:document.getElementById("tanstack-grid-scroll-inner"),scurveChart:document.getElementById("scurve-chart"),ganttChart:document.getElementById("gantt-chart"),ganttChartWrapper:document.getElementById("gantt-chart-wrapper"),ganttTreeBody:document.getElementById("gantt-tree-body"),ganttTreeScroll:document.getElementById("gantt-tree-scroll"),ganttSummaryTable:document.getElementById("gantt-summary-table"),ganttSummaryBody:document.getElementById("gantt-summary-body"),ganttSummaryTotal:document.getElementById("gantt-summary-total"),statusBar:document.querySelector(".status-bar"),statusMessageEl:document.getElementById("status-message"),itemCountEl:document.getElementById("item-count"),modifiedCountEl:document.getElementById("modified-count"),totalProgressEl:document.getElementById("total-progress"),weekStartSelect:document.getElementById("week-start-day-select"),weekEndSelect:document.getElementById("week-end-day-select")},t.domRefs||{});if(this.state.domRefs=e,this._updateSaveButtonState(),!e.root)throw new Error("Root container #tahapan-grid-app tidak ditemukan");if(this._applyDataset(e.root),!e.tanstackGridContainer)throw new Error("TanStack grid container #tanstack-grid-container tidak ditemukan")}_applyDataset(t){var e,a,s,i,n,o;if(!t||!t.dataset)return;const{dataset:r}=t;this.state.projectId=Number(r.projectId||this.state.projectId||0)||this.state.projectId,this.state.projectName=r.projectName||this.state.projectName,this.state.projectStart=r.projectStart||this.state.projectStart,this.state.projectEnd=r.projectEnd||this.state.projectEnd;const l=new Set(["daily","weekly","monthly","custom"]),d=(r.defaultTimeScale||r.timeScale||r.saveMode||this.state.timeScale||this.state.saveMode||"").toString().toLowerCase();l.has(d)?(this.state.timeScale=d,this.state.saveMode=d):this.state.timeScale||(this.state.timeScale=this.state.saveMode||"weekly"),this.state.displayScale=this.state.timeScale||"weekly";const h=(r.defaultInputMode||r.inputMode||r.displayMode||this.state.inputMode||"percentage").toString().toLowerCase(),c=new Set(["percentage","volume","cost"]);this.state.inputMode=c.has(h)?h:"percentage";const u=Number.parseInt(null!=(i=null!=(s=null!=(a=null!=(e=r.weekEndDay)?e:r.weekend)?a:r.weekEnd)?s:r.week_end_day)?i:"",10);Number.isNaN(u)||(this.state.weekEndDay=u);const g=Number.parseInt(null!=(o=null!=(n=r.weekStartDay)?n:r.week_start_day)?o:"",10);if(Number.isNaN(g))Number.isNaN(u)||(this.state.weekStartDay=(this.state.weekEndDay+1)%7);else{const t=(g%7+7)%7;this.state.weekStartDay=t}const p=Object.assign({base:r.apiBase||"",tahapan:r.apiTahapan||r.apiBase||"",listPekerjaan:r.apiListPekerjaan||"",volume:r.apiVolume||"",assignmentsBase:r.apiAssignmentsBase||"",save:r.apiSave||this.state.apiEndpoints&&this.state.apiEndpoints.save||this._getDefaultSaveEndpoint(),weekBoundary:r.apiWeekBoundary||"",regenerateTahapan:r.apiRegenerateTahapan||"",reset:r.apiResetProgress||this.state.apiEndpoints&&this.state.apiEndpoints.reset||""},this.state.apiEndpoints||{});this.state.apiEndpoints=p,void 0!==r.enableUplotKurva&&(this.state.useUPlotKurva="false"!==r.enableUplotKurva)}_attachEvents(){this._attachToolbarEvents(),this._initTanStackGridIfNeeded()}_attachToolbarEvents(){const t=this.state.domRefs.saveButton,e=this.state.domRefs.refreshButton,a=this.state.domRefs.resetButton;t&&t.addEventListener("click",()=>this.saveChanges()),e&&e.addEventListener("click",()=>this.refresh()),a&&a.addEventListener("click",()=>this._handleResetProgress()),this._syncToolbarRadios(),this._attachRadioGroupHandler("displayMode",t=>this._handleDisplayModeChange(t)),this._attachRadioGroupHandler("progressMode",t=>this._handleProgressModeChange(t)),this._attachRadioGroupHandler("timeScale",t=>this._handleTimeScaleChange(t)),this._setupWeekBoundaryControls(),this._setupExportButtons(),this._setupCostViewToggle(),this._setupKeyboardShortcuts(),this._setupUXEnhancements()}_setupKeyboardShortcuts(){this.keyboardShortcuts=new g,this.keyboardShortcuts.register("ctrl+s",()=>{this.saveChanges(),p.info("Saving changes... (Ctrl+S)")},{description:"Save all changes"}),this.keyboardShortcuts.register("ctrl+r",()=>{this.refresh(),p.info("Refreshing data... (Ctrl+R)")},{description:"Refresh data from server"}),this.keyboardShortcuts.register("ctrl+alt+p",()=>{const t=document.getElementById("mode-planned");t&&(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})),p.info("Switched to Perencanaan mode (Ctrl+Alt+P)"))},{description:"Switch to Perencanaan mode"}),this.keyboardShortcuts.register("ctrl+alt+a",()=>{const t=document.getElementById("mode-actual");t&&(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})),p.info("Switched to Realisasi mode (Ctrl+Alt+A)"))},{description:"Switch to Realisasi mode"}),this.keyboardShortcuts.register("ctrl+alt+1",()=>{const t=document.getElementById("mode-percentage");t&&!t.disabled&&(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})),p.info("Display: Percentage (Ctrl+Alt+1)"))},{description:"Switch to Percentage display"}),this.keyboardShortcuts.register("ctrl+alt+2",()=>{const t=document.getElementById("mode-volume");t&&!t.disabled&&(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})),p.info("Display: Volume (Ctrl+Alt+2)"))},{description:"Switch to Volume display"}),this.keyboardShortcuts.register("ctrl+alt+3",()=>{const t=document.getElementById("mode-cost");t&&!t.disabled?(t.checked=!0,t.dispatchEvent(new Event("change",{bubbles:!0})),p.info("Display: Cost (Ctrl+Alt+3)")):p.warning("Cost view only available in Realisasi mode")},{description:"Switch to Cost display"}),this.keyboardShortcuts.register("escape",()=>{document.querySelectorAll(".dropdown-menu.show").forEach(t=>{const e=t.previousElementSibling;if(e){const t=bootstrap.Dropdown.getInstance(e);t&&t.hide()}})},{description:"Close open menus",preventDefault:!1}),this.keyboardShortcuts.register("ctrl+shift+/",()=>{this._showKeyboardShortcutsHelp()},{description:"Show keyboard shortcuts help"}),console.log("‚å®Ô∏è Keyboard shortcuts registered:",this.keyboardShortcuts.getShortcuts())}_setupUXEnhancements(){m();const t=this.state.domRefs.saveButton;t&&t.setAttribute("data-keyboard-hint","Ctrl+S"),console.log("üé® UX enhancements applied")}_showKeyboardShortcutsHelp(){const t=`\n      <div class="modal fade" id="keyboardShortcutsModal" tabindex="-1">\n        <div class="modal-dialog">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title">\n                <i class="bi bi-keyboard"></i> Keyboard Shortcuts\n              </h5>\n              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n            </div>\n            <div class="modal-body">\n              <table class="table table-sm">\n                <thead>\n                  <tr>\n                    <th style="width: 40%">Shortcut</th>\n                    <th>Action</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${this.keyboardShortcuts.getShortcuts().map(t=>`\n      <tr>\n        <td><kbd>${t.key.replace(/\+/g,"</kbd> + <kbd>")}</kbd></td>\n        <td>${t.description}</td>\n      </tr>\n    `).join("")}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,e=document.getElementById("keyboardShortcutsModal");e&&e.remove(),document.body.insertAdjacentHTML("beforeend",t);new bootstrap.Modal(document.getElementById("keyboardShortcutsModal")).show(),document.getElementById("keyboardShortcutsModal").addEventListener("hidden.bs.modal",function(){this.remove()})}_setupExportButtons(){var t;if(!this._exportBindingsAttached)if("undefined"!=typeof ExportManager){if(null==(t=this.state)?void 0:t.projectId)try{this._exportManagerInstance=new ExportManager(this.state.projectId,"jadwal-pekerjaan");["csv","pdf","word","xlsx"].forEach(t=>{const e=document.getElementById(`btn-export-${t}`);e&&e.addEventListener("click",()=>{this._exportManagerInstance.exportAs(t)})}),this._exportBindingsAttached=!0}catch(e){console.error("[JadwalKegiatanApp] Failed to initialize export buttons",e)}}else console.warn("[JadwalKegiatanApp] ExportManager is not loaded; export buttons disabled")}_setupCostViewToggle(){var t,e;const a=document.getElementById("toggleCostViewBtn"),s=document.getElementById("toggleCostViewBtnText"),i=document.getElementById("toggleCostViewBtnSpinner"),n=null==a?void 0:a.querySelector("i");a?this.kurvaSChart?!1!==(null==(e=null==(t=this.kurvaSChart)?void 0:t.options)?void 0:e.enableCostView)?(this._costToggleBtn=a,this._costToggleBtnText=s,this._costToggleSpinner=i,this._costToggleBtnIcon=n,a.addEventListener("click",()=>o(this,null,function*(){a.disabled=!0,null==i||i.classList.remove("d-none");try{(yield this.kurvaSChart.toggleView())?(this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Switched Kurva-S view:",this.kurvaSChart.viewMode)):console.error("[JadwalKegiatanApp] Failed to toggle view")}catch(t){console.error("[JadwalKegiatanApp] Error toggling cost view:",t)}finally{a.disabled=!1,null==i||i.classList.add("d-none")}})),this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Cost view toggle button setup complete")):a.classList.add("d-none"):console.warn("[JadwalKegiatanApp] Kurva S chart not initialized, cannot setup toggle"):console.log("[JadwalKegiatanApp] Cost view toggle button not found (chart tab may not be active)")}_setCostToggleButtonState(){if(!this._costToggleBtn||!this.kurvaSChart)return;const t="cost"===this.kurvaSChart.viewMode,e=t?"Show Progress View":"Show Cost View",a=t?"fas fa-chart-line":"fas fa-money-bill-wave";this._costToggleBtnText&&(this._costToggleBtnText.textContent=e),this._costToggleBtnIcon&&(this._costToggleBtnIcon.className=a)}_activateDefaultCostView(){return o(this,null,function*(){if(this._costViewAutoActivated)return void this._setCostToggleButtonState();if(!this.kurvaSChart)return;if((this.kurvaSChart.options||{}).enableCostView)try{(yield this.kurvaSChart.toggleView("cost"))&&(this._costViewAutoActivated=!0,this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Defaulted Kurva-S to cost view"))}catch(t){console.warn("[JadwalKegiatanApp] Failed to enable cost view automatically:",t)}})}_attachRadioGroupHandler(t,e){const a=document.querySelectorAll(`input[name="${t}"]`);a&&0!==a.length&&a.forEach(t=>{t.addEventListener("change",t=>{t.target.checked&&e(t.target.value)})})}_setupWeekBoundaryControls(){const{weekStartSelect:t,weekEndSelect:e}=this.state.domRefs||{};t&&e&&(this._syncWeekBoundaryControls(),t.addEventListener("change",t=>{const e=this._normalizePythonWeekday(t.target.value,this._getWeekStartDay()),a=(e+6)%7;this._handleWeekBoundaryChange({weekStartDay:e,weekEndDay:a,source:"start"})}),e.addEventListener("change",t=>{const e=this._normalizePythonWeekday(t.target.value,this._getWeekEndDay()),a=(e+1)%7;this._handleWeekBoundaryChange({weekStartDay:a,weekEndDay:e,source:"end"})}))}_handleResetProgress(){return o(this,null,function*(){var t;const e=null==(t=this.state.apiEndpoints)?void 0:t.reset;if(!e)return void this.showToast("Endpoint reset tidak tersedia","danger",3200);const a=this.state.progressMode||"planned",s="planned"===a?"Perencanaan":"Realisasi";if(window.confirm(`Reset semua progress ${s} ke 0%?\n\nData ${"Perencanaan"===s?"Realisasi":"Perencanaan"} tidak akan terpengaruh.\n\nOperasi ini dapat di-undo dengan memasukkan ulang data.`))try{this.state.isLoading=!0,this._updateStatusBar(`Mereset progress ${s}...`);const t=yield fetch(e,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:JSON.stringify({mode:a})});if(!t.ok){const e=yield t.text().catch(()=>"");throw new Error(e||`HTTP ${t.status}`)}const i=yield t.json().catch(()=>({}));this._resetEditedCellsState(),this.state.assignmentMap instanceof Map?this.state.assignmentMap.clear():this.state.assignmentMap=new Map,this._clearFailedRows(),this.state.isDirty=!1;const n=(null==i?void 0:i.message)||"Progress berhasil direset. Silakan input ulang jadwal pekerjaan.";this.showToast(n,"success",3400),yield this._loadInitialData({forceReload:!0})}catch(i){console.error("[JadwalKegiatanApp] Failed to reset progress",i),this.showToast("Gagal mereset progress. Coba lagi atau hubungi admin.","danger",3600)}finally{this.state.isLoading=!1,this._updateStatusBar()}})}_syncWeekBoundaryControls(){const{weekStartSelect:t,weekEndSelect:e}=this.state.domRefs||{};t&&(t.value=String(this._getWeekStartDay())),e&&(e.value=String(this._getWeekEndDay()))}_handleWeekBoundaryChange({weekStartDay:t,weekEndDay:e,source:a}){const s=this._normalizePythonWeekday(e,this._getWeekEndDay()),i=this._normalizePythonWeekday(t,(s+1)%7);if(i===this._getWeekStartDay()&&s===this._getWeekEndDay())return void this._syncWeekBoundaryControls();this.state.weekStartDay=i,this.state.weekEndDay=s,this._syncWeekBoundaryControls();const n=`${this._formatWeekdayLabel(i)} ‚Üí ${this._formatWeekdayLabel(s)}`,o="start"===a?"Week start disetel ke":"Week end disetel ke";this.showToast(`${o} ${n}`,"info",2400),this._regenerateColumnsForWeekBoundary(),this._persistWeekBoundarySettings(i,s)}_regenerateColumnsForWeekBoundary(){if(Array.isArray(this.state.tahapanList)&&0!==this.state.tahapanList.length){this.timeColumnGenerator||(this.timeColumnGenerator=new h(this.state));try{this.timeColumnGenerator.generate(),this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),this._syncGridViews(),this._recalculateAllProgressTotals()}catch(t){console.error("[JadwalKegiatanApp] Failed to regenerate columns for week boundary change",t),this.showToast("Gagal menerapkan pengaturan minggu","danger",3200)}}}_invalidateCachedDataset(){this.state.pekerjaanTree=[],this.state.tahapanList=[],this.state.timeColumns=[],this.state.flatPekerjaan=[],this.state.timeColumnIndex={},this.state.assignmentMap=new Map,this._resetEditedCellsState()}_resetEditedCellsState(){this.state.modifiedCells instanceof Map?this.state.modifiedCells.clear():this.state.modifiedCells=new Map,this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides.clear():this.state.cellVolumeOverrides=new Map,this.state.cellValidationMap instanceof Map?this.state.cellValidationMap.clear():this.state.cellValidationMap=new Map,this.state.validationWarningRows instanceof Set?this.state.validationWarningRows.clear():this.state.validationWarningRows=new Set,this.state.saveErrorRows instanceof Set?this.state.saveErrorRows.clear():this.state.saveErrorRows=new Set,this.state.showCompletionWarnings=!1}_persistWeekBoundarySettings(t,e){var a;const s=null==(a=this.state.apiEndpoints)?void 0:a.weekBoundary;s&&(this._weekBoundarySaveTimer&&clearTimeout(this._weekBoundarySaveTimer),this._pendingWeekBoundary={weekStartDay:t,weekEndDay:e},this._weekBoundarySaveTimer=window.setTimeout(()=>{this._weekBoundarySaveTimer=null;const a=this._pendingWeekBoundary||{weekStartDay:t,weekEndDay:e};this._pendingWeekBoundary=null;const i=JSON.stringify({week_start_day:a.weekStartDay,week_end_day:a.weekEndDay});fetch(s,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:i}).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}`);return t.json()}).then(t=>{const e=void 0!==(null==t?void 0:t.week_start_day)?t.week_start_day:a.weekStartDay,s=void 0!==(null==t?void 0:t.week_end_day)?t.week_end_day:a.weekEndDay;this.state.weekStartDay=e,this.state.weekEndDay=s,this._regenerateTimeline({mode:"weekly",weekStartDay:e,weekEndDay:s})}).catch(t=>{console.warn("[JadwalKegiatanApp] Failed to persist week boundary setting",t)})},500))}_regenerateTimeline(){return o(this,arguments,function*(t={}){var e;const{mode:a="weekly",weekStartDay:s,weekEndDay:i}=t,o=null==(e=this.state.apiEndpoints)?void 0:e.regenerateTahapan;if(!o)return;if(this._isRegeneratingTimeline)return void(this._queuedRegeneratePayload={mode:a,weekStartDay:s,weekEndDay:i});if(this.state.isDirty&&this.state.modifiedCells instanceof Map&&this.state.modifiedCells.size>0){if(!window.confirm("Mengubah batas minggu akan me-refresh data dan membatalkan perubahan yang belum disimpan. Lanjutkan?"))return;this._resetEditedCellsState(),this.state.isDirty=!1}this._isRegeneratingTimeline=!0,this.state.isLoading=!0;const r="monthly"===a?"Mengatur ulang struktur bulanan...":"Mengatur ulang struktur minggu...";this._updateStatusBar(r);const l="monthly"===a?"Mengatur ulang kolom monthly...":"Mengatur ulang kolom weekly sesuai preferensi Anda...";this.showToast(l,"info",2400);try{const t=yield fetch(o,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:JSON.stringify(n({mode:a},"weekly"===a?{week_start_day:"number"==typeof s?s:this._getWeekStartDay(),week_end_day:"number"==typeof i?i:this._getWeekEndDay()}:{}))});if(!t.ok)throw new Error(`HTTP ${t.status}`);this._invalidateCachedDataset(),yield this._loadInitialData({forceReload:!0});const e="monthly"===a?"Struktur monthly diperbarui (read-only)":"Periode minggu diperbarui";this.showToast(e,"success",2200)}catch(d){console.error("[JadwalKegiatanApp] Failed to regenerate weekly structure",d),this.showToast("Gagal memperbarui struktur waktu","danger",3200)}finally{if(this.state.isLoading=!1,this._updateStatusBar(),this._isRegeneratingTimeline=!1,this._queuedRegeneratePayload){const t=this._queuedRegeneratePayload;this._queuedRegeneratePayload=null,this._regenerateTimeline(t)}}})}_formatWeekdayLabel(t){const e=this._normalizePythonWeekday(t,0);return["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu","Minggu"][e]||`Day ${e}`}_syncToolbarRadios(){const t=this.state.inputMode||"percentage";document.querySelectorAll('input[name="displayMode"]').forEach(e=>{e.checked=e.value===t});const e=this.state.progressMode||"planned";document.querySelectorAll('input[name="progressMode"]').forEach(t=>{const a=t.value===e;t.checked!==a&&(t.checked=a);const s=t.nextElementSibling;s&&s.matches(".btn")&&s.setAttribute("aria-selected",String(a))});const a=this.state.displayScale||this.state.timeScale||"weekly";document.querySelectorAll('input[name="timeScale"]').forEach(t=>{t.checked=t.value===a}),this._updateCostToggleAvailability()}_handleDisplayModeChange(t){const e=(t||"").toLowerCase();if(!new Set(["percentage","volume","cost"]).has(e)||this.state.inputMode===e)return;if("cost"===e&&"actual"!==(this.state.progressMode||"planned"))return this.showToast("Mode biaya hanya tersedia saat melihat Realisasi","warning",2600),void this._syncToolbarRadios();this.state.inputMode=e,this.state.displayMode=e,this.gridManager&&this.gridManager.setInputMode(e),this._syncGridViews();let a="Persentase";"volume"===e?a="Volume":"cost"===e&&(a="Biaya"),this.showToast(`Mode input diubah ke ${a}`,"info",2200)}_handleProgressModeChange(t){const e=(t||"").toLowerCase();if(!new Set(["planned","actual"]).has(e)||this.state.progressMode===e)return;const a=this.state.progressMode;console.log(`[ModeChange] Switching progress mode from ${a} to ${e}`);const s=this.stateManager.states[a].getStats();this._suppressStateManagerEvent=!0,this.stateManager.switchMode(e),this._suppressStateManagerEvent=!1;const i=this.stateManager.states[e].getStats();console.log("[ModeChange] State switch complete:"),console.log(`  - Old ${a.toUpperCase()}: ${s.modifiedCount} modified, ${s.assignmentCount} assignments`),console.log(`  - New ${e.toUpperCase()}: ${i.modifiedCount} modified, ${i.assignmentCount} assignments`),this._applyProgressModeSwitch(e,{showToast:!0})}_applyProgressModeSwitch(t,e={}){const a="actual"===t?"actual":"planned",s=this.state.inputMode||"percentage";if(this.state.progressMode=a,"actual"!==a&&"cost"===this.state.inputMode&&(this.state.inputMode="percentage",this.state.displayMode="percentage"),this.gridManager&&"function"==typeof this.gridManager.setInputMode){const t=this.state.inputMode||"percentage";t!==s&&this.gridManager.setInputMode(t)}if(this._syncToolbarRadios(),this._updateCostToggleAvailability(),this._updateProgressModeIndicator(a),this._syncGridViews(),this._updateCharts(),e.showToast){const t="planned"===a?"Perencanaan":"Realisasi";this.showToast(`Mode progress diubah ke ${t}`,"info",2200)}}_updateProgressModeIndicator(t){const e=document.getElementById("progress-mode-indicator");if(!e)return;const a="actual"===t?"actual":"planned",s="planned"===a?"Perencanaan":"Realisasi",i="planned"===a?"bg-info":"bg-warning";e.textContent=`Mode: ${s}`,e.className=`badge ${i} ms-2`,e.style.cssText="font-size: 0.75rem; vertical-align: middle;"}_updateCostToggleAvailability(){const t=document.getElementById("mode-cost");if(!t)return;const e="actual"===(this.state.progressMode||"planned");if(t.disabled=!e,!e&&t.checked){const t=document.getElementById("mode-percentage");t&&(t.checked=!0)}}_handleTimeScaleChange(t){const e=(t||"").toLowerCase();if(!new Set(["weekly","monthly"]).has(e))return this._syncToolbarRadios(),void this.showToast("Mode waktu ini belum aktif pada fase saat ini","warning",3200);(this.state.displayScale||this.state.timeScale||"weekly")!==e?(this.state.displayScale=e,this._syncToolbarRadios(),this._syncGridViews(),this._renderGrid(),this._updateCharts(),"weekly"===e?this.showToast("Time scale diatur ke Weekly","info",2e3):this.showToast("Time scale diatur ke Monthly (akumulasi 4 minggu, read-only)","info",2600)):this._syncToolbarRadios()}_initTanStackGridIfNeeded(){const t=this.state.domRefs.tanstackGridContainer;t?(t.classList.remove("d-none"),this.state.useUnifiedTable?this.unifiedManager||(this.unifiedManager=new w(this.state,{showToast:this.showToast.bind(this),onCellChange:t=>this._handleGridCellChange(t),getCellValidationState:t=>this._getCellValidationState(t)}),this.unifiedManager.mount(t,{topScroll:this.state.domRefs.tanstackGridTopScroll,topScrollInner:this.state.domRefs.tanstackGridTopScrollInner,body:this.state.domRefs.tanstackGridBody})):this.gridManager||(this.gridManager=new l(this.state,{showToast:this.showToast.bind(this),onCellChange:t=>this._handleGridCellChange(t),getCellValidationState:t=>this._getCellValidationState(t)}),this.gridManager.mount(t,{topScroll:this.state.domRefs.tanstackGridTopScroll,topScrollInner:this.state.domRefs.tanstackGridTopScrollInner,body:this.state.domRefs.tanstackGridBody}))):console.warn("[JadwalKegiatanApp] TanStack grid container not available")}_loadInitialData(){return o(this,arguments,function*(t={}){var e,a,s,i,n,o,r,l,d,g,p,m;const{forceReload:f=!1}=t;if(!f&&(null==(e=this.state.pekerjaanTree)?void 0:e.length)>0)return console.log("[JadwalKegiatanApp] Using template dataset"),console.log("Preloaded pekerjaanTree items:",this.state.pekerjaanTree.length),console.log("Preloaded tahapanList items:",(null==(a=this.state.tahapanList)?void 0:a.length)||0),console.log("Preloaded timeColumns items:",(null==(s=this.state.timeColumns)?void 0:s.length)||0),this._recalculateAllProgressTotals(),void this._syncGridViews();this.state.apiBase=(null==(i=this.state.apiEndpoints)?void 0:i.tahapan)||`/detail_project/api/project/${this.state.projectId}/tahapan/`,this.dataLoader=new c(this.state),this.timeColumnGenerator=new h(this.state),this.saveHandler=new u(this.state,{apiUrl:(null==(n=this.state.apiEndpoints)?void 0:n.save)||`/detail_project/api/project/${this.state.projectId}/pekerjaan/assign_weekly/`,onSuccess:t=>this._onSaveSuccess(t),onError:t=>this._onSaveError(t),showToast:(t,e)=>this.showToast(t,e)}),this.state.isLoading=!0;try{console.log("[JadwalKegiatanApp] Loading data using modern DataLoader..."),yield this.dataLoader.loadAllData({skipIfLoaded:!1}),this.timeColumnGenerator.generate();const t=(this.state.displayScale||this.state.timeScale||"weekly").toLowerCase();if(!this._isEnforcingWeekly&&"weekly"===t){const t=this._countWeeklyColumns(),e=this._estimateExpectedWeeklyColumns(),a=((null==(r=null==(o=this.state.timeColumns)?void 0:o[0])?void 0:r.generationMode)||(null==(d=null==(l=this.state.timeColumns)?void 0:l[0])?void 0:d.type)||"").toLowerCase();if(0===t||"monthly"===a||e>0&&t>0&&t<e)return console.warn("[JadwalKegiatanApp] Weekly columns incomplete; regenerating weekly structure based on project timeline..."),this._isEnforcingWeekly=!0,yield this._regenerateTimeline({mode:"weekly",weekStartDay:this._getWeekStartDay(),weekEndDay:this._getWeekEndDay()}),void(this._isEnforcingWeekly=!1)}yield this.dataLoader.loadAssignments(),this._recalculateAllProgressTotals(),yield this._loadKurvaSData(),this.state.dependencies=this.state.dependencies||[],this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),console.log("[JadwalKegiatanApp] ‚úÖ Data loaded successfully:",`${(null==(g=this.state.flatPekerjaan)?void 0:g.length)||0} pekerjaan,`,`${(null==(p=this.state.tahapanList)?void 0:p.length)||0} tahapan,`,`${(null==(m=this.state.timeColumns)?void 0:m.length)||0} columns`),this._initializeCharts(),this._updateCharts()}catch(y){console.error("[JadwalKegiatanApp] ‚ùå Failed to load data:",y),this.state.error=y,this.showToast("Gagal memuat data: "+y.message,"danger")}finally{this.state.isLoading=!1,this._syncGridViews()}})}_loadKurvaSData(){return o(this,null,function*(){var t;try{const e=`/detail_project/api/v2/project/${this.state.projectId}/kurva-s-data/`;console.log("[JadwalKegiatanApp] Loading Kurva S harga data from:",e);const a=yield fetch(e,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const s=yield a.json();if(this.state.hargaMap=new Map(Object.entries(s.hargaMap||{}).map(([t,e])=>[t,parseFloat(e)||0])),this.state.totalBiayaProject=parseFloat(s.totalBiayaProject||0),this.state.pekerjaanMeta=s.pekerjaanMeta||{},s.volumeMap&&Object.keys(s.volumeMap).length>0){0===((null==(t=this.state.volumeMap)?void 0:t.size)||0)&&(this.state.volumeMap=new Map(Object.entries(s.volumeMap).map(([t,e])=>[t,parseFloat(e)||0])))}console.log("[JadwalKegiatanApp] ‚úÖ Kurva S data loaded:",{hargaCount:this.state.hargaMap.size,totalBiaya:this.state.totalBiayaProject,totalBiayaFormatted:`Rp ${this.state.totalBiayaProject.toLocaleString("id-ID")}`})}catch(e){console.error("[JadwalKegiatanApp] ‚ö†Ô∏è Failed to load Kurva S data:",e),this.state.hargaMap=this.state.hargaMap||new Map,this.state.totalBiayaProject=this.state.totalBiayaProject||0,this.state.pekerjaanMeta=this.state.pekerjaanMeta||{},console.warn("[JadwalKegiatanApp] Kurva S will use fallback calculation")}})}_loadChartModules(){return o(this,null,function*(){if(!this._chartModulesLoaded&&!this._chartModulesLoading)if(this.state.useUPlotKurva){this._chartModulesLoading=!0,console.log("üìä Loading chart modules (lazy)...");try{const t=yield r(()=>import("./chart-modules-7de66ekb.js").then(t=>t.u),__vite__mapDeps([0,1]));this.KurvaSChartClass=t.KurvaSUPlotChart||t.default,this._chartModulesLoaded=!0,this._chartModulesLoading=!1,console.log("‚úÖ Chart modules loaded"),this._initializeChartsAfterLoad()}catch(t){console.error("‚ùå Failed to load chart modules:",t),this._chartModulesLoading=!1,p.error("Failed to load chart modules")}}else console.warn("[JadwalKegiatanApp] uPlot dimatikan, melewati inisialisasi chart")})}_initializeChartsAfterLoad(){var t;if(console.log("[JadwalKegiatanApp] Initializing charts after load..."),(null==(t=this.state.domRefs)?void 0:t.scurveChart)&&this.KurvaSChartClass)try{this.kurvaSChart=new this.KurvaSChartClass(this.state,{useIdealCurve:!0,steepnessFactor:.8,smoothCurves:!0,showArea:!0,enableCostView:!0});if(this.kurvaSChart.initialize(this.state.domRefs.scurveChart)){console.log("[JadwalKegiatanApp] Kurva-S chart initialized");const t=this._activateDefaultCostView();t&&"function"==typeof t.catch&&t.catch(t=>{console.warn("[JadwalKegiatanApp] Failed to auto-enable cost view:",t)})}}catch(e){console.warn("[JadwalKegiatanApp] Failed to initialize Kurva-S chart:",e)}console.log("[JadwalKegiatanApp] ‚ö†Ô∏è OLD Gantt Chart initialization SKIPPED (replaced by new design)")}_initializeRedesignedGantt(t=0){return o(this,null,function*(){if(this.state.useUnifiedTable&&!1===this.state.keepLegacyGantt){console.log("[JadwalKegiatanApp] Unified mode active - rendering Gantt via unified table overlay");const t=document.getElementById("gantt-redesign-container");return t?void(yield this._initializeUnifiedGanttOverlay(t)):void console.warn("[JadwalKegiatanApp] Gantt container not found for unified overlay")}if(this.ganttFrozenGrid)return void console.log("[JadwalKegiatanApp] Gantt already initialized, skipping");0===t&&(yield new Promise(t=>setTimeout(t,100)));const e=document.getElementById("gantt-redesign-container");if(!e)return console.warn(`[JadwalKegiatanApp] ‚è≥ Gantt container not found (attempt ${t+1}/3)`),t<3?(console.log("[JadwalKegiatanApp] Retrying in 200ms..."),yield new Promise(t=>setTimeout(t,200)),this._initializeRedesignedGantt(t+1)):(console.error("[JadwalKegiatanApp] ‚ùå Gantt container not found after retries"),console.error("[JadwalKegiatanApp] DOM state:",{ganttView:document.getElementById("gantt-view"),ganttTab:document.getElementById("gantt-tab")}),void p.error("Failed to find Gantt container"));try{console.log("üöÄ Initializing Gantt V2 (Frozen Column)..."),yield this._initializeFrozenGantt(e)}catch(a){throw console.error("[JadwalKegiatanApp] ‚ùå Failed to initialize Gantt:",a),console.error("[JadwalKegiatanApp] Error stack:",a.stack),p.error("Failed to load Gantt Chart"),a}})}_initializeFrozenGantt(t){return o(this,null,function*(){console.log("[JadwalKegiatanApp] ‚úÖ Container found:",t);const{GanttFrozenGrid:e}=yield r(()=>o(this,null,function*(){const{GanttFrozenGrid:t}=yield import("./gantt-frozen-grid-QMnIxjuC.js");return{GanttFrozenGrid:t}}),__vite__mapDeps([2,0,1]));this.ganttFrozenGrid=new e(t,{rowHeight:40,timeScale:"week"}),yield this.ganttFrozenGrid.initialize(this),console.log("[JadwalKegiatanApp] ‚úÖ Gantt V2 (Frozen Column) initialized successfully!"),p.success("üìä Gantt Chart loaded",2e3)})}_initializeUnifiedGanttOverlay(t){return o(this,null,function*(){let e=t.querySelector(".unified-gantt-host");e||(e=document.createElement("div"),e.className="unified-gantt-host",e.style.position="relative",e.style.minHeight="420px",e.style.width="100%",t.innerHTML="",t.appendChild(e)),this.unifiedGanttManager||(this.unifiedGanttManager=new w(this.state,{showToast:this.showToast.bind(this),onCellChange:t=>this._handleGridCellChange(t),getCellValidationState:t=>this._getCellValidationState(t)}),this.unifiedGanttManager.mount(e,{}));const a={tree:this.state.pekerjaanTree||[],timeColumns:this._getDisplayTimeColumns(),inputMode:this.state.inputMode||"percentage",timeScale:this.state.displayScale||this.state.timeScale||"weekly",dependencies:this.state.dependencies||[]};this.unifiedGanttManager.updateData(a),this.unifiedGanttManager.switchMode("gantt")})}_prepareGanttData(){var t;const e=[];if((null==(t=this.state)?void 0:t.flatPekerjaan)&&Array.isArray(this.state.flatPekerjaan)){const t=this.state.flatPekerjaan.filter(t=>"pekerjaan"===t.type);console.log(`[JadwalKegiatanApp] Transforming ${t.length} pekerjaan nodes for Gantt (filtered from ${this.state.flatPekerjaan.length} total nodes)`),t.length>0&&console.log("[JadwalKegiatanApp] Sample pekerjaan node:",t[0]),t.forEach(t=>{let a=0,s=0;if(this.stateManager){const e=this.state.tahapanList||[],i=e.length;if(i>0){let n=0,o=0;e.forEach(e=>{const a=this.stateManager.getCellValue(t.id,e.column_id,"planned"),s=this.stateManager.getCellValue(t.id,e.column_id,"actual");n+=a||0,o+=s||0}),a=Math.round(n/i),s=Math.round(o/i)}}e.push({klasifikasi_id:t.klasifikasi_id,klasifikasi_name:t.klasifikasi_name||"Unknown Klasifikasi",klasifikasi_kode:t.klasifikasi_kode||"",sub_klasifikasi_id:t.sub_klasifikasi_id,sub_klasifikasi_name:t.sub_klasifikasi_name||"Unknown Sub-Klasifikasi",sub_klasifikasi_kode:t.sub_klasifikasi_kode||"",pekerjaan_id:t.id,pekerjaan_name:t.nama||t.name||"Unknown Pekerjaan",pekerjaan_kode:t.kode||"",tgl_mulai_rencana:t.tgl_mulai_rencana||this.state.projectStart,tgl_selesai_rencana:t.tgl_selesai_rencana||this.state.projectEnd,tgl_mulai_realisasi:t.tgl_mulai_realisasi||this.state.projectStart,tgl_selesai_realisasi:t.tgl_selesai_realisasi||this.state.projectEnd,progress_rencana:a,progress_realisasi:s,volume:t.volume||0,satuan:t.satuan||""})})}else console.warn("[JadwalKegiatanApp] No flatPekerjaan data available for Gantt");const a={project_id:this.state.projectId,project_name:this.state.projectName||"Project",start_date:this.state.projectStart,end_date:this.state.projectEnd};return console.log(`[JadwalKegiatanApp] Prepared ${e.length} nodes for Gantt Chart`),{data:e,project:a,milestones:[]}}_initializeCharts(){this._setupLazyChartLoading(),this._bindUnifiedTabSync()}_setupLazyChartLoading(){const t=document.querySelector("#scurve-tab")||document.querySelector('[data-bs-target="#scurve-view"]'),e=document.querySelector("#gantt-tab")||document.querySelector('[data-bs-target="#gantt-view"]');console.log("[LazyLoad] Found tabs:",{scurveTab:t,ganttTab:e}),t&&(t.addEventListener("shown.bs.tab",()=>o(this,null,function*(){console.log("[LazyLoad] Kurva S tab shown"),this.state.useUnifiedTable&&this.unifiedManager&&this.unifiedManager.switchMode("kurva"),this._chartModulesLoaded||(yield this._loadChartModules())}),{once:!0}),t.addEventListener("click",()=>o(this,null,function*(){console.log("[LazyLoad] Kurva S tab clicked"),this.state.useUnifiedTable&&this.unifiedManager&&this.unifiedManager.switchMode("kurva"),this._chartModulesLoaded||this._chartModulesLoading||(yield this._loadChartModules())}),{once:!0})),e&&(e.addEventListener("shown.bs.tab",()=>o(this,null,function*(){console.log("[LazyLoad] üéØ Gantt tab shown - initializing NEW Gantt Chart!"),this._chartModulesLoaded||(yield this._loadChartModules()),yield this._initializeRedesignedGantt()}),{once:!0}),e.addEventListener("click",()=>o(this,null,function*(){console.log("[LazyLoad] üéØ Gantt tab clicked"),this._chartModulesLoaded||this._chartModulesLoading||(yield this._loadChartModules())}),{once:!0})),console.log("üìä Chart lazy loading configured (with NEW Gantt initialization)")}_updateCharts(){if(console.log("[JadwalKegiatanApp] Updating charts..."),this.kurvaSChart)try{this.kurvaSChart.update(),console.log("[JadwalKegiatanApp] ‚úÖ Kurva-S chart updated")}catch(t){console.warn("[JadwalKegiatanApp] Failed to update Kurva-S chart:",t)}if(this.ganttFrozenGrid&&"function"==typeof this.ganttFrozenGrid.update)try{this.ganttFrozenGrid.update(),console.log("[JadwalKegiatanApp] ‚úÖ Gantt V2 chart updated")}catch(t){console.warn("[JadwalKegiatanApp] Failed to update Gantt V2 chart:",t)}}_renderGanttSummary(){console.log("[JadwalKegiatanApp] ‚ö†Ô∏è _renderGanttSummary() SKIPPED (old Gantt method)")}_renderGanttTree(){console.log("[JadwalKegiatanApp] ‚ö†Ô∏è _renderGanttTree() SKIPPED (old Gantt method)")}_attachGanttScrollSync(){var t,e,a;const s=null==(t=this.state.domRefs)?void 0:t.ganttTreeScroll,i=null==(e=this.state.domRefs)?void 0:e.ganttChartWrapper;if(!s||!i)return;const n=i.querySelector(".gantt-container");if(!n)return;if((null==(a=this._ganttScrollSyncHandlers)?void 0:a.scrollEl)&&this._ganttScrollSyncHandlers.scrollEl!==n&&(this._ganttScrollSyncHandlers.scrollEl.removeEventListener("scroll",this._ganttScrollSyncHandlers.scrollHandler),s.removeEventListener("wheel",this._ganttScrollSyncHandlers.wheelHandler),this._ganttScrollSyncHandlers=null),this._ganttScrollSyncHandlers)return void(s.scrollTop=n.scrollTop);const o=()=>{s.scrollTop=n.scrollTop},r=t=>{0!==t.deltaY&&(n.scrollTop+=t.deltaY)};n.addEventListener("scroll",o),s.addEventListener("wheel",r,{passive:!0}),this._ganttScrollSyncHandlers={scrollEl:n,scrollHandler:o,wheelHandler:r}}_escapeHtml(t){return null==t?"":String(t).replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]||t))}saveChanges(){return o(this,null,function*(){if(!this.saveHandler)return console.error("[JadwalKegiatanApp] SaveHandler not initialized"),void p.error("Save handler not initialized");if(!this._validateRowTotalsBeforeSave())return void p.warning("Please fix validation errors before saving");const t=this.state.domRefs.saveButton;t&&f.setLoading(t,"Saving...");try{const e=yield this.saveHandler.save();e.success?(this._renderGrid(),this._recalculateAllProgressTotals(),t&&f.setSuccess(t,2e3),p.success("Changes saved successfully!")):(t&&f.setError(t,2e3),p.error(e.message||"Failed to save changes"))}catch(e){console.error("[JadwalKegiatanApp] Save error:",e),t&&f.setError(t,2e3),p.error("An error occurred while saving")}})}_onSaveSuccess(t){console.log("[JadwalKegiatanApp] Save completed successfully"),this.state.isDirty=!1,this._clearSaveErrorRows();const e="actual"===(this.state.progressMode||"planned").toLowerCase()?"Perubahan realisasi tersimpan":"Perubahan perencanaan tersimpan";this._updateStatusBar(e),this._clearApiFailedRows(),this._renderGrid(),this._recalculateAllProgressTotals(),this._updateCharts()}_onSaveError(t){console.error("[JadwalKegiatanApp] Save failed:",t),this._markFailedRowsFromError(t)}refresh(){return o(this,null,function*(){if(this.state.isDirty){if(!confirm("Ada perubahan yang belum disimpan. Yakin ingin refresh?"))return}console.log("Refreshing data..."),this._resetEditedCellsState(),this.state.isDirty=!1,yield this._loadInitialData({forceReload:!0}),this.showToast("Data berhasil di-refresh","success")})}showToast(t,e="info",a=3e3){if("function"==typeof window.showToast)return void window.showToast(t,e,a);console.log(`[${e.toUpperCase()}] ${t}`);const s=document.createElement("div");s.className=`toast toast-${e}`,s.textContent=t,document.body.appendChild(s),setTimeout(()=>{s.classList.add("show")},10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},a)}_buildTimeColumns(t=[]){return Array.isArray(t)?t.map((t,e)=>{var a;const s=null!=(a=null==t?void 0:t.id)?a:`tahapan-${e+1}`,i=`col_${String(s).replace(/[^a-zA-Z0-9_-]/g,"_")}`,n=(null==t?void 0:t.nama)||(null==t?void 0:t.name)||`Tahapan ${e+1}`,o="number"==typeof(null==t?void 0:t.urutan)?t.urutan:Number.parseInt(null==t?void 0:t.urutan,10)||e;return{id:s,fieldId:i,label:n,order:o,weekNumber:o+1,startDate:(null==t?void 0:t.tanggal_mulai)||(null==t?void 0:t.start_date)||(null==t?void 0:t.startDate)||null,endDate:(null==t?void 0:t.tanggal_selesai)||(null==t?void 0:t.end_date)||(null==t?void 0:t.endDate)||null,isAutoGenerated:Boolean(null==t?void 0:t.is_auto_generated),generationMode:(null==t?void 0:t.generation_mode)||null}}):[]}_createTimeColumnIndex(t=[]){const e={};return(t||[]).forEach(t=>{const a=t.fieldId||t.id;a&&(e[a]=t)}),e}_getDefaultSaveEndpoint(){var t;const e=null==(t=this.state)?void 0:t.projectId;return e?`/detail_project/api/v2/project/${e}/assign-weekly/`:""}_fetchJson(t){return o(this,arguments,function*(t,e={}){if(!t)throw new Error("URL tidak boleh kosong saat memanggil _fetchJson");const a=yield fetch(t,n({credentials:"same-origin"},e));if(!a.ok){const t=yield a.text().catch(()=>"");throw new Error(t||`HTTP ${a.status}: ${a.statusText}`)}return a.json()})}_syncGridViews(){const t=this._getDisplayTimeColumns();this.state.activeTimeColumns=t,this.state.dependencies=this.state.dependencies||[];const e={tree:this.state.pekerjaanTree||[],timeColumns:t,inputMode:this.state.inputMode||"percentage",timeScale:this.state.displayScale||this.state.timeScale||"weekly",dependencies:this.state.dependencies||[]};this.state.useUnifiedTable&&this.unifiedManager?(this.unifiedManager.updateData(e),this.unifiedGanttManager&&this.unifiedGanttManager.updateData(e)):this.gridManager&&(this.gridManager.updateData(e),"function"==typeof this.gridManager.updateTopScrollMetrics&&this.gridManager.updateTopScrollMetrics()),this._updateStatusBar()}_renderGrid(){this.gridManager?this._syncGridViews():"function"==typeof this._renderLegacyGrid&&this._renderLegacyGrid()}_clearApiFailedRows(){this.state.apiFailedRows instanceof Set&&this.state.apiFailedRows.size>0&&(this.state.apiFailedRows.clear(),this._refreshFailedRowsUnion())}_markFailedRowsFromIds(t){t instanceof Set&&0!==t.size?(this.state.apiFailedRows=new Set(Array.from(t)),this._refreshFailedRowsUnion()):this._clearApiFailedRows()}_setSaveErrorRows(t){this.state.saveErrorRows instanceof Set||(this.state.saveErrorRows=new Set);const e=t instanceof Set?Array.from(t):[];this.state.saveErrorRows=new Set(e.map(t=>Number(t))),this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles()}_clearSaveErrorRows(){this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.size>0&&(this.state.saveErrorRows.clear(),this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles())}_clearSaveErrorForRow(t){if(!(t&&this.state.saveErrorRows instanceof Set&&0!==this.state.saveErrorRows.size))return;this.state.saveErrorRows.delete(Number(t))&&this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles()}_markFailedRowsFromError(t){const e=this._extractPekerjaanIdsFromError(t);this._markFailedRowsFromIds(e)}_extractPekerjaanIdsFromError(t){const e=new Set,a=(t=[])=>{t.forEach(t=>{var a,s;const i=(null==t?void 0:t.pekerjaan_id)||(null==t?void 0:t.pekerjaanId)||(null==(a=null==t?void 0:t.item)?void 0:a.pekerjaan_id)||(null==(s=null==t?void 0:t.item)?void 0:s.pekerjaanId)||null;i&&e.add(Number(i))})};return Array.isArray(null==t?void 0:t.validationErrors)&&a(t.validationErrors),Array.isArray(null==t?void 0:t.details)&&a(t.details),e}_getContainerValue(t,e){return t&&e?t instanceof Map?t.has(e)?t.get(e):null:"object"==typeof t&&Object.prototype.hasOwnProperty.call(t,e)?t[e]:null:null}_calculateRowTotalPercent(t){if(!t)return 0;const e=this.state.timeColumns||[],a=this.state.modifiedCells instanceof Map?this.state.modifiedCells:null,s=this.state.assignmentMap;let i=0;return e.forEach(e=>{const n=e.fieldId||e.id;if(!n)return;const o=`${t}-${n}`;let r=null;r=a&&a.has(o)?a.get(o):this._getContainerValue(s,o);const l=Number(r);Number.isFinite(l)&&(i+=l)}),Number(i.toFixed(2))}_calculateRowTotalVolume(t){if(!t)return 0;const e=this._getRowVolume(t),a=Array.isArray(this.state.timeColumns)?this.state.timeColumns:[],s=this.state.modifiedCells instanceof Map?this.state.modifiedCells:null,i=this.state.assignmentMap,n=this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides:null;let o=0;return a.forEach(a=>{const r=a.fieldId||a.id;if(!r)return;const l=`${t}-${r}`;let d=null;if(n&&n.has(l)){const t=Number(n.get(l));Number.isFinite(t)&&(d=t)}if(null===d){let t=null;s&&s.has(l)?t=Number(s.get(l)):i&&(t=Number(this._getContainerValue(i,l))),Number.isFinite(t)&&Number.isFinite(e)&&e>0&&(d=t/100*e)}Number.isFinite(d)&&(o+=d)}),Number(o.toFixed(3))}_setCellVolumeOverride(t,e){if(!t)return;this.state.cellVolumeOverrides instanceof Map||(this.state.cellVolumeOverrides=new Map);const a=Number(e);Number.isFinite(a)?this.state.cellVolumeOverrides.set(t,Number(a.toFixed(3))):this.state.cellVolumeOverrides.has(t)&&this.state.cellVolumeOverrides.delete(t)}_clearCellVolumeOverride(t){t&&this.state.cellVolumeOverrides instanceof Map&&0!==this.state.cellVolumeOverrides.size&&this.state.cellVolumeOverrides.delete(t)}_updateCellValidationState(t,e){if(!t)return;this.state.cellValidationMap instanceof Map||(this.state.cellValidationMap=new Map);const a=this.state.cellValidationMap.get(t)||null,s=e&&!1===e.isValid?"warning"===e.level?"warning":"error":null;let i=!1;s?a!==s&&(this.state.cellValidationMap.set(t,s),i=!0):a&&(this.state.cellValidationMap.delete(t),i=!0),i&&this.gridManager&&"function"==typeof this.gridManager.refreshCells&&this.gridManager.refreshCells()}_getCellValidationState(t){return t&&this.state.cellValidationMap instanceof Map&&this.state.cellValidationMap.get(t)||null}_updateProgressTotals(t){if(!t)return 0;this.state.progressTotals instanceof Map||(this.state.progressTotals=new Map);const e=this._calculateRowTotalPercent(t);return this.state.progressTotals.set(Number(t),e),this._updateAutoWarningRows(Number(t),e),this._updateCompletionWarningRows(Number(t),e),this._updateStatusBar(),e}_updateVolumeTotals(t,e=null,a={}){if(!t)return;this.state.volumeTotals instanceof Map||(this.state.volumeTotals=new Map);const s=this._calculateRowTotalVolume(t);this.state.volumeTotals.set(Number(t),s);const i=Number.isFinite(e)&&null!==e?Number(e):this.state.progressTotals instanceof Map?this.state.progressTotals.get(Number(t)):null,n=this._getRowVolume(t),o=!Number.isFinite(i)&&Number.isFinite(s)&&Number.isFinite(n)&&n>0?s/n*100:i;this._updateVolumeWarningRows(Number(t),s,{percentTotal:o,deferRefresh:a.deferRefresh})}_recalculateAllProgressTotals(){this.state.progressTotals instanceof Map?this.state.progressTotals.clear():this.state.progressTotals=new Map,this.state.volumeTotals instanceof Map?this.state.volumeTotals.clear():this.state.volumeTotals=new Map,this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides.clear():this.state.cellVolumeOverrides=new Map,this.state.autoWarningRows=new Set,this.state.volumeWarningRows=new Set,this.state.validationWarningRows=new Set,this.state.saveErrorRows=new Set;(Array.isArray(this.state.flatPekerjaan)?this.state.flatPekerjaan.filter(t=>"pekerjaan"===(null==t?void 0:t.type)&&t.id):[]).forEach(t=>{const e=this._calculateRowTotalPercent(t.id);this.state.progressTotals.set(Number(t.id),e),this._updateAutoWarningRows(Number(t.id),e,{deferRefresh:!0}),this._updateCompletionWarningRows(Number(t.id),e,{deferRefresh:!0}),this._updateVolumeTotals(Number(t.id),e,{deferRefresh:!0})}),this._refreshFailedRowsUnion(),this.state.showCompletionWarnings&&this.gridManager&&this.gridManager.refreshRowStyles(),this._updateStatusBar()}_refreshFailedRowsUnion(){const t=new Set;this.state.autoWarningRows instanceof Set&&this.state.autoWarningRows.forEach(e=>t.add(Number(e))),this.state.volumeWarningRows instanceof Set&&this.state.volumeWarningRows.forEach(e=>t.add(Number(e))),this.state.apiFailedRows instanceof Set&&this.state.apiFailedRows.forEach(e=>t.add(Number(e))),this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.forEach(e=>t.add(Number(e))),this.state.failedRows=t,this._updateSaveButtonState(),this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles()}_updateAutoWarningRows(t,e,a={}){if(!t)return;this.state.autoWarningRows instanceof Set||(this.state.autoWarningRows=new Set);let s=!1;e>100.01?this.state.autoWarningRows.has(t)||(this.state.autoWarningRows.add(t),s=!0):this.state.autoWarningRows.has(t)&&(this.state.autoWarningRows.delete(t),s=!0),s&&!a.deferRefresh&&this._refreshFailedRowsUnion()}_updateCompletionWarningRows(t,e,a={}){if(!t)return;this.state.validationWarningRows instanceof Set||(this.state.validationWarningRows=new Set);let s=!1;this.state.showCompletionWarnings&&Number.isFinite(e)&&e>.01&&e<99.99?this.state.validationWarningRows.has(t)||(this.state.validationWarningRows.add(t),s=!0):this.state.validationWarningRows.has(t)&&(this.state.validationWarningRows.delete(t),s=!0),s&&!a.deferRefresh&&this.gridManager&&this.gridManager.refreshRowStyles()}_recomputeCompletionWarnings(){this.state.validationWarningRows instanceof Set?this.state.validationWarningRows.clear():this.state.validationWarningRows=new Set,this.state.progressTotals instanceof Map?(this.state.progressTotals.forEach((t,e)=>{this._updateCompletionWarningRows(Number(e),t,{deferRefresh:!0})}),this.gridManager&&this.gridManager.refreshRowStyles()):this.gridManager&&this.gridManager.refreshRowStyles()}_updateVolumeWarningRows(t,e,a={}){if(!t)return;this.state.volumeWarningRows instanceof Set||(this.state.volumeWarningRows=new Set);const s=this._getRowVolume(t),i=a&&Number.isFinite(a.percentTotal)?Number(a.percentTotal):this.state.progressTotals instanceof Map?this.state.progressTotals.get(Number(t)):null,n=Number.isFinite(s)&&s>0?Math.max(.001*s,.01):.01;let o=!1;Number.isFinite(s)&&s>0?o=Number.isFinite(e)&&e>s+n:Number.isFinite(i)&&(o=i>n);let r=!1;o?this.state.volumeWarningRows.has(t)||(this.state.volumeWarningRows.add(t),r=!0):this.state.volumeWarningRows.has(t)&&(this.state.volumeWarningRows.delete(t),r=!0),r&&!a.deferRefresh&&this._refreshFailedRowsUnion()}_clearFailedRows(){this.state.autoWarningRows instanceof Set&&this.state.autoWarningRows.clear(),this.state.volumeWarningRows instanceof Set&&this.state.volumeWarningRows.clear(),this.state.failedRows instanceof Set&&this.state.failedRows.clear(),this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.clear(),this._refreshFailedRowsUnion()}_getRowVolume(t){var e;const a=null==(e=this.state)?void 0:e.volumeMap,s=Number(t);if(a instanceof Map&&a.has(s))return Number(a.get(s))||0;if(a&&"object"==typeof a){const t=String(s);if(Object.prototype.hasOwnProperty.call(a,t))return Number(a[t])||0}const i=Array.isArray(this.state.flatPekerjaan)&&this.state.flatPekerjaan.find(t=>Number(t.id)===s);return i&&void 0!==i.volume&&Number(i.volume)||0}_getRowCostCapacity(t){var e;const a=null==(e=this.state)?void 0:e.hargaMap,s=Number(t);if(a instanceof Map&&a.has(s))return Number(a.get(s))||0;if(a&&"object"==typeof a){const t=String(s);if(Object.prototype.hasOwnProperty.call(a,t))return Number(a[t])||0}const i=Array.isArray(this.state.flatPekerjaan)&&this.state.flatPekerjaan.find(t=>Number(t.id)===s);if(i){const t=["budgeted_cost","total_biaya","totalBiaya","total_cost","biaya"];for(const e of t)if(void 0!==i[e]){const t=Number(i[e]);if(Number.isFinite(t))return t}}return 0}_getMergedCostCells(t){const e=new Map;return(null==t?void 0:t.costAssignmentMap)instanceof Map&&t.costAssignmentMap.forEach((t,a)=>{const s=Number(t);Number.isFinite(s)&&e.set(a,s)}),(null==t?void 0:t.costModifiedCells)instanceof Map&&t.costModifiedCells.forEach((t,a)=>{const s=Number(t);Number.isFinite(s)&&e.set(a,s)}),e}_calculateAllCostTotals(){const t=new Map,e=this._getCurrentModeState();if(!e)return t;return this._getMergedCostCells(e).forEach((e,a)=>{const s=parseInt((a||"").split("-")[0],10);Number.isFinite(s)&&t.set(s,(t.get(s)||0)+Number(e))}),t}_formatCurrency(t){const e=Number(t)||0;return this._currencyFormatter||"undefined"==typeof Intl||(this._currencyFormatter=new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0})),this._currencyFormatter?this._currencyFormatter.format(e):`Rp ${e.toLocaleString("id-ID")}`}_validateRowTotalsBeforeSave(){if(!(this.state.progressTotals instanceof Map))return!0;this.state.showCompletionWarnings||(this.state.showCompletionWarnings=!0),this._recomputeCompletionWarnings();const t=[];this.state.progressTotals.forEach((e,a)=>{Number.isFinite(e)&&e>100.01&&t.push({type:"percent",pekerjaan_id:a,total:e})});const e=[];this.state.volumeTotals instanceof Map&&this.state.volumeTotals.forEach((t,a)=>{const s=this._getRowVolume(a),i=Number.isFinite(s)&&s>0?Math.max(.001*s,.01):.01,n=this.state.progressTotals instanceof Map&&this.state.progressTotals.has(a)?this.state.progressTotals.get(a):null,o=Number.isFinite(n)&&null!==n?Number(n):Number.isFinite(t)&&Number.isFinite(s)&&s>0?Number(t)/Number(s)*100:null;Number.isFinite(s)&&s>0?Number.isFinite(t)&&t>s+i&&e.push({type:"volume",pekerjaan_id:a,total:t,capacity:s}):Number.isFinite(o)&&o>i&&e.push({type:"volume",pekerjaan_id:a,total:t,capacity:s||0,missingCapacity:!0})});const a=[];if("actual"===(this.state.progressMode||"planned").toLowerCase()){this._calculateAllCostTotals().forEach((t,e)=>{if(!Number.isFinite(t))return;const s=this._getRowCostCapacity(e),i=Number.isFinite(s)&&s>0?Math.max(.001*s,1):1;Number.isFinite(s)&&s>0?t>s+i&&a.push({type:"cost",pekerjaan_id:e,total:t,capacity:s}):t>i&&a.push({type:"cost",pekerjaan_id:e,total:t,capacity:0,missingCapacity:!0})})}if(0===t.length&&0===e.length&&0===a.length)return this._clearFailedRows(),this._clearSaveErrorRows(),!0;const s=new Set,i=t.concat(e,a),n=i.slice(0,3).map(t=>(s.add(Number(t.pekerjaan_id)),"volume"===t.type?t.missingCapacity?`- Pekerjaan ${t.pekerjaan_id}: volume tidak dapat disimpan karena master volume 0`:`- Pekerjaan ${t.pekerjaan_id}: total volume ${t.total.toFixed(3)} > kapasitas ${t.capacity.toFixed(3)}`:"cost"===t.type?t.missingCapacity?`- Pekerjaan ${t.pekerjaan_id}: biaya aktual tidak dapat disimpan karena master biaya 0`:`- Pekerjaan ${t.pekerjaan_id}: total biaya ${this._formatCurrency(t.total)} > batas ${this._formatCurrency(t.capacity)}`:`- Pekerjaan ${t.pekerjaan_id}: total ${t.total.toFixed(2)}% > 100%`));return i.length>3&&n.push(`(+${i.length-3} lagi)`),this._markFailedRowsFromIds(s),this._setSaveErrorRows(s),this.showToast(`Tidak dapat menyimpan:\n${n.join("\n")}`,"danger",5e3),!1}_updateStatusBar(t="Ready"){var e,a,s;const i=(null==(e=this.state)?void 0:e.domRefs)||{};if(i.statusMessageEl||i.itemCountEl||i.modifiedCountEl||i.totalProgressEl){if(i.statusMessageEl&&"string"==typeof t&&(i.statusMessageEl.textContent=t),i.itemCountEl){const t=Array.isArray(null==(a=this.state)?void 0:a.flatPekerjaan)?this.state.flatPekerjaan.filter(t=>"pekerjaan"===(null==t?void 0:t.type)).length:0;i.itemCountEl.textContent=t.toLocaleString("id-ID")}if(i.modifiedCountEl){const t=(null==(s=this.state)?void 0:s.modifiedCells)instanceof Map?this.state.modifiedCells.size:0;i.modifiedCountEl.textContent=t.toLocaleString("id-ID")}if(i.totalProgressEl){const t=this._calculateProjectProgress();i.totalProgressEl.textContent=null===t?"-":`${t.toLocaleString("id-ID",{maximumFractionDigits:1})}%`}}}_calculateProjectProgress(){var t,e;if((null==(t=this.state)?void 0:t.progressTotals)instanceof Map&&this.state.progressTotals.size>0){let t=0;this.state.progressTotals.forEach(e=>{t+=Number(e)||0});const e=t/this.state.progressTotals.size;return Math.round(10*e)/10}if((null==(e=this.state)?void 0:e.assignmentMap)instanceof Map&&this.state.assignmentMap.size>0){const t=new Map;if(this.state.assignmentMap.forEach((e,a)=>{const[s]=`${a}`.split("-"),i=Number(e)||0,n=t.get(s)||0;t.set(s,n+i)}),t.size>0){let e=0;t.forEach(t=>{e+=t});const a=e/t.size;return Math.round(10*a)/10}}return null}_buildAssignmentsPayload(){if(!this.state.modifiedCells||0===this.state.modifiedCells.size)return[];const t=[],e=this.state.timeColumnIndex||{};return this.state.modifiedCells.forEach((a,s)=>{const i=this._parseCellKey(s);if(!(null==i?void 0:i.pekerjaanId)||!i.fieldId)return;const n=e[i.fieldId];if(!n)return void console.warn("[JadwalKegiatanApp] Column metadata not found for",i.fieldId);const o=parseFloat(a);if(Number.isNaN(o))return;const r=n.weekNumber||n.order+1||1;t.push({pekerjaan_id:Number(i.pekerjaanId),week_number:r,proportion:Number(o.toFixed(2)),tahapan_id:n.id||null})}),t}_getSaveMode(){var t;const e=((null==(t=this.state)?void 0:t.saveMode)||"weekly").toLowerCase();return new Set(["daily","weekly","monthly","custom"]).has(e)?e:"weekly"}_normalizePythonWeekday(t,e=0){const a=Number.isFinite(e)?(e%7+7)%7:0,s=Number(t);if(!Number.isFinite(s))return a;const i=s%7;return i<0?i+7:i}_getWeekStartDay(){var t;return Number.isFinite(Number(null==(t=this.state)?void 0:t.weekStartDay))?this._normalizePythonWeekday(this.state.weekStartDay,(this._getWeekEndDay()+1)%7):(this._getWeekEndDay()+1)%7}_getWeekEndDay(){var t;return this._normalizePythonWeekday(null==(t=this.state)?void 0:t.weekEndDay,6)}_getDisplayTimeColumns(){const t=Array.isArray(this.state.timeColumns)?this.state.timeColumns:[];if("monthly"!==(this.state.displayScale||this.state.timeScale||"weekly").toLowerCase())return t;const e=t.filter(t=>(t=>{var e;const a=(t.generationMode||t.type||"").toLowerCase();if("monthly"===a)return!1;if("weekly"===a||"week"===a||"wk"===a)return!0;if(Number.isFinite(Number(null!=(e=t.weekNumber)?e:t.week_number)))return!0;const s=(t.label||"").toLowerCase();return s.includes("week")||s.includes("minggu")})(t)),a=e.length>0?e:t;return this._buildMonthlyColumns(a)}_buildMonthlyColumns(t){var e,a,s,i,n,o,r,l,d,h,c,u,g,p;const m=[];for(let f=0;f<t.length;f+=4){const y=t.slice(f,f+4);if(!y.length)continue;const w=m.length,v=null!=(i=null!=(s=null==(e=y[0])?void 0:e.weekNumber)?s:null==(a=y[0])?void 0:a.order)?i:f+1,_=null!=(o=null==(n=y[y.length-1])?void 0:n.weekNumber)?o:v+y.length-1,b=(null==(r=y[0])?void 0:r.rangeLabel)||(null==(l=y[0])?void 0:l.label)||"",k=(null==(d=y[y.length-1])?void 0:d.rangeLabel)||(null==(h=y[y.length-1])?void 0:h.label)||"",S=`Month ${w+1}`,M=`Week ${v}-${_}`,C=this._coerceDate((null==(c=y[0])?void 0:c.startDate)||(null==(u=y[0])?void 0:u.start_date)),E=this._coerceDate((null==(g=y[y.length-1])?void 0:g.endDate)||(null==(p=y[y.length-1])?void 0:p.end_date)),T=this._formatShortRange(C,E);m.push({id:`month-${w+1}`,fieldId:`month_${w+1}`,label:S,rangeLabel:T||M,rangeText:T,startDate:C,endDate:E,tooltip:b&&k?`${b} ‚Äî ${k}`:`${S}: Week ${v}-${_}`,generationMode:"monthly",type:"monthly",index:w,childColumns:y,readOnly:!0})}return m}_coerceDate(t){if(!t)return null;if(t instanceof Date)return Number.isNaN(t.getTime())?null:t;const e=new Date(t);return Number.isNaN(e.getTime())?null:e}_formatShortRange(t,e){const a=t=>{if(!(t instanceof Date)||Number.isNaN(t.getTime()))return"";return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}`},s=a(t),i=a(e);return s&&i?`${s} - ${i}`:s||i||""}_parseCellKey(t){if(!t||"string"!=typeof t)return null;const e=t.indexOf("-");return-1===e?{pekerjaanId:t,fieldId:null}:{pekerjaanId:t.slice(0,e),fieldId:t.slice(e+1)}}_getCsrfToken(){const t="csrftoken";let e=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let s=0;s<a.length;s++){const i=a[s].trim();if(i.substring(0,10)===t+"="){e=decodeURIComponent(i.substring(10));break}}}return e}_handleGridCellChange({cellKey:t,value:e,columnMeta:a,displayValue:s,isVolumeMode:i,validation:n,pekerjaanId:o,columnId:r,valueType:l="percentage"}){if(!t)return;n&&this._updateCellValidationState(t,n);let d=e;"string"==typeof d&&(d=parseFloat(d)),Number.isNaN(d)&&(d=0);const h=this._getCurrentModeState(),c=this.state.progressMode||"planned",u="cost"===(l||(i?"volume":"percentage")).toLowerCase();if(console.log(`[CellChange] Mode: ${c.toUpperCase()}, Cell: ${t}, Value: ${d}`),u){if("actual"!==c)return void this.showToast("Biaya aktual hanya bisa diedit pada mode Realisasi","warning",2600);h.costModifiedCells.set(t,d),h.isDirty=!0}else h.modifiedCells.set(t,d),h.isDirty=!0;(null==a?void 0:a.fieldId)&&this.state.timeColumnIndex&&(this.state.timeColumnIndex[a.fieldId]=a||this.state.timeColumnIndex[a.fieldId]),i?this._setCellVolumeOverride(t,s):this._clearCellVolumeOverride(t);const g=this._parseCellKey(t),p=o||(null==g?void 0:g.pekerjaanId);if(p){this._clearSaveErrorForRow(Number(p));const t=this._updateProgressTotals(Number(p));this._updateVolumeTotals(Number(p),t)}u?console.log(`[CellChange] Cost map size: ${h.costModifiedCells.size}`):(console.log(`[CellChange] ${c.toUpperCase()} modifiedCells size: ${h.modifiedCells.size}`),this._updateCharts(),console.log("[CellChange] Real-time Kurva-S chart updated"))}_bindUnifiedTabSync(){if(!this.state.useUnifiedTable)return;const t=document.querySelector("#scurve-tab")||document.querySelector('[data-bs-target="#scurve-view"]'),e=document.querySelector("#gantt-tab")||document.querySelector('[data-bs-target="#gantt-view"]');if(t){const e=()=>{this.unifiedManager&&this.unifiedManager.switchMode("kurva")};t.addEventListener("shown.bs.tab",e),t.addEventListener("click",e)}if(e){const t=()=>{this.unifiedManager&&this.unifiedManager.switchMode("gantt")};e.addEventListener("shown.bs.tab",t),e.addEventListener("click",t)}if(e){const t=()=>{this.unifiedGanttManager&&this.unifiedGanttManager.switchMode("gantt")};e.addEventListener("shown.bs.tab",t),e.addEventListener("click",t)}}destroy(){this._unbindStateManagerEvents(),this.gridManager&&(this.gridManager.destroy(),this.gridManager=null),this.unifiedManager=null,this.unifiedGanttManager=null,this.state=null,this.initialized=!1,console.log("JadwalKegiatanApp destroyed")}}if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{(new v).initialize()});else{(new v).initialize()}
//# sourceMappingURL=jadwal-kegiatan-BEma-Slv.js.map
