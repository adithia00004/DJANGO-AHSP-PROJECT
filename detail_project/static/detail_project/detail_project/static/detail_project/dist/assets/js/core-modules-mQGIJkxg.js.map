{"version":3,"file":"core-modules-mQGIJkxg.js","sources":["../../../../../../js/src/modules/core/mode-state.js","../../../../../../js/src/modules/core/state-manager.js","../../../../../../js/src/modules/core/time-column-generator.js","../../../../../../js/src/modules/core/data-loader.js","../../../../../../js/src/modules/core/save-handler.js"],"sourcesContent":["/**\n * ModeState - Holds state for a single progress mode (planned or actual)\n *\n * Phase 0.2: StateManager Architecture\n *\n * This class encapsulates all data for one mode:\n * - assignmentMap: Saved data from backend (Map<cellKey, value>)\n * - modifiedCells: Unsaved changes from user input (Map<cellKey, value>)\n * - isDirty: Flag indicating if cache needs invalidation\n *\n * @class ModeState\n */\nexport class ModeState {\n  /**\n   * Create a new ModeState\n   */\n  constructor() {\n    /**\n     * Saved assignment values from backend\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (percentage 0-100)\n     * @type {Map<string, number>}\n     */\n    this.assignmentMap = new Map();\n\n    /**\n     * Modified cell values (unsaved changes)\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (percentage 0-100)\n     * @type {Map<string, number>}\n     */\n    this.modifiedCells = new Map();\n\n    /**\n     * Saved actual cost values (only applicable for actual mode but shared API)\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (rupiah)\n     * @type {Map<string, number>}\n     */\n    this.costAssignmentMap = new Map();\n\n    /**\n     * Modified actual cost values waiting to be saved\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (rupiah)\n     * @type {Map<string, number>}\n     */\n    this.costModifiedCells = new Map();\n\n    /**\n     * Dirty flag for cache invalidation\n     * Set to true when modifiedCells changes\n     * @type {boolean}\n     */\n    this.isDirty = false;\n  }\n\n  /**\n   * Serialize state to JSON\n   * Useful for debugging and persistence\n   * @returns {Object}\n   */\n  toJSON() {\n    return {\n      assignmentMap: Array.from(this.assignmentMap.entries()),\n      modifiedCells: Array.from(this.modifiedCells.entries()),\n      costAssignmentMap: Array.from(this.costAssignmentMap.entries()),\n      costModifiedCells: Array.from(this.costModifiedCells.entries()),\n      isDirty: this.isDirty\n    };\n  }\n\n  /**\n   * Deserialize state from JSON\n   * @param {Object} data - Serialized state data\n   * @returns {ModeState}\n   */\n  static fromJSON(data) {\n    const state = new ModeState();\n\n    if (data.assignmentMap && Array.isArray(data.assignmentMap)) {\n      state.assignmentMap = new Map(data.assignmentMap);\n    }\n\n    if (data.modifiedCells && Array.isArray(data.modifiedCells)) {\n      state.modifiedCells = new Map(data.modifiedCells);\n    }\n\n    if (data.costAssignmentMap && Array.isArray(data.costAssignmentMap)) {\n      state.costAssignmentMap = new Map(data.costAssignmentMap);\n    }\n\n    if (data.costModifiedCells && Array.isArray(data.costModifiedCells)) {\n      state.costModifiedCells = new Map(data.costModifiedCells);\n    }\n\n    if (typeof data.isDirty === 'boolean') {\n      state.isDirty = data.isDirty;\n    }\n\n    return state;\n  }\n\n  /**\n   * Get statistics about this mode state\n   * @returns {Object}\n   */\n  getStats() {\n    return {\n      assignmentCount: this.assignmentMap.size,\n      modifiedCount: this.modifiedCells.size,\n      costAssignmentCount: this.costAssignmentMap.size,\n      costModifiedCount: this.costModifiedCells.size,\n      isDirty: this.isDirty,\n      hasUnsavedChanges: this.modifiedCells.size > 0 || this.costModifiedCells.size > 0\n    };\n  }\n\n  /**\n   * Clear all data from this mode state\n   */\n  clear() {\n    this.assignmentMap.clear();\n    this.modifiedCells.clear();\n    this.costAssignmentMap.clear();\n    this.costModifiedCells.clear();\n    this.isDirty = true;\n  }\n\n  /**\n   * Clone this mode state (deep copy)\n   * @returns {ModeState}\n   */\n  clone() {\n    const cloned = new ModeState();\n    cloned.assignmentMap = new Map(this.assignmentMap);\n    cloned.modifiedCells = new Map(this.modifiedCells);\n    cloned.costAssignmentMap = new Map(this.costAssignmentMap);\n    cloned.costModifiedCells = new Map(this.costModifiedCells);\n    cloned.isDirty = this.isDirty;\n    return cloned;\n  }\n}\n\nexport default ModeState;\n","/**\n * StateManager - Singleton for managing dual-mode progress state\n *\n * Phase 0.2: StateManager Architecture\n *\n * This class replaces the fragmented state management pattern with a single\n * source of truth. It manages both 'planned' and 'actual' progress states\n * and provides a clean API for reading/writing cell values.\n *\n * Key features:\n * - Singleton pattern (one instance per application)\n * - Dual state architecture (planned vs actual)\n * - Smart caching with automatic invalidation\n * - Event-driven updates (pub/sub pattern)\n * - Thread-safe state switching\n *\n * @class StateManager\n */\n\nimport { ModeState } from './mode-state.js';\n\nconst LOG_PREFIX = '[StateManager]';\n\nexport class StateManager {\n  /**\n   * Singleton instance\n   * @private\n   * @static\n   * @type {StateManager|null}\n   */\n  static instance = null;\n\n  /**\n   * Get singleton instance\n   * @returns {StateManager}\n   */\n  static getInstance() {\n    if (!StateManager.instance) {\n      StateManager.instance = new StateManager();\n      console.log(LOG_PREFIX, 'Singleton instance created');\n    }\n    return StateManager.instance;\n  }\n\n  /**\n   * Private constructor (use getInstance() instead)\n   * @private\n   */\n  constructor() {\n    if (StateManager.instance) {\n      throw new Error('StateManager is a singleton. Use StateManager.getInstance()');\n    }\n\n    /**\n     * Current progress mode ('planned' or 'actual')\n     * @type {string}\n     */\n    this.currentMode = 'planned';\n\n    /**\n     * Mode-specific state storage\n     * @type {Object}\n     */\n    this.states = {\n      planned: new ModeState(),\n      actual: new ModeState()\n    };\n\n    /**\n     * Merged cell values cache\n     * Key: \"cells:{mode}\"\n     * Value: Map<cellKey, number>\n     * @private\n     * @type {Map<string, Map<string, number>>}\n     */\n    this._mergedCellsCache = new Map();\n\n    /**\n     * Event listeners for state changes\n     * @private\n     * @type {Set<Function>}\n     */\n    this._listeners = new Set();\n\n    /**\n     * Single source of truth: Flat list of all pekerjaan rows\n     * @type {Array<Object>}\n     */\n    this.flatPekerjaan = [];\n\n    /**\n     * Single source of truth: Time columns configuration\n     * @type {Array<Object>}\n     */\n    this.timeColumns = [];\n\n    /**\n     * Chart data cache (from SSoT API)\n     * Key: \"{timescale}:{mode}\" e.g. \"weekly:both\"\n     * @type {Map<string, Object>}\n     * @private\n     */\n    this._chartDataCache = new Map();\n\n    /**\n     * Project ID for API calls\n     * @type {number|null}\n     */\n    this.projectId = null;\n\n    console.log(LOG_PREFIX, 'Initialized with dual state architecture');\n  }\n\n  /**\n   * Get value for a specific cell\n   * Reads from modifiedCells first, then assignmentMap\n   *\n   * @param {number|string} pekerjaanId - Pekerjaan ID\n   * @param {string} columnId - Column ID (e.g., \"col_123\")\n   * @returns {number} Cell value (0 if not found)\n   */\n  getCellValue(pekerjaanId, columnId) {\n    const state = this._getCurrentState();\n    const cellKey = `${pekerjaanId}-${columnId}`;\n\n    // Priority: modifiedCells > assignmentMap > 0\n    return state.modifiedCells.get(cellKey) ??\n      state.assignmentMap.get(cellKey) ??\n      0;\n  }\n\n  /**\n   * Get all cell values for a specific mode (merged view)\n   * Returns assignmentMap + modifiedCells combined\n   * Uses cache for performance\n   *\n   * @param {string} mode - 'planned' or 'actual'\n   * @returns {Map<string, number>} Merged cell values\n   */\n  getAllCellsForMode(mode) {\n    const modeState = this.states[mode];\n    if (!modeState) {\n      console.error(LOG_PREFIX, `Invalid mode: ${mode}`);\n      return new Map();\n    }\n\n    const cacheKey = `cells:${mode}`;\n\n    // Return cached if available and not dirty\n    if (this._mergedCellsCache.has(cacheKey) && !modeState.isDirty) {\n      return this._mergedCellsCache.get(cacheKey);\n    }\n\n    // Build merged map: assignmentMap + modifiedCells\n    const merged = new Map(modeState.assignmentMap);\n\n    // Override with modified cells\n    modeState.modifiedCells.forEach((value, key) => {\n      merged.set(key, value);\n    });\n\n    // Cache it\n    this._mergedCellsCache.set(cacheKey, merged);\n    modeState.isDirty = false;\n\n    console.log(LOG_PREFIX, `Built merged cells for ${mode.toUpperCase()}: ${merged.size} cells`);\n\n    return merged;\n  }\n\n  /**\n   * Set value for a specific cell (user input)\n   * Writes to modifiedCells, invalidates cache\n   *\n   * @param {number|string} pekerjaanId - Pekerjaan ID\n   * @param {string} columnId - Column ID\n   * @param {number|string} value - Cell value (percentage)\n   */\n  setCellValue(pekerjaanId, columnId, value) {\n    const state = this._getCurrentState();\n    const cellKey = `${pekerjaanId}-${columnId}`;\n    const numericValue = parseFloat(value);\n\n    if (Number.isNaN(numericValue)) {\n      console.warn(LOG_PREFIX, `Invalid value for cell ${cellKey}:`, value);\n      return;\n    }\n\n    // Write to modifiedCells\n    state.modifiedCells.set(cellKey, numericValue);\n\n    // Invalidate cache\n    this._invalidateCache(this.currentMode);\n\n    // Mark as dirty\n    state.isDirty = true;\n\n    console.log(LOG_PREFIX, `Cell ${cellKey} = ${numericValue}% (${this.currentMode.toUpperCase()} mode)`);\n  }\n\n  /**\n   * Switch to a different progress mode\n   * @param {string} newMode - 'planned' or 'actual'\n   */\n  switchMode(newMode) {\n    if (newMode !== 'planned' && newMode !== 'actual') {\n      console.error(LOG_PREFIX, `Invalid mode: ${newMode}`);\n      return;\n    }\n\n    if (this.currentMode === newMode) {\n      console.log(LOG_PREFIX, `Already in ${newMode.toUpperCase()} mode`);\n      return;\n    }\n\n    const oldMode = this.currentMode;\n    this.currentMode = newMode;\n\n    console.log(LOG_PREFIX, `Switched: ${oldMode.toUpperCase()} → ${newMode.toUpperCase()}`);\n\n    // Notify listeners\n    this._notifyListeners({\n      type: 'mode-switch',\n      oldMode,\n      newMode\n    });\n  }\n\n  /**\n   * Commit modified cells to assignmentMap (after save)\n   * Clears modifiedCells and invalidates cache\n   */\n  commitChanges() {\n    const state = this._getCurrentState();\n\n    // Move modifiedCells → assignmentMap\n    state.modifiedCells.forEach((value, key) => {\n      state.assignmentMap.set(key, value);\n    });\n\n    // Move costModifiedCells → costAssignmentMap (used for actual mode)\n    state.costModifiedCells.forEach((value, key) => {\n      if (value === null || typeof value === 'undefined') {\n        state.costAssignmentMap.delete(key);\n        return;\n      }\n      const numeric = Number(value);\n      if (Number.isFinite(numeric) && numeric >= 0) {\n        state.costAssignmentMap.set(key, numeric);\n      } else {\n        state.costAssignmentMap.delete(key);\n      }\n    });\n\n    const count = state.modifiedCells.size + state.costModifiedCells.size;\n    state.modifiedCells.clear();\n    state.costModifiedCells.clear();\n\n    // Invalidate cache\n    this._invalidateCache(this.currentMode);\n\n    // Also invalidate chart data cache (SSoT API data needs refresh)\n    this.invalidateChartCache();\n\n    console.log(LOG_PREFIX, `Committed ${count} changes to ${this.currentMode.toUpperCase()} assignmentMap`);\n\n    // Notify listeners\n    this._notifyListeners({\n      type: 'commit',\n      mode: this.currentMode,\n      count\n    });\n  }\n\n  /**\n   * Load initial data into assignmentMap\n   * Used by DataLoader after fetching from backend\n   *\n   * @param {string} mode - 'planned' or 'actual'\n   * @param {Map<string, number>} dataMap - Cell key → value map\n   */\n  loadData(mode, dataMap, costDataMap = new Map()) {\n    const state = this.states[mode];\n    if (!state) {\n      console.error(LOG_PREFIX, `Invalid mode: ${mode}`);\n      return;\n    }\n\n    // Replace assignmentMap\n    state.assignmentMap = new Map(dataMap);\n    if (costDataMap instanceof Map) {\n      state.costAssignmentMap = new Map(costDataMap);\n    }\n\n    // Clear modified cells\n    state.modifiedCells.clear();\n    state.costModifiedCells.clear();\n\n    // Invalidate cache\n    this._invalidateCache(mode);\n\n    console.log(LOG_PREFIX, `Loaded ${dataMap.size} assignments into ${mode.toUpperCase()} state`);\n  }\n\n  /**\n   * Set flat pekerjaan rows (single source of truth for all modes)\n   * @param {Array<Object>} rows - Flat list of pekerjaan objects\n   */\n  setFlatPekerjaan(rows) {\n    this.flatPekerjaan = Array.isArray(rows) ? rows : [];\n    console.log(LOG_PREFIX, `Set ${this.flatPekerjaan.length} pekerjaan rows`);\n  }\n\n  /**\n   * Get flat pekerjaan rows\n   * @returns {Array<Object>}\n   */\n  getFlatPekerjaan() {\n    return this.flatPekerjaan;\n  }\n\n  /**\n   * Set time columns configuration (single source of truth for all modes)\n   * @param {Array<Object>} columns - Time columns array\n   */\n  setTimeColumns(columns) {\n    this.timeColumns = Array.isArray(columns) ? columns : [];\n    console.log(LOG_PREFIX, `Set ${this.timeColumns.length} time columns`);\n  }\n\n  /**\n   * Get time columns configuration\n   * @returns {Array<Object>}\n   */\n  getTimeColumns() {\n    return this.timeColumns;\n  }\n\n  /**\n   * Set initial value for a cell (from backend data)\n   * Used during data loading phase\n   *\n   * @param {number|string} pekerjaanId\n   * @param {string} columnId\n   * @param {number} plannedValue\n   * @param {number} actualValue\n   */\n  setInitialValue(pekerjaanId, columnId, plannedValue = 0, actualValue = 0, options = {}) {\n    const cellKey = `${pekerjaanId}-${columnId}`;\n\n    // Set planned value\n    if (Number.isFinite(plannedValue) && plannedValue > 0) {\n      this.states.planned.assignmentMap.set(cellKey, plannedValue);\n    }\n\n    // Set actual value\n    if (Number.isFinite(actualValue) && actualValue > 0) {\n      this.states.actual.assignmentMap.set(cellKey, actualValue);\n    }\n\n    const hasCostProp =\n      Object.prototype.hasOwnProperty.call(options || {}, 'actualCost') ||\n      Object.prototype.hasOwnProperty.call(options || {}, 'actual_cost') ||\n      Object.prototype.hasOwnProperty.call(options || {}, 'cost');\n    const actualCost = Number(options?.actualCost ?? options?.cost ?? options?.actual_cost);\n    if (Number.isFinite(actualCost) && actualCost >= 0) {\n      this.states.actual.costAssignmentMap.set(cellKey, actualCost);\n    } else if (hasCostProp) {\n      this.states.actual.costAssignmentMap.delete(cellKey);\n    }\n  }\n\n  /**\n   * Add event listener for state changes\n   * @param {Function} callback - Listener function\n   */\n  addEventListener(callback) {\n    if (typeof callback !== 'function') {\n      console.error(LOG_PREFIX, 'Event listener must be a function');\n      return;\n    }\n\n    this._listeners.add(callback);\n    console.log(LOG_PREFIX, `Added event listener (total: ${this._listeners.size})`);\n  }\n\n  /**\n   * Remove event listener\n   * @param {Function} callback - Listener function\n   */\n  removeEventListener(callback) {\n    this._listeners.delete(callback);\n  }\n\n  /**\n   * Check if there are unsaved changes in current mode\n   * @returns {boolean}\n   */\n  hasUnsavedChanges() {\n    const state = this._getCurrentState();\n    return (\n      (state.modifiedCells && state.modifiedCells.size > 0) ||\n      (state.costModifiedCells && state.costModifiedCells.size > 0)\n    );\n  }\n\n  /**\n   * Get statistics about state manager\n   * @returns {Object}\n   */\n  getStats() {\n    return {\n      currentMode: this.currentMode,\n      planned: this.states.planned.getStats(),\n      actual: this.states.actual.getStats(),\n      cacheSize: this._mergedCellsCache.size,\n      listenerCount: this._listeners.size\n    };\n  }\n\n  /**\n   * Get current mode state\n   * @private\n   * @returns {ModeState}\n   */\n  _getCurrentState() {\n    return this.states[this.currentMode];\n  }\n\n  /**\n   * Invalidate cache for a specific mode\n   * @private\n   * @param {string} mode\n   */\n  _invalidateCache(mode) {\n    const cacheKey = `cells:${mode}`;\n    this._mergedCellsCache.delete(cacheKey);\n\n    const state = this.states[mode];\n    if (state) {\n      state.isDirty = true;\n    }\n  }\n\n  /**\n   * Notify all event listeners\n   * @private\n   * @param {Object} event - Event data\n   */\n  _notifyListeners(event) {\n    this._listeners.forEach(listener => {\n      try {\n        listener(event);\n      } catch (error) {\n        console.error(LOG_PREFIX, 'Listener error:', error);\n      }\n    });\n  }\n\n  /**\n   * Clear all data (use with caution)\n   */\n  reset() {\n    this.states.planned.clear();\n    this.states.actual.clear();\n    this._mergedCellsCache.clear();\n    this.currentMode = 'planned';\n\n    console.log(LOG_PREFIX, 'State reset');\n\n    this._notifyListeners({ type: 'reset' });\n  }\n\n  /**\n   * Fetch chart data from SSoT API (with caching)\n   * @param {string} timescale - 'weekly' or 'monthly'\n   * @param {string} mode - 'planned', 'actual', or 'both'\n   * @returns {Promise<Object>} Chart data from API\n   */\n  async fetchChartData(timescale = 'weekly', mode = 'both') {\n    const cacheKey = `${timescale}:${mode}`;\n\n    // Return cached data if available\n    if (this._chartDataCache.has(cacheKey)) {\n      console.log(LOG_PREFIX, 'Using cached chart data for:', cacheKey);\n      return this._chartDataCache.get(cacheKey);\n    }\n\n    if (!this.projectId) {\n      console.warn(LOG_PREFIX, 'No projectId set, cannot fetch chart data');\n      return null;\n    }\n\n    try {\n      console.log(LOG_PREFIX, 'Fetching chart data from API:', cacheKey);\n\n      const response = await fetch(\n        `/detail_project/api/v2/project/${this.projectId}/chart-data/?timescale=${timescale}&mode=${mode}`,\n        {\n          method: 'GET',\n          headers: {\n            'Accept': 'application/json',\n            'X-Requested-With': 'XMLHttpRequest'\n          },\n          credentials: 'same-origin'\n        }\n      );\n\n      if (!response.ok) {\n        throw new Error(`API error: ${response.status}`);\n      }\n\n      const data = await response.json();\n\n      // Cache the response\n      this._chartDataCache.set(cacheKey, data);\n\n      console.log(LOG_PREFIX, 'Chart data fetched:', {\n        timescale,\n        columns: data.columns?.length || 0,\n        rows: data.rows?.length || 0\n      });\n\n      // Notify listeners\n      this._notifyListeners({\n        type: 'chartDataLoaded',\n        timescale,\n        mode,\n        data\n      });\n\n      return data;\n\n    } catch (error) {\n      console.error(LOG_PREFIX, 'Failed to fetch chart data:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Get cached chart data (synchronous)\n   * @param {string} timescale - 'weekly' or 'monthly'\n   * @param {string} mode - 'planned', 'actual', or 'both'\n   * @returns {Object|null} Cached chart data or null\n   */\n  getChartData(timescale = 'weekly', mode = 'both') {\n    const cacheKey = `${timescale}:${mode}`;\n    return this._chartDataCache.get(cacheKey) || null;\n  }\n\n  /**\n   * Invalidate chart data cache (call after save or data change)\n   * @param {string} [timescale] - Specific timescale to invalidate, or all if omitted\n   */\n  invalidateChartCache(timescale = null) {\n    if (timescale) {\n      // Remove specific timescale entries\n      for (const key of this._chartDataCache.keys()) {\n        if (key.startsWith(timescale + ':')) {\n          this._chartDataCache.delete(key);\n        }\n      }\n      console.log(LOG_PREFIX, 'Chart cache invalidated for timescale:', timescale);\n    } else {\n      // Clear all\n      this._chartDataCache.clear();\n      console.log(LOG_PREFIX, 'All chart cache invalidated');\n    }\n  }\n\n  /**\n   * Set project ID for API calls\n   * @param {number} projectId\n   */\n  setProjectId(projectId) {\n    this.projectId = projectId;\n    console.log(LOG_PREFIX, 'Project ID set:', projectId);\n  }\n\n  /**\n   * Export state for debugging\n   * @returns {Object}\n   */\n  exportState() {\n    return {\n      currentMode: this.currentMode,\n      planned: this.states.planned.toJSON(),\n      actual: this.states.actual.toJSON(),\n      stats: this.getStats()\n    };\n  }\n}\n\n// Phase 0: Export to global scope for testing and debugging\nif (typeof window !== 'undefined') {\n  window.StateManager = StateManager;\n}\n\nexport default StateManager;\n","/**\n * Time Column Generator Module (ES6 Modern Version)\n * Generates time columns for different modes: daily, weekly, monthly, custom\n *\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/time_column_generator_module.js\n * Date: 2025-11-19\n */\n\nimport { StateManager } from './state-manager.js';\n\n// =========================================================================\n// CONSTANTS\n// =========================================================================\n\nconst ONE_DAY_MS = 24 * 60 * 60 * 1000;\n\n// =========================================================================\n// UTILITY FUNCTIONS\n// =========================================================================\n\n/**\n * Format date to short format (DD MMM)\n * @param {Date} date - Date to format\n * @returns {string} Formatted date\n */\nfunction formatDayMonth(date) {\n  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {\n    return '';\n  }\n  const day = date.getDate().toString().padStart(2, '0');\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\n  return `${day}/${month}`;\n}\n\n/**\n * Format date for display\n * @param {Date} date - Date to format\n * @param {string} format - Format type (short|iso|long)\n * @returns {string} Formatted date\n */\nfunction formatDate(date, format = 'short') {\n  if (format === 'short') {\n    const day = date.getDate().toString().padStart(2, '0');\n    const month = date.toLocaleString('id-ID', { month: 'short' });\n    return `${day} ${month}`;\n  } else if (format === 'iso') {\n    return date.toISOString().split('T')[0];\n  }\n  return date.toLocaleDateString('id-ID');\n}\n\n/**\n * Get week number for a date relative to project start\n * @param {Date} targetDate - Target date\n * @param {Date} projectStart - Project start date\n * @param {Object} options - Additional options\n * @param {number} options.weekEndDay - JS weekday (0=Sunday) marking end of week\n * @returns {number} Week number (1-based)\n */\nfunction getWeekNumberForDate(targetDate, projectStart, options = {}) {\n  if (!(targetDate instanceof Date) || Number.isNaN(targetDate.getTime())) {\n    return 1;\n  }\n\n  if (!(projectStart instanceof Date) || Number.isNaN(projectStart.getTime())) {\n    return 1;\n  }\n\n  if (targetDate <= projectStart) {\n    return 1;\n  }\n\n  const resolvedWeekEnd =\n    Number.isInteger(options.weekEndDay) && !Number.isNaN(options.weekEndDay)\n      ? ((options.weekEndDay % 7) + 7) % 7\n      : 0; // Default: Sunday\n\n  // Calculate first week end\n  const firstWeekEnd = new Date(projectStart);\n  const offsetToEnd = (resolvedWeekEnd - projectStart.getDay() + 7) % 7;\n  firstWeekEnd.setDate(firstWeekEnd.getDate() + offsetToEnd);\n\n  if (targetDate <= firstWeekEnd) {\n    return 1;\n  }\n\n  // Calculate week number\n  const daysAfterFirst = Math.floor((targetDate - firstWeekEnd) / ONE_DAY_MS);\n  return 1 + Math.floor((daysAfterFirst + 6) / 7);\n}\n\n// =========================================================================\n// TIME COLUMN GENERATOR CLASS\n// =========================================================================\n\n/**\n * TimeColumnGenerator class - generates time columns from tahapan data\n */\nexport class TimeColumnGenerator {\n  constructor(state) {\n    if (!state) {\n      throw new Error('[TimeColumnGenerator] State is required');\n    }\n\n    this.state = state;\n  }\n\n  /**\n   * Generate time columns from loaded tahapan data\n   * Maps database tahapan to grid time columns based on current time scale mode.\n   *\n   * FILTERING LOGIC:\n   * - daily/weekly/monthly: Shows ONLY auto-generated tahapan with matching generation_mode\n   * - custom: Shows ALL tahapan (both auto-generated and manually created)\n   *\n   * CRITICAL: Each column MUST have tahapanId for save functionality to work!\n   *\n   * @returns {Array} Generated time columns\n   */\n  generate() {\n    this.state.timeColumns = [];\n    this._projectStartCache = undefined;\n    this._jsWeekEndDayCache = undefined;\n\n    const timeScale = this.state.timeScale || 'custom';\n    const tahapanList = this.state.tahapanList || [];\n\n    console.log(`[TimeColumnGenerator] Generating columns for mode: ${timeScale}`);\n    console.log(`[TimeColumnGenerator] Available tahapan in database: ${tahapanList.length}`);\n\n    // Map tahapan to time columns\n    tahapanList.forEach((tahap, index) => {\n      // For daily/weekly/monthly modes, only include tahapan with matching generation_mode\n      // For custom mode, include all tahapan\n      let shouldInclude = false;\n\n      if (timeScale === 'custom') {\n        // Custom mode: include all tahapan\n        shouldInclude = true;\n      } else {\n        // Daily/weekly/monthly: only include AUTO-GENERATED tahapan with matching generation_mode\n        shouldInclude = (\n          tahap.is_auto_generated === true &&\n          tahap.generation_mode === timeScale\n        );\n      }\n\n      if (shouldInclude) {\n        const column = this._createColumn(tahap, index);\n        this.state.timeColumns.push(column);\n      }\n    });\n\n    // FALLBACK: If no columns generated, show all tahapan\n    if (this.state.timeColumns.length === 0 && tahapanList.length > 0) {\n      console.warn(`[TimeColumnGenerator] No auto-generated tahapan found for mode \"${timeScale}\"`);\n      console.warn(`[TimeColumnGenerator] Showing all ${tahapanList.length} tahapan as fallback`);\n\n      tahapanList.forEach((tahap, index) => {\n        const column = this._createColumn(tahap, index);\n        this.state.timeColumns.push(column);\n      });\n    }\n\n    console.log(`[TimeColumnGenerator] ✅ Generated ${this.state.timeColumns.length} time columns`);\n\n    // Single source of truth: Update StateManager\n    try {\n      const stateManager = StateManager.getInstance();\n      stateManager.setTimeColumns(this.state.timeColumns);\n    } catch (e) {\n      console.warn('[TimeColumnGenerator] Could not update StateManager:', e.message);\n    }\n\n    return this.state.timeColumns;\n  }\n\n  /**\n   * Create a column object from tahapan data\n   * @param {Object} tahap - Tahapan data\n   * @param {number} index - Index in list\n   * @returns {Object} Column object\n   * @private\n   */\n  _createColumn(tahap, index) {\n    const startDate = tahap.tanggal_mulai ? new Date(tahap.tanggal_mulai) : null;\n    const endDate = tahap.tanggal_selesai ? new Date(tahap.tanggal_selesai) : null;\n\n    let label = tahap.nama || `Tahap ${index + 1}`;\n    let rangeLabel = '';\n    let rangeText = '';\n    let tooltip = label;\n    let weekNumber = null;\n    let shortStart = '';\n    let shortEnd = '';\n    const resolvedOrder =\n      Number.isInteger(tahap.urutan) && tahap.urutan >= 0 ? tahap.urutan : index;\n\n    const isWeeklyMode =\n      (this.state.timeScale || '').toLowerCase() === 'weekly' ||\n      (tahap.generation_mode || '').toLowerCase() === 'weekly';\n    const projectStartDate = this._getProjectStartDate();\n    const jsWeekEndDay = this._getJsWeekEndDay();\n    const computedWeekNumber =\n      isWeeklyMode && startDate && projectStartDate\n        ? getWeekNumberForDate(startDate, projectStartDate, { weekEndDay: jsWeekEndDay })\n        : null;\n\n    // Special formatting for weekly mode\n    if (\n      tahap.is_auto_generated === true &&\n      tahap.generation_mode === 'weekly' &&\n      startDate &&\n      endDate\n    ) {\n      weekNumber = computedWeekNumber ?? resolvedOrder + 1;\n\n      shortStart = formatDayMonth(startDate);\n      shortEnd = formatDayMonth(endDate);\n\n      label = `Week ${weekNumber}`;\n      rangeLabel = `( ${shortStart} - ${shortEnd} )`;\n      rangeText = `${shortStart}\\u00A0-\\u00A0${shortEnd}`;\n\n      const longStart = startDate.toLocaleDateString('id-ID', {\n        weekday: 'long',\n        day: '2-digit',\n        month: 'long',\n        year: 'numeric'\n      });\n      const longEnd = endDate.toLocaleDateString('id-ID', {\n        weekday: 'long',\n        day: '2-digit',\n        month: 'long',\n        year: 'numeric'\n      });\n\n      tooltip = `Week ${weekNumber}: ${longStart} - ${longEnd}`;\n    } else if (startDate && endDate) {\n      shortStart = formatDayMonth(startDate);\n      shortEnd = formatDayMonth(endDate);\n      rangeLabel = `( ${shortStart} - ${shortEnd} )`;\n      rangeText = `${shortStart}\\u00A0-\\u00A0${shortEnd}`;\n    }\n\n    if (!weekNumber && isWeeklyMode) {\n      weekNumber = computedWeekNumber ?? resolvedOrder + 1;\n    }\n\n    const safeTahapanId = tahap.tahapan_id || tahap.id || resolvedOrder;\n    const fieldId = `col_${safeTahapanId}`;\n\n    return {\n      id: `tahap-${safeTahapanId}`,\n      fieldId,\n      tahapanId: tahap.tahapan_id,  // CRITICAL: Link to database tahapan!\n      label,\n      rangeLabel,\n      rangeText,\n      tooltip,\n      type: tahap.generation_mode || 'custom',\n      isAutoGenerated: tahap.is_auto_generated || false,\n      generationMode: tahap.generation_mode || 'custom',\n      index: resolvedOrder,\n      weekNumber,\n      startDate,\n      endDate,\n      urutan: tahap.urutan || index\n    };\n  }\n\n  /**\n   * Get column by ID\n   * @param {string} columnId - Column ID\n   * @returns {Object|null} Column object\n   */\n  getColumnById(columnId) {\n    return this.state.timeColumns.find(col => col.id === columnId) || null;\n  }\n\n  /**\n   * Get column by tahapan ID\n   * @param {number} tahapanId - Tahapan ID\n   * @returns {Object|null} Column object\n   */\n  getColumnByTahapanId(tahapanId) {\n    return this.state.timeColumns.find(col => col.tahapanId === tahapanId) || null;\n  }\n\n  /**\n   * Get columns for date range\n   * @param {Date} startDate - Start date\n   * @param {Date} endDate - End date\n   * @returns {Array} Columns in range\n   */\n  getColumnsInRange(startDate, endDate) {\n    return this.state.timeColumns.filter(col => {\n      if (!col.startDate || !col.endDate) return false;\n      return col.startDate <= endDate && col.endDate >= startDate;\n    });\n  }\n\n  /**\n   * Regenerate columns (refresh from tahapan list)\n   * @returns {Array} New time columns\n   */\n  regenerate() {\n    console.log('[TimeColumnGenerator] Regenerating columns...');\n    return this.generate();\n  }\n\n  _getProjectStartDate() {\n    if (typeof this._projectStartCache !== 'undefined') {\n      return this._projectStartCache;\n    }\n    const raw = this.state.projectStart;\n    if (!raw) {\n      this._projectStartCache = null;\n      return this._projectStartCache;\n    }\n    if (raw instanceof Date) {\n      this._projectStartCache = Number.isNaN(raw.getTime()) ? null : raw;\n      return this._projectStartCache;\n    }\n    const parsed = new Date(raw);\n    this._projectStartCache = Number.isNaN(parsed.getTime()) ? null : parsed;\n    return this._projectStartCache;\n  }\n\n  _getJsWeekEndDay() {\n    if (typeof this._jsWeekEndDayCache !== 'undefined') {\n      return this._jsWeekEndDayCache;\n    }\n    const pyWeekEnd = Number(this.state.weekEndDay);\n    const normalizedPy = Number.isFinite(pyWeekEnd) ? ((pyWeekEnd % 7) + 7) % 7 : 6;\n    this._jsWeekEndDayCache = (normalizedPy + 1) % 7; // Convert Monday-based to JS Sunday-based\n    return this._jsWeekEndDayCache;\n  }\n}\n\n// Export utilities\nexport {\n  formatDate,\n  formatDayMonth,\n  getWeekNumberForDate\n};\n","/**\n * Data Loader Module (ES6 Modern Version)\n * Handles all data loading operations for Jadwal Kegiatan page\n *\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/data_loader_module.js\n * Date: 2025-11-19\n * Phase 0.3: Integrated with StateManager\n */\n\nimport { StateManager } from './state-manager.js';\n\n// =========================================================================\n// UTILITY FUNCTIONS\n// =========================================================================\n\n/**\n * Get CSRF token from cookies\n * @returns {string|null} CSRF token\n */\nfunction getCookie(name) {\n  let cookieValue = null;\n  if (document.cookie && document.cookie !== '') {\n    const cookies = document.cookie.split(';');\n    for (let i = 0; i < cookies.length; i++) {\n      const cookie = cookies[i].trim();\n      if (cookie.substring(0, name.length + 1) === (name + '=')) {\n        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));\n        break;\n      }\n    }\n  }\n  return cookieValue;\n}\n\n/**\n * Make API call with automatic CSRF handling\n * @param {string} url - API endpoint\n * @param {Object} options - Fetch options\n * @returns {Promise<any>} JSON response\n */\nasync function apiCall(url, options = {}) {\n  const method = (options.method || 'GET').toUpperCase();\n  const needsCSRF = ['POST', 'PUT', 'DELETE', 'PATCH'].includes(method);\n\n  if (needsCSRF) {\n    options.headers = options.headers || {};\n    options.headers['X-CSRFToken'] = getCookie('csrftoken');\n  }\n\n  const response = await fetch(url, {\n    credentials: 'same-origin',\n    ...options\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({}));\n    throw new Error(error.error || `HTTP ${response.status}`);\n  }\n\n  return response.json();\n}\n\n/**\n * Derive time scale mode from tahapan list\n * @param {Array} tahapanList - List of tahapan\n * @param {string} fallbackMode - Default mode if can't detect\n * @returns {string} Detected mode (daily|weekly|monthly|custom)\n */\nfunction deriveTimeScaleFromTahapan(tahapanList, fallbackMode = 'weekly') {\n  if (!Array.isArray(tahapanList) || tahapanList.length === 0) {\n    return fallbackMode;\n  }\n\n  const autoCounts = { daily: 0, weekly: 0, monthly: 0 };\n  let autoTotal = 0;\n  let manualCount = 0;\n\n  tahapanList.forEach((tahap) => {\n    if (tahap && tahap.is_auto_generated && typeof tahap.generation_mode === 'string') {\n      const mode = tahap.generation_mode.toLowerCase();\n      if (autoCounts.hasOwnProperty(mode)) {\n        autoCounts[mode] += 1;\n        autoTotal += 1;\n      }\n    } else {\n      manualCount += 1;\n    }\n  });\n\n  // If auto-generated tahapan exist, use dominant mode\n  if (autoTotal > 0) {\n    const dominantMode = Object.entries(autoCounts).reduce((bestMode, entry) => {\n      const [mode, count] = entry;\n      if (!bestMode) return mode;\n      if (count > autoCounts[bestMode]) return mode;\n      return bestMode;\n    }, '');\n\n    if (dominantMode && autoCounts[dominantMode] > 0) {\n      return dominantMode;\n    }\n  }\n\n  // If only manual tahapan exist, it's custom mode\n  if (manualCount > 0) {\n    return 'custom';\n  }\n\n  return fallbackMode;\n}\n\n/**\n * Initialize expanded nodes set for tree\n * @param {Array} tree - Pekerjaan tree\n * @param {Object} state - Application state\n */\nfunction initialiseExpandedNodes(tree, state) {\n  if (!Array.isArray(tree) || tree.length === 0) {\n    return;\n  }\n\n  if (!(state.expandedNodes instanceof Set)) {\n    state.expandedNodes = new Set();\n  }\n\n  // If already initialized, skip\n  if (state.expandedNodes.size > 0) {\n    return;\n  }\n\n  // Expand all nodes by default\n  const collectIds = (nodes) => {\n    nodes.forEach((node) => {\n      if (!node || !node.id) return;\n      if (node.children && node.children.length > 0) {\n        state.expandedNodes.add(node.id);\n        collectIds(node.children);\n      }\n    });\n  };\n\n  collectIds(tree);\n}\n\n/**\n * Build hierarchical pekerjaan tree from API response\n * @param {Object} response - API response\n * @returns {Array} Tree structure\n */\nfunction buildPekerjaanTree(response) {\n  const tree = [];\n  const data = response.klasifikasi || response;\n\n  if (!Array.isArray(data)) return tree;\n\n  data.forEach(klas => {\n    const klasNode = {\n      id: `klas-${klas.id || klas.nama}`,\n      type: 'klasifikasi',\n      nama: klas.name || klas.nama || 'Klasifikasi',\n      children: [],\n      level: 0,\n      expanded: true\n    };\n\n    // Store for enrichment\n    const klasifikasiId = klas.id;\n    const klasifikasiName = klas.name || klas.nama || 'Klasifikasi';\n    const klasifikasiKode = klas.kode || '';\n\n    if (klas.sub && Array.isArray(klas.sub)) {\n      klas.sub.forEach(sub => {\n        const subNode = {\n          id: `sub-${sub.id || sub.nama}`,\n          type: 'sub-klasifikasi',\n          nama: sub.name || sub.nama || 'Sub-Klasifikasi',\n          children: [],\n          level: 1,\n          expanded: true\n        };\n\n        // Store for enrichment\n        const subKlasifikasiId = sub.id;\n        const subKlasifikasiName = sub.name || sub.nama || 'Sub-Klasifikasi';\n        const subKlasifikasiKode = sub.kode || '';\n\n        if (sub.pekerjaan && Array.isArray(sub.pekerjaan)) {\n          sub.pekerjaan.forEach(pkj => {\n            const pkjNode = {\n              id: pkj.id || pkj.pekerjaan_id,\n              type: 'pekerjaan',\n              kode: pkj.snapshot_kode || pkj.kode || '',\n              nama: pkj.snapshot_uraian || pkj.uraian || '',\n              volume: pkj.volume || 0,\n              satuan: pkj.snapshot_satuan || pkj.satuan || '-',\n              level: 2,\n              budgeted_cost: Number.parseFloat(pkj.budgeted_cost ?? pkj.total_cost ?? 0) || 0,\n\n              // ✅ ADD: Parent information for Gantt Chart\n              klasifikasi_id: klasifikasiId,\n              klasifikasi_name: klasifikasiName,\n              klasifikasi_kode: klasifikasiKode,\n              sub_klasifikasi_id: subKlasifikasiId,\n              sub_klasifikasi_name: subKlasifikasiName,\n              sub_klasifikasi_kode: subKlasifikasiKode\n            };\n            subNode.children.push(pkjNode);\n          });\n        }\n\n        klasNode.children.push(subNode);\n      });\n    }\n\n    tree.push(klasNode);\n  });\n\n  return tree;\n}\n\n/**\n * Flatten tree structure for easy access\n * @param {Array} tree - Hierarchical tree\n * @param {Array} result - Accumulator\n * @returns {Array} Flattened list\n */\nfunction flattenTree(tree, result = []) {\n  tree.forEach(node => {\n    result.push(node);\n    if (node.children && node.children.length > 0) {\n      flattenTree(node.children, result);\n    }\n  });\n  return result;\n}\n\n// =========================================================================\n// DATA LOADER CLASS\n// =========================================================================\n\n/**\n * DataLoader class - handles all data loading operations\n */\nexport class DataLoader {\n  constructor(state, options = {}) {\n    if (!state) {\n      throw new Error('[DataLoader] State is required');\n    }\n\n    this.state = state;\n    this.options = options;\n    this.projectId = state.projectId;\n\n    // Phase 0.3: Initialize StateManager\n    this.stateManager = StateManager.getInstance();\n\n    // Initialize state maps if not exist\n    if (!this.state.volumeMap) {\n      this.state.volumeMap = new Map();\n    }\n    // Phase 0.3: assignmentMap now managed by StateManager\n    // Legacy code may still access via this.state.assignmentMap (delegation getter)\n    if (!this.state.cache) {\n      this.state.cache = {};\n    }\n\n    // Lightweight response cache to avoid repeated fetches on tab switches\n    this.cacheTTL = options.cacheTTL || 60000; // default 60s\n    this.responseCache = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n    this.responseCacheTimestamps = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n\n    console.log('[DataLoader] Phase 0.3: Initialized with StateManager');\n  }\n\n  /**\n   * Load all data required for the page\n   * @param {Object} options - Load options\n   * @returns {Promise<Object>} Load result with metadata\n   */\n  async loadAllData(options = {}) {\n    const { force = false, skipIfLoaded = false } = options;\n    // Prevent duplicate loading\n    if (this.state.cache.initialLoadInProgress) {\n      console.info('[DataLoader] loadAllData skipped (already in progress)');\n      return null;\n    }\n\n    // Skip if already loaded\n    if (!force && this.state.cache.initialLoadCompleted && skipIfLoaded) {\n      console.info('[DataLoader] loadAllData skipped (already completed)');\n      return this.state.cache.initialLoadResult || null;\n    }\n\n    this.state.cache.initialLoadInProgress = true;\n\n    try {\n      console.log('[DataLoader] Loading all data...');\n\n      // Step 1: Load base data in parallel\n      await Promise.all([\n        this.loadTahapan({ forceRefresh: force }),\n        this.loadPekerjaan({ forceRefresh: force }),\n        this.loadVolumes({ forceRefresh: force })\n      ]);\n\n      // Step 2: Time columns will be generated by TimeColumnGenerator\n      // (We don't call it here, will be handled by main app)\n\n      // Step 3: Load assignments (depends on time columns being generated)\n      await this.loadAssignments({ forceRefresh: force });\n\n      this.state.cache.initialLoadCompleted = true;\n      this.state.cache.initialLoadResult = {\n        completedAt: Date.now(),\n        tahapanCount: this.state.tahapanList?.length || 0,\n        pekerjaanCount: this.state.flatPekerjaan?.filter(node => node.type === 'pekerjaan').length || 0,\n      };\n\n      console.log('[DataLoader] ✅ All data loaded successfully:', this.state.cache.initialLoadResult);\n      return this.state.cache.initialLoadResult;\n\n    } catch (error) {\n      console.error('[DataLoader] ❌ Load data failed:', error);\n      this.state.cache.initialLoadError = error;\n      throw error;\n    } finally {\n      this.state.cache.initialLoadInProgress = false;\n    }\n  }\n\n  /**\n   * Load tahapan data from API\n   * @returns {Promise<Array>} List of tahapan\n   */\n  async loadTahapan(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      const useCache = !forceRefresh\n        && this._isCacheValid('tahapan')\n        && Array.isArray(this.responseCache.tahapan);\n\n      if (useCache) {\n        this.state.tahapanList = JSON.parse(JSON.stringify(this.responseCache.tahapan));\n        const detectedModeFromCache = deriveTimeScaleFromTahapan(\n          this.state.tahapanList,\n          this.state.timeScale || 'weekly'\n        );\n        this.state.timeScale = detectedModeFromCache;\n        console.log(`[DataLoader] Using cached tahapan list (${this.state.tahapanList.length} items)`);\n        return this.state.tahapanList;\n      }\n\n      const url = this.state.apiBase || `/detail_project/api/project/${this.projectId}/tahapan/`;\n      const data = await apiCall(url);\n\n      this.state.tahapanList = (data.tahapan || data || []).sort((a, b) => a.urutan - b.urutan);\n\n      // Auto-detect time scale mode from tahapan\n      const detectedMode = deriveTimeScaleFromTahapan(\n        this.state.tahapanList,\n        this.state.timeScale || 'weekly'\n      );\n      this.state.timeScale = detectedMode;\n\n      this._setCache('tahapan', JSON.parse(JSON.stringify(this.state.tahapanList)));\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.tahapanList.length} tahapan, mode: ${detectedMode}`);\n      return this.state.tahapanList;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load tahapan:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Load pekerjaan tree data from API\n   * @returns {Promise<Array>} Pekerjaan tree\n   */\n  async loadPekerjaan(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      const useCache = !forceRefresh\n        && this._isCacheValid('pekerjaan')\n        && Array.isArray(this.responseCache.pekerjaan);\n\n      if (useCache) {\n        const cachedTree = JSON.parse(JSON.stringify(this.responseCache.pekerjaan));\n        this.state.pekerjaanTree = cachedTree;\n        this.state.flatPekerjaan = flattenTree(cachedTree);\n        initialiseExpandedNodes(cachedTree, this.state);\n\n        // Single source of truth: Update StateManager\n        this.stateManager.setFlatPekerjaan(this.state.flatPekerjaan);\n\n        console.log(`[DataLoader] Using cached pekerjaan tree (${this.state.flatPekerjaan.length} nodes)`);\n        return this.state.pekerjaanTree;\n      }\n\n      const url = `/detail_project/api/project/${this.projectId}/list-pekerjaan/tree/`;\n      const response = await apiCall(url);\n\n      // Build hierarchical tree\n      const tree = buildPekerjaanTree(response);\n      this.state.pekerjaanTree = tree;\n\n      // Flatten for easy access\n      this.state.flatPekerjaan = flattenTree(tree);\n\n      // Initialize expanded nodes\n      initialiseExpandedNodes(tree, this.state);\n\n      this._setCache('pekerjaan', JSON.parse(JSON.stringify(tree)));\n\n      // Single source of truth: Update StateManager\n      this.stateManager.setFlatPekerjaan(this.state.flatPekerjaan);\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.flatPekerjaan.length} pekerjaan nodes`);\n      return this.state.pekerjaanTree;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load pekerjaan:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Load volume data for all pekerjaan\n   * @returns {Promise<Map>} Volume map\n   */\n  async loadVolumes(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      const useCache = !forceRefresh\n        && this._isCacheValid('volumes')\n        && Array.isArray(this.responseCache.volumes);\n\n      if (useCache) {\n        this.state.volumeMap.clear();\n        this.responseCache.volumes.forEach(([pkjId, qty]) => {\n          this.state.volumeMap.set(pkjId, qty);\n        });\n        console.log(`[DataLoader] Using cached volumes (${this.state.volumeMap.size} entries)`);\n        return this.state.volumeMap;\n      }\n\n      const url = `/detail_project/api/project/${this.projectId}/volume-pekerjaan/list/`;\n      const data = await apiCall(url);\n\n      this.state.volumeMap.clear();\n\n      const volumes = data.items || data.volumes || data.data || [];\n      if (Array.isArray(volumes)) {\n        volumes.forEach(v => {\n          const pkjId = v.pekerjaan_id || v.id;\n          const qty = parseFloat(v.quantity || v.volume || v.qty) || 0;\n          if (pkjId) {\n            this.state.volumeMap.set(pkjId, qty);\n          }\n        });\n      }\n\n      this._setCache('volumes', Array.from(this.state.volumeMap.entries()));\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.volumeMap.size} volume entries`);\n      return this.state.volumeMap;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load volumes:', error);\n      // Don't throw, volumes are optional\n      return this.state.volumeMap;\n    }\n  }\n\n  /**\n   * Load assignments (progress data) for all pekerjaan\n   * @returns {Promise<Map>} Assignment map\n   */\n  async loadAssignments(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      // Phase 0.3: Clear StateManager data (both modes)\n      this.stateManager.states.planned.assignmentMap.clear();\n      this.stateManager.states.actual.assignmentMap.clear();\n      console.log('[DataLoader] Phase 0.3: Loading assignments (attempting API v2)...');\n\n      const pekerjaanNodes = this.state.flatPekerjaan.filter(node => node.type === 'pekerjaan');\n      const totalNodes = pekerjaanNodes.length;\n\n      if (totalNodes === 0) {\n        console.info('[DataLoader] No pekerjaan nodes found for assignments');\n        return this.state.assignmentMap;\n      }\n\n      const useCache = !forceRefresh\n        && this._isCacheValid('assignments')\n        && Array.isArray(this.responseCache.assignments);\n\n      if (useCache) {\n        this._applyAssignmentsData(this.responseCache.assignments, { source: 'cache' });\n        return this.state.assignmentMap;\n      }\n\n      const assignments = await this._loadAssignmentsViaV2();\n      if (Array.isArray(assignments) && assignments.length > 0) {\n        this._setCache('assignments', assignments);\n      }\n\n      return this.state.assignmentMap;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load assignments:', error);\n      return this.state.assignmentMap;\n    }\n  }\n\n  /**\n   * Reload specific data type\n   * @param {string} type - Data type (tahapan|pekerjaan|volumes|assignments)\n   * @returns {Promise<any>} Loaded data\n   */\n  async reload(type) {\n    const loaders = {\n      tahapan: () => this.loadTahapan({ forceRefresh: true }),\n      pekerjaan: () => this.loadPekerjaan({ forceRefresh: true }),\n      volumes: () => this.loadVolumes({ forceRefresh: true }),\n      assignments: () => this.loadAssignments({ forceRefresh: true })\n    };\n\n    const loader = loaders[type];\n    if (!loader) {\n      throw new Error(`[DataLoader] Unknown reload type: ${type}`);\n    }\n\n    console.log(`[DataLoader] Reloading ${type}...`);\n    return loader();\n  }\n\n  _isCacheValid(cacheType) {\n    const timestamp = this.responseCacheTimestamps?.[cacheType];\n    if (!timestamp) {\n      return false;\n    }\n    return (Date.now() - timestamp) < this.cacheTTL;\n  }\n\n  _setCache(cacheType, payload) {\n    if (!this.responseCache.hasOwnProperty(cacheType)) {\n      return;\n    }\n    this.responseCache[cacheType] = payload;\n    this.responseCacheTimestamps[cacheType] = Date.now();\n  }\n\n  /**\n   * Clear cached responses. If cacheType is provided, only clear that entry.\n   * @param {string|null} cacheType\n   */\n  clearCache(cacheType = null) {\n    if (cacheType && this.responseCache.hasOwnProperty(cacheType)) {\n      this.responseCache[cacheType] = null;\n      this.responseCacheTimestamps[cacheType] = null;\n      console.log(`[DataLoader] Cache cleared for ${cacheType}`);\n      return;\n    }\n\n    this.responseCache = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n    this.responseCacheTimestamps = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n    console.log('[DataLoader] All caches cleared');\n  }\n\n  _buildWeekColumnIndex() {\n    const weekColumnIndex = {};\n    if (Array.isArray(this.state.timeColumns)) {\n      this.state.timeColumns.forEach((col) => {\n        const weekNumber = Number(col.weekNumber || col.week_number || col.urutan);\n        if (Number.isFinite(weekNumber) && weekNumber >= 1 && col.id) {\n          weekColumnIndex[weekNumber] = col;\n        }\n      });\n    }\n    return weekColumnIndex;\n  }\n\n  async _loadAssignmentsViaV2() {\n    const url = `/detail_project/api/v2/project/${this.projectId}/assignments/`;\n    const data = await apiCall(url);\n\n    if (!data || !Array.isArray(data.assignments)) {\n      console.info('[DataLoader] API v2 returned no assignments array (treating as empty dataset)');\n      return [];\n    }\n\n    if (data.assignments.length === 0) {\n      console.info('[DataLoader] API v2 assignments empty (no progress recorded yet)');\n      return [];\n    }\n\n    this._applyAssignmentsData(data.assignments, { source: 'api' });\n    return data.assignments;\n  }\n\n  _applyAssignmentsData(assignments = [], { source = 'api' } = {}) {\n    const weekColumnIndex = this._buildWeekColumnIndex();\n    let mapped = 0;\n\n    assignments.forEach((item) => {\n      const pekerjaanId = Number(item.pekerjaan_id || item.pekerjaanId || item.id);\n      const weekNumber = Number(item.week_number || item.weekNumber);\n\n      // Phase 0.3: Read both planned and actual proportions\n      const plannedProportion = parseFloat(item.planned_proportion) || 0;\n      const actualProportion = parseFloat(item.actual_proportion) || 0;\n      const rawCost = item.actual_cost ?? item.actualCost ?? null;\n      const actualCost = rawCost === null || typeof rawCost === 'undefined'\n        ? null\n        : Number.parseFloat(rawCost);\n\n      if (!pekerjaanId || !weekNumber) {\n        return;\n      }\n\n      const column = weekColumnIndex[weekNumber];\n      if (!column) {\n        return;\n      }\n\n      const columnKey = column.fieldId || column.id;\n      if (!columnKey) {\n        return;\n      }\n\n      const options = {};\n      if (actualCost !== null && !Number.isNaN(actualCost) && Number.isFinite(actualCost)) {\n        options.actualCost = actualCost;\n      }\n\n      this.stateManager.setInitialValue(\n        pekerjaanId,\n        columnKey,\n        plannedProportion,\n        actualProportion,\n        options\n      );\n      mapped += 1;\n    });\n\n    const stats = this.stateManager.getStats();\n    const sourceLabel = source === 'cache' ? 'cache' : 'API v2';\n    console.log(`[DataLoader] Phase 0.3: Loaded ${mapped} assignments via ${sourceLabel}`);\n    console.log(`[DataLoader] Planned: ${stats.planned.assignmentCount} assignments`);\n    console.log(`[DataLoader] Actual: ${stats.actual.assignmentCount} assignments`);\n  }\n}\n\n// Export utilities for external use\nexport {\n  apiCall,\n  getCookie,\n  deriveTimeScaleFromTahapan,\n  buildPekerjaanTree,\n  flattenTree,\n  initialiseExpandedNodes\n};\n","/**\r\n * Save Handler Module (ES6 Modern Version)\r\n * Handles saving modified cells to Django backend\r\n *\r\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/save_handler_module.js\r\n * Date: 2025-11-19\r\n * Phase 0.3: Integrated with StateManager\r\n */\r\n\r\nimport { StateManager } from './state-manager.js';\r\n\r\n// =========================================================================\r\n// UTILITY FUNCTIONS\r\n// =========================================================================\r\n\r\n/**\r\n * Get CSRF token from cookies\r\n * @returns {string|null} CSRF token\r\n */\r\nfunction getCookie(name) {\r\n  let cookieValue = null;\r\n  if (document.cookie && document.cookie !== '') {\r\n    const cookies = document.cookie.split(';');\r\n    for (let i = 0; i < cookies.length; i++) {\r\n      const cookie = cookies[i].trim();\r\n      if (cookie.substring(0, name.length + 1) === (name + '=')) {\r\n        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));\r\n        break;\r\n      }\r\n    }\r\n  }\r\n  return cookieValue;\r\n}\r\n\r\n// =========================================================================\r\n// SAVE HANDLER CLASS\r\n// =========================================================================\r\n\r\n/**\r\n * SaveHandler - Manages save operations for grid data\r\n * Handles building payloads, API calls, and state updates\r\n */\r\nexport class SaveHandler {\r\n  /**\r\n   * Create a SaveHandler instance\r\n   * @param {Object} state - Application state\r\n   * @param {Object} options - Configuration options\r\n   * @param {string} options.apiUrl - API endpoint URL\r\n   * @param {Function} options.onSuccess - Success callback\r\n   * @param {Function} options.onError - Error callback\r\n   * @param {Function} options.showToast - Toast notification function\r\n   */\r\n  constructor(state, options = {}) {\r\n    if (!state) {\r\n      throw new Error('[SaveHandler] State is required');\r\n    }\r\n\r\n    this.state = state;\r\n    this.options = options;\r\n\r\n    // Phase 0.3: Initialize StateManager\r\n    this.stateManager = StateManager.getInstance();\r\n\r\n    // API configuration\r\n    this.apiUrl = options.apiUrl || `/detail_project/api/project/${state.projectId}/pekerjaan/assign_weekly/`;\r\n\r\n    // Callbacks\r\n    this.onSuccess = options.onSuccess || (() => {});\r\n    this.onError = options.onError || ((err) => console.error(err));\r\n    this.showToast = options.showToast || ((msg, type) => console.log(`[${type}] ${msg}`));\r\n    this.dataLoader = options.dataLoader || null;\r\n\r\n    // Save state\r\n    this.isSaving = false;\r\n\r\n    console.log('[SaveHandler] Phase 0.3: Initialized with StateManager');\r\n    console.log('[SaveHandler] API:', this.apiUrl);\r\n  }\r\n\r\n  // =======================================================================\r\n  // MAIN SAVE OPERATION\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Save all modified cells to server\r\n   * Main entry point for save operation\r\n   * @returns {Promise<Object>} Save result\r\n   */\r\n  async save() {\r\n    if (this.isSaving) {\r\n      console.warn('[SaveHandler] Save already in progress');\r\n      this.showToast('Penyimpanan sedang berlangsung...', 'warning');\r\n      return { success: false, reason: 'already_saving' };\r\n    }\r\n\r\n    console.log('[SaveHandler] Starting save operation...');\r\n    this.isSaving = true;\r\n\r\n    try {\r\n      // Check if there are any changes\r\n      const hasCostChanges = this._hasCostChanges();\r\n      if ((!this.state.modifiedCells || this.state.modifiedCells.size === 0) && !hasCostChanges) {\r\n        console.warn('[SaveHandler] No modified cells to save');\r\n        this.showToast('Tidak ada perubahan untuk disimpan', 'info');\r\n        this.isSaving = false;\r\n        return { success: false, reason: 'no_changes' };\r\n      }\r\n\r\n      // Build payload\r\n      const payload = this._buildPayload();\r\n      const payloadCount = payload.assignments?.length ?? payload.items?.length ?? 0;\r\n      console.log(`[SaveHandler] Built payload with ${payloadCount} items`);\r\n\r\n      // Send to server\r\n      const result = await this._sendToServer(payload);\r\n\r\n      // Handle success\r\n      this._handleSaveSuccess(result);\r\n\r\n      this.isSaving = false;\r\n      return { success: true, result };\r\n\r\n    } catch (error) {\r\n      // Handle error\r\n      this._handleSaveError(error);\r\n      this.isSaving = false;\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  // =======================================================================\r\n  // PAYLOAD BUILDING\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Build save payload from modified cells\r\n   * Converts modifiedCells Map to API format\r\n   * @returns {Object} Payload object\r\n   * @private\r\n   */\r\n  _buildPayload() {\r\n    const assignments = [];\r\n\r\n    // Phase 2E.1: Log which mode's modifiedCells we're reading from\r\n    const progressMode = this.state?.progressMode || 'planned';\r\n    const modeState = this.stateManager.states[progressMode];\r\n    const modifiedCells = modeState?.modifiedCells || this.state.modifiedCells || new Map();\r\n    const costModifiedCells = progressMode === 'actual' ? (modeState?.costModifiedCells || new Map()) : new Map();\r\n    const cellsToSave = new Set();\r\n\r\n    modifiedCells.forEach((_, cellKey) => cellsToSave.add(cellKey));\r\n    if (progressMode === 'actual' && costModifiedCells instanceof Map) {\r\n      costModifiedCells.forEach((_, cellKey) => cellsToSave.add(cellKey));\r\n    }\r\n\r\n    console.log(\r\n      `[SaveHandler] Building payload from ${progressMode.toUpperCase()} modifiedCells` +\r\n      ` (cells: ${modifiedCells.size}, cost: ${costModifiedCells.size})`\r\n    );\r\n\r\n    // Convert modifiedCells Map to array of assignments\r\n    // Phase 2E.1: Property delegation ensures this reads from current mode's modifiedCells\r\n    cellsToSave.forEach((cellKey) => {\r\n      const value = modifiedCells.has(cellKey) ? modifiedCells.get(cellKey) : undefined;\r\n      // Parse cellKey (format: \"nodeId-columnId\")\r\n      const [pekerjaanId, tahapanId] = cellKey.split('-');\r\n\r\n      if (!pekerjaanId || !tahapanId) {\r\n        console.warn(`[SaveHandler] Invalid cell key: ${cellKey}`);\r\n        return;\r\n      }\r\n\r\n      // Get numeric value\r\n      let proportion = typeof value === 'undefined' ? this._getSavedValue(cellKey) : parseFloat(value);\r\n      if (!Number.isFinite(proportion)) {\r\n        proportion = 0;\r\n      }\r\n\r\n      // Get column info for additional metadata\r\n      const column = this.state.timeColumns?.find((col) => {\r\n        const key = col.fieldId || col.id;\r\n        return key?.toString() === tahapanId.toString();\r\n      });\r\n\r\n      // Build item\r\n      // Backend expects generic 'proportion' field - it will convert to planned/actual based on mode\r\n      const item = {\r\n        pekerjaan_id: parseInt(pekerjaanId, 10),\r\n        proportion: Number(proportion.toFixed(2)),\r\n      };\r\n\r\n      const targetField = progressMode === 'actual' ? 'actual_proportion' : 'planned_proportion';\r\n      item[targetField] = item.proportion;\r\n\r\n      if (column) {\r\n        const tahapanPrimaryId =\r\n          column.tahapanId ??\r\n          column.tahapan_id ??\r\n          (Number.isFinite(Number(column.id)) ? Number(column.id) : null);\r\n        if (tahapanPrimaryId) {\r\n          item.tahapan_id = tahapanPrimaryId;\r\n        }\r\n\r\n        if (column.startDate) {\r\n          item.week_start = this._formatDate(column.startDate);\r\n        }\r\n        if (column.endDate) {\r\n          item.week_end = this._formatDate(column.endDate);\r\n        }\r\n        if (Number.isFinite(column.weekNumber)) {\r\n          item.week_number = column.weekNumber;\r\n        }\r\n\r\n        if (!item.week_number) {\r\n          const normalizedOrder = Number.isFinite(column.index)\r\n            ? Number(column.index)\r\n            : Number.isFinite(column.order)\r\n              ? Number(column.order)\r\n              : Number.isFinite(column.urutan)\r\n                ? Number(column.urutan)\r\n                : null;\r\n          if (normalizedOrder !== null) {\r\n            item.week_number = normalizedOrder + 1;\r\n          }\r\n        }\r\n      } else {\r\n        const numericTahapan = parseInt(tahapanId, 10);\r\n        if (Number.isFinite(numericTahapan)) {\r\n          item.tahapan_id = numericTahapan;\r\n        }\r\n      }\r\n\r\n      if (!item.week_number) {\r\n        const fallbackWeek = parseInt(item.tahapan_id ?? tahapanId, 10);\r\n        if (Number.isFinite(fallbackWeek)) {\r\n          item.week_number = fallbackWeek;\r\n        } else {\r\n          // Default to 1 as last resort to satisfy backend validation\r\n          item.week_number = 1;\r\n        }\r\n      }\r\n\r\n      if (progressMode === 'actual' && costModifiedCells instanceof Map && costModifiedCells.has(cellKey)) {\r\n        const costValue = Number(costModifiedCells.get(cellKey));\r\n        if (Number.isFinite(costValue) && costValue >= 0) {\r\n          item.actual_cost = Number(costValue.toFixed(2));\r\n        }\r\n      }\r\n\r\n      assignments.push(item);\r\n    });\r\n\r\n    console.log(`[SaveHandler] Built ${assignments.length} assignment items`);\r\n\r\n    // Phase 2E.1: progressMode already declared at top of function\r\n    console.log(`[SaveHandler] Progress Mode: ${progressMode.toUpperCase()} - Will save to ${progressMode === 'actual' ? 'actual_proportion' : 'planned_proportion'} field`);\r\n\r\n    const payload = {\r\n      assignments,\r\n      mode: progressMode,  // Phase 2E.1: 'planned' or 'actual' (determines field to update)\r\n      project_id: this.state.projectId,\r\n      week_end_day: this.state.weekEndDay ?? 6,\r\n    };\r\n\r\n    console.log(`[SaveHandler] Payload:`, JSON.stringify(payload, null, 2));\r\n\r\n    return payload;\r\n  }\r\n\r\n  /**\r\n   * Format date for API (YYYY-MM-DD)\r\n   * @param {Date} date - Date to format\r\n   * @returns {string} Formatted date\r\n   * @private\r\n   */\r\n  _formatDate(date) {\r\n    if (!(date instanceof Date)) {\r\n      date = new Date(date);\r\n    }\r\n    if (Number.isNaN(date.getTime())) {\r\n      return '';\r\n    }\r\n    return date.toISOString().split('T')[0];\r\n  }\r\n\r\n  // =======================================================================\r\n  // API COMMUNICATION\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Send payload to server\r\n   * @param {Object} payload - Payload to send\r\n   * @returns {Promise<Object>} Server response\r\n   * @private\r\n   */\r\n  async _sendToServer(payload) {\r\n    console.log('[SaveHandler] Sending request to:', this.apiUrl);\r\n    console.log('[SaveHandler] Payload:', payload);\r\n\r\n    const csrfToken = getCookie('csrftoken');\r\n\r\n    const response = await fetch(this.apiUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-CSRFToken': csrfToken\r\n      },\r\n      credentials: 'same-origin',\r\n      body: JSON.stringify(payload)\r\n    });\r\n\r\n    if (!response.ok) {\r\n      let errorData = {};\r\n      let parsedBody = null;\r\n      try {\r\n        parsedBody = await response.json();\r\n        errorData = parsedBody || {};\r\n      } catch (jsonError) {\r\n        const fallbackText = await response.text().catch(() => '');\r\n        errorData = { message: fallbackText };\r\n      }\r\n\r\n      const errorMsg = errorData.error || errorData.message || `HTTP ${response.status}`;\r\n      const error = new Error(errorMsg);\r\n      if (errorData.errors) {\r\n        error.details = errorData.errors;\r\n      }\r\n      if (errorData.validation_errors) {\r\n        error.validationErrors = errorData.validation_errors;\r\n      }\r\n      if (typeof errorData === 'object') {\r\n        error.payload = errorData;\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    const result = await response.json();\r\n    console.log('[SaveHandler] Server response:', result);\r\n\r\n    return result;\r\n  }\r\n\r\n  // =======================================================================\r\n  // RESPONSE HANDLING\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Handle successful save\r\n   * @param {Object} result - Server response\r\n   * @private\r\n   */\r\n  _handleSaveSuccess(result) {\r\n    console.log('[SaveHandler] ✅ Save successful');\r\n\r\n    const progressMode = (this.state?.progressMode || 'planned').toLowerCase();\r\n    const modeState = this.stateManager?.states?.[progressMode];\r\n    const pendingModifiedCount = modeState?.modifiedCells?.size ?? this.state.modifiedCells.size;\r\n\r\n    // Update assignmentMap with saved values\r\n    this._updateAssignmentMap();\r\n\r\n    // Clear modified cells\r\n    this.state.modifiedCells.clear();\r\n    if (this.state.cellVolumeOverrides instanceof Map) {\r\n      this.state.cellVolumeOverrides.clear();\r\n    }\r\n\r\n    // Update UI status\r\n    if (this.state.cache) {\r\n      this.state.cache.hasUnsavedChanges = false;\r\n    }\r\n\r\n    // Clear client-side caches so subsequent fetches get fresh data\r\n    if (this.dataLoader && typeof this.dataLoader.clearCache === 'function') {\r\n      this.dataLoader.clearCache();\r\n    }\r\n\r\n    // Show success message\r\n    const apiSavedTotal = (Number(result.created_count) || 0) + (Number(result.updated_count) || 0);\r\n    const fallbackSaved = Number(result.saved_count) || Number(result.count) || pendingModifiedCount;\r\n    const savedCount = apiSavedTotal > 0 ? apiSavedTotal : fallbackSaved;\r\n    const modeLabel = progressMode === 'actual' ? 'Realisasi' : 'Perencanaan';\r\n    const message = `Berhasil menyimpan ${savedCount} perubahan (${modeLabel})`;\r\n    this.showToast(message, 'success');\r\n    this.showToast(message, 'success');\r\n\r\n    // Call success callback\r\n    if (typeof this.onSuccess === 'function') {\r\n      this.onSuccess(result);\r\n    }\r\n\r\n    console.log(`[SaveHandler] Saved ${savedCount} assignments, cleared ${pendingModifiedCount} modified cells`);\r\n  }\r\n\r\n  /**\r\n   * Handle save error\r\n   * @param {Error} error - Error object\r\n   * @private\r\n   */\r\n  _handleSaveError(error) {\r\n    console.error('[SaveHandler] ❌ Save failed:', error);\r\n\r\n    const detailMessages = [];\r\n    if (Array.isArray(error.validationErrors) && error.validationErrors.length > 0) {\r\n      error.validationErrors.slice(0, 3).forEach((item) => {\r\n        if (item?.error) {\r\n          detailMessages.push(`• ${item.error}`);\r\n        }\r\n      });\r\n      if (error.validationErrors.length > 3) {\r\n        detailMessages.push(`(+${error.validationErrors.length - 3} lagi)`);\r\n      }\r\n    }\r\n\r\n    if (Array.isArray(error.details) && error.details.length > 0) {\r\n      error.details.slice(0, 3).forEach((item) => {\r\n        if (item?.error) {\r\n          detailMessages.push(`• ${item.error}`);\r\n        }\r\n      });\r\n      if (error.details.length > 3) {\r\n        detailMessages.push(`(+${error.details.length - 3} lagi)`);\r\n      }\r\n    }\r\n\r\n    let message = `Gagal menyimpan: ${error.message}`;\r\n    if (detailMessages.length > 0) {\r\n      message += `\\n${detailMessages.join('\\n')}`;\r\n    }\r\n    this.showToast(message, 'danger', 5000);\r\n\r\n    // Call error callback\r\n    if (typeof this.onError === 'function') {\r\n      this.onError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the current mode's state object\r\n   * @returns {Object} Current mode state (plannedState or actualState)\r\n   * @private\r\n   */\r\n  _getCurrentModeState() {\r\n    // Phase 2E.1: Support dual state architecture\r\n    const progressMode = this.state.progressMode || 'planned';\r\n    return progressMode === 'actual'\r\n      ? this.state.actualState\r\n      : this.state.plannedState;\r\n  }\r\n\r\n  /**\r\n   * Update assignmentMap with modified values\r\n   * Phase 0.3: Delegate to StateManager.commitChanges()\r\n   * @private\r\n   */\r\n  _updateAssignmentMap() {\r\n    // Phase 0.3: StateManager handles moving modifiedCells → assignmentMap\r\n    this.stateManager.commitChanges();\r\n\r\n    const progressMode = this.state.progressMode || 'planned';\r\n    const stats = this.stateManager.states[progressMode].getStats();\r\n    console.log(`[SaveHandler] Phase 0.3: StateManager committed changes for ${progressMode.toUpperCase()}`);\r\n    console.log(`[SaveHandler] New state: ${stats.assignmentCount} assignments, ${stats.modifiedCount} modified`);\r\n  }\r\n\r\n  _hasCostChanges() {\r\n    const progressMode = this.state?.progressMode || 'planned';\r\n    if (progressMode !== 'actual') {\r\n      return false;\r\n    }\r\n    const costMap = this.state.costModifiedCells;\r\n    return costMap instanceof Map ? costMap.size > 0 : false;\r\n  }\r\n\r\n  _getSavedValue(cellKey) {\r\n    const assignmentMap = this.state.assignmentMap;\r\n    if (!assignmentMap) {\r\n      return 0;\r\n    }\r\n    if (assignmentMap instanceof Map) {\r\n      return Number(assignmentMap.get(cellKey)) || 0;\r\n    }\r\n    if (typeof assignmentMap === 'object' && assignmentMap !== null) {\r\n      return Number(assignmentMap[cellKey]) || 0;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  // =======================================================================\r\n  // UTILITY METHODS\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Check if there are unsaved changes\r\n   * Phase 0.3: Delegate to StateManager\r\n   * @returns {boolean} True if has unsaved changes\r\n   */\r\n  hasUnsavedChanges() {\r\n    return this.stateManager.hasUnsavedChanges();\r\n  }\r\n\r\n  /**\r\n   * Get count of modified cells\r\n   * Phase 0.3: Delegate to StateManager\r\n   * @returns {number} Number of modified cells\r\n   */\r\n  getModifiedCount() {\r\n    const mode = this.state.progressMode || 'planned';\r\n    return this.stateManager.states[mode].modifiedCells.size;\r\n  }\r\n\r\n  /**\r\n   * Validate payload before sending\r\n   * @param {Object} payload - Payload to validate\r\n   * @returns {Object} Validation result\r\n   */\r\n  validatePayload(payload) {\r\n    const errors = [];\r\n    const warnings = [];\r\n\r\n    const assignments = Array.isArray(payload?.assignments)\r\n      ? payload.assignments\r\n      : Array.isArray(payload?.items)\r\n        ? payload.items\r\n        : null;\r\n\r\n    if (!assignments) {\r\n      errors.push('Invalid payload structure');\r\n      return { isValid: false, errors, warnings };\r\n    }\r\n\r\n    if (assignments.length === 0) {\r\n      warnings.push('No items to save');\r\n    }\r\n\r\n    // Validate each item\r\n    assignments.forEach((item, index) => {\r\n      if (!item.pekerjaan_id) {\r\n        errors.push(`Item ${index}: Missing pekerjaan_id`);\r\n      }\r\n      if (!item.week_number) {\r\n        warnings.push(`Item ${index}: Missing week_number (akan memakai default)`);\r\n      }\r\n      if (typeof item.proportion === 'undefined') {\r\n        errors.push(`Item ${index}: Missing proportion value`);\r\n      } else if (!Number.isFinite(item.proportion)) {\r\n        errors.push(`Item ${index}: Invalid proportion value`);\r\n      } else if (item.proportion < 0 || item.proportion > 100) {\r\n        warnings.push(`Item ${index}: Proportion out of range (${item.proportion}%)`);\r\n      }\r\n    });\r\n\r\n    const isValid = errors.length === 0;\r\n\r\n    if (!isValid) {\r\n      console.error('[SaveHandler] Payload validation failed:', errors);\r\n    }\r\n\r\n    if (warnings.length > 0) {\r\n      console.warn('[SaveHandler] Payload validation warnings:', warnings);\r\n    }\r\n\r\n    return { isValid, errors, warnings };\r\n  }\r\n\r\n  /**\r\n   * Cancel save operation\r\n   */\r\n  cancel() {\r\n    if (this.isSaving) {\r\n      console.log('[SaveHandler] Cancelling save operation...');\r\n      this.isSaving = false;\r\n      // Note: Cannot actually abort fetch request without AbortController\r\n      // This just sets the flag\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get save statistics\r\n   * @returns {Object} Save statistics\r\n   */\r\n  getStats() {\r\n    return {\r\n      modifiedCells: this.getModifiedCount(),\r\n      isSaving: this.isSaving,\r\n      hasUnsavedChanges: this.hasUnsavedChanges(),\r\n      apiUrl: this.apiUrl\r\n    };\r\n  }\r\n}\r\n\r\n// Export utility functions\r\nexport {\r\n  getCookie\r\n};\r\n"],"names":["ModeState","constructor","this","assignmentMap","Map","modifiedCells","costAssignmentMap","costModifiedCells","isDirty","toJSON","Array","from","entries","fromJSON","data","state","isArray","getStats","assignmentCount","size","modifiedCount","costAssignmentCount","costModifiedCount","hasUnsavedChanges","clear","clone","cloned","LOG_PREFIX","_StateManager","getInstance","instance","console","log","Error","currentMode","states","planned","actual","_mergedCellsCache","_listeners","Set","flatPekerjaan","timeColumns","_chartDataCache","projectId","getCellValue","pekerjaanId","columnId","_a","_b","_getCurrentState","cellKey","get","getAllCellsForMode","mode","modeState","error","cacheKey","has","merged","forEach","value","key","set","toUpperCase","setCellValue","numericValue","parseFloat","Number","isNaN","warn","_invalidateCache","switchMode","newMode","oldMode","_notifyListeners","type","commitChanges","delete","numeric","isFinite","count","invalidateChartCache","loadData","dataMap","costDataMap","setFlatPekerjaan","rows","length","getFlatPekerjaan","setTimeColumns","columns","getTimeColumns","setInitialValue","plannedValue","actualValue","options","hasCostProp","Object","prototype","hasOwnProperty","call","actualCost","cost","actual_cost","addEventListener","callback","add","removeEventListener","cacheSize","listenerCount","event","listener","reset","fetchChartData","timescale","__async","response","fetch","method","headers","Accept","credentials","ok","status","json","getChartData","keys","startsWith","setProjectId","exportState","stats","StateManager","window","formatDayMonth","date","Date","getTime","getDate","toString","padStart","getMonth","TimeColumnGenerator","generate","_projectStartCache","_jsWeekEndDayCache","timeScale","tahapanList","tahap","index","shouldInclude","is_auto_generated","generation_mode","column","_createColumn","push","e","message","startDate","tanggal_mulai","endDate","tanggal_selesai","label","nama","rangeLabel","rangeText","tooltip","weekNumber","shortStart","shortEnd","resolvedOrder","isInteger","urutan","isWeeklyMode","toLowerCase","projectStartDate","_getProjectStartDate","jsWeekEndDay","_getJsWeekEndDay","computedWeekNumber","targetDate","projectStart","resolvedWeekEnd","weekEndDay","firstWeekEnd","offsetToEnd","getDay","setDate","daysAfterFirst","Math","floor","getWeekNumberForDate","toLocaleDateString","weekday","day","month","year","safeTahapanId","tahapan_id","id","fieldId","tahapanId","isAutoGenerated","generationMode","getColumnById","find","col","getColumnByTahapanId","getColumnsInRange","filter","regenerate","raw","parsed","pyWeekEnd","normalizedPy","apiCall","_0","arguments","url","includes","name","cookieValue","document","cookie","cookies","split","i","trim","substring","decodeURIComponent","getCookie","__spreadValues","catch","deriveTimeScaleFromTahapan","fallbackMode","autoCounts","daily","weekly","monthly","autoTotal","manualCount","dominantMode","reduce","bestMode","entry","initialiseExpandedNodes","tree","expandedNodes","collectIds","nodes","node","children","flattenTree","result","DataLoader","stateManager","volumeMap","cache","cacheTTL","responseCache","tahapan","pekerjaan","volumes","assignments","responseCacheTimestamps","loadAllData","force","skipIfLoaded","initialLoadInProgress","info","initialLoadCompleted","initialLoadResult","Promise","all","loadTahapan","forceRefresh","loadPekerjaan","loadVolumes","loadAssignments","completedAt","now","tahapanCount","pekerjaanCount","initialLoadError","_isCacheValid","JSON","parse","stringify","detectedModeFromCache","apiBase","sort","a","b","detectedMode","_setCache","cachedTree","pekerjaanTree","klasifikasi","klas","klasNode","level","expanded","klasifikasiId","klasifikasiName","klasifikasiKode","kode","sub","subNode","subKlasifikasiId","subKlasifikasiName","subKlasifikasiKode","pkj","pkjNode","pekerjaan_id","snapshot_kode","snapshot_uraian","uraian","volume","satuan","snapshot_satuan","budgeted_cost","total_cost","klasifikasi_id","klasifikasi_name","klasifikasi_kode","sub_klasifikasi_id","sub_klasifikasi_name","sub_klasifikasi_kode","buildPekerjaanTree","pkjId","qty","items","v","quantity","pekerjaanNodes","_applyAssignmentsData","source","_loadAssignmentsViaV2","reload","loader","cacheType","timestamp","payload","clearCache","_buildWeekColumnIndex","weekColumnIndex","week_number","mapped","item","plannedProportion","planned_proportion","actualProportion","actual_proportion","rawCost","columnKey","sourceLabel","SaveHandler","apiUrl","onSuccess","onError","err","showToast","msg","dataLoader","isSaving","save","_c","_d","success","reason","hasCostChanges","_hasCostChanges","_buildPayload","payloadCount","_sendToServer","_handleSaveSuccess","_handleSaveError","progressMode","cellsToSave","_","proportion","_getSavedValue","parseInt","toFixed","tahapanPrimaryId","week_start","_formatDate","week_end","normalizedOrder","order","numericTahapan","fallbackWeek","costValue","project_id","week_end_day","toISOString","csrfToken","body","errorData","parsedBody","jsonError","text","errorMsg","errors","details","validation_errors","validationErrors","_e","pendingModifiedCount","_updateAssignmentMap","cellVolumeOverrides","apiSavedTotal","created_count","updated_count","fallbackSaved","saved_count","savedCount","detailMessages","slice","join","_getCurrentModeState","actualState","plannedState","costMap","getModifiedCount","validatePayload","warnings","isValid","cancel"],"mappings":"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"}