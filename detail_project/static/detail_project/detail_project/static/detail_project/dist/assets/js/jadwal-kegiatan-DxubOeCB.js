var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,n=(e,n)=>{for(var o in n||(n={}))a.call(n,o)&&i(e,o,n[o]);if(t)for(var o of t(n))s.call(n,o)&&i(e,o,n[o]);return e},o=(e,t,a)=>new Promise((s,i)=>{var n=e=>{try{r(a.next(e))}catch(t){i(t)}},o=e=>{try{r(a.throw(e))}catch(t){i(t)}},r=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,o);r((a=a.apply(e,t)).next())});import{_ as r}from"./vendor-export-CxtsESY6.js";import{a as l,A as d,G as h,u as c}from"./grid-modules-B7d76Eao.js";import{S as u,T as g,D as p,a as m}from"./core-modules-DWAA-Xbs.js";import"./vendor-ag-grid-CNpf5Dvm.js";class w{constructor(e){this.id=e.id,this.name=e.name,this.expanded=void 0===e.expanded||e.expanded,this.visible=!0,this.level=0,this.parentId=null}toggleExpand(){return this.expanded=!this.expanded,this.expanded}isLeaf(){return!1}}class f{constructor(e={}){this.startDate=e.startDate?new Date(e.startDate):null,this.endDate=e.endDate?new Date(e.endDate):null,this.progress=e.progress||0,this.duration=e.duration||0}calculateDuration(){if(!this.startDate||!this.endDate)return 0;const e=Math.abs(this.endDate-this.startDate);return Math.ceil(e/864e5)}isValid(){return this.startDate&&this.endDate&&this.startDate<=this.endDate}getProgressDate(){if(!this.isValid()||0===this.progress)return this.startDate;const e=this.calculateDuration(),t=Math.floor(e*this.progress/100),a=new Date(this.startDate);return a.setDate(a.getDate()+t),a}}class y extends w{constructor(e){super(e),this.type="pekerjaan",this.kode=e.kode||"",this.planned=new f({startDate:e.tgl_mulai_rencana,endDate:e.tgl_selesai_rencana,progress:e.progress_rencana||0}),this.actual=new f({startDate:e.tgl_mulai_realisasi,endDate:e.tgl_selesai_realisasi,progress:e.progress_realisasi||0}),this.status=this._calculateStatus(),this.volume=e.volume||0,this.satuan=e.satuan||"",this.subKlasifikasiId=e.sub_klasifikasi_id,this.klasifikasiId=e.klasifikasi_id}_calculateStatus(){const e=new Date;return this.actual.startDate?100===this.actual.progress?"complete":this.actual.startDate<=e?this.actual.progress<this.planned.progress?"delayed":"in-progress":"not-started":"not-started"}updateStatus(){this.status=this._calculateStatus()}isLeaf(){return!0}getStartDate(){const e=[this.planned.startDate,this.actual.startDate].filter(e=>e);return 0===e.length?null:new Date(Math.min(...e))}getEndDate(){const e=[this.planned.endDate,this.actual.endDate].filter(e=>e);return 0===e.length?null:new Date(Math.max(...e))}}class v extends w{constructor(e){super(e),this.type="sub-klasifikasi",this.kode=e.kode||"",this.pekerjaan=[],this.klasifikasiId=e.klasifikasi_id,this.level=2}addPekerjaan(e){e.level=3,e.parentId=this.id,this.pekerjaan.push(e)}getPekerjaan(){return this.pekerjaan}getPekerjaanCount(){return this.pekerjaan.length}getAggregatedProgress(e="planned"){if(0===this.pekerjaan.length)return 0;const t=this.pekerjaan.reduce((t,a)=>t+("planned"===e?a.planned.progress:a.actual.progress),0);return Math.round(t/this.pekerjaan.length)}getDateRange(){if(0===this.pekerjaan.length)return{start:null,end:null};const e=this.pekerjaan.map(e=>e.getStartDate()).filter(e=>e),t=this.pekerjaan.map(e=>e.getEndDate()).filter(e=>e);return{start:e.length>0?new Date(Math.min(...e)):null,end:t.length>0?new Date(Math.max(...t)):null}}isLeaf(){return 0===this.pekerjaan.length}}class _ extends w{constructor(e){super(e),this.type="klasifikasi",this.kode=e.kode||"",this.subKlasifikasi=[],this.level=1}addSubKlasifikasi(e){e.level=2,e.parentId=this.id,this.subKlasifikasi.push(e)}getSubKlasifikasi(){return this.subKlasifikasi}getAllPekerjaan(){return this.subKlasifikasi.flatMap(e=>e.getPekerjaan())}getTotalPekerjaanCount(){return this.subKlasifikasi.reduce((e,t)=>e+t.getPekerjaanCount(),0)}getAggregatedProgress(e="planned"){const t=this.getAllPekerjaan();if(0===t.length)return 0;const a=t.reduce((t,a)=>t+("planned"===e?a.planned.progress:a.actual.progress),0);return Math.round(a/t.length)}getDateRange(){if(0===this.subKlasifikasi.length)return{start:null,end:null};const e=this.subKlasifikasi.map(e=>e.getDateRange()),t=e.map(e=>e.start).filter(e=>e),a=e.map(e=>e.end).filter(e=>e);return{start:t.length>0?new Date(Math.min(...t)):null,end:a.length>0?new Date(Math.max(...a)):null}}isLeaf(){return 0===this.subKlasifikasi.length}}class k{constructor(e){this.id=e.id||this._generateId(),this.date=new Date(e.date),this.title=e.title||"",this.description=e.description||"",this.color=e.color||"#ff6b6b",this.icon=e.icon||"üìç",this.comments=e.comments||[],this.linkedPekerjaan=e.linkedPekerjaan||[],this.createdAt=e.createdAt?new Date(e.createdAt):new Date,this.createdBy=e.createdBy||""}_generateId(){return`milestone_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}addComment(e){this.comments.push({id:`comment_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,text:e.text,author:e.author||"",timestamp:new Date})}removeComment(e){this.comments=this.comments.filter(t=>t.id!==e)}linkPekerjaan(e){this.linkedPekerjaan.includes(e)||this.linkedPekerjaan.push(e)}unlinkPekerjaan(e){this.linkedPekerjaan=this.linkedPekerjaan.filter(t=>t!==e)}}class b{constructor(e){this.projectId=e.project_id,this.projectName=e.project_name||"",this.startDate=new Date(e.start_date),this.endDate=new Date(e.end_date),this.currentDate=new Date}getDuration(){const e=Math.abs(this.endDate-this.startDate);return Math.ceil(e/864e5)}getTimeProgress(){const e=this.endDate-this.startDate,t=this.currentDate-this.startDate;return Math.round(t/e*100)}}class S{constructor(){this.klasifikasi=[],this.milestones=[],this.projectMeta=null,this._flattenedNodes=null,this._nodeIndex=new Map}initialize(e){console.log("üìä Initializing Gantt Data Model..."),this.projectMeta=new b(e.project),this._buildHierarchy(e.data),e.milestones&&(this.milestones=e.milestones.map(e=>new k(e))),this._buildNodeIndex(),console.log(`‚úÖ Gantt Data Model initialized: ${this.klasifikasi.length} klasifikasi, ${this.getTotalPekerjaanCount()} pekerjaan`)}_buildHierarchy(e){const t=new Map,a=new Map;e.forEach(e=>{if(t.has(e.klasifikasi_id)||t.set(e.klasifikasi_id,new _({id:e.klasifikasi_id,name:e.klasifikasi_name,kode:e.klasifikasi_kode})),!a.has(e.sub_klasifikasi_id)){const t=new v({id:e.sub_klasifikasi_id,name:e.sub_klasifikasi_name,kode:e.sub_klasifikasi_kode,klasifikasi_id:e.klasifikasi_id});a.set(e.sub_klasifikasi_id,t)}const s=new y({id:e.pekerjaan_id,name:e.pekerjaan_name,kode:e.pekerjaan_kode,tgl_mulai_rencana:e.tgl_mulai_rencana,tgl_selesai_rencana:e.tgl_selesai_rencana,tgl_mulai_realisasi:e.tgl_mulai_realisasi,tgl_selesai_realisasi:e.tgl_selesai_realisasi,progress_rencana:e.progress_rencana,progress_realisasi:e.progress_realisasi,volume:e.volume,satuan:e.satuan,sub_klasifikasi_id:e.sub_klasifikasi_id,klasifikasi_id:e.klasifikasi_id});a.get(e.sub_klasifikasi_id).addPekerjaan(s)}),a.forEach(e=>{const a=t.get(e.klasifikasiId);a&&a.addSubKlasifikasi(e)}),this.klasifikasi=Array.from(t.values())}_buildNodeIndex(){this._nodeIndex.clear(),this.klasifikasi.forEach(e=>{this._nodeIndex.set(e.id,e),e.getSubKlasifikasi().forEach(e=>{this._nodeIndex.set(e.id,e),e.getPekerjaan().forEach(e=>{this._nodeIndex.set(e.id,e)})})})}getNodeById(e){return this._nodeIndex.get(e)}getFlattenedTree(){const e=[];return this.klasifikasi.forEach(t=>{e.push(t),t.expanded&&t.getSubKlasifikasi().forEach(t=>{e.push(t),t.expanded&&t.getPekerjaan().forEach(t=>{e.push(t)})})}),e}toggleNode(e){const t=this.getNodeById(e);return t&&!t.isLeaf()?(t.toggleExpand(),this._flattenedNodes=null,t.expanded):null}getTotalPekerjaanCount(){return this.klasifikasi.reduce((e,t)=>e+t.getTotalPekerjaanCount(),0)}getProjectDateRange(){return this.projectMeta?{start:this.projectMeta.startDate,end:this.projectMeta.endDate}:{start:null,end:null}}addMilestone(e){const t=new k(e);return this.milestones.push(t),t}removeMilestone(e){this.milestones=this.milestones.filter(t=>t.id!==e)}getMilestoneById(e){return this.milestones.find(t=>t.id===e)}getMilestonesInRange(e,t){return this.milestones.filter(a=>a.date>=e&&a.date<=t)}searchNodes(e){const t=e.toLowerCase(),a=[];return this.klasifikasi.forEach(e=>{(e.name.toLowerCase().includes(t)||e.kode.toLowerCase().includes(t))&&a.push(e),e.getSubKlasifikasi().forEach(e=>{(e.name.toLowerCase().includes(t)||e.kode.toLowerCase().includes(t))&&a.push(e),e.getPekerjaan().forEach(e=>{(e.name.toLowerCase().includes(t)||e.kode.toLowerCase().includes(t))&&a.push(e)})})}),a}toJSON(){return{klasifikasi:this.klasifikasi,milestones:this.milestones,projectMeta:this.projectMeta}}}class M{constructor(){this.shortcuts=new Map,this.enabled=!0,this._boundHandler=this._handleKeyDown.bind(this),this.init()}init(){document.addEventListener("keydown",this._boundHandler),console.log("‚å®Ô∏è Keyboard shortcuts initialized")}register(e,t,a={}){const{description:s="",preventDefault:i=!0}=a;this.shortcuts.set(e.toLowerCase(),{callback:t,description:s,preventDefault:i})}unregister(e){this.shortcuts.delete(e.toLowerCase())}_handleKeyDown(e){if(!this.enabled)return;const t=document.activeElement,a="INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable,s=[];e.ctrlKey&&s.push("ctrl"),e.altKey&&s.push("alt"),e.shiftKey&&s.push("shift"),e.metaKey&&s.push("meta");const i=e.key.toLowerCase();["control","alt","shift","meta"].includes(i)||s.push(i);const n=s.join("+"),o=this.shortcuts.get(n);if(o){if(a&&!["ctrl+a","ctrl+c","ctrl+v","ctrl+x","ctrl+z"].includes(n))return;o.preventDefault&&e.preventDefault(),o.callback(e),console.log(`‚å®Ô∏è Shortcut triggered: ${n}`)}}enable(){this.enabled=!0}disable(){this.enabled=!1}getShortcuts(){return Array.from(this.shortcuts.entries()).map(([e,t])=>({key:e,description:t.description}))}destroy(){document.removeEventListener("keydown",this._boundHandler),this.shortcuts.clear()}}class C{static add(e){e&&(e.classList.add("btn-ripple"),e.addEventListener("click",function(e){const t=document.createElement("span");t.classList.add("ripple-circle");const a=this.getBoundingClientRect(),s=Math.max(a.width,a.height),i=e.clientX-a.left-s/2,n=e.clientY-a.top-s/2;t.style.width=t.style.height=s+"px",t.style.left=i+"px",t.style.top=n+"px",this.appendChild(t),setTimeout(()=>t.remove(),600)}))}static addToAll(e){document.querySelectorAll(e).forEach(e=>{C.add(e)})}}class T{static setLoading(e,t="Loading..."){if(!e)return;e.dataset.originalText=e.innerHTML,e.disabled=!0,e.classList.add("loading");e.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>'+t}static setSuccess(e,t=2e3){e&&(e.disabled=!1,e.classList.remove("loading"),e.classList.add("success"),e.dataset.originalText&&(e.innerHTML=e.dataset.originalText),setTimeout(()=>{e.classList.remove("success")},t))}static setError(e,t=2e3){e&&(e.disabled=!1,e.classList.remove("loading"),e.classList.add("error"),e.dataset.originalText&&(e.innerHTML=e.dataset.originalText),setTimeout(()=>{e.classList.remove("error")},t))}static reset(e){e&&(e.disabled=!1,e.classList.remove("loading","success","error"),e.dataset.originalText&&(e.innerHTML=e.dataset.originalText))}static markChanges(e,t){e&&(t?(e.classList.add("has-changes"),e.setAttribute("data-tooltip","You have unsaved changes")):(e.classList.remove("has-changes"),e.removeAttribute("data-tooltip")))}}class E{static success(e,t=1600){var a,s;(null==(s=null==(a=window.DP)?void 0:a.core)?void 0:s.toast)?window.DP.core.toast.show(e,"success",t):console.log(`‚úÖ ${e}`)}static error(e,t=3e3){var a,s;(null==(s=null==(a=window.DP)?void 0:a.core)?void 0:s.toast)?window.DP.core.toast.show(e,"danger",t):console.error(`‚ùå ${e}`)}static warning(e,t=2e3){var a,s;(null==(s=null==(a=window.DP)?void 0:a.core)?void 0:s.toast)?window.DP.core.toast.show(e,"warning",t):console.warn(`‚ö†Ô∏è ${e}`)}static info(e,t=1600){var a,s;(null==(s=null==(a=window.DP)?void 0:a.core)?void 0:s.toast)?window.DP.core.toast.show(e,"info",t):console.info(`‚ÑπÔ∏è ${e}`)}}class R{constructor(e,t,a={}){this.container=e,this.dataModel=t,this.options=n({width:a.width||"30%",minWidth:a.minWidth||250,maxWidth:a.maxWidth||500,showSearch:!1!==a.showSearch,showStats:!1!==a.showStats,mode:a.mode||"planned"},a),this.state={searchText:"",selectedNodeId:null,hoveredNodeId:null,scrollTop:0},this.onNodeClick=a.onNodeClick||(()=>{}),this.onNodeExpand=a.onNodeExpand||(()=>{}),this.onSearchChange=a.onSearchChange||(()=>{}),this.elements={},this.init()}init(){console.log("üå≥ Initializing Tree Panel..."),this._buildDOM(),this._attachEventListeners(),this.render(),console.log("‚úÖ Tree Panel initialized")}_buildDOM(){if(this.container.innerHTML="",this.container.className="gantt-tree-panel",this.options.showSearch){const e=document.createElement("div");e.className="tree-panel-header",e.innerHTML='\n        <div class="tree-search-container">\n          <input\n            type="text"\n            class="tree-search-input"\n            placeholder="Search tasks..."\n            aria-label="Search tasks"\n          />\n          <i class="bi bi-search tree-search-icon"></i>\n        </div>\n      ',this.container.appendChild(e),this.elements.searchInput=e.querySelector(".tree-search-input")}if(this.options.showStats){const e=document.createElement("div");e.className="tree-stats-bar",this.container.appendChild(e),this.elements.statsBar=e}const e=document.createElement("div");e.className="tree-content",this.container.appendChild(e),this.elements.treeContent=e;const t=document.createElement("div");t.className="tree-resize-handle",t.setAttribute("aria-label","Resize tree panel"),this.container.appendChild(t),this.elements.resizeHandle=t}_attachEventListeners(){if(this.elements.searchInput){const e=function(e,t=300){let a;return function(...s){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),e(...s)},t)}}(e=>{this.state.searchText=e,this.onSearchChange(e),this.render()},300);this.elements.searchInput.addEventListener("input",t=>{e(t.target.value)})}this.elements.treeContent.addEventListener("click",e=>{this._handleTreeClick(e)}),this.elements.treeContent.addEventListener("mouseenter",e=>{if(e.target.classList.contains("tree-node-row")){const t=e.target.dataset.nodeId;this.state.hoveredNodeId=t,this._highlightRow(t)}},!0),this.elements.treeContent.addEventListener("mouseleave",e=>{e.target.classList.contains("tree-node-row")&&(this.state.hoveredNodeId=null,this._unhighlightRow(e.target.dataset.nodeId))},!0),this._setupResizeHandle(),this.elements.treeContent.addEventListener("scroll",()=>{this.state.scrollTop=this.elements.treeContent.scrollTop})}_handleTreeClick(e){const t=e.target;if(t.classList.contains("tree-expand-btn")){const e=t.closest(".tree-node-row").dataset.nodeId;return void this._toggleNode(e)}if(t.classList.contains("tree-node-row")||t.closest(".tree-node-row")){const e=(t.classList.contains("tree-node-row")?t:t.closest(".tree-node-row")).dataset.nodeId;return void this._selectNode(e)}}_toggleNode(e){const t=this.dataModel.toggleNode(e);this.onNodeExpand(e,t),this.render()}_selectNode(e){this.state.selectedNodeId=e,this.onNodeClick(e),this.render()}_highlightRow(e){const t=this.elements.treeContent.querySelector(`[data-node-id="${e}"]`);t&&t.classList.add("hovered")}_unhighlightRow(e){const t=this.elements.treeContent.querySelector(`[data-node-id="${e}"]`);t&&t.classList.remove("hovered")}_setupResizeHandle(){let e=!1,t=0,a=0;this.elements.resizeHandle.addEventListener("mousedown",s=>{e=!0,t=s.clientX,a=this.container.offsetWidth,document.body.style.cursor="col-resize",s.preventDefault()}),document.addEventListener("mousemove",s=>{if(!e)return;const i=s.clientX-t,n=a+i;n>=this.options.minWidth&&n<=this.options.maxWidth&&(this.container.style.width=n+"px")}),document.addEventListener("mouseup",()=>{e&&(e=!1,document.body.style.cursor="")})}render(){this.elements.statsBar&&this._renderStats(),this._renderTree()}_renderStats(){const e=this.dataModel.getTotalPekerjaanCount(),t=this.dataModel.klasifikasi.length;let a=0,s=0;this.dataModel.klasifikasi.forEach(e=>{const t=e.getAggregatedProgress(this.options.mode);t>0&&(a+=t,s++)});const i=s>0?Math.round(a/s):0;this.elements.statsBar.innerHTML=`\n      <div class="tree-stat">\n        <i class="bi bi-diagram-3"></i>\n        <span>${t} Categories</span>\n      </div>\n      <div class="tree-stat">\n        <i class="bi bi-list-check"></i>\n        <span>${e} Tasks</span>\n      </div>\n      <div class="tree-stat">\n        <i class="bi bi-graph-up"></i>\n        <span>${i}% Complete</span>\n      </div>\n    `}_renderTree(){const e=this.dataModel.getFlattenedTree(),t=(this.state.searchText.length>0?this._filterNodesBySearch(e):e).map(e=>this._renderNode(e)).join("");this.elements.treeContent.innerHTML=t,this.elements.treeContent.scrollTop=this.state.scrollTop}_filterNodesBySearch(e){const t=this.state.searchText.toLowerCase();return e.filter(e=>e.name.toLowerCase().includes(t)||e.kode.toLowerCase().includes(t))}_renderNode(e){const t=this.state.selectedNodeId===e.id,a=20*(e.level-1);let s="",i="",n="";switch(e.type){case"klasifikasi":s='<i class="bi bi-folder2"></i>';break;case"sub-klasifikasi":s='<i class="bi bi-folder"></i>';break;case"pekerjaan":s=this._getStatusIcon(e.status)}if(e.isLeaf())i='<span class="tree-expand-spacer"></span>';else{const t=e.expanded?"chevron-down":"chevron-right";i=`\n        <button class="tree-expand-btn" aria-label="${e.expanded?"Collapse":"Expand"}">\n          <i class="bi bi-${t}"></i>\n        </button>\n      `}if("pekerjaan"!==e.type){const t=e.getAggregatedProgress(this.options.mode);n=`\n        <span class="tree-progress-badge ${this._getProgressClass(t)}">\n          ${t}%\n        </span>\n      `}else{const t="planned"===this.options.mode?e.planned.progress:e.actual.progress;n=`\n        <span class="tree-progress-badge ${this._getProgressClass(t)}">\n          ${t}%\n        </span>\n      `}return`\n      <div\n        class="tree-node-row level-${e.level} ${t?"selected":""} ${e.type}"\n        data-node-id="${e.id}"\n        data-node-type="${e.type}"\n        style="padding-left: ${a}px"\n      >\n        ${i}\n        <span class="tree-node-icon">${s}</span>\n        <span class="tree-node-label">\n          ${e.kode?`<span class="tree-node-kode">${e.kode}</span>`:""}\n          <span class="tree-node-name">${this._highlightSearch(e.name)}</span>\n        </span>\n        ${n}\n      </div>\n    `}_getStatusIcon(e){const t={"not-started":'<i class="bi bi-circle text-muted"></i>',"in-progress":'<i class="bi bi-play-circle text-primary"></i>',complete:'<i class="bi bi-check-circle text-success"></i>',delayed:'<i class="bi bi-exclamation-circle text-danger"></i>'};return t[e]||t["not-started"]}_getProgressClass(e){return 0===e?"progress-none":e<25?"progress-low":e<50?"progress-medium":e<75?"progress-high":e<100?"progress-very-high":"progress-complete"}_highlightSearch(e){if(!this.state.searchText)return e;const t=new RegExp(`(${this.state.searchText})`,"gi");return e.replace(t,"<mark>$1</mark>")}setMode(e){this.options.mode=e,this.render()}scrollToNode(e){const t=this.elements.treeContent.querySelector(`[data-node-id="${e}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),this._selectNode(e))}expandAll(){this.dataModel.klasifikasi.forEach(e=>{e.expanded=!0,e.getSubKlasifikasi().forEach(e=>{e.expanded=!0})}),this.render()}collapseAll(){this.dataModel.klasifikasi.forEach(e=>{e.expanded=!1}),this.render()}getSelectedNode(){return this.dataModel.getNodeById(this.state.selectedNodeId)}getScrollTop(){return this.state.scrollTop}setScrollTop(e){this.state.scrollTop=e,this.elements.treeContent.scrollTop=e}destroy(){this.container.innerHTML="",console.log("üóëÔ∏è Tree Panel destroyed")}}class D{constructor(e,t,a={}){this.container=e,this.dataModel=t,this.options=n({rowHeight:a.rowHeight||40,barHeight:a.barHeight||24,barPadding:a.barPadding||8,zoom:a.zoom||"month",mode:a.mode||"planned",showGrid:!1!==a.showGrid,showToday:!1!==a.showToday,showMilestones:!1!==a.showMilestones},a),this.canvas={scale:null,timeline:null,scaleCtx:null,timelineCtx:null,pixelsPerDay:1,totalWidth:0,totalHeight:0,visibleNodes:[]},this.dateRange={start:null,end:null,totalDays:0},this.scrollState={x:0,y:0},this.onBarClick=a.onBarClick||(()=>{}),this.onMilestoneClick=a.onMilestoneClick||(()=>{}),this.onScroll=a.onScroll||(()=>{}),this.colors={planned:{fill:"rgba(13, 110, 252, 0.2)",stroke:"#0d6efd",progress:"rgba(13, 110, 252, 0.5)"},actual:{fill:"rgba(25, 135, 84, 0.8)",stroke:"#198754",progress:"#198754"},grid:"#e9ecef",today:"#dc3545",text:"#212529",textSecondary:"#6c757d"},this._animationFrameId=null,this._renderPending=!1,this.init()}init(){console.log("üìÖ Initializing Timeline Panel..."),this._buildDOM(),this._setupCanvas(),this._calculateDateRange(),this._attachEventListeners(),this.render(),console.log("‚úÖ Timeline Panel initialized")}_buildDOM(){this.container.innerHTML="",this.container.className="gantt-timeline-panel";const e=document.createElement("div");e.className="timeline-header",e.innerHTML='\n      <div class="timeline-toolbar">\n        <div class="timeline-toolbar-group">\n          <span class="timeline-toolbar-label">Zoom:</span>\n          <button class="timeline-zoom-btn" data-zoom="day">Day</button>\n          <button class="timeline-zoom-btn" data-zoom="week">Week</button>\n          <button class="timeline-zoom-btn active" data-zoom="month">Month</button>\n          <button class="timeline-zoom-btn" data-zoom="quarter">Quarter</button>\n        </div>\n        <div class="timeline-toolbar-group">\n          <button class="btn btn-sm btn-outline-primary" id="timeline-fit-btn">\n            <i class="bi bi-arrows-angle-contract"></i> Fit to Screen\n          </button>\n        </div>\n        <div class="timeline-toolbar-group">\n          <button class="btn btn-sm btn-outline-secondary" id="timeline-today-btn">\n            <i class="bi bi-calendar-check"></i> Today\n          </button>\n        </div>\n      </div>\n      <div class="timeline-scale">\n        <canvas class="timeline-scale-canvas"></canvas>\n      </div>\n    ',this.container.appendChild(e);const t=document.createElement("div");t.className="timeline-content",t.innerHTML='\n      <div class="timeline-canvas-wrapper">\n        <canvas class="timeline-canvas"></canvas>\n      </div>\n    ',this.container.appendChild(t),this.elements={header:e,toolbar:e.querySelector(".timeline-toolbar"),scaleCanvas:e.querySelector(".timeline-scale-canvas"),content:t,timelineCanvas:t.querySelector(".timeline-canvas")}}_setupCanvas(){this.canvas.scale=this.elements.scaleCanvas,this.canvas.timeline=this.elements.timelineCanvas,this.canvas.scaleCtx=this.canvas.scale.getContext("2d"),this.canvas.timelineCtx=this.canvas.timeline.getContext("2d"),this._setupHighDPICanvas(this.canvas.scale,this.canvas.scaleCtx),this._setupHighDPICanvas(this.canvas.timeline,this.canvas.timelineCtx)}_setupHighDPICanvas(e,t){const a=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*a,e.height=s.height*a,e.style.width=s.width+"px",e.style.height=s.height+"px",t.scale(a,a)}_calculateDateRange(){const e=this.dataModel.getProjectDateRange();e.start&&e.end?(this.dateRange.start=new Date(e.start),this.dateRange.end=new Date(e.end)):(this.dateRange.start=new Date,this.dateRange.end=new Date,this.dateRange.end.setFullYear(this.dateRange.end.getFullYear()+1));const t=.1*(this.dateRange.end-this.dateRange.start);this.dateRange.start=new Date(this.dateRange.start.getTime()-t),this.dateRange.end=new Date(this.dateRange.end.getTime()+t);const a=Math.abs(this.dateRange.end-this.dateRange.start);this.dateRange.totalDays=Math.ceil(a/864e5),console.log(`üìÖ Date range: ${this.dateRange.start.toLocaleDateString()} - ${this.dateRange.end.toLocaleDateString()} (${this.dateRange.totalDays} days)`)}_attachEventListeners(){this.elements.toolbar.querySelectorAll(".timeline-zoom-btn").forEach(e=>{e.addEventListener("click",()=>{this._setZoom(e.dataset.zoom)})});const e=this.elements.toolbar.querySelector("#timeline-fit-btn");e&&e.addEventListener("click",()=>this._fitToScreen());const t=this.elements.toolbar.querySelector("#timeline-today-btn");t&&t.addEventListener("click",()=>this._scrollToToday()),this.canvas.timeline.addEventListener("click",e=>{this._handleCanvasClick(e)}),this.elements.content.addEventListener("scroll",()=>{this.scrollState.x=this.elements.content.scrollLeft,this.scrollState.y=this.elements.content.scrollTop,this.onScroll(this.scrollState),this._scheduleRender()}),this.resizeObserver=new ResizeObserver(()=>{this._handleResize()}),this.resizeObserver.observe(this.container)}_setZoom(e){this.options.zoom=e,this.elements.toolbar.querySelectorAll(".timeline-zoom-btn").forEach(t=>{t.classList.toggle("active",t.dataset.zoom===e)}),this._calculatePixelsPerDay(),this._scheduleRender()}_calculatePixelsPerDay(){this.canvas.pixelsPerDay={day:40,week:8,month:2,quarter:.7}[this.options.zoom]||2,this.canvas.totalWidth=this.dateRange.totalDays*this.canvas.pixelsPerDay}_fitToScreen(){const e=this.elements.content.offsetWidth;this.canvas.pixelsPerDay=e/this.dateRange.totalDays,this.canvas.totalWidth=e,this.elements.toolbar.querySelectorAll(".timeline-zoom-btn").forEach(e=>{e.classList.remove("active")}),this._scheduleRender()}_scrollToToday(){const e=new Date,t=Math.floor((e-this.dateRange.start)/864e5)*this.canvas.pixelsPerDay-this.elements.content.offsetWidth/2;this.elements.content.scrollLeft=Math.max(0,t)}_handleCanvasClick(e){const t=this.canvas.timeline.getBoundingClientRect(),a=e.clientX-t.left+this.scrollState.x,s=e.clientY-t.top+this.scrollState.y,i=this._getMilestoneAtPoint(a,s);if(i)return void this.onMilestoneClick(i,e);const n=this._getBarAtPoint(a,s);n&&this.onBarClick(n.node,n.type,e)}_getMilestoneAtPoint(e,t){for(const a of this.dataModel.milestones){const s=this._dateToX(a.date),i=20;if(Math.sqrt(Math.pow(e-s,2)+Math.pow(t-i,2))<=12)return a}return null}_getBarAtPoint(e,t){const a=this.canvas.visibleNodes;for(let s=0;s<a.length;s++){const i=a[s],n=s*this.options.rowHeight;if(!(t<n||t>n+this.options.rowHeight)&&"pekerjaan"===i.type){const a=i.planned;if(a.isValid()){const s=this._dateToX(a.startDate),o=this._dateToX(a.endDate),r=n+this.options.barPadding,l=this.options.barHeight;if(e>=s&&e<=o&&t>=r&&t<=r+l)return{node:i,type:"planned"}}const s=i.actual;if(s.isValid()){const a=this._dateToX(s.startDate),o=this._dateToX(s.endDate),r=n+this.options.barPadding+this.options.barHeight/2-6;if(e>=a&&e<=o&&t>=r&&t<=r+12)return{node:i,type:"actual"}}}}return null}_handleResize(){this._setupHighDPICanvas(this.canvas.scale,this.canvas.scaleCtx),this._setupHighDPICanvas(this.canvas.timeline,this.canvas.timelineCtx),this._scheduleRender()}_scheduleRender(){this._renderPending||(this._renderPending=!0,this._animationFrameId=requestAnimationFrame(()=>{this.render(),this._renderPending=!1}))}render(){this._calculatePixelsPerDay(),this.canvas.visibleNodes=this.dataModel.getFlattenedTree(),this.canvas.totalHeight=this.canvas.visibleNodes.length*this.options.rowHeight,this.canvas.timeline.style.width=this.canvas.totalWidth+"px",this.canvas.timeline.style.height=this.canvas.totalHeight+"px",this._setupHighDPICanvas(this.canvas.timeline,this.canvas.timelineCtx),this.canvas.scale.style.width=this.canvas.totalWidth+"px",this._setupHighDPICanvas(this.canvas.scale,this.canvas.scaleCtx),this._renderScale(),this._renderTimeline()}_renderScale(){const e=this.canvas.scaleCtx,t=this.canvas.totalWidth,a=this.canvas.scale.offsetHeight;switch(e.clearRect(0,0,t,a),e.fillStyle="#f8f9fa",e.fillRect(0,0,t,a),this.options.zoom){case"day":this._renderDayScale(e);break;case"week":this._renderWeekScale(e);break;case"month":this._renderMonthScale(e);break;case"quarter":this._renderQuarterScale(e)}this.options.showMilestones&&this._renderMilestonesInScale(e)}_renderDayScale(e){const t=new Date(this.dateRange.start),a=new Date(this.dateRange.end);e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle";let s=new Date(t),i=null;for(;s<=a;){const t=this._dateToX(s);s.getMonth()!==i&&(i=s.getMonth(),e.strokeStyle="#dee2e6",e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,60),e.stroke(),e.fillStyle="#212529",e.font="bold 12px sans-serif",e.fillText(s.toLocaleDateString("en-US",{month:"short",year:"numeric"}),t+30,15)),e.fillStyle="#6c757d",e.font="10px sans-serif",e.fillText(s.getDate(),t+this.canvas.pixelsPerDay/2,45),e.strokeStyle="#e9ecef",e.lineWidth=1,e.beginPath(),e.moveTo(t,30),e.lineTo(t,60),e.stroke(),s.setDate(s.getDate()+1)}}_renderMonthScale(e){const t=new Date(this.dateRange.start),a=new Date(this.dateRange.end);e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle";let s=new Date(t);for(s.setDate(1);s<=a;){const t=this._dateToX(s);0===s.getMonth()&&(e.strokeStyle="#dee2e6",e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,60),e.stroke(),e.fillStyle="#212529",e.font="bold 12px sans-serif",e.fillText(s.getFullYear(),t+30,15)),e.fillStyle="#6c757d",e.font="11px sans-serif",e.fillText(s.toLocaleDateString("en-US",{month:"short"}),t+15,45),e.strokeStyle="#e9ecef",e.lineWidth=1,e.beginPath(),e.moveTo(t,30),e.lineTo(t,60),e.stroke(),s.setMonth(s.getMonth()+1)}}_renderWeekScale(e){this._renderMonthScale(e)}_renderQuarterScale(e){this._renderMonthScale(e)}_renderMilestonesInScale(e){this.dataModel.milestones.forEach(t=>{const a=this._dateToX(t.date);e.fillStyle=t.color,e.beginPath(),e.arc(a,20,12,0,2*Math.PI),e.fill(),e.fillStyle="white",e.font="14px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(t.icon,a,20)})}_renderTimeline(){const e=this.canvas.timelineCtx,t=this.canvas.totalWidth,a=this.canvas.totalHeight;e.clearRect(0,0,t,a),this.options.showGrid&&this._renderGrid(e),this.options.showToday&&this._renderTodayMarker(e),this.canvas.visibleNodes.forEach((t,a)=>{const s=a*this.options.rowHeight;this._renderNodeBars(e,t,s)})}_renderGrid(e){const t=new Date(this.dateRange.start),a=new Date(this.dateRange.end);e.strokeStyle=this.colors.grid,e.lineWidth=1;let s=new Date(t);for(s.setDate(1);s<=a;){const t=this._dateToX(s);e.beginPath(),e.moveTo(t,0),e.lineTo(t,this.canvas.totalHeight),e.stroke(),s.setMonth(s.getMonth()+1)}for(let i=0;i<=this.canvas.visibleNodes.length;i++){const t=i*this.options.rowHeight;e.beginPath(),e.moveTo(0,t),e.lineTo(this.canvas.totalWidth,t),e.stroke()}}_renderTodayMarker(e){const t=new Date,a=this._dateToX(t);e.strokeStyle=this.colors.today,e.lineWidth=2,e.setLineDash([5,5]),e.beginPath(),e.moveTo(a,0),e.lineTo(a,this.canvas.totalHeight),e.stroke(),e.setLineDash([])}_renderNodeBars(e,t,a){if("pekerjaan"!==t.type)return;const s=a+this.options.barPadding;t.planned.isValid()&&this._renderBar(e,t.planned,s,this.colors.planned,"planned"),t.actual.isValid()&&this._renderBar(e,t.actual,s+this.options.barHeight/2-6,this.colors.actual,"actual",12)}_renderBar(e,t,a,s,i,n=null){if(!t.isValid())return;const o=this._dateToX(t.startDate),r=this._dateToX(t.endDate)-o,l=n||this.options.barHeight;if(e.fillStyle=s.fill,e.fillRect(o,a,r,l),e.strokeStyle=s.stroke,e.lineWidth=1,e.strokeRect(o,a,r,l),t.progress>0){const i=r*t.progress/100;e.fillStyle=s.progress,e.fillRect(o,a,i,l)}"planned"===i&&r>40&&(e.fillStyle=this.colors.text,e.font="11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(`${t.progress}%`,o+r/2,a+l/2))}_dateToX(e){return Math.floor((e-this.dateRange.start)/864e5)*this.canvas.pixelsPerDay}_xToDate(e){const t=e/this.canvas.pixelsPerDay,a=new Date(this.dateRange.start);return a.setDate(a.getDate()+Math.floor(t)),a}setMode(e){this.options.mode=e,this._scheduleRender()}syncScrollY(e){this.elements.content.scrollTop=e}getScrollState(){return this.scrollState}destroy(){this._animationFrameId&&cancelAnimationFrame(this._animationFrameId),this.resizeObserver&&this.resizeObserver.disconnect(),this.container.innerHTML="",console.log("üóëÔ∏è Timeline Panel destroyed")}}class P{constructor(e,t={}){if(this.container="string"==typeof e?document.querySelector(e):e,!this.container)throw new Error("Gantt container not found");this.options=n({mode:t.mode||"planned",rowHeight:t.rowHeight||40,enableMilestones:!1!==t.enableMilestones,enableSync:!1!==t.enableSync},t),this.dataModel=new S,this.treePanel=null,this.timelinePanel=null,this.state={loading:!1,initialized:!1,selectedNodeId:null,mode:this.options.mode},this.onDataChange=t.onDataChange||(()=>{}),this.onNodeSelect=t.onNodeSelect||(()=>{}),this.onMilestoneChange=t.onMilestoneChange||(()=>{}),this.milestonePopup=null}initialize(e){return o(this,null,function*(){console.log("üöÄ Initializing Gantt Chart Redesign..."),this.state.loading=!0;try{this._buildDOM(),this.dataModel.initialize(e),yield this._createComponents(),this._setupSync(),this.state.loading=!1,this.state.initialized=!0,this.render(),console.log("‚úÖ Gantt Chart Redesign initialized successfully"),E.success("Gantt Chart loaded successfully")}catch(t){throw console.error("‚ùå Failed to initialize Gantt Chart:",t),this._showError("Failed to initialize Gantt Chart: "+t.message),this.state.loading=!1,t}})}_buildDOM(){this.container.innerHTML="",this.container.className="gantt-container";const e=document.createElement("div");e.className="gantt-tree-panel-container",this.container.appendChild(e);const t=document.createElement("div");t.className="gantt-timeline-panel-container",this.container.appendChild(t),this.elements={treeContainer:e,timelineContainer:t}}_createComponents(){return o(this,null,function*(){this.treePanel=new R(this.elements.treeContainer,this.dataModel,{mode:this.state.mode,onNodeClick:e=>this._handleNodeClick(e),onNodeExpand:(e,t)=>this._handleNodeExpand(e,t),onSearchChange:e=>this._handleSearchChange(e)}),this.timelinePanel=new D(this.elements.timelineContainer,this.dataModel,{mode:this.state.mode,rowHeight:this.options.rowHeight,showMilestones:this.options.enableMilestones,onBarClick:(e,t,a)=>this._handleBarClick(e,t,a),onMilestoneClick:(e,t)=>this._handleMilestoneClick(e,t),onScroll:e=>this._handleTimelineScroll(e)}),this._createMilestonePopup()})}_setupSync(){if(!this.options.enableSync)return;let e=!1,t=!1;this.treePanel.elements.treeContent.addEventListener("scroll",()=>{if(t)return;e=!0;const a=this.treePanel.getScrollTop();this.timelinePanel.syncScrollY(a),setTimeout(()=>{e=!1},50)}),this.timelinePanel.elements.content.addEventListener("scroll",()=>{if(e)return;t=!0;const a=this.timelinePanel.elements.content.scrollTop;this.treePanel.setScrollTop(a),setTimeout(()=>{t=!1},50)})}_handleNodeClick(e){this.state.selectedNodeId=e;const t=this.dataModel.getNodeById(e);console.log("üìå Node selected:",t),this.onNodeSelect(t)}_handleNodeExpand(e,t){console.log(`${t?"üìÇ":"üìÅ"} Node ${t?"expanded":"collapsed"}:`,e),this.render()}_handleSearchChange(e){console.log("üîç Search:",e)}_handleBarClick(e,t,a){console.log(`üìä Bar clicked: ${e.name} (${t})`),this._handleNodeClick(e.id),E.info(`${e.name}: ${"planned"===t?"Planned":"Actual"} - ${"planned"===t?e.planned.progress:e.actual.progress}%`)}_handleMilestoneClick(e,t){console.log("üéØ Milestone clicked:",e),this._showMilestonePopup(e,t)}_handleTimelineScroll(e){}_createMilestonePopup(){if(!this.options.enableMilestones)return;const e=document.createElement("div");e.className="milestone-popup",e.innerHTML='\n      <div class="milestone-popup-header">\n        <h6 class="milestone-popup-title"></h6>\n        <button class="milestone-popup-close" aria-label="Close">\n          <i class="bi bi-x"></i>\n        </button>\n      </div>\n      <div class="milestone-popup-body">\n        <div class="milestone-popup-date">\n          <i class="bi bi-calendar"></i>\n          <span class="milestone-date-text"></span>\n        </div>\n        <div class="milestone-popup-description"></div>\n        <div class="milestone-popup-comments"></div>\n      </div>\n    ',document.body.appendChild(e),this.milestonePopup=e,e.querySelector(".milestone-popup-close").addEventListener("click",()=>{this._hideMilestonePopup()}),document.addEventListener("click",t=>{!e.classList.contains("visible")||e.contains(t.target)||t.target.closest(".milestone-marker")||this._hideMilestonePopup()})}_showMilestonePopup(e,t){if(!this.milestonePopup)return;this.milestonePopup.querySelector(".milestone-popup-title").textContent=e.title,this.milestonePopup.querySelector(".milestone-date-text").textContent=e.date.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),this.milestonePopup.querySelector(".milestone-popup-description").textContent=e.description||"No description";const a=this.milestonePopup.querySelector(".milestone-popup-comments");e.comments.length>0?a.innerHTML=e.comments.map(e=>`\n        <div class="milestone-comment">\n          <div class="milestone-comment-author">${e.author}</div>\n          <div class="milestone-comment-text">${e.text}</div>\n          <div class="milestone-comment-time">${this._formatDate(e.timestamp)}</div>\n        </div>\n      `).join(""):a.innerHTML='<p class="text-muted">No comments yet</p>';const s=t.clientX,i=t.clientY;this.milestonePopup.style.left=s+10+"px",this.milestonePopup.style.top=i+10+"px",this.milestonePopup.classList.add("visible")}_hideMilestonePopup(){this.milestonePopup&&this.milestonePopup.classList.remove("visible")}_formatDate(e){const t=new Date-e,a=Math.floor(t/1e3),s=Math.floor(a/60),i=Math.floor(s/60),n=Math.floor(i/24);return n>0?`${n} day${n>1?"s":""} ago`:i>0?`${i} hour${i>1?"s":""} ago`:s>0?`${s} minute${s>1?"s":""} ago`:"Just now"}_showLoading(){this.container.innerHTML='\n      <div class="gantt-loading">\n        <div class="gantt-loading-spinner"></div>\n        <p>Loading Gantt Chart...</p>\n      </div>\n    '}_showError(e){this.container.innerHTML=`\n      <div class="gantt-empty">\n        <i class="bi bi-exclamation-triangle text-danger"></i>\n        <h5>Error Loading Gantt Chart</h5>\n        <p>${e}</p>\n      </div>\n    `}_showEmpty(){this.container.innerHTML='\n      <div class="gantt-empty">\n        <i class="bi bi-calendar-x"></i>\n        <h5>No Data Available</h5>\n        <p>No tasks to display in Gantt Chart</p>\n      </div>\n    '}render(){this.state.initialized&&(0!==this.dataModel.getTotalPekerjaanCount()?(this.treePanel.render(),this.timelinePanel.render()):this._showEmpty())}setMode(e){["planned","actual"].includes(e)?(this.state.mode=e,this.treePanel&&this.treePanel.setMode(e),this.timelinePanel&&this.timelinePanel.setMode(e),console.log(`üîÑ Mode changed to: ${e}`)):console.warn("Invalid mode:",e)}expandAll(){this.treePanel&&(this.treePanel.expandAll(),this.render())}collapseAll(){this.treePanel&&(this.treePanel.collapseAll(),this.render())}scrollToNode(e){this.treePanel&&this.treePanel.scrollToNode(e)}addMilestone(e){const t=this.dataModel.addMilestone(e);return this.onMilestoneChange("add",t),this.render(),E.success("Milestone added"),t}removeMilestone(e){this.dataModel.removeMilestone(e),this.onMilestoneChange("remove",e),this.render(),E.success("Milestone removed")}updateData(e){console.log("üîÑ Updating Gantt data...");try{this.dataModel.initialize(e),this.render(),E.success("Gantt Chart updated")}catch(t){console.error("‚ùå Failed to update data:",t),E.error("Failed to update Gantt Chart")}}exportData(){return this.dataModel.toJSON()}getSelectedNode(){return this.dataModel.getNodeById(this.state.selectedNodeId)}search(e){return this.dataModel.searchNodes(e)}destroy(){console.log("üóëÔ∏è Destroying Gantt Chart..."),this.treePanel&&this.treePanel.destroy(),this.timelinePanel&&this.timelinePanel.destroy(),this.milestonePopup&&this.milestonePopup.remove(),this.container.innerHTML="",this.state.initialized=!1,console.log("‚úÖ Gantt Chart destroyed")}}class j{constructor(){this.state=null,this.eventManager=null,this.initialized=!1,this.agGridManager=null,this.stateManager=u.getInstance(),this.dataLoader=null,this.timeColumnGenerator=null,this.gridRenderer=null,this.saveHandler=null,this.kurvaSChart=null,this.ganttChart=null,this.ganttChartRedesign=null,this._chartModulesLoaded=!1,this._chartModulesLoading=!1,this.keyboardShortcuts=null,this._weekBoundarySaveTimer=null,this._pendingWeekBoundary=null,this._isRegeneratingTimeline=!1,this._queuedRegeneratePayload=null,this._isEnforcingWeekly=!1,this._exportManagerInstance=null,this._exportBindingsAttached=!1,this._costToggleBtn=null,this._costToggleBtnText=null,this._costToggleSpinner=null,this._costToggleBtnIcon=null,this._costViewAutoActivated=!1,this._ganttScrollSyncHandlers=null}_getProjectDateRange(){var e,t;let a=null,s=null;if(null==(e=this.state)?void 0:e.projectStart){const e=new Date(this.state.projectStart);Number.isNaN(e.getTime())||(a=e)}if(null==(t=this.state)?void 0:t.projectEnd){const e=new Date(this.state.projectEnd);Number.isNaN(e.getTime())||(s=e)}return!a||s&&!Number.isNaN(s.getTime())||(s=new Date(a.getFullYear(),11,31)),{start:a,end:s}}_estimateExpectedWeeklyColumns(){const{start:e,end:t}=this._getProjectDateRange();if(!e||!t||Number.isNaN(e.getTime())||Number.isNaN(t.getTime()))return 0;const a=Math.max(0,Math.floor((t-e)/864e5))+1;return Math.max(1,Math.ceil(a/7))}_countWeeklyColumns(){return Array.isArray(this.state.timeColumns)?this.state.timeColumns.filter(e=>{var t;const a=(e.generationMode||e.type||"").toLowerCase();return"weekly"===a||"week"===a||"wk"===a||Number.isFinite(Number(null!=(t=e.weekNumber)?t:e.week_number))}).length:0}initialize(){return o(this,arguments,function*(e={}){if(this.initialized)console.warn("JadwalKegiatanApp already initialized");else{console.log("üöÄ Initializing Jadwal Kegiatan App (Vite Build)");try{this._setupState(e),this._setupDomRefs(e),this._attachEvents(),yield this._loadInitialData(),this.initialized=!0,console.log("‚úÖ Jadwal Kegiatan App initialized successfully"),window.JadwalKegiatanApp=this}catch(t){throw console.error("‚ùå Failed to initialize Jadwal Kegiatan App:",t),t}}})}_setupState(e){var t;const a=window.kelolaTahapanPageState||(null==(t=window.JadwalPekerjaanApp)?void 0:t.state);this.state=Object.assign({pekerjaanTree:[],timeColumns:[],tahapanList:[],timeColumnIndex:{},expandedNodes:new Set,volumeMap:new Map,isLoading:!1,error:null,domRefs:{},apiEndpoints:{},projectId:null,projectName:"",projectStart:null,projectEnd:null,useAgGrid:!0,timeScale:"weekly",inputMode:"percentage",saveMode:"weekly",weekStartDay:0,weekEndDay:6,displayScale:null,progressMode:"planned",displayMode:"percentage",stateManager:this.stateManager,plannedState:{progressTotals:new Map,volumeTotals:new Map,cellVolumeOverrides:new Map,cellValidationMap:new Map,failedRows:new Set,autoWarningRows:new Set,volumeWarningRows:new Set,validationWarningRows:new Set,saveErrorRows:new Set,apiFailedRows:new Set,showCompletionWarnings:!1,isDirty:!1},actualState:{progressTotals:new Map,volumeTotals:new Map,cellVolumeOverrides:new Map,cellValidationMap:new Map,failedRows:new Set,autoWarningRows:new Set,volumeWarningRows:new Set,validationWarningRows:new Set,saveErrorRows:new Set,apiFailedRows:new Set,showCompletionWarnings:!1,isDirty:!1},progressTotals:null,volumeTotals:null,cellVolumeOverrides:null,cellValidationMap:null,failedRows:null,autoWarningRows:null,volumeWarningRows:null,validationWarningRows:null,saveErrorRows:null,apiFailedRows:null,showCompletionWarnings:!1,isDirty:!1},a||{},e.initialState||{}),window.kelolaTahapanPageState=this.state,this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),this._ensureStateCollections(),this.state.displayScale||(this.state.displayScale=this.state.timeScale||"weekly"),this._setupStateDelegation()}_setupStateDelegation(){const e=()=>"actual"===this.state.progressMode?this.state.actualState:this.state.plannedState;Object.defineProperty(this.state,"modifiedCells",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].modifiedCells},configurable:!0}),Object.defineProperty(this.state,"assignmentMap",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].assignmentMap},configurable:!0}),Object.defineProperty(this.state,"costAssignmentMap",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].costAssignmentMap},configurable:!0}),Object.defineProperty(this.state,"costModifiedCells",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].costModifiedCells},configurable:!0}),Object.defineProperty(this.state,"progressTotals",{get:()=>e().progressTotals,configurable:!0}),Object.defineProperty(this.state,"volumeTotals",{get:()=>e().volumeTotals,configurable:!0}),Object.defineProperty(this.state,"cellVolumeOverrides",{get:()=>e().cellVolumeOverrides,configurable:!0}),Object.defineProperty(this.state,"cellValidationMap",{get:()=>e().cellValidationMap,configurable:!0}),Object.defineProperty(this.state,"isDirty",{get:()=>e().isDirty||this.stateManager.hasUnsavedChanges(),set:t=>{e().isDirty=t},configurable:!0}),console.log("[JadwalKegiatanApp] Phase 0.3: State delegation setup with StateManager integration")}_getCurrentModeState(){const e="actual"===this.state.progressMode?"actual":"planned";return this.stateManager.states[e]}_updateSaveButtonState(){var e,t,a;const s=null==(t=null==(e=this.state)?void 0:e.domRefs)?void 0:t.saveButton;if(!s)return;const i=(null==(a=this.state)?void 0:a.failedRows)instanceof Set&&this.state.failedRows.size>0;s.disabled=!1,s.classList.toggle("btn-outline-danger",Boolean(i)),s.classList.toggle("btn-success",!i),i?s.setAttribute("title","Ada baris dengan peringatan (>100%/volume). Klik untuk melihat detail dan perbaiki."):s.removeAttribute("title")}_ensureStateCollections(){this.state.failedRows instanceof Set||(this.state.failedRows=new Set),this.state.autoWarningRows instanceof Set||(this.state.autoWarningRows=new Set),this.state.volumeWarningRows instanceof Set||(this.state.volumeWarningRows=new Set),this.state.validationWarningRows instanceof Set||(this.state.validationWarningRows=new Set),this.state.saveErrorRows instanceof Set||(this.state.saveErrorRows=new Set),this.state.apiFailedRows instanceof Set||(this.state.apiFailedRows=new Set),this.state.progressTotals instanceof Map||(this.state.progressTotals=new Map),this.state.volumeTotals instanceof Map||(this.state.volumeTotals=new Map),this.state.cellVolumeOverrides instanceof Map||(this.state.cellVolumeOverrides=new Map),this.state.cellValidationMap instanceof Map||(this.state.cellValidationMap=new Map)}_setupDomRefs(e){const t=Object.assign({root:document.getElementById("tahapan-grid-app"),leftThead:document.getElementById("left-thead"),rightThead:document.getElementById("right-thead"),leftTbody:document.getElementById("left-tbody"),rightTbody:document.getElementById("right-tbody"),leftPanelScroll:document.querySelector(".left-panel-scroll"),rightPanelScroll:document.getElementById("right-panel-scroll-bottom")||document.querySelector(".right-panel-scroll"),rightTable:document.getElementById("right-table"),horizontalScrollTop:document.getElementById("right-panel-scroll-top"),horizontalScrollInner:document.getElementById("right-panel-scroll-inner"),timeHeaderRow:document.getElementById("time-header-row"),saveButton:document.getElementById("save-button")||document.getElementById("btn-save-all"),refreshButton:document.getElementById("refresh-button"),resetButton:document.getElementById("btn-reset-progress"),agGridContainer:document.getElementById("ag-grid-container"),agGridTopScroll:document.getElementById("ag-grid-scroll-top"),agGridTopScrollInner:document.getElementById("ag-grid-scroll-inner"),scurveChart:document.getElementById("scurve-chart"),ganttChart:document.getElementById("gantt-chart"),ganttChartWrapper:document.getElementById("gantt-chart-wrapper"),ganttTreeBody:document.getElementById("gantt-tree-body"),ganttTreeScroll:document.getElementById("gantt-tree-scroll"),ganttSummaryTable:document.getElementById("gantt-summary-table"),ganttSummaryBody:document.getElementById("gantt-summary-body"),ganttSummaryTotal:document.getElementById("gantt-summary-total"),statusBar:document.querySelector(".status-bar"),statusMessageEl:document.getElementById("status-message"),itemCountEl:document.getElementById("item-count"),modifiedCountEl:document.getElementById("modified-count"),totalProgressEl:document.getElementById("total-progress"),weekStartSelect:document.getElementById("week-start-day-select"),weekEndSelect:document.getElementById("week-end-day-select")},e.domRefs||{});if(this.state.domRefs=t,this._updateSaveButtonState(),!t.root)throw new Error("Root container #tahapan-grid-app tidak ditemukan");if(this._applyDataset(t.root),this.state.useAgGrid){if(!t.agGridContainer)throw new Error("AG Grid container #ag-grid-container tidak ditemukan")}else if(!t.leftTbody||!t.rightTbody)throw new Error("Critical DOM elements not found (leftTbody, rightTbody)")}_applyDataset(e){var t,a,s,i,n,o;if(!e||!e.dataset)return;const{dataset:r}=e;this.state.projectId=Number(r.projectId||this.state.projectId||0)||this.state.projectId,this.state.projectName=r.projectName||this.state.projectName,this.state.projectStart=r.projectStart||this.state.projectStart,this.state.projectEnd=r.projectEnd||this.state.projectEnd;const l=new Set(["daily","weekly","monthly","custom"]),d=(r.defaultTimeScale||r.timeScale||r.saveMode||this.state.timeScale||this.state.saveMode||"").toString().toLowerCase();l.has(d)?(this.state.timeScale=d,this.state.saveMode=d):this.state.timeScale||(this.state.timeScale=this.state.saveMode||"weekly"),this.state.displayScale=this.state.timeScale||"weekly";const h=(r.defaultInputMode||r.inputMode||r.displayMode||this.state.inputMode||"percentage").toString().toLowerCase(),c=new Set(["percentage","volume","cost"]);this.state.inputMode=c.has(h)?h:"percentage";const u=Number.parseInt(null!=(i=null!=(s=null!=(a=null!=(t=r.weekEndDay)?t:r.weekend)?a:r.weekEnd)?s:r.week_end_day)?i:"",10);Number.isNaN(u)||(this.state.weekEndDay=u);const g=Number.parseInt(null!=(o=null!=(n=r.weekStartDay)?n:r.week_start_day)?o:"",10);if(Number.isNaN(g))Number.isNaN(u)||(this.state.weekStartDay=(this.state.weekEndDay+1)%7);else{const e=(g%7+7)%7;this.state.weekStartDay=e}const p=Object.assign({base:r.apiBase||"",tahapan:r.apiTahapan||r.apiBase||"",listPekerjaan:r.apiListPekerjaan||"",volume:r.apiVolume||"",assignmentsBase:r.apiAssignmentsBase||"",save:r.apiSave||this.state.apiEndpoints&&this.state.apiEndpoints.save||this._getDefaultSaveEndpoint(),weekBoundary:r.apiWeekBoundary||"",regenerateTahapan:r.apiRegenerateTahapan||"",reset:r.apiResetProgress||this.state.apiEndpoints&&this.state.apiEndpoints.reset||""},this.state.apiEndpoints||{});this.state.apiEndpoints=p,this.state.useAgGrid="true"===r.enableAgGrid||this.state.useAgGrid}_attachEvents(){const e={updateProgressIndicator:(e,t)=>{c(e,t,this.state)},showToast:this.showToast.bind(this)};this.state.useAgGrid?this.eventManager&&(this.eventManager.cleanup(),this.eventManager=null):this.eventManager=l(this.state,e),this._attachToolbarEvents(),this._initAgGridIfNeeded()}_attachToolbarEvents(){const e=this.state.domRefs.saveButton,t=this.state.domRefs.refreshButton,a=this.state.domRefs.resetButton;e&&e.addEventListener("click",()=>this.saveChanges()),t&&t.addEventListener("click",()=>this.refresh()),a&&a.addEventListener("click",()=>this._handleResetProgress()),this._syncToolbarRadios(),this._attachRadioGroupHandler("displayMode",e=>this._handleDisplayModeChange(e)),this._attachRadioGroupHandler("progressMode",e=>this._handleProgressModeChange(e)),this._attachRadioGroupHandler("timeScale",e=>this._handleTimeScaleChange(e)),this._setupWeekBoundaryControls(),this._setupExportButtons(),this._setupCostViewToggle(),this._setupKeyboardShortcuts(),this._setupUXEnhancements()}_setupKeyboardShortcuts(){this.keyboardShortcuts=new M,this.keyboardShortcuts.register("ctrl+s",()=>{this.saveChanges(),E.info("Saving changes... (Ctrl+S)")},{description:"Save all changes"}),this.keyboardShortcuts.register("ctrl+r",()=>{this.refresh(),E.info("Refreshing data... (Ctrl+R)")},{description:"Refresh data from server"}),this.keyboardShortcuts.register("ctrl+alt+p",()=>{const e=document.getElementById("mode-planned");e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),E.info("Switched to Perencanaan mode (Ctrl+Alt+P)"))},{description:"Switch to Perencanaan mode"}),this.keyboardShortcuts.register("ctrl+alt+a",()=>{const e=document.getElementById("mode-actual");e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),E.info("Switched to Realisasi mode (Ctrl+Alt+A)"))},{description:"Switch to Realisasi mode"}),this.keyboardShortcuts.register("ctrl+alt+1",()=>{const e=document.getElementById("mode-percentage");e&&!e.disabled&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),E.info("Display: Percentage (Ctrl+Alt+1)"))},{description:"Switch to Percentage display"}),this.keyboardShortcuts.register("ctrl+alt+2",()=>{const e=document.getElementById("mode-volume");e&&!e.disabled&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),E.info("Display: Volume (Ctrl+Alt+2)"))},{description:"Switch to Volume display"}),this.keyboardShortcuts.register("ctrl+alt+3",()=>{const e=document.getElementById("mode-cost");e&&!e.disabled?(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),E.info("Display: Cost (Ctrl+Alt+3)")):E.warning("Cost view only available in Realisasi mode")},{description:"Switch to Cost display"}),this.keyboardShortcuts.register("escape",()=>{document.querySelectorAll(".dropdown-menu.show").forEach(e=>{const t=e.previousElementSibling;if(t){const e=bootstrap.Dropdown.getInstance(t);e&&e.hide()}})},{description:"Close open menus",preventDefault:!1}),this.keyboardShortcuts.register("ctrl+shift+/",()=>{this._showKeyboardShortcutsHelp()},{description:"Show keyboard shortcuts help"}),console.log("‚å®Ô∏è Keyboard shortcuts registered:",this.keyboardShortcuts.getShortcuts())}_setupUXEnhancements(){console.log("üé® Initializing UX enhancements..."),C.addToAll(".btn-primary, .btn-save, .btn-danger"),document.querySelectorAll("button[title]").forEach(e=>{e.hasAttribute("data-tooltip")||e.setAttribute("data-tooltip",e.getAttribute("title"))}),console.log("‚úÖ UX enhancements initialized");const e=this.state.domRefs.saveButton;e&&e.setAttribute("data-keyboard-hint","Ctrl+S"),console.log("üé® UX enhancements applied")}_showKeyboardShortcutsHelp(){const e=`\n      <div class="modal fade" id="keyboardShortcutsModal" tabindex="-1">\n        <div class="modal-dialog">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title">\n                <i class="bi bi-keyboard"></i> Keyboard Shortcuts\n              </h5>\n              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n            </div>\n            <div class="modal-body">\n              <table class="table table-sm">\n                <thead>\n                  <tr>\n                    <th style="width: 40%">Shortcut</th>\n                    <th>Action</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${this.keyboardShortcuts.getShortcuts().map(e=>`\n      <tr>\n        <td><kbd>${e.key.replace(/\+/g,"</kbd> + <kbd>")}</kbd></td>\n        <td>${e.description}</td>\n      </tr>\n    `).join("")}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,t=document.getElementById("keyboardShortcutsModal");t&&t.remove(),document.body.insertAdjacentHTML("beforeend",e);new bootstrap.Modal(document.getElementById("keyboardShortcutsModal")).show(),document.getElementById("keyboardShortcutsModal").addEventListener("hidden.bs.modal",function(){this.remove()})}_setupExportButtons(){var e;if(!this._exportBindingsAttached)if("undefined"!=typeof ExportManager){if(null==(e=this.state)?void 0:e.projectId)try{this._exportManagerInstance=new ExportManager(this.state.projectId,"jadwal-pekerjaan");["csv","pdf","word","xlsx"].forEach(e=>{const t=document.getElementById(`btn-export-${e}`);t&&t.addEventListener("click",()=>{this._exportManagerInstance.exportAs(e)})}),this._exportBindingsAttached=!0}catch(t){console.error("[JadwalKegiatanApp] Failed to initialize export buttons",t)}}else console.warn("[JadwalKegiatanApp] ExportManager is not loaded; export buttons disabled")}_setupCostViewToggle(){const e=document.getElementById("toggleCostViewBtn"),t=document.getElementById("toggleCostViewBtnText"),a=document.getElementById("toggleCostViewBtnSpinner"),s=null==e?void 0:e.querySelector("i");e?this.kurvaSChart?(this._costToggleBtn=e,this._costToggleBtnText=t,this._costToggleSpinner=a,this._costToggleBtnIcon=s,e.addEventListener("click",()=>o(this,null,function*(){e.disabled=!0,null==a||a.classList.remove("d-none");try{(yield this.kurvaSChart.toggleView())?(this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Switched Kurva-S view:",this.kurvaSChart.viewMode)):console.error("[JadwalKegiatanApp] Failed to toggle view")}catch(t){console.error("[JadwalKegiatanApp] Error toggling cost view:",t)}finally{e.disabled=!1,null==a||a.classList.add("d-none")}})),this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Cost view toggle button setup complete")):console.warn("[JadwalKegiatanApp] Kurva S chart not initialized, cannot setup toggle"):console.log("[JadwalKegiatanApp] Cost view toggle button not found (chart tab may not be active)")}_setCostToggleButtonState(){if(!this._costToggleBtn||!this.kurvaSChart)return;const e="cost"===this.kurvaSChart.viewMode,t=e?"Show Progress View":"Show Cost View",a=e?"fas fa-chart-line":"fas fa-money-bill-wave";this._costToggleBtnText&&(this._costToggleBtnText.textContent=t),this._costToggleBtnIcon&&(this._costToggleBtnIcon.className=a)}_activateDefaultCostView(){return o(this,null,function*(){if(this._costViewAutoActivated)return void this._setCostToggleButtonState();if(!this.kurvaSChart)return;if((this.kurvaSChart.options||{}).enableCostView)try{(yield this.kurvaSChart.toggleView("cost"))&&(this._costViewAutoActivated=!0,this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Defaulted Kurva-S to cost view"))}catch(e){console.warn("[JadwalKegiatanApp] Failed to enable cost view automatically:",e)}})}_attachRadioGroupHandler(e,t){const a=document.querySelectorAll(`input[name="${e}"]`);a&&0!==a.length&&a.forEach(e=>{e.addEventListener("change",e=>{e.target.checked&&t(e.target.value)})})}_setupWeekBoundaryControls(){const{weekStartSelect:e,weekEndSelect:t}=this.state.domRefs||{};e&&t&&(this._syncWeekBoundaryControls(),e.addEventListener("change",e=>{const t=this._normalizePythonWeekday(e.target.value,this._getWeekStartDay()),a=(t+6)%7;this._handleWeekBoundaryChange({weekStartDay:t,weekEndDay:a,source:"start"})}),t.addEventListener("change",e=>{const t=this._normalizePythonWeekday(e.target.value,this._getWeekEndDay()),a=(t+1)%7;this._handleWeekBoundaryChange({weekStartDay:a,weekEndDay:t,source:"end"})}))}_handleResetProgress(){return o(this,null,function*(){var e;const t=null==(e=this.state.apiEndpoints)?void 0:e.reset;if(!t)return void this.showToast("Endpoint reset tidak tersedia","danger",3200);const a=this.state.progressMode||"planned",s="planned"===a?"Perencanaan":"Realisasi";if(window.confirm(`Reset semua progress ${s} ke 0%?\n\nData ${"Perencanaan"===s?"Realisasi":"Perencanaan"} tidak akan terpengaruh.\n\nOperasi ini dapat di-undo dengan memasukkan ulang data.`))try{this.state.isLoading=!0,this._updateStatusBar(`Mereset progress ${s}...`);const e=yield fetch(t,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:JSON.stringify({mode:a})});if(!e.ok){const t=yield e.text().catch(()=>"");throw new Error(t||`HTTP ${e.status}`)}const i=yield e.json().catch(()=>({}));this._resetEditedCellsState(),this.state.assignmentMap instanceof Map?this.state.assignmentMap.clear():this.state.assignmentMap=new Map,this._clearFailedRows(),this.state.isDirty=!1;const n=(null==i?void 0:i.message)||"Progress berhasil direset. Silakan input ulang jadwal pekerjaan.";this.showToast(n,"success",3400),yield this._loadInitialData({forceReload:!0})}catch(i){console.error("[JadwalKegiatanApp] Failed to reset progress",i),this.showToast("Gagal mereset progress. Coba lagi atau hubungi admin.","danger",3600)}finally{this.state.isLoading=!1,this._updateStatusBar()}})}_syncWeekBoundaryControls(){const{weekStartSelect:e,weekEndSelect:t}=this.state.domRefs||{};e&&(e.value=String(this._getWeekStartDay())),t&&(t.value=String(this._getWeekEndDay()))}_handleWeekBoundaryChange({weekStartDay:e,weekEndDay:t,source:a}){const s=this._normalizePythonWeekday(t,this._getWeekEndDay()),i=this._normalizePythonWeekday(e,(s+1)%7);if(i===this._getWeekStartDay()&&s===this._getWeekEndDay())return void this._syncWeekBoundaryControls();this.state.weekStartDay=i,this.state.weekEndDay=s,this._syncWeekBoundaryControls();const n=`${this._formatWeekdayLabel(i)} ‚Üí ${this._formatWeekdayLabel(s)}`,o="start"===a?"Week start disetel ke":"Week end disetel ke";this.showToast(`${o} ${n}`,"info",2400),this._regenerateColumnsForWeekBoundary(),this._persistWeekBoundarySettings(i,s)}_regenerateColumnsForWeekBoundary(){if(Array.isArray(this.state.tahapanList)&&0!==this.state.tahapanList.length){this.timeColumnGenerator||(this.timeColumnGenerator=new g(this.state));try{this.timeColumnGenerator.generate(),this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),this._syncGridViews(),this._recalculateAllProgressTotals()}catch(e){console.error("[JadwalKegiatanApp] Failed to regenerate columns for week boundary change",e),this.showToast("Gagal menerapkan pengaturan minggu","danger",3200)}}}_invalidateCachedDataset(){this.state.pekerjaanTree=[],this.state.tahapanList=[],this.state.timeColumns=[],this.state.flatPekerjaan=[],this.state.timeColumnIndex={},this.state.assignmentMap=new Map,this._resetEditedCellsState()}_resetEditedCellsState(){this.state.modifiedCells instanceof Map?this.state.modifiedCells.clear():this.state.modifiedCells=new Map,this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides.clear():this.state.cellVolumeOverrides=new Map,this.state.cellValidationMap instanceof Map?this.state.cellValidationMap.clear():this.state.cellValidationMap=new Map,this.state.validationWarningRows instanceof Set?this.state.validationWarningRows.clear():this.state.validationWarningRows=new Set,this.state.saveErrorRows instanceof Set?this.state.saveErrorRows.clear():this.state.saveErrorRows=new Set,this.state.showCompletionWarnings=!1}_persistWeekBoundarySettings(e,t){var a;const s=null==(a=this.state.apiEndpoints)?void 0:a.weekBoundary;s&&(this._weekBoundarySaveTimer&&clearTimeout(this._weekBoundarySaveTimer),this._pendingWeekBoundary={weekStartDay:e,weekEndDay:t},this._weekBoundarySaveTimer=window.setTimeout(()=>{this._weekBoundarySaveTimer=null;const a=this._pendingWeekBoundary||{weekStartDay:e,weekEndDay:t};this._pendingWeekBoundary=null;const i=JSON.stringify({week_start_day:a.weekStartDay,week_end_day:a.weekEndDay});fetch(s,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:i}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{const t=void 0!==(null==e?void 0:e.week_start_day)?e.week_start_day:a.weekStartDay,s=void 0!==(null==e?void 0:e.week_end_day)?e.week_end_day:a.weekEndDay;this.state.weekStartDay=t,this.state.weekEndDay=s,this._regenerateTimeline({mode:"weekly",weekStartDay:t,weekEndDay:s})}).catch(e=>{console.warn("[JadwalKegiatanApp] Failed to persist week boundary setting",e)})},500))}_regenerateTimeline(){return o(this,arguments,function*(e={}){var t;const{mode:a="weekly",weekStartDay:s,weekEndDay:i}=e,o=null==(t=this.state.apiEndpoints)?void 0:t.regenerateTahapan;if(!o)return;if(this._isRegeneratingTimeline)return void(this._queuedRegeneratePayload={mode:a,weekStartDay:s,weekEndDay:i});if(this.state.isDirty&&this.state.modifiedCells instanceof Map&&this.state.modifiedCells.size>0){if(!window.confirm("Mengubah batas minggu akan me-refresh data dan membatalkan perubahan yang belum disimpan. Lanjutkan?"))return;this._resetEditedCellsState(),this.state.isDirty=!1}this._isRegeneratingTimeline=!0,this.state.isLoading=!0;const r="monthly"===a?"Mengatur ulang struktur bulanan...":"Mengatur ulang struktur minggu...";this._updateStatusBar(r);const l="monthly"===a?"Mengatur ulang kolom monthly...":"Mengatur ulang kolom weekly sesuai preferensi Anda...";this.showToast(l,"info",2400);try{const e=yield fetch(o,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:JSON.stringify(n({mode:a},"weekly"===a?{week_start_day:"number"==typeof s?s:this._getWeekStartDay(),week_end_day:"number"==typeof i?i:this._getWeekEndDay()}:{}))});if(!e.ok)throw new Error(`HTTP ${e.status}`);this._invalidateCachedDataset(),yield this._loadInitialData({forceReload:!0});const t="monthly"===a?"Struktur monthly diperbarui (read-only)":"Periode minggu diperbarui";this.showToast(t,"success",2200)}catch(d){console.error("[JadwalKegiatanApp] Failed to regenerate weekly structure",d),this.showToast("Gagal memperbarui struktur waktu","danger",3200)}finally{if(this.state.isLoading=!1,this._updateStatusBar(),this._isRegeneratingTimeline=!1,this._queuedRegeneratePayload){const e=this._queuedRegeneratePayload;this._queuedRegeneratePayload=null,this._regenerateTimeline(e)}}})}_formatWeekdayLabel(e){const t=this._normalizePythonWeekday(e,0);return["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu","Minggu"][t]||`Day ${t}`}_syncToolbarRadios(){const e=this.state.inputMode||"percentage";document.querySelectorAll('input[name="displayMode"]').forEach(t=>{t.checked=t.value===e});const t=this.state.displayScale||this.state.timeScale||"weekly";document.querySelectorAll('input[name="timeScale"]').forEach(e=>{e.checked=e.value===t}),this._updateCostToggleAvailability()}_handleDisplayModeChange(e){const t=(e||"").toLowerCase();if(!new Set(["percentage","volume","cost"]).has(t)||this.state.inputMode===t)return;if("cost"===t&&"actual"!==(this.state.progressMode||"planned"))return this.showToast("Mode biaya hanya tersedia saat melihat Realisasi","warning",2600),void this._syncToolbarRadios();this.state.inputMode=t,this.state.displayMode=t,this.agGridManager&&this.agGridManager.setInputMode(t),this._syncGridViews();let a="Persentase";"volume"===t?a="Volume":"cost"===t&&(a="Biaya"),this.showToast(`Mode input diubah ke ${a}`,"info",2200)}_handleProgressModeChange(e){const t=(e||"").toLowerCase();if(!new Set(["planned","actual"]).has(t)||this.state.progressMode===t)return;const a=this.state.progressMode;console.log(`[ModeChange] Switching progress mode from ${a} to ${t}`);const s=this.stateManager.states[a].getStats();this.stateManager.switchMode(t),this.state.progressMode=t,"actual"!==t&&"cost"===this.state.inputMode&&(this.state.inputMode="percentage",this.state.displayMode="percentage",this._syncToolbarRadios());const i=this.stateManager.states[t].getStats();console.log("[ModeChange] State switch complete:"),console.log(`  - Old ${a.toUpperCase()}: ${s.modifiedCount} modified, ${s.assignmentCount} assignments`),console.log(`  - New ${t.toUpperCase()}: ${i.modifiedCount} modified, ${i.assignmentCount} assignments`);const n=document.getElementById("progress-mode-indicator");if(n){const e="planned"===t?"Perencanaan":"Realisasi",a="planned"===t?"bg-info":"bg-warning";n.textContent=`Mode: ${e}`,n.className=`badge ${a} ms-2`,n.style.cssText="font-size: 0.75rem; vertical-align: middle;"}this._syncGridViews();const o="planned"===t?"Perencanaan":"Realisasi";this.showToast(`Mode progress diubah ke ${o}`,"info",2200)}_updateCostToggleAvailability(){const e=document.getElementById("mode-cost");if(!e)return;const t="actual"===(this.state.progressMode||"planned");if(e.disabled=!t,!t&&e.checked){const e=document.getElementById("mode-percentage");e&&(e.checked=!0)}}_handleTimeScaleChange(e){const t=(e||"").toLowerCase();if(!new Set(["weekly","monthly"]).has(t))return this._syncToolbarRadios(),void this.showToast("Mode waktu ini belum aktif pada fase saat ini","warning",3200);(this.state.displayScale||this.state.timeScale||"weekly")!==t?(this.state.displayScale=t,this._syncToolbarRadios(),this._syncGridViews(),this._renderGrid(),this._updateCharts(),"weekly"===t?this.showToast("Time scale diatur ke Weekly","info",2e3):this.showToast("Time scale diatur ke Monthly (akumulasi 4 minggu, read-only)","info",2600)):this._syncToolbarRadios()}_initAgGridIfNeeded(){if(!this.state.useAgGrid)return;const e=this.state.domRefs.agGridContainer;e?this.agGridManager||(this.agGridManager=new d(this.state,{showToast:this.showToast.bind(this),onCellChange:e=>this._handleAgGridCellChange(e),getCellValidationState:e=>this._getCellValidationState(e)}),this.agGridManager.mount(e)):console.warn("[JadwalKegiatanApp] AG Grid container not available")}_loadInitialData(){return o(this,arguments,function*(e={}){var t,a,s,i,n,o,r,l,d,c,u,w;const{forceReload:f=!1}=e;if(!f&&(null==(t=this.state.pekerjaanTree)?void 0:t.length)>0)return console.log("[JadwalKegiatanApp] Using template dataset"),console.log("Preloaded pekerjaanTree items:",this.state.pekerjaanTree.length),console.log("Preloaded tahapanList items:",(null==(a=this.state.tahapanList)?void 0:a.length)||0),console.log("Preloaded timeColumns items:",(null==(s=this.state.timeColumns)?void 0:s.length)||0),this._recalculateAllProgressTotals(),void this._syncGridViews();this.state.apiBase=(null==(i=this.state.apiEndpoints)?void 0:i.tahapan)||`/detail_project/api/project/${this.state.projectId}/tahapan/`,this.dataLoader=new p(this.state),this.timeColumnGenerator=new g(this.state),this.gridRenderer=new h(this.state),this.saveHandler=new m(this.state,{apiUrl:(null==(n=this.state.apiEndpoints)?void 0:n.save)||`/detail_project/api/project/${this.state.projectId}/pekerjaan/assign_weekly/`,onSuccess:e=>this._onSaveSuccess(e),onError:e=>this._onSaveError(e),showToast:(e,t)=>this.showToast(e,t)}),this.state.isLoading=!0;try{console.log("[JadwalKegiatanApp] Loading data using modern DataLoader..."),yield this.dataLoader.loadAllData({skipIfLoaded:!1}),this.timeColumnGenerator.generate();const e=(this.state.displayScale||this.state.timeScale||"weekly").toLowerCase();if(!this._isEnforcingWeekly&&"weekly"===e){const e=this._countWeeklyColumns(),t=this._estimateExpectedWeeklyColumns(),a=((null==(r=null==(o=this.state.timeColumns)?void 0:o[0])?void 0:r.generationMode)||(null==(d=null==(l=this.state.timeColumns)?void 0:l[0])?void 0:d.type)||"").toLowerCase();if(0===e||"monthly"===a||t>0&&e>0&&e<t)return console.warn("[JadwalKegiatanApp] Weekly columns incomplete; regenerating weekly structure based on project timeline..."),this._isEnforcingWeekly=!0,yield this._regenerateTimeline({mode:"weekly",weekStartDay:this._getWeekStartDay(),weekEndDay:this._getWeekEndDay()}),void(this._isEnforcingWeekly=!1)}yield this.dataLoader.loadAssignments(),this._recalculateAllProgressTotals(),yield this._loadKurvaSData(),this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),console.log("[JadwalKegiatanApp] ‚úÖ Data loaded successfully:",`${(null==(c=this.state.flatPekerjaan)?void 0:c.length)||0} pekerjaan,`,`${(null==(u=this.state.tahapanList)?void 0:u.length)||0} tahapan,`,`${(null==(w=this.state.timeColumns)?void 0:w.length)||0} columns`),this._renderGrid(),this._initializeCharts(),this._updateCharts()}catch(y){console.error("[JadwalKegiatanApp] ‚ùå Failed to load data:",y),this.state.error=y,this.showToast("Gagal memuat data: "+y.message,"danger")}finally{this.state.isLoading=!1,this._syncGridViews()}})}_loadKurvaSData(){return o(this,null,function*(){var e;try{const t=`/detail_project/api/v2/project/${this.state.projectId}/kurva-s-data/`;console.log("[JadwalKegiatanApp] Loading Kurva S harga data from:",t);const a=yield fetch(t,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const s=yield a.json();if(this.state.hargaMap=new Map(Object.entries(s.hargaMap||{}).map(([e,t])=>[e,parseFloat(t)||0])),this.state.totalBiayaProject=parseFloat(s.totalBiayaProject||0),this.state.pekerjaanMeta=s.pekerjaanMeta||{},s.volumeMap&&Object.keys(s.volumeMap).length>0){0===((null==(e=this.state.volumeMap)?void 0:e.size)||0)&&(this.state.volumeMap=new Map(Object.entries(s.volumeMap).map(([e,t])=>[e,parseFloat(t)||0])))}console.log("[JadwalKegiatanApp] ‚úÖ Kurva S data loaded:",{hargaCount:this.state.hargaMap.size,totalBiaya:this.state.totalBiayaProject,totalBiayaFormatted:`Rp ${this.state.totalBiayaProject.toLocaleString("id-ID")}`})}catch(t){console.error("[JadwalKegiatanApp] ‚ö†Ô∏è Failed to load Kurva S data:",t),this.state.hargaMap=this.state.hargaMap||new Map,this.state.totalBiayaProject=this.state.totalBiayaProject||0,this.state.pekerjaanMeta=this.state.pekerjaanMeta||{},console.warn("[JadwalKegiatanApp] Kurva S will use fallback calculation")}})}_renderGrid(){var e,t,a;if(!this.gridRenderer)return void console.warn("[JadwalKegiatanApp] GridRenderer not initialized");this.state.activeTimeColumns=this._getDisplayTimeColumns(),console.log("[JadwalKegiatanApp] Rendering grid...");const s=this.gridRenderer.renderTables();if(!s)return void console.warn("[JadwalKegiatanApp] Grid rendering returned null");const{leftHTML:i,rightHTML:n}=s,o=(null==(e=this.state.domRefs)?void 0:e.leftTbody)||document.getElementById("left-tbody"),r=(null==(t=this.state.domRefs)?void 0:t.rightTbody)||document.getElementById("right-tbody");o&&(o.innerHTML=i),r&&(r.innerHTML=n);const l=(null==(a=this.state.domRefs)?void 0:a.timeHeaderRow)||document.getElementById("time-header-row");l&&this.gridRenderer.renderTimeHeader(l),this.gridRenderer.syncRowHeights(this.state.domRefs||{}),this._updateLegacyHorizontalScroll(),console.log("[JadwalKegiatanApp] ‚úÖ Grid rendered"),this._updateStatusBar()}_loadChartModules(){return o(this,null,function*(){if(!this._chartModulesLoaded&&!this._chartModulesLoading){this._chartModulesLoading=!0,console.log("üìä Loading chart modules (lazy)...");try{const[e,t]=yield Promise.all([r(()=>import("./chart-modules-DnPQdEVM.js").then(e=>e.e),[]),r(()=>import("./chart-modules-DnPQdEVM.js").then(e=>e.f),[])]);this.KurvaSChartClass=e.KurvaSChart,this.GanttChartClass=t.GanttChart,this._chartModulesLoaded=!0,this._chartModulesLoading=!1,console.log("‚úÖ Chart modules loaded"),this._initializeChartsAfterLoad()}catch(e){console.error("‚ùå Failed to load chart modules:",e),this._chartModulesLoading=!1,E.error("Failed to load chart modules")}}})}_initializeChartsAfterLoad(){var e;if(console.log("[JadwalKegiatanApp] Initializing charts after load..."),(null==(e=this.state.domRefs)?void 0:e.scurveChart)&&this.KurvaSChartClass)try{this.kurvaSChart=new this.KurvaSChartClass(this.state,{useIdealCurve:!0,steepnessFactor:.8,smoothCurves:!0,showArea:!0});if(this.kurvaSChart.initialize(this.state.domRefs.scurveChart)){console.log("[JadwalKegiatanApp] Kurva-S chart initialized");const e=this._activateDefaultCostView();e&&"function"==typeof e.catch&&e.catch(e=>{console.warn("[JadwalKegiatanApp] Failed to auto-enable cost view:",e)})}}catch(t){console.warn("[JadwalKegiatanApp] Failed to initialize Kurva-S chart:",t)}console.log("[JadwalKegiatanApp] ‚ö†Ô∏è OLD Gantt Chart initialization SKIPPED (replaced by new design)")}_initializeRedesignedGantt(e=0){return o(this,null,function*(){if(this.ganttChartRedesign)return void console.log("[JadwalKegiatanApp] Redesigned Gantt already initialized, skipping");0===e&&(yield new Promise(e=>setTimeout(e,100)));const t=document.getElementById("gantt-redesign-container");if(!t)return console.warn(`[JadwalKegiatanApp] ‚è≥ Gantt container not found (attempt ${e+1}/3)`),e<3?(console.log("[JadwalKegiatanApp] Retrying in 200ms..."),yield new Promise(e=>setTimeout(e,200)),this._initializeRedesignedGantt(e+1)):(console.error("[JadwalKegiatanApp] ‚ùå Gantt redesign container not found after retries"),console.error("[JadwalKegiatanApp] DOM state:",{ganttView:document.getElementById("gantt-view"),ganttTab:document.getElementById("gantt-tab")}),void E.error("Failed to find Gantt container"));try{console.log("üöÄ Initializing COMPLETELY NEW Redesigned Gantt Chart..."),console.log("[JadwalKegiatanApp] ‚úÖ Container found:",t),this.ganttChartRedesign=new P(t,{mode:this.state.currentMode||"planned",rowHeight:40,enableMilestones:!0,enableSync:!0,onNodeSelect:e=>{console.log("üìå Node selected in Gantt:",e)},onDataChange:()=>{console.log("üîÑ Gantt data changed")},onMilestoneChange:(e,t)=>{console.log(`üéØ Milestone ${e}:`,t)}});const e=this._prepareGanttData();console.log("[JadwalKegiatanApp] Prepared Gantt data:",{dataCount:e.data.length,project:e.project,milestonesCount:e.milestones.length}),yield this.ganttChartRedesign.initialize(e),console.log("[JadwalKegiatanApp] ‚úÖ NEW Redesigned Gantt Chart initialized successfully!"),E.success("‚ú® New Gantt Chart loaded!",2e3)}catch(a){throw console.error("[JadwalKegiatanApp] ‚ùå Failed to initialize Redesigned Gantt:",a),console.error("[JadwalKegiatanApp] Error stack:",a.stack),E.error("Failed to load new Gantt Chart"),a}})}_prepareGanttData(){var e;const t=[];(null==(e=this.state)?void 0:e.flatPekerjaan)&&Array.isArray(this.state.flatPekerjaan)?(console.log(`[JadwalKegiatanApp] Transforming ${this.state.flatPekerjaan.length} nodes for Gantt`),this.state.flatPekerjaan.forEach(e=>{const a="klasifikasi"===e.type?e.id:"subKlasifikasi"===e.type?e.parent_id:"pekerjaan"===e.type?e.klasifikasi_id:null,s="subKlasifikasi"===e.type?e.id:"pekerjaan"===e.type?e.sub_klasifikasi_id:null,i="pekerjaan"===e.type?e.id:null;let n=0,o=0;if("pekerjaan"===e.type&&this.stateManager){const t=this.state.tahapanList||[],a=t.length;if(a>0){let s=0,i=0;t.forEach(t=>{const a=this.stateManager.getCellValue(e.id,t.column_id,"planned"),n=this.stateManager.getCellValue(e.id,t.column_id,"actual");s+=a||0,i+=n||0}),n=Math.round(s/a),o=Math.round(i/a)}}t.push({klasifikasi_id:a,klasifikasi_name:"klasifikasi"===e.type?e.name:e.klasifikasi_name||"",klasifikasi_kode:"klasifikasi"===e.type?e.kode:e.klasifikasi_kode||"",sub_klasifikasi_id:s,sub_klasifikasi_name:"subKlasifikasi"===e.type?e.name:e.sub_klasifikasi_name||"",sub_klasifikasi_kode:"subKlasifikasi"===e.type?e.kode:e.sub_klasifikasi_kode||"",pekerjaan_id:i,pekerjaan_name:"pekerjaan"===e.type?e.name:"",pekerjaan_kode:"pekerjaan"===e.type?e.kode:"",tgl_mulai_rencana:e.tgl_mulai_rencana||this.state.projectStart,tgl_selesai_rencana:e.tgl_selesai_rencana||this.state.projectEnd,tgl_mulai_realisasi:e.tgl_mulai_realisasi||this.state.projectStart,tgl_selesai_realisasi:e.tgl_selesai_realisasi||this.state.projectEnd,progress_rencana:n,progress_realisasi:o,volume:e.volume||0,satuan:e.satuan||"",node_type:e.type})})):console.warn("[JadwalKegiatanApp] No flatPekerjaan data available for Gantt");const a={project_id:this.state.projectId,project_name:this.state.projectName||"Project",start_date:this.state.projectStart,end_date:this.state.projectEnd};return console.log(`[JadwalKegiatanApp] Prepared ${t.length} nodes for Gantt Chart`),{data:t,project:a,milestones:[]}}_initializeCharts(){this._setupLazyChartLoading()}_setupLazyChartLoading(){const e=document.querySelector("#scurve-tab")||document.querySelector('[data-bs-target="#scurve-view"]'),t=document.querySelector("#gantt-tab")||document.querySelector('[data-bs-target="#gantt-view"]');console.log("[LazyLoad] Found tabs:",{scurveTab:e,ganttTab:t}),e&&(e.addEventListener("shown.bs.tab",()=>o(this,null,function*(){console.log("[LazyLoad] Kurva S tab shown"),this._chartModulesLoaded||(yield this._loadChartModules())}),{once:!0}),e.addEventListener("click",()=>o(this,null,function*(){console.log("[LazyLoad] Kurva S tab clicked"),this._chartModulesLoaded||this._chartModulesLoading||(yield this._loadChartModules())}),{once:!0})),t&&(t.addEventListener("shown.bs.tab",()=>o(this,null,function*(){console.log("[LazyLoad] üéØ Gantt tab shown - initializing NEW Gantt Chart!"),this._chartModulesLoaded||(yield this._loadChartModules()),yield this._initializeRedesignedGantt()}),{once:!0}),t.addEventListener("click",()=>o(this,null,function*(){console.log("[LazyLoad] üéØ Gantt tab clicked"),this._chartModulesLoaded||this._chartModulesLoading||(yield this._loadChartModules())}),{once:!0})),console.log("üìä Chart lazy loading configured (with NEW Gantt initialization)")}_updateCharts(){if(console.log("[JadwalKegiatanApp] Updating charts..."),this.kurvaSChart)try{this.kurvaSChart.update(),console.log("[JadwalKegiatanApp] ‚úÖ Kurva-S chart updated")}catch(e){console.warn("[JadwalKegiatanApp] Failed to update Kurva-S chart:",e)}if(this.ganttChartRedesign)try{const e=this._prepareGanttData();this.ganttChartRedesign.updateData(e),console.log("[JadwalKegiatanApp] ‚úÖ NEW Gantt chart updated")}catch(e){console.warn("[JadwalKegiatanApp] Failed to update NEW Gantt chart:",e)}console.log("[JadwalKegiatanApp] ‚ö†Ô∏è OLD Gantt Chart update SKIPPED (replaced by new design)")}_renderGanttSummary(){console.log("[JadwalKegiatanApp] ‚ö†Ô∏è _renderGanttSummary() SKIPPED (old Gantt method)")}_renderGanttTree(){console.log("[JadwalKegiatanApp] ‚ö†Ô∏è _renderGanttTree() SKIPPED (old Gantt method)")}_attachGanttScrollSync(){var e,t,a;const s=null==(e=this.state.domRefs)?void 0:e.ganttTreeScroll,i=null==(t=this.state.domRefs)?void 0:t.ganttChartWrapper;if(!s||!i)return;const n=i.querySelector(".gantt-container");if(!n)return;if((null==(a=this._ganttScrollSyncHandlers)?void 0:a.scrollEl)&&this._ganttScrollSyncHandlers.scrollEl!==n&&(this._ganttScrollSyncHandlers.scrollEl.removeEventListener("scroll",this._ganttScrollSyncHandlers.scrollHandler),s.removeEventListener("wheel",this._ganttScrollSyncHandlers.wheelHandler),this._ganttScrollSyncHandlers=null),this._ganttScrollSyncHandlers)return void(s.scrollTop=n.scrollTop);const o=()=>{s.scrollTop=n.scrollTop},r=e=>{0!==e.deltaY&&(n.scrollTop+=e.deltaY)};n.addEventListener("scroll",o),s.addEventListener("wheel",r,{passive:!0}),this._ganttScrollSyncHandlers={scrollEl:n,scrollHandler:o,wheelHandler:r}}_escapeHtml(e){return null==e?"":String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]||e))}saveChanges(){return o(this,null,function*(){if(!this.saveHandler)return console.error("[JadwalKegiatanApp] SaveHandler not initialized"),void E.error("Save handler not initialized");if(!this._validateRowTotalsBeforeSave())return void E.warning("Please fix validation errors before saving");const e=this.state.domRefs.saveButton;e&&T.setLoading(e,"Saving...");try{const t=yield this.saveHandler.save();t.success?(this._renderGrid(),this._recalculateAllProgressTotals(),e&&T.setSuccess(e,2e3),E.success("Changes saved successfully!")):(e&&T.setError(e,2e3),E.error(t.message||"Failed to save changes"))}catch(t){console.error("[JadwalKegiatanApp] Save error:",t),e&&T.setError(e,2e3),E.error("An error occurred while saving")}})}_onSaveSuccess(e){console.log("[JadwalKegiatanApp] Save completed successfully"),this.state.isDirty=!1,this._clearSaveErrorRows();const t="actual"===(this.state.progressMode||"planned").toLowerCase()?"Perubahan realisasi tersimpan":"Perubahan perencanaan tersimpan";this._updateStatusBar(t),this._clearApiFailedRows(),this._renderGrid(),this._recalculateAllProgressTotals(),this._updateCharts()}_onSaveError(e){console.error("[JadwalKegiatanApp] Save failed:",e),this._markFailedRowsFromError(e)}refresh(){return o(this,null,function*(){if(this.state.isDirty){if(!confirm("Ada perubahan yang belum disimpan. Yakin ingin refresh?"))return}console.log("Refreshing data..."),this._resetEditedCellsState(),this.state.isDirty=!1,yield this._loadInitialData({forceReload:!0}),this.showToast("Data berhasil di-refresh","success")})}showToast(e,t="info",a=3e3){if("function"==typeof window.showToast)return void window.showToast(e,t,a);console.log(`[${t.toUpperCase()}] ${e}`);const s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.classList.add("show")},10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},a)}_buildTimeColumns(e=[]){return Array.isArray(e)?e.map((e,t)=>{var a;const s=null!=(a=null==e?void 0:e.id)?a:`tahapan-${t+1}`,i=`col_${String(s).replace(/[^a-zA-Z0-9_-]/g,"_")}`,n=(null==e?void 0:e.nama)||(null==e?void 0:e.name)||`Tahapan ${t+1}`,o="number"==typeof(null==e?void 0:e.urutan)?e.urutan:Number.parseInt(null==e?void 0:e.urutan,10)||t;return{id:s,fieldId:i,label:n,order:o,weekNumber:o+1,startDate:(null==e?void 0:e.tanggal_mulai)||(null==e?void 0:e.start_date)||(null==e?void 0:e.startDate)||null,endDate:(null==e?void 0:e.tanggal_selesai)||(null==e?void 0:e.end_date)||(null==e?void 0:e.endDate)||null,isAutoGenerated:Boolean(null==e?void 0:e.is_auto_generated),generationMode:(null==e?void 0:e.generation_mode)||null}}):[]}_createTimeColumnIndex(e=[]){const t={};return(e||[]).forEach(e=>{const a=e.fieldId||e.id;a&&(t[a]=e)}),t}_getDefaultSaveEndpoint(){var e;const t=null==(e=this.state)?void 0:e.projectId;return t?`/detail_project/api/v2/project/${t}/assign-weekly/`:""}_fetchJson(e){return o(this,arguments,function*(e,t={}){if(!e)throw new Error("URL tidak boleh kosong saat memanggil _fetchJson");const a=yield fetch(e,n({credentials:"same-origin"},t));if(!a.ok){const e=yield a.text().catch(()=>"");throw new Error(e||`HTTP ${a.status}: ${a.statusText}`)}return a.json()})}_syncGridViews(){const e=this._getDisplayTimeColumns();this.state.activeTimeColumns=e,this.agGridManager&&(this.agGridManager.updateData({tree:this.state.pekerjaanTree||[],timeColumns:e,inputMode:this.state.inputMode||"percentage",timeScale:this.state.displayScale||this.state.timeScale||"weekly"}),"function"==typeof this.agGridManager.updateTopScrollMetrics&&this.agGridManager.updateTopScrollMetrics()),this._updateLegacyHorizontalScroll()}_updateLegacyHorizontalScroll(){var e;const t=(null==(e=this.state)?void 0:e.domRefs)||{},a=t.horizontalScrollTop,s=t.horizontalScrollInner,i=t.rightTable;a&&s&&i&&window.requestAnimationFrame(()=>{s.style.width=`${i.scrollWidth}px`})}_clearApiFailedRows(){this.state.apiFailedRows instanceof Set&&this.state.apiFailedRows.size>0&&(this.state.apiFailedRows.clear(),this._refreshFailedRowsUnion())}_markFailedRowsFromIds(e){e instanceof Set&&0!==e.size?(this.state.apiFailedRows=new Set(Array.from(e)),this._refreshFailedRowsUnion()):this._clearApiFailedRows()}_setSaveErrorRows(e){this.state.saveErrorRows instanceof Set||(this.state.saveErrorRows=new Set);const t=e instanceof Set?Array.from(e):[];this.state.saveErrorRows=new Set(t.map(e=>Number(e))),this.agGridManager&&"function"==typeof this.agGridManager.refreshRowStyles&&this.agGridManager.refreshRowStyles()}_clearSaveErrorRows(){this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.size>0&&(this.state.saveErrorRows.clear(),this.agGridManager&&"function"==typeof this.agGridManager.refreshRowStyles&&this.agGridManager.refreshRowStyles())}_clearSaveErrorForRow(e){if(!(e&&this.state.saveErrorRows instanceof Set&&0!==this.state.saveErrorRows.size))return;this.state.saveErrorRows.delete(Number(e))&&this.agGridManager&&"function"==typeof this.agGridManager.refreshRowStyles&&this.agGridManager.refreshRowStyles()}_markFailedRowsFromError(e){const t=this._extractPekerjaanIdsFromError(e);this._markFailedRowsFromIds(t)}_extractPekerjaanIdsFromError(e){const t=new Set,a=(e=[])=>{e.forEach(e=>{var a,s;const i=(null==e?void 0:e.pekerjaan_id)||(null==e?void 0:e.pekerjaanId)||(null==(a=null==e?void 0:e.item)?void 0:a.pekerjaan_id)||(null==(s=null==e?void 0:e.item)?void 0:s.pekerjaanId)||null;i&&t.add(Number(i))})};return Array.isArray(null==e?void 0:e.validationErrors)&&a(e.validationErrors),Array.isArray(null==e?void 0:e.details)&&a(e.details),t}_getContainerValue(e,t){return e&&t?e instanceof Map?e.has(t)?e.get(t):null:"object"==typeof e&&Object.prototype.hasOwnProperty.call(e,t)?e[t]:null:null}_calculateRowTotalPercent(e){if(!e)return 0;const t=this.state.timeColumns||[],a=this.state.modifiedCells instanceof Map?this.state.modifiedCells:null,s=this.state.assignmentMap;let i=0;return t.forEach(t=>{const n=t.fieldId||t.id;if(!n)return;const o=`${e}-${n}`;let r=null;r=a&&a.has(o)?a.get(o):this._getContainerValue(s,o);const l=Number(r);Number.isFinite(l)&&(i+=l)}),Number(i.toFixed(2))}_calculateRowTotalVolume(e){if(!e)return 0;const t=this._getRowVolume(e),a=Array.isArray(this.state.timeColumns)?this.state.timeColumns:[],s=this.state.modifiedCells instanceof Map?this.state.modifiedCells:null,i=this.state.assignmentMap,n=this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides:null;let o=0;return a.forEach(a=>{const r=a.fieldId||a.id;if(!r)return;const l=`${e}-${r}`;let d=null;if(n&&n.has(l)){const e=Number(n.get(l));Number.isFinite(e)&&(d=e)}if(null===d){let e=null;s&&s.has(l)?e=Number(s.get(l)):i&&(e=Number(this._getContainerValue(i,l))),Number.isFinite(e)&&Number.isFinite(t)&&t>0&&(d=e/100*t)}Number.isFinite(d)&&(o+=d)}),Number(o.toFixed(3))}_setCellVolumeOverride(e,t){if(!e)return;this.state.cellVolumeOverrides instanceof Map||(this.state.cellVolumeOverrides=new Map);const a=Number(t);Number.isFinite(a)?this.state.cellVolumeOverrides.set(e,Number(a.toFixed(3))):this.state.cellVolumeOverrides.has(e)&&this.state.cellVolumeOverrides.delete(e)}_clearCellVolumeOverride(e){e&&this.state.cellVolumeOverrides instanceof Map&&0!==this.state.cellVolumeOverrides.size&&this.state.cellVolumeOverrides.delete(e)}_updateCellValidationState(e,t){if(!e)return;this.state.cellValidationMap instanceof Map||(this.state.cellValidationMap=new Map);const a=this.state.cellValidationMap.get(e)||null,s=t&&!1===t.isValid?"warning"===t.level?"warning":"error":null;let i=!1;s?a!==s&&(this.state.cellValidationMap.set(e,s),i=!0):a&&(this.state.cellValidationMap.delete(e),i=!0),i&&this.agGridManager&&"function"==typeof this.agGridManager.refreshCells&&this.agGridManager.refreshCells()}_getCellValidationState(e){return e&&this.state.cellValidationMap instanceof Map&&this.state.cellValidationMap.get(e)||null}_updateProgressTotals(e){if(!e)return 0;this.state.progressTotals instanceof Map||(this.state.progressTotals=new Map);const t=this._calculateRowTotalPercent(e);return this.state.progressTotals.set(Number(e),t),this._updateAutoWarningRows(Number(e),t),this._updateCompletionWarningRows(Number(e),t),this._updateStatusBar(),t}_updateVolumeTotals(e,t=null,a={}){if(!e)return;this.state.volumeTotals instanceof Map||(this.state.volumeTotals=new Map);const s=this._calculateRowTotalVolume(e);this.state.volumeTotals.set(Number(e),s);const i=Number.isFinite(t)&&null!==t?Number(t):this.state.progressTotals instanceof Map?this.state.progressTotals.get(Number(e)):null,n=this._getRowVolume(e),o=!Number.isFinite(i)&&Number.isFinite(s)&&Number.isFinite(n)&&n>0?s/n*100:i;this._updateVolumeWarningRows(Number(e),s,{percentTotal:o,deferRefresh:a.deferRefresh})}_recalculateAllProgressTotals(){this.state.progressTotals instanceof Map?this.state.progressTotals.clear():this.state.progressTotals=new Map,this.state.volumeTotals instanceof Map?this.state.volumeTotals.clear():this.state.volumeTotals=new Map,this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides.clear():this.state.cellVolumeOverrides=new Map,this.state.autoWarningRows=new Set,this.state.volumeWarningRows=new Set,this.state.validationWarningRows=new Set,this.state.saveErrorRows=new Set;(Array.isArray(this.state.flatPekerjaan)?this.state.flatPekerjaan.filter(e=>"pekerjaan"===(null==e?void 0:e.type)&&e.id):[]).forEach(e=>{const t=this._calculateRowTotalPercent(e.id);this.state.progressTotals.set(Number(e.id),t),this._updateAutoWarningRows(Number(e.id),t,{deferRefresh:!0}),this._updateCompletionWarningRows(Number(e.id),t,{deferRefresh:!0}),this._updateVolumeTotals(Number(e.id),t,{deferRefresh:!0})}),this._refreshFailedRowsUnion(),this.state.showCompletionWarnings&&this.agGridManager&&this.agGridManager.refreshRowStyles(),this._updateStatusBar()}_refreshFailedRowsUnion(){const e=new Set;this.state.autoWarningRows instanceof Set&&this.state.autoWarningRows.forEach(t=>e.add(Number(t))),this.state.volumeWarningRows instanceof Set&&this.state.volumeWarningRows.forEach(t=>e.add(Number(t))),this.state.apiFailedRows instanceof Set&&this.state.apiFailedRows.forEach(t=>e.add(Number(t))),this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.forEach(t=>e.add(Number(t))),this.state.failedRows=e,this._updateSaveButtonState(),this.agGridManager&&"function"==typeof this.agGridManager.refreshRowStyles&&this.agGridManager.refreshRowStyles()}_updateAutoWarningRows(e,t,a={}){if(!e)return;this.state.autoWarningRows instanceof Set||(this.state.autoWarningRows=new Set);let s=!1;t>100.01?this.state.autoWarningRows.has(e)||(this.state.autoWarningRows.add(e),s=!0):this.state.autoWarningRows.has(e)&&(this.state.autoWarningRows.delete(e),s=!0),s&&!a.deferRefresh&&this._refreshFailedRowsUnion()}_updateCompletionWarningRows(e,t,a={}){if(!e)return;this.state.validationWarningRows instanceof Set||(this.state.validationWarningRows=new Set);let s=!1;this.state.showCompletionWarnings&&Number.isFinite(t)&&t>.01&&t<99.99?this.state.validationWarningRows.has(e)||(this.state.validationWarningRows.add(e),s=!0):this.state.validationWarningRows.has(e)&&(this.state.validationWarningRows.delete(e),s=!0),s&&!a.deferRefresh&&this.agGridManager&&this.agGridManager.refreshRowStyles()}_recomputeCompletionWarnings(){this.state.validationWarningRows instanceof Set?this.state.validationWarningRows.clear():this.state.validationWarningRows=new Set,this.state.progressTotals instanceof Map?(this.state.progressTotals.forEach((e,t)=>{this._updateCompletionWarningRows(Number(t),e,{deferRefresh:!0})}),this.agGridManager&&this.agGridManager.refreshRowStyles()):this.agGridManager&&this.agGridManager.refreshRowStyles()}_updateVolumeWarningRows(e,t,a={}){if(!e)return;this.state.volumeWarningRows instanceof Set||(this.state.volumeWarningRows=new Set);const s=this._getRowVolume(e),i=a&&Number.isFinite(a.percentTotal)?Number(a.percentTotal):this.state.progressTotals instanceof Map?this.state.progressTotals.get(Number(e)):null,n=Number.isFinite(s)&&s>0?Math.max(.001*s,.01):.01;let o=!1;Number.isFinite(s)&&s>0?o=Number.isFinite(t)&&t>s+n:Number.isFinite(i)&&(o=i>n);let r=!1;o?this.state.volumeWarningRows.has(e)||(this.state.volumeWarningRows.add(e),r=!0):this.state.volumeWarningRows.has(e)&&(this.state.volumeWarningRows.delete(e),r=!0),r&&!a.deferRefresh&&this._refreshFailedRowsUnion()}_clearFailedRows(){this.state.autoWarningRows instanceof Set&&this.state.autoWarningRows.clear(),this.state.volumeWarningRows instanceof Set&&this.state.volumeWarningRows.clear(),this.state.failedRows instanceof Set&&this.state.failedRows.clear(),this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.clear(),this._refreshFailedRowsUnion()}_getRowVolume(e){var t;const a=null==(t=this.state)?void 0:t.volumeMap,s=Number(e);if(a instanceof Map&&a.has(s))return Number(a.get(s))||0;if(a&&"object"==typeof a){const e=String(s);if(Object.prototype.hasOwnProperty.call(a,e))return Number(a[e])||0}const i=Array.isArray(this.state.flatPekerjaan)&&this.state.flatPekerjaan.find(e=>Number(e.id)===s);return i&&void 0!==i.volume&&Number(i.volume)||0}_validateRowTotalsBeforeSave(){if(!(this.state.progressTotals instanceof Map))return!0;this.state.showCompletionWarnings||(this.state.showCompletionWarnings=!0),this._recomputeCompletionWarnings();const e=[];this.state.progressTotals.forEach((t,a)=>{Number.isFinite(t)&&t>100.01&&e.push({type:"percent",pekerjaan_id:a,total:t})});const t=[];if(this.state.volumeTotals instanceof Map&&this.state.volumeTotals.forEach((e,a)=>{const s=this._getRowVolume(a),i=Number.isFinite(s)&&s>0?Math.max(.001*s,.01):.01,n=this.state.progressTotals instanceof Map&&this.state.progressTotals.has(a)?this.state.progressTotals.get(a):null,o=Number.isFinite(n)&&null!==n?Number(n):Number.isFinite(e)&&Number.isFinite(s)&&s>0?Number(e)/Number(s)*100:null;Number.isFinite(s)&&s>0?Number.isFinite(e)&&e>s+i&&t.push({type:"volume",pekerjaan_id:a,total:e,capacity:s}):Number.isFinite(o)&&o>i&&t.push({type:"volume",pekerjaan_id:a,total:e,capacity:s||0,missingCapacity:!0})}),0===e.length&&0===t.length)return this._clearFailedRows(),this._clearSaveErrorRows(),!0;const a=new Set,s=e.concat(t),i=s.slice(0,3).map(e=>(a.add(Number(e.pekerjaan_id)),"volume"===e.type?e.missingCapacity?`- Pekerjaan ${e.pekerjaan_id}: volume tidak dapat disimpan karena master volume 0`:`- Pekerjaan ${e.pekerjaan_id}: total volume ${e.total.toFixed(3)} > kapasitas ${e.capacity.toFixed(3)}`:`- Pekerjaan ${e.pekerjaan_id}: total ${e.total.toFixed(2)}% > 100%`));return s.length>3&&i.push(`(+${s.length-3} lagi)`),this._markFailedRowsFromIds(a),this._setSaveErrorRows(a),this.showToast(`Tidak dapat menyimpan:\n${i.join("\n")}`,"danger",5e3),!1}_updateStatusBar(e="Ready"){var t,a,s;const i=(null==(t=this.state)?void 0:t.domRefs)||{};if(i.statusMessageEl||i.itemCountEl||i.modifiedCountEl||i.totalProgressEl){if(i.statusMessageEl&&"string"==typeof e&&(i.statusMessageEl.textContent=e),i.itemCountEl){const e=Array.isArray(null==(a=this.state)?void 0:a.flatPekerjaan)?this.state.flatPekerjaan.filter(e=>"pekerjaan"===(null==e?void 0:e.type)).length:0;i.itemCountEl.textContent=e.toLocaleString("id-ID")}if(i.modifiedCountEl){const e=(null==(s=this.state)?void 0:s.modifiedCells)instanceof Map?this.state.modifiedCells.size:0;i.modifiedCountEl.textContent=e.toLocaleString("id-ID")}if(i.totalProgressEl){const e=this._calculateProjectProgress();i.totalProgressEl.textContent=null===e?"-":`${e.toLocaleString("id-ID",{maximumFractionDigits:1})}%`}}}_calculateProjectProgress(){var e,t;if((null==(e=this.state)?void 0:e.progressTotals)instanceof Map&&this.state.progressTotals.size>0){let e=0;this.state.progressTotals.forEach(t=>{e+=Number(t)||0});const t=e/this.state.progressTotals.size;return Math.round(10*t)/10}if((null==(t=this.state)?void 0:t.assignmentMap)instanceof Map&&this.state.assignmentMap.size>0){const e=new Map;if(this.state.assignmentMap.forEach((t,a)=>{const[s]=`${a}`.split("-"),i=Number(t)||0,n=e.get(s)||0;e.set(s,n+i)}),e.size>0){let t=0;e.forEach(e=>{t+=e});const a=t/e.size;return Math.round(10*a)/10}}return null}_buildAssignmentsPayload(){if(!this.state.modifiedCells||0===this.state.modifiedCells.size)return[];const e=[],t=this.state.timeColumnIndex||{};return this.state.modifiedCells.forEach((a,s)=>{const i=this._parseCellKey(s);if(!(null==i?void 0:i.pekerjaanId)||!i.fieldId)return;const n=t[i.fieldId];if(!n)return void console.warn("[JadwalKegiatanApp] Column metadata not found for",i.fieldId);const o=parseFloat(a);if(Number.isNaN(o))return;const r=n.weekNumber||n.order+1||1;e.push({pekerjaan_id:Number(i.pekerjaanId),week_number:r,proportion:Number(o.toFixed(2)),tahapan_id:n.id||null})}),e}_getSaveMode(){var e;const t=((null==(e=this.state)?void 0:e.saveMode)||"weekly").toLowerCase();return new Set(["daily","weekly","monthly","custom"]).has(t)?t:"weekly"}_normalizePythonWeekday(e,t=0){const a=Number.isFinite(t)?(t%7+7)%7:0,s=Number(e);if(!Number.isFinite(s))return a;const i=s%7;return i<0?i+7:i}_getWeekStartDay(){var e;return Number.isFinite(Number(null==(e=this.state)?void 0:e.weekStartDay))?this._normalizePythonWeekday(this.state.weekStartDay,(this._getWeekEndDay()+1)%7):(this._getWeekEndDay()+1)%7}_getWeekEndDay(){var e;return this._normalizePythonWeekday(null==(e=this.state)?void 0:e.weekEndDay,6)}_getDisplayTimeColumns(){var e,t,a,s,i,n,o,r,l,d;const h=Array.isArray(this.state.timeColumns)?this.state.timeColumns:[];if("monthly"!==(this.state.displayScale||this.state.timeScale||"weekly").toLowerCase())return h;const c=h.filter(e=>(e=>{var t;const a=(e.generationMode||e.type||"").toLowerCase();if("monthly"===a)return!1;if("weekly"===a||"week"===a||"wk"===a)return!0;if(Number.isFinite(Number(null!=(t=e.weekNumber)?t:e.week_number)))return!0;const s=(e.label||"").toLowerCase();return s.includes("week")||s.includes("minggu")})(e)),u=c.length>0?c:h,g=[];for(let p=0;p<u.length;p+=4){const h=u.slice(p,p+4);if(!h.length)continue;const c=g.length,m=null!=(s=null!=(a=null==(e=h[0])?void 0:e.weekNumber)?a:null==(t=h[0])?void 0:t.order)?s:p+1,w=null!=(n=null==(i=h[h.length-1])?void 0:i.weekNumber)?n:m+h.length-1,f=(null==(o=h[0])?void 0:o.rangeLabel)||(null==(r=h[0])?void 0:r.label)||"",y=(null==(l=h[h.length-1])?void 0:l.rangeLabel)||(null==(d=h[h.length-1])?void 0:d.label)||"",v=`Month ${c+1}`,_=`Week ${m}-${w}`;g.push({id:`month-${c+1}`,fieldId:`month_${c+1}`,label:v,rangeLabel:_,tooltip:f&&y?`${f} ‚Üí ${y}`:`${v}: Week ${m}-${w}`,generationMode:"monthly",type:"monthly",index:c,childColumns:h})}return g}_parseCellKey(e){if(!e||"string"!=typeof e)return null;const t=e.indexOf("-");return-1===t?{pekerjaanId:e,fieldId:null}:{pekerjaanId:e.slice(0,t),fieldId:e.slice(t+1)}}_getCsrfToken(){const e="csrftoken";let t=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let s=0;s<a.length;s++){const i=a[s].trim();if(i.substring(0,10)===e+"="){t=decodeURIComponent(i.substring(10));break}}}return t}_handleAgGridCellChange({cellKey:e,value:t,columnMeta:a,displayValue:s,isVolumeMode:i,validation:n,pekerjaanId:o,columnId:r,valueType:l="percentage"}){if(!e)return;n&&this._updateCellValidationState(e,n);let d=t;"string"==typeof d&&(d=parseFloat(d)),Number.isNaN(d)&&(d=0);const h=this._getCurrentModeState(),c=this.state.progressMode||"planned",u="cost"===(l||(i?"volume":"percentage")).toLowerCase();if(console.log(`[CellChange] Mode: ${c.toUpperCase()}, Cell: ${e}, Value: ${d}`),u){if("actual"!==c)return void this.showToast("Biaya aktual hanya bisa diedit pada mode Realisasi","warning",2600);h.costModifiedCells.set(e,d),h.isDirty=!0}else h.modifiedCells.set(e,d),h.isDirty=!0;(null==a?void 0:a.fieldId)&&this.state.timeColumnIndex&&(this.state.timeColumnIndex[a.fieldId]=a||this.state.timeColumnIndex[a.fieldId]),i?this._setCellVolumeOverride(e,s):this._clearCellVolumeOverride(e);const g=this._parseCellKey(e),p=o||(null==g?void 0:g.pekerjaanId);if(p){this._clearSaveErrorForRow(Number(p));const e=this._updateProgressTotals(Number(p));this._updateVolumeTotals(Number(p),e)}u?console.log(`[CellChange] Cost map size: ${h.costModifiedCells.size}`):(console.log(`[CellChange] ${c.toUpperCase()} modifiedCells size: ${h.modifiedCells.size}`),this._updateCharts(),console.log("[CellChange] Real-time Kurva-S chart updated"))}destroy(){this.eventManager&&(this.eventManager.cleanup(),this.eventManager=null),this.agGridManager&&(this.agGridManager.destroy(),this.agGridManager=null),this.state=null,this.initialized=!1,console.log("JadwalKegiatanApp destroyed")}}if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{(new j).initialize()});else{(new j).initialize()}
//# sourceMappingURL=jadwal-kegiatan-DxubOeCB.js.map
