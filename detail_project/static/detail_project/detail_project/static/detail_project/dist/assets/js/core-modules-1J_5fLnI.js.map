{"version":3,"file":"core-modules-1J_5fLnI.js","sources":["../../../../../../js/src/modules/core/data-loader.js","../../../../../../js/src/modules/core/time-column-generator.js","../../../../../../js/src/modules/core/save-handler.js"],"sourcesContent":["/**\n * Data Loader Module (ES6 Modern Version)\n * Handles all data loading operations for Jadwal Kegiatan page\n *\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/data_loader_module.js\n * Date: 2025-11-19\n */\n\n// =========================================================================\n// UTILITY FUNCTIONS\n// =========================================================================\n\n/**\n * Get CSRF token from cookies\n * @returns {string|null} CSRF token\n */\nfunction getCookie(name) {\n  let cookieValue = null;\n  if (document.cookie && document.cookie !== '') {\n    const cookies = document.cookie.split(';');\n    for (let i = 0; i < cookies.length; i++) {\n      const cookie = cookies[i].trim();\n      if (cookie.substring(0, name.length + 1) === (name + '=')) {\n        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));\n        break;\n      }\n    }\n  }\n  return cookieValue;\n}\n\n/**\n * Make API call with automatic CSRF handling\n * @param {string} url - API endpoint\n * @param {Object} options - Fetch options\n * @returns {Promise<any>} JSON response\n */\nasync function apiCall(url, options = {}) {\n  const method = (options.method || 'GET').toUpperCase();\n  const needsCSRF = ['POST', 'PUT', 'DELETE', 'PATCH'].includes(method);\n\n  if (needsCSRF) {\n    options.headers = options.headers || {};\n    options.headers['X-CSRFToken'] = getCookie('csrftoken');\n  }\n\n  const response = await fetch(url, {\n    credentials: 'same-origin',\n    ...options\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({}));\n    throw new Error(error.error || `HTTP ${response.status}`);\n  }\n\n  return response.json();\n}\n\n/**\n * Derive time scale mode from tahapan list\n * @param {Array} tahapanList - List of tahapan\n * @param {string} fallbackMode - Default mode if can't detect\n * @returns {string} Detected mode (daily|weekly|monthly|custom)\n */\nfunction deriveTimeScaleFromTahapan(tahapanList, fallbackMode = 'weekly') {\n  if (!Array.isArray(tahapanList) || tahapanList.length === 0) {\n    return fallbackMode;\n  }\n\n  const autoCounts = { daily: 0, weekly: 0, monthly: 0 };\n  let autoTotal = 0;\n  let manualCount = 0;\n\n  tahapanList.forEach((tahap) => {\n    if (tahap && tahap.is_auto_generated && typeof tahap.generation_mode === 'string') {\n      const mode = tahap.generation_mode.toLowerCase();\n      if (autoCounts.hasOwnProperty(mode)) {\n        autoCounts[mode] += 1;\n        autoTotal += 1;\n      }\n    } else {\n      manualCount += 1;\n    }\n  });\n\n  // If auto-generated tahapan exist, use dominant mode\n  if (autoTotal > 0) {\n    const dominantMode = Object.entries(autoCounts).reduce((bestMode, entry) => {\n      const [mode, count] = entry;\n      if (!bestMode) return mode;\n      if (count > autoCounts[bestMode]) return mode;\n      return bestMode;\n    }, '');\n\n    if (dominantMode && autoCounts[dominantMode] > 0) {\n      return dominantMode;\n    }\n  }\n\n  // If only manual tahapan exist, it's custom mode\n  if (manualCount > 0) {\n    return 'custom';\n  }\n\n  return fallbackMode;\n}\n\n/**\n * Initialize expanded nodes set for tree\n * @param {Array} tree - Pekerjaan tree\n * @param {Object} state - Application state\n */\nfunction initialiseExpandedNodes(tree, state) {\n  if (!Array.isArray(tree) || tree.length === 0) {\n    return;\n  }\n\n  if (!(state.expandedNodes instanceof Set)) {\n    state.expandedNodes = new Set();\n  }\n\n  // If already initialized, skip\n  if (state.expandedNodes.size > 0) {\n    return;\n  }\n\n  // Expand all nodes by default\n  const collectIds = (nodes) => {\n    nodes.forEach((node) => {\n      if (!node || !node.id) return;\n      if (node.children && node.children.length > 0) {\n        state.expandedNodes.add(node.id);\n        collectIds(node.children);\n      }\n    });\n  };\n\n  collectIds(tree);\n}\n\n/**\n * Build hierarchical pekerjaan tree from API response\n * @param {Object} response - API response\n * @returns {Array} Tree structure\n */\nfunction buildPekerjaanTree(response) {\n  const tree = [];\n  const data = response.klasifikasi || response;\n\n  if (!Array.isArray(data)) return tree;\n\n  data.forEach(klas => {\n    const klasNode = {\n      id: `klas-${klas.id || klas.nama}`,\n      type: 'klasifikasi',\n      nama: klas.name || klas.nama || 'Klasifikasi',\n      children: [],\n      level: 0,\n      expanded: true\n    };\n\n    if (klas.sub && Array.isArray(klas.sub)) {\n      klas.sub.forEach(sub => {\n        const subNode = {\n          id: `sub-${sub.id || sub.nama}`,\n          type: 'sub-klasifikasi',\n          nama: sub.name || sub.nama || 'Sub-Klasifikasi',\n          children: [],\n          level: 1,\n          expanded: true\n        };\n\n        if (sub.pekerjaan && Array.isArray(sub.pekerjaan)) {\n          sub.pekerjaan.forEach(pkj => {\n            const pkjNode = {\n              id: pkj.id || pkj.pekerjaan_id,\n              type: 'pekerjaan',\n              kode: pkj.snapshot_kode || pkj.kode || '',\n              nama: pkj.snapshot_uraian || pkj.uraian || '',\n              volume: pkj.volume || 0,\n              satuan: pkj.snapshot_satuan || pkj.satuan || '-',\n              level: 2\n            };\n            subNode.children.push(pkjNode);\n          });\n        }\n\n        klasNode.children.push(subNode);\n      });\n    }\n\n    tree.push(klasNode);\n  });\n\n  return tree;\n}\n\n/**\n * Flatten tree structure for easy access\n * @param {Array} tree - Hierarchical tree\n * @param {Array} result - Accumulator\n * @returns {Array} Flattened list\n */\nfunction flattenTree(tree, result = []) {\n  tree.forEach(node => {\n    result.push(node);\n    if (node.children && node.children.length > 0) {\n      flattenTree(node.children, result);\n    }\n  });\n  return result;\n}\n\n// =========================================================================\n// DATA LOADER CLASS\n// =========================================================================\n\n/**\n * DataLoader class - handles all data loading operations\n */\nexport class DataLoader {\n  constructor(state, options = {}) {\n    if (!state) {\n      throw new Error('[DataLoader] State is required');\n    }\n\n    this.state = state;\n    this.options = options;\n    this.projectId = state.projectId;\n\n    // Initialize state maps if not exist\n    if (!this.state.volumeMap) {\n      this.state.volumeMap = new Map();\n    }\n    if (!this.state.assignmentMap) {\n      this.state.assignmentMap = new Map();\n    }\n    if (!this.state.cache) {\n      this.state.cache = {};\n    }\n  }\n\n  /**\n   * Load all data required for the page\n   * @param {Object} options - Load options\n   * @returns {Promise<Object>} Load result with metadata\n   */\n  async loadAllData(options = {}) {\n    // Prevent duplicate loading\n    if (this.state.cache.initialLoadInProgress) {\n      console.info('[DataLoader] loadAllData skipped (already in progress)');\n      return null;\n    }\n\n    // Skip if already loaded\n    if (!options.force && this.state.cache.initialLoadCompleted && options.skipIfLoaded) {\n      console.info('[DataLoader] loadAllData skipped (already completed)');\n      return this.state.cache.initialLoadResult || null;\n    }\n\n    this.state.cache.initialLoadInProgress = true;\n\n    try {\n      console.log('[DataLoader] Loading all data...');\n\n      // Step 1: Load base data in parallel\n      await Promise.all([\n        this.loadTahapan(),\n        this.loadPekerjaan(),\n        this.loadVolumes()\n      ]);\n\n      // Step 2: Time columns will be generated by TimeColumnGenerator\n      // (We don't call it here, will be handled by main app)\n\n      // Step 3: Load assignments (depends on time columns being generated)\n      await this.loadAssignments();\n\n      this.state.cache.initialLoadCompleted = true;\n      this.state.cache.initialLoadResult = {\n        completedAt: Date.now(),\n        tahapanCount: this.state.tahapanList?.length || 0,\n        pekerjaanCount: this.state.flatPekerjaan?.filter(node => node.type === 'pekerjaan').length || 0,\n      };\n\n      console.log('[DataLoader] ✅ All data loaded successfully:', this.state.cache.initialLoadResult);\n      return this.state.cache.initialLoadResult;\n\n    } catch (error) {\n      console.error('[DataLoader] ❌ Load data failed:', error);\n      this.state.cache.initialLoadError = error;\n      throw error;\n    } finally {\n      this.state.cache.initialLoadInProgress = false;\n    }\n  }\n\n  /**\n   * Load tahapan data from API\n   * @returns {Promise<Array>} List of tahapan\n   */\n  async loadTahapan() {\n    try {\n      const url = this.state.apiBase || `/detail_project/api/project/${this.projectId}/tahapan/`;\n      const data = await apiCall(url);\n\n      this.state.tahapanList = (data.tahapan || data || []).sort((a, b) => a.urutan - b.urutan);\n\n      // Auto-detect time scale mode from tahapan\n      const detectedMode = deriveTimeScaleFromTahapan(\n        this.state.tahapanList,\n        this.state.timeScale || 'weekly'\n      );\n      this.state.timeScale = detectedMode;\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.tahapanList.length} tahapan, mode: ${detectedMode}`);\n      return this.state.tahapanList;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load tahapan:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Load pekerjaan tree data from API\n   * @returns {Promise<Array>} Pekerjaan tree\n   */\n  async loadPekerjaan() {\n    try {\n      const url = `/detail_project/api/project/${this.projectId}/list-pekerjaan/tree/`;\n      const response = await apiCall(url);\n\n      // Build hierarchical tree\n      const tree = buildPekerjaanTree(response);\n      this.state.pekerjaanTree = tree;\n\n      // Flatten for easy access\n      this.state.flatPekerjaan = flattenTree(tree);\n\n      // Initialize expanded nodes\n      initialiseExpandedNodes(tree, this.state);\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.flatPekerjaan.length} pekerjaan nodes`);\n      return this.state.pekerjaanTree;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load pekerjaan:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Load volume data for all pekerjaan\n   * @returns {Promise<Map>} Volume map\n   */\n  async loadVolumes() {\n    try {\n      const url = `/detail_project/api/project/${this.projectId}/volume-pekerjaan/list/`;\n      const data = await apiCall(url);\n\n      this.state.volumeMap.clear();\n\n      const volumes = data.items || data.volumes || data.data || [];\n      if (Array.isArray(volumes)) {\n        volumes.forEach(v => {\n          const pkjId = v.pekerjaan_id || v.id;\n          const qty = parseFloat(v.quantity || v.volume || v.qty) || 0;\n          if (pkjId) {\n            this.state.volumeMap.set(pkjId, qty);\n          }\n        });\n      }\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.volumeMap.size} volume entries`);\n      return this.state.volumeMap;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load volumes:', error);\n      // Don't throw, volumes are optional\n      return this.state.volumeMap;\n    }\n  }\n\n  /**\n   * Load assignments (progress data) for all pekerjaan\n   * @returns {Promise<Map>} Assignment map\n   */\n  async loadAssignments() {\n    try {\n      this.state.assignmentMap.clear();\n      console.log('[DataLoader] Loading assignments (attempting API v2)...');\n\n      const pekerjaanNodes = this.state.flatPekerjaan.filter(node => node.type === 'pekerjaan');\n      const totalNodes = pekerjaanNodes.length;\n\n      if (totalNodes === 0) {\n        console.info('[DataLoader] No pekerjaan nodes found for assignments');\n        return this.state.assignmentMap;\n      }\n\n      await this._loadAssignmentsViaV2();\n      return this.state.assignmentMap;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load assignments:', error);\n      return this.state.assignmentMap;\n    }\n  }\n\n  /**\n   * Reload specific data type\n   * @param {string} type - Data type (tahapan|pekerjaan|volumes|assignments)\n   * @returns {Promise<any>} Loaded data\n   */\n  async reload(type) {\n    const loaders = {\n      tahapan: () => this.loadTahapan(),\n      pekerjaan: () => this.loadPekerjaan(),\n      volumes: () => this.loadVolumes(),\n      assignments: () => this.loadAssignments()\n    };\n\n    const loader = loaders[type];\n    if (!loader) {\n      throw new Error(`[DataLoader] Unknown reload type: ${type}`);\n    }\n\n    console.log(`[DataLoader] Reloading ${type}...`);\n    return loader();\n  }\n\n  _buildWeekColumnIndex() {\n    const weekColumnIndex = {};\n    if (Array.isArray(this.state.timeColumns)) {\n      this.state.timeColumns.forEach((col) => {\n        const weekNumber = Number(col.weekNumber || col.week_number || col.urutan);\n        if (Number.isFinite(weekNumber) && weekNumber >= 1 && col.id) {\n          weekColumnIndex[weekNumber] = col;\n        }\n      });\n    }\n    return weekColumnIndex;\n  }\n\n  async _loadAssignmentsViaV2() {\n    const url = `/detail_project/api/v2/project/${this.projectId}/assignments/`;\n    const data = await apiCall(url);\n\n    if (!data || !Array.isArray(data.assignments)) {\n      console.info('[DataLoader] API v2 returned no assignments array (treating as empty dataset)');\n      return;\n    }\n\n    if (data.assignments.length === 0) {\n      console.info('[DataLoader] API v2 assignments empty (no progress recorded yet)');\n      return;\n    }\n\n    const weekColumnIndex = this._buildWeekColumnIndex();\n    let mapped = 0;\n\n    data.assignments.forEach((item) => {\n      const pekerjaanId = Number(item.pekerjaan_id || item.pekerjaanId || item.id);\n      const weekNumber = Number(item.week_number || item.weekNumber);\n\n      // Phase 2E.1: Determine which field to read based on progressMode\n      const progressMode = this.state?.progressMode || 'planned';\n      let proportion;\n\n      if (progressMode === 'actual') {\n        // Read actual_proportion field\n        proportion = parseFloat(item.actual_proportion ?? item.proportion);\n        console.log(`[DataLoader] Mode ACTUAL: Reading actual_proportion=${item.actual_proportion} for pekerjaan=${pekerjaanId}, week=${weekNumber}`);\n      } else {\n        // Read planned_proportion field (default)\n        proportion = parseFloat(item.planned_proportion ?? item.proportion);\n        console.log(`[DataLoader] Mode PLANNED: Reading planned_proportion=${item.planned_proportion} for pekerjaan=${pekerjaanId}, week=${weekNumber}`);\n      }\n\n      if (!pekerjaanId || !weekNumber || Number.isNaN(proportion)) {\n        return;\n      }\n\n      const column = weekColumnIndex[weekNumber];\n      if (!column) {\n        return;\n      }\n\n      const columnKey = column.fieldId || column.id;\n      if (!columnKey) {\n        return;\n      }\n\n      const cellKey = `${pekerjaanId}-${columnKey}`;\n      // Phase 2E.1: Property delegation ensures this writes to current mode's assignmentMap\n      this.state.assignmentMap.set(cellKey, proportion);\n      mapped += 1;\n    });\n\n    // Phase 2E.1: Log which mode's state received the data\n    const progressMode = this.state?.progressMode || 'planned';\n    console.log(`[DataLoader] ✅ Loaded ${mapped} assignments into ${progressMode.toUpperCase()} state via API v2`);\n  }\n}\n\n// Export utilities for external use\nexport {\n  apiCall,\n  getCookie,\n  deriveTimeScaleFromTahapan,\n  buildPekerjaanTree,\n  flattenTree,\n  initialiseExpandedNodes\n};\n","/**\n * Time Column Generator Module (ES6 Modern Version)\n * Generates time columns for different modes: daily, weekly, monthly, custom\n *\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/time_column_generator_module.js\n * Date: 2025-11-19\n */\n\n// =========================================================================\n// CONSTANTS\n// =========================================================================\n\nconst ONE_DAY_MS = 24 * 60 * 60 * 1000;\n\n// =========================================================================\n// UTILITY FUNCTIONS\n// =========================================================================\n\n/**\n * Format date to short format (DD MMM)\n * @param {Date} date - Date to format\n * @returns {string} Formatted date\n */\nfunction formatDayMonth(date) {\n  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {\n    return '';\n  }\n  const day = date.getDate().toString().padStart(2, '0');\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\n  return `${day}/${month}`;\n}\n\n/**\n * Format date for display\n * @param {Date} date - Date to format\n * @param {string} format - Format type (short|iso|long)\n * @returns {string} Formatted date\n */\nfunction formatDate(date, format = 'short') {\n  if (format === 'short') {\n    const day = date.getDate().toString().padStart(2, '0');\n    const month = date.toLocaleString('id-ID', { month: 'short' });\n    return `${day} ${month}`;\n  } else if (format === 'iso') {\n    return date.toISOString().split('T')[0];\n  }\n  return date.toLocaleDateString('id-ID');\n}\n\n/**\n * Get week number for a date relative to project start\n * @param {Date} targetDate - Target date\n * @param {Date} projectStart - Project start date\n * @param {Object} options - Additional options\n * @param {number} options.weekEndDay - JS weekday (0=Sunday) marking end of week\n * @returns {number} Week number (1-based)\n */\nfunction getWeekNumberForDate(targetDate, projectStart, options = {}) {\n  if (!(targetDate instanceof Date) || Number.isNaN(targetDate.getTime())) {\n    return 1;\n  }\n\n  if (!(projectStart instanceof Date) || Number.isNaN(projectStart.getTime())) {\n    return 1;\n  }\n\n  if (targetDate <= projectStart) {\n    return 1;\n  }\n\n  const resolvedWeekEnd =\n    Number.isInteger(options.weekEndDay) && !Number.isNaN(options.weekEndDay)\n      ? ((options.weekEndDay % 7) + 7) % 7\n      : 0; // Default: Sunday\n\n  // Calculate first week end\n  const firstWeekEnd = new Date(projectStart);\n  const offsetToEnd = (resolvedWeekEnd - projectStart.getDay() + 7) % 7;\n  firstWeekEnd.setDate(firstWeekEnd.getDate() + offsetToEnd);\n\n  if (targetDate <= firstWeekEnd) {\n    return 1;\n  }\n\n  // Calculate week number\n  const daysAfterFirst = Math.floor((targetDate - firstWeekEnd) / ONE_DAY_MS);\n  return 1 + Math.floor((daysAfterFirst + 6) / 7);\n}\n\n// =========================================================================\n// TIME COLUMN GENERATOR CLASS\n// =========================================================================\n\n/**\n * TimeColumnGenerator class - generates time columns from tahapan data\n */\nexport class TimeColumnGenerator {\n  constructor(state) {\n    if (!state) {\n      throw new Error('[TimeColumnGenerator] State is required');\n    }\n\n    this.state = state;\n  }\n\n  /**\n   * Generate time columns from loaded tahapan data\n   * Maps database tahapan to grid time columns based on current time scale mode.\n   *\n   * FILTERING LOGIC:\n   * - daily/weekly/monthly: Shows ONLY auto-generated tahapan with matching generation_mode\n   * - custom: Shows ALL tahapan (both auto-generated and manually created)\n   *\n   * CRITICAL: Each column MUST have tahapanId for save functionality to work!\n   *\n   * @returns {Array} Generated time columns\n   */\n  generate() {\n    this.state.timeColumns = [];\n    this._projectStartCache = undefined;\n    this._jsWeekEndDayCache = undefined;\n\n    const timeScale = this.state.timeScale || 'custom';\n    const tahapanList = this.state.tahapanList || [];\n\n    console.log(`[TimeColumnGenerator] Generating columns for mode: ${timeScale}`);\n    console.log(`[TimeColumnGenerator] Available tahapan in database: ${tahapanList.length}`);\n\n    // Map tahapan to time columns\n    tahapanList.forEach((tahap, index) => {\n      // For daily/weekly/monthly modes, only include tahapan with matching generation_mode\n      // For custom mode, include all tahapan\n      let shouldInclude = false;\n\n      if (timeScale === 'custom') {\n        // Custom mode: include all tahapan\n        shouldInclude = true;\n      } else {\n        // Daily/weekly/monthly: only include AUTO-GENERATED tahapan with matching generation_mode\n        shouldInclude = (\n          tahap.is_auto_generated === true &&\n          tahap.generation_mode === timeScale\n        );\n      }\n\n      if (shouldInclude) {\n        const column = this._createColumn(tahap, index);\n        this.state.timeColumns.push(column);\n      }\n    });\n\n    // FALLBACK: If no columns generated, show all tahapan\n    if (this.state.timeColumns.length === 0 && tahapanList.length > 0) {\n      console.warn(`[TimeColumnGenerator] No auto-generated tahapan found for mode \"${timeScale}\"`);\n      console.warn(`[TimeColumnGenerator] Showing all ${tahapanList.length} tahapan as fallback`);\n\n      tahapanList.forEach((tahap, index) => {\n        const column = this._createColumn(tahap, index);\n        this.state.timeColumns.push(column);\n      });\n    }\n\n    console.log(`[TimeColumnGenerator] ✅ Generated ${this.state.timeColumns.length} time columns`);\n    return this.state.timeColumns;\n  }\n\n  /**\n   * Create a column object from tahapan data\n   * @param {Object} tahap - Tahapan data\n   * @param {number} index - Index in list\n   * @returns {Object} Column object\n   * @private\n   */\n  _createColumn(tahap, index) {\n    const startDate = tahap.tanggal_mulai ? new Date(tahap.tanggal_mulai) : null;\n    const endDate = tahap.tanggal_selesai ? new Date(tahap.tanggal_selesai) : null;\n\n    let label = tahap.nama || `Tahap ${index + 1}`;\n    let rangeLabel = '';\n    let rangeText = '';\n    let tooltip = label;\n    let weekNumber = null;\n    let shortStart = '';\n    let shortEnd = '';\n    const resolvedOrder =\n      Number.isInteger(tahap.urutan) && tahap.urutan >= 0 ? tahap.urutan : index;\n\n    const isWeeklyMode =\n      (this.state.timeScale || '').toLowerCase() === 'weekly' ||\n      (tahap.generation_mode || '').toLowerCase() === 'weekly';\n    const projectStartDate = this._getProjectStartDate();\n    const jsWeekEndDay = this._getJsWeekEndDay();\n    const computedWeekNumber =\n      isWeeklyMode && startDate && projectStartDate\n        ? getWeekNumberForDate(startDate, projectStartDate, { weekEndDay: jsWeekEndDay })\n        : null;\n\n    // Special formatting for weekly mode\n    if (\n      tahap.is_auto_generated === true &&\n      tahap.generation_mode === 'weekly' &&\n      startDate &&\n      endDate\n    ) {\n      weekNumber = computedWeekNumber ?? resolvedOrder + 1;\n\n      shortStart = formatDayMonth(startDate);\n      shortEnd = formatDayMonth(endDate);\n\n      label = `Week ${weekNumber}`;\n      rangeLabel = `( ${shortStart} - ${shortEnd} )`;\n      rangeText = `${shortStart}\\u00A0-\\u00A0${shortEnd}`;\n\n      const longStart = startDate.toLocaleDateString('id-ID', {\n        weekday: 'long',\n        day: '2-digit',\n        month: 'long',\n        year: 'numeric'\n      });\n      const longEnd = endDate.toLocaleDateString('id-ID', {\n        weekday: 'long',\n        day: '2-digit',\n        month: 'long',\n        year: 'numeric'\n      });\n\n      tooltip = `Week ${weekNumber}: ${longStart} - ${longEnd}`;\n    } else if (startDate && endDate) {\n      shortStart = formatDayMonth(startDate);\n      shortEnd = formatDayMonth(endDate);\n      rangeLabel = `( ${shortStart} - ${shortEnd} )`;\n      rangeText = `${shortStart}\\u00A0-\\u00A0${shortEnd}`;\n    }\n\n    if (!weekNumber && isWeeklyMode) {\n      weekNumber = computedWeekNumber ?? resolvedOrder + 1;\n    }\n\n    const safeTahapanId = tahap.tahapan_id || tahap.id || resolvedOrder;\n    const fieldId = `col_${safeTahapanId}`;\n\n    return {\n      id: `tahap-${safeTahapanId}`,\n      fieldId,\n      tahapanId: tahap.tahapan_id,  // CRITICAL: Link to database tahapan!\n      label,\n      rangeLabel,\n      rangeText,\n      tooltip,\n      type: tahap.generation_mode || 'custom',\n      isAutoGenerated: tahap.is_auto_generated || false,\n      generationMode: tahap.generation_mode || 'custom',\n      index: resolvedOrder,\n      weekNumber,\n      startDate,\n      endDate,\n      urutan: tahap.urutan || index\n    };\n  }\n\n  /**\n   * Get column by ID\n   * @param {string} columnId - Column ID\n   * @returns {Object|null} Column object\n   */\n  getColumnById(columnId) {\n    return this.state.timeColumns.find(col => col.id === columnId) || null;\n  }\n\n  /**\n   * Get column by tahapan ID\n   * @param {number} tahapanId - Tahapan ID\n   * @returns {Object|null} Column object\n   */\n  getColumnByTahapanId(tahapanId) {\n    return this.state.timeColumns.find(col => col.tahapanId === tahapanId) || null;\n  }\n\n  /**\n   * Get columns for date range\n   * @param {Date} startDate - Start date\n   * @param {Date} endDate - End date\n   * @returns {Array} Columns in range\n   */\n  getColumnsInRange(startDate, endDate) {\n    return this.state.timeColumns.filter(col => {\n      if (!col.startDate || !col.endDate) return false;\n      return col.startDate <= endDate && col.endDate >= startDate;\n    });\n  }\n\n  /**\n   * Regenerate columns (refresh from tahapan list)\n   * @returns {Array} New time columns\n   */\n  regenerate() {\n    console.log('[TimeColumnGenerator] Regenerating columns...');\n    return this.generate();\n  }\n\n  _getProjectStartDate() {\n    if (typeof this._projectStartCache !== 'undefined') {\n      return this._projectStartCache;\n    }\n    const raw = this.state.projectStart;\n    if (!raw) {\n      this._projectStartCache = null;\n      return this._projectStartCache;\n    }\n    if (raw instanceof Date) {\n      this._projectStartCache = Number.isNaN(raw.getTime()) ? null : raw;\n      return this._projectStartCache;\n    }\n    const parsed = new Date(raw);\n    this._projectStartCache = Number.isNaN(parsed.getTime()) ? null : parsed;\n    return this._projectStartCache;\n  }\n\n  _getJsWeekEndDay() {\n    if (typeof this._jsWeekEndDayCache !== 'undefined') {\n      return this._jsWeekEndDayCache;\n    }\n    const pyWeekEnd = Number(this.state.weekEndDay);\n    const normalizedPy = Number.isFinite(pyWeekEnd) ? ((pyWeekEnd % 7) + 7) % 7 : 6;\n    this._jsWeekEndDayCache = (normalizedPy + 1) % 7; // Convert Monday-based to JS Sunday-based\n    return this._jsWeekEndDayCache;\n  }\n}\n\n// Export utilities\nexport {\n  formatDate,\n  formatDayMonth,\n  getWeekNumberForDate\n};\n","/**\n * Save Handler Module (ES6 Modern Version)\n * Handles saving modified cells to Django backend\n *\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/save_handler_module.js\n * Date: 2025-11-19\n */\n\n// =========================================================================\n// UTILITY FUNCTIONS\n// =========================================================================\n\n/**\n * Get CSRF token from cookies\n * @returns {string|null} CSRF token\n */\nfunction getCookie(name) {\n  let cookieValue = null;\n  if (document.cookie && document.cookie !== '') {\n    const cookies = document.cookie.split(';');\n    for (let i = 0; i < cookies.length; i++) {\n      const cookie = cookies[i].trim();\n      if (cookie.substring(0, name.length + 1) === (name + '=')) {\n        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));\n        break;\n      }\n    }\n  }\n  return cookieValue;\n}\n\n// =========================================================================\n// SAVE HANDLER CLASS\n// =========================================================================\n\n/**\n * SaveHandler - Manages save operations for grid data\n * Handles building payloads, API calls, and state updates\n */\nexport class SaveHandler {\n  /**\n   * Create a SaveHandler instance\n   * @param {Object} state - Application state\n   * @param {Object} options - Configuration options\n   * @param {string} options.apiUrl - API endpoint URL\n   * @param {Function} options.onSuccess - Success callback\n   * @param {Function} options.onError - Error callback\n   * @param {Function} options.showToast - Toast notification function\n   */\n  constructor(state, options = {}) {\n    if (!state) {\n      throw new Error('[SaveHandler] State is required');\n    }\n\n    this.state = state;\n    this.options = options;\n\n    // API configuration\n    this.apiUrl = options.apiUrl || `/detail_project/api/project/${state.projectId}/pekerjaan/assign_weekly/`;\n\n    // Callbacks\n    this.onSuccess = options.onSuccess || (() => {});\n    this.onError = options.onError || ((err) => console.error(err));\n    this.showToast = options.showToast || ((msg, type) => console.log(`[${type}] ${msg}`));\n\n    // Save state\n    this.isSaving = false;\n\n    console.log('[SaveHandler] Initialized with API:', this.apiUrl);\n  }\n\n  // =======================================================================\n  // MAIN SAVE OPERATION\n  // =======================================================================\n\n  /**\n   * Save all modified cells to server\n   * Main entry point for save operation\n   * @returns {Promise<Object>} Save result\n   */\n  async save() {\n    if (this.isSaving) {\n      console.warn('[SaveHandler] Save already in progress');\n      this.showToast('Penyimpanan sedang berlangsung...', 'warning');\n      return { success: false, reason: 'already_saving' };\n    }\n\n    console.log('[SaveHandler] Starting save operation...');\n    this.isSaving = true;\n\n    try {\n      // Check if there are any changes\n      if (!this.state.modifiedCells || this.state.modifiedCells.size === 0) {\n        console.warn('[SaveHandler] No modified cells to save');\n        this.showToast('Tidak ada perubahan untuk disimpan', 'info');\n        this.isSaving = false;\n        return { success: false, reason: 'no_changes' };\n      }\n\n      // Build payload\n      const payload = this._buildPayload();\n      const payloadCount = payload.assignments?.length ?? payload.items?.length ?? 0;\n      console.log(`[SaveHandler] Built payload with ${payloadCount} items`);\n\n      // Send to server\n      const result = await this._sendToServer(payload);\n\n      // Handle success\n      this._handleSaveSuccess(result);\n\n      this.isSaving = false;\n      return { success: true, result };\n\n    } catch (error) {\n      // Handle error\n      this._handleSaveError(error);\n      this.isSaving = false;\n      return { success: false, error };\n    }\n  }\n\n  // =======================================================================\n  // PAYLOAD BUILDING\n  // =======================================================================\n\n  /**\n   * Build save payload from modified cells\n   * Converts modifiedCells Map to API format\n   * @returns {Object} Payload object\n   * @private\n   */\n  _buildPayload() {\n    const assignments = [];\n\n    // Phase 2E.1: Log which mode's modifiedCells we're reading from\n    const progressMode = this.state?.progressMode || 'planned';\n    console.log(`[SaveHandler] Building payload from ${progressMode.toUpperCase()} modifiedCells (size: ${this.state.modifiedCells.size})`);\n\n    // Convert modifiedCells Map to array of assignments\n    // Phase 2E.1: Property delegation ensures this reads from current mode's modifiedCells\n    this.state.modifiedCells.forEach((value, cellKey) => {\n      // Parse cellKey (format: \"nodeId-columnId\")\n      const [pekerjaanId, tahapanId] = cellKey.split('-');\n\n      if (!pekerjaanId || !tahapanId) {\n        console.warn(`[SaveHandler] Invalid cell key: ${cellKey}`);\n        return;\n      }\n\n      // Get numeric value\n      const proportion = parseFloat(value);\n      if (!Number.isFinite(proportion)) {\n        console.warn(`[SaveHandler] Invalid value for ${cellKey}: ${value}`);\n        return;\n      }\n\n      // Get column info for additional metadata\n      const column = this.state.timeColumns?.find((col) => {\n        const key = col.fieldId || col.id;\n        return key?.toString() === tahapanId.toString();\n      });\n\n      // Build item\n      const item = {\n        pekerjaan_id: parseInt(pekerjaanId, 10),\n        proportion: Number(proportion.toFixed(2)),\n      };\n\n      if (column) {\n        const tahapanPrimaryId =\n          column.tahapanId ??\n          column.tahapan_id ??\n          (Number.isFinite(Number(column.id)) ? Number(column.id) : null);\n        if (tahapanPrimaryId) {\n          item.tahapan_id = tahapanPrimaryId;\n        }\n\n        if (column.startDate) {\n          item.week_start = this._formatDate(column.startDate);\n        }\n        if (column.endDate) {\n          item.week_end = this._formatDate(column.endDate);\n        }\n        if (Number.isFinite(column.weekNumber)) {\n          item.week_number = column.weekNumber;\n        }\n\n        if (!item.week_number) {\n          const normalizedOrder = Number.isFinite(column.index)\n            ? Number(column.index)\n            : Number.isFinite(column.order)\n              ? Number(column.order)\n              : Number.isFinite(column.urutan)\n                ? Number(column.urutan)\n                : null;\n          if (normalizedOrder !== null) {\n            item.week_number = normalizedOrder + 1;\n          }\n        }\n      } else {\n        const numericTahapan = parseInt(tahapanId, 10);\n        if (Number.isFinite(numericTahapan)) {\n          item.tahapan_id = numericTahapan;\n        }\n      }\n\n      if (!item.week_number) {\n        const fallbackWeek = parseInt(item.tahapan_id ?? tahapanId, 10);\n        if (Number.isFinite(fallbackWeek)) {\n          item.week_number = fallbackWeek;\n        } else {\n          // Default to 1 as last resort to satisfy backend validation\n          item.week_number = 1;\n        }\n      }\n\n      assignments.push(item);\n    });\n\n    console.log(`[SaveHandler] Built ${assignments.length} assignment items`);\n\n    // Phase 2E.1: progressMode already declared at top of function\n    console.log(`[SaveHandler] Progress Mode: ${progressMode.toUpperCase()} - Will save to ${progressMode === 'actual' ? 'actual_proportion' : 'planned_proportion'} field`);\n\n    const payload = {\n      assignments,\n      mode: progressMode,  // Phase 2E.1: 'planned' or 'actual' (determines field to update)\n      project_id: this.state.projectId,\n      week_end_day: this.state.weekEndDay ?? 6,\n    };\n\n    console.log(`[SaveHandler] Payload:`, JSON.stringify(payload, null, 2));\n\n    return payload;\n  }\n\n  /**\n   * Format date for API (YYYY-MM-DD)\n   * @param {Date} date - Date to format\n   * @returns {string} Formatted date\n   * @private\n   */\n  _formatDate(date) {\n    if (!(date instanceof Date)) {\n      date = new Date(date);\n    }\n    if (Number.isNaN(date.getTime())) {\n      return '';\n    }\n    return date.toISOString().split('T')[0];\n  }\n\n  // =======================================================================\n  // API COMMUNICATION\n  // =======================================================================\n\n  /**\n   * Send payload to server\n   * @param {Object} payload - Payload to send\n   * @returns {Promise<Object>} Server response\n   * @private\n   */\n  async _sendToServer(payload) {\n    console.log('[SaveHandler] Sending request to:', this.apiUrl);\n    console.log('[SaveHandler] Payload:', payload);\n\n    const csrfToken = getCookie('csrftoken');\n\n    const response = await fetch(this.apiUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-CSRFToken': csrfToken\n      },\n      credentials: 'same-origin',\n      body: JSON.stringify(payload)\n    });\n\n    if (!response.ok) {\n      let errorData = {};\n      let parsedBody = null;\n      try {\n        parsedBody = await response.json();\n        errorData = parsedBody || {};\n      } catch (jsonError) {\n        const fallbackText = await response.text().catch(() => '');\n        errorData = { message: fallbackText };\n      }\n\n      const errorMsg = errorData.error || errorData.message || `HTTP ${response.status}`;\n      const error = new Error(errorMsg);\n      if (errorData.errors) {\n        error.details = errorData.errors;\n      }\n      if (errorData.validation_errors) {\n        error.validationErrors = errorData.validation_errors;\n      }\n      if (typeof errorData === 'object') {\n        error.payload = errorData;\n      }\n      throw error;\n    }\n\n    const result = await response.json();\n    console.log('[SaveHandler] Server response:', result);\n\n    return result;\n  }\n\n  // =======================================================================\n  // RESPONSE HANDLING\n  // =======================================================================\n\n  /**\n   * Handle successful save\n   * @param {Object} result - Server response\n   * @private\n   */\n  _handleSaveSuccess(result) {\n    console.log('[SaveHandler] ✅ Save successful');\n\n    // Update assignmentMap with saved values\n    this._updateAssignmentMap();\n\n    // Clear modified cells\n    const modifiedCount = this.state.modifiedCells.size;\n    this.state.modifiedCells.clear();\n    if (this.state.cellVolumeOverrides instanceof Map) {\n      this.state.cellVolumeOverrides.clear();\n    }\n\n    // Update UI status\n    if (this.state.cache) {\n      this.state.cache.hasUnsavedChanges = false;\n    }\n\n    // Show success message\n    const savedCount = result.saved_count || result.count || modifiedCount;\n    const message = `Berhasil menyimpan ${savedCount} perubahan`;\n    this.showToast(message, 'success');\n\n    // Call success callback\n    if (typeof this.onSuccess === 'function') {\n      this.onSuccess(result);\n    }\n\n    console.log(`[SaveHandler] Saved ${savedCount} assignments, cleared ${modifiedCount} modified cells`);\n  }\n\n  /**\n   * Handle save error\n   * @param {Error} error - Error object\n   * @private\n   */\n  _handleSaveError(error) {\n    console.error('[SaveHandler] ❌ Save failed:', error);\n\n    const detailMessages = [];\n    if (Array.isArray(error.validationErrors) && error.validationErrors.length > 0) {\n      error.validationErrors.slice(0, 3).forEach((item) => {\n        if (item?.error) {\n          detailMessages.push(`• ${item.error}`);\n        }\n      });\n      if (error.validationErrors.length > 3) {\n        detailMessages.push(`(+${error.validationErrors.length - 3} lagi)`);\n      }\n    }\n\n    if (Array.isArray(error.details) && error.details.length > 0) {\n      error.details.slice(0, 3).forEach((item) => {\n        if (item?.error) {\n          detailMessages.push(`• ${item.error}`);\n        }\n      });\n      if (error.details.length > 3) {\n        detailMessages.push(`(+${error.details.length - 3} lagi)`);\n      }\n    }\n\n    let message = `Gagal menyimpan: ${error.message}`;\n    if (detailMessages.length > 0) {\n      message += `\\n${detailMessages.join('\\n')}`;\n    }\n    this.showToast(message, 'danger', 5000);\n\n    // Call error callback\n    if (typeof this.onError === 'function') {\n      this.onError(error);\n    }\n  }\n\n  /**\n   * Update assignmentMap with modified values\n   * Moves modified values from modifiedCells to assignmentMap\n   * @private\n   */\n  _updateAssignmentMap() {\n    if (!this.state.assignmentMap) {\n      this.state.assignmentMap = new Map();\n    }\n\n    this.state.modifiedCells.forEach((value, cellKey) => {\n      const numericValue = parseFloat(value);\n      if (Number.isFinite(numericValue)) {\n        this.state.assignmentMap.set(cellKey, numericValue);\n      }\n    });\n\n    console.log('[SaveHandler] Updated assignmentMap with modified values');\n  }\n\n  // =======================================================================\n  // UTILITY METHODS\n  // =======================================================================\n\n  /**\n   * Check if there are unsaved changes\n   * @returns {boolean} True if has unsaved changes\n   */\n  hasUnsavedChanges() {\n    return this.state.modifiedCells && this.state.modifiedCells.size > 0;\n  }\n\n  /**\n   * Get count of modified cells\n   * @returns {number} Number of modified cells\n   */\n  getModifiedCount() {\n    return this.state.modifiedCells ? this.state.modifiedCells.size : 0;\n  }\n\n  /**\n   * Validate payload before sending\n   * @param {Object} payload - Payload to validate\n   * @returns {Object} Validation result\n   */\n  validatePayload(payload) {\n    const errors = [];\n    const warnings = [];\n\n    const assignments = Array.isArray(payload?.assignments)\n      ? payload.assignments\n      : Array.isArray(payload?.items)\n        ? payload.items\n        : null;\n\n    if (!assignments) {\n      errors.push('Invalid payload structure');\n      return { isValid: false, errors, warnings };\n    }\n\n    if (assignments.length === 0) {\n      warnings.push('No items to save');\n    }\n\n    // Validate each item\n    assignments.forEach((item, index) => {\n      if (!item.pekerjaan_id) {\n        errors.push(`Item ${index}: Missing pekerjaan_id`);\n      }\n      if (!item.week_number) {\n        warnings.push(`Item ${index}: Missing week_number (akan memakai default)`);\n      }\n      if (typeof item.proportion === 'undefined') {\n        errors.push(`Item ${index}: Missing proportion value`);\n      } else if (!Number.isFinite(item.proportion)) {\n        errors.push(`Item ${index}: Invalid proportion value`);\n      } else if (item.proportion < 0 || item.proportion > 100) {\n        warnings.push(`Item ${index}: Proportion out of range (${item.proportion}%)`);\n      }\n    });\n\n    const isValid = errors.length === 0;\n\n    if (!isValid) {\n      console.error('[SaveHandler] Payload validation failed:', errors);\n    }\n\n    if (warnings.length > 0) {\n      console.warn('[SaveHandler] Payload validation warnings:', warnings);\n    }\n\n    return { isValid, errors, warnings };\n  }\n\n  /**\n   * Cancel save operation\n   */\n  cancel() {\n    if (this.isSaving) {\n      console.log('[SaveHandler] Cancelling save operation...');\n      this.isSaving = false;\n      // Note: Cannot actually abort fetch request without AbortController\n      // This just sets the flag\n    }\n  }\n\n  /**\n   * Get save statistics\n   * @returns {Object} Save statistics\n   */\n  getStats() {\n    return {\n      modifiedCells: this.getModifiedCount(),\n      isSaving: this.isSaving,\n      hasUnsavedChanges: this.hasUnsavedChanges(),\n      apiUrl: this.apiUrl\n    };\n  }\n}\n\n// Export utility functions\nexport {\n  getCookie\n};\n"],"names":["apiCall","_0","__async","this","arguments","url","options","method","toUpperCase","includes","headers","name","cookieValue","document","cookie","cookies","split","i","length","trim","substring","decodeURIComponent","getCookie","response","fetch","__spreadValues","credentials","ok","error","json","catch","Error","status","flattenTree","tree","result","forEach","node","push","children","DataLoader","constructor","state","projectId","volumeMap","Map","assignmentMap","cache","loadAllData","_a","_b","initialLoadInProgress","console","info","force","initialLoadCompleted","skipIfLoaded","initialLoadResult","log","Promise","all","loadTahapan","loadPekerjaan","loadVolumes","loadAssignments","completedAt","Date","now","tahapanCount","tahapanList","pekerjaanCount","flatPekerjaan","filter","type","initialLoadError","apiBase","data","tahapan","sort","a","b","urutan","detectedMode","fallbackMode","Array","isArray","autoCounts","daily","weekly","monthly","autoTotal","manualCount","tahap","is_auto_generated","generation_mode","mode","toLowerCase","hasOwnProperty","dominantMode","Object","entries","reduce","bestMode","entry","count","deriveTimeScaleFromTahapan","timeScale","klasifikasi","klas","klasNode","id","nama","level","expanded","sub","subNode","pekerjaan","pkj","pkjNode","pekerjaan_id","kode","snapshot_kode","snapshot_uraian","uraian","volume","satuan","snapshot_satuan","buildPekerjaanTree","pekerjaanTree","expandedNodes","Set","size","collectIds","nodes","add","initialiseExpandedNodes","clear","volumes","items","v","pkjId","qty","parseFloat","quantity","set","pekerjaanNodes","_loadAssignmentsViaV2","reload","loader","assignments","_buildWeekColumnIndex","weekColumnIndex","timeColumns","col","weekNumber","Number","week_number","isFinite","mapped","item","_c","pekerjaanId","proportion","progressMode","actual_proportion","planned_proportion","isNaN","column","columnKey","fieldId","cellKey","formatDayMonth","date","getTime","getDate","toString","padStart","getMonth","TimeColumnGenerator","generate","_projectStartCache","_jsWeekEndDayCache","index","shouldInclude","_createColumn","warn","startDate","tanggal_mulai","endDate","tanggal_selesai","label","rangeLabel","rangeText","tooltip","shortStart","shortEnd","resolvedOrder","isInteger","isWeeklyMode","projectStartDate","_getProjectStartDate","jsWeekEndDay","_getJsWeekEndDay","computedWeekNumber","targetDate","projectStart","resolvedWeekEnd","weekEndDay","firstWeekEnd","offsetToEnd","getDay","setDate","daysAfterFirst","Math","floor","getWeekNumberForDate","toLocaleDateString","weekday","day","month","year","safeTahapanId","tahapan_id","tahapanId","isAutoGenerated","generationMode","getColumnById","columnId","find","getColumnByTahapanId","getColumnsInRange","regenerate","raw","parsed","pyWeekEnd","normalizedPy","SaveHandler","apiUrl","onSuccess","onError","err","showToast","msg","isSaving","save","_d","success","reason","modifiedCells","payload","_buildPayload","payloadCount","_sendToServer","_handleSaveSuccess","_handleSaveError","value","key","parseInt","toFixed","tahapanPrimaryId","week_start","_formatDate","week_end","normalizedOrder","order","numericTahapan","fallbackWeek","project_id","week_end_day","JSON","stringify","toISOString","csrfToken","body","errorData","parsedBody","jsonError","message","text","errorMsg","errors","details","validation_errors","validationErrors","_updateAssignmentMap","modifiedCount","cellVolumeOverrides","hasUnsavedChanges","savedCount","saved_count","detailMessages","slice","join","numericValue","getModifiedCount","validatePayload","warnings","isValid","cancel","getStats"],"mappings":"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"}