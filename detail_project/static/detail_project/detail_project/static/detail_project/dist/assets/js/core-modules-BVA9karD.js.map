{"version":3,"file":"core-modules-BVA9karD.js","sources":["../../../../../../js/src/modules/core/mode-state.js","../../../../../../js/src/modules/core/state-manager.js","../../../../../../js/src/modules/core/time-column-generator.js","../../../../../../js/src/modules/core/data-loader.js","../../../../../../js/src/modules/core/save-handler.js"],"sourcesContent":["/**\n * ModeState - Holds state for a single progress mode (planned or actual)\n *\n * Phase 0.2: StateManager Architecture\n *\n * This class encapsulates all data for one mode:\n * - assignmentMap: Saved data from backend (Map<cellKey, value>)\n * - modifiedCells: Unsaved changes from user input (Map<cellKey, value>)\n * - isDirty: Flag indicating if cache needs invalidation\n *\n * @class ModeState\n */\nexport class ModeState {\n  /**\n   * Create a new ModeState\n   */\n  constructor() {\n    /**\n     * Saved assignment values from backend\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (percentage 0-100)\n     * @type {Map<string, number>}\n     */\n    this.assignmentMap = new Map();\n\n    /**\n     * Modified cell values (unsaved changes)\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (percentage 0-100)\n     * @type {Map<string, number>}\n     */\n    this.modifiedCells = new Map();\n\n    /**\n     * Saved actual cost values (only applicable for actual mode but shared API)\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (rupiah)\n     * @type {Map<string, number>}\n     */\n    this.costAssignmentMap = new Map();\n\n    /**\n     * Modified actual cost values waiting to be saved\n     * Key format: \"{pekerjaanId}-{columnId}\"\n     * Value: number (rupiah)\n     * @type {Map<string, number>}\n     */\n    this.costModifiedCells = new Map();\n\n    /**\n     * Dirty flag for cache invalidation\n     * Set to true when modifiedCells changes\n     * @type {boolean}\n     */\n    this.isDirty = false;\n  }\n\n  /**\n   * Serialize state to JSON\n   * Useful for debugging and persistence\n   * @returns {Object}\n   */\n  toJSON() {\n    return {\n      assignmentMap: Array.from(this.assignmentMap.entries()),\n      modifiedCells: Array.from(this.modifiedCells.entries()),\n      costAssignmentMap: Array.from(this.costAssignmentMap.entries()),\n      costModifiedCells: Array.from(this.costModifiedCells.entries()),\n      isDirty: this.isDirty\n    };\n  }\n\n  /**\n   * Deserialize state from JSON\n   * @param {Object} data - Serialized state data\n   * @returns {ModeState}\n   */\n  static fromJSON(data) {\n    const state = new ModeState();\n\n    if (data.assignmentMap && Array.isArray(data.assignmentMap)) {\n      state.assignmentMap = new Map(data.assignmentMap);\n    }\n\n    if (data.modifiedCells && Array.isArray(data.modifiedCells)) {\n      state.modifiedCells = new Map(data.modifiedCells);\n    }\n\n    if (data.costAssignmentMap && Array.isArray(data.costAssignmentMap)) {\n      state.costAssignmentMap = new Map(data.costAssignmentMap);\n    }\n\n    if (data.costModifiedCells && Array.isArray(data.costModifiedCells)) {\n      state.costModifiedCells = new Map(data.costModifiedCells);\n    }\n\n    if (typeof data.isDirty === 'boolean') {\n      state.isDirty = data.isDirty;\n    }\n\n    return state;\n  }\n\n  /**\n   * Get statistics about this mode state\n   * @returns {Object}\n   */\n  getStats() {\n    return {\n      assignmentCount: this.assignmentMap.size,\n      modifiedCount: this.modifiedCells.size,\n      costAssignmentCount: this.costAssignmentMap.size,\n      costModifiedCount: this.costModifiedCells.size,\n      isDirty: this.isDirty,\n      hasUnsavedChanges: this.modifiedCells.size > 0 || this.costModifiedCells.size > 0\n    };\n  }\n\n  /**\n   * Clear all data from this mode state\n   */\n  clear() {\n    this.assignmentMap.clear();\n    this.modifiedCells.clear();\n    this.costAssignmentMap.clear();\n    this.costModifiedCells.clear();\n    this.isDirty = true;\n  }\n\n  /**\n   * Clone this mode state (deep copy)\n   * @returns {ModeState}\n   */\n  clone() {\n    const cloned = new ModeState();\n    cloned.assignmentMap = new Map(this.assignmentMap);\n    cloned.modifiedCells = new Map(this.modifiedCells);\n    cloned.costAssignmentMap = new Map(this.costAssignmentMap);\n    cloned.costModifiedCells = new Map(this.costModifiedCells);\n    cloned.isDirty = this.isDirty;\n    return cloned;\n  }\n}\n\nexport default ModeState;\n","/**\n * StateManager - Singleton for managing dual-mode progress state\n *\n * Phase 0.2: StateManager Architecture\n *\n * This class replaces the fragmented state management pattern with a single\n * source of truth. It manages both 'planned' and 'actual' progress states\n * and provides a clean API for reading/writing cell values.\n *\n * Key features:\n * - Singleton pattern (one instance per application)\n * - Dual state architecture (planned vs actual)\n * - Smart caching with automatic invalidation\n * - Event-driven updates (pub/sub pattern)\n * - Thread-safe state switching\n *\n * @class StateManager\n */\n\nimport { ModeState } from './mode-state.js';\n\nconst LOG_PREFIX = '[StateManager]';\n\nexport class StateManager {\n  /**\n   * Singleton instance\n   * @private\n   * @static\n   * @type {StateManager|null}\n   */\n  static instance = null;\n\n  /**\n   * Get singleton instance\n   * @returns {StateManager}\n   */\n  static getInstance() {\n    if (!StateManager.instance) {\n      StateManager.instance = new StateManager();\n      console.log(LOG_PREFIX, 'Singleton instance created');\n    }\n    return StateManager.instance;\n  }\n\n  /**\n   * Private constructor (use getInstance() instead)\n   * @private\n   */\n  constructor() {\n    if (StateManager.instance) {\n      throw new Error('StateManager is a singleton. Use StateManager.getInstance()');\n    }\n\n    /**\n     * Current progress mode ('planned' or 'actual')\n     * @type {string}\n     */\n    this.currentMode = 'planned';\n\n    /**\n     * Mode-specific state storage\n     * @type {Object}\n     */\n    this.states = {\n      planned: new ModeState(),\n      actual: new ModeState()\n    };\n\n    /**\n     * Merged cell values cache\n     * Key: \"cells:{mode}\"\n     * Value: Map<cellKey, number>\n     * @private\n     * @type {Map<string, Map<string, number>>}\n     */\n    this._mergedCellsCache = new Map();\n\n    /**\n     * Event listeners for state changes\n     * @private\n     * @type {Set<Function>}\n     */\n    this._listeners = new Set();\n\n    console.log(LOG_PREFIX, 'Initialized with dual state architecture');\n  }\n\n  /**\n   * Get value for a specific cell\n   * Reads from modifiedCells first, then assignmentMap\n   *\n   * @param {number|string} pekerjaanId - Pekerjaan ID\n   * @param {string} columnId - Column ID (e.g., \"col_123\")\n   * @returns {number} Cell value (0 if not found)\n   */\n  getCellValue(pekerjaanId, columnId) {\n    const state = this._getCurrentState();\n    const cellKey = `${pekerjaanId}-${columnId}`;\n\n    // Priority: modifiedCells > assignmentMap > 0\n    return state.modifiedCells.get(cellKey) ??\n           state.assignmentMap.get(cellKey) ??\n           0;\n  }\n\n  /**\n   * Get all cell values for a specific mode (merged view)\n   * Returns assignmentMap + modifiedCells combined\n   * Uses cache for performance\n   *\n   * @param {string} mode - 'planned' or 'actual'\n   * @returns {Map<string, number>} Merged cell values\n   */\n  getAllCellsForMode(mode) {\n    const modeState = this.states[mode];\n    if (!modeState) {\n      console.error(LOG_PREFIX, `Invalid mode: ${mode}`);\n      return new Map();\n    }\n\n    const cacheKey = `cells:${mode}`;\n\n    // Return cached if available and not dirty\n    if (this._mergedCellsCache.has(cacheKey) && !modeState.isDirty) {\n      return this._mergedCellsCache.get(cacheKey);\n    }\n\n    // Build merged map: assignmentMap + modifiedCells\n    const merged = new Map(modeState.assignmentMap);\n\n    // Override with modified cells\n    modeState.modifiedCells.forEach((value, key) => {\n      merged.set(key, value);\n    });\n\n    // Cache it\n    this._mergedCellsCache.set(cacheKey, merged);\n    modeState.isDirty = false;\n\n    console.log(LOG_PREFIX, `Built merged cells for ${mode.toUpperCase()}: ${merged.size} cells`);\n\n    return merged;\n  }\n\n  /**\n   * Set value for a specific cell (user input)\n   * Writes to modifiedCells, invalidates cache\n   *\n   * @param {number|string} pekerjaanId - Pekerjaan ID\n   * @param {string} columnId - Column ID\n   * @param {number|string} value - Cell value (percentage)\n   */\n  setCellValue(pekerjaanId, columnId, value) {\n    const state = this._getCurrentState();\n    const cellKey = `${pekerjaanId}-${columnId}`;\n    const numericValue = parseFloat(value);\n\n    if (Number.isNaN(numericValue)) {\n      console.warn(LOG_PREFIX, `Invalid value for cell ${cellKey}:`, value);\n      return;\n    }\n\n    // Write to modifiedCells\n    state.modifiedCells.set(cellKey, numericValue);\n\n    // Invalidate cache\n    this._invalidateCache(this.currentMode);\n\n    // Mark as dirty\n    state.isDirty = true;\n\n    console.log(LOG_PREFIX, `Cell ${cellKey} = ${numericValue}% (${this.currentMode.toUpperCase()} mode)`);\n  }\n\n  /**\n   * Switch to a different progress mode\n   * @param {string} newMode - 'planned' or 'actual'\n   */\n  switchMode(newMode) {\n    if (newMode !== 'planned' && newMode !== 'actual') {\n      console.error(LOG_PREFIX, `Invalid mode: ${newMode}`);\n      return;\n    }\n\n    if (this.currentMode === newMode) {\n      console.log(LOG_PREFIX, `Already in ${newMode.toUpperCase()} mode`);\n      return;\n    }\n\n    const oldMode = this.currentMode;\n    this.currentMode = newMode;\n\n    console.log(LOG_PREFIX, `Switched: ${oldMode.toUpperCase()} → ${newMode.toUpperCase()}`);\n\n    // Notify listeners\n    this._notifyListeners({\n      type: 'mode-switch',\n      oldMode,\n      newMode\n    });\n  }\n\n  /**\n   * Commit modified cells to assignmentMap (after save)\n   * Clears modifiedCells and invalidates cache\n   */\n  commitChanges() {\n    const state = this._getCurrentState();\n\n    // Move modifiedCells → assignmentMap\n    state.modifiedCells.forEach((value, key) => {\n      state.assignmentMap.set(key, value);\n    });\n\n    // Move costModifiedCells → costAssignmentMap (used for actual mode)\n    state.costModifiedCells.forEach((value, key) => {\n      if (value === null || typeof value === 'undefined') {\n        state.costAssignmentMap.delete(key);\n        return;\n      }\n      const numeric = Number(value);\n      if (Number.isFinite(numeric) && numeric >= 0) {\n        state.costAssignmentMap.set(key, numeric);\n      } else {\n        state.costAssignmentMap.delete(key);\n      }\n    });\n\n    const count = state.modifiedCells.size + state.costModifiedCells.size;\n    state.modifiedCells.clear();\n    state.costModifiedCells.clear();\n\n    // Invalidate cache\n    this._invalidateCache(this.currentMode);\n\n    console.log(LOG_PREFIX, `Committed ${count} changes to ${this.currentMode.toUpperCase()} assignmentMap`);\n\n    // Notify listeners\n    this._notifyListeners({\n      type: 'commit',\n      mode: this.currentMode,\n      count\n    });\n  }\n\n  /**\n   * Load initial data into assignmentMap\n   * Used by DataLoader after fetching from backend\n   *\n   * @param {string} mode - 'planned' or 'actual'\n   * @param {Map<string, number>} dataMap - Cell key → value map\n   */\n  loadData(mode, dataMap, costDataMap = new Map()) {\n    const state = this.states[mode];\n    if (!state) {\n      console.error(LOG_PREFIX, `Invalid mode: ${mode}`);\n      return;\n    }\n\n    // Replace assignmentMap\n    state.assignmentMap = new Map(dataMap);\n    if (costDataMap instanceof Map) {\n      state.costAssignmentMap = new Map(costDataMap);\n    }\n\n    // Clear modified cells\n    state.modifiedCells.clear();\n    state.costModifiedCells.clear();\n\n    // Invalidate cache\n    this._invalidateCache(mode);\n\n    console.log(LOG_PREFIX, `Loaded ${dataMap.size} assignments into ${mode.toUpperCase()} state`);\n  }\n\n  /**\n   * Set initial value for a cell (from backend data)\n   * Used during data loading phase\n   *\n   * @param {number|string} pekerjaanId\n   * @param {string} columnId\n   * @param {number} plannedValue\n   * @param {number} actualValue\n   */\n  setInitialValue(pekerjaanId, columnId, plannedValue = 0, actualValue = 0, options = {}) {\n    const cellKey = `${pekerjaanId}-${columnId}`;\n\n    // Set planned value\n    if (Number.isFinite(plannedValue) && plannedValue > 0) {\n      this.states.planned.assignmentMap.set(cellKey, plannedValue);\n    }\n\n    // Set actual value\n    if (Number.isFinite(actualValue) && actualValue > 0) {\n      this.states.actual.assignmentMap.set(cellKey, actualValue);\n    }\n\n    const hasCostProp =\n      Object.prototype.hasOwnProperty.call(options || {}, 'actualCost') ||\n      Object.prototype.hasOwnProperty.call(options || {}, 'actual_cost') ||\n      Object.prototype.hasOwnProperty.call(options || {}, 'cost');\n    const actualCost = Number(options?.actualCost ?? options?.cost ?? options?.actual_cost);\n    if (Number.isFinite(actualCost) && actualCost >= 0) {\n      this.states.actual.costAssignmentMap.set(cellKey, actualCost);\n    } else if (hasCostProp) {\n      this.states.actual.costAssignmentMap.delete(cellKey);\n    }\n  }\n\n  /**\n   * Add event listener for state changes\n   * @param {Function} callback - Listener function\n   */\n  addEventListener(callback) {\n    if (typeof callback !== 'function') {\n      console.error(LOG_PREFIX, 'Event listener must be a function');\n      return;\n    }\n\n    this._listeners.add(callback);\n    console.log(LOG_PREFIX, `Added event listener (total: ${this._listeners.size})`);\n  }\n\n  /**\n   * Remove event listener\n   * @param {Function} callback - Listener function\n   */\n  removeEventListener(callback) {\n    this._listeners.delete(callback);\n  }\n\n  /**\n   * Check if there are unsaved changes in current mode\n   * @returns {boolean}\n   */\n  hasUnsavedChanges() {\n    const state = this._getCurrentState();\n    return (\n      (state.modifiedCells && state.modifiedCells.size > 0) ||\n      (state.costModifiedCells && state.costModifiedCells.size > 0)\n    );\n  }\n\n  /**\n   * Get statistics about state manager\n   * @returns {Object}\n   */\n  getStats() {\n    return {\n      currentMode: this.currentMode,\n      planned: this.states.planned.getStats(),\n      actual: this.states.actual.getStats(),\n      cacheSize: this._mergedCellsCache.size,\n      listenerCount: this._listeners.size\n    };\n  }\n\n  /**\n   * Get current mode state\n   * @private\n   * @returns {ModeState}\n   */\n  _getCurrentState() {\n    return this.states[this.currentMode];\n  }\n\n  /**\n   * Invalidate cache for a specific mode\n   * @private\n   * @param {string} mode\n   */\n  _invalidateCache(mode) {\n    const cacheKey = `cells:${mode}`;\n    this._mergedCellsCache.delete(cacheKey);\n\n    const state = this.states[mode];\n    if (state) {\n      state.isDirty = true;\n    }\n  }\n\n  /**\n   * Notify all event listeners\n   * @private\n   * @param {Object} event - Event data\n   */\n  _notifyListeners(event) {\n    this._listeners.forEach(listener => {\n      try {\n        listener(event);\n      } catch (error) {\n        console.error(LOG_PREFIX, 'Listener error:', error);\n      }\n    });\n  }\n\n  /**\n   * Clear all data (use with caution)\n   */\n  reset() {\n    this.states.planned.clear();\n    this.states.actual.clear();\n    this._mergedCellsCache.clear();\n    this.currentMode = 'planned';\n\n    console.log(LOG_PREFIX, 'State reset');\n\n    this._notifyListeners({ type: 'reset' });\n  }\n\n  /**\n   * Export state for debugging\n   * @returns {Object}\n   */\n  exportState() {\n    return {\n      currentMode: this.currentMode,\n      planned: this.states.planned.toJSON(),\n      actual: this.states.actual.toJSON(),\n      stats: this.getStats()\n    };\n  }\n}\n\n// Phase 0: Export to global scope for testing and debugging\nif (typeof window !== 'undefined') {\n  window.StateManager = StateManager;\n}\n\nexport default StateManager;\n","/**\n * Time Column Generator Module (ES6 Modern Version)\n * Generates time columns for different modes: daily, weekly, monthly, custom\n *\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/time_column_generator_module.js\n * Date: 2025-11-19\n */\n\n// =========================================================================\n// CONSTANTS\n// =========================================================================\n\nconst ONE_DAY_MS = 24 * 60 * 60 * 1000;\n\n// =========================================================================\n// UTILITY FUNCTIONS\n// =========================================================================\n\n/**\n * Format date to short format (DD MMM)\n * @param {Date} date - Date to format\n * @returns {string} Formatted date\n */\nfunction formatDayMonth(date) {\n  if (!(date instanceof Date) || Number.isNaN(date.getTime())) {\n    return '';\n  }\n  const day = date.getDate().toString().padStart(2, '0');\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\n  return `${day}/${month}`;\n}\n\n/**\n * Format date for display\n * @param {Date} date - Date to format\n * @param {string} format - Format type (short|iso|long)\n * @returns {string} Formatted date\n */\nfunction formatDate(date, format = 'short') {\n  if (format === 'short') {\n    const day = date.getDate().toString().padStart(2, '0');\n    const month = date.toLocaleString('id-ID', { month: 'short' });\n    return `${day} ${month}`;\n  } else if (format === 'iso') {\n    return date.toISOString().split('T')[0];\n  }\n  return date.toLocaleDateString('id-ID');\n}\n\n/**\n * Get week number for a date relative to project start\n * @param {Date} targetDate - Target date\n * @param {Date} projectStart - Project start date\n * @param {Object} options - Additional options\n * @param {number} options.weekEndDay - JS weekday (0=Sunday) marking end of week\n * @returns {number} Week number (1-based)\n */\nfunction getWeekNumberForDate(targetDate, projectStart, options = {}) {\n  if (!(targetDate instanceof Date) || Number.isNaN(targetDate.getTime())) {\n    return 1;\n  }\n\n  if (!(projectStart instanceof Date) || Number.isNaN(projectStart.getTime())) {\n    return 1;\n  }\n\n  if (targetDate <= projectStart) {\n    return 1;\n  }\n\n  const resolvedWeekEnd =\n    Number.isInteger(options.weekEndDay) && !Number.isNaN(options.weekEndDay)\n      ? ((options.weekEndDay % 7) + 7) % 7\n      : 0; // Default: Sunday\n\n  // Calculate first week end\n  const firstWeekEnd = new Date(projectStart);\n  const offsetToEnd = (resolvedWeekEnd - projectStart.getDay() + 7) % 7;\n  firstWeekEnd.setDate(firstWeekEnd.getDate() + offsetToEnd);\n\n  if (targetDate <= firstWeekEnd) {\n    return 1;\n  }\n\n  // Calculate week number\n  const daysAfterFirst = Math.floor((targetDate - firstWeekEnd) / ONE_DAY_MS);\n  return 1 + Math.floor((daysAfterFirst + 6) / 7);\n}\n\n// =========================================================================\n// TIME COLUMN GENERATOR CLASS\n// =========================================================================\n\n/**\n * TimeColumnGenerator class - generates time columns from tahapan data\n */\nexport class TimeColumnGenerator {\n  constructor(state) {\n    if (!state) {\n      throw new Error('[TimeColumnGenerator] State is required');\n    }\n\n    this.state = state;\n  }\n\n  /**\n   * Generate time columns from loaded tahapan data\n   * Maps database tahapan to grid time columns based on current time scale mode.\n   *\n   * FILTERING LOGIC:\n   * - daily/weekly/monthly: Shows ONLY auto-generated tahapan with matching generation_mode\n   * - custom: Shows ALL tahapan (both auto-generated and manually created)\n   *\n   * CRITICAL: Each column MUST have tahapanId for save functionality to work!\n   *\n   * @returns {Array} Generated time columns\n   */\n  generate() {\n    this.state.timeColumns = [];\n    this._projectStartCache = undefined;\n    this._jsWeekEndDayCache = undefined;\n\n    const timeScale = this.state.timeScale || 'custom';\n    const tahapanList = this.state.tahapanList || [];\n\n    console.log(`[TimeColumnGenerator] Generating columns for mode: ${timeScale}`);\n    console.log(`[TimeColumnGenerator] Available tahapan in database: ${tahapanList.length}`);\n\n    // Map tahapan to time columns\n    tahapanList.forEach((tahap, index) => {\n      // For daily/weekly/monthly modes, only include tahapan with matching generation_mode\n      // For custom mode, include all tahapan\n      let shouldInclude = false;\n\n      if (timeScale === 'custom') {\n        // Custom mode: include all tahapan\n        shouldInclude = true;\n      } else {\n        // Daily/weekly/monthly: only include AUTO-GENERATED tahapan with matching generation_mode\n        shouldInclude = (\n          tahap.is_auto_generated === true &&\n          tahap.generation_mode === timeScale\n        );\n      }\n\n      if (shouldInclude) {\n        const column = this._createColumn(tahap, index);\n        this.state.timeColumns.push(column);\n      }\n    });\n\n    // FALLBACK: If no columns generated, show all tahapan\n    if (this.state.timeColumns.length === 0 && tahapanList.length > 0) {\n      console.warn(`[TimeColumnGenerator] No auto-generated tahapan found for mode \"${timeScale}\"`);\n      console.warn(`[TimeColumnGenerator] Showing all ${tahapanList.length} tahapan as fallback`);\n\n      tahapanList.forEach((tahap, index) => {\n        const column = this._createColumn(tahap, index);\n        this.state.timeColumns.push(column);\n      });\n    }\n\n    console.log(`[TimeColumnGenerator] ✅ Generated ${this.state.timeColumns.length} time columns`);\n    return this.state.timeColumns;\n  }\n\n  /**\n   * Create a column object from tahapan data\n   * @param {Object} tahap - Tahapan data\n   * @param {number} index - Index in list\n   * @returns {Object} Column object\n   * @private\n   */\n  _createColumn(tahap, index) {\n    const startDate = tahap.tanggal_mulai ? new Date(tahap.tanggal_mulai) : null;\n    const endDate = tahap.tanggal_selesai ? new Date(tahap.tanggal_selesai) : null;\n\n    let label = tahap.nama || `Tahap ${index + 1}`;\n    let rangeLabel = '';\n    let rangeText = '';\n    let tooltip = label;\n    let weekNumber = null;\n    let shortStart = '';\n    let shortEnd = '';\n    const resolvedOrder =\n      Number.isInteger(tahap.urutan) && tahap.urutan >= 0 ? tahap.urutan : index;\n\n    const isWeeklyMode =\n      (this.state.timeScale || '').toLowerCase() === 'weekly' ||\n      (tahap.generation_mode || '').toLowerCase() === 'weekly';\n    const projectStartDate = this._getProjectStartDate();\n    const jsWeekEndDay = this._getJsWeekEndDay();\n    const computedWeekNumber =\n      isWeeklyMode && startDate && projectStartDate\n        ? getWeekNumberForDate(startDate, projectStartDate, { weekEndDay: jsWeekEndDay })\n        : null;\n\n    // Special formatting for weekly mode\n    if (\n      tahap.is_auto_generated === true &&\n      tahap.generation_mode === 'weekly' &&\n      startDate &&\n      endDate\n    ) {\n      weekNumber = computedWeekNumber ?? resolvedOrder + 1;\n\n      shortStart = formatDayMonth(startDate);\n      shortEnd = formatDayMonth(endDate);\n\n      label = `Week ${weekNumber}`;\n      rangeLabel = `( ${shortStart} - ${shortEnd} )`;\n      rangeText = `${shortStart}\\u00A0-\\u00A0${shortEnd}`;\n\n      const longStart = startDate.toLocaleDateString('id-ID', {\n        weekday: 'long',\n        day: '2-digit',\n        month: 'long',\n        year: 'numeric'\n      });\n      const longEnd = endDate.toLocaleDateString('id-ID', {\n        weekday: 'long',\n        day: '2-digit',\n        month: 'long',\n        year: 'numeric'\n      });\n\n      tooltip = `Week ${weekNumber}: ${longStart} - ${longEnd}`;\n    } else if (startDate && endDate) {\n      shortStart = formatDayMonth(startDate);\n      shortEnd = formatDayMonth(endDate);\n      rangeLabel = `( ${shortStart} - ${shortEnd} )`;\n      rangeText = `${shortStart}\\u00A0-\\u00A0${shortEnd}`;\n    }\n\n    if (!weekNumber && isWeeklyMode) {\n      weekNumber = computedWeekNumber ?? resolvedOrder + 1;\n    }\n\n    const safeTahapanId = tahap.tahapan_id || tahap.id || resolvedOrder;\n    const fieldId = `col_${safeTahapanId}`;\n\n    return {\n      id: `tahap-${safeTahapanId}`,\n      fieldId,\n      tahapanId: tahap.tahapan_id,  // CRITICAL: Link to database tahapan!\n      label,\n      rangeLabel,\n      rangeText,\n      tooltip,\n      type: tahap.generation_mode || 'custom',\n      isAutoGenerated: tahap.is_auto_generated || false,\n      generationMode: tahap.generation_mode || 'custom',\n      index: resolvedOrder,\n      weekNumber,\n      startDate,\n      endDate,\n      urutan: tahap.urutan || index\n    };\n  }\n\n  /**\n   * Get column by ID\n   * @param {string} columnId - Column ID\n   * @returns {Object|null} Column object\n   */\n  getColumnById(columnId) {\n    return this.state.timeColumns.find(col => col.id === columnId) || null;\n  }\n\n  /**\n   * Get column by tahapan ID\n   * @param {number} tahapanId - Tahapan ID\n   * @returns {Object|null} Column object\n   */\n  getColumnByTahapanId(tahapanId) {\n    return this.state.timeColumns.find(col => col.tahapanId === tahapanId) || null;\n  }\n\n  /**\n   * Get columns for date range\n   * @param {Date} startDate - Start date\n   * @param {Date} endDate - End date\n   * @returns {Array} Columns in range\n   */\n  getColumnsInRange(startDate, endDate) {\n    return this.state.timeColumns.filter(col => {\n      if (!col.startDate || !col.endDate) return false;\n      return col.startDate <= endDate && col.endDate >= startDate;\n    });\n  }\n\n  /**\n   * Regenerate columns (refresh from tahapan list)\n   * @returns {Array} New time columns\n   */\n  regenerate() {\n    console.log('[TimeColumnGenerator] Regenerating columns...');\n    return this.generate();\n  }\n\n  _getProjectStartDate() {\n    if (typeof this._projectStartCache !== 'undefined') {\n      return this._projectStartCache;\n    }\n    const raw = this.state.projectStart;\n    if (!raw) {\n      this._projectStartCache = null;\n      return this._projectStartCache;\n    }\n    if (raw instanceof Date) {\n      this._projectStartCache = Number.isNaN(raw.getTime()) ? null : raw;\n      return this._projectStartCache;\n    }\n    const parsed = new Date(raw);\n    this._projectStartCache = Number.isNaN(parsed.getTime()) ? null : parsed;\n    return this._projectStartCache;\n  }\n\n  _getJsWeekEndDay() {\n    if (typeof this._jsWeekEndDayCache !== 'undefined') {\n      return this._jsWeekEndDayCache;\n    }\n    const pyWeekEnd = Number(this.state.weekEndDay);\n    const normalizedPy = Number.isFinite(pyWeekEnd) ? ((pyWeekEnd % 7) + 7) % 7 : 6;\n    this._jsWeekEndDayCache = (normalizedPy + 1) % 7; // Convert Monday-based to JS Sunday-based\n    return this._jsWeekEndDayCache;\n  }\n}\n\n// Export utilities\nexport {\n  formatDate,\n  formatDayMonth,\n  getWeekNumberForDate\n};\n","/**\n * Data Loader Module (ES6 Modern Version)\n * Handles all data loading operations for Jadwal Kegiatan page\n *\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/data_loader_module.js\n * Date: 2025-11-19\n * Phase 0.3: Integrated with StateManager\n */\n\nimport { StateManager } from './state-manager.js';\n\n// =========================================================================\n// UTILITY FUNCTIONS\n// =========================================================================\n\n/**\n * Get CSRF token from cookies\n * @returns {string|null} CSRF token\n */\nfunction getCookie(name) {\n  let cookieValue = null;\n  if (document.cookie && document.cookie !== '') {\n    const cookies = document.cookie.split(';');\n    for (let i = 0; i < cookies.length; i++) {\n      const cookie = cookies[i].trim();\n      if (cookie.substring(0, name.length + 1) === (name + '=')) {\n        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));\n        break;\n      }\n    }\n  }\n  return cookieValue;\n}\n\n/**\n * Make API call with automatic CSRF handling\n * @param {string} url - API endpoint\n * @param {Object} options - Fetch options\n * @returns {Promise<any>} JSON response\n */\nasync function apiCall(url, options = {}) {\n  const method = (options.method || 'GET').toUpperCase();\n  const needsCSRF = ['POST', 'PUT', 'DELETE', 'PATCH'].includes(method);\n\n  if (needsCSRF) {\n    options.headers = options.headers || {};\n    options.headers['X-CSRFToken'] = getCookie('csrftoken');\n  }\n\n  const response = await fetch(url, {\n    credentials: 'same-origin',\n    ...options\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({}));\n    throw new Error(error.error || `HTTP ${response.status}`);\n  }\n\n  return response.json();\n}\n\n/**\n * Derive time scale mode from tahapan list\n * @param {Array} tahapanList - List of tahapan\n * @param {string} fallbackMode - Default mode if can't detect\n * @returns {string} Detected mode (daily|weekly|monthly|custom)\n */\nfunction deriveTimeScaleFromTahapan(tahapanList, fallbackMode = 'weekly') {\n  if (!Array.isArray(tahapanList) || tahapanList.length === 0) {\n    return fallbackMode;\n  }\n\n  const autoCounts = { daily: 0, weekly: 0, monthly: 0 };\n  let autoTotal = 0;\n  let manualCount = 0;\n\n  tahapanList.forEach((tahap) => {\n    if (tahap && tahap.is_auto_generated && typeof tahap.generation_mode === 'string') {\n      const mode = tahap.generation_mode.toLowerCase();\n      if (autoCounts.hasOwnProperty(mode)) {\n        autoCounts[mode] += 1;\n        autoTotal += 1;\n      }\n    } else {\n      manualCount += 1;\n    }\n  });\n\n  // If auto-generated tahapan exist, use dominant mode\n  if (autoTotal > 0) {\n    const dominantMode = Object.entries(autoCounts).reduce((bestMode, entry) => {\n      const [mode, count] = entry;\n      if (!bestMode) return mode;\n      if (count > autoCounts[bestMode]) return mode;\n      return bestMode;\n    }, '');\n\n    if (dominantMode && autoCounts[dominantMode] > 0) {\n      return dominantMode;\n    }\n  }\n\n  // If only manual tahapan exist, it's custom mode\n  if (manualCount > 0) {\n    return 'custom';\n  }\n\n  return fallbackMode;\n}\n\n/**\n * Initialize expanded nodes set for tree\n * @param {Array} tree - Pekerjaan tree\n * @param {Object} state - Application state\n */\nfunction initialiseExpandedNodes(tree, state) {\n  if (!Array.isArray(tree) || tree.length === 0) {\n    return;\n  }\n\n  if (!(state.expandedNodes instanceof Set)) {\n    state.expandedNodes = new Set();\n  }\n\n  // If already initialized, skip\n  if (state.expandedNodes.size > 0) {\n    return;\n  }\n\n  // Expand all nodes by default\n  const collectIds = (nodes) => {\n    nodes.forEach((node) => {\n      if (!node || !node.id) return;\n      if (node.children && node.children.length > 0) {\n        state.expandedNodes.add(node.id);\n        collectIds(node.children);\n      }\n    });\n  };\n\n  collectIds(tree);\n}\n\n/**\n * Build hierarchical pekerjaan tree from API response\n * @param {Object} response - API response\n * @returns {Array} Tree structure\n */\nfunction buildPekerjaanTree(response) {\n  const tree = [];\n  const data = response.klasifikasi || response;\n\n  if (!Array.isArray(data)) return tree;\n\n  data.forEach(klas => {\n    const klasNode = {\n      id: `klas-${klas.id || klas.nama}`,\n      type: 'klasifikasi',\n      nama: klas.name || klas.nama || 'Klasifikasi',\n      children: [],\n      level: 0,\n      expanded: true\n    };\n\n    // Store for enrichment\n    const klasifikasiId = klas.id;\n    const klasifikasiName = klas.name || klas.nama || 'Klasifikasi';\n    const klasifikasiKode = klas.kode || '';\n\n    if (klas.sub && Array.isArray(klas.sub)) {\n      klas.sub.forEach(sub => {\n        const subNode = {\n          id: `sub-${sub.id || sub.nama}`,\n          type: 'sub-klasifikasi',\n          nama: sub.name || sub.nama || 'Sub-Klasifikasi',\n          children: [],\n          level: 1,\n          expanded: true\n        };\n\n        // Store for enrichment\n        const subKlasifikasiId = sub.id;\n        const subKlasifikasiName = sub.name || sub.nama || 'Sub-Klasifikasi';\n        const subKlasifikasiKode = sub.kode || '';\n\n        if (sub.pekerjaan && Array.isArray(sub.pekerjaan)) {\n          sub.pekerjaan.forEach(pkj => {\n            const pkjNode = {\n              id: pkj.id || pkj.pekerjaan_id,\n              type: 'pekerjaan',\n              kode: pkj.snapshot_kode || pkj.kode || '',\n              nama: pkj.snapshot_uraian || pkj.uraian || '',\n              volume: pkj.volume || 0,\n              satuan: pkj.snapshot_satuan || pkj.satuan || '-',\n              level: 2,\n              budgeted_cost: Number.parseFloat(pkj.budgeted_cost ?? pkj.total_cost ?? 0) || 0,\n\n              // ✅ ADD: Parent information for Gantt Chart\n              klasifikasi_id: klasifikasiId,\n              klasifikasi_name: klasifikasiName,\n              klasifikasi_kode: klasifikasiKode,\n              sub_klasifikasi_id: subKlasifikasiId,\n              sub_klasifikasi_name: subKlasifikasiName,\n              sub_klasifikasi_kode: subKlasifikasiKode\n            };\n            subNode.children.push(pkjNode);\n          });\n        }\n\n        klasNode.children.push(subNode);\n      });\n    }\n\n    tree.push(klasNode);\n  });\n\n  return tree;\n}\n\n/**\n * Flatten tree structure for easy access\n * @param {Array} tree - Hierarchical tree\n * @param {Array} result - Accumulator\n * @returns {Array} Flattened list\n */\nfunction flattenTree(tree, result = []) {\n  tree.forEach(node => {\n    result.push(node);\n    if (node.children && node.children.length > 0) {\n      flattenTree(node.children, result);\n    }\n  });\n  return result;\n}\n\n// =========================================================================\n// DATA LOADER CLASS\n// =========================================================================\n\n/**\n * DataLoader class - handles all data loading operations\n */\nexport class DataLoader {\n  constructor(state, options = {}) {\n    if (!state) {\n      throw new Error('[DataLoader] State is required');\n    }\n\n    this.state = state;\n    this.options = options;\n    this.projectId = state.projectId;\n\n    // Phase 0.3: Initialize StateManager\n    this.stateManager = StateManager.getInstance();\n\n    // Initialize state maps if not exist\n    if (!this.state.volumeMap) {\n      this.state.volumeMap = new Map();\n    }\n    // Phase 0.3: assignmentMap now managed by StateManager\n    // Legacy code may still access via this.state.assignmentMap (delegation getter)\n    if (!this.state.cache) {\n      this.state.cache = {};\n    }\n\n    // Lightweight response cache to avoid repeated fetches on tab switches\n    this.cacheTTL = options.cacheTTL || 60000; // default 60s\n    this.responseCache = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n    this.responseCacheTimestamps = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n\n    console.log('[DataLoader] Phase 0.3: Initialized with StateManager');\n  }\n\n  /**\n   * Load all data required for the page\n   * @param {Object} options - Load options\n   * @returns {Promise<Object>} Load result with metadata\n   */\n  async loadAllData(options = {}) {\n    const { force = false, skipIfLoaded = false } = options;\n    // Prevent duplicate loading\n    if (this.state.cache.initialLoadInProgress) {\n      console.info('[DataLoader] loadAllData skipped (already in progress)');\n      return null;\n    }\n\n    // Skip if already loaded\n    if (!force && this.state.cache.initialLoadCompleted && skipIfLoaded) {\n      console.info('[DataLoader] loadAllData skipped (already completed)');\n      return this.state.cache.initialLoadResult || null;\n    }\n\n    this.state.cache.initialLoadInProgress = true;\n\n    try {\n      console.log('[DataLoader] Loading all data...');\n\n      // Step 1: Load base data in parallel\n      await Promise.all([\n        this.loadTahapan({ forceRefresh: force }),\n        this.loadPekerjaan({ forceRefresh: force }),\n        this.loadVolumes({ forceRefresh: force })\n      ]);\n\n      // Step 2: Time columns will be generated by TimeColumnGenerator\n      // (We don't call it here, will be handled by main app)\n\n      // Step 3: Load assignments (depends on time columns being generated)\n      await this.loadAssignments({ forceRefresh: force });\n\n      this.state.cache.initialLoadCompleted = true;\n      this.state.cache.initialLoadResult = {\n        completedAt: Date.now(),\n        tahapanCount: this.state.tahapanList?.length || 0,\n        pekerjaanCount: this.state.flatPekerjaan?.filter(node => node.type === 'pekerjaan').length || 0,\n      };\n\n      console.log('[DataLoader] ✅ All data loaded successfully:', this.state.cache.initialLoadResult);\n      return this.state.cache.initialLoadResult;\n\n    } catch (error) {\n      console.error('[DataLoader] ❌ Load data failed:', error);\n      this.state.cache.initialLoadError = error;\n      throw error;\n    } finally {\n      this.state.cache.initialLoadInProgress = false;\n    }\n  }\n\n  /**\n   * Load tahapan data from API\n   * @returns {Promise<Array>} List of tahapan\n   */\n  async loadTahapan(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      const useCache = !forceRefresh\n        && this._isCacheValid('tahapan')\n        && Array.isArray(this.responseCache.tahapan);\n\n      if (useCache) {\n        this.state.tahapanList = JSON.parse(JSON.stringify(this.responseCache.tahapan));\n        const detectedModeFromCache = deriveTimeScaleFromTahapan(\n          this.state.tahapanList,\n          this.state.timeScale || 'weekly'\n        );\n        this.state.timeScale = detectedModeFromCache;\n        console.log(`[DataLoader] Using cached tahapan list (${this.state.tahapanList.length} items)`);\n        return this.state.tahapanList;\n      }\n\n      const url = this.state.apiBase || `/detail_project/api/project/${this.projectId}/tahapan/`;\n      const data = await apiCall(url);\n\n      this.state.tahapanList = (data.tahapan || data || []).sort((a, b) => a.urutan - b.urutan);\n\n      // Auto-detect time scale mode from tahapan\n      const detectedMode = deriveTimeScaleFromTahapan(\n        this.state.tahapanList,\n        this.state.timeScale || 'weekly'\n      );\n      this.state.timeScale = detectedMode;\n\n      this._setCache('tahapan', JSON.parse(JSON.stringify(this.state.tahapanList)));\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.tahapanList.length} tahapan, mode: ${detectedMode}`);\n      return this.state.tahapanList;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load tahapan:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Load pekerjaan tree data from API\n   * @returns {Promise<Array>} Pekerjaan tree\n   */\n  async loadPekerjaan(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      const useCache = !forceRefresh\n        && this._isCacheValid('pekerjaan')\n        && Array.isArray(this.responseCache.pekerjaan);\n\n      if (useCache) {\n        const cachedTree = JSON.parse(JSON.stringify(this.responseCache.pekerjaan));\n        this.state.pekerjaanTree = cachedTree;\n        this.state.flatPekerjaan = flattenTree(cachedTree);\n        initialiseExpandedNodes(cachedTree, this.state);\n        console.log(`[DataLoader] Using cached pekerjaan tree (${this.state.flatPekerjaan.length} nodes)`);\n        return this.state.pekerjaanTree;\n      }\n\n      const url = `/detail_project/api/project/${this.projectId}/list-pekerjaan/tree/`;\n      const response = await apiCall(url);\n\n      // Build hierarchical tree\n      const tree = buildPekerjaanTree(response);\n      this.state.pekerjaanTree = tree;\n\n      // Flatten for easy access\n      this.state.flatPekerjaan = flattenTree(tree);\n\n      // Initialize expanded nodes\n      initialiseExpandedNodes(tree, this.state);\n\n      this._setCache('pekerjaan', JSON.parse(JSON.stringify(tree)));\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.flatPekerjaan.length} pekerjaan nodes`);\n      return this.state.pekerjaanTree;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load pekerjaan:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Load volume data for all pekerjaan\n   * @returns {Promise<Map>} Volume map\n   */\n  async loadVolumes(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      const useCache = !forceRefresh\n        && this._isCacheValid('volumes')\n        && Array.isArray(this.responseCache.volumes);\n\n      if (useCache) {\n        this.state.volumeMap.clear();\n        this.responseCache.volumes.forEach(([pkjId, qty]) => {\n          this.state.volumeMap.set(pkjId, qty);\n        });\n        console.log(`[DataLoader] Using cached volumes (${this.state.volumeMap.size} entries)`);\n        return this.state.volumeMap;\n      }\n\n      const url = `/detail_project/api/project/${this.projectId}/volume-pekerjaan/list/`;\n      const data = await apiCall(url);\n\n      this.state.volumeMap.clear();\n\n      const volumes = data.items || data.volumes || data.data || [];\n      if (Array.isArray(volumes)) {\n        volumes.forEach(v => {\n          const pkjId = v.pekerjaan_id || v.id;\n          const qty = parseFloat(v.quantity || v.volume || v.qty) || 0;\n          if (pkjId) {\n            this.state.volumeMap.set(pkjId, qty);\n          }\n        });\n      }\n\n      this._setCache('volumes', Array.from(this.state.volumeMap.entries()));\n\n      console.log(`[DataLoader] ✅ Loaded ${this.state.volumeMap.size} volume entries`);\n      return this.state.volumeMap;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load volumes:', error);\n      // Don't throw, volumes are optional\n      return this.state.volumeMap;\n    }\n  }\n\n  /**\n   * Load assignments (progress data) for all pekerjaan\n   * @returns {Promise<Map>} Assignment map\n   */\n  async loadAssignments(options = {}) {\n    const { forceRefresh = false } = options;\n    try {\n      // Phase 0.3: Clear StateManager data (both modes)\n      this.stateManager.states.planned.assignmentMap.clear();\n      this.stateManager.states.actual.assignmentMap.clear();\n      console.log('[DataLoader] Phase 0.3: Loading assignments (attempting API v2)...');\n\n      const pekerjaanNodes = this.state.flatPekerjaan.filter(node => node.type === 'pekerjaan');\n      const totalNodes = pekerjaanNodes.length;\n\n      if (totalNodes === 0) {\n        console.info('[DataLoader] No pekerjaan nodes found for assignments');\n        return this.state.assignmentMap;\n      }\n\n      const useCache = !forceRefresh\n        && this._isCacheValid('assignments')\n        && Array.isArray(this.responseCache.assignments);\n\n      if (useCache) {\n        this._applyAssignmentsData(this.responseCache.assignments, { source: 'cache' });\n        return this.state.assignmentMap;\n      }\n\n      const assignments = await this._loadAssignmentsViaV2();\n      if (Array.isArray(assignments) && assignments.length > 0) {\n        this._setCache('assignments', assignments);\n      }\n\n      return this.state.assignmentMap;\n    } catch (error) {\n      console.error('[DataLoader] ❌ Failed to load assignments:', error);\n      return this.state.assignmentMap;\n    }\n  }\n\n  /**\n   * Reload specific data type\n   * @param {string} type - Data type (tahapan|pekerjaan|volumes|assignments)\n   * @returns {Promise<any>} Loaded data\n   */\n  async reload(type) {\n    const loaders = {\n      tahapan: () => this.loadTahapan({ forceRefresh: true }),\n      pekerjaan: () => this.loadPekerjaan({ forceRefresh: true }),\n      volumes: () => this.loadVolumes({ forceRefresh: true }),\n      assignments: () => this.loadAssignments({ forceRefresh: true })\n    };\n\n    const loader = loaders[type];\n    if (!loader) {\n      throw new Error(`[DataLoader] Unknown reload type: ${type}`);\n    }\n\n    console.log(`[DataLoader] Reloading ${type}...`);\n    return loader();\n  }\n\n  _isCacheValid(cacheType) {\n    const timestamp = this.responseCacheTimestamps?.[cacheType];\n    if (!timestamp) {\n      return false;\n    }\n    return (Date.now() - timestamp) < this.cacheTTL;\n  }\n\n  _setCache(cacheType, payload) {\n    if (!this.responseCache.hasOwnProperty(cacheType)) {\n      return;\n    }\n    this.responseCache[cacheType] = payload;\n    this.responseCacheTimestamps[cacheType] = Date.now();\n  }\n\n  /**\n   * Clear cached responses. If cacheType is provided, only clear that entry.\n   * @param {string|null} cacheType\n   */\n  clearCache(cacheType = null) {\n    if (cacheType && this.responseCache.hasOwnProperty(cacheType)) {\n      this.responseCache[cacheType] = null;\n      this.responseCacheTimestamps[cacheType] = null;\n      console.log(`[DataLoader] Cache cleared for ${cacheType}`);\n      return;\n    }\n\n    this.responseCache = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n    this.responseCacheTimestamps = {\n      tahapan: null,\n      pekerjaan: null,\n      volumes: null,\n      assignments: null\n    };\n    console.log('[DataLoader] All caches cleared');\n  }\n\n  _buildWeekColumnIndex() {\n    const weekColumnIndex = {};\n    if (Array.isArray(this.state.timeColumns)) {\n      this.state.timeColumns.forEach((col) => {\n        const weekNumber = Number(col.weekNumber || col.week_number || col.urutan);\n        if (Number.isFinite(weekNumber) && weekNumber >= 1 && col.id) {\n          weekColumnIndex[weekNumber] = col;\n        }\n      });\n    }\n    return weekColumnIndex;\n  }\n\n  async _loadAssignmentsViaV2() {\n    const url = `/detail_project/api/v2/project/${this.projectId}/assignments/`;\n    const data = await apiCall(url);\n\n    if (!data || !Array.isArray(data.assignments)) {\n      console.info('[DataLoader] API v2 returned no assignments array (treating as empty dataset)');\n      return [];\n    }\n\n    if (data.assignments.length === 0) {\n      console.info('[DataLoader] API v2 assignments empty (no progress recorded yet)');\n      return [];\n    }\n\n    this._applyAssignmentsData(data.assignments, { source: 'api' });\n    return data.assignments;\n  }\n\n  _applyAssignmentsData(assignments = [], { source = 'api' } = {}) {\n    const weekColumnIndex = this._buildWeekColumnIndex();\n    let mapped = 0;\n\n    assignments.forEach((item) => {\n      const pekerjaanId = Number(item.pekerjaan_id || item.pekerjaanId || item.id);\n      const weekNumber = Number(item.week_number || item.weekNumber);\n\n      // Phase 0.3: Read both planned and actual proportions\n      const plannedProportion = parseFloat(item.planned_proportion) || 0;\n      const actualProportion = parseFloat(item.actual_proportion) || 0;\n      const rawCost = item.actual_cost ?? item.actualCost ?? null;\n      const actualCost = rawCost === null || typeof rawCost === 'undefined'\n        ? null\n        : Number.parseFloat(rawCost);\n\n      if (!pekerjaanId || !weekNumber) {\n        return;\n      }\n\n      const column = weekColumnIndex[weekNumber];\n      if (!column) {\n        return;\n      }\n\n      const columnKey = column.fieldId || column.id;\n      if (!columnKey) {\n        return;\n      }\n\n      const options = {};\n      if (actualCost !== null && !Number.isNaN(actualCost) && Number.isFinite(actualCost)) {\n        options.actualCost = actualCost;\n      }\n\n      this.stateManager.setInitialValue(\n        pekerjaanId,\n        columnKey,\n        plannedProportion,\n        actualProportion,\n        options\n      );\n      mapped += 1;\n    });\n\n    const stats = this.stateManager.getStats();\n    const sourceLabel = source === 'cache' ? 'cache' : 'API v2';\n    console.log(`[DataLoader] Phase 0.3: Loaded ${mapped} assignments via ${sourceLabel}`);\n    console.log(`[DataLoader] Planned: ${stats.planned.assignmentCount} assignments`);\n    console.log(`[DataLoader] Actual: ${stats.actual.assignmentCount} assignments`);\n  }\n}\n\n// Export utilities for external use\nexport {\n  apiCall,\n  getCookie,\n  deriveTimeScaleFromTahapan,\n  buildPekerjaanTree,\n  flattenTree,\n  initialiseExpandedNodes\n};\n","/**\r\n * Save Handler Module (ES6 Modern Version)\r\n * Handles saving modified cells to Django backend\r\n *\r\n * Migrated from: jadwal_pekerjaan/kelola_tahapan/save_handler_module.js\r\n * Date: 2025-11-19\r\n * Phase 0.3: Integrated with StateManager\r\n */\r\n\r\nimport { StateManager } from './state-manager.js';\r\n\r\n// =========================================================================\r\n// UTILITY FUNCTIONS\r\n// =========================================================================\r\n\r\n/**\r\n * Get CSRF token from cookies\r\n * @returns {string|null} CSRF token\r\n */\r\nfunction getCookie(name) {\r\n  let cookieValue = null;\r\n  if (document.cookie && document.cookie !== '') {\r\n    const cookies = document.cookie.split(';');\r\n    for (let i = 0; i < cookies.length; i++) {\r\n      const cookie = cookies[i].trim();\r\n      if (cookie.substring(0, name.length + 1) === (name + '=')) {\r\n        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));\r\n        break;\r\n      }\r\n    }\r\n  }\r\n  return cookieValue;\r\n}\r\n\r\n// =========================================================================\r\n// SAVE HANDLER CLASS\r\n// =========================================================================\r\n\r\n/**\r\n * SaveHandler - Manages save operations for grid data\r\n * Handles building payloads, API calls, and state updates\r\n */\r\nexport class SaveHandler {\r\n  /**\r\n   * Create a SaveHandler instance\r\n   * @param {Object} state - Application state\r\n   * @param {Object} options - Configuration options\r\n   * @param {string} options.apiUrl - API endpoint URL\r\n   * @param {Function} options.onSuccess - Success callback\r\n   * @param {Function} options.onError - Error callback\r\n   * @param {Function} options.showToast - Toast notification function\r\n   */\r\n  constructor(state, options = {}) {\r\n    if (!state) {\r\n      throw new Error('[SaveHandler] State is required');\r\n    }\r\n\r\n    this.state = state;\r\n    this.options = options;\r\n\r\n    // Phase 0.3: Initialize StateManager\r\n    this.stateManager = StateManager.getInstance();\r\n\r\n    // API configuration\r\n    this.apiUrl = options.apiUrl || `/detail_project/api/project/${state.projectId}/pekerjaan/assign_weekly/`;\r\n\r\n    // Callbacks\r\n    this.onSuccess = options.onSuccess || (() => {});\r\n    this.onError = options.onError || ((err) => console.error(err));\r\n    this.showToast = options.showToast || ((msg, type) => console.log(`[${type}] ${msg}`));\r\n    this.dataLoader = options.dataLoader || null;\r\n\r\n    // Save state\r\n    this.isSaving = false;\r\n\r\n    console.log('[SaveHandler] Phase 0.3: Initialized with StateManager');\r\n    console.log('[SaveHandler] API:', this.apiUrl);\r\n  }\r\n\r\n  // =======================================================================\r\n  // MAIN SAVE OPERATION\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Save all modified cells to server\r\n   * Main entry point for save operation\r\n   * @returns {Promise<Object>} Save result\r\n   */\r\n  async save() {\r\n    if (this.isSaving) {\r\n      console.warn('[SaveHandler] Save already in progress');\r\n      this.showToast('Penyimpanan sedang berlangsung...', 'warning');\r\n      return { success: false, reason: 'already_saving' };\r\n    }\r\n\r\n    console.log('[SaveHandler] Starting save operation...');\r\n    this.isSaving = true;\r\n\r\n    try {\r\n      // Check if there are any changes\r\n      const hasCostChanges = this._hasCostChanges();\r\n      if ((!this.state.modifiedCells || this.state.modifiedCells.size === 0) && !hasCostChanges) {\r\n        console.warn('[SaveHandler] No modified cells to save');\r\n        this.showToast('Tidak ada perubahan untuk disimpan', 'info');\r\n        this.isSaving = false;\r\n        return { success: false, reason: 'no_changes' };\r\n      }\r\n\r\n      // Build payload\r\n      const payload = this._buildPayload();\r\n      const payloadCount = payload.assignments?.length ?? payload.items?.length ?? 0;\r\n      console.log(`[SaveHandler] Built payload with ${payloadCount} items`);\r\n\r\n      // Send to server\r\n      const result = await this._sendToServer(payload);\r\n\r\n      // Handle success\r\n      this._handleSaveSuccess(result);\r\n\r\n      this.isSaving = false;\r\n      return { success: true, result };\r\n\r\n    } catch (error) {\r\n      // Handle error\r\n      this._handleSaveError(error);\r\n      this.isSaving = false;\r\n      return { success: false, error };\r\n    }\r\n  }\r\n\r\n  // =======================================================================\r\n  // PAYLOAD BUILDING\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Build save payload from modified cells\r\n   * Converts modifiedCells Map to API format\r\n   * @returns {Object} Payload object\r\n   * @private\r\n   */\r\n  _buildPayload() {\r\n    const assignments = [];\r\n\r\n    // Phase 2E.1: Log which mode's modifiedCells we're reading from\r\n    const progressMode = this.state?.progressMode || 'planned';\r\n    const modeState = this.stateManager.states[progressMode];\r\n    const modifiedCells = modeState?.modifiedCells || this.state.modifiedCells || new Map();\r\n    const costModifiedCells = progressMode === 'actual' ? (modeState?.costModifiedCells || new Map()) : new Map();\r\n    const cellsToSave = new Set();\r\n\r\n    modifiedCells.forEach((_, cellKey) => cellsToSave.add(cellKey));\r\n    if (progressMode === 'actual' && costModifiedCells instanceof Map) {\r\n      costModifiedCells.forEach((_, cellKey) => cellsToSave.add(cellKey));\r\n    }\r\n\r\n    console.log(\r\n      `[SaveHandler] Building payload from ${progressMode.toUpperCase()} modifiedCells` +\r\n      ` (cells: ${modifiedCells.size}, cost: ${costModifiedCells.size})`\r\n    );\r\n\r\n    // Convert modifiedCells Map to array of assignments\r\n    // Phase 2E.1: Property delegation ensures this reads from current mode's modifiedCells\r\n    cellsToSave.forEach((cellKey) => {\r\n      const value = modifiedCells.has(cellKey) ? modifiedCells.get(cellKey) : undefined;\r\n      // Parse cellKey (format: \"nodeId-columnId\")\r\n      const [pekerjaanId, tahapanId] = cellKey.split('-');\r\n\r\n      if (!pekerjaanId || !tahapanId) {\r\n        console.warn(`[SaveHandler] Invalid cell key: ${cellKey}`);\r\n        return;\r\n      }\r\n\r\n      // Get numeric value\r\n      let proportion = typeof value === 'undefined' ? this._getSavedValue(cellKey) : parseFloat(value);\r\n      if (!Number.isFinite(proportion)) {\r\n        proportion = 0;\r\n      }\r\n\r\n      // Get column info for additional metadata\r\n      const column = this.state.timeColumns?.find((col) => {\r\n        const key = col.fieldId || col.id;\r\n        return key?.toString() === tahapanId.toString();\r\n      });\r\n\r\n      // Build item\r\n      // Backend expects generic 'proportion' field - it will convert to planned/actual based on mode\r\n      const item = {\r\n        pekerjaan_id: parseInt(pekerjaanId, 10),\r\n        proportion: Number(proportion.toFixed(2)),\r\n      };\r\n\r\n      const targetField = progressMode === 'actual' ? 'actual_proportion' : 'planned_proportion';\r\n      item[targetField] = item.proportion;\r\n\r\n      if (column) {\r\n        const tahapanPrimaryId =\r\n          column.tahapanId ??\r\n          column.tahapan_id ??\r\n          (Number.isFinite(Number(column.id)) ? Number(column.id) : null);\r\n        if (tahapanPrimaryId) {\r\n          item.tahapan_id = tahapanPrimaryId;\r\n        }\r\n\r\n        if (column.startDate) {\r\n          item.week_start = this._formatDate(column.startDate);\r\n        }\r\n        if (column.endDate) {\r\n          item.week_end = this._formatDate(column.endDate);\r\n        }\r\n        if (Number.isFinite(column.weekNumber)) {\r\n          item.week_number = column.weekNumber;\r\n        }\r\n\r\n        if (!item.week_number) {\r\n          const normalizedOrder = Number.isFinite(column.index)\r\n            ? Number(column.index)\r\n            : Number.isFinite(column.order)\r\n              ? Number(column.order)\r\n              : Number.isFinite(column.urutan)\r\n                ? Number(column.urutan)\r\n                : null;\r\n          if (normalizedOrder !== null) {\r\n            item.week_number = normalizedOrder + 1;\r\n          }\r\n        }\r\n      } else {\r\n        const numericTahapan = parseInt(tahapanId, 10);\r\n        if (Number.isFinite(numericTahapan)) {\r\n          item.tahapan_id = numericTahapan;\r\n        }\r\n      }\r\n\r\n      if (!item.week_number) {\r\n        const fallbackWeek = parseInt(item.tahapan_id ?? tahapanId, 10);\r\n        if (Number.isFinite(fallbackWeek)) {\r\n          item.week_number = fallbackWeek;\r\n        } else {\r\n          // Default to 1 as last resort to satisfy backend validation\r\n          item.week_number = 1;\r\n        }\r\n      }\r\n\r\n      if (progressMode === 'actual' && costModifiedCells instanceof Map && costModifiedCells.has(cellKey)) {\r\n        const costValue = Number(costModifiedCells.get(cellKey));\r\n        if (Number.isFinite(costValue) && costValue >= 0) {\r\n          item.actual_cost = Number(costValue.toFixed(2));\r\n        }\r\n      }\r\n\r\n      assignments.push(item);\r\n    });\r\n\r\n    console.log(`[SaveHandler] Built ${assignments.length} assignment items`);\r\n\r\n    // Phase 2E.1: progressMode already declared at top of function\r\n    console.log(`[SaveHandler] Progress Mode: ${progressMode.toUpperCase()} - Will save to ${progressMode === 'actual' ? 'actual_proportion' : 'planned_proportion'} field`);\r\n\r\n    const payload = {\r\n      assignments,\r\n      mode: progressMode,  // Phase 2E.1: 'planned' or 'actual' (determines field to update)\r\n      project_id: this.state.projectId,\r\n      week_end_day: this.state.weekEndDay ?? 6,\r\n    };\r\n\r\n    console.log(`[SaveHandler] Payload:`, JSON.stringify(payload, null, 2));\r\n\r\n    return payload;\r\n  }\r\n\r\n  /**\r\n   * Format date for API (YYYY-MM-DD)\r\n   * @param {Date} date - Date to format\r\n   * @returns {string} Formatted date\r\n   * @private\r\n   */\r\n  _formatDate(date) {\r\n    if (!(date instanceof Date)) {\r\n      date = new Date(date);\r\n    }\r\n    if (Number.isNaN(date.getTime())) {\r\n      return '';\r\n    }\r\n    return date.toISOString().split('T')[0];\r\n  }\r\n\r\n  // =======================================================================\r\n  // API COMMUNICATION\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Send payload to server\r\n   * @param {Object} payload - Payload to send\r\n   * @returns {Promise<Object>} Server response\r\n   * @private\r\n   */\r\n  async _sendToServer(payload) {\r\n    console.log('[SaveHandler] Sending request to:', this.apiUrl);\r\n    console.log('[SaveHandler] Payload:', payload);\r\n\r\n    const csrfToken = getCookie('csrftoken');\r\n\r\n    const response = await fetch(this.apiUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-CSRFToken': csrfToken\r\n      },\r\n      credentials: 'same-origin',\r\n      body: JSON.stringify(payload)\r\n    });\r\n\r\n    if (!response.ok) {\r\n      let errorData = {};\r\n      let parsedBody = null;\r\n      try {\r\n        parsedBody = await response.json();\r\n        errorData = parsedBody || {};\r\n      } catch (jsonError) {\r\n        const fallbackText = await response.text().catch(() => '');\r\n        errorData = { message: fallbackText };\r\n      }\r\n\r\n      const errorMsg = errorData.error || errorData.message || `HTTP ${response.status}`;\r\n      const error = new Error(errorMsg);\r\n      if (errorData.errors) {\r\n        error.details = errorData.errors;\r\n      }\r\n      if (errorData.validation_errors) {\r\n        error.validationErrors = errorData.validation_errors;\r\n      }\r\n      if (typeof errorData === 'object') {\r\n        error.payload = errorData;\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    const result = await response.json();\r\n    console.log('[SaveHandler] Server response:', result);\r\n\r\n    return result;\r\n  }\r\n\r\n  // =======================================================================\r\n  // RESPONSE HANDLING\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Handle successful save\r\n   * @param {Object} result - Server response\r\n   * @private\r\n   */\r\n  _handleSaveSuccess(result) {\r\n    console.log('[SaveHandler] ✅ Save successful');\r\n\r\n    const progressMode = (this.state?.progressMode || 'planned').toLowerCase();\r\n    const modeState = this.stateManager?.states?.[progressMode];\r\n    const pendingModifiedCount = modeState?.modifiedCells?.size ?? this.state.modifiedCells.size;\r\n\r\n    // Update assignmentMap with saved values\r\n    this._updateAssignmentMap();\r\n\r\n    // Clear modified cells\r\n    this.state.modifiedCells.clear();\r\n    if (this.state.cellVolumeOverrides instanceof Map) {\r\n      this.state.cellVolumeOverrides.clear();\r\n    }\r\n\r\n    // Update UI status\r\n    if (this.state.cache) {\r\n      this.state.cache.hasUnsavedChanges = false;\r\n    }\r\n\r\n    // Clear client-side caches so subsequent fetches get fresh data\r\n    if (this.dataLoader && typeof this.dataLoader.clearCache === 'function') {\r\n      this.dataLoader.clearCache();\r\n    }\r\n\r\n    // Show success message\r\n    const apiSavedTotal = (Number(result.created_count) || 0) + (Number(result.updated_count) || 0);\r\n    const fallbackSaved = Number(result.saved_count) || Number(result.count) || pendingModifiedCount;\r\n    const savedCount = apiSavedTotal > 0 ? apiSavedTotal : fallbackSaved;\r\n    const modeLabel = progressMode === 'actual' ? 'Realisasi' : 'Perencanaan';\r\n    const message = `Berhasil menyimpan ${savedCount} perubahan (${modeLabel})`;\r\n    this.showToast(message, 'success');\r\n    this.showToast(message, 'success');\r\n\r\n    // Call success callback\r\n    if (typeof this.onSuccess === 'function') {\r\n      this.onSuccess(result);\r\n    }\r\n\r\n    console.log(`[SaveHandler] Saved ${savedCount} assignments, cleared ${pendingModifiedCount} modified cells`);\r\n  }\r\n\r\n  /**\r\n   * Handle save error\r\n   * @param {Error} error - Error object\r\n   * @private\r\n   */\r\n  _handleSaveError(error) {\r\n    console.error('[SaveHandler] ❌ Save failed:', error);\r\n\r\n    const detailMessages = [];\r\n    if (Array.isArray(error.validationErrors) && error.validationErrors.length > 0) {\r\n      error.validationErrors.slice(0, 3).forEach((item) => {\r\n        if (item?.error) {\r\n          detailMessages.push(`• ${item.error}`);\r\n        }\r\n      });\r\n      if (error.validationErrors.length > 3) {\r\n        detailMessages.push(`(+${error.validationErrors.length - 3} lagi)`);\r\n      }\r\n    }\r\n\r\n    if (Array.isArray(error.details) && error.details.length > 0) {\r\n      error.details.slice(0, 3).forEach((item) => {\r\n        if (item?.error) {\r\n          detailMessages.push(`• ${item.error}`);\r\n        }\r\n      });\r\n      if (error.details.length > 3) {\r\n        detailMessages.push(`(+${error.details.length - 3} lagi)`);\r\n      }\r\n    }\r\n\r\n    let message = `Gagal menyimpan: ${error.message}`;\r\n    if (detailMessages.length > 0) {\r\n      message += `\\n${detailMessages.join('\\n')}`;\r\n    }\r\n    this.showToast(message, 'danger', 5000);\r\n\r\n    // Call error callback\r\n    if (typeof this.onError === 'function') {\r\n      this.onError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the current mode's state object\r\n   * @returns {Object} Current mode state (plannedState or actualState)\r\n   * @private\r\n   */\r\n  _getCurrentModeState() {\r\n    // Phase 2E.1: Support dual state architecture\r\n    const progressMode = this.state.progressMode || 'planned';\r\n    return progressMode === 'actual'\r\n      ? this.state.actualState\r\n      : this.state.plannedState;\r\n  }\r\n\r\n  /**\r\n   * Update assignmentMap with modified values\r\n   * Phase 0.3: Delegate to StateManager.commitChanges()\r\n   * @private\r\n   */\r\n  _updateAssignmentMap() {\r\n    // Phase 0.3: StateManager handles moving modifiedCells → assignmentMap\r\n    this.stateManager.commitChanges();\r\n\r\n    const progressMode = this.state.progressMode || 'planned';\r\n    const stats = this.stateManager.states[progressMode].getStats();\r\n    console.log(`[SaveHandler] Phase 0.3: StateManager committed changes for ${progressMode.toUpperCase()}`);\r\n    console.log(`[SaveHandler] New state: ${stats.assignmentCount} assignments, ${stats.modifiedCount} modified`);\r\n  }\r\n\r\n  _hasCostChanges() {\r\n    const progressMode = this.state?.progressMode || 'planned';\r\n    if (progressMode !== 'actual') {\r\n      return false;\r\n    }\r\n    const costMap = this.state.costModifiedCells;\r\n    return costMap instanceof Map ? costMap.size > 0 : false;\r\n  }\r\n\r\n  _getSavedValue(cellKey) {\r\n    const assignmentMap = this.state.assignmentMap;\r\n    if (!assignmentMap) {\r\n      return 0;\r\n    }\r\n    if (assignmentMap instanceof Map) {\r\n      return Number(assignmentMap.get(cellKey)) || 0;\r\n    }\r\n    if (typeof assignmentMap === 'object' && assignmentMap !== null) {\r\n      return Number(assignmentMap[cellKey]) || 0;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  // =======================================================================\r\n  // UTILITY METHODS\r\n  // =======================================================================\r\n\r\n  /**\r\n   * Check if there are unsaved changes\r\n   * Phase 0.3: Delegate to StateManager\r\n   * @returns {boolean} True if has unsaved changes\r\n   */\r\n  hasUnsavedChanges() {\r\n    return this.stateManager.hasUnsavedChanges();\r\n  }\r\n\r\n  /**\r\n   * Get count of modified cells\r\n   * Phase 0.3: Delegate to StateManager\r\n   * @returns {number} Number of modified cells\r\n   */\r\n  getModifiedCount() {\r\n    const mode = this.state.progressMode || 'planned';\r\n    return this.stateManager.states[mode].modifiedCells.size;\r\n  }\r\n\r\n  /**\r\n   * Validate payload before sending\r\n   * @param {Object} payload - Payload to validate\r\n   * @returns {Object} Validation result\r\n   */\r\n  validatePayload(payload) {\r\n    const errors = [];\r\n    const warnings = [];\r\n\r\n    const assignments = Array.isArray(payload?.assignments)\r\n      ? payload.assignments\r\n      : Array.isArray(payload?.items)\r\n        ? payload.items\r\n        : null;\r\n\r\n    if (!assignments) {\r\n      errors.push('Invalid payload structure');\r\n      return { isValid: false, errors, warnings };\r\n    }\r\n\r\n    if (assignments.length === 0) {\r\n      warnings.push('No items to save');\r\n    }\r\n\r\n    // Validate each item\r\n    assignments.forEach((item, index) => {\r\n      if (!item.pekerjaan_id) {\r\n        errors.push(`Item ${index}: Missing pekerjaan_id`);\r\n      }\r\n      if (!item.week_number) {\r\n        warnings.push(`Item ${index}: Missing week_number (akan memakai default)`);\r\n      }\r\n      if (typeof item.proportion === 'undefined') {\r\n        errors.push(`Item ${index}: Missing proportion value`);\r\n      } else if (!Number.isFinite(item.proportion)) {\r\n        errors.push(`Item ${index}: Invalid proportion value`);\r\n      } else if (item.proportion < 0 || item.proportion > 100) {\r\n        warnings.push(`Item ${index}: Proportion out of range (${item.proportion}%)`);\r\n      }\r\n    });\r\n\r\n    const isValid = errors.length === 0;\r\n\r\n    if (!isValid) {\r\n      console.error('[SaveHandler] Payload validation failed:', errors);\r\n    }\r\n\r\n    if (warnings.length > 0) {\r\n      console.warn('[SaveHandler] Payload validation warnings:', warnings);\r\n    }\r\n\r\n    return { isValid, errors, warnings };\r\n  }\r\n\r\n  /**\r\n   * Cancel save operation\r\n   */\r\n  cancel() {\r\n    if (this.isSaving) {\r\n      console.log('[SaveHandler] Cancelling save operation...');\r\n      this.isSaving = false;\r\n      // Note: Cannot actually abort fetch request without AbortController\r\n      // This just sets the flag\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get save statistics\r\n   * @returns {Object} Save statistics\r\n   */\r\n  getStats() {\r\n    return {\r\n      modifiedCells: this.getModifiedCount(),\r\n      isSaving: this.isSaving,\r\n      hasUnsavedChanges: this.hasUnsavedChanges(),\r\n      apiUrl: this.apiUrl\r\n    };\r\n  }\r\n}\r\n\r\n// Export utility functions\r\nexport {\r\n  getCookie\r\n};\r\n"],"names":["ModeState","constructor","this","assignmentMap","Map","modifiedCells","costAssignmentMap","costModifiedCells","isDirty","toJSON","Array","from","entries","fromJSON","data","state","isArray","getStats","assignmentCount","size","modifiedCount","costAssignmentCount","costModifiedCount","hasUnsavedChanges","clear","clone","cloned","LOG_PREFIX","_StateManager","getInstance","instance","console","log","Error","currentMode","states","planned","actual","_mergedCellsCache","_listeners","Set","getCellValue","pekerjaanId","columnId","_a","_b","_getCurrentState","cellKey","get","getAllCellsForMode","mode","modeState","error","cacheKey","has","merged","forEach","value","key","set","toUpperCase","setCellValue","numericValue","parseFloat","Number","isNaN","warn","_invalidateCache","switchMode","newMode","oldMode","_notifyListeners","type","commitChanges","delete","numeric","isFinite","count","loadData","dataMap","costDataMap","setInitialValue","plannedValue","actualValue","options","hasCostProp","Object","prototype","hasOwnProperty","call","actualCost","cost","actual_cost","addEventListener","callback","add","removeEventListener","cacheSize","listenerCount","event","listener","reset","exportState","stats","StateManager","window","formatDayMonth","date","Date","getTime","getDate","toString","padStart","getMonth","TimeColumnGenerator","generate","timeColumns","_projectStartCache","_jsWeekEndDayCache","timeScale","tahapanList","length","tahap","index","shouldInclude","is_auto_generated","generation_mode","column","_createColumn","push","startDate","tanggal_mulai","endDate","tanggal_selesai","label","nama","rangeLabel","rangeText","tooltip","weekNumber","shortStart","shortEnd","resolvedOrder","isInteger","urutan","isWeeklyMode","toLowerCase","projectStartDate","_getProjectStartDate","jsWeekEndDay","_getJsWeekEndDay","computedWeekNumber","targetDate","projectStart","resolvedWeekEnd","weekEndDay","firstWeekEnd","offsetToEnd","getDay","setDate","daysAfterFirst","Math","floor","getWeekNumberForDate","toLocaleDateString","weekday","day","month","year","safeTahapanId","tahapan_id","id","fieldId","tahapanId","isAutoGenerated","generationMode","getColumnById","find","col","getColumnByTahapanId","getColumnsInRange","filter","regenerate","raw","parsed","pyWeekEnd","normalizedPy","apiCall","_0","__async","arguments","url","method","includes","headers","name","cookieValue","document","cookie","cookies","split","i","trim","substring","decodeURIComponent","getCookie","response","fetch","__spreadValues","credentials","ok","json","catch","status","deriveTimeScaleFromTahapan","fallbackMode","autoCounts","daily","weekly","monthly","autoTotal","manualCount","dominantMode","reduce","bestMode","entry","initialiseExpandedNodes","tree","expandedNodes","collectIds","nodes","node","children","flattenTree","result","DataLoader","projectId","stateManager","volumeMap","cache","cacheTTL","responseCache","tahapan","pekerjaan","volumes","assignments","responseCacheTimestamps","loadAllData","force","skipIfLoaded","initialLoadInProgress","info","initialLoadCompleted","initialLoadResult","Promise","all","loadTahapan","forceRefresh","loadPekerjaan","loadVolumes","loadAssignments","completedAt","now","tahapanCount","pekerjaanCount","flatPekerjaan","initialLoadError","_isCacheValid","JSON","parse","stringify","detectedModeFromCache","apiBase","sort","a","b","detectedMode","_setCache","cachedTree","pekerjaanTree","klasifikasi","klas","klasNode","level","expanded","klasifikasiId","klasifikasiName","klasifikasiKode","kode","sub","subNode","subKlasifikasiId","subKlasifikasiName","subKlasifikasiKode","pkj","pkjNode","pekerjaan_id","snapshot_kode","snapshot_uraian","uraian","volume","satuan","snapshot_satuan","budgeted_cost","total_cost","klasifikasi_id","klasifikasi_name","klasifikasi_kode","sub_klasifikasi_id","sub_klasifikasi_name","sub_klasifikasi_kode","buildPekerjaanTree","pkjId","qty","items","v","quantity","pekerjaanNodes","_applyAssignmentsData","source","_loadAssignmentsViaV2","reload","loader","cacheType","timestamp","payload","clearCache","_buildWeekColumnIndex","weekColumnIndex","week_number","mapped","item","plannedProportion","planned_proportion","actualProportion","actual_proportion","rawCost","columnKey","sourceLabel","SaveHandler","apiUrl","onSuccess","onError","err","showToast","msg","dataLoader","isSaving","save","_c","_d","success","reason","hasCostChanges","_hasCostChanges","_buildPayload","payloadCount","_sendToServer","_handleSaveSuccess","_handleSaveError","progressMode","cellsToSave","_","proportion","_getSavedValue","parseInt","toFixed","tahapanPrimaryId","week_start","_formatDate","week_end","normalizedOrder","order","numericTahapan","fallbackWeek","costValue","project_id","week_end_day","toISOString","csrfToken","body","errorData","parsedBody","jsonError","message","text","errorMsg","errors","details","validation_errors","validationErrors","_e","pendingModifiedCount","_updateAssignmentMap","cellVolumeOverrides","apiSavedTotal","created_count","updated_count","fallbackSaved","saved_count","savedCount","detailMessages","slice","join","_getCurrentModeState","actualState","plannedState","costMap","getModifiedCount","validatePayload","warnings","isValid","cancel"],"mappings":"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"}