var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,s=(t,a,n)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n,r=(e,t,a)=>new Promise((n,s)=>{var r=e=>{try{i(a.next(e))}catch(t){s(t)}},o=e=>{try{i(a.throw(e))}catch(t){s(t)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(r,o);i((a=a.apply(e,t)).next())});function o(e){return r(this,arguments,function*(e,r={}){const o=(r.method||"GET").toUpperCase();["POST","PUT","DELETE","PATCH"].includes(o)&&(r.headers=r.headers||{},r.headers["X-CSRFToken"]=function(e){let t=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let n=0;n<a.length;n++){const s=a[n].trim();if(s.substring(0,e.length+1)===e+"="){t=decodeURIComponent(s.substring(e.length+1));break}}}return t}("csrftoken"));const i=yield fetch(e,((e,r)=>{for(var o in r||(r={}))a.call(r,o)&&s(e,o,r[o]);if(t)for(var o of t(r))n.call(r,o)&&s(e,o,r[o]);return e})({credentials:"same-origin"},r));if(!i.ok){const e=yield i.json().catch(()=>({}));throw new Error(e.error||`HTTP ${i.status}`)}return i.json()})}function i(e,t=[]){return e.forEach(e=>{t.push(e),e.children&&e.children.length>0&&i(e.children,t)}),t}class l{constructor(e,t={}){if(!e)throw new Error("[DataLoader] State is required");this.state=e,this.options=t,this.projectId=e.projectId,this.state.volumeMap||(this.state.volumeMap=new Map),this.state.assignmentMap||(this.state.assignmentMap=new Map),this.state.cache||(this.state.cache={})}loadAllData(){return r(this,arguments,function*(e={}){var t,a;if(this.state.cache.initialLoadInProgress)return console.info("[DataLoader] loadAllData skipped (already in progress)"),null;if(!e.force&&this.state.cache.initialLoadCompleted&&e.skipIfLoaded)return console.info("[DataLoader] loadAllData skipped (already completed)"),this.state.cache.initialLoadResult||null;this.state.cache.initialLoadInProgress=!0;try{return console.log("[DataLoader] Loading all data..."),yield Promise.all([this.loadTahapan(),this.loadPekerjaan(),this.loadVolumes()]),yield this.loadAssignments(),this.state.cache.initialLoadCompleted=!0,this.state.cache.initialLoadResult={completedAt:Date.now(),tahapanCount:(null==(t=this.state.tahapanList)?void 0:t.length)||0,pekerjaanCount:(null==(a=this.state.flatPekerjaan)?void 0:a.filter(e=>"pekerjaan"===e.type).length)||0},console.log("[DataLoader] ✅ All data loaded successfully:",this.state.cache.initialLoadResult),this.state.cache.initialLoadResult}catch(n){throw console.error("[DataLoader] ❌ Load data failed:",n),this.state.cache.initialLoadError=n,n}finally{this.state.cache.initialLoadInProgress=!1}})}loadTahapan(){return r(this,null,function*(){try{const e=this.state.apiBase||`/detail_project/api/project/${this.projectId}/tahapan/`,t=yield o(e);this.state.tahapanList=(t.tahapan||t||[]).sort((e,t)=>e.urutan-t.urutan);const a=function(e,t="weekly"){if(!Array.isArray(e)||0===e.length)return t;const a={daily:0,weekly:0,monthly:0};let n=0,s=0;if(e.forEach(e=>{if(e&&e.is_auto_generated&&"string"==typeof e.generation_mode){const t=e.generation_mode.toLowerCase();a.hasOwnProperty(t)&&(a[t]+=1,n+=1)}else s+=1}),n>0){const e=Object.entries(a).reduce((e,t)=>{const[n,s]=t;return e?s>a[e]?n:e:n},"");if(e&&a[e]>0)return e}return s>0?"custom":t}(this.state.tahapanList,this.state.timeScale||"weekly");return this.state.timeScale=a,console.log(`[DataLoader] ✅ Loaded ${this.state.tahapanList.length} tahapan, mode: ${a}`),this.state.tahapanList}catch(e){throw console.error("[DataLoader] ❌ Failed to load tahapan:",e),e}})}loadPekerjaan(){return r(this,null,function*(){try{const e=`/detail_project/api/project/${this.projectId}/list-pekerjaan/tree/`,t=function(e){const t=[],a=e.klasifikasi||e;return Array.isArray(a)?(a.forEach(e=>{const a={id:`klas-${e.id||e.nama}`,type:"klasifikasi",nama:e.name||e.nama||"Klasifikasi",children:[],level:0,expanded:!0};e.sub&&Array.isArray(e.sub)&&e.sub.forEach(e=>{const t={id:`sub-${e.id||e.nama}`,type:"sub-klasifikasi",nama:e.name||e.nama||"Sub-Klasifikasi",children:[],level:1,expanded:!0};e.pekerjaan&&Array.isArray(e.pekerjaan)&&e.pekerjaan.forEach(e=>{const a={id:e.id||e.pekerjaan_id,type:"pekerjaan",kode:e.snapshot_kode||e.kode||"",nama:e.snapshot_uraian||e.uraian||"",volume:e.volume||0,satuan:e.snapshot_satuan||e.satuan||"-",level:2};t.children.push(a)}),a.children.push(t)}),t.push(a)}),t):t}(yield o(e));return this.state.pekerjaanTree=t,this.state.flatPekerjaan=i(t),function(e,t){if(!Array.isArray(e)||0===e.length)return;if(t.expandedNodes instanceof Set||(t.expandedNodes=new Set),t.expandedNodes.size>0)return;const a=e=>{e.forEach(e=>{e&&e.id&&e.children&&e.children.length>0&&(t.expandedNodes.add(e.id),a(e.children))})};a(e)}(t,this.state),console.log(`[DataLoader] ✅ Loaded ${this.state.flatPekerjaan.length} pekerjaan nodes`),this.state.pekerjaanTree}catch(e){throw console.error("[DataLoader] ❌ Failed to load pekerjaan:",e),e}})}loadVolumes(){return r(this,null,function*(){try{const e=`/detail_project/api/project/${this.projectId}/volume-pekerjaan/list/`,t=yield o(e);this.state.volumeMap.clear();const a=t.items||t.volumes||t.data||[];return Array.isArray(a)&&a.forEach(e=>{const t=e.pekerjaan_id||e.id,a=parseFloat(e.quantity||e.volume||e.qty)||0;t&&this.state.volumeMap.set(t,a)}),console.log(`[DataLoader] ✅ Loaded ${this.state.volumeMap.size} volume entries`),this.state.volumeMap}catch(e){return console.error("[DataLoader] ❌ Failed to load volumes:",e),this.state.volumeMap}})}loadAssignments(){return r(this,null,function*(){try{this.state.assignmentMap.clear(),console.log("[DataLoader] Loading assignments (attempting API v2)...");const e=this.state.flatPekerjaan.filter(e=>"pekerjaan"===e.type);return 0===e.length?(console.info("[DataLoader] No pekerjaan nodes found for assignments"),this.state.assignmentMap):(yield this._loadAssignmentsViaV2(),this.state.assignmentMap)}catch(e){return console.error("[DataLoader] ❌ Failed to load assignments:",e),this.state.assignmentMap}})}reload(e){return r(this,null,function*(){const t={tahapan:()=>this.loadTahapan(),pekerjaan:()=>this.loadPekerjaan(),volumes:()=>this.loadVolumes(),assignments:()=>this.loadAssignments()}[e];if(!t)throw new Error(`[DataLoader] Unknown reload type: ${e}`);return console.log(`[DataLoader] Reloading ${e}...`),t()})}_buildWeekColumnIndex(){const e={};return Array.isArray(this.state.timeColumns)&&this.state.timeColumns.forEach(t=>{const a=Number(t.weekNumber||t.week_number||t.urutan);Number.isFinite(a)&&a>=1&&t.id&&(e[a]=t)}),e}_loadAssignmentsViaV2(){return r(this,null,function*(){var e;const t=`/detail_project/api/v2/project/${this.projectId}/assignments/`,a=yield o(t);if(!a||!Array.isArray(a.assignments))return void console.info("[DataLoader] API v2 returned no assignments array (treating as empty dataset)");if(0===a.assignments.length)return void console.info("[DataLoader] API v2 assignments empty (no progress recorded yet)");const n=this._buildWeekColumnIndex();let s=0;a.assignments.forEach(e=>{var t,a,r;const o=Number(e.pekerjaan_id||e.pekerjaanId||e.id),i=Number(e.week_number||e.weekNumber);let l;if("actual"===((null==(t=this.state)?void 0:t.progressMode)||"planned")?(l=parseFloat(null!=(a=e.actual_proportion)?a:e.proportion),console.log(`[DataLoader] Mode ACTUAL: Reading actual_proportion=${e.actual_proportion} for pekerjaan=${o}, week=${i}`)):(l=parseFloat(null!=(r=e.planned_proportion)?r:e.proportion),console.log(`[DataLoader] Mode PLANNED: Reading planned_proportion=${e.planned_proportion} for pekerjaan=${o}, week=${i}`)),!o||!i||Number.isNaN(l))return;const d=n[i];if(!d)return;const u=d.fieldId||d.id;if(!u)return;const c=`${o}-${u}`;this.state.assignmentMap.set(c,l),s+=1});const r=(null==(e=this.state)?void 0:e.progressMode)||"planned";console.log(`[DataLoader] ✅ Loaded ${s} assignments into ${r.toUpperCase()} state via API v2`)})}}function d(e){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}`}class u{constructor(e){if(!e)throw new Error("[TimeColumnGenerator] State is required");this.state=e}generate(){this.state.timeColumns=[],this._projectStartCache=void 0,this._jsWeekEndDayCache=void 0;const e=this.state.timeScale||"custom",t=this.state.tahapanList||[];return console.log(`[TimeColumnGenerator] Generating columns for mode: ${e}`),console.log(`[TimeColumnGenerator] Available tahapan in database: ${t.length}`),t.forEach((t,a)=>{let n=!1;if(n="custom"===e||!0===t.is_auto_generated&&t.generation_mode===e,n){const e=this._createColumn(t,a);this.state.timeColumns.push(e)}}),0===this.state.timeColumns.length&&t.length>0&&(console.warn(`[TimeColumnGenerator] No auto-generated tahapan found for mode "${e}"`),console.warn(`[TimeColumnGenerator] Showing all ${t.length} tahapan as fallback`),t.forEach((e,t)=>{const a=this._createColumn(e,t);this.state.timeColumns.push(a)})),console.log(`[TimeColumnGenerator] ✅ Generated ${this.state.timeColumns.length} time columns`),this.state.timeColumns}_createColumn(e,t){const a=e.tanggal_mulai?new Date(e.tanggal_mulai):null,n=e.tanggal_selesai?new Date(e.tanggal_selesai):null;let s=e.nama||`Tahap ${t+1}`,r="",o="",i=s,l=null,u="",c="";const h=Number.isInteger(e.urutan)&&e.urutan>=0?e.urutan:t,p="weekly"===(this.state.timeScale||"").toLowerCase()||"weekly"===(e.generation_mode||"").toLowerCase(),m=this._getProjectStartDate(),g=this._getJsWeekEndDay(),f=p&&a&&m?function(e,t,a={}){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return 1;if(!(t instanceof Date)||Number.isNaN(t.getTime()))return 1;if(e<=t)return 1;const n=Number.isInteger(a.weekEndDay)&&!Number.isNaN(a.weekEndDay)?(a.weekEndDay%7+7)%7:0,s=new Date(t),r=(n-t.getDay()+7)%7;if(s.setDate(s.getDate()+r),e<=s)return 1;const o=Math.floor((e-s)/864e5);return 1+Math.floor((o+6)/7)}(a,m,{weekEndDay:g}):null;if(!0===e.is_auto_generated&&"weekly"===e.generation_mode&&a&&n){l=null!=f?f:h+1,u=d(a),c=d(n),s=`Week ${l}`,r=`( ${u} - ${c} )`,o=`${u} - ${c}`;i=`Week ${l}: ${a.toLocaleDateString("id-ID",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})} - ${n.toLocaleDateString("id-ID",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})}`}else a&&n&&(u=d(a),c=d(n),r=`( ${u} - ${c} )`,o=`${u} - ${c}`);!l&&p&&(l=null!=f?f:h+1);const v=e.tahapan_id||e.id||h;return{id:`tahap-${v}`,fieldId:`col_${v}`,tahapanId:e.tahapan_id,label:s,rangeLabel:r,rangeText:o,tooltip:i,type:e.generation_mode||"custom",isAutoGenerated:e.is_auto_generated||!1,generationMode:e.generation_mode||"custom",index:h,weekNumber:l,startDate:a,endDate:n,urutan:e.urutan||t}}getColumnById(e){return this.state.timeColumns.find(t=>t.id===e)||null}getColumnByTahapanId(e){return this.state.timeColumns.find(t=>t.tahapanId===e)||null}getColumnsInRange(e,t){return this.state.timeColumns.filter(a=>!(!a.startDate||!a.endDate)&&(a.startDate<=t&&a.endDate>=e))}regenerate(){return console.log("[TimeColumnGenerator] Regenerating columns..."),this.generate()}_getProjectStartDate(){if(void 0!==this._projectStartCache)return this._projectStartCache;const e=this.state.projectStart;if(!e)return this._projectStartCache=null,this._projectStartCache;if(e instanceof Date)return this._projectStartCache=Number.isNaN(e.getTime())?null:e,this._projectStartCache;const t=new Date(e);return this._projectStartCache=Number.isNaN(t.getTime())?null:t,this._projectStartCache}_getJsWeekEndDay(){if(void 0!==this._jsWeekEndDayCache)return this._jsWeekEndDayCache;const e=Number(this.state.weekEndDay),t=Number.isFinite(e)?(e%7+7)%7:6;return this._jsWeekEndDayCache=(t+1)%7,this._jsWeekEndDayCache}}class c{constructor(e,t={}){if(!e)throw new Error("[SaveHandler] State is required");this.state=e,this.options=t,this.apiUrl=t.apiUrl||`/detail_project/api/project/${e.projectId}/pekerjaan/assign_weekly/`,this.onSuccess=t.onSuccess||(()=>{}),this.onError=t.onError||(e=>console.error(e)),this.showToast=t.showToast||((e,t)=>console.log(`[${t}] ${e}`)),this.isSaving=!1,console.log("[SaveHandler] Initialized with API:",this.apiUrl)}save(){return r(this,null,function*(){var e,t,a,n;if(this.isSaving)return console.warn("[SaveHandler] Save already in progress"),this.showToast("Penyimpanan sedang berlangsung...","warning"),{success:!1,reason:"already_saving"};console.log("[SaveHandler] Starting save operation..."),this.isSaving=!0;try{if(!this.state.modifiedCells||0===this.state.modifiedCells.size)return console.warn("[SaveHandler] No modified cells to save"),this.showToast("Tidak ada perubahan untuk disimpan","info"),this.isSaving=!1,{success:!1,reason:"no_changes"};const s=this._buildPayload(),r=null!=(n=null!=(a=null==(e=s.assignments)?void 0:e.length)?a:null==(t=s.items)?void 0:t.length)?n:0;console.log(`[SaveHandler] Built payload with ${r} items`);const o=yield this._sendToServer(s);return this._handleSaveSuccess(o),this.isSaving=!1,{success:!0,result:o}}catch(s){return this._handleSaveError(s),this.isSaving=!1,{success:!1,error:s}}})}_buildPayload(){var e,t;const a=[],n=(null==(e=this.state)?void 0:e.progressMode)||"planned";console.log(`[SaveHandler] Building payload from ${n.toUpperCase()} modifiedCells (size: ${this.state.modifiedCells.size})`),this.state.modifiedCells.forEach((e,t)=>{var n,s,r,o;const[i,l]=t.split("-");if(!i||!l)return void console.warn(`[SaveHandler] Invalid cell key: ${t}`);const d=parseFloat(e);if(!Number.isFinite(d))return void console.warn(`[SaveHandler] Invalid value for ${t}: ${e}`);const u=null==(n=this.state.timeColumns)?void 0:n.find(e=>{const t=e.fieldId||e.id;return(null==t?void 0:t.toString())===l.toString()}),c={pekerjaan_id:parseInt(i,10),proportion:Number(d.toFixed(2))};if(u){const e=null!=(r=null!=(s=u.tahapanId)?s:u.tahapan_id)?r:Number.isFinite(Number(u.id))?Number(u.id):null;if(e&&(c.tahapan_id=e),u.startDate&&(c.week_start=this._formatDate(u.startDate)),u.endDate&&(c.week_end=this._formatDate(u.endDate)),Number.isFinite(u.weekNumber)&&(c.week_number=u.weekNumber),!c.week_number){const e=Number.isFinite(u.index)?Number(u.index):Number.isFinite(u.order)?Number(u.order):Number.isFinite(u.urutan)?Number(u.urutan):null;null!==e&&(c.week_number=e+1)}}else{const e=parseInt(l,10);Number.isFinite(e)&&(c.tahapan_id=e)}if(!c.week_number){const e=parseInt(null!=(o=c.tahapan_id)?o:l,10);Number.isFinite(e)?c.week_number=e:c.week_number=1}a.push(c)}),console.log(`[SaveHandler] Built ${a.length} assignment items`),console.log(`[SaveHandler] Progress Mode: ${n.toUpperCase()} - Will save to ${"actual"===n?"actual_proportion":"planned_proportion"} field`);const s={assignments:a,mode:n,project_id:this.state.projectId,week_end_day:null!=(t=this.state.weekEndDay)?t:6};return console.log("[SaveHandler] Payload:",JSON.stringify(s,null,2)),s}_formatDate(e){return e instanceof Date||(e=new Date(e)),Number.isNaN(e.getTime())?"":e.toISOString().split("T")[0]}_sendToServer(e){return r(this,null,function*(){console.log("[SaveHandler] Sending request to:",this.apiUrl),console.log("[SaveHandler] Payload:",e);const t=function(e){let t=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let n=0;n<a.length;n++){const s=a[n].trim();if(s.substring(0,e.length+1)===e+"="){t=decodeURIComponent(s.substring(e.length+1));break}}}return t}("csrftoken"),a=yield fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":t},credentials:"same-origin",body:JSON.stringify(e)});if(!a.ok){let e={},t=null;try{t=yield a.json(),e=t||{}}catch(s){e={message:yield a.text().catch(()=>"")}}const n=e.error||e.message||`HTTP ${a.status}`,r=new Error(n);throw e.errors&&(r.details=e.errors),e.validation_errors&&(r.validationErrors=e.validation_errors),"object"==typeof e&&(r.payload=e),r}const n=yield a.json();return console.log("[SaveHandler] Server response:",n),n})}_handleSaveSuccess(e){console.log("[SaveHandler] ✅ Save successful"),this._updateAssignmentMap();const t=this.state.modifiedCells.size;this.state.modifiedCells.clear(),this.state.cellVolumeOverrides instanceof Map&&this.state.cellVolumeOverrides.clear(),this.state.cache&&(this.state.cache.hasUnsavedChanges=!1);const a=e.saved_count||e.count||t,n=`Berhasil menyimpan ${a} perubahan`;this.showToast(n,"success"),"function"==typeof this.onSuccess&&this.onSuccess(e),console.log(`[SaveHandler] Saved ${a} assignments, cleared ${t} modified cells`)}_handleSaveError(e){console.error("[SaveHandler] ❌ Save failed:",e);const t=[];Array.isArray(e.validationErrors)&&e.validationErrors.length>0&&(e.validationErrors.slice(0,3).forEach(e=>{(null==e?void 0:e.error)&&t.push(`• ${e.error}`)}),e.validationErrors.length>3&&t.push(`(+${e.validationErrors.length-3} lagi)`)),Array.isArray(e.details)&&e.details.length>0&&(e.details.slice(0,3).forEach(e=>{(null==e?void 0:e.error)&&t.push(`• ${e.error}`)}),e.details.length>3&&t.push(`(+${e.details.length-3} lagi)`));let a=`Gagal menyimpan: ${e.message}`;t.length>0&&(a+=`\n${t.join("\n")}`),this.showToast(a,"danger",5e3),"function"==typeof this.onError&&this.onError(e)}_updateAssignmentMap(){this.state.assignmentMap||(this.state.assignmentMap=new Map),this.state.modifiedCells.forEach((e,t)=>{const a=parseFloat(e);Number.isFinite(a)&&this.state.assignmentMap.set(t,a)}),console.log("[SaveHandler] Updated assignmentMap with modified values")}hasUnsavedChanges(){return this.state.modifiedCells&&this.state.modifiedCells.size>0}getModifiedCount(){return this.state.modifiedCells?this.state.modifiedCells.size:0}validatePayload(e){const t=[],a=[],n=Array.isArray(null==e?void 0:e.assignments)?e.assignments:Array.isArray(null==e?void 0:e.items)?e.items:null;if(!n)return t.push("Invalid payload structure"),{isValid:!1,errors:t,warnings:a};0===n.length&&a.push("No items to save"),n.forEach((e,n)=>{e.pekerjaan_id||t.push(`Item ${n}: Missing pekerjaan_id`),e.week_number||a.push(`Item ${n}: Missing week_number (akan memakai default)`),void 0===e.proportion?t.push(`Item ${n}: Missing proportion value`):Number.isFinite(e.proportion)?(e.proportion<0||e.proportion>100)&&a.push(`Item ${n}: Proportion out of range (${e.proportion}%)`):t.push(`Item ${n}: Invalid proportion value`)});const s=0===t.length;return s||console.error("[SaveHandler] Payload validation failed:",t),a.length>0&&console.warn("[SaveHandler] Payload validation warnings:",a),{isValid:s,errors:t,warnings:a}}cancel(){this.isSaving&&(console.log("[SaveHandler] Cancelling save operation..."),this.isSaving=!1)}getStats(){return{modifiedCells:this.getModifiedCount(),isSaving:this.isSaving,hasUnsavedChanges:this.hasUnsavedChanges(),apiUrl:this.apiUrl}}}export{l as D,c as S,u as T};
//# sourceMappingURL=core-modules-1J_5fLnI.js.map
