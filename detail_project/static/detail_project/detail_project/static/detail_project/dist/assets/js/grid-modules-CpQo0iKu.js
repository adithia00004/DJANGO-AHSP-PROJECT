var e=Object.defineProperty,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,n=(t,s,l)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[s]=l;import{c as i}from"./vendor-ag-grid-CNpf5Dvm.js";class a{constructor(e){this.rootElement=e,this.handlers=new Map,this.activeListeners=new Map}on(e,t,s,l={}){this.handlers.has(e)||(this.handlers.set(e,[]),this._attachListener(e,l)),this.handlers.get(e).push({selector:t,handler:s,options:l})}off(e,t,s){if(!this.handlers.has(e))return;const l=this.handlers.get(e),n=l.findIndex(e=>e.selector===t&&e.handler===s);-1!==n&&(l.splice(n,1),0===l.length&&(this._detachListener(e),this.handlers.delete(e)))}clearEvent(e){this.handlers.has(e)&&(this._detachListener(e),this.handlers.delete(e))}destroy(){for(const e of this.handlers.keys())this._detachListener(e);this.handlers.clear(),this.activeListeners.clear(),this.rootElement=null}_attachListener(e,t={}){const s=t=>{const s=this.handlers.get(e)||[];for(const{selector:e,handler:l}of s){const s=t.target.closest(e);s&&this.rootElement.contains(s)&&l.call(s,t,s)}};this.rootElement.addEventListener(e,s,{capture:t.capture||!1,passive:t.passive||!1}),this.activeListeners.set(e,s)}_detachListener(e){const t=this.activeListeners.get(e);t&&(this.rootElement.removeEventListener(e,t),this.activeListeners.delete(e))}}function r(e){let t=null,s=null;const l=function(...l){s=l,null===t&&(t=requestAnimationFrame(()=>{e.apply(this,s),t=null,s=null}))};return l.cancel=()=>{null!==t&&(cancelAnimationFrame(t),t=null,s=null)},l}function o(e,t={}){const{min:s=0,max:l=100,precision:n=1}=t;if(null==e||""===e)return{isValid:!0,message:"",level:"info",value:0};const i=parseFloat(e);if(isNaN(i))return{isValid:!1,message:`Nilai harus berupa angka (0-${l})`,level:"error",value:0};if(i<s)return{isValid:!1,message:`Nilai tidak boleh kurang dari ${s}`,level:"error",value:s};if(i>l)return{isValid:!1,message:`Nilai tidak boleh lebih dari ${l}`,level:"error",value:l};return{isValid:!0,message:"",level:"info",value:Math.round(i*Math.pow(10,n))/Math.pow(10,n)}}function d(e,t,s){const l=document.querySelector(`[data-pekerjaan-id="${e}"]`);if(!l)return;const n=l.querySelector(".progress-indicator")||function(e){const t=e.querySelector(".name-cell");if(!t)return null;const s=document.createElement("span");return s.className="progress-indicator",t.appendChild(s),s}(l),i=function(e,t={}){const{maxTotal:s=100,tolerance:l=.1}=t,n=e.reduce((e,t)=>e+(parseFloat(t)||0),0),i=Math.round(10*n)/10;return Math.abs(i-s)<l?{isValid:!0,message:`Total: ${i}%`,level:"info",value:i}:i>s?{isValid:!1,message:`Total melebihi ${s}% (${i}%)`,level:"error",value:i}:i<s-l?{isValid:!1,message:`Total kurang dari ${s}% (${i}%)`,level:"warning",value:i}:{isValid:!0,message:`Total: ${i}%`,level:"info",value:i}}([t],{maxTotal:100});n.textContent=`${t.toFixed(1)}%`,n.className="progress-indicator","error"===i.level?n.classList.add("progress-error"):"warning"===i.level?n.classList.add("progress-warning"):n.classList.add("progress-success"),s&&s.progressTotals&&s.progressTotals.set(e,t)}function c(e,t,s){const l=e.target,n=l.value,i=o(n);if(function(e,t,s={}){const{showTooltip:l=!0,tooltipDuration:n=3e3}=s;e.classList.remove("validation-error","validation-warning","validation-success");const i=e.querySelector(".validation-tooltip");if(i&&i.remove(),t.isValid)e.classList.add("validation-success");else if("error"===t.level?e.classList.add("validation-error"):"warning"===t.level&&e.classList.add("validation-warning"),l&&t.message){const s=document.createElement("div");s.className=`validation-tooltip validation-tooltip-${t.level}`,s.textContent=t.message,e.style.position="relative",e.appendChild(s),n>0&&setTimeout(()=>{s.remove()},n)}}(t,i,{showTooltip:!i.isValid,tooltipDuration:3e3}),i.isValid||i.value!==parseFloat(n)){l.value=i.value;const e=t.dataset.cellId;e&&s.modifiedCells&&s.modifiedCells.set(e,i.value)}return i.isValid||"error"!==i.level||"function"==typeof window.showToast&&window.showToast(i.message,"danger",3e3),i}class u{constructor(e,t){this.state=e,this.helpers=t,this.eventManagers=new Map,this.scrollHandlers=new Map}attachEvents(){var e,t,s,l,n;const i=(null==(e=this.state.domRefs)?void 0:e.leftTbody)||document.getElementById("left-tbody"),a=(null==(t=this.state.domRefs)?void 0:t.rightTbody)||document.getElementById("right-tbody"),r=(null==(s=this.state.domRefs)?void 0:s.leftPanelScroll)||document.querySelector(".left-panel-scroll"),o=(null==(l=this.state.domRefs)?void 0:l.rightPanelScroll)||document.querySelector(".right-panel-scroll");if(!i||!a)return console.error("Grid containers not found"),!1;this.cleanup(),this._setupLeftPanelEvents(i),this._setupRightPanelEvents(a),r&&o&&this._setupScrollSync(r,o);const d=(null==(n=this.state.domRefs)?void 0:n.horizontalScrollTop)||document.getElementById("right-panel-scroll-top");return d&&o&&this._setupHorizontalScrollSync(d,o),!0}_setupLeftPanelEvents(e){const t=new a(e);t.on("click",".tree-toggle",(e,t)=>{this._handleTreeToggle(e,t)}),t.on("click",".name-cell",(e,t)=>{this._handleRowSelection(e,t)}),this.eventManagers.set("left-panel",t)}_setupRightPanelEvents(e){const t=new a(e);t.on("click",".time-cell.editable",(e,t)=>{this._handleCellClick(e,t)}),t.on("dblclick",".time-cell.editable",(e,t)=>{this._handleCellDoubleClick(e,t)}),t.on("input",".time-cell input",(e,t)=>{this._handleCellInput(e,t)}),t.on("blur",".time-cell input",(e,t)=>{this._handleCellBlur(e,t)}),t.on("keydown",".time-cell input",(e,t)=>{this._handleCellKeydown(e,t)}),this.eventManagers.set("right-panel",t)}_setupScrollSync(e,t){const s=r(()=>{t.scrollTop=e.scrollTop}),l=r(()=>{e.scrollTop=t.scrollTop});e.addEventListener("scroll",s,{passive:!0}),t.addEventListener("scroll",l,{passive:!0}),this.scrollHandlers.set("left",{element:e,handler:s}),this.scrollHandlers.set("right",{element:t,handler:l})}_setupHorizontalScrollSync(e,t){const s=r(()=>{t.scrollLeft=e.scrollLeft}),l=r(()=>{e.scrollLeft=t.scrollLeft});e.addEventListener("scroll",s,{passive:!0}),t.addEventListener("scroll",l,{passive:!0}),this.scrollHandlers.set("horizontal-top",{element:e,handler:s}),this.scrollHandlers.set("horizontal-bottom",{element:t,handler:l})}_handleTreeToggle(e,t){e.stopPropagation();const s=t.dataset.nodeId,l=!t.classList.contains("collapsed");l?(this.state.expandedNodes.delete(s),t.classList.add("collapsed")):(this.state.expandedNodes.add(s),t.classList.remove("collapsed")),this._toggleNodeChildren(s,!l),requestAnimationFrame(()=>{this._syncRowHeights()})}_toggleNodeChildren(e,t){var s,l;const n=(null==(s=this.state.domRefs)?void 0:s.leftTbody)||document.getElementById("left-tbody"),i=(null==(l=this.state.domRefs)?void 0:l.rightTbody)||document.getElementById("right-tbody"),a=`[data-parent-id="${e}"]`,r=n.querySelectorAll(a),o=i.querySelectorAll(a),d=t?"":"none";r.forEach(e=>{if(e.style.display=d,!t){const t=e.dataset.nodeId;t&&this._toggleNodeChildren(t,!1)}}),o.forEach(e=>{e.style.display=d})}_handleRowSelection(e,t){const s=t.closest("tr");if(!s)return;s.classList.toggle("row-selected");const l=s.dataset.rowIndex;if(l){const e=document.querySelector(`.right-panel-scroll tr[data-row-index="${l}"]`);e&&e.classList.toggle("row-selected")}}_handleCellClick(e,t){document.querySelectorAll(".time-cell.selected").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected")}_handleCellDoubleClick(e,t){e.preventDefault(),t.classList.contains("editing")||this._enterEditMode(t)}_enterEditMode(e){const t=e.dataset.value||"0",s=document.createElement("input");s.type="number",s.className="cell-input",s.value=t,s.min="0",s.max="100",s.step="0.1",e.innerHTML="",e.appendChild(s),e.classList.add("editing"),s.focus(),s.select()}_handleCellInput(e,t){const s=t.closest(".time-cell");if(!s)return;const l=parseFloat(t.value);isNaN(l)||(l<0||l>100?s.classList.add("validation-warning"):s.classList.remove("validation-warning"))}_handleCellBlur(e,t){const s=t.closest(".time-cell");if(!s)return;const l=c(e,s,this.state);this._exitEditMode(s,l.value);const n=s.dataset.cellId;if(n){this.state.modifiedCells=this.state.modifiedCells||new Map,this.state.modifiedCells.set(n,l.value),this.state.isDirty=!0;const[e]=n.split("-");this._updatePekerjaanProgress(e)}}_exitEditMode(e,t){e.classList.remove("editing"),e.dataset.value=t;const s=0===t?"-":`${t}%`;e.innerHTML=`<span class="cell-value">${s}</span>`}_handleCellKeydown(e,t){const s=t.closest(".time-cell");if(s)switch(e.key){case"Enter":e.preventDefault(),t.blur(),this._navigateToNextCell(s,"down");break;case"Escape":e.preventDefault();const l=s.dataset.originalValue||"0";t.value=l,t.blur();break;case"Tab":e.preventDefault(),t.blur();const n=e.shiftKey?"left":"right";this._navigateToNextCell(s,n);break;case"ArrowUp":e.ctrlKey&&(e.preventDefault(),t.blur(),this._navigateToNextCell(s,"up"));break;case"ArrowDown":e.ctrlKey&&(e.preventDefault(),t.blur(),this._navigateToNextCell(s,"down"))}}_navigateToNextCell(e,t){const s=e.closest("tr");if(!s)return;let l=null;switch(t){case"right":for(l=e.nextElementSibling;l&&!l.classList.contains("editable");)l=l.nextElementSibling;break;case"left":for(l=e.previousElementSibling;l&&!l.classList.contains("editable");)l=l.previousElementSibling;break;case"down":const t=s.nextElementSibling;if(t){const n=Array.from(s.children).indexOf(e);l=t.children[n]}break;case"up":const n=s.previousElementSibling;if(n){const t=Array.from(s.children).indexOf(e);l=n.children[t]}}l&&l.classList.contains("editable")&&this._enterEditMode(l)}_updatePekerjaanProgress(e){const t=this.state.modifiedCells||new Map,s=this.state.timeColumns||[];let l=0;s.forEach(s=>{const n=`${e}-${s.id}`,i=t.get(n)||0;l+=parseFloat(i)||0}),"function"==typeof this.helpers.updateProgressIndicator&&this.helpers.updateProgressIndicator(e,l)}_syncRowHeights(){var e,t;const s=(null==(e=this.state.domRefs)?void 0:e.leftTbody)||document.getElementById("left-tbody"),l=(null==(t=this.state.domRefs)?void 0:t.rightTbody)||document.getElementById("right-tbody");if(!s||!l)return;const n=s.querySelectorAll("tr"),i=l.querySelectorAll("tr");n.forEach((e,t)=>{const s=i[t];if(!s)return;e.style.height="",s.style.height="";const l=e.offsetHeight,n=s.offsetHeight,a=Math.max(l,n);e.style.height=`${a}px`,s.style.height=`${a}px`})}cleanup(){for(const e of this.eventManagers.values())e.destroy();this.eventManagers.clear();for(const{element:e,handler:t}of this.scrollHandlers.values())t.cancel&&t.cancel(),e.removeEventListener("scroll",t);this.scrollHandlers.clear()}}function h(e,t={}){const s=new u(e,t);return s.attachEvents(),s}function p(e=[],t={}){const s="function"==typeof t.isEditableFn?t.isEditableFn:g,l=(t.inputMode||"percentage").toLowerCase(),n="function"==typeof t.getCellValidationState?t.getCellValidationState:null,i=[{headerName:"Pekerjaan",field:"name",minWidth:280,flex:1.2,pinned:"left",cellRenderer:m,cellClass:"ag pekerjaan-col",wrapText:!0,autoHeight:!0},{headerName:"Volume",field:"volume",width:70,pinned:"left",resizable:!1,editable:!1,suppressHeaderMenuButton:!0,cellClass:"ag-volume-col text-end",valueFormatter:e=>function(e){if(null==e||""===e)return"-";const t=Number(e);if(Number.isNaN(t))return e;return t.toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:2})}(e.value)},{headerName:"Satuan",field:"unit",width:70,pinned:"left",resizable:!1,editable:!1,suppressHeaderMenuButton:!0,cellClass:"ag-unit-col text-center"}],a=(e||[]).map(e=>{const t=e.fieldId||e.id||"periode",i=e.label||e.id||"Periode",a=e.rangeText||(e.rangeLabel?e.rangeLabel.replace(/[()]/g,"").trim():""),r=a?`${i}\n${a}`:i,o=e=>{var s,l,n,i,a,r,o,d;const c=(null==(l=null==(s=null==e?void 0:e.data)?void 0:s.raw)?void 0:l.id)||(null==(n=null==e?void 0:e.data)?void 0:n.id)||(null==(r=null==(a=null==(i=null==e?void 0:e.node)?void 0:i.data)?void 0:a.raw)?void 0:r.id)||(null==(d=null==(o=null==e?void 0:e.node)?void 0:o.data)?void 0:d.id);return c?`${c}-${t}`:null},d={"ag-cell-readonly":e=>!s(e)};return n&&(d["ag-cell-invalid"]=e=>{const t=o(e);return!!t&&"error"===n(t)},d["ag-cell-warning"]=e=>{const t=o(e);return!!t&&"warning"===n(t)}),{headerName:r,field:t,minWidth:100,flex:1,type:"numericColumn",cellDataType:"number",editable:e=>s(e),cellEditor:"agNumberCellEditor",valueParser:e=>function(e){if(null==e||""===e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;const t=parseFloat(e);return Number.isFinite(t)?t:null}(e.newValue),cellClass:"ag-time-col",cellClassRules:d,headerClass:"ag-time-header",valueFormatter:e=>function(e,t="percentage"){if(null==e||""===e)return"-";if("volume"===t){const t=Number(e);return Number.isNaN(t)?e:t.toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:3})}return`${e}`}(e.value,l)}});return i.concat(a)}function m(e){var t;const s=e.value||"",l=(null==(t=e.data)?void 0:t.level)||0,n=document.createElement("div");return n.className="ag-pekerjaan-label",n.style.paddingLeft=16*l+"px",n.textContent=s,n}function g(e){var t,s,l;return"pekerjaan"===((null==(t=null==e?void 0:e.data)?void 0:t.rowType)||(null==(l=null==(s=null==e?void 0:e.data)?void 0:s.raw)?void 0:l.type))}class f{constructor(e,t={}){this.state=e,this.helpers=t,this.gridApi=null,this.columnApi=null,this.gridOptions=null,this.container=null,this.currentColumns=[],this.themeObserver=null,this.inputMode=((null==e?void 0:e.inputMode)||"percentage").toLowerCase(),this.topScroll=null,this.topScrollInner=null,this.bottomHorizontalViewport=null,this.horizontalScrollHandlers=[],this._isSyncingHorizontalScroll=!1}mount(e){e?(this.container=e,this.gridOptions=this._createGridOptions(),this.gridApi=i(e,this.gridOptions),"function"==typeof this.gridApi.getColumnApi&&(this.columnApi=this.gridApi.getColumnApi()),e.classList.add("ag-grid-initialized"),this._applyThemeClass(),this._setupThemeWatcher(),this._setupHorizontalScrollProxy(),this._updateTopScrollWidth()):console.warn("[AGGridManager] Container not provided")}updateData({tree:e=[],timeColumns:t=[],inputMode:s,timeScale:l}={}){if(!this.gridApi)return;"string"==typeof s&&(this.inputMode=s.toLowerCase()),"string"==typeof l&&(this.state.timeScale=l.toLowerCase());const n=p(t,this._getColumnOptions());this.currentColumns=t,this.gridApi.setGridOption("columnDefs",n);const i=this._buildRowData(e,t);this.gridApi.setGridOption("rowData",i),this._updateTopScrollWidth()}destroy(){this.gridApi&&(this.gridApi.destroy(),this.gridApi=null,this.columnApi=null),this.themeObserver&&(this.themeObserver.disconnect(),this.themeObserver=null),this._teardownHorizontalScrollProxy()}_createGridOptions(){return{columnDefs:p([],this._getColumnOptions()),rowData:[],animateRows:!0,suppressAggFuncInHeader:!0,rowHeight:60,headerHeight:44,defaultColDef:{resizable:!0,sortable:!1,flex:1,minWidth:120},rowClassRules:{"row-has-error":e=>this._isFailedRow(null==e?void 0:e.data),"row-has-warning":e=>this._isWarningRow(null==e?void 0:e.data),"row-save-error":e=>this._hasSaveError(null==e?void 0:e.data)},onCellValueChanged:e=>this._handleCellValueChanged(e)}}_buildRowData(e=[],t=[]){const s=[],l=t||[],n=(e,t=[],i=0)=>{const a=(e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e).filter(Boolean):[])(e);a.length&&a.forEach((e,a)=>{if(!e)return;const r=e.snapshot_uraian||e.uraian||e.nama||e.name||`Node ${t.length+a+1}`,o=e.snapshot_kode||e.kode||e.code||"",d=t.concat(r),c=e.type||e.rowType||(e.children&&e.children.length>0?"klasifikasi":"pekerjaan"),u=e.id||e.pekerjaan_id||`node-${d.join("-")}`,h=[];h.push(`row-${c}`);const p={id:u,name:r,code:o,path:d,level:i,raw:e,rowType:c,isEditable:"pekerjaan"===c,rowClass:h.join(" "),unit:e.snapshot_satuan||e.satuan||e.unit||e.snapshot_unit||"",volume:this._resolveVolumeValue(e)};l.length>0&&l.forEach(t=>{var s,l,n;const i=t.fieldId||t.id;if(!i)return;let a=null;if(Array.isArray(t.childColumns)&&t.childColumns.length>0)a=t.childColumns.reduce((e,t)=>{const s=t.fieldId||t.id,l=this._fetchAssignmentValue(u,s);return e+(Number(l)||0)},0);else{const r=e.assignments||e.assignment_map||e.assignmentMap||e[i];if(r&&"object"==typeof r){const e=null!=(l=null!=(s=r[t.id])?s:r[t.fieldId])?l:r[t.label];a=this._normalizeCellValue(e)}else void 0!==e[i]&&(a=this._normalizeCellValue(e[i]));null==a&&(null==(n=this.state)?void 0:n.assignmentMap)&&(a=this._fetchAssignmentValue(u,i))}let r=a;"volume"===this.inputMode&&null!=a&&(r=this._percentToVolume(r,p.volume)),p[i]=r}),s.push(p);const m=(e=>{if(!e||"object"!=typeof e)return[];const t=["children","sub","pekerjaan","items","nodes"];for(const s of t)if(Array.isArray(e[s])&&e[s].length>0)return e[s];return[]})(e);m.length>0&&n(m,d,i+1)})};return n(e,[]),"undefined"!=typeof console&&console.log("[AGGridManager] updateData",s.length,"rows,",l.length+2,"columns"),s}_handleCellValueChanged(e){var t,s,l;const n=null==e?void 0:e.colDef,i=null==n?void 0:n.field;if(!i)return;const a=null==e?void 0:e.data,r=(null==(t=null==a?void 0:a.raw)?void 0:t.id)||(null==a?void 0:a.id);if(!r)return;if((null==(s=this.state)?void 0:s.displayScale)&&"weekly"!==this.state.displayScale)return"function"==typeof this.helpers.showToast&&this.helpers.showToast("Pengeditan hanya tersedia pada mode weekly","warning"),void(e.node&&e.node.setDataValue(i,e.oldValue));if(!this._isCellEditable(a))return"function"==typeof this.helpers.showToast&&this.helpers.showToast("Progress hanya dapat diisi pada baris pekerjaan","warning"),void(e.node&&e.node.setDataValue(i,e.oldValue));const d="volume"===this.inputMode,c=Number(null==a?void 0:a.volume)||0,u=o(e.newValue,{min:0,max:d?c||0:100,precision:d?3:1});if(!u.isValid&&u.message&&"function"==typeof this.helpers.showToast){const e="error"===u.level?"danger":"warning";this.helpers.showToast(u.message,e)}let h=null!=(l=u.value)?l:0,p=h;d&&(p=this._volumeToPercent(h,c)),p=Number.isFinite(p)?Number(p.toFixed(2)):0,e.node&&e.node.setDataValue(i,h);const m=(this.currentColumns||[]).find(e=>(e.fieldId||e.id)===i)||null,g=`${r}-${i}`;"function"==typeof this.helpers.onCellChange&&this.helpers.onCellChange({cellKey:g,value:p,pekerjaanId:r,columnId:i,columnMeta:m,displayValue:h,rowVolume:c,isVolumeMode:d,validation:u})}_resolveVolumeValue(e){var t;const s=(null==e?void 0:e.id)||(null==e?void 0:e.pekerjaan_id),l=null==(t=this.state)?void 0:t.volumeMap;return l instanceof Map&&s&&l.has(s)?l.get(s):l&&"object"==typeof l&&s&&l[s]?l[s]:e.volume||e.qty||e.jumlah||e.volume_total||e.total_volume||""}updateTopScrollMetrics(){this._updateTopScrollWidth()}_fetchAssignmentValue(e,t){var s;if(!e||!t||!(null==(s=this.state)?void 0:s.assignmentMap))return null;const l=`${e}-${t}`,n=this.state.assignmentMap;return n instanceof Map?n.has(l)?this._normalizeCellValue(n.get(l)):null:"object"==typeof n&&null!==n&&Object.prototype.hasOwnProperty.call(n,l)?this._normalizeCellValue(n[l]):null}_percentToVolume(e,t){const s=Number(e),l=Number(t);return Number.isFinite(s)&&Number.isFinite(l)?s/100*l:e}_volumeToPercent(e,t){const s=Number(e),l=Number(t);if(!Number.isFinite(s)||s<0)return 0;if(!Number.isFinite(l)||l<=0)return 0;const n=s/l*100;return Math.min(100,Math.max(0,n))}_applyThemeClass(){var e;if(!this.container)return;const t="dark"===((null==(e=document.documentElement)?void 0:e.getAttribute("data-bs-theme"))||"light").toLowerCase();this.container.classList.remove("ag-theme-alpine","ag-theme-alpine-dark"),this.container.classList.add(t?"ag-theme-alpine-dark":"ag-theme-alpine")}setInputMode(e){if(!e)return;const t=e.toLowerCase();if(this.inputMode!==t&&(this.inputMode=t,this.gridApi)){const e=p(this.currentColumns,this._getColumnOptions());this.gridApi.setGridOption("columnDefs",e),this.gridApi.refreshCells({force:!0})}}_getColumnOptions(){return{inputMode:this.inputMode||"percentage",isEditableFn:e=>this._isCellEditable((null==e?void 0:e.data)||e),getCellValidationState:e=>{var t;return"function"==typeof(null==(t=this.helpers)?void 0:t.getCellValidationState)?this.helpers.getCellValidationState(e):null}}}_isCellEditable(e){var t,s;if(!e)return!1;if((null==(t=this.state)?void 0:t.displayScale)&&"weekly"!==this.state.displayScale)return!1;const l=e.data||e;return"pekerjaan"===((null==l?void 0:l.rowType)||(null==(s=null==l?void 0:l.raw)?void 0:s.type))}_normalizeCellValue(e){if(null==e||""===e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){const t=e.trim();if(""===t)return null;const s=parseFloat(t.replace(",","."));return Number.isFinite(s)?s:null}return null}_setupHorizontalScrollProxy(){var e,t;const s=document.getElementById("ag-grid-scroll-top"),l=document.getElementById("ag-grid-scroll-inner");if(!s||!l)return;const n=(null==(e=this.container)?void 0:e.querySelector(".ag-body-horizontal-scroll-viewport"))||(null==(t=this.container)?void 0:t.querySelector(".ag-center-cols-viewport"));if(!n)return;this.topScroll=s,this.topScrollInner=l,this.bottomHorizontalViewport=n;const i=()=>{this._isSyncingHorizontalScroll||(this._isSyncingHorizontalScroll=!0,n.scrollLeft=s.scrollLeft,this._isSyncingHorizontalScroll=!1)},a=()=>{this._isSyncingHorizontalScroll||(this._isSyncingHorizontalScroll=!0,s.scrollLeft=n.scrollLeft,this._isSyncingHorizontalScroll=!1)};s.addEventListener("scroll",i,{passive:!0}),n.addEventListener("scroll",a,{passive:!0}),this.horizontalScrollHandlers.push({element:s,handler:i}),this.horizontalScrollHandlers.push({element:n,handler:a}),setTimeout(()=>this._updateTopScrollWidth(),0)}_teardownHorizontalScrollProxy(){this.horizontalScrollHandlers.forEach(({element:e,handler:t})=>{e.removeEventListener("scroll",t)}),this.horizontalScrollHandlers=[],this.topScroll=null,this.topScrollInner=null,this.bottomHorizontalViewport=null}_updateTopScrollWidth(){if(!this.topScrollInner||!this.container)return;const e=this.container.querySelector(".ag-center-cols-container");if(!e)return;const t=e.scrollWidth;t>0&&(this.topScrollInner.style.width=`${t}px`)}refreshRowStyles(){this.gridApi&&this.gridApi.refreshCells({force:!0})}refreshCells(e={}){this.gridApi&&this.gridApi.refreshCells(((e,i)=>{for(var a in i||(i={}))s.call(i,a)&&n(e,a,i[a]);if(t)for(var a of t(i))l.call(i,a)&&n(e,a,i[a]);return e})({force:!0},e))}_setupThemeWatcher(){this.themeObserver||"undefined"==typeof MutationObserver||(this.themeObserver=new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"data-bs-theme"===e.attributeName&&this._applyThemeClass()})}),this.themeObserver.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]}))}_resolveRowId(e){var t,s,l,n;if(!e)return null;const i=e.raw||e,a=null!=(n=null!=(l=null!=(s=null!=(t=null==i?void 0:i.id)?t:null==i?void 0:i.pekerjaan_id)?s:e.id)?l:e.pekerjaan_id)?n:null;if(null==a)return null;const r=Number(a);return Number.isFinite(r)?r:a}_setHasFlag(e,t){if(null==t||!(e instanceof Set))return!1;const s=Number(t),l=Number.isFinite(s)?s:t;return e.has(l)}_isFailedRow(e){var t;const s=this._resolveRowId(e);return this._setHasFlag(null==(t=this.state)?void 0:t.failedRows,s)}_isWarningRow(e){var t;const s=this._resolveRowId(e);return this._setHasFlag(null==(t=this.state)?void 0:t.validationWarningRows,s)}_hasSaveError(e){var t;const s=this._resolveRowId(e);return this._setHasFlag(null==(t=this.state)?void 0:t.saveErrorRows,s)}}function v(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function y(e,t=2){if(null==e||""===e)return"-";const s=parseFloat(e);return Number.isNaN(s)?"-":s.toLocaleString("id-ID",{minimumFractionDigits:t,maximumFractionDigits:t})}class b{constructor(e,t={}){if(!e)throw new Error("[GridRenderer] State is required");this.state=e,this.options=t,this.escapeHtml=t.escapeHtml||v,this.formatNumber=t.formatNumber||y,console.log("[GridRenderer] Initialized")}_getDisplayColumns(){var e,t;return Array.isArray(null==(e=this.state)?void 0:e.activeTimeColumns)&&this.state.activeTimeColumns.length>0?this.state.activeTimeColumns:Array.isArray(null==(t=this.state)?void 0:t.timeColumns)?this.state.timeColumns:[]}_formatDisplayValue(e,t,s=t){var l,n;const i=Number(t),a=Number(s);if(!(i>0&&Number.isFinite(i)||0===i&&Number.isFinite(a)&&a>0))return"";if("volume"===((null==(l=this.state)?void 0:l.displayMode)||"percentage").toLowerCase()){const t=null==(n=this.state)?void 0:n.volumeMap;let s=0;if(t instanceof Map&&t.has(e)?s=Number(t.get(e))||0:t&&"object"==typeof t&&t[e]&&(s=Number(t[e])||0),!Number.isFinite(s)||s<=0)return`<span class="cell-value percentage">${i.toFixed(1)}</span>`;return`<span class="cell-value volume">${(i/100*s).toFixed(2)}</span>`}return`<span class="cell-value percentage">${i.toFixed(1)}</span>`}renderTables(){if(!this.state||!Array.isArray(this.state.pekerjaanTree))return console.warn("[GridRenderer] Invalid state or missing pekerjaanTree"),null;console.log(`[GridRenderer] Rendering tables for ${this.state.pekerjaanTree.length} root nodes`);const e=[],t=[];this.state.pekerjaanTree.forEach(s=>{this._renderLeftRow(s,e,!0,null),this._renderRightRow(s,t,!0,null)});const s=e.join(""),l=t.join("");return console.log(`[GridRenderer] ✅ Rendered ${e.length} rows`),{leftHTML:s,rightHTML:l}}_renderLeftRow(e,t,s=!0,l=null){const n=this._isNodeExpanded(e.id),i=s,a="pekerjaan"===e.type&&this.state.volumeResetJobs instanceof Set&&this.state.volumeResetJobs.has(e.id),r=[`row-${e.type}`];i||r.push("row-hidden"),a&&r.push("volume-warning");const o=r.join(" ").trim(),d=`level-${e.level}`;if(e.children&&e.children.length>0){e.id}const c=this.state.volumeMap&&this.state.volumeMap.has(e.id)?this.state.volumeMap.get(e.id):0,u="pekerjaan"===e.type?this.formatNumber(c):"",h="pekerjaan"===e.type?this.escapeHtml(e.satuan):"",p="pekerjaan"===e.type?this._renderProgressChip(e.id):"";t.push(`\n      <tr class="${o}" data-node-id="${e.id}" data-parent-id="${null!=l?l:""}" data-row-index="${t.length}">\n        <td class="col-uraian ${d}">\n          <div class="tree-node">\n            <div class="tree-node-body">\n              ${a?'<div class="tree-node-meta"><span class="kt-volume-pill">Perlu update volume</span></div>':""}\n              <div class="tree-node-title">\n                <span class="tree-node-label">${this.escapeHtml(e.nama)}</span>\n                ${p}\n              </div>\n            </div>\n          </div>\n        </td>\n        <td class="col-volume text-right">${u}</td>\n        <td class="col-satuan">${h}</td>\n      </tr>\n    `),e.children&&e.children.length>0&&e.children.forEach(s=>{this._renderLeftRow(s,t,n&&i,e.id)})}_renderRightRow(e,t,s=!0,l=null){const n=this._isNodeExpanded(e.id),i=s,a="pekerjaan"===e.type&&this.state.volumeResetJobs instanceof Set&&this.state.volumeResetJobs.has(e.id),r=[`row-${e.type}`];i||r.push("row-hidden"),a&&r.push("volume-warning");const o=r.join(" ").trim(),d=this._getDisplayColumns().map(t=>this._renderTimeCell(e,t)).join("");t.push(`\n      <tr class="${o}" data-node-id="${e.id}" data-parent-id="${null!=l?l:""}" data-row-index="${t.length}">\n        ${d}\n      </tr>\n    `),e.children&&e.children.length>0&&e.children.forEach(s=>{this._renderRightRow(s,t,n&&i,e.id)})}_renderTimeCell(e,t){if("pekerjaan"!==e.type)return`<td class="time-cell readonly" data-node-id="${e.id}" data-col-id="${t.id}"></td>`;if(Array.isArray(t.childColumns)&&t.childColumns.length>0){const s=t.childColumns.reduce((t,s)=>{const l=s.fieldId||s.id,n=this._getAssignmentValue(`${e.id}-${l}`),{value:i}=this.getEffectiveCellValue(e.id,l,n);return t+(Number(i)||0)},0),l=this._formatDisplayValue(e.id,s,s),n=Number.isFinite(s)?s.toFixed(2):"";return`<td class="time-cell readonly monthly"\n                data-node-id="${e.id}"\n                data-col-id="${t.id}"\n                data-value="${n}"\n                tabindex="-1">\n                ${l}\n              </td>`}const s=`${e.id}-${t.id}`,l=this._getAssignmentValue(s),{value:n,modifiedValue:i}=this.getEffectiveCellValue(e.id,t.id,l);let a=`time-cell editable ${"monthly"===(t.generationMode||t.type||"").toLowerCase()?"monthly":"weekly"}`;l>0&&(a+=" saved"),void 0!==i&&i!==l&&(a+=" modified");const r=this._formatDisplayValue(e.id,n,l);return`<td class="${a}"\n                data-node-id="${e.id}"\n                data-col-id="${t.id}"\n                data-value="${n}"\n                data-saved-value="${l}"\n                tabindex="0">\n              ${r}\n            </td>`}renderTimeHeader(e){const t=this._getDisplayColumns();if(!e||0===t.length)return console.warn("[GridRenderer] Invalid header row or time columns"),"legacy";console.log(`[GridRenderer] Rendering ${t.length} time headers`),e.innerHTML="";const s=document.createDocumentFragment();return t.forEach(e=>{const t=document.createElement("th");t.dataset.colId=e.id;const l=e.label||"",n=e.rangeLabel||e.subLabel||"",i="monthly"===(e.generationMode||e.type||"").toLowerCase();t.className=i?"monthly":"weekly";const a=this.escapeHtml(l),r=this.escapeHtml(n),o=[`<span class="time-header__label">${a}</span>`];n&&o.push(`<span class="time-header__range">${r}</span>`),t.innerHTML=`<div class="time-header">${o.join("")}</div>`,t.title=e.tooltip||(n?`${l} ${n}`.trim():l),s.appendChild(t)}),e.appendChild(s),console.log("[GridRenderer] ✅ Time headers rendered"),e}_renderProgressChip(e){const t=this.calculateRowProgress(e);if(null===t)return"";let s="progress-chip--ok",l="On Track";return t>100.5?(s="progress-chip--over",l="Over 100%"):t<99.5&&(s="progress-chip--under",l="Under 100%"),`\n      <span class="progress-chip ${s}" title="${l}">\n        ${t.toFixed(1)}%\n      </span>\n    `}calculateRowProgress(e){if(!this.state||!Array.isArray(this.state.timeColumns)||0===this.state.timeColumns.length)return null;let t=0;return this.state.timeColumns.forEach(s=>{const{value:l}=this.getEffectiveCellValue(e,s.id),n=Number.isFinite(l)?l:parseFloat(l)||0;t+=n}),Number.isFinite(t)?parseFloat(t.toFixed(1)):null}getEffectiveCellValue(e,t,s=0){const l=`${e}-${t}`,n="number"==typeof s?s:parseFloat(s)||0;let i;if(this.state.modifiedCells instanceof Map&&this.state.modifiedCells.has(l)){const e=parseFloat(this.state.modifiedCells.get(l));Number.isFinite(e)&&(i=e)}return{value:void 0!==i?i:n,modifiedValue:i}}_getAssignmentValue(e){return this.state&&this.state.assignmentMap?this.state.assignmentMap instanceof Map||"function"==typeof this.state.assignmentMap.get?this.state.assignmentMap.get(e)||0:Object.prototype.hasOwnProperty.call(this.state.assignmentMap,e)?this.state.assignmentMap[e]:0:0}_isNodeExpanded(e){return!this.state||!this.state.expandedNodes||!1!==this.state.expandedNodes.has(e)}toggleNode(e){this.state.expandedNodes||(this.state.expandedNodes=new Set);return this.state.expandedNodes.has(e)?(this.state.expandedNodes.delete(e),console.log(`[GridRenderer] Collapsed node: ${e}`),!1):(this.state.expandedNodes.add(e),console.log(`[GridRenderer] Expanded node: ${e}`),!0)}expandNode(e){this.state.expandedNodes||(this.state.expandedNodes=new Set),this.state.expandedNodes.add(e),console.log(`[GridRenderer] Expanded node: ${e}`)}collapseNode(e){this.state.expandedNodes&&(this.state.expandedNodes.delete(e),console.log(`[GridRenderer] Collapsed node: ${e}`))}expandAll(){this.state.expandedNodes||(this.state.expandedNodes=new Set);const e=t=>{t.forEach(t=>{t&&t.id&&t.children&&t.children.length>0&&(this.state.expandedNodes.add(t.id),e(t.children))})};Array.isArray(this.state.pekerjaanTree)&&(e(this.state.pekerjaanTree),console.log(`[GridRenderer] Expanded all nodes (${this.state.expandedNodes.size} nodes)`))}collapseAll(){this.state.expandedNodes&&(this.state.expandedNodes.clear(),console.log("[GridRenderer] Collapsed all nodes"))}syncRowHeights(e){var t;if(null==(t=this.state)?void 0:t.useAgGrid)return;const s=e.leftTbody||document.getElementById("left-tbody"),l=e.rightTbody||document.getElementById("right-tbody");if(!s||!l)return;const n=s.querySelectorAll("tr"),i=l.querySelectorAll("tr");console.log(`[GridRenderer] Syncing heights for ${n.length} rows`);const a=[];n.forEach((e,t)=>{const s=i[t];if(!s)return;e.style.height="",s.style.height="";const l=e.offsetHeight,n=s.offsetHeight,r=Math.max(l,n);a.push(r)}),n.forEach((e,t)=>{const s=i[t];if(!s||!a[t])return;const l=a[t];e.style.height=`${l}px`,s.style.height=`${l}px`}),console.log("[GridRenderer] ✅ Row heights synchronized")}syncHeaderHeights(e){const t=e.leftThead||document.getElementById("left-thead"),s=e.rightThead||document.getElementById("right-thead");if(!t||!s)return void console.warn("[GridRenderer] Cannot sync header heights: missing thead elements");const l=t.querySelector("tr"),n=s.querySelector("tr");if(!l||!n)return void console.warn("[GridRenderer] Cannot sync header heights: missing tr elements");l.style.height="",n.style.height="";const i=Math.max(l.offsetHeight,n.offsetHeight);l.style.height=`${i}px`,n.style.height=`${i}px`,console.log(`[GridRenderer] Header heights synchronized: ${i}px`)}setupScrollSync(e){const t=e.leftPanelScroll||document.querySelector(".left-panel-scroll"),s=e.rightPanelScroll||document.querySelector(".right-panel-scroll");if(!t||!s)return console.warn("[GridRenderer] Cannot setup scroll sync: missing scroll containers"),null;if(this.state.cache&&this.state.cache.gridScrollSyncBound)return console.log("[GridRenderer] Scroll sync already setup"),this.state.cache.gridScrollSyncBound;const l=()=>{t.scrollTop!==s.scrollTop&&(t.scrollTop=s.scrollTop)},n=()=>{s.scrollTop!==t.scrollTop&&(s.scrollTop=t.scrollTop)};s.addEventListener("scroll",l,{passive:!0}),t.addEventListener("scroll",n,{passive:!0});const i={syncFromRight:l,syncFromLeft:n};return this.state.cache||(this.state.cache={}),this.state.cache.gridScrollSyncBound=i,console.log("[GridRenderer] ✅ Scroll sync setup complete"),i}getStats(){const e=this.state.flatPekerjaan?this.state.flatPekerjaan.length:0,t=this.state.flatPekerjaan?this.state.flatPekerjaan.filter(e=>"pekerjaan"===e.type).length:0,s=this.state.timeColumns?this.state.timeColumns.length:0;return{totalRows:e,pekerjaanRows:t,timeColumns:s,totalCells:t*s,modifiedCells:this.state.modifiedCells?this.state.modifiedCells.size:0,expandedNodes:this.state.expandedNodes?this.state.expandedNodes.size:0}}validateState(){const e=[],t=[];Array.isArray(this.state.pekerjaanTree)||e.push("Missing pekerjaanTree"),Array.isArray(this.state.timeColumns)||e.push("Missing timeColumns"),this.state.volumeMap instanceof Map||t.push("volumeMap is not a Map"),this.state.assignmentMap instanceof Map||t.push("assignmentMap is not a Map"),this.state.modifiedCells instanceof Map||t.push("modifiedCells is not a Map"),this.state.expandedNodes instanceof Set||t.push("expandedNodes is not a Set");const s=0===e.length;return s||console.error("[GridRenderer] Validation errors:",e),t.length>0&&console.warn("[GridRenderer] Validation warnings:",t),{isValid:s,errors:e,warnings:t}}}export{f as A,b as G,h as a,d as u};
//# sourceMappingURL=grid-modules-CpQo0iKu.js.map
