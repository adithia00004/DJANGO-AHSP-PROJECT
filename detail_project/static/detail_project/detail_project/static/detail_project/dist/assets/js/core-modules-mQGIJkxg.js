var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,n=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,i=(e,t,a)=>new Promise((s,n)=>{var i=e=>{try{o(a.next(e))}catch(t){n(t)}},r=e=>{try{o(a.throw(e))}catch(t){n(t)}},o=e=>e.done?s(e.value):Promise.resolve(e.value).then(i,r);o((a=a.apply(e,t)).next())});class r{constructor(){this.assignmentMap=new Map,this.modifiedCells=new Map,this.costAssignmentMap=new Map,this.costModifiedCells=new Map,this.isDirty=!1}toJSON(){return{assignmentMap:Array.from(this.assignmentMap.entries()),modifiedCells:Array.from(this.modifiedCells.entries()),costAssignmentMap:Array.from(this.costAssignmentMap.entries()),costModifiedCells:Array.from(this.costModifiedCells.entries()),isDirty:this.isDirty}}static fromJSON(e){const t=new r;return e.assignmentMap&&Array.isArray(e.assignmentMap)&&(t.assignmentMap=new Map(e.assignmentMap)),e.modifiedCells&&Array.isArray(e.modifiedCells)&&(t.modifiedCells=new Map(e.modifiedCells)),e.costAssignmentMap&&Array.isArray(e.costAssignmentMap)&&(t.costAssignmentMap=new Map(e.costAssignmentMap)),e.costModifiedCells&&Array.isArray(e.costModifiedCells)&&(t.costModifiedCells=new Map(e.costModifiedCells)),"boolean"==typeof e.isDirty&&(t.isDirty=e.isDirty),t}getStats(){return{assignmentCount:this.assignmentMap.size,modifiedCount:this.modifiedCells.size,costAssignmentCount:this.costAssignmentMap.size,costModifiedCount:this.costModifiedCells.size,isDirty:this.isDirty,hasUnsavedChanges:this.modifiedCells.size>0||this.costModifiedCells.size>0}}clear(){this.assignmentMap.clear(),this.modifiedCells.clear(),this.costAssignmentMap.clear(),this.costModifiedCells.clear(),this.isDirty=!0}clone(){const e=new r;return e.assignmentMap=new Map(this.assignmentMap),e.modifiedCells=new Map(this.modifiedCells),e.costAssignmentMap=new Map(this.costAssignmentMap),e.costModifiedCells=new Map(this.costModifiedCells),e.isDirty=this.isDirty,e}}const o="[StateManager]",l=class e{static getInstance(){return e.instance||(e.instance=new e,console.log(o,"Singleton instance created")),e.instance}constructor(){if(e.instance)throw new Error("StateManager is a singleton. Use StateManager.getInstance()");this.currentMode="planned",this.states={planned:new r,actual:new r},this._mergedCellsCache=new Map,this._listeners=new Set,this.flatPekerjaan=[],this.timeColumns=[],this._chartDataCache=new Map,this.projectId=null,console.log(o,"Initialized with dual state architecture")}getCellValue(e,t){var a,s;const n=this._getCurrentState(),i=`${e}-${t}`;return null!=(s=null!=(a=n.modifiedCells.get(i))?a:n.assignmentMap.get(i))?s:0}getAllCellsForMode(e){const t=this.states[e];if(!t)return console.error(o,`Invalid mode: ${e}`),new Map;const a=`cells:${e}`;if(this._mergedCellsCache.has(a)&&!t.isDirty)return this._mergedCellsCache.get(a);const s=new Map(t.assignmentMap);return t.modifiedCells.forEach((e,t)=>{s.set(t,e)}),this._mergedCellsCache.set(a,s),t.isDirty=!1,console.log(o,`Built merged cells for ${e.toUpperCase()}: ${s.size} cells`),s}setCellValue(e,t,a){const s=this._getCurrentState(),n=`${e}-${t}`,i=parseFloat(a);Number.isNaN(i)?console.warn(o,`Invalid value for cell ${n}:`,a):(s.modifiedCells.set(n,i),this._invalidateCache(this.currentMode),s.isDirty=!0,console.log(o,`Cell ${n} = ${i}% (${this.currentMode.toUpperCase()} mode)`))}switchMode(e){if("planned"!==e&&"actual"!==e)return void console.error(o,`Invalid mode: ${e}`);if(this.currentMode===e)return void console.log(o,`Already in ${e.toUpperCase()} mode`);const t=this.currentMode;this.currentMode=e,console.log(o,`Switched: ${t.toUpperCase()} → ${e.toUpperCase()}`),this._notifyListeners({type:"mode-switch",oldMode:t,newMode:e})}commitChanges(){const e=this._getCurrentState();e.modifiedCells.forEach((t,a)=>{e.assignmentMap.set(a,t)}),e.costModifiedCells.forEach((t,a)=>{if(null==t)return void e.costAssignmentMap.delete(a);const s=Number(t);Number.isFinite(s)&&s>=0?e.costAssignmentMap.set(a,s):e.costAssignmentMap.delete(a)});const t=e.modifiedCells.size+e.costModifiedCells.size;e.modifiedCells.clear(),e.costModifiedCells.clear(),this._invalidateCache(this.currentMode),this.invalidateChartCache(),console.log(o,`Committed ${t} changes to ${this.currentMode.toUpperCase()} assignmentMap`),this._notifyListeners({type:"commit",mode:this.currentMode,count:t})}loadData(e,t,a=new Map){const s=this.states[e];s?(s.assignmentMap=new Map(t),a instanceof Map&&(s.costAssignmentMap=new Map(a)),s.modifiedCells.clear(),s.costModifiedCells.clear(),this._invalidateCache(e),console.log(o,`Loaded ${t.size} assignments into ${e.toUpperCase()} state`)):console.error(o,`Invalid mode: ${e}`)}setFlatPekerjaan(e){this.flatPekerjaan=Array.isArray(e)?e:[],console.log(o,`Set ${this.flatPekerjaan.length} pekerjaan rows`)}getFlatPekerjaan(){return this.flatPekerjaan}setTimeColumns(e){this.timeColumns=Array.isArray(e)?e:[],console.log(o,`Set ${this.timeColumns.length} time columns`)}getTimeColumns(){return this.timeColumns}setInitialValue(e,t,a=0,s=0,n={}){var i,r;const o=`${e}-${t}`;Number.isFinite(a)&&a>0&&this.states.planned.assignmentMap.set(o,a),Number.isFinite(s)&&s>0&&this.states.actual.assignmentMap.set(o,s);const l=Object.prototype.hasOwnProperty.call(n||{},"actualCost")||Object.prototype.hasOwnProperty.call(n||{},"actual_cost")||Object.prototype.hasOwnProperty.call(n||{},"cost"),c=Number(null!=(r=null!=(i=null==n?void 0:n.actualCost)?i:null==n?void 0:n.cost)?r:null==n?void 0:n.actual_cost);Number.isFinite(c)&&c>=0?this.states.actual.costAssignmentMap.set(o,c):l&&this.states.actual.costAssignmentMap.delete(o)}addEventListener(e){"function"==typeof e?(this._listeners.add(e),console.log(o,`Added event listener (total: ${this._listeners.size})`)):console.error(o,"Event listener must be a function")}removeEventListener(e){this._listeners.delete(e)}hasUnsavedChanges(){const e=this._getCurrentState();return e.modifiedCells&&e.modifiedCells.size>0||e.costModifiedCells&&e.costModifiedCells.size>0}getStats(){return{currentMode:this.currentMode,planned:this.states.planned.getStats(),actual:this.states.actual.getStats(),cacheSize:this._mergedCellsCache.size,listenerCount:this._listeners.size}}_getCurrentState(){return this.states[this.currentMode]}_invalidateCache(e){const t=`cells:${e}`;this._mergedCellsCache.delete(t);const a=this.states[e];a&&(a.isDirty=!0)}_notifyListeners(e){this._listeners.forEach(t=>{try{t(e)}catch(a){console.error(o,"Listener error:",a)}})}reset(){this.states.planned.clear(),this.states.actual.clear(),this._mergedCellsCache.clear(),this.currentMode="planned",console.log(o,"State reset"),this._notifyListeners({type:"reset"})}fetchChartData(e="weekly",t="both"){return i(this,null,function*(){var a,s;const n=`${e}:${t}`;if(this._chartDataCache.has(n))return console.log(o,"Using cached chart data for:",n),this._chartDataCache.get(n);if(!this.projectId)return console.warn(o,"No projectId set, cannot fetch chart data"),null;try{console.log(o,"Fetching chart data from API:",n);const i=yield fetch(`/detail_project/api/v2/project/${this.projectId}/chart-data/?timescale=${e}&mode=${t}`,{method:"GET",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(!i.ok)throw new Error(`API error: ${i.status}`);const r=yield i.json();return this._chartDataCache.set(n,r),console.log(o,"Chart data fetched:",{timescale:e,columns:(null==(a=r.columns)?void 0:a.length)||0,rows:(null==(s=r.rows)?void 0:s.length)||0}),this._notifyListeners({type:"chartDataLoaded",timescale:e,mode:t,data:r}),r}catch(i){return console.error(o,"Failed to fetch chart data:",i),null}})}getChartData(e="weekly",t="both"){const a=`${e}:${t}`;return this._chartDataCache.get(a)||null}invalidateChartCache(e=null){if(e){for(const t of this._chartDataCache.keys())t.startsWith(e+":")&&this._chartDataCache.delete(t);console.log(o,"Chart cache invalidated for timescale:",e)}else this._chartDataCache.clear(),console.log(o,"All chart cache invalidated")}setProjectId(e){this.projectId=e,console.log(o,"Project ID set:",e)}exportState(){return{currentMode:this.currentMode,planned:this.states.planned.toJSON(),actual:this.states.actual.toJSON(),stats:this.getStats()}}};var c;n(l,"symbol"!=typeof(c="instance")?c+"":c,null);let d=l;"undefined"!=typeof window&&(window.StateManager=d);function h(e){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}`}class u{constructor(e){if(!e)throw new Error("[TimeColumnGenerator] State is required");this.state=e}generate(){this.state.timeColumns=[],this._projectStartCache=void 0,this._jsWeekEndDayCache=void 0;const e=this.state.timeScale||"custom",t=this.state.tahapanList||[];console.log(`[TimeColumnGenerator] Generating columns for mode: ${e}`),console.log(`[TimeColumnGenerator] Available tahapan in database: ${t.length}`),t.forEach((t,a)=>{let s=!1;if(s="custom"===e||!0===t.is_auto_generated&&t.generation_mode===e,s){const e=this._createColumn(t,a);this.state.timeColumns.push(e)}}),0===this.state.timeColumns.length&&t.length>0&&(console.warn(`[TimeColumnGenerator] No auto-generated tahapan found for mode "${e}"`),console.warn(`[TimeColumnGenerator] Showing all ${t.length} tahapan as fallback`),t.forEach((e,t)=>{const a=this._createColumn(e,t);this.state.timeColumns.push(a)})),console.log(`[TimeColumnGenerator] ✅ Generated ${this.state.timeColumns.length} time columns`);try{d.getInstance().setTimeColumns(this.state.timeColumns)}catch(a){console.warn("[TimeColumnGenerator] Could not update StateManager:",a.message)}return this.state.timeColumns}_createColumn(e,t){const a=e.tanggal_mulai?new Date(e.tanggal_mulai):null,s=e.tanggal_selesai?new Date(e.tanggal_selesai):null;let n=e.nama||`Tahap ${t+1}`,i="",r="",o=n,l=null,c="",d="";const u=Number.isInteger(e.urutan)&&e.urutan>=0?e.urutan:t,p="weekly"===(this.state.timeScale||"").toLowerCase()||"weekly"===(e.generation_mode||"").toLowerCase(),m=this._getProjectStartDate(),g=this._getJsWeekEndDay(),f=p&&a&&m?function(e,t,a={}){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return 1;if(!(t instanceof Date)||Number.isNaN(t.getTime()))return 1;if(e<=t)return 1;const s=Number.isInteger(a.weekEndDay)&&!Number.isNaN(a.weekEndDay)?(a.weekEndDay%7+7)%7:0,n=new Date(t),i=(s-t.getDay()+7)%7;if(n.setDate(n.getDate()+i),e<=n)return 1;const r=Math.floor((e-n)/864e5);return 1+Math.floor((r+6)/7)}(a,m,{weekEndDay:g}):null;if(!0===e.is_auto_generated&&"weekly"===e.generation_mode&&a&&s){l=null!=f?f:u+1,c=h(a),d=h(s),n=`Week ${l}`,i=`( ${c} - ${d} )`,r=`${c} - ${d}`;o=`Week ${l}: ${a.toLocaleDateString("id-ID",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})} - ${s.toLocaleDateString("id-ID",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})}`}else a&&s&&(c=h(a),d=h(s),i=`( ${c} - ${d} )`,r=`${c} - ${d}`);!l&&p&&(l=null!=f?f:u+1);const C=e.tahapan_id||e.id||u;return{id:`tahap-${C}`,fieldId:`col_${C}`,tahapanId:e.tahapan_id,label:n,rangeLabel:i,rangeText:r,tooltip:o,type:e.generation_mode||"custom",isAutoGenerated:e.is_auto_generated||!1,generationMode:e.generation_mode||"custom",index:u,weekNumber:l,startDate:a,endDate:s,urutan:e.urutan||t}}getColumnById(e){return this.state.timeColumns.find(t=>t.id===e)||null}getColumnByTahapanId(e){return this.state.timeColumns.find(t=>t.tahapanId===e)||null}getColumnsInRange(e,t){return this.state.timeColumns.filter(a=>!(!a.startDate||!a.endDate)&&(a.startDate<=t&&a.endDate>=e))}regenerate(){return console.log("[TimeColumnGenerator] Regenerating columns..."),this.generate()}_getProjectStartDate(){if(void 0!==this._projectStartCache)return this._projectStartCache;const e=this.state.projectStart;if(!e)return this._projectStartCache=null,this._projectStartCache;if(e instanceof Date)return this._projectStartCache=Number.isNaN(e.getTime())?null:e,this._projectStartCache;const t=new Date(e);return this._projectStartCache=Number.isNaN(t.getTime())?null:t,this._projectStartCache}_getJsWeekEndDay(){if(void 0!==this._jsWeekEndDayCache)return this._jsWeekEndDayCache;const e=Number(this.state.weekEndDay),t=Number.isFinite(e)?(e%7+7)%7:6;return this._jsWeekEndDayCache=(t+1)%7,this._jsWeekEndDayCache}}function p(e){return i(this,arguments,function*(e,i={}){const r=(i.method||"GET").toUpperCase();["POST","PUT","DELETE","PATCH"].includes(r)&&(i.headers=i.headers||{},i.headers["X-CSRFToken"]=function(e){let t=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let s=0;s<a.length;s++){const n=a[s].trim();if(n.substring(0,e.length+1)===e+"="){t=decodeURIComponent(n.substring(e.length+1));break}}}return t}("csrftoken"));const o=yield fetch(e,((e,i)=>{for(var r in i||(i={}))a.call(i,r)&&n(e,r,i[r]);if(t)for(var r of t(i))s.call(i,r)&&n(e,r,i[r]);return e})({credentials:"same-origin"},i));if(!o.ok){const e=yield o.json().catch(()=>({}));throw new Error(e.error||`HTTP ${o.status}`)}return o.json()})}function m(e,t="weekly"){if(!Array.isArray(e)||0===e.length)return t;const a={daily:0,weekly:0,monthly:0};let s=0,n=0;if(e.forEach(e=>{if(e&&e.is_auto_generated&&"string"==typeof e.generation_mode){const t=e.generation_mode.toLowerCase();a.hasOwnProperty(t)&&(a[t]+=1,s+=1)}else n+=1}),s>0){const e=Object.entries(a).reduce((e,t)=>{const[s,n]=t;return e?n>a[e]?s:e:s},"");if(e&&a[e]>0)return e}return n>0?"custom":t}function g(e,t){if(!Array.isArray(e)||0===e.length)return;if(t.expandedNodes instanceof Set||(t.expandedNodes=new Set),t.expandedNodes.size>0)return;const a=e=>{e.forEach(e=>{e&&e.id&&e.children&&e.children.length>0&&(t.expandedNodes.add(e.id),a(e.children))})};a(e)}function f(e,t=[]){return e.forEach(e=>{t.push(e),e.children&&e.children.length>0&&f(e.children,t)}),t}class C{constructor(e,t={}){if(!e)throw new Error("[DataLoader] State is required");this.state=e,this.options=t,this.projectId=e.projectId,this.stateManager=d.getInstance(),this.state.volumeMap||(this.state.volumeMap=new Map),this.state.cache||(this.state.cache={}),this.cacheTTL=t.cacheTTL||6e4,this.responseCache={tahapan:null,pekerjaan:null,volumes:null,assignments:null},this.responseCacheTimestamps={tahapan:null,pekerjaan:null,volumes:null,assignments:null},console.log("[DataLoader] Phase 0.3: Initialized with StateManager")}loadAllData(){return i(this,arguments,function*(e={}){var t,a;const{force:s=!1,skipIfLoaded:n=!1}=e;if(this.state.cache.initialLoadInProgress)return console.info("[DataLoader] loadAllData skipped (already in progress)"),null;if(!s&&this.state.cache.initialLoadCompleted&&n)return console.info("[DataLoader] loadAllData skipped (already completed)"),this.state.cache.initialLoadResult||null;this.state.cache.initialLoadInProgress=!0;try{return console.log("[DataLoader] Loading all data..."),yield Promise.all([this.loadTahapan({forceRefresh:s}),this.loadPekerjaan({forceRefresh:s}),this.loadVolumes({forceRefresh:s})]),yield this.loadAssignments({forceRefresh:s}),this.state.cache.initialLoadCompleted=!0,this.state.cache.initialLoadResult={completedAt:Date.now(),tahapanCount:(null==(t=this.state.tahapanList)?void 0:t.length)||0,pekerjaanCount:(null==(a=this.state.flatPekerjaan)?void 0:a.filter(e=>"pekerjaan"===e.type).length)||0},console.log("[DataLoader] ✅ All data loaded successfully:",this.state.cache.initialLoadResult),this.state.cache.initialLoadResult}catch(i){throw console.error("[DataLoader] ❌ Load data failed:",i),this.state.cache.initialLoadError=i,i}finally{this.state.cache.initialLoadInProgress=!1}})}loadTahapan(){return i(this,arguments,function*(e={}){const{forceRefresh:t=!1}=e;try{if(!t&&this._isCacheValid("tahapan")&&Array.isArray(this.responseCache.tahapan)){this.state.tahapanList=JSON.parse(JSON.stringify(this.responseCache.tahapan));const e=m(this.state.tahapanList,this.state.timeScale||"weekly");return this.state.timeScale=e,console.log(`[DataLoader] Using cached tahapan list (${this.state.tahapanList.length} items)`),this.state.tahapanList}const e=this.state.apiBase||`/detail_project/api/project/${this.projectId}/tahapan/`,a=yield p(e);this.state.tahapanList=(a.tahapan||a||[]).sort((e,t)=>e.urutan-t.urutan);const s=m(this.state.tahapanList,this.state.timeScale||"weekly");return this.state.timeScale=s,this._setCache("tahapan",JSON.parse(JSON.stringify(this.state.tahapanList))),console.log(`[DataLoader] ✅ Loaded ${this.state.tahapanList.length} tahapan, mode: ${s}`),this.state.tahapanList}catch(a){throw console.error("[DataLoader] ❌ Failed to load tahapan:",a),a}})}loadPekerjaan(){return i(this,arguments,function*(e={}){const{forceRefresh:t=!1}=e;try{if(!t&&this._isCacheValid("pekerjaan")&&Array.isArray(this.responseCache.pekerjaan)){const e=JSON.parse(JSON.stringify(this.responseCache.pekerjaan));return this.state.pekerjaanTree=e,this.state.flatPekerjaan=f(e),g(e,this.state),this.stateManager.setFlatPekerjaan(this.state.flatPekerjaan),console.log(`[DataLoader] Using cached pekerjaan tree (${this.state.flatPekerjaan.length} nodes)`),this.state.pekerjaanTree}const e=`/detail_project/api/project/${this.projectId}/list-pekerjaan/tree/`,a=function(e){const t=[],a=e.klasifikasi||e;return Array.isArray(a)?(a.forEach(e=>{const a={id:`klas-${e.id||e.nama}`,type:"klasifikasi",nama:e.name||e.nama||"Klasifikasi",children:[],level:0,expanded:!0},s=e.id,n=e.name||e.nama||"Klasifikasi",i=e.kode||"";e.sub&&Array.isArray(e.sub)&&e.sub.forEach(e=>{const t={id:`sub-${e.id||e.nama}`,type:"sub-klasifikasi",nama:e.name||e.nama||"Sub-Klasifikasi",children:[],level:1,expanded:!0},r=e.id,o=e.name||e.nama||"Sub-Klasifikasi",l=e.kode||"";e.pekerjaan&&Array.isArray(e.pekerjaan)&&e.pekerjaan.forEach(e=>{var a,c;const d={id:e.id||e.pekerjaan_id,type:"pekerjaan",kode:e.snapshot_kode||e.kode||"",nama:e.snapshot_uraian||e.uraian||"",volume:e.volume||0,satuan:e.snapshot_satuan||e.satuan||"-",level:2,budgeted_cost:Number.parseFloat(null!=(c=null!=(a=e.budgeted_cost)?a:e.total_cost)?c:0)||0,klasifikasi_id:s,klasifikasi_name:n,klasifikasi_kode:i,sub_klasifikasi_id:r,sub_klasifikasi_name:o,sub_klasifikasi_kode:l};t.children.push(d)}),a.children.push(t)}),t.push(a)}),t):t}(yield p(e));return this.state.pekerjaanTree=a,this.state.flatPekerjaan=f(a),g(a,this.state),this._setCache("pekerjaan",JSON.parse(JSON.stringify(a))),this.stateManager.setFlatPekerjaan(this.state.flatPekerjaan),console.log(`[DataLoader] ✅ Loaded ${this.state.flatPekerjaan.length} pekerjaan nodes`),this.state.pekerjaanTree}catch(a){throw console.error("[DataLoader] ❌ Failed to load pekerjaan:",a),a}})}loadVolumes(){return i(this,arguments,function*(e={}){const{forceRefresh:t=!1}=e;try{if(!t&&this._isCacheValid("volumes")&&Array.isArray(this.responseCache.volumes))return this.state.volumeMap.clear(),this.responseCache.volumes.forEach(([e,t])=>{this.state.volumeMap.set(e,t)}),console.log(`[DataLoader] Using cached volumes (${this.state.volumeMap.size} entries)`),this.state.volumeMap;const e=`/detail_project/api/project/${this.projectId}/volume-pekerjaan/list/`,a=yield p(e);this.state.volumeMap.clear();const s=a.items||a.volumes||a.data||[];return Array.isArray(s)&&s.forEach(e=>{const t=e.pekerjaan_id||e.id,a=parseFloat(e.quantity||e.volume||e.qty)||0;t&&this.state.volumeMap.set(t,a)}),this._setCache("volumes",Array.from(this.state.volumeMap.entries())),console.log(`[DataLoader] ✅ Loaded ${this.state.volumeMap.size} volume entries`),this.state.volumeMap}catch(a){return console.error("[DataLoader] ❌ Failed to load volumes:",a),this.state.volumeMap}})}loadAssignments(){return i(this,arguments,function*(e={}){const{forceRefresh:t=!1}=e;try{this.stateManager.states.planned.assignmentMap.clear(),this.stateManager.states.actual.assignmentMap.clear(),console.log("[DataLoader] Phase 0.3: Loading assignments (attempting API v2)...");const e=this.state.flatPekerjaan.filter(e=>"pekerjaan"===e.type);if(0===e.length)return console.info("[DataLoader] No pekerjaan nodes found for assignments"),this.state.assignmentMap;if(!t&&this._isCacheValid("assignments")&&Array.isArray(this.responseCache.assignments))return this._applyAssignmentsData(this.responseCache.assignments,{source:"cache"}),this.state.assignmentMap;const a=yield this._loadAssignmentsViaV2();return Array.isArray(a)&&a.length>0&&this._setCache("assignments",a),this.state.assignmentMap}catch(a){return console.error("[DataLoader] ❌ Failed to load assignments:",a),this.state.assignmentMap}})}reload(e){return i(this,null,function*(){const t={tahapan:()=>this.loadTahapan({forceRefresh:!0}),pekerjaan:()=>this.loadPekerjaan({forceRefresh:!0}),volumes:()=>this.loadVolumes({forceRefresh:!0}),assignments:()=>this.loadAssignments({forceRefresh:!0})}[e];if(!t)throw new Error(`[DataLoader] Unknown reload type: ${e}`);return console.log(`[DataLoader] Reloading ${e}...`),t()})}_isCacheValid(e){var t;const a=null==(t=this.responseCacheTimestamps)?void 0:t[e];return!!a&&Date.now()-a<this.cacheTTL}_setCache(e,t){this.responseCache.hasOwnProperty(e)&&(this.responseCache[e]=t,this.responseCacheTimestamps[e]=Date.now())}clearCache(e=null){if(e&&this.responseCache.hasOwnProperty(e))return this.responseCache[e]=null,this.responseCacheTimestamps[e]=null,void console.log(`[DataLoader] Cache cleared for ${e}`);this.responseCache={tahapan:null,pekerjaan:null,volumes:null,assignments:null},this.responseCacheTimestamps={tahapan:null,pekerjaan:null,volumes:null,assignments:null},console.log("[DataLoader] All caches cleared")}_buildWeekColumnIndex(){const e={};return Array.isArray(this.state.timeColumns)&&this.state.timeColumns.forEach(t=>{const a=Number(t.weekNumber||t.week_number||t.urutan);Number.isFinite(a)&&a>=1&&t.id&&(e[a]=t)}),e}_loadAssignmentsViaV2(){return i(this,null,function*(){const e=`/detail_project/api/v2/project/${this.projectId}/assignments/`,t=yield p(e);return t&&Array.isArray(t.assignments)?0===t.assignments.length?(console.info("[DataLoader] API v2 assignments empty (no progress recorded yet)"),[]):(this._applyAssignmentsData(t.assignments,{source:"api"}),t.assignments):(console.info("[DataLoader] API v2 returned no assignments array (treating as empty dataset)"),[])})}_applyAssignmentsData(e=[],{source:t="api"}={}){const a=this._buildWeekColumnIndex();let s=0;e.forEach(e=>{var t,n;const i=Number(e.pekerjaan_id||e.pekerjaanId||e.id),r=Number(e.week_number||e.weekNumber),o=parseFloat(e.planned_proportion)||0,l=parseFloat(e.actual_proportion)||0,c=null!=(n=null!=(t=e.actual_cost)?t:e.actualCost)?n:null,d=null==c?null:Number.parseFloat(c);if(!i||!r)return;const h=a[r];if(!h)return;const u=h.fieldId||h.id;if(!u)return;const p={};null!==d&&!Number.isNaN(d)&&Number.isFinite(d)&&(p.actualCost=d),this.stateManager.setInitialValue(i,u,o,l,p),s+=1});const n=this.stateManager.getStats(),i="cache"===t?"cache":"API v2";console.log(`[DataLoader] Phase 0.3: Loaded ${s} assignments via ${i}`),console.log(`[DataLoader] Planned: ${n.planned.assignmentCount} assignments`),console.log(`[DataLoader] Actual: ${n.actual.assignmentCount} assignments`)}}class y{constructor(e,t={}){if(!e)throw new Error("[SaveHandler] State is required");this.state=e,this.options=t,this.stateManager=d.getInstance(),this.apiUrl=t.apiUrl||`/detail_project/api/project/${e.projectId}/pekerjaan/assign_weekly/`,this.onSuccess=t.onSuccess||(()=>{}),this.onError=t.onError||(e=>console.error(e)),this.showToast=t.showToast||((e,t)=>console.log(`[${t}] ${e}`)),this.dataLoader=t.dataLoader||null,this.isSaving=!1,console.log("[SaveHandler] Phase 0.3: Initialized with StateManager"),console.log("[SaveHandler] API:",this.apiUrl)}save(){return i(this,null,function*(){var e,t,a,s;if(this.isSaving)return console.warn("[SaveHandler] Save already in progress"),this.showToast("Penyimpanan sedang berlangsung...","warning"),{success:!1,reason:"already_saving"};console.log("[SaveHandler] Starting save operation..."),this.isSaving=!0;try{const n=this._hasCostChanges();if(!(this.state.modifiedCells&&0!==this.state.modifiedCells.size||n))return console.warn("[SaveHandler] No modified cells to save"),this.showToast("Tidak ada perubahan untuk disimpan","info"),this.isSaving=!1,{success:!1,reason:"no_changes"};const i=this._buildPayload(),r=null!=(s=null!=(a=null==(e=i.assignments)?void 0:e.length)?a:null==(t=i.items)?void 0:t.length)?s:0;console.log(`[SaveHandler] Built payload with ${r} items`);const o=yield this._sendToServer(i);return this._handleSaveSuccess(o),this.isSaving=!1,{success:!0,result:o}}catch(n){return this._handleSaveError(n),this.isSaving=!1,{success:!1,error:n}}})}_buildPayload(){var e,t;const a=[],s=(null==(e=this.state)?void 0:e.progressMode)||"planned",n=this.stateManager.states[s],i=(null==n?void 0:n.modifiedCells)||this.state.modifiedCells||new Map,r="actual"===s&&(null==n?void 0:n.costModifiedCells)||new Map,o=new Set;i.forEach((e,t)=>o.add(t)),"actual"===s&&r instanceof Map&&r.forEach((e,t)=>o.add(t)),console.log(`[SaveHandler] Building payload from ${s.toUpperCase()} modifiedCells (cells: ${i.size}, cost: ${r.size})`),o.forEach(e=>{var t,n,o,l;const c=i.has(e)?i.get(e):void 0,[d,h]=e.split("-");if(!d||!h)return void console.warn(`[SaveHandler] Invalid cell key: ${e}`);let u=void 0===c?this._getSavedValue(e):parseFloat(c);Number.isFinite(u)||(u=0);const p=null==(t=this.state.timeColumns)?void 0:t.find(e=>{const t=e.fieldId||e.id;return(null==t?void 0:t.toString())===h.toString()}),m={pekerjaan_id:parseInt(d,10),proportion:Number(u.toFixed(2))};if(m["actual"===s?"actual_proportion":"planned_proportion"]=m.proportion,p){const e=null!=(o=null!=(n=p.tahapanId)?n:p.tahapan_id)?o:Number.isFinite(Number(p.id))?Number(p.id):null;if(e&&(m.tahapan_id=e),p.startDate&&(m.week_start=this._formatDate(p.startDate)),p.endDate&&(m.week_end=this._formatDate(p.endDate)),Number.isFinite(p.weekNumber)&&(m.week_number=p.weekNumber),!m.week_number){const e=Number.isFinite(p.index)?Number(p.index):Number.isFinite(p.order)?Number(p.order):Number.isFinite(p.urutan)?Number(p.urutan):null;null!==e&&(m.week_number=e+1)}}else{const e=parseInt(h,10);Number.isFinite(e)&&(m.tahapan_id=e)}if(!m.week_number){const e=parseInt(null!=(l=m.tahapan_id)?l:h,10);Number.isFinite(e)?m.week_number=e:m.week_number=1}if("actual"===s&&r instanceof Map&&r.has(e)){const t=Number(r.get(e));Number.isFinite(t)&&t>=0&&(m.actual_cost=Number(t.toFixed(2)))}a.push(m)}),console.log(`[SaveHandler] Built ${a.length} assignment items`),console.log(`[SaveHandler] Progress Mode: ${s.toUpperCase()} - Will save to ${"actual"===s?"actual_proportion":"planned_proportion"} field`);const l={assignments:a,mode:s,project_id:this.state.projectId,week_end_day:null!=(t=this.state.weekEndDay)?t:6};return console.log("[SaveHandler] Payload:",JSON.stringify(l,null,2)),l}_formatDate(e){return e instanceof Date||(e=new Date(e)),Number.isNaN(e.getTime())?"":e.toISOString().split("T")[0]}_sendToServer(e){return i(this,null,function*(){console.log("[SaveHandler] Sending request to:",this.apiUrl),console.log("[SaveHandler] Payload:",e);const t=function(e){let t=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let s=0;s<a.length;s++){const n=a[s].trim();if(n.substring(0,e.length+1)===e+"="){t=decodeURIComponent(n.substring(e.length+1));break}}}return t}("csrftoken"),a=yield fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":t},credentials:"same-origin",body:JSON.stringify(e)});if(!a.ok){let e={},t=null;try{t=yield a.json(),e=t||{}}catch(n){e={message:yield a.text().catch(()=>"")}}const s=e.error||e.message||`HTTP ${a.status}`,i=new Error(s);throw e.errors&&(i.details=e.errors),e.validation_errors&&(i.validationErrors=e.validation_errors),"object"==typeof e&&(i.payload=e),i}const s=yield a.json();return console.log("[SaveHandler] Server response:",s),s})}_handleSaveSuccess(e){var t,a,s,n,i;console.log("[SaveHandler] ✅ Save successful");const r=((null==(t=this.state)?void 0:t.progressMode)||"planned").toLowerCase(),o=null==(s=null==(a=this.stateManager)?void 0:a.states)?void 0:s[r],l=null!=(i=null==(n=null==o?void 0:o.modifiedCells)?void 0:n.size)?i:this.state.modifiedCells.size;this._updateAssignmentMap(),this.state.modifiedCells.clear(),this.state.cellVolumeOverrides instanceof Map&&this.state.cellVolumeOverrides.clear(),this.state.cache&&(this.state.cache.hasUnsavedChanges=!1),this.dataLoader&&"function"==typeof this.dataLoader.clearCache&&this.dataLoader.clearCache();const c=(Number(e.created_count)||0)+(Number(e.updated_count)||0),d=Number(e.saved_count)||Number(e.count)||l,h=c>0?c:d,u=`Berhasil menyimpan ${h} perubahan (${"actual"===r?"Realisasi":"Perencanaan"})`;this.showToast(u,"success"),this.showToast(u,"success"),"function"==typeof this.onSuccess&&this.onSuccess(e),console.log(`[SaveHandler] Saved ${h} assignments, cleared ${l} modified cells`)}_handleSaveError(e){console.error("[SaveHandler] ❌ Save failed:",e);const t=[];Array.isArray(e.validationErrors)&&e.validationErrors.length>0&&(e.validationErrors.slice(0,3).forEach(e=>{(null==e?void 0:e.error)&&t.push(`• ${e.error}`)}),e.validationErrors.length>3&&t.push(`(+${e.validationErrors.length-3} lagi)`)),Array.isArray(e.details)&&e.details.length>0&&(e.details.slice(0,3).forEach(e=>{(null==e?void 0:e.error)&&t.push(`• ${e.error}`)}),e.details.length>3&&t.push(`(+${e.details.length-3} lagi)`));let a=`Gagal menyimpan: ${e.message}`;t.length>0&&(a+=`\n${t.join("\n")}`),this.showToast(a,"danger",5e3),"function"==typeof this.onError&&this.onError(e)}_getCurrentModeState(){return"actual"===(this.state.progressMode||"planned")?this.state.actualState:this.state.plannedState}_updateAssignmentMap(){this.stateManager.commitChanges();const e=this.state.progressMode||"planned",t=this.stateManager.states[e].getStats();console.log(`[SaveHandler] Phase 0.3: StateManager committed changes for ${e.toUpperCase()}`),console.log(`[SaveHandler] New state: ${t.assignmentCount} assignments, ${t.modifiedCount} modified`)}_hasCostChanges(){var e;if("actual"!==((null==(e=this.state)?void 0:e.progressMode)||"planned"))return!1;const t=this.state.costModifiedCells;return t instanceof Map&&t.size>0}_getSavedValue(e){const t=this.state.assignmentMap;return t?t instanceof Map?Number(t.get(e))||0:"object"==typeof t&&null!==t&&Number(t[e])||0:0}hasUnsavedChanges(){return this.stateManager.hasUnsavedChanges()}getModifiedCount(){const e=this.state.progressMode||"planned";return this.stateManager.states[e].modifiedCells.size}validatePayload(e){const t=[],a=[],s=Array.isArray(null==e?void 0:e.assignments)?e.assignments:Array.isArray(null==e?void 0:e.items)?e.items:null;if(!s)return t.push("Invalid payload structure"),{isValid:!1,errors:t,warnings:a};0===s.length&&a.push("No items to save"),s.forEach((e,s)=>{e.pekerjaan_id||t.push(`Item ${s}: Missing pekerjaan_id`),e.week_number||a.push(`Item ${s}: Missing week_number (akan memakai default)`),void 0===e.proportion?t.push(`Item ${s}: Missing proportion value`):Number.isFinite(e.proportion)?(e.proportion<0||e.proportion>100)&&a.push(`Item ${s}: Proportion out of range (${e.proportion}%)`):t.push(`Item ${s}: Invalid proportion value`)});const n=0===t.length;return n||console.error("[SaveHandler] Payload validation failed:",t),a.length>0&&console.warn("[SaveHandler] Payload validation warnings:",a),{isValid:n,errors:t,warnings:a}}cancel(){this.isSaving&&(console.log("[SaveHandler] Cancelling save operation..."),this.isSaving=!1)}getStats(){return{modifiedCells:this.getModifiedCount(),isSaving:this.isSaving,hasUnsavedChanges:this.hasUnsavedChanges(),apiUrl:this.apiUrl}}}export{C as D,d as S,u as T,y as a};
