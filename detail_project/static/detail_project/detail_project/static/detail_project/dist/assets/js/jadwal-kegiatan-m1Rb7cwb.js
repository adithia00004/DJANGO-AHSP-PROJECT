const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/chart-modules-C7fXYRml.js","assets/js/core-modules-BVA9karD.js","assets/chart-modules-Saz_VHki.css"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,o=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,r=(e,t)=>{for(var a in t||(t={}))n.call(t,a)&&o(e,a,t[a]);if(s)for(var a of s(t))i.call(t,a)&&o(e,a,t[a]);return e},l=(e,s)=>t(e,a(s)),d=(e,t,a)=>new Promise((s,n)=>{var i=e=>{try{r(a.next(e))}catch(t){n(t)}},o=e=>{try{r(a.throw(e))}catch(t){n(t)}},r=e=>e.done?s(e.value):Promise.resolve(e.value).then(i,o);r((a=a.apply(e,t)).next())});import{_ as h}from"./vendor-export-CxtsESY6.js";import{T as c}from"./grid-modules-BShDKBX5.js";import{G as u,b as g,K as p,T as m,i as v,B as y}from"./chart-modules-C7fXYRml.js";import{S as f,D as w,T as _,a as b}from"./core-modules-BVA9karD.js";class k{constructor(e,t={}){var a,s,n,i,o;this.tableManager=e,this.debug=Boolean((null==(s=null==(a=this.tableManager)?void 0:a.options)?void 0:s.debugUnifiedTable)||(null==(i=null==(n=this.tableManager)?void 0:n.state)?void 0:i.debugUnifiedTable)||window.DEBUG_UNIFIED_TABLE),this._missingColumnLog=new Set,this.scrollLeft=0,this._syncScheduled=!1,this.pinnedWidth=0,this.mode="progress",this.projectId=t.projectId||null,this.canvas=document.createElement("canvas"),this.canvas.className="kurva-s-canvas-overlay",this.canvas.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      pointer-events: auto;\n      z-index: 10;\n    ",this.ctx=this.canvas.getContext("2d"),this.yAxisContainer=document.createElement("div"),this.yAxisContainer.className="kurva-s-yaxis-overlay",this.yAxisContainer.style.cssText="\n      position: absolute;\n      top: 0;\n      right: 0;\n      width: 80px;\n      pointer-events: none;\n      z-index: 11;\n      display: none;\n    ",this.visible=!1,this.curveData={planned:[],actual:[]},this.legendElement=null,this.curvePoints=[],this.tooltip=null;const r=null==(o=this.tableManager)?void 0:o.bodyScroll;r&&r.addEventListener("scroll",()=>{this.visible&&(this._updateTransform(),this._syncScheduled||(this._syncScheduled=!0,requestAnimationFrame(()=>{this._syncScheduled=!1,this.visible&&this.syncWithTable()})))},{passive:!0}),this._bindPointerEvents()}show(){var e;if(this.visible)return;const t=null==(e=this.tableManager)?void 0:e.bodyScroll;t&&(t.style.position=t.style.position||"relative",this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),t.appendChild(this.canvas),this.canvas.style.display="block",this.yAxisContainer.parentNode&&this.yAxisContainer.parentNode.removeChild(this.yAxisContainer),t.appendChild(this.yAxisContainer),this.yAxisContainer.style.display="block",this.visible=!0,this._log("show",{overlay:!0}),this._showLegend(),this._renderWithRetry())}hide(){var e;this.visible&&(this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),(null==(e=this.yAxisContainer)?void 0:e.parentNode)&&this.yAxisContainer.parentNode.removeChild(this.yAxisContainer),this.visible=!1,this._log("hide"),this._hideLegend())}syncWithTable(){var e;const t=null==(e=this.tableManager)?void 0:e.bodyScroll;if(!t)return void this._log("warn-no-scroll-area",{message:"No scrollArea found"});this.pinnedWidth=this._getPinnedWidth(t),this.scrollLeft=t.scrollLeft||0;const a=t.clientWidth-this.pinnedWidth,s=Math.max(100,Math.min(a,32e3)),n=Math.max(100,Math.min(t.clientHeight,16e3));this.canvas.width=s,this.canvas.height=n,this.canvas.style.width=`${s}px`,this.canvas.style.height=`${n}px`;const i=n,o=this.scrollLeft+t.clientWidth-80,r=t.scrollTop||0;if(this.yAxisContainer&&(this.yAxisContainer.style.width="80px",this.yAxisContainer.style.height=`${i}px`,this.yAxisContainer.style.left=`${o}px`,this.yAxisContainer.style.top=`${r}px`,this.yAxisContainer.style.display=this.visible?"block":"none"),this.canvas.style.position="absolute",this.canvas.style.left=`${this.pinnedWidth}px`,this.canvas.style.top="0px",this.canvas.style.transform=`translateX(${this.scrollLeft}px)`,this.canvas.style.pointerEvents="auto",this.canvas.style.zIndex="10",this.yAxisContainer){const e=80,a=n,s=this.scrollLeft+t.clientWidth-e,i=t.scrollTop||0;this.yAxisContainer.style.width=`${e}px`,this.yAxisContainer.style.height=`${a}px`,this.yAxisContainer.style.left=`${s}px`,this.yAxisContainer.style.top=`${i}px`,this.yAxisContainer.style.display=this.visible?"block":"none"}this._log("canvas-sizing",{viewportWidth:a,pinnedWidth:this.pinnedWidth,canvasWidth:s,canvasHeight:n,scrollLeft:this.scrollLeft,transform:this.canvas.style.transform,left:this.canvas.style.left});const l="function"==typeof this.tableManager.getCellBoundingRects?this.tableManager.getCellBoundingRects():[];this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.curvePoints=[],this._log("sync-debug",{canvasSize:{w:this.canvas.width,h:this.canvas.height},scrollAreaSize:{w:t.scrollWidth,h:t.scrollHeight},visibleSize:{w:t.clientWidth,h:t.clientHeight},scroll:{left:t.scrollLeft,top:t.scrollTop},cellRects:l.length,plannedPoints:this.curveData.planned.length,actualPoints:this.curveData.actual.length,canvasVisible:this.visible,canvasParent:this.canvas.parentNode?"attached":"detached"}),this._log("sync",{cells:l.length,plannedPoints:this.curveData.planned.length,actualPoints:this.curveData.actual.length,size:{w:this.canvas.width,h:this.canvas.height}}),0!==l.length?(this._drawCurve(l,this.curveData.planned,this._getPlannedColor(),"Planned"),this._drawCurve(l,this.curveData.actual,this._getActualColor(),"Actual"),this._drawYAxisLabels(n)):this._log("warn-no-cell-rects",{message:"No cell rects available for plotting"})}_getPinnedWidth(e){var t,a;const s=null==(a=null==(t=this.tableManager)?void 0:t.getPinnedColumnsWidth)?void 0:a.call(t);if(s&&s>0)return s;let n=0;const i=null==e?void 0:e.previousElementSibling;if(i){i.querySelectorAll('th[data-pinned="left"], td[data-pinned="left"]').forEach(e=>{n+=e.offsetWidth||0})}return n}_updateTransform(){var e;const t=null==(e=this.tableManager)?void 0:e.bodyScroll;t&&(this.scrollLeft=t.scrollLeft||0,this.canvas.style.transform=`translateX(${this.scrollLeft}px)`)}setMode(e){return d(this,null,function*(){"progress"===e||"cost"===e?(this.mode=e,this._log("mode-changed",{mode:e}),"cost"===this.mode?yield this._loadCostMode():yield this._loadProgressMode()):console.error("[KurvaSOverlay] Invalid mode:",e)})}_loadCostMode(){return d(this,null,function*(){if(this.projectId)try{const e=yield fetch(`/detail_project/api/v2/project/${this.projectId}/kurva-s-harga/`,{credentials:"include"});if(!e.ok)throw new Error(`API error: ${e.status}`);const t=yield e.json();this._log("cost-data-loaded",t);const{buildCostDataset:a}=yield h(()=>d(this,null,function*(){const{buildCostDataset:e}=yield import("./chart-modules-C7fXYRml.js").then(e=>e.d);return{buildCostDataset:e}}),__vite__mapDeps([0,1,2])),s=a(t);if(!s)return void console.error("[KurvaSOverlay] Failed to build cost dataset");const n={planned:this._convertDatasetSeriesToCurvePoints(s,"planned"),actual:this._convertDatasetSeriesToCurvePoints(s,"actual")};this.renderCurve(n)}catch(e){console.error("[KurvaSOverlay] Failed to load cost mode:",e)}else console.error("[KurvaSOverlay] Cannot load cost mode: no projectId")})}_loadProgressMode(){return d(this,null,function*(){var e;"function"==typeof(null==(e=this.tableManager)?void 0:e.updateCurvaS)?this.tableManager.updateCurvaS():this._log("warn-update-curvas-missing",{message:"updateCurvaS not available"})})}_convertDatasetSeriesToCurvePoints(e,t){const a=e[t]||[],s=e.labels||[],n=e.details||[];return a.map((e,a)=>{var i,o,r,l,d,h,c,u,g;const p=n[a]||{},m=s[a]||`Week ${a+1}`,v=(null==(i=null==p?void 0:p.metadata)?void 0:i.id)||(null==(o=null==p?void 0:p.metadata)?void 0:o.fieldId)||(null==(r=null==p?void 0:p.metadata)?void 0:r.columnId)||(null==p?void 0:p.weekNumber)||(null==(l=m.match(/W(\d+)/))?void 0:l[1])||`week_${a+1}`;return{columnId:String(v),weekNumber:(null==p?void 0:p.weekNumber)||(null==(d=null==p?void 0:p.metadata)?void 0:d.weekNumber)||a+1,weekProgress:Number("planned"===t?null!=(c=null!=(h=p.planned)?h:p.plannedPercent)?c:e:null!=(g=null!=(u=p.actual)?u:p.actualPercent)?g:e)||0,cumulativeProgress:Number(e)||0,label:m}})}renderCurve(e){this.curveData={planned:Array.isArray(e.planned)?e.planned:[],actual:Array.isArray(e.actual)?e.actual:[]},this._log("renderCurve",{plannedPoints:this.curveData.planned.length,actualPoints:this.curveData.actual.length}),this.visible&&this.syncWithTable()}_drawCurve(e,t,a,s){if(!Array.isArray(t)||0===t.length)return void this._log(`_drawCurve:${s}`,{info:"No dataPoints"});const n=this._mapDataToCanvasPoints(e,t);0!==n.length?(this._log(`_drawCurve:${s}`,{points:n.length,sample:n[0]}),this.ctx.strokeStyle=a,this.ctx.lineWidth=3,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),n.forEach((e,t)=>{0===t?this.ctx.moveTo(e.x,e.y):this.ctx.lineTo(e.x,e.y)}),this.ctx.stroke(),this.ctx.fillStyle=a,n.forEach(e=>{this.ctx.beginPath(),this.ctx.arc(e.x,e.y,6,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#ffffff",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,2.5,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=a,e.color=a,e.label=s}),this.curvePoints||(this.curvePoints=[]),this.curvePoints.push(...n)):this._log(`_drawCurve:${s}`,{error:"No points mapped"})}_mapDataToCanvasPoints(e,t){var a;const s=[],n=null==(a=this.tableManager)?void 0:a.bodyScroll,i=n?n.clientHeight:this.canvas.height,o=i-40;this._log("_mapDataToCanvasPoints",{canvasHeight:this.canvas.height,viewportHeight:i,y0percent:o,y100percent:40,dataPoints:t.length,cellRects:e.length});const r=this._getWeekGridLines(e);if(e.length>0&&t.length>0){if(e.reduce((e,t)=>!e||t.x<e.x?t:e,null)){const e=-this.scrollLeft,t=this._interpolateY(0,o,40);s.push({x:e,y:t,columnId:"week_0",progress:0,weekNumber:0,weekProgress:0})}}return t.forEach(e=>{const t=e.columnId||e.weekId||e.week,a=Number.isFinite(e.cumulativeProgress)?e.cumulativeProgress:e.progress||0,n=r.get(String(t));if(!n)return void(this.debug&&!this._missingColumnLog.has(String(t))&&(this._missingColumnLog.add(String(t)),this._log("skip-missing-column",{columnId:t,availableColumns:r.size})));const i=this._interpolateY(a,o,40);s.push({x:n,y:i,columnId:t,progress:a,weekNumber:e.weekNumber,weekProgress:e.weekProgress})}),s}_getWeekGridLines(e){const t=new Map;return e.forEach(e=>{const a=String(e.columnId);if(!t.has(a)){const s=e.x+e.width-this.pinnedWidth-this.scrollLeft;t.set(a,s)}}),this._log("grid-lines",{sample:Array.from(t.entries()).slice(0,3),pinnedWidth:this.pinnedWidth,scrollLeft:this.scrollLeft}),t}_interpolateY(e,t,a){return t-Math.max(0,Math.min(100,e))/100*(t-a)}_renderWithRetry(e=1,t=3){var a;if(!this.visible)return;const s="function"==typeof(null==(a=this.tableManager)?void 0:a.getCellBoundingRects)?this.tableManager.getCellBoundingRects():[],n=this.canvas.width>0&&this.canvas.height>0,i=Array.isArray(s)&&s.length>0;n&&i?this.syncWithTable():e<t?requestAnimationFrame(()=>this._renderWithRetry(e+1,t)):this._log("render-retry-exhausted",{hasSize:n,hasCells:i})}_drawYAxisLabels(e){if(!this.yAxisContainer)return;this.yAxisContainer.innerHTML="";const t=e-40,a=document.createElement("div");a.style.position="absolute",a.style.inset="0",a.style.background="rgba(255, 255, 255, 0.9)",a.style.borderLeft="1px solid #dee2e6",this.yAxisContainer.appendChild(a);[0,20,40,60,80,100].forEach(e=>{const a=this._interpolateY(e,t,40),s=document.createElement("div");s.style.position="absolute",s.style.left="0",s.style.top=`${a}px`,s.style.width="100%",s.style.height="1px",s.style.borderTop="1px solid #dee2e6",this.yAxisContainer.appendChild(s);const n=document.createElement("div");n.textContent=`${e}%`,n.style.position="absolute",n.style.left="10px",n.style.top=a-6+"px",n.style.font='11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',n.style.color="#495057",n.style.lineHeight="12px",this.yAxisContainer.appendChild(n)})}_showLegend(){if(this.legendElement)return this.legendElement.style.display="flex",void this._updateLegendColors();const e=this._isDarkMode();this.legendElement=document.createElement("div"),this.legendElement.className="kurva-s-legend",this.legendElement.style.cssText=`\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      background: ${e?"rgba(30, 30, 30, 0.95)":"rgba(255, 255, 255, 0.95)"};\n      border: 1px solid ${e?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.1)"};\n      border-radius: 8px;\n      padding: 8px 12px;\n      font-size: 13px;\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, ${e?"0.5":"0.15"});\n      z-index: 25;\n      pointer-events: none;\n      display: flex;\n      gap: 16px;\n      align-items: center;\n    `;const t=this._getPlannedColor(),a=this._getActualColor(),s=e?"#e5e7eb":"#374151";this.legendElement.innerHTML=`\n      <div style="display: flex; align-items: center; gap: 6px;">\n        <div style="width: 24px; height: 4px; background: ${t}; border-radius: 2px;"></div>\n        <span style="color: ${s}; font-weight: 500;">Planned</span>\n      </div>\n      <div style="display: flex; align-items: center; gap: 6px;">\n        <div style="width: 24px; height: 4px; background: ${a}; border-radius: 2px;"></div>\n        <span style="color: ${s}; font-weight: 500;">Actual</span>\n      </div>\n    `,document.body.appendChild(this.legendElement)}_updateLegendColors(){if(!this.legendElement)return;const e=this._isDarkMode();this.legendElement.style.background=e?"rgba(30, 30, 30, 0.95)":"rgba(255, 255, 255, 0.95)",this.legendElement.style.borderColor=e?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.1)",this.legendElement.style.boxShadow=`0 4px 12px rgba(0, 0, 0, ${e?"0.5":"0.15"})`;const t=e?"#e5e7eb":"#374151";this.legendElement.querySelectorAll("span").forEach(e=>e.style.color=t)}_isDarkMode(){const e=document.body.classList;return!(!e.contains("dark-mode")&&!e.contains("dark"))||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches}_hideLegend(){this.legendElement&&(this.legendElement.style.display="none")}_getPlannedColor(){return"#0dcaf0"}_getActualColor(){return"#ffc107"}_getCssVar(e){try{const t=document.documentElement,a=getComputedStyle(t).getPropertyValue(e);return a&&a.trim().length?a.trim():null}catch(t){return null}}_getBtnColor(e){var t,a,s;try{const n=document.querySelector(e);if(!n)return null;const i=getComputedStyle(n);return(null==(t=i.getPropertyValue("background-color"))?void 0:t.trim())||(null==(a=i.getPropertyValue("border-color"))?void 0:a.trim())||(null==(s=i.getPropertyValue("color"))?void 0:s.trim())||null}catch(n){return null}}_bindPointerEvents(){this.canvas.addEventListener("mousemove",e=>{if(!this.visible||!this.curvePoints||0===this.curvePoints.length)return;const t=this.canvas.getBoundingClientRect(),a=e.clientX-t.left,s=e.clientY-t.top,n=this._hitTestPoint(a,s,10);n?(this._showTooltip(e.clientX,e.clientY,n),this.canvas.style.cursor="pointer"):(this._hideTooltip(),this.canvas.style.cursor="default")}),this.canvas.addEventListener("mouseleave",()=>{this._hideTooltip(),this.canvas.style.cursor="default"})}_hitTestPoint(e,t,a){if(!this.curvePoints)return null;for(const s of this.curvePoints){const n=s.x-e,i=s.y-t;if(Math.sqrt(n*n+i*i)<=a)return s}return null}_ensureTooltip(){return this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.className="kurvas-overlay-tooltip",this.tooltip.style.cssText="\n      position: fixed;\n      padding: 8px 12px;\n      background: rgba(17, 24, 39, 0.95);\n      color: #f8fafc;\n      border-radius: 6px;\n      font-size: 12px;\n      pointer-events: none;\n      z-index: 30;\n      display: none;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n      line-height: 1.5;\n    ",document.body.appendChild(this.tooltip)),this.tooltip}_showTooltip(e,t,a){const s=this._ensureTooltip(),n=a.weekNumber?`Week ${a.weekNumber}`:a.columnId,i=Number.isFinite(a.progress)?`${a.progress.toFixed(1)}%`:"-",o=Number.isFinite(a.weekProgress)?`${a.weekProgress.toFixed(1)}%`:"-";s.innerHTML=`\n      <div style="font-weight: 600; margin-bottom: 4px; color: ${a.color};">${a.label}</div>\n      <div><strong>${n}</strong></div>\n      <div>Cumulative: ${i}</div>\n      <div>Week Progress: ${o}</div>\n    `,s.style.left=`${e+12}px`,s.style.top=`${t+12}px`,s.style.display="block"}_hideTooltip(){this.tooltip&&(this.tooltip.style.display="none")}_log(e,t){this.debug&&console.log(`[KurvaSOverlay] ${e}`,t||{})}}class C{constructor(e,t={}){var a,s;this.state=e||{},this.options=t,this.currentMode="grid",this.debug=Boolean((null==(a=this.state)?void 0:a.debugUnifiedTable)||(null==(s=this.options)?void 0:s.debugUnifiedTable)),this.tanstackGrid=null,this.overlays={gantt:null,kurva:null}}mount(e,t={}){this.tanstackGrid=new c(this.state,this.options),this.tanstackGrid.mount(e,t),this.tanstackGrid.setCellRenderer("input"),this._log("mount",{containerMounted:Boolean(e),debug:this.debug})}updateData(e){var t,a,s,n,i;this.tanstackGrid&&(this._log("updateData",{rows:(null==(t=null==e?void 0:e.tree)?void 0:t.length)||(null==(a=this.tanstackGrid.currentRows)?void 0:a.length)||0,cols:(null==(s=null==e?void 0:e.timeColumns)?void 0:s.length)||(null==(n=this.tanstackGrid.currentColumns)?void 0:n.length)||0,deps:(null==(i=null==e?void 0:e.dependencies)?void 0:i.length)||0}),this.tanstackGrid.updateData(e),this._refreshGanttOverlay(e),this._refreshKurvaSOverlay(e))}switchMode(e){var t,a,s,n,i,o;if(!e||e===this.currentMode||!this.tanstackGrid)return;const r=this.currentMode,l={grid:"input",gantt:"gantt",kurva:"readonly"}[e]||"input";if("gantt"===this.currentMode&&this.overlays.gantt&&this.overlays.gantt.hide(),"kurva"===this.currentMode&&this.overlays.kurva&&(null==(a=(t=this.overlays.kurva).hide)||a.call(t)),this.currentMode=e,this._log("switchMode",{from:r,to:e,renderer:l,rows:(null==(s=this.tanstackGrid.currentRows)?void 0:s.length)||0,cols:(null==(n=this.tanstackGrid.currentColumns)?void 0:n.length)||0}),this.tanstackGrid.setCellRenderer(l),"gantt"===e&&(this.overlays.gantt||(this.overlays.gantt=new u(this.tanstackGrid)),this.overlays.gantt.show(),this._refreshGanttOverlay()),"kurva"===e){if(!this.overlays.kurva){const e=(null==(i=this.state)?void 0:i.projectId)||(null==(o=this.options)?void 0:o.projectId)||null;this.overlays.kurva=new k(this.tanstackGrid,{projectId:e})}this.overlays.kurva.show(),this._refreshKurvaSOverlay()}}_refreshGanttOverlay(e={}){if(!this.overlays.gantt||!this.tanstackGrid)return;const t=this._buildBarData(e),a=e.dependencies||[];this._log("refreshGanttOverlay",{bars:t.length,deps:a.length}),this.overlays.gantt.renderBars(t),this.overlays.gantt.renderDependencies(a)}_buildBarData(e={}){var t,a,s,n,i,o,r,l,d,h,c,u;let g=Array.isArray(e.tree)?e.tree:[],p=Array.isArray(e.timeColumns)?e.timeColumns:[];const m=(null==(t=this.tanstackGrid)?void 0:t.currentRows)||[],v=(null==(a=this.tanstackGrid)?void 0:a.currentColumns)||[],y=Array.isArray(null==(s=this.state)?void 0:s.flatPekerjaan)?this.state.flatPekerjaan:[];(!g.length||g.length<=1)&&m.length>g.length&&(g=m),(!g.length||g.length<=1)&&y.length&&(g=y.map(e=>({pekerjaanId:e.id||e.pekerjaan_id,name:e.nama||e.name,raw:e,subRows:[]})));const f=p.some(e=>{var t;return null==(t=null==e?void 0:e.meta)?void 0:t.timeColumn});p.length&&f||!v.length||(p=v),!p.length&&Array.isArray(null==(n=this.state)?void 0:n.timeColumns)&&(p=this.state.timeColumns.map(e=>({id:e.id,fieldId:e.fieldId,meta:{timeColumn:!0,columnMeta:e}})));const w=[],_=(null==(i=this.state)?void 0:i.stateManager)||(null==(o=this.state)?void 0:o.stateManagerInstance)||(null==(r=this.options)?void 0:r.stateManager),b="function"==typeof(null==_?void 0:_.getAllCellsForMode)?_.getAllCellsForMode("planned"):this._mergeModeState(null==(l=null==_?void 0:_.states)?void 0:l.planned),k="function"==typeof(null==_?void 0:_.getAllCellsForMode)?_.getAllCellsForMode("actual"):this._mergeModeState(null==(d=null==_?void 0:_.states)?void 0:d.actual),C=((null==(h=this.state)?void 0:h.progressMode)||(null==_?void 0:_.currentMode)||"planned").toLowerCase();console.log("[UnifiedTable] ðŸ” BuildBarData DEBUG:",{rows:g.length,cols:p.length,plannedSize:(null==b?void 0:b.size)||0,actualSize:(null==k?void 0:k.size)||0,activeMode:C,samplePlannedKeys:b?Array.from(b.keys()).slice(0,5):[],sampleActualKeys:k?Array.from(k.keys()).slice(0,5):[],samplePlannedValues:b?Array.from(b.entries()).slice(0,3):[],sampleActualValues:k?Array.from(k.entries()).slice(0,3):[]}),this._log("buildBarData:start",{rows:g.length,cols:p.length,plannedSize:(null==b?void 0:b.size)||0,actualSize:(null==k?void 0:k.size)||0,activeMode:C,timeColumnsWithMeta:p.filter(e=>{var t;return null==(t=e.meta)?void 0:t.timeColumn}).length,sampleColumns:p.slice(0,5).map(e=>{var t,a,s,n;return e.fieldId||e.id||(null==(a=null==(t=e.meta)?void 0:t.columnMeta)?void 0:a.fieldId)||(null==(n=null==(s=e.meta)?void 0:s.columnMeta)?void 0:n.id)}),sampleRows:g.slice(0,3).map(e=>{var t;return e.pekerjaanId||e.id||(null==(t=e.raw)?void 0:t.pekerjaan_id)})});const S=this._flattenRows(g),M=new Map;S.forEach(e=>{var t,a;const s=e.pekerjaanId||e.id||(null==(t=e.raw)?void 0:t.pekerjaan_id);s&&M.set(String(s),{label:e.name||(null==(a=e.raw)?void 0:a.nama)||s})});const T=new Map;p.forEach(e=>{const t=this._resolveColumnMeta(e);if(!(null==t?void 0:t.timeColumn))return;const a=e.fieldId||e.id||t.fieldId||t.id||t.columnId||t.column_id;a&&T.set(String(a),t)});return new Set([...Array.from((null==(c=null==b?void 0:b.keys)?void 0:c.call(b))||[]),...Array.from((null==(u=null==k?void 0:k.keys)?void 0:u.call(k))||[])]).forEach(e=>{const[t,a]=String(e).split("-"),s=String(t||"").trim(),n=String(a||"").trim();if(!s||!n)return;const i=M.get(s),o=T.get(n);if(!i||!o)return;const r=this._resolveValue(b,e,0),l=this._resolveValue(k,e,r);if(!Number.isFinite(r)&&!Number.isFinite(l))return;const d=(Number(l)||0)-(Number(r)||0);w.push({pekerjaanId:s,columnId:n,value:Number(l)||0,planned:Number(r)||0,actual:Number(l)||0,variance:d,label:i.label,color:"#4dabf7"})}),0===w.length&&((null==b?void 0:b.size)>0||(null==k?void 0:k.size)>0)&&(console.warn("[UnifiedTable] âš ï¸ NO BAR DATA despite having cell values! Check:",{"mergedPlanned.size":(null==b?void 0:b.size)||0,"mergedActual.size":(null==k?void 0:k.size)||0,"tree.length":g.length,"columns.length":p.length,timeColumnsWithMeta:p.filter(e=>{var t;return null==(t=e.meta)?void 0:t.timeColumn}).length}),this._log("buildBarData:debug",{plannedKeys:b?Array.from(b.keys()).slice(0,5):[],actualKeys:k?Array.from(k.keys()).slice(0,5):[],columnIds:p.map(e=>{var t,a,s,n,i,o;return e.fieldId||e.id||(null==(a=null==(t=e.meta)?void 0:t.columnMeta)?void 0:a.fieldId)||(null==(n=null==(s=e.meta)?void 0:s.columnMeta)?void 0:n.id)||(null==(i=e.meta)?void 0:i.columnId)||(null==(o=e.meta)?void 0:o.column_id)||e.id}).slice(0,5)})),this._log("buildBarData:done",{bars:w.length}),w}_flattenRows(e=[]){const t=[],a=Array.isArray(e)?[...e]:[];for(;a.length;){const e=a.shift();e&&(t.push(e),Array.isArray(e.subRows)&&e.subRows.length?a.push(...e.subRows):Array.isArray(e.children)&&e.children.length?a.push(...e.children):Array.isArray(e.sub)&&e.sub.length&&a.push(...e.sub))}return t}_resolveColumnMeta(e){var t,a,s;if(!e)return null;if((null==(t=e.meta)?void 0:t.columnMeta)&&(null==(a=e.meta)?void 0:a.timeColumn))return l(r({},e.meta.columnMeta),{timeColumn:!0});if(null==(s=e.meta)?void 0:s.timeColumn)return l(r({},e.meta.columnMeta||e.meta),{timeColumn:!0});const n=(e.generationMode||e.type||"").toLowerCase();return"weekly"===n||"monthly"===n||Boolean(e.rangeLabel||e.weekNumber)?l(r({},e),{timeColumn:!0,columnMeta:e}):null}_mergeModeState(e){if(!e)return new Map;const t=new Map(e.assignmentMap||[]);return(e.modifiedCells||new Map).forEach((e,a)=>{t.set(a,e)}),t}_resolveValue(e,t,a){if(e&&e.has&&e.has(t)){const a=e.get(t);if(Number.isFinite(a))return a}return a}_refreshKurvaSOverlay(e={}){if(!this.overlays.kurva||!this.tanstackGrid)return;const t=this._buildCurveData(e);this._log("refreshKurvaSOverlay",{plannedPoints:t.planned.length,actualPoints:t.actual.length}),this.overlays.kurva.renderCurve(t)}updateCurvaS(e={}){this._refreshKurvaSOverlay(e)}setKurvaMode(e){return d(this,null,function*(){this.overlays.kurva?(this._log("setKurvaMode",{mode:e}),yield this.overlays.kurva.setMode(e)):console.warn("[UnifiedTable] Cannot set Kurva mode: overlay not initialized")})}_buildCurveData(e={}){var t,a,s,n,i,o,r;let l=Array.isArray(e.timeColumns)?e.timeColumns:[];const d=(null==(t=this.tanstackGrid)?void 0:t.currentColumns)||[];!l.length&&d.length&&(l=d),!l.length&&Array.isArray(null==(a=this.state)?void 0:a.timeColumns)&&(l=this.state.timeColumns);const h=l.filter(e=>{const t=this._resolveColumnMeta(e);return null==t?void 0:t.timeColumn});if(0===h.length)return this._log("buildCurveData:noTimeColumns",{columnsTotal:l.length}),{planned:[],actual:[]};const c={timeColumns:h,stateManager:(null==(s=this.state)?void 0:s.stateManager)||(null==(n=this.state)?void 0:n.stateManagerInstance)||(null==(i=this.options)?void 0:i.stateManager),tree:(null==(o=this.state)?void 0:o.tree)||(null==e?void 0:e.tree)||[],totalBiayaProject:(null==(r=this.state)?void 0:r.totalBiayaProject)||(null==e?void 0:e.totalBiayaProject)||0};this._log("buildCurveData:state",{timeColumns:h.length,tree:c.tree.length,totalBiaya:c.totalBiayaProject});const u=g(c);if(!u)return this._log("buildCurveData:noDataset",{state:c}),{planned:[],actual:[]};const p=this._convertDatasetToCurvePoints(u,"planned"),m=this._convertDatasetToCurvePoints(u,"actual");return this._log("buildCurveData:result",{plannedPoints:p.length,actualPoints:m.length,useHargaCalculation:u.useHargaCalculation,totalBiaya:u.totalBiaya,totalVolume:u.totalVolume}),{planned:p,actual:m}}_convertDatasetToCurvePoints(e,t){const a=e[t]||[],s=e.labels||[],n=e.details||[];return a.map((e,a)=>{var i,o,r;const l=n[a]||{},d=s[a]||`Week ${a+1}`,h=(null==(i=null==l?void 0:l.metadata)?void 0:i.id)||(null==(o=null==l?void 0:l.metadata)?void 0:o.fieldId)||(null==(r=null==l?void 0:l.metadata)?void 0:r.columnId)||`week_${a+1}`;return{columnId:String(h),weekNumber:a+1,weekProgress:"planned"===t?l.planned:l.actual,cumulativeProgress:e,label:d}})}_log(e,t){(this.debug||Boolean(window.DEBUG_UNIFIED_TABLE))&&console.log(`[UnifiedTable] ${e}`,t)}}class S{constructor(e=null){this.stateManager=e||f.getInstance()}buildState(e={},t=null,a={}){const s="function"==typeof a.createTimeColumnIndex?a.createTimeColumnIndex:()=>({}),n=Object.assign({pekerjaanTree:[],timeColumns:[],tahapanList:[],timeColumnIndex:{},expandedNodes:new Set,volumeMap:new Map,isLoading:!1,error:null,domRefs:{},apiEndpoints:{},projectId:null,projectName:"",projectStart:null,projectEnd:null,useUPlotKurva:!0,timeScale:"weekly",inputMode:"percentage",saveMode:"weekly",weekStartDay:0,weekEndDay:6,displayScale:null,progressMode:"planned",displayMode:"percentage",useUnifiedTable:!e.disableUnifiedTable,keepLegacyGantt:!!e.enableLegacyGantt,dependencies:[],debugUnifiedTable:Boolean(e.debugUnifiedTable||window.DEBUG_UNIFIED_TABLE),stateManager:this.stateManager,plannedState:{progressTotals:new Map,volumeTotals:new Map,cellVolumeOverrides:new Map,cellValidationMap:new Map,failedRows:new Set,autoWarningRows:new Set,volumeWarningRows:new Set,validationWarningRows:new Set,saveErrorRows:new Set,apiFailedRows:new Set,showCompletionWarnings:!1,isDirty:!1},actualState:{progressTotals:new Map,volumeTotals:new Map,cellVolumeOverrides:new Map,cellValidationMap:new Map,failedRows:new Set,autoWarningRows:new Set,volumeWarningRows:new Set,validationWarningRows:new Set,saveErrorRows:new Set,apiFailedRows:new Set,showCompletionWarnings:!1,isDirty:!1},progressTotals:null,volumeTotals:null,cellVolumeOverrides:null,cellValidationMap:null,failedRows:null,autoWarningRows:null,volumeWarningRows:null,validationWarningRows:null,saveErrorRows:null,apiFailedRows:null,showCompletionWarnings:!1,isDirty:!1},t||{},e.initialState||{});return window.kelolaTahapanPageState=n,n.timeColumnIndex=s(n.timeColumns),n}buildDomRefs(e,t={}){const a=Object.assign({root:document.getElementById("tahapan-grid-app"),saveButton:document.getElementById("save-button")||document.getElementById("btn-save-all"),refreshButton:document.getElementById("refresh-button"),resetButton:document.getElementById("btn-reset-progress"),tanstackGridContainer:document.getElementById("tanstack-grid-container"),tanstackGridBody:document.getElementById("tanstack-grid-body"),tanstackGridTopScroll:document.getElementById("tanstack-grid-scroll-top"),tanstackGridTopScrollInner:document.getElementById("tanstack-grid-scroll-inner"),scurveChart:document.getElementById("scurve-chart"),ganttChart:document.getElementById("gantt-chart"),ganttChartWrapper:document.getElementById("gantt-chart-wrapper"),ganttTreeBody:document.getElementById("gantt-tree-body"),ganttTreeScroll:document.getElementById("gantt-tree-scroll"),ganttSummaryTable:document.getElementById("gantt-summary-table"),ganttSummaryBody:document.getElementById("gantt-summary-body"),ganttSummaryTotal:document.getElementById("gantt-summary-total"),statusBar:document.querySelector(".status-bar"),statusMessageEl:document.getElementById("status-message"),itemCountEl:document.getElementById("item-count"),modifiedCountEl:document.getElementById("modified-count"),totalProgressEl:document.getElementById("total-progress"),weekStartSelect:document.getElementById("week-start-day-select"),weekEndSelect:document.getElementById("week-end-day-select")},t.domRefs||{});return e.domRefs=a,a}}class M{constructor(e){this.app=e}attachAll(){this._attachToolbarEvents(),this.app._initTanStackGridIfNeeded()}_attachToolbarEvents(){var e;const t=(null==(e=this.app.state)?void 0:e.domRefs)||{},a=t.saveButton,s=t.refreshButton,n=t.resetButton;a&&a.addEventListener("click",()=>this.app.saveChanges()),s&&s.addEventListener("click",()=>this.app.refresh()),n&&n.addEventListener("click",()=>this.app._handleResetProgress()),this.app._syncToolbarRadios(),this.app._attachRadioGroupHandler("displayMode",e=>this.app._handleDisplayModeChange(e)),this.app._attachRadioGroupHandler("progressMode",e=>this.app._handleProgressModeChange(e)),this.app._attachRadioGroupHandler("timeScale",e=>this.app._handleTimeScaleChange(e)),this.app._setupWeekBoundaryControls(),this.app._setupExportButtons(),this.app._setupCostViewToggle(),this._setupKeyboardShortcuts(),this._setupUXEnhancements()}_setupKeyboardShortcuts(){var e,t,a,s;this.app.keyboardShortcuts=new p,this.app.keyboardShortcuts.register("ctrl+s",()=>{this.app.saveChanges(),m.info("Saving changes... (Ctrl+S)")},{description:"Save all changes"}),this.app.keyboardShortcuts.register("ctrl+r",()=>{this.app.refresh(),m.info("Refreshing data... (Ctrl+R)")},{description:"Refresh data from server"}),this.app.keyboardShortcuts.register("ctrl+alt+p",()=>{const e=document.getElementById("mode-planned");e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),m.info("Switched to Perencanaan mode (Ctrl+Alt+P)"))},{description:"Switch to Perencanaan mode"}),this.app.keyboardShortcuts.register("ctrl+alt+a",()=>{const e=document.getElementById("mode-actual");e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),m.info("Switched to Realisasi mode (Ctrl+Alt+A)"))},{description:"Switch to Realisasi mode"}),this.app.keyboardShortcuts.register("ctrl+alt+1",()=>{const e=document.getElementById("mode-percentage");e&&!e.disabled&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),m.info("Display: Percentage (Ctrl+Alt+1)"))},{description:"Switch to Percentage display"}),this.app.keyboardShortcuts.register("ctrl+alt+2",()=>{const e=document.getElementById("mode-volume");e&&!e.disabled&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),m.info("Display: Volume (Ctrl+Alt+2)"))},{description:"Switch to Volume display"}),this.app.keyboardShortcuts.register("ctrl+alt+3",()=>{const e=document.getElementById("mode-cost");e&&!e.disabled?(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})),m.info("Display: Cost (Ctrl+Alt+3)")):m.warning("Cost view only available in Realisasi mode")},{description:"Switch to Cost display"}),this.app.keyboardShortcuts.register("escape",()=>{document.querySelectorAll(".dropdown-menu.show").forEach(e=>{const t=e.previousElementSibling;if(t){const e=bootstrap.Dropdown.getInstance(t);e&&e.hide()}})},{description:"Close open menus",preventDefault:!1}),this.app.keyboardShortcuts.register("ctrl+shift+/",()=>{this._showKeyboardShortcutsHelp()},{description:"Show keyboard shortcuts help"}),((null==(t=null==(e=this.app)?void 0:e.state)?void 0:t.debugUnifiedTable)||window.DEBUG_UNIFIED_TABLE)&&console.log("[EventBinder] Keyboard shortcuts registered",null==(s=(a=this.app.keyboardShortcuts).getShortcuts)?void 0:s.call(a))}_setupUXEnhancements(){var e,t,a,s;v();const n=null==(t=null==(e=this.app.state)?void 0:e.domRefs)?void 0:t.saveButton;n&&n.setAttribute("data-keyboard-hint","Ctrl+S"),((null==(s=null==(a=this.app)?void 0:a.state)?void 0:s.debugUnifiedTable)||window.DEBUG_UNIFIED_TABLE)&&console.log("[EventBinder] UX enhancements applied")}_showKeyboardShortcutsHelp(){var e,t;const a=`\n      <div class="modal fade" id="keyboardShortcutsModal" tabindex="-1">\n        <div class="modal-dialog">\n          <div class="modal-content">\n            <div class="modal-header">\n              <h5 class="modal-title">\n                <i class="bi bi-keyboard"></i> Keyboard Shortcuts\n              </h5>\n              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n            </div>\n            <div class="modal-body">\n              <table class="table table-sm">\n                <thead>\n                  <tr>\n                    <th>Shortcut</th>\n                    <th>Deskripsi</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${((null==(t=null==(e=this.app.keyboardShortcuts)?void 0:e.getShortcuts)?void 0:t.call(e))||[]).map(e=>`\n      <tr>\n        <td><kbd>${e.key.replace(/\\+/g,"</kbd> + <kbd>")}</kbd></td>\n        <td>${e.description}</td>\n      </tr>\n    `).join("")}\n                </tbody>\n              </table>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,s=document.getElementById("keyboardShortcutsModal");s&&s.remove();const n=document.createElement("div");n.innerHTML=a,document.body.appendChild(n.firstElementChild);const i=new bootstrap.Modal(document.getElementById("keyboardShortcutsModal"));document.getElementById("keyboardShortcutsModal").addEventListener("hidden.bs.modal",function(){const e=document.getElementById("keyboardShortcutsModal");e&&e.parentNode&&e.parentNode.removeChild(e)}),i.show()}}class T{constructor(e){this.app=e}loadInitialData(){return d(this,arguments,function*(e={}){var t,a,s,n,i,o,r,l,d,h,c,u;const g=this.app,{forceReload:p=!1}=e;if(!p&&(null==(t=g.state.pekerjaanTree)?void 0:t.length)>0)return console.log("[JadwalKegiatanApp] Using template dataset"),console.log("Preloaded pekerjaanTree items:",g.state.pekerjaanTree.length),console.log("Preloaded tahapanList items:",(null==(a=g.state.tahapanList)?void 0:a.length)||0),console.log("Preloaded timeColumns items:",(null==(s=g.state.timeColumns)?void 0:s.length)||0),g._recalculateAllProgressTotals(),void g._syncGridViews();g._showSkeleton("grid"),g.state.apiBase=(null==(n=g.state.apiEndpoints)?void 0:n.tahapan)||`/detail_project/api/project/${g.state.projectId}/tahapan/`,g.dataLoader=new w(g.state),g.timeColumnGenerator=new _(g.state),g.saveHandler=new b(g.state,{apiUrl:(null==(i=g.state.apiEndpoints)?void 0:i.save)||`/detail_project/api/project/${g.state.projectId}/pekerjaan/assign_weekly/`,onSuccess:e=>g._onSaveSuccess(e),onError:e=>g._onSaveError(e),showToast:(e,t)=>g.showToast(e,t),dataLoader:g.dataLoader}),g.state.isLoading=!0;try{console.log("[JadwalKegiatanApp] Loading data using modern DataLoader..."),yield g.dataLoader.loadAllData({skipIfLoaded:!1,force:p}),g.timeColumnGenerator.generate();const e=(g.state.displayScale||g.state.timeScale||"weekly").toLowerCase();if(!g._isEnforcingWeekly&&"weekly"===e){const e=g._countWeeklyColumns(),t=g._estimateExpectedWeeklyColumns(),a=((null==(r=null==(o=g.state.timeColumns)?void 0:o[0])?void 0:r.generationMode)||(null==(d=null==(l=g.state.timeColumns)?void 0:l[0])?void 0:d.type)||"").toLowerCase();if(0===e||"monthly"===a||t>0&&e>0&&e<t)return console.warn("[JadwalKegiatanApp] Weekly columns incomplete; regenerating weekly structure based on project timeline..."),g._isEnforcingWeekly=!0,yield this.regenerateTimeline({mode:"weekly",weekStartDay:g._getWeekStartDay(),weekEndDay:g._getWeekEndDay()}),void(g._isEnforcingWeekly=!1)}yield g.dataLoader.loadAssignments(),g._recalculateAllProgressTotals(),yield g._loadKurvaSData(),g.state.dependencies=g.state.dependencies||[],g.state.timeColumnIndex=g._createTimeColumnIndex(g.state.timeColumns),console.log("[JadwalKegiatanApp] Æ’o. Data loaded successfully:",`${(null==(h=g.state.flatPekerjaan)?void 0:h.length)||0} pekerjaan,`,`${(null==(c=g.state.tahapanList)?void 0:c.length)||0} tahapan,`,`${(null==(u=g.state.timeColumns)?void 0:u.length)||0} columns`),g._initializeCharts(),g._updateCharts()}catch(m){console.error("[JadwalKegiatanApp] Æ’?O Failed to load data:",m),g.state.error=m,g.showToast("Gagal memuat data: "+m.message,"danger")}finally{g.state.isLoading=!1,g._syncGridViews(),g._hideSkeleton("grid")}})}regenerateTimeline(){return d(this,arguments,function*(e={}){var t;const a=this.app,{mode:s="weekly",weekStartDay:n,weekEndDay:i}=e,o=null==(t=a.state.apiEndpoints)?void 0:t.regenerateTahapan;if(!o)return;if(a._isRegeneratingTimeline)return void(a._queuedRegeneratePayload={mode:s,weekStartDay:n,weekEndDay:i});if(a.state.isDirty&&a.state.modifiedCells instanceof Map&&a.state.modifiedCells.size>0){if(!window.confirm("Mengubah batas minggu akan me-refresh data dan membatalkan perubahan yang belum disimpan. Lanjutkan?"))return;a._resetEditedCellsState(),a.state.isDirty=!1}a._isRegeneratingTimeline=!0,a.state.isLoading=!0;const l="monthly"===s?"Mengatur ulang struktur bulanan...":"Mengatur ulang struktur minggu...";a._updateStatusBar(l);const d="monthly"===s?"Mengatur ulang kolom monthly...":"Mengatur ulang kolom weekly sesuai preferensi Anda...";a.showToast(d,"info",2400);try{const e=yield fetch(o,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":a._getCsrfToken()},body:JSON.stringify(r({mode:s},"weekly"===s?{week_start_day:"number"==typeof n?n:a._getWeekStartDay(),week_end_day:"number"==typeof i?i:a._getWeekEndDay()}:{}))});if(!e.ok)throw new Error(`HTTP ${e.status}`);a._invalidateCachedDataset(),yield this.loadInitialData({forceReload:!0});const t="monthly"===s?"Struktur monthly diperbarui (read-only)":"Periode minggu diperbarui";a.showToast(t,"success",2200)}catch(h){console.error("[JadwalKegiatanApp] Failed to regenerate weekly structure",h),a.showToast("Gagal memperbarui struktur waktu","danger",3200)}finally{if(a.state.isLoading=!1,a._updateStatusBar(),a._isRegeneratingTimeline=!1,a._queuedRegeneratePayload){const e=a._queuedRegeneratePayload;a._queuedRegeneratePayload=null,this.regenerateTimeline(e)}}})}}class E{constructor(e){this.app=e}syncToolbarRadios(){var e,t;const a=(null==(e=this.app)?void 0:e.state)||{},s=a.inputMode||"percentage";this._setRadioGroupChecked("displayMode",s);const n=a.progressMode||"planned";this._setRadioGroupChecked("progressMode",n,{ariaSelected:!0});const i=a.displayScale||a.timeScale||"weekly";this._setRadioGroupChecked("timeScale",i),"function"==typeof(null==(t=this.app)?void 0:t._updateCostToggleAvailability)&&this.app._updateCostToggleAvailability()}attachRadioGroupHandler(e,t){const a=document.querySelectorAll(`input[name="${e}"]`);a&&0!==a.length&&a.forEach(e=>{e.addEventListener("change",e=>{e.target.checked&&t(e.target.value)})})}_setRadioGroupChecked(e,t,a={}){document.querySelectorAll(`input[name="${e}"]`).forEach(e=>{const s=e.value===t;if(e.checked!==s&&(e.checked=s),a.ariaSelected){const t=e.nextElementSibling;t&&t.matches(".btn")&&t.setAttribute("aria-selected",String(s))}})}setupWeekBoundaryControls(){const{weekStartSelect:e,weekEndSelect:t}=this.app.state.domRefs||{};e&&t&&(this.app._syncWeekBoundaryControls(),e.addEventListener("change",e=>{const t=this.app._normalizePythonWeekday(e.target.value,this.app._getWeekStartDay()),a=(t+6)%7;this.app._handleWeekBoundaryChange({weekStartDay:t,weekEndDay:a,source:"start"})}),t.addEventListener("change",e=>{const t=this.app._normalizePythonWeekday(e.target.value,this.app._getWeekEndDay()),a=(t+1)%7;this.app._handleWeekBoundaryChange({weekStartDay:a,weekEndDay:t,source:"end"})}))}setupCostViewToggle(){var e,t,a,s;const n=document.getElementById("toggleCostViewBtn"),i=document.getElementById("toggleCostViewBtnText"),o=document.getElementById("toggleCostViewBtnSpinner"),r=null==n?void 0:n.querySelector("i");if(!n)return void(null==(t=(e=this.app)._log)||t.call(e,"[JadwalKegiatanApp] Cost view toggle button not found (chart tab may not be active)"));if(!this.app.kurvaSChart)return void console.warn("[JadwalKegiatanApp] Kurva S chart not initialized, cannot setup toggle");if(!1===(null==(s=null==(a=this.app.kurvaSChart)?void 0:a.options)?void 0:s.enableCostView))return void n.classList.add("d-none");this.app._costToggleBtn=n,this.app._costToggleBtnText=i,this.app._costToggleSpinner=o,this.app._costToggleBtnIcon=r;const l=e=>{i&&(i.textContent=e)};n.addEventListener("click",()=>d(this,null,function*(){n.disabled=!0,n.classList.add("disabled"),o&&o.classList.remove("d-none"),r&&r.classList.add("d-none"),l("Memuat biaya...");try{"function"==typeof this.app._loadCostView&&(yield this.app._loadCostView())}catch(e){console.error("[JadwalKegiatanApp] Failed to toggle cost view",e),"function"==typeof this.app.showToast&&this.app.showToast("Gagal memuat view biaya","danger",2600)}finally{n.disabled=!1,n.classList.remove("disabled"),o&&o.classList.add("d-none"),r&&r.classList.remove("d-none"),l("Biaya")}}))}showSkeleton(e){const t=document.getElementById(`skeleton-${e}`),a=document.getElementById(`${e}-view`);t&&(t.classList.add("showing"),t.classList.remove("fade-out")),a&&a.classList.add("content-hidden")}hideSkeleton(e){const t=document.getElementById(`skeleton-${e}`),a=document.getElementById(`${e}-view`);t&&(t.classList.add("fade-out"),setTimeout(()=>{t.classList.remove("showing"),t.classList.remove("fade-out")},300)),a&&a.classList.remove("content-hidden")}}class R{constructor(e){this.app=e}initializeCharts(){this._setupLazyChartLoading(),this.app._bindUnifiedTabSync()}_setupLazyChartLoading(){const e=this.app,t=document.querySelector("#scurve-tab")||document.querySelector('[data-bs-target="#scurve-view"]'),a=document.querySelector("#gantt-tab")||document.querySelector('[data-bs-target="#gantt-view"]');console.log("[LazyLoad] Found tabs:",{scurveTab:t,ganttTab:a}),t&&(t.addEventListener("shown.bs.tab",()=>d(this,null,function*(){console.log("[LazyLoad] Kurva S tab shown"),e.state.useUnifiedTable&&e.unifiedManager&&e.unifiedManager.switchMode("kurva"),e._chartModulesLoaded||(yield e._loadChartModules())}),{once:!0}),t.addEventListener("click",()=>d(this,null,function*(){console.log("[LazyLoad] Kurva S tab clicked"),e.state.useUnifiedTable&&e.unifiedManager&&e.unifiedManager.switchMode("kurva"),e._chartModulesLoaded||e._chartModulesLoading||(yield e._loadChartModules())}),{once:!0})),a&&(a.addEventListener("shown.bs.tab",()=>d(this,null,function*(){console.log("[LazyLoad] dYZ_ Gantt tab shown - initializing NEW Gantt Chart!"),e._chartModulesLoaded||(yield e._loadChartModules()),yield this._initializeRedesignedGantt()}),{once:!0}),a.addEventListener("click",()=>d(this,null,function*(){console.log("[LazyLoad] dYZ_ Gantt tab clicked"),e._chartModulesLoaded||e._chartModulesLoading||(yield e._loadChartModules())}),{once:!0})),console.log('dY"S Chart lazy loading configured (with NEW Gantt initialization)')}updateChartsThrottled(){const e=this.app;e._chartUpdatePending||(e._chartUpdatePending=!0,requestAnimationFrame(()=>{setTimeout(()=>{this.updateCharts(),e._chartUpdatePending=!1},e._chartUpdateDelay)}))}updateCharts(){const e=this.app;if(console.log("[JadwalKegiatanApp] Updating charts..."),e.kurvaSChart)try{e.kurvaSChart.update(),console.log("[JadwalKegiatanApp] Æ’o. Kurva-S chart updated")}catch(t){console.warn("[JadwalKegiatanApp] Failed to update Kurva-S chart:",t)}if(e.ganttFrozenGrid&&"function"==typeof e.ganttFrozenGrid.update)try{e.ganttFrozenGrid.update(),console.log("[JadwalKegiatanApp] Æ’o. Gantt V2 chart updated")}catch(t){console.warn("[JadwalKegiatanApp] Failed to update Gantt V2 chart:",t)}}initializeChartsAfterLoad(){var e;const t=this.app;if(console.log("[JadwalKegiatanApp] Initializing charts after load..."),t.state.useUnifiedTable)console.log("[JadwalKegiatanApp] Skipping legacy Kurva-S chart (using unified overlay)");else{if((null==(e=t.state.domRefs)?void 0:e.scurveChart)&&t.KurvaSChartClass)try{t.kurvaSChart=new t.KurvaSChartClass(t.state,{useIdealCurve:!0,steepnessFactor:.8,smoothCurves:!0,showArea:!0,enableCostView:!0});if(t.kurvaSChart.initialize(t.state.domRefs.scurveChart)){console.log("[JadwalKegiatanApp] Kurva-S chart initialized"),t._setupCostViewToggle();const e=t._activateDefaultCostView();e&&"function"==typeof e.catch&&e.catch(e=>{console.warn("[JadwalKegiatanApp] Failed to auto-enable cost view:",e)})}}catch(a){console.warn("[JadwalKegiatanApp] Failed to initialize Kurva-S chart:",a)}console.log("[JadwalKegiatanApp] Æ’sÃ¿â€¹,? OLD Gantt Chart initialization SKIPPED (replaced by new design)")}}_initializeRedesignedGantt(e=0){return d(this,null,function*(){this.app;console.log("[JadwalKegiatanApp] Rendering Gantt via unified table overlay"),0===e&&(yield new Promise(e=>setTimeout(e,100)));const t=document.getElementById("gantt-redesign-container");if(!t)return console.warn(`[JadwalKegiatanApp] Ð“?3 Gantt container not found (attempt ${e+1}/3)`),e<3?(console.log("[JadwalKegiatanApp] Retrying in 200ms..."),yield new Promise(e=>setTimeout(e,200)),this._initializeRedesignedGantt(e+1)):(console.error("[JadwalKegiatanApp] Ð“?O Gantt container not found after retries"),console.error("[JadwalKegiatanApp] DOM state:",{ganttView:document.getElementById("gantt-view"),ganttTab:document.getElementById("gantt-tab")}),void m.error("Failed to find Gantt container"));try{yield this._initializeUnifiedGanttOverlay(t)}catch(a){throw console.error("[JadwalKegiatanApp] Ð“?O Failed to initialize Gantt:",a),console.error("[JadwalKegiatanApp] Error stack:",a.stack),m.error("Failed to load Gantt Chart"),a}})}_initializeUnifiedGanttOverlay(e){return d(this,null,function*(){const t=this.app;if(t.unifiedManager||t._initTanStackGridIfNeeded(),!t.unifiedManager)return void console.warn("[JadwalKegiatanApp] Unified manager not available for Gantt overlay");const a=this._ensureGanttHost(e);if(!a)return void console.warn("[JadwalKegiatanApp] Unable to prepare Gantt host for unified overlay");const s={tree:t.state.pekerjaanTree||[],timeColumns:t._getDisplayTimeColumns(),inputMode:t.state.inputMode||"percentage",timeScale:t.state.displayScale||t.state.timeScale||"weekly",dependencies:t.state.dependencies||[]};t.state.debugUnifiedTable&&console.log("[UnifiedGanttOverlay] Apply payload",{rows:s.tree.length,columns:s.timeColumns.length,deps:s.dependencies.length}),t.unifiedManager.updateData(s),t.unifiedManager.switchMode("gantt"),this._applyGanttOverlayStyles(a)})}_applyGanttOverlayStyles(e){if(!e)return;e.classList.add("gantt-overlay-mode");const t="gantt-overlay-style";if(!document.getElementById(t)){const e=document.createElement("style");e.id=t,e.textContent="\n        /* Biarkan header/frozen columns tetap tampil untuk konteks */\n        .gantt-overlay-mode .tanstack-grid-header { display: block !important; }\n        /* Sembunyikan konten text pada sel time-column saja, jangan menggangu pinned kolom */\n        .gantt-overlay-mode .tanstack-grid-cell.time-cell { color: transparent; }\n        .gantt-overlay-mode .tanstack-grid-cell.time-cell * { visibility: hidden; }\n        .gantt-overlay-mode .tanstack-grid-cell.time-cell { pointer-events: none; }\n        /* Izinkan scroll tetap berjalan */\n        .gantt-overlay-mode .tanstack-grid-body { overflow: auto; }\n      ",document.head.appendChild(e)}}_ensureGanttHost(e){if(this.app,!e)return null;let t=e.querySelector(".unified-gantt-host");return t?t.innerHTML="":(t=document.createElement("div"),t.className="unified-gantt-host",t.style.position="relative",t.style.minHeight="420px",t.style.width="100%",e.innerHTML="",e.appendChild(t)),this._moveGridContainerTo(t),t}_moveGridContainerTo(e){var t,a;const s=null==(a=null==(t=this.app.state)?void 0:t.domRefs)?void 0:a.tanstackGridContainer;s&&e&&s.parentNode!==e&&e.appendChild(s)}_restoreGridContainerPosition(){var e,t;const a=this.app,s=null==(t=null==(e=a.state)?void 0:e.domRefs)?void 0:t.tanstackGridContainer,n=a._gridContainerParent;s&&n&&s.parentNode!==n&&(a._gridContainerNextSibling&&a._gridContainerNextSibling.parentNode===n?n.insertBefore(s,a._gridContainerNextSibling):n.appendChild(s))}_prepareGanttData(){var e;const t=this.app,a=[];if((null==(e=t.state)?void 0:e.flatPekerjaan)&&Array.isArray(t.state.flatPekerjaan)){const e=t.state.flatPekerjaan.filter(e=>"pekerjaan"===e.type);console.log(`[JadwalKegiatanApp] Transforming ${e.length} pekerjaan nodes for Gantt (filtered from ${t.state.flatPekerjaan.length} total nodes)`),e.length>0&&console.log("[JadwalKegiatanApp] Sample pekerjaan node:",e[0]),e.forEach(e=>{a.push({id:e.id,name:e.nama||e.name||"Pekerjaan",start:e.tanggal_mulai||e.start_date||this._fallbackDate(e),end:e.tanggal_selesai||e.end_date||this._fallbackDate(e,7),progress_rencana:e.progress_plan||0,progress_realisasi:e.progress_actual||0,volume:e.volume||0,satuan:e.satuan||""})})}else console.warn("[JadwalKegiatanApp] No flatPekerjaan data available for Gantt");const s={project_id:t.state.projectId,project_name:t.state.projectName||"Project",start_date:t.state.projectStart,end_date:t.state.projectEnd};return console.log(`[JadwalKegiatanApp] Prepared ${a.length} nodes for Gantt Chart`),{data:a,project:s,milestones:[]}}_fallbackDate(e,t=0){const a=new Date;if(!(null==e?void 0:e.created_at)){const e=new Date(a);return e.setDate(e.getDate()+t),e.toISOString().slice(0,10)}const s=new Date(e.created_at);if(Number.isNaN(s.getTime())){const e=new Date(a);return e.setDate(e.getDate()+t),e.toISOString().slice(0,10)}return s.setDate(s.getDate()+t),s.toISOString().slice(0,10)}}class A{constructor(){this.state=null,this.initialized=!1,this.gridManager=null,this.stateManager=f.getInstance(),this.dataLoader=null,this.timeColumnGenerator=null,this.saveHandler=null,this.unifiedManager=null,this._gridContainerParent=null,this._gridContainerNextSibling=null,this.kurvaSChart=null,this.ganttChart=null,this.ganttFrozenGrid=null,this._chartModulesLoaded=!1,this._chartModulesLoading=!1,this._chartUpdatePending=!1,this._chartUpdateDelay=200,this.keyboardShortcuts=null,this.eventBinder=null,this.dataOrchestrator=null,this.uxManager=new E(this),this.chartCoordinator=new R(this),this._weekBoundarySaveTimer=null,this._pendingWeekBoundary=null,this._isRegeneratingTimeline=!1,this._queuedRegeneratePayload=null,this._isEnforcingWeekly=!1,this._exportManagerInstance=null,this._exportBindingsAttached=!1,this._costToggleBtn=null,this._costToggleBtnText=null,this._costToggleSpinner=null,this._costToggleBtnIcon=null,this._costViewAutoActivated=!1,this._ganttScrollSyncHandlers=null,this._stateManagerListener=null,this._suppressStateManagerEvent=!1,this._currencyFormatter=null}_getProjectDateRange(){var e,t;let a=null,s=null;if(null==(e=this.state)?void 0:e.projectStart){const e=new Date(this.state.projectStart);Number.isNaN(e.getTime())||(a=e)}if(null==(t=this.state)?void 0:t.projectEnd){const e=new Date(this.state.projectEnd);Number.isNaN(e.getTime())||(s=e)}return!a||s&&!Number.isNaN(s.getTime())||(s=new Date(a.getFullYear(),11,31)),{start:a,end:s}}_estimateExpectedWeeklyColumns(){const{start:e,end:t}=this._getProjectDateRange();if(!e||!t||Number.isNaN(e.getTime())||Number.isNaN(t.getTime()))return 0;const a=Math.max(0,Math.floor((t-e)/864e5))+1;return Math.max(1,Math.ceil(a/7))}_countWeeklyColumns(){return Array.isArray(this.state.timeColumns)?this.state.timeColumns.filter(e=>{var t;const a=(e.generationMode||e.type||"").toLowerCase();return"weekly"===a||"week"===a||"wk"===a||Number.isFinite(Number(null!=(t=e.weekNumber)?t:e.week_number))}).length:0}initialize(){return d(this,arguments,function*(e={}){var t;if(this.initialized)console.warn("JadwalKegiatanApp already initialized");else{console.log("ðŸš€ Initializing Jadwal Kegiatan App (Vite Build)");try{this.appInitializer=new S(this.stateManager);const a=window.kelolaTahapanPageState||(null==(t=window.JadwalPekerjaanApp)?void 0:t.state);this.state=this.appInitializer.buildState(e,a,{createTimeColumnIndex:this._createTimeColumnIndex.bind(this)}),this._ensureStateCollections(),this.state.displayScale||(this.state.displayScale=this.state.timeScale||"weekly"),this._setupStateDelegation(),this._bindStateManagerEvents();const s=this.appInitializer.buildDomRefs(this.state,e);if(this.state.domRefs=s,this._updateSaveButtonState(),!s.root)throw new Error("Root container #tahapan-grid-app tidak ditemukan");if(this._applyDataset(s.root),!s.tanstackGridContainer)throw new Error("TanStack grid container #tanstack-grid-container tidak ditemukan");this.dataOrchestrator||(this.dataOrchestrator=new T(this)),this.eventBinder=new M(this),this._attachEvents(),yield this._loadInitialData(),this.initialized=!0,console.log("âœ… Jadwal Kegiatan App initialized successfully"),window.JadwalKegiatanApp=this}catch(a){throw console.error("âŒ Failed to initialize Jadwal Kegiatan App:",a),a}}})}_setupStateDelegation(){const e=()=>"actual"===this.state.progressMode?this.state.actualState:this.state.plannedState;Object.defineProperty(this.state,"modifiedCells",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].modifiedCells},set:e=>{const t=this.state.progressMode;this.stateManager.states[t].modifiedCells=e instanceof Map?e:new Map(Object.entries(e||{}))},configurable:!0}),Object.defineProperty(this.state,"assignmentMap",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].assignmentMap},set:e=>{const t=this.state.progressMode;this.stateManager.states[t].assignmentMap=e instanceof Map?e:new Map(Object.entries(e||{}))},configurable:!0}),Object.defineProperty(this.state,"costAssignmentMap",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].costAssignmentMap},set:e=>{const t=this.state.progressMode;this.stateManager.states[t].costAssignmentMap=e instanceof Map?e:new Map(Object.entries(e||{}))},configurable:!0}),Object.defineProperty(this.state,"costModifiedCells",{get:()=>{const e=this.state.progressMode;return this.stateManager.states[e].costModifiedCells},set:e=>{const t=this.state.progressMode;this.stateManager.states[t].costModifiedCells=e instanceof Map?e:new Map(Object.entries(e||{}))},configurable:!0}),Object.defineProperty(this.state,"progressTotals",{get:()=>e().progressTotals,configurable:!0}),Object.defineProperty(this.state,"volumeTotals",{get:()=>e().volumeTotals,configurable:!0}),Object.defineProperty(this.state,"cellVolumeOverrides",{get:()=>e().cellVolumeOverrides,configurable:!0}),Object.defineProperty(this.state,"cellValidationMap",{get:()=>e().cellValidationMap,configurable:!0}),Object.defineProperty(this.state,"isDirty",{get:()=>e().isDirty||this.stateManager.hasUnsavedChanges(),set:t=>{e().isDirty=t},configurable:!0}),console.log("[JadwalKegiatanApp] Phase 0.3: State delegation setup with StateManager integration")}_bindStateManagerEvents(){this.stateManager&&!this._stateManagerListener&&(this._stateManagerListener=e=>this._handleStateManagerEvent(e),this.stateManager.addEventListener(this._stateManagerListener),console.log("[JadwalKegiatanApp] StateManager listener attached"))}_unbindStateManagerEvents(){this.stateManager&&this._stateManagerListener&&(this.stateManager.removeEventListener(this._stateManagerListener),this._stateManagerListener=null,console.log("[JadwalKegiatanApp] StateManager listener removed"))}_showSkeleton(e){this.uxManager&&this.uxManager.showSkeleton(e)}_hideSkeleton(e){this.uxManager&&this.uxManager.hideSkeleton(e)}_handleStateManagerEvent(e={}){if(e&&"object"==typeof e)switch(e.type){case"mode-switch":if(this._suppressStateManagerEvent)return;this._applyProgressModeSwitch(e.newMode,{showToast:!1});break;case"commit":this._handleStateCommitEvent(e);break;case"reset":this._handleStateResetEvent()}}_handleStateCommitEvent(e={}){this.gridManager&&"function"==typeof this.gridManager.refreshCells&&this.gridManager.refreshCells(),this._updateStatusBar(),this._updateCharts();const t="actual"===(e.mode||this.state.progressMode||"planned")?"Realisasi":"Perencanaan";console.log(`[StateManager] Commit event processed for mode: ${t}`)}_handleStateResetEvent(){var e;console.log("[StateManager] Reset event received, syncing UI components"),this.state.progressMode=(null==(e=this.stateManager)?void 0:e.currentMode)||"planned",this._syncToolbarRadios(),this._syncGridViews(),this._updateStatusBar("Ready"),this._updateCharts()}_getCurrentModeState(){const e="actual"===this.state.progressMode?"actual":"planned";return this.stateManager.states[e]}_updateSaveButtonState(){var e,t,a;const s=null==(t=null==(e=this.state)?void 0:e.domRefs)?void 0:t.saveButton;if(!s)return;const n=(null==(a=this.state)?void 0:a.failedRows)instanceof Set&&this.state.failedRows.size>0;s.disabled=!1,s.classList.toggle("btn-outline-danger",Boolean(n)),s.classList.toggle("btn-success",!n),n?s.setAttribute("title","Ada baris dengan peringatan (>100%/volume). Klik untuk melihat detail dan perbaiki."):s.removeAttribute("title")}_ensureStateCollections(){this.state.failedRows instanceof Set||(this.state.failedRows=new Set),this.state.autoWarningRows instanceof Set||(this.state.autoWarningRows=new Set),this.state.volumeWarningRows instanceof Set||(this.state.volumeWarningRows=new Set),this.state.validationWarningRows instanceof Set||(this.state.validationWarningRows=new Set),this.state.saveErrorRows instanceof Set||(this.state.saveErrorRows=new Set),this.state.apiFailedRows instanceof Set||(this.state.apiFailedRows=new Set),this.state.progressTotals instanceof Map||(this.state.progressTotals=new Map),this.state.volumeTotals instanceof Map||(this.state.volumeTotals=new Map),this.state.cellVolumeOverrides instanceof Map||(this.state.cellVolumeOverrides=new Map),this.state.cellValidationMap instanceof Map||(this.state.cellValidationMap=new Map)}_applyDataset(e){var t,a,s,n,i,o;if(!e||!e.dataset)return;const{dataset:r}=e;this.state.projectId=Number(r.projectId||this.state.projectId||0)||this.state.projectId,this.state.projectName=r.projectName||this.state.projectName,this.state.projectStart=r.projectStart||this.state.projectStart,this.state.projectEnd=r.projectEnd||this.state.projectEnd;const l=new Set(["daily","weekly","monthly","custom"]),d=(r.defaultTimeScale||r.timeScale||r.saveMode||this.state.timeScale||this.state.saveMode||"").toString().toLowerCase();l.has(d)?(this.state.timeScale=d,this.state.saveMode=d):this.state.timeScale||(this.state.timeScale=this.state.saveMode||"weekly"),this.state.displayScale=this.state.timeScale||"weekly";const h=(r.defaultInputMode||r.inputMode||r.displayMode||this.state.inputMode||"percentage").toString().toLowerCase(),c=new Set(["percentage","volume","cost"]);this.state.inputMode=c.has(h)?h:"percentage";const u=Number.parseInt(null!=(n=null!=(s=null!=(a=null!=(t=r.weekEndDay)?t:r.weekend)?a:r.weekEnd)?s:r.week_end_day)?n:"",10);Number.isNaN(u)||(this.state.weekEndDay=u);const g=Number.parseInt(null!=(o=null!=(i=r.weekStartDay)?i:r.week_start_day)?o:"",10);if(Number.isNaN(g))Number.isNaN(u)||(this.state.weekStartDay=(this.state.weekEndDay+1)%7);else{const e=(g%7+7)%7;this.state.weekStartDay=e}const p=Object.assign({base:r.apiBase||"",tahapan:r.apiTahapan||r.apiBase||"",listPekerjaan:r.apiListPekerjaan||"",volume:r.apiVolume||"",assignmentsBase:r.apiAssignmentsBase||"",save:r.apiSave||this.state.apiEndpoints&&this.state.apiEndpoints.save||this._getDefaultSaveEndpoint(),weekBoundary:r.apiWeekBoundary||"",regenerateTahapan:r.apiRegenerateTahapan||"",reset:r.apiResetProgress||this.state.apiEndpoints&&this.state.apiEndpoints.reset||""},this.state.apiEndpoints||{});this.state.apiEndpoints=p,void 0!==r.enableUplotKurva&&(this.state.useUPlotKurva="false"!==r.enableUplotKurva)}_attachEvents(){this.eventBinder?this.eventBinder.attachAll():this._initTanStackGridIfNeeded()}_attachRadioGroupHandler(e,t){var a;(null==(a=this.uxManager)?void 0:a.attachRadioGroupHandler)&&this.uxManager.attachRadioGroupHandler(e,t)}_setupWeekBoundaryControls(){var e;(null==(e=this.uxManager)?void 0:e.setupWeekBoundaryControls)&&this.uxManager.setupWeekBoundaryControls()}_setupCostViewToggle(){var e;(null==(e=this.uxManager)?void 0:e.setupCostViewToggle)&&this.uxManager.setupCostViewToggle()}_setupWeekBoundaryControls(){const{weekStartSelect:e,weekEndSelect:t}=this.state.domRefs||{};e&&t&&(this._syncWeekBoundaryControls(),e.addEventListener("change",e=>{const t=this._normalizePythonWeekday(e.target.value,this._getWeekStartDay()),a=(t+6)%7;this._handleWeekBoundaryChange({weekStartDay:t,weekEndDay:a,source:"start"})}),t.addEventListener("change",e=>{const t=this._normalizePythonWeekday(e.target.value,this._getWeekEndDay()),a=(t+1)%7;this._handleWeekBoundaryChange({weekStartDay:a,weekEndDay:t,source:"end"})}))}_setupExportButtons(){var e;if(!this._exportBindingsAttached)if("undefined"!=typeof ExportManager){if(null==(e=this.state)?void 0:e.projectId)try{this._exportManagerInstance=new ExportManager(this.state.projectId,"jadwal-pekerjaan");["csv","pdf","word","xlsx"].forEach(e=>{const t=document.getElementById(`btn-export-${e}`);t&&t.addEventListener("click",()=>{this._exportManagerInstance.exportAs(e)})}),this._exportBindingsAttached=!0}catch(t){console.error("[JadwalKegiatanApp] Failed to initialize export buttons",t)}}else console.warn("[JadwalKegiatanApp] ExportManager is not loaded; export buttons disabled")}_setupCostViewToggle(){var e,t;const a=document.getElementById("toggleCostViewBtn"),s=document.getElementById("toggleCostViewBtnText"),n=document.getElementById("toggleCostViewBtnSpinner"),i=null==a?void 0:a.querySelector("i");a?this.kurvaSChart?!1!==(null==(t=null==(e=this.kurvaSChart)?void 0:e.options)?void 0:t.enableCostView)?(this._costToggleBtn=a,this._costToggleBtnText=s,this._costToggleSpinner=n,this._costToggleBtnIcon=i,a.addEventListener("click",()=>d(this,null,function*(){a.disabled=!0,null==n||n.classList.remove("d-none");try{(yield this.kurvaSChart.toggleView())?(this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Switched Kurva-S view:",this.kurvaSChart.viewMode)):console.error("[JadwalKegiatanApp] Failed to toggle view")}catch(e){console.error("[JadwalKegiatanApp] Error toggling cost view:",e)}finally{a.disabled=!1,null==n||n.classList.add("d-none")}})),this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Cost view toggle button setup complete")):a.classList.add("d-none"):console.warn("[JadwalKegiatanApp] Kurva S chart not initialized, cannot setup toggle"):console.log("[JadwalKegiatanApp] Cost view toggle button not found (chart tab may not be active)")}_setCostToggleButtonState(){if(!this._costToggleBtn||!this.kurvaSChart)return;const e="cost"===this.kurvaSChart.viewMode,t=e?"Show Progress View":"Show Cost View",a=e?"fas fa-chart-line":"fas fa-money-bill-wave";this._costToggleBtnText&&(this._costToggleBtnText.textContent=t),this._costToggleBtnIcon&&(this._costToggleBtnIcon.className=a)}_activateDefaultCostView(){return d(this,null,function*(){if(this._costViewAutoActivated)return void this._setCostToggleButtonState();if(!this.kurvaSChart)return;if((this.kurvaSChart.options||{}).enableCostView)try{(yield this.kurvaSChart.toggleView("cost"))&&(this._costViewAutoActivated=!0,this._setCostToggleButtonState(),console.log("[JadwalKegiatanApp] Defaulted Kurva-S to cost view"))}catch(e){console.warn("[JadwalKegiatanApp] Failed to enable cost view automatically:",e)}})}_handleResetProgress(){return d(this,null,function*(){var e;const t=null==(e=this.state.apiEndpoints)?void 0:e.reset;if(!t)return void this.showToast("Endpoint reset tidak tersedia","danger",3200);const a=this.state.progressMode||"planned",s="planned"===a?"Perencanaan":"Realisasi";if(window.confirm(`Reset semua progress ${s} ke 0%?\n\nData ${"Perencanaan"===s?"Realisasi":"Perencanaan"} tidak akan terpengaruh.\n\nOperasi ini dapat di-undo dengan memasukkan ulang data.`))try{this.state.isLoading=!0,this._updateStatusBar(`Mereset progress ${s}...`);const e=yield fetch(t,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:JSON.stringify({mode:a})});if(!e.ok){const t=yield e.text().catch(()=>"");throw new Error(t||`HTTP ${e.status}`)}const n=yield e.json().catch(()=>({}));this._resetEditedCellsState(),this.state.assignmentMap instanceof Map?this.state.assignmentMap.clear():this.state.assignmentMap=new Map,this._clearFailedRows(),this.state.isDirty=!1;const i=(null==n?void 0:n.message)||"Progress berhasil direset. Silakan input ulang jadwal pekerjaan.";this.showToast(i,"success",3400),yield this._loadInitialData({forceReload:!0})}catch(n){console.error("[JadwalKegiatanApp] Failed to reset progress",n),this.showToast("Gagal mereset progress. Coba lagi atau hubungi admin.","danger",3600)}finally{this.state.isLoading=!1,this._updateStatusBar()}})}_syncWeekBoundaryControls(){const{weekStartSelect:e,weekEndSelect:t}=this.state.domRefs||{};e&&(e.value=String(this._getWeekStartDay())),t&&(t.value=String(this._getWeekEndDay()))}_handleWeekBoundaryChange({weekStartDay:e,weekEndDay:t,source:a}){const s=this._normalizePythonWeekday(t,this._getWeekEndDay()),n=this._normalizePythonWeekday(e,(s+1)%7);if(n===this._getWeekStartDay()&&s===this._getWeekEndDay())return void this._syncWeekBoundaryControls();this.state.weekStartDay=n,this.state.weekEndDay=s,this._syncWeekBoundaryControls();const i=`${this._formatWeekdayLabel(n)} â†’ ${this._formatWeekdayLabel(s)}`,o="start"===a?"Week start disetel ke":"Week end disetel ke";this.showToast(`${o} ${i}`,"info",2400),this._regenerateColumnsForWeekBoundary(),this._persistWeekBoundarySettings(n,s)}_regenerateColumnsForWeekBoundary(){if(Array.isArray(this.state.tahapanList)&&0!==this.state.tahapanList.length){this.timeColumnGenerator||(this.timeColumnGenerator=new _(this.state));try{this.timeColumnGenerator.generate(),this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),this._syncGridViews(),this._recalculateAllProgressTotals()}catch(e){console.error("[JadwalKegiatanApp] Failed to regenerate columns for week boundary change",e),this.showToast("Gagal menerapkan pengaturan minggu","danger",3200)}}}_invalidateCachedDataset(){var e,t,a,s,n,i;this.state.pekerjaanTree=[],this.state.tahapanList=[],this.state.timeColumns=[],this.state.flatPekerjaan=[],this.state.timeColumnIndex={},(null==(a=null==(t=null==(e=this.stateManager)?void 0:e.states)?void 0:t.planned)?void 0:a.assignmentMap)instanceof Map&&this.stateManager.states.planned.assignmentMap.clear(),(null==(i=null==(n=null==(s=this.stateManager)?void 0:s.states)?void 0:n.actual)?void 0:i.assignmentMap)instanceof Map&&this.stateManager.states.actual.assignmentMap.clear(),this._resetEditedCellsState()}_resetEditedCellsState(){this.state.modifiedCells instanceof Map?this.state.modifiedCells.clear():this.state.modifiedCells=new Map,this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides.clear():this.state.cellVolumeOverrides=new Map,this.state.cellValidationMap instanceof Map?this.state.cellValidationMap.clear():this.state.cellValidationMap=new Map,this.state.validationWarningRows instanceof Set?this.state.validationWarningRows.clear():this.state.validationWarningRows=new Set,this.state.saveErrorRows instanceof Set?this.state.saveErrorRows.clear():this.state.saveErrorRows=new Set,this.state.showCompletionWarnings=!1}_persistWeekBoundarySettings(e,t){var a;const s=null==(a=this.state.apiEndpoints)?void 0:a.weekBoundary;s&&(this._weekBoundarySaveTimer&&clearTimeout(this._weekBoundarySaveTimer),this._pendingWeekBoundary={weekStartDay:e,weekEndDay:t},this._weekBoundarySaveTimer=window.setTimeout(()=>{this._weekBoundarySaveTimer=null;const a=this._pendingWeekBoundary||{weekStartDay:e,weekEndDay:t};this._pendingWeekBoundary=null;const n=JSON.stringify({week_start_day:a.weekStartDay,week_end_day:a.weekEndDay});fetch(s,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:n}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{const t=void 0!==(null==e?void 0:e.week_start_day)?e.week_start_day:a.weekStartDay,s=void 0!==(null==e?void 0:e.week_end_day)?e.week_end_day:a.weekEndDay;this.state.weekStartDay=t,this.state.weekEndDay=s,this._regenerateTimeline({mode:"weekly",weekStartDay:t,weekEndDay:s})}).catch(e=>{console.warn("[JadwalKegiatanApp] Failed to persist week boundary setting",e)})},500))}_regenerateTimeline(){return d(this,arguments,function*(e={}){var t;if(this.dataOrchestrator&&"function"==typeof this.dataOrchestrator.regenerateTimeline)return this.dataOrchestrator.regenerateTimeline(e);const{mode:a="weekly",weekStartDay:s,weekEndDay:n}=e,i=null==(t=this.state.apiEndpoints)?void 0:t.regenerateTahapan;if(!i)return;if(this._isRegeneratingTimeline)return void(this._queuedRegeneratePayload={mode:a,weekStartDay:s,weekEndDay:n});if(this.state.isDirty&&this.state.modifiedCells instanceof Map&&this.state.modifiedCells.size>0){if(!window.confirm("Mengubah batas minggu akan me-refresh data dan membatalkan perubahan yang belum disimpan. Lanjutkan?"))return;this._resetEditedCellsState(),this.state.isDirty=!1}this._isRegeneratingTimeline=!0,this.state.isLoading=!0;const o="monthly"===a?"Mengatur ulang struktur bulanan...":"Mengatur ulang struktur minggu...";this._updateStatusBar(o);const l="monthly"===a?"Mengatur ulang kolom monthly...":"Mengatur ulang kolom weekly sesuai preferensi Anda...";this.showToast(l,"info",2400);try{const e=yield fetch(i,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},body:JSON.stringify(r({mode:a},"weekly"===a?{week_start_day:"number"==typeof s?s:this._getWeekStartDay(),week_end_day:"number"==typeof n?n:this._getWeekEndDay()}:{}))});if(!e.ok)throw new Error(`HTTP ${e.status}`);this._invalidateCachedDataset(),yield this._loadInitialData({forceReload:!0});const t="monthly"===a?"Struktur monthly diperbarui (read-only)":"Periode minggu diperbarui";this.showToast(t,"success",2200)}catch(d){console.error("[JadwalKegiatanApp] Failed to regenerate weekly structure",d),this.showToast("Gagal memperbarui struktur waktu","danger",3200)}finally{if(this.state.isLoading=!1,this._updateStatusBar(),this._isRegeneratingTimeline=!1,this._queuedRegeneratePayload){const e=this._queuedRegeneratePayload;this._queuedRegeneratePayload=null,this._regenerateTimeline(e)}}})}_formatWeekdayLabel(e){const t=this._normalizePythonWeekday(e,0);return["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu","Minggu"][t]||`Day ${t}`}_syncToolbarRadios(){var e;(null==(e=this.uxManager)?void 0:e.syncToolbarRadios)&&this.uxManager.syncToolbarRadios()}_handleDisplayModeChange(e){const t=(e||"").toLowerCase();if(!new Set(["percentage","volume","cost"]).has(t)||this.state.inputMode===t)return;if("cost"===t&&"actual"!==(this.state.progressMode||"planned"))return this.showToast("Mode biaya hanya tersedia saat melihat Realisasi","warning",2600),void this._syncToolbarRadios();this.state.inputMode=t,this.state.displayMode=t,this.gridManager&&this.gridManager.setInputMode(t),this._syncGridViews();let a="Persentase";"volume"===t?a="Volume":"cost"===t&&(a="Biaya"),this.showToast(`Mode input diubah ke ${a}`,"info",2200)}_handleProgressModeChange(e){const t=(e||"").toLowerCase();if(!new Set(["planned","actual"]).has(t)||this.state.progressMode===t)return;const a=this.state.progressMode;console.log(`[ModeChange] Switching progress mode from ${a} to ${t}`);const s=this.stateManager.states[a].getStats();this._suppressStateManagerEvent=!0,this.stateManager.switchMode(t),this._suppressStateManagerEvent=!1;const n=this.stateManager.states[t].getStats();console.log("[ModeChange] State switch complete:"),console.log(`  - Old ${a.toUpperCase()}: ${s.modifiedCount} modified, ${s.assignmentCount} assignments`),console.log(`  - New ${t.toUpperCase()}: ${n.modifiedCount} modified, ${n.assignmentCount} assignments`),this._applyProgressModeSwitch(t,{showToast:!0})}_applyProgressModeSwitch(e,t={}){const a="actual"===e?"actual":"planned",s=this.state.inputMode||"percentage";if(this.state.progressMode=a,"actual"!==a&&"cost"===this.state.inputMode&&(this.state.inputMode="percentage",this.state.displayMode="percentage"),this.gridManager&&"function"==typeof this.gridManager.setInputMode){const e=this.state.inputMode||"percentage";e!==s&&this.gridManager.setInputMode(e)}if(this._syncToolbarRadios(),this._updateCostToggleAvailability(),this._updateProgressModeIndicator(a),this._syncGridViews(),this._updateCharts(),t.showToast){const e="planned"===a?"Rencana":"Realisasi";this.showToast(`Mode progress diubah ke ${e}`,"info",2200)}}_updateProgressModeIndicator(e){const t=document.getElementById("progress-mode-indicator");if(!t)return;const a="actual"===e?"actual":"planned",s="planned"===a?"Rencana":"Realisasi",n="planned"===a?"bg-info":"bg-warning";t.textContent=`Mode: ${s}`,t.className=`badge ${n} ms-2`,t.style.cssText="font-size: 0.75rem; vertical-align: middle;"}_updateCostToggleAvailability(){const e=document.getElementById("mode-cost");if(!e)return;const t="actual"===(this.state.progressMode||"planned");if(e.disabled=!t,!t&&e.checked){const e=document.getElementById("mode-percentage");e&&(e.checked=!0)}}_handleTimeScaleChange(e){const t=(e||"").toLowerCase();if(!new Set(["weekly","monthly"]).has(t))return this._syncToolbarRadios(),void this.showToast("Mode waktu ini belum aktif pada fase saat ini","warning",3200);(this.state.displayScale||this.state.timeScale||"weekly")!==t?(this.state.displayScale=t,this._syncToolbarRadios(),this._syncGridViews(),this._renderGrid(),this._updateCharts(),"weekly"===t?this.showToast("Time scale diatur ke Weekly","info",2e3):this.showToast("Time scale diatur ke Monthly (akumulasi 4 minggu, read-only)","info",2600)):this._syncToolbarRadios()}_initTanStackGridIfNeeded(){const e=this.state.domRefs.tanstackGridContainer;e?(this._gridContainerParent||(this._gridContainerParent=e.parentNode||null,this._gridContainerNextSibling=e.nextSibling||null),e.classList.remove("d-none"),this.state.useUnifiedTable?this.unifiedManager||(this.unifiedManager=new C(this.state,{showToast:this.showToast.bind(this),onCellChange:e=>this._handleGridCellChange(e),getCellValidationState:e=>this._getCellValidationState(e),debugUnifiedTable:this.state.debugUnifiedTable}),this.unifiedManager.mount(e,{topScroll:this.state.domRefs.tanstackGridTopScroll,topScrollInner:this.state.domRefs.tanstackGridTopScrollInner,body:this.state.domRefs.tanstackGridBody})):this.gridManager||(this.gridManager=new c(this.state,{showToast:this.showToast.bind(this),onCellChange:e=>this._handleGridCellChange(e),getCellValidationState:e=>this._getCellValidationState(e)}),this.gridManager.mount(e,{topScroll:this.state.domRefs.tanstackGridTopScroll,topScrollInner:this.state.domRefs.tanstackGridTopScrollInner,body:this.state.domRefs.tanstackGridBody}))):console.warn("[JadwalKegiatanApp] TanStack grid container not available")}_loadInitialData(){return d(this,arguments,function*(e={}){var t,a,s,n,i,o,r,l,d,h,c,u;if(this.dataOrchestrator&&"function"==typeof this.dataOrchestrator.loadInitialData)return this.dataOrchestrator.loadInitialData(e);const{forceReload:g=!1}=e;if(!g&&(null==(t=this.state.pekerjaanTree)?void 0:t.length)>0)return console.log("[JadwalKegiatanApp] Using template dataset"),console.log("Preloaded pekerjaanTree items:",this.state.pekerjaanTree.length),console.log("Preloaded tahapanList items:",(null==(a=this.state.tahapanList)?void 0:a.length)||0),console.log("Preloaded timeColumns items:",(null==(s=this.state.timeColumns)?void 0:s.length)||0),this._recalculateAllProgressTotals(),void this._syncGridViews();this._showSkeleton("grid"),this.state.apiBase=(null==(n=this.state.apiEndpoints)?void 0:n.tahapan)||`/detail_project/api/project/${this.state.projectId}/tahapan/`,this.dataLoader=new DataLoader(this.state),this.timeColumnGenerator=new _(this.state),this.saveHandler=new SaveHandler(this.state,{apiUrl:(null==(i=this.state.apiEndpoints)?void 0:i.save)||`/detail_project/api/project/${this.state.projectId}/pekerjaan/assign_weekly/`,onSuccess:e=>this._onSaveSuccess(e),onError:e=>this._onSaveError(e),showToast:(e,t)=>this.showToast(e,t),dataLoader:this.dataLoader}),this.state.isLoading=!0;try{console.log("[JadwalKegiatanApp] Loading data using modern DataLoader..."),yield this.dataLoader.loadAllData({skipIfLoaded:!1,force:g}),this.timeColumnGenerator.generate();const e=(this.state.displayScale||this.state.timeScale||"weekly").toLowerCase();if(!this._isEnforcingWeekly&&"weekly"===e){const e=this._countWeeklyColumns(),t=this._estimateExpectedWeeklyColumns(),a=((null==(r=null==(o=this.state.timeColumns)?void 0:o[0])?void 0:r.generationMode)||(null==(d=null==(l=this.state.timeColumns)?void 0:l[0])?void 0:d.type)||"").toLowerCase();if(0===e||"monthly"===a||t>0&&e>0&&e<t)return console.warn("[JadwalKegiatanApp] Weekly columns incomplete; regenerating weekly structure based on project timeline..."),this._isEnforcingWeekly=!0,yield this._regenerateTimeline({mode:"weekly",weekStartDay:this._getWeekStartDay(),weekEndDay:this._getWeekEndDay()}),void(this._isEnforcingWeekly=!1)}yield this.dataLoader.loadAssignments(),this._recalculateAllProgressTotals(),yield this._loadKurvaSData(),this.state.dependencies=this.state.dependencies||[],this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),console.log("[JadwalKegiatanApp] âœ… Data loaded successfully:",`${(null==(h=this.state.flatPekerjaan)?void 0:h.length)||0} pekerjaan,`,`${(null==(c=this.state.tahapanList)?void 0:c.length)||0} tahapan,`,`${(null==(u=this.state.timeColumns)?void 0:u.length)||0} columns`),this._initializeCharts(),this._updateCharts()}catch(p){console.error("[JadwalKegiatanApp] âŒ Failed to load data:",p),this.state.error=p,this.showToast("Gagal memuat data: "+p.message,"danger")}finally{this.state.isLoading=!1,this._syncGridViews(),this._hideSkeleton("grid")}})}_loadKurvaSData(){return d(this,null,function*(){var e;try{const t=`/detail_project/api/v2/project/${this.state.projectId}/kurva-s-data/`;console.log("[JadwalKegiatanApp] Loading Kurva S harga data from:",t);const a=yield fetch(t,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const s=yield a.json();if(this.state.hargaMap=new Map(Object.entries(s.hargaMap||{}).map(([e,t])=>[e,parseFloat(t)||0])),this.state.totalBiayaProject=parseFloat(s.totalBiayaProject||0),this.state.pekerjaanMeta=s.pekerjaanMeta||{},s.volumeMap&&Object.keys(s.volumeMap).length>0){0===((null==(e=this.state.volumeMap)?void 0:e.size)||0)&&(this.state.volumeMap=new Map(Object.entries(s.volumeMap).map(([e,t])=>[e,parseFloat(t)||0])))}console.log("[JadwalKegiatanApp] âœ… Kurva S data loaded:",{hargaCount:this.state.hargaMap.size,totalBiaya:this.state.totalBiayaProject,totalBiayaFormatted:`Rp ${this.state.totalBiayaProject.toLocaleString("id-ID")}`})}catch(t){console.error("[JadwalKegiatanApp] âš ï¸ Failed to load Kurva S data:",t),this.state.hargaMap=this.state.hargaMap||new Map,this.state.totalBiayaProject=this.state.totalBiayaProject||0,this.state.pekerjaanMeta=this.state.pekerjaanMeta||{},console.warn("[JadwalKegiatanApp] Kurva S will use fallback calculation")}})}_loadChartModules(){return d(this,null,function*(){if(!this._chartModulesLoaded&&!this._chartModulesLoading)if(this.state.useUPlotKurva){this._chartModulesLoading=!0,console.log("ðŸ“Š Loading chart modules (lazy)...");try{const e=yield h(()=>import("./chart-modules-C7fXYRml.js").then(e=>e.u),__vite__mapDeps([0,1,2]));this.KurvaSChartClass=e.KurvaSUPlotChart||e.default,this._chartModulesLoaded=!0,this._chartModulesLoading=!1,console.log("âœ… Chart modules loaded"),this._initializeChartsAfterLoad()}catch(e){console.error("âŒ Failed to load chart modules:",e),this._chartModulesLoading=!1,m.error("Failed to load chart modules")}}else console.warn("[JadwalKegiatanApp] uPlot dimatikan, melewati inisialisasi chart")})}_initializeChartsAfterLoad(){var e;if(this.chartCoordinator)return this.chartCoordinator.initializeChartsAfterLoad();if(console.log("[JadwalKegiatanApp] Initializing charts after load..."),this.state.useUnifiedTable)console.log("[JadwalKegiatanApp] Skipping legacy Kurva-S chart (using unified overlay)");else{if((null==(e=this.state.domRefs)?void 0:e.scurveChart)&&this.KurvaSChartClass)try{this.kurvaSChart=new this.KurvaSChartClass(this.state,{useIdealCurve:!0,steepnessFactor:.8,smoothCurves:!0,showArea:!0,enableCostView:!0});if(this.kurvaSChart.initialize(this.state.domRefs.scurveChart)){console.log("[JadwalKegiatanApp] Kurva-S chart initialized"),this._setupCostViewToggle();const e=this._activateDefaultCostView();e&&"function"==typeof e.catch&&e.catch(e=>{console.warn("[JadwalKegiatanApp] Failed to auto-enable cost view:",e)})}}catch(t){console.warn("[JadwalKegiatanApp] Failed to initialize Kurva-S chart:",t)}console.log("[JadwalKegiatanApp] âš ï¸ OLD Gantt Chart initialization SKIPPED (replaced by new design)")}}_initializeRedesignedGantt(e=0){return d(this,null,function*(){if(this.chartCoordinator)return this.chartCoordinator._initializeRedesignedGantt(e);console.log("[JadwalKegiatanApp] Rendering Gantt via unified table overlay"),0===e&&(yield new Promise(e=>setTimeout(e,100)));const t=document.getElementById("gantt-redesign-container");if(!t)return console.warn(`[JadwalKegiatanApp] â³ Gantt container not found (attempt ${e+1}/3)`),e<3?(console.log("[JadwalKegiatanApp] Retrying in 200ms..."),yield new Promise(e=>setTimeout(e,200)),this._initializeRedesignedGantt(e+1)):(console.error("[JadwalKegiatanApp] âŒ Gantt container not found after retries"),console.error("[JadwalKegiatanApp] DOM state:",{ganttView:document.getElementById("gantt-view"),ganttTab:document.getElementById("gantt-tab")}),void m.error("Failed to find Gantt container"));try{yield this._initializeUnifiedGanttOverlay(t)}catch(a){throw console.error("[JadwalKegiatanApp] âŒ Failed to initialize Gantt:",a),console.error("[JadwalKegiatanApp] Error stack:",a.stack),m.error("Failed to load Gantt Chart"),a}})}_initializeUnifiedGanttOverlay(e){return d(this,null,function*(){if(this.chartCoordinator)return this.chartCoordinator._initializeUnifiedGanttOverlay(e);if(this.unifiedManager||this._initTanStackGridIfNeeded(),!this.unifiedManager)return void console.warn("[JadwalKegiatanApp] Unified manager not available for Gantt overlay");const t=this._ensureGanttHost(e);if(!t)return void console.warn("[JadwalKegiatanApp] Unable to prepare Gantt host for unified overlay");const a={tree:this.state.pekerjaanTree||[],timeColumns:this._getDisplayTimeColumns(),inputMode:this.state.inputMode||"percentage",timeScale:this.state.displayScale||this.state.timeScale||"weekly",dependencies:this.state.dependencies||[]};this.state.debugUnifiedTable&&console.log("[UnifiedGanttOverlay] Apply payload",{rows:a.tree.length,columns:a.timeColumns.length,deps:a.dependencies.length}),this.unifiedManager.updateData(a),this.unifiedManager.switchMode("gantt"),this._applyGanttOverlayStyles(t)})}_applyGanttOverlayStyles(e){if(this.chartCoordinator)return this.chartCoordinator._applyGanttOverlayStyles(e);if(!e)return;e.classList.add("gantt-overlay-mode");const t="gantt-overlay-style";if(!document.getElementById(t)){const e=document.createElement("style");e.id=t,e.textContent="\n        /* Biarkan header/frozen columns tetap tampil untuk konteks */\n        .gantt-overlay-mode .tanstack-grid-header { display: block !important; }\n        /* Sembunyikan konten text pada sel time-column saja, jangan menggangu pinned kolom */\n        .gantt-overlay-mode .tanstack-grid-cell.time-cell { color: transparent; }\n        .gantt-overlay-mode .tanstack-grid-cell.time-cell * { visibility: hidden; }\n        .gantt-overlay-mode .tanstack-grid-cell.time-cell { pointer-events: none; }\n        /* Izinkan scroll tetap berjalan */\n        .gantt-overlay-mode .tanstack-grid-body { overflow: auto; }\n      ",document.head.appendChild(e)}}_ensureGanttHost(e){if(this.chartCoordinator)return this.chartCoordinator._ensureGanttHost(e);if(!e)return null;let t=e.querySelector(".unified-gantt-host");return t?t.innerHTML="":(t=document.createElement("div"),t.className="unified-gantt-host",t.style.position="relative",t.style.minHeight="420px",t.style.width="100%",e.innerHTML="",e.appendChild(t)),this._moveGridContainerTo(t),t}_moveGridContainerTo(e){var t,a;if(this.chartCoordinator)return this.chartCoordinator._moveGridContainerTo(e);const s=null==(a=null==(t=this.state)?void 0:t.domRefs)?void 0:a.tanstackGridContainer;s&&e&&s.parentNode!==e&&e.appendChild(s)}_restoreGridContainerPosition(){var e,t;if(this.chartCoordinator)return this.chartCoordinator._restoreGridContainerPosition();const a=null==(t=null==(e=this.state)?void 0:e.domRefs)?void 0:t.tanstackGridContainer,s=this._gridContainerParent;a&&s&&a.parentNode!==s&&(this._gridContainerNextSibling&&this._gridContainerNextSibling.parentNode===s?s.insertBefore(a,this._gridContainerNextSibling):s.appendChild(a))}_prepareGanttData(){var e;if(this.chartCoordinator)return this.chartCoordinator._prepareGanttData();const t=[];if((null==(e=this.state)?void 0:e.flatPekerjaan)&&Array.isArray(this.state.flatPekerjaan)){const e=this.state.flatPekerjaan.filter(e=>"pekerjaan"===e.type);console.log(`[JadwalKegiatanApp] Transforming ${e.length} pekerjaan nodes for Gantt (filtered from ${this.state.flatPekerjaan.length} total nodes)`),e.length>0&&console.log("[JadwalKegiatanApp] Sample pekerjaan node:",e[0]),e.forEach(e=>{let a=0,s=0;if(this.stateManager){const t=this.state.tahapanList||[],n=t.length;if(n>0){let i=0,o=0;t.forEach(t=>{const a=this.stateManager.getCellValue(e.id,t.column_id,"planned"),s=this.stateManager.getCellValue(e.id,t.column_id,"actual");i+=a||0,o+=s||0}),a=Math.round(i/n),s=Math.round(o/n)}}t.push({klasifikasi_id:e.klasifikasi_id,klasifikasi_name:e.klasifikasi_name||"Unknown Klasifikasi",klasifikasi_kode:e.klasifikasi_kode||"",sub_klasifikasi_id:e.sub_klasifikasi_id,sub_klasifikasi_name:e.sub_klasifikasi_name||"Unknown Sub-Klasifikasi",sub_klasifikasi_kode:e.sub_klasifikasi_kode||"",pekerjaan_id:e.id,pekerjaan_name:e.nama||e.name||"Unknown Pekerjaan",pekerjaan_kode:e.kode||"",tgl_mulai_rencana:e.tgl_mulai_rencana||this.state.projectStart,tgl_selesai_rencana:e.tgl_selesai_rencana||this.state.projectEnd,tgl_mulai_realisasi:e.tgl_mulai_realisasi||this.state.projectStart,tgl_selesai_realisasi:e.tgl_selesai_realisasi||this.state.projectEnd,progress_rencana:a,progress_realisasi:s,volume:e.volume||0,satuan:e.satuan||""})})}else console.warn("[JadwalKegiatanApp] No flatPekerjaan data available for Gantt");const a={project_id:this.state.projectId,project_name:this.state.projectName||"Project",start_date:this.state.projectStart,end_date:this.state.projectEnd};return console.log(`[JadwalKegiatanApp] Prepared ${t.length} nodes for Gantt Chart`),{data:t,project:a,milestones:[]}}_initializeCharts(){if(this.chartCoordinator)return this.chartCoordinator.initializeCharts();this._setupLazyChartLoading(),this._bindUnifiedTabSync()}_setupLazyChartLoading(){if(this.chartCoordinator)return this.chartCoordinator._setupLazyChartLoading()}_updateChartsThrottled(){if(this.chartCoordinator)return this.chartCoordinator.updateChartsThrottled()}_updateCharts(){if(this.chartCoordinator)return this.chartCoordinator.updateCharts()}_renderGanttSummary(){console.log("[JadwalKegiatanApp] âš ï¸ _renderGanttSummary() SKIPPED (old Gantt method)")}_renderGanttTree(){console.log("[JadwalKegiatanApp] âš ï¸ _renderGanttTree() SKIPPED (old Gantt method)")}_attachGanttScrollSync(){var e,t,a;const s=null==(e=this.state.domRefs)?void 0:e.ganttTreeScroll,n=null==(t=this.state.domRefs)?void 0:t.ganttChartWrapper;if(!s||!n)return;const i=n.querySelector(".gantt-container");if(!i)return;if((null==(a=this._ganttScrollSyncHandlers)?void 0:a.scrollEl)&&this._ganttScrollSyncHandlers.scrollEl!==i&&(this._ganttScrollSyncHandlers.scrollEl.removeEventListener("scroll",this._ganttScrollSyncHandlers.scrollHandler),s.removeEventListener("wheel",this._ganttScrollSyncHandlers.wheelHandler),this._ganttScrollSyncHandlers=null),this._ganttScrollSyncHandlers)return void(s.scrollTop=i.scrollTop);const o=()=>{s.scrollTop=i.scrollTop},r=e=>{0!==e.deltaY&&(i.scrollTop+=e.deltaY)};i.addEventListener("scroll",o),s.addEventListener("wheel",r,{passive:!0}),this._ganttScrollSyncHandlers={scrollEl:i,scrollHandler:o,wheelHandler:r}}_escapeHtml(e){return null==e?"":String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]||e))}saveChanges(){return d(this,null,function*(){if(!this.saveHandler)return console.error("[JadwalKegiatanApp] SaveHandler not initialized"),void m.error("Save handler not initialized");if(!this._validateRowTotalsBeforeSave())return void m.warning("Please fix validation errors before saving");const e=this.state.domRefs.saveButton;e&&y.setLoading(e,"Saving...");try{const t=yield this.saveHandler.save();t.success?(this._renderGrid(),this._recalculateAllProgressTotals(),e&&y.setSuccess(e,2e3),m.success("Changes saved successfully!")):(e&&y.setError(e,2e3),m.error(t.message||"Failed to save changes"))}catch(t){console.error("[JadwalKegiatanApp] Save error:",t),e&&y.setError(e,2e3),m.error("An error occurred while saving")}})}_onSaveSuccess(e){console.log("[JadwalKegiatanApp] Save completed successfully"),this.state.isDirty=!1,this._clearSaveErrorRows();const t="actual"===(this.state.progressMode||"planned").toLowerCase()?"Perubahan realisasi tersimpan":"Perubahan perencanaan tersimpan";this._updateStatusBar(t),this._clearApiFailedRows(),this._renderGrid(),this._recalculateAllProgressTotals(),this._updateCharts()}_onSaveError(e){console.error("[JadwalKegiatanApp] Save failed:",e),this._markFailedRowsFromError(e)}refresh(){return d(this,null,function*(){if(this.state.isDirty){if(!confirm("Ada perubahan yang belum disimpan. Yakin ingin refresh?"))return}console.log("Refreshing data..."),this._resetEditedCellsState(),this.state.isDirty=!1,yield this._loadInitialData({forceReload:!0}),this.showToast("Data berhasil di-refresh","success")})}showToast(e,t="info",a=3e3){if("function"==typeof window.showToast)return void window.showToast(e,t,a);console.log(`[${t.toUpperCase()}] ${e}`);const s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.classList.add("show")},10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},a)}_buildTimeColumns(e=[]){return Array.isArray(e)?e.map((e,t)=>{var a;const s=null!=(a=null==e?void 0:e.id)?a:`tahapan-${t+1}`,n=`col_${String(s).replace(/[^a-zA-Z0-9_-]/g,"_")}`,i=(null==e?void 0:e.nama)||(null==e?void 0:e.name)||`Tahapan ${t+1}`,o="number"==typeof(null==e?void 0:e.urutan)?e.urutan:Number.parseInt(null==e?void 0:e.urutan,10)||t;return{id:s,fieldId:n,label:i,order:o,weekNumber:o+1,startDate:(null==e?void 0:e.tanggal_mulai)||(null==e?void 0:e.start_date)||(null==e?void 0:e.startDate)||null,endDate:(null==e?void 0:e.tanggal_selesai)||(null==e?void 0:e.end_date)||(null==e?void 0:e.endDate)||null,isAutoGenerated:Boolean(null==e?void 0:e.is_auto_generated),generationMode:(null==e?void 0:e.generation_mode)||null}}):[]}_createTimeColumnIndex(e=[]){const t={};return(e||[]).forEach(e=>{const a=e.fieldId||e.id;a&&(t[a]=e)}),t}_getDefaultSaveEndpoint(){var e;const t=null==(e=this.state)?void 0:e.projectId;return t?`/detail_project/api/v2/project/${t}/assign-weekly/`:""}_fetchJson(e){return d(this,arguments,function*(e,t={}){if(!e)throw new Error("URL tidak boleh kosong saat memanggil _fetchJson");const a=yield fetch(e,r({credentials:"same-origin"},t));if(!a.ok){const e=yield a.text().catch(()=>"");throw new Error(e||`HTTP ${a.status}: ${a.statusText}`)}return a.json()})}_syncGridViews(){const e=this._getDisplayTimeColumns();this.state.activeTimeColumns=e,this.state.dependencies=this.state.dependencies||[];const t={tree:this.state.pekerjaanTree||[],timeColumns:e,inputMode:this.state.inputMode||"percentage",timeScale:this.state.displayScale||this.state.timeScale||"weekly",dependencies:this.state.dependencies||[]};this.state.useUnifiedTable&&this.unifiedManager?(this.state.debugUnifiedTable&&console.log("[UnifiedTab] Sync grid payload",{rows:t.tree.length,columns:t.timeColumns.length,deps:t.dependencies.length,mode:this.state.progressMode,displayScale:this.state.displayScale||this.state.timeScale}),this.unifiedManager.updateData(t)):this.gridManager&&(this.gridManager.updateData(t),"function"==typeof this.gridManager.updateTopScrollMetrics&&this.gridManager.updateTopScrollMetrics()),this._updateStatusBar()}_renderGrid(){this.state.useUnifiedTable&&(this.unifiedManager||this._initTanStackGridIfNeeded(),this.unifiedManager)||this.gridManager?this._syncGridViews():"function"==typeof this._renderLegacyGrid&&this._renderLegacyGrid()}_clearApiFailedRows(){this.state.apiFailedRows instanceof Set&&this.state.apiFailedRows.size>0&&(this.state.apiFailedRows.clear(),this._refreshFailedRowsUnion())}_markFailedRowsFromIds(e){e instanceof Set&&0!==e.size?(this.state.apiFailedRows=new Set(Array.from(e)),this._refreshFailedRowsUnion()):this._clearApiFailedRows()}_setSaveErrorRows(e){this.state.saveErrorRows instanceof Set||(this.state.saveErrorRows=new Set);const t=e instanceof Set?Array.from(e):[];this.state.saveErrorRows=new Set(t.map(e=>Number(e))),this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles()}_clearSaveErrorRows(){this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.size>0&&(this.state.saveErrorRows.clear(),this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles())}_clearSaveErrorForRow(e){if(!(e&&this.state.saveErrorRows instanceof Set&&0!==this.state.saveErrorRows.size))return;this.state.saveErrorRows.delete(Number(e))&&this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles()}_markFailedRowsFromError(e){const t=this._extractPekerjaanIdsFromError(e);this._markFailedRowsFromIds(t)}_extractPekerjaanIdsFromError(e){const t=new Set,a=(e=[])=>{e.forEach(e=>{var a,s;const n=(null==e?void 0:e.pekerjaan_id)||(null==e?void 0:e.pekerjaanId)||(null==(a=null==e?void 0:e.item)?void 0:a.pekerjaan_id)||(null==(s=null==e?void 0:e.item)?void 0:s.pekerjaanId)||null;n&&t.add(Number(n))})};return Array.isArray(null==e?void 0:e.validationErrors)&&a(e.validationErrors),Array.isArray(null==e?void 0:e.details)&&a(e.details),t}_getContainerValue(e,t){return e&&t?e instanceof Map?e.has(t)?e.get(t):null:"object"==typeof e&&Object.prototype.hasOwnProperty.call(e,t)?e[t]:null:null}_calculateRowTotalPercent(e){if(!e)return 0;const t=this.state.timeColumns||[],a=this.state.modifiedCells instanceof Map?this.state.modifiedCells:null,s=this.state.assignmentMap;let n=0;return t.forEach(t=>{const i=t.fieldId||t.id;if(!i)return;const o=`${e}-${i}`;let r=null;r=a&&a.has(o)?a.get(o):this._getContainerValue(s,o);const l=Number(r);Number.isFinite(l)&&(n+=l)}),Number(n.toFixed(2))}_calculateRowTotalVolume(e){if(!e)return 0;const t=this._getRowVolume(e),a=Array.isArray(this.state.timeColumns)?this.state.timeColumns:[],s=this.state.modifiedCells instanceof Map?this.state.modifiedCells:null,n=this.state.assignmentMap,i=this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides:null;let o=0;return a.forEach(a=>{const r=a.fieldId||a.id;if(!r)return;const l=`${e}-${r}`;let d=null;if(i&&i.has(l)){const e=Number(i.get(l));Number.isFinite(e)&&(d=e)}if(null===d){let e=null;s&&s.has(l)?e=Number(s.get(l)):n&&(e=Number(this._getContainerValue(n,l))),Number.isFinite(e)&&Number.isFinite(t)&&t>0&&(d=e/100*t)}Number.isFinite(d)&&(o+=d)}),Number(o.toFixed(3))}_setCellVolumeOverride(e,t){if(!e)return;this.state.cellVolumeOverrides instanceof Map||(this.state.cellVolumeOverrides=new Map);const a=Number(t);Number.isFinite(a)?this.state.cellVolumeOverrides.set(e,Number(a.toFixed(3))):this.state.cellVolumeOverrides.has(e)&&this.state.cellVolumeOverrides.delete(e)}_clearCellVolumeOverride(e){e&&this.state.cellVolumeOverrides instanceof Map&&0!==this.state.cellVolumeOverrides.size&&this.state.cellVolumeOverrides.delete(e)}_updateCellValidationState(e,t){if(!e)return;this.state.cellValidationMap instanceof Map||(this.state.cellValidationMap=new Map);const a=this.state.cellValidationMap.get(e)||null,s=t&&!1===t.isValid?"warning"===t.level?"warning":"error":null;let n=!1;s?a!==s&&(this.state.cellValidationMap.set(e,s),n=!0):a&&(this.state.cellValidationMap.delete(e),n=!0),n&&this.gridManager&&"function"==typeof this.gridManager.refreshCells&&this.gridManager.refreshCells()}_getCellValidationState(e){return e&&this.state.cellValidationMap instanceof Map&&this.state.cellValidationMap.get(e)||null}_updateProgressTotals(e){if(!e)return 0;this.state.progressTotals instanceof Map||(this.state.progressTotals=new Map);const t=this._calculateRowTotalPercent(e);return this.state.progressTotals.set(Number(e),t),this._updateAutoWarningRows(Number(e),t),this._updateCompletionWarningRows(Number(e),t),this._updateStatusBar(),t}_updateVolumeTotals(e,t=null,a={}){if(!e)return;this.state.volumeTotals instanceof Map||(this.state.volumeTotals=new Map);const s=this._calculateRowTotalVolume(e);this.state.volumeTotals.set(Number(e),s);const n=Number.isFinite(t)&&null!==t?Number(t):this.state.progressTotals instanceof Map?this.state.progressTotals.get(Number(e)):null,i=this._getRowVolume(e),o=!Number.isFinite(n)&&Number.isFinite(s)&&Number.isFinite(i)&&i>0?s/i*100:n;this._updateVolumeWarningRows(Number(e),s,{percentTotal:o,deferRefresh:a.deferRefresh})}_recalculateAllProgressTotals(){this.state.progressTotals instanceof Map?this.state.progressTotals.clear():this.state.progressTotals=new Map,this.state.volumeTotals instanceof Map?this.state.volumeTotals.clear():this.state.volumeTotals=new Map,this.state.cellVolumeOverrides instanceof Map?this.state.cellVolumeOverrides.clear():this.state.cellVolumeOverrides=new Map,this.state.autoWarningRows=new Set,this.state.volumeWarningRows=new Set,this.state.validationWarningRows=new Set,this.state.saveErrorRows=new Set;(Array.isArray(this.state.flatPekerjaan)?this.state.flatPekerjaan.filter(e=>"pekerjaan"===(null==e?void 0:e.type)&&e.id):[]).forEach(e=>{const t=this._calculateRowTotalPercent(e.id);this.state.progressTotals.set(Number(e.id),t),this._updateAutoWarningRows(Number(e.id),t,{deferRefresh:!0}),this._updateCompletionWarningRows(Number(e.id),t,{deferRefresh:!0}),this._updateVolumeTotals(Number(e.id),t,{deferRefresh:!0})}),this._refreshFailedRowsUnion(),this.state.showCompletionWarnings&&this.gridManager&&this.gridManager.refreshRowStyles(),this._updateStatusBar()}_refreshFailedRowsUnion(){const e=new Set;this.state.autoWarningRows instanceof Set&&this.state.autoWarningRows.forEach(t=>e.add(Number(t))),this.state.volumeWarningRows instanceof Set&&this.state.volumeWarningRows.forEach(t=>e.add(Number(t))),this.state.apiFailedRows instanceof Set&&this.state.apiFailedRows.forEach(t=>e.add(Number(t))),this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.forEach(t=>e.add(Number(t))),this.state.failedRows=e,this._updateSaveButtonState(),this.gridManager&&"function"==typeof this.gridManager.refreshRowStyles&&this.gridManager.refreshRowStyles()}_updateAutoWarningRows(e,t,a={}){if(!e)return;this.state.autoWarningRows instanceof Set||(this.state.autoWarningRows=new Set);let s=!1;t>100.01?this.state.autoWarningRows.has(e)||(this.state.autoWarningRows.add(e),s=!0):this.state.autoWarningRows.has(e)&&(this.state.autoWarningRows.delete(e),s=!0),s&&!a.deferRefresh&&this._refreshFailedRowsUnion()}_updateCompletionWarningRows(e,t,a={}){if(!e)return;this.state.validationWarningRows instanceof Set||(this.state.validationWarningRows=new Set);let s=!1;this.state.showCompletionWarnings&&Number.isFinite(t)&&t>.01&&t<99.99?this.state.validationWarningRows.has(e)||(this.state.validationWarningRows.add(e),s=!0):this.state.validationWarningRows.has(e)&&(this.state.validationWarningRows.delete(e),s=!0),s&&!a.deferRefresh&&this.gridManager&&this.gridManager.refreshRowStyles()}_recomputeCompletionWarnings(){this.state.validationWarningRows instanceof Set?this.state.validationWarningRows.clear():this.state.validationWarningRows=new Set,this.state.progressTotals instanceof Map?(this.state.progressTotals.forEach((e,t)=>{this._updateCompletionWarningRows(Number(t),e,{deferRefresh:!0})}),this.gridManager&&this.gridManager.refreshRowStyles()):this.gridManager&&this.gridManager.refreshRowStyles()}_updateVolumeWarningRows(e,t,a={}){if(!e)return;this.state.volumeWarningRows instanceof Set||(this.state.volumeWarningRows=new Set);const s=this._getRowVolume(e),n=a&&Number.isFinite(a.percentTotal)?Number(a.percentTotal):this.state.progressTotals instanceof Map?this.state.progressTotals.get(Number(e)):null,i=Number.isFinite(s)&&s>0?Math.max(.001*s,.01):.01;let o=!1;Number.isFinite(s)&&s>0?o=Number.isFinite(t)&&t>s+i:Number.isFinite(n)&&(o=n>i);let r=!1;o?this.state.volumeWarningRows.has(e)||(this.state.volumeWarningRows.add(e),r=!0):this.state.volumeWarningRows.has(e)&&(this.state.volumeWarningRows.delete(e),r=!0),r&&!a.deferRefresh&&this._refreshFailedRowsUnion()}_clearFailedRows(){this.state.autoWarningRows instanceof Set&&this.state.autoWarningRows.clear(),this.state.volumeWarningRows instanceof Set&&this.state.volumeWarningRows.clear(),this.state.failedRows instanceof Set&&this.state.failedRows.clear(),this.state.saveErrorRows instanceof Set&&this.state.saveErrorRows.clear(),this._refreshFailedRowsUnion()}_getRowVolume(e){var t;const a=null==(t=this.state)?void 0:t.volumeMap,s=Number(e);if(a instanceof Map&&a.has(s))return Number(a.get(s))||0;if(a&&"object"==typeof a){const e=String(s);if(Object.prototype.hasOwnProperty.call(a,e))return Number(a[e])||0}const n=Array.isArray(this.state.flatPekerjaan)&&this.state.flatPekerjaan.find(e=>Number(e.id)===s);return n&&void 0!==n.volume&&Number(n.volume)||0}_getRowCostCapacity(e){var t;const a=null==(t=this.state)?void 0:t.hargaMap,s=Number(e);if(a instanceof Map&&a.has(s))return Number(a.get(s))||0;if(a&&"object"==typeof a){const e=String(s);if(Object.prototype.hasOwnProperty.call(a,e))return Number(a[e])||0}const n=Array.isArray(this.state.flatPekerjaan)&&this.state.flatPekerjaan.find(e=>Number(e.id)===s);if(n){const e=["budgeted_cost","total_biaya","totalBiaya","total_cost","biaya"];for(const t of e)if(void 0!==n[t]){const e=Number(n[t]);if(Number.isFinite(e))return e}}return 0}_getMergedCostCells(e){const t=new Map;return(null==e?void 0:e.costAssignmentMap)instanceof Map&&e.costAssignmentMap.forEach((e,a)=>{const s=Number(e);Number.isFinite(s)&&t.set(a,s)}),(null==e?void 0:e.costModifiedCells)instanceof Map&&e.costModifiedCells.forEach((e,a)=>{const s=Number(e);Number.isFinite(s)&&t.set(a,s)}),t}_calculateAllCostTotals(){const e=new Map,t=this._getCurrentModeState();if(!t)return e;return this._getMergedCostCells(t).forEach((t,a)=>{const s=parseInt((a||"").split("-")[0],10);Number.isFinite(s)&&e.set(s,(e.get(s)||0)+Number(t))}),e}_formatCurrency(e){const t=Number(e)||0;return this._currencyFormatter||"undefined"==typeof Intl||(this._currencyFormatter=new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0})),this._currencyFormatter?this._currencyFormatter.format(t):`Rp ${t.toLocaleString("id-ID")}`}_validateRowTotalsBeforeSave(){if(!(this.state.progressTotals instanceof Map))return!0;this.state.showCompletionWarnings||(this.state.showCompletionWarnings=!0),this._recomputeCompletionWarnings();const e=[];this.state.progressTotals.forEach((t,a)=>{Number.isFinite(t)&&t>100.01&&e.push({type:"percent",pekerjaan_id:a,total:t})});const t=[];this.state.volumeTotals instanceof Map&&this.state.volumeTotals.forEach((e,a)=>{const s=this._getRowVolume(a),n=Number.isFinite(s)&&s>0?Math.max(.001*s,.01):.01,i=this.state.progressTotals instanceof Map&&this.state.progressTotals.has(a)?this.state.progressTotals.get(a):null,o=Number.isFinite(i)&&null!==i?Number(i):Number.isFinite(e)&&Number.isFinite(s)&&s>0?Number(e)/Number(s)*100:null;Number.isFinite(s)&&s>0?Number.isFinite(e)&&e>s+n&&t.push({type:"volume",pekerjaan_id:a,total:e,capacity:s}):Number.isFinite(o)&&o>n&&t.push({type:"volume",pekerjaan_id:a,total:e,capacity:s||0,missingCapacity:!0})});const a=[];if("actual"===(this.state.progressMode||"planned").toLowerCase()){this._calculateAllCostTotals().forEach((e,t)=>{if(!Number.isFinite(e))return;const s=this._getRowCostCapacity(t),n=Number.isFinite(s)&&s>0?Math.max(.001*s,1):1;Number.isFinite(s)&&s>0?e>s+n&&a.push({type:"cost",pekerjaan_id:t,total:e,capacity:s}):e>n&&a.push({type:"cost",pekerjaan_id:t,total:e,capacity:0,missingCapacity:!0})})}if(0===e.length&&0===t.length&&0===a.length)return this._clearFailedRows(),this._clearSaveErrorRows(),!0;const s=new Set,n=e.concat(t,a),i=n.slice(0,3).map(e=>(s.add(Number(e.pekerjaan_id)),"volume"===e.type?e.missingCapacity?`- Pekerjaan ${e.pekerjaan_id}: volume tidak dapat disimpan karena master volume 0`:`- Pekerjaan ${e.pekerjaan_id}: total volume ${e.total.toFixed(3)} > kapasitas ${e.capacity.toFixed(3)}`:"cost"===e.type?e.missingCapacity?`- Pekerjaan ${e.pekerjaan_id}: biaya aktual tidak dapat disimpan karena master biaya 0`:`- Pekerjaan ${e.pekerjaan_id}: total biaya ${this._formatCurrency(e.total)} > batas ${this._formatCurrency(e.capacity)}`:`- Pekerjaan ${e.pekerjaan_id}: total ${e.total.toFixed(2)}% > 100%`));return n.length>3&&i.push(`(+${n.length-3} lagi)`),this._markFailedRowsFromIds(s),this._setSaveErrorRows(s),this.showToast(`Tidak dapat menyimpan:\n${i.join("\n")}`,"danger",5e3),!1}_updateStatusBar(e="Ready"){var t,a,s;const n=(null==(t=this.state)?void 0:t.domRefs)||{};if(n.statusMessageEl||n.itemCountEl||n.modifiedCountEl||n.totalProgressEl){if(n.statusMessageEl&&"string"==typeof e&&(n.statusMessageEl.textContent=e),n.itemCountEl){const e=Array.isArray(null==(a=this.state)?void 0:a.flatPekerjaan)?this.state.flatPekerjaan.filter(e=>"pekerjaan"===(null==e?void 0:e.type)).length:0;n.itemCountEl.textContent=e.toLocaleString("id-ID")}if(n.modifiedCountEl){const e=(null==(s=this.state)?void 0:s.modifiedCells)instanceof Map?this.state.modifiedCells.size:0;n.modifiedCountEl.textContent=e.toLocaleString("id-ID")}if(n.totalProgressEl){const e=this._calculateProjectProgress();n.totalProgressEl.textContent=null===e?"-":`${e.toLocaleString("id-ID",{maximumFractionDigits:1})}%`}}}_calculateProjectProgress(){var e,t;if((null==(e=this.state)?void 0:e.progressTotals)instanceof Map&&this.state.progressTotals.size>0){let e=0;this.state.progressTotals.forEach(t=>{e+=Number(t)||0});const t=e/this.state.progressTotals.size;return Math.round(10*t)/10}if((null==(t=this.state)?void 0:t.assignmentMap)instanceof Map&&this.state.assignmentMap.size>0){const e=new Map;if(this.state.assignmentMap.forEach((t,a)=>{const[s]=`${a}`.split("-"),n=Number(t)||0,i=e.get(s)||0;e.set(s,i+n)}),e.size>0){let t=0;e.forEach(e=>{t+=e});const a=t/e.size;return Math.round(10*a)/10}}return null}_buildAssignmentsPayload(){if(!this.state.modifiedCells||0===this.state.modifiedCells.size)return[];const e=[],t=this.state.timeColumnIndex||{};return this.state.modifiedCells.forEach((a,s)=>{const n=this._parseCellKey(s);if(!(null==n?void 0:n.pekerjaanId)||!n.fieldId)return;const i=t[n.fieldId];if(!i)return void console.warn("[JadwalKegiatanApp] Column metadata not found for",n.fieldId);const o=parseFloat(a);if(Number.isNaN(o))return;const r=i.weekNumber||i.order+1||1;e.push({pekerjaan_id:Number(n.pekerjaanId),week_number:r,proportion:Number(o.toFixed(2)),tahapan_id:i.id||null})}),e}_getSaveMode(){var e;const t=((null==(e=this.state)?void 0:e.saveMode)||"weekly").toLowerCase();return new Set(["daily","weekly","monthly","custom"]).has(t)?t:"weekly"}_normalizePythonWeekday(e,t=0){const a=Number.isFinite(t)?(t%7+7)%7:0,s=Number(e);if(!Number.isFinite(s))return a;const n=s%7;return n<0?n+7:n}_getWeekStartDay(){var e;return Number.isFinite(Number(null==(e=this.state)?void 0:e.weekStartDay))?this._normalizePythonWeekday(this.state.weekStartDay,(this._getWeekEndDay()+1)%7):(this._getWeekEndDay()+1)%7}_getWeekEndDay(){var e;return this._normalizePythonWeekday(null==(e=this.state)?void 0:e.weekEndDay,6)}_getDisplayTimeColumns(){const e=Array.isArray(this.state.timeColumns)?this.state.timeColumns:[];if("monthly"!==(this.state.displayScale||this.state.timeScale||"weekly").toLowerCase())return e;const t=e.filter(e=>(e=>{var t;const a=(e.generationMode||e.type||"").toLowerCase();if("monthly"===a)return!1;if("weekly"===a||"week"===a||"wk"===a)return!0;if(Number.isFinite(Number(null!=(t=e.weekNumber)?t:e.week_number)))return!0;const s=(e.label||"").toLowerCase();return s.includes("week")||s.includes("minggu")})(e)),a=t.length>0?t:e;return this._buildMonthlyColumns(a)}_buildMonthlyColumns(e){var t,a,s,n,i,o,r,l,d,h,c,u,g,p;const m=[];for(let v=0;v<e.length;v+=4){const y=e.slice(v,v+4);if(!y.length)continue;const f=m.length,w=null!=(n=null!=(s=null==(t=y[0])?void 0:t.weekNumber)?s:null==(a=y[0])?void 0:a.order)?n:v+1,_=null!=(o=null==(i=y[y.length-1])?void 0:i.weekNumber)?o:w+y.length-1,b=(null==(r=y[0])?void 0:r.rangeLabel)||(null==(l=y[0])?void 0:l.label)||"",k=(null==(d=y[y.length-1])?void 0:d.rangeLabel)||(null==(h=y[y.length-1])?void 0:h.label)||"",C=`Month ${f+1}`,S=`Week ${w}-${_}`,M=this._coerceDate((null==(c=y[0])?void 0:c.startDate)||(null==(u=y[0])?void 0:u.start_date)),T=this._coerceDate((null==(g=y[y.length-1])?void 0:g.endDate)||(null==(p=y[y.length-1])?void 0:p.end_date)),E=this._formatShortRange(M,T);m.push({id:`month-${f+1}`,fieldId:`month_${f+1}`,label:C,rangeLabel:E||S,rangeText:E,startDate:M,endDate:T,tooltip:b&&k?`${b} â€” ${k}`:`${C}: Week ${w}-${_}`,generationMode:"monthly",type:"monthly",index:f,childColumns:y,readOnly:!0})}return m}_coerceDate(e){if(!e)return null;if(e instanceof Date)return Number.isNaN(e.getTime())?null:e;const t=new Date(e);return Number.isNaN(t.getTime())?null:t}_formatShortRange(e,t){const a=e=>{if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}`},s=a(e),n=a(t);return s&&n?`${s} - ${n}`:s||n||""}_parseCellKey(e){if(!e||"string"!=typeof e)return null;const t=e.indexOf("-");return-1===t?{pekerjaanId:e,fieldId:null}:{pekerjaanId:e.slice(0,t),fieldId:e.slice(t+1)}}_getCsrfToken(){const e="csrftoken";let t=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let s=0;s<a.length;s++){const n=a[s].trim();if(n.substring(0,10)===e+"="){t=decodeURIComponent(n.substring(10));break}}}return t}_handleGridCellChange({cellKey:e,value:t,columnMeta:a,displayValue:s,isVolumeMode:n,validation:i,pekerjaanId:o,columnId:r,valueType:l="percentage"}){if(!e)return;i&&this._updateCellValidationState(e,i);let d=t;"string"==typeof d&&(d=parseFloat(d)),Number.isNaN(d)&&(d=0);const h=this._getCurrentModeState(),c=this.state.progressMode||"planned",u="cost"===(l||(n?"volume":"percentage")).toLowerCase();if(console.log(`[CellChange] Mode: ${c.toUpperCase()}, Cell: ${e}, Value: ${d}`),u){if("actual"!==c)return void this.showToast("Biaya aktual hanya bisa diedit pada mode Realisasi","warning",2600);h.costModifiedCells.set(e,d),h.isDirty=!0}else h.modifiedCells.set(e,d),h.isDirty=!0;(null==a?void 0:a.fieldId)&&this.state.timeColumnIndex&&(this.state.timeColumnIndex[a.fieldId]=a||this.state.timeColumnIndex[a.fieldId]),n?this._setCellVolumeOverride(e,s):this._clearCellVolumeOverride(e);const g=this._parseCellKey(e),p=o||(null==g?void 0:g.pekerjaanId);if(p){this._clearSaveErrorForRow(Number(p));const e=this._updateProgressTotals(Number(p));this._updateVolumeTotals(Number(p),e)}u?console.log(`[CellChange] Cost map size: ${h.costModifiedCells.size}`):(console.log(`[CellChange] ${c.toUpperCase()} modifiedCells size: ${h.modifiedCells.size}`),this._updateChartsThrottled(),console.log("[CellChange] Real-time Kurva-S chart updated"))}_bindUnifiedTabSync(){if(!this.state.useUnifiedTable)return;const e=document.querySelector("#scurve-tab")||document.querySelector('[data-bs-target="#scurve-view"]'),t=document.querySelector("#gantt-tab")||document.querySelector('[data-bs-target="#gantt-view"]'),a=document.querySelector("#grid-tab")||document.querySelector('[data-bs-target="#grid-view"]');if(e){const t=()=>{var e,t;const a=document.getElementById("scurve-chart")||document.querySelector("#scurve-view .chart-container");a&&(null==(t=null==(e=this.state)?void 0:e.domRefs)?void 0:t.tanstackGridContainer)&&(a.innerHTML="",a.appendChild(this.state.domRefs.tanstackGridContainer),a.style.position="relative",a.style.minHeight="420px"),this.unifiedManager&&(this.unifiedManager.switchMode("kurva"),this.state.debugUnifiedTable&&console.log("[UnifiedTab] Switch -> kurva"))};e.addEventListener("shown.bs.tab",t),e.addEventListener("click",t)}if(t){const e=()=>{const e=document.getElementById("gantt-redesign-container");e?this._initializeUnifiedGanttOverlay(e):this.unifiedManager&&(this.unifiedManager.switchMode("gantt"),this.state.debugUnifiedTable&&console.log("[UnifiedTab] Switch -> gantt (no overlay host)"))};t.addEventListener("shown.bs.tab",e),t.addEventListener("click",e)}if(a){const e=()=>{this._restoreGridContainerPosition(),this.unifiedManager&&(this.unifiedManager.switchMode("grid"),this.state.debugUnifiedTable&&console.log("[UnifiedTab] Switch -> grid"))};a.addEventListener("shown.bs.tab",e),a.addEventListener("click",e)}}destroy(){this._unbindStateManagerEvents(),this.gridManager&&(this.gridManager.destroy(),this.gridManager=null),this.unifiedManager=null,this.state=null,this.initialized=!1,console.log("JadwalKegiatanApp destroyed")}}if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{(new A).initialize()});else{(new A).initialize()}
//# sourceMappingURL=jadwal-kegiatan-m1Rb7cwb.js.map
