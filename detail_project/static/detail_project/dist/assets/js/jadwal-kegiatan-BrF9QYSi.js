var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,n=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,i=(e,t,a)=>new Promise((s,n)=>{var i=e=>{try{l(a.next(e))}catch(t){n(t)}},o=e=>{try{l(a.throw(e))}catch(t){n(t)}},l=e=>e.done?s(e.value):Promise.resolve(e.value).then(i,o);l((a=a.apply(e,t)).next())});import{a as o,A as l,u as r}from"./grid-modules-DxQgn-T9.js";import"./vendor-ag-grid-CNpf5Dvm.js";class d{constructor(){this.state=null,this.eventManager=null,this.initialized=!1,this.agGridManager=null}initialize(){return i(this,arguments,function*(e={}){if(this.initialized)console.warn("JadwalKegiatanApp already initialized");else{console.log("ðŸš€ Initializing Jadwal Kegiatan App (Vite Build)");try{this._setupState(e),this._setupDomRefs(e),this._attachEvents(),yield this._loadInitialData(),this.initialized=!0,console.log("âœ… Jadwal Kegiatan App initialized successfully"),window.JadwalKegiatanApp=this}catch(t){throw console.error("âŒ Failed to initialize Jadwal Kegiatan App:",t),t}}})}_setupState(e){var t;const a=window.kelolaTahapanPageState||(null==(t=window.JadwalPekerjaanApp)?void 0:t.state);this.state=Object.assign({pekerjaanTree:[],timeColumns:[],tahapanList:[],timeColumnIndex:{},expandedNodes:new Set,modifiedCells:new Map,progressTotals:new Map,isDirty:!1,isLoading:!1,error:null,domRefs:{},apiEndpoints:{},projectId:null,projectName:"",projectStart:null,projectEnd:null,useAgGrid:!1,saveMode:"weekly",weekEndDay:6},a||{},e.initialState||{}),window.kelolaTahapanPageState=this.state,this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns)}_setupDomRefs(e){const t=Object.assign({root:document.getElementById("tahapan-grid-app"),leftThead:document.getElementById("left-thead"),rightThead:document.getElementById("right-thead"),leftTbody:document.getElementById("left-tbody"),rightTbody:document.getElementById("right-tbody"),leftPanelScroll:document.querySelector(".left-panel-scroll"),rightPanelScroll:document.querySelector(".right-panel-scroll"),timeHeaderRow:document.getElementById("time-header-row"),saveButton:document.getElementById("save-button")||document.getElementById("btn-save-all"),refreshButton:document.getElementById("refresh-button"),agGridContainer:document.getElementById("ag-grid-container")},e.domRefs||{});if(this.state.domRefs=t,!t.root)throw new Error("Root container #tahapan-grid-app tidak ditemukan");if(this._applyDataset(t.root),!t.leftTbody||!t.rightTbody)throw new Error("Critical DOM elements not found (leftTbody, rightTbody)")}_applyDataset(e){var t,a,s,n;if(!e||!e.dataset)return;const{dataset:i}=e;this.state.projectId=Number(i.projectId||this.state.projectId||0)||this.state.projectId,this.state.projectName=i.projectName||this.state.projectName,this.state.projectStart=i.projectStart||this.state.projectStart,this.state.projectEnd=i.projectEnd||this.state.projectEnd,this.state.saveMode=i.saveMode||i.timeScale||this.state.saveMode;const o=Number.parseInt(null!=(n=null!=(s=null!=(a=null!=(t=i.weekEndDay)?t:i.weekend)?a:i.weekEnd)?s:i.week_end_day)?n:"",10);Number.isNaN(o)||(this.state.weekEndDay=o);const l=Object.assign({base:i.apiBase||"",tahapan:i.apiTahapan||i.apiBase||"",listPekerjaan:i.apiListPekerjaan||"",volume:i.apiVolume||"",assignmentsBase:i.apiAssignmentsBase||"",save:i.apiSave||this.state.apiEndpoints&&this.state.apiEndpoints.save||this._getDefaultSaveEndpoint()},this.state.apiEndpoints||{});this.state.apiEndpoints=l,this.state.useAgGrid="true"===i.enableAgGrid||this.state.useAgGrid}_attachEvents(){const e={updateProgressIndicator:(e,t)=>{r(e,t,this.state)},showToast:this.showToast.bind(this)};this.state.useAgGrid?this.eventManager&&(this.eventManager.cleanup(),this.eventManager=null):this.eventManager=o(this.state,e),this._attachToolbarEvents(),this._initAgGridIfNeeded()}_attachToolbarEvents(){const e=this.state.domRefs.saveButton,t=this.state.domRefs.refreshButton;e&&e.addEventListener("click",()=>this.saveChanges()),t&&t.addEventListener("click",()=>this.refresh())}_initAgGridIfNeeded(){if(!this.state.useAgGrid)return;const e=this.state.domRefs.agGridContainer;e?this.agGridManager||(this.agGridManager=new l(this.state,{showToast:this.showToast.bind(this),onCellChange:e=>this._handleAgGridCellChange(e)}),this.agGridManager.mount(e)):console.warn("[JadwalKegiatanApp] AG Grid container not available")}_loadInitialData(){return i(this,null,function*(){var e,t,a;if((null==(e=this.state.pekerjaanTree)?void 0:e.length)>0){const e="function"==typeof console.groupCollapsed;return e&&console.groupCollapsed("[JadwalKegiatanApp] Using template dataset"),console.log("Preloaded pekerjaanTree items:",this.state.pekerjaanTree.length),console.log("Preloaded tahapanList items:",(null==(t=this.state.tahapanList)?void 0:t.length)||0),console.log("Preloaded timeColumns items:",(null==(a=this.state.timeColumns)?void 0:a.length)||0),e&&console.groupEnd(),void this._syncGridViews()}const{apiEndpoints:s,projectId:n}=this.state;if(!(null==s?void 0:s.tahapan)||!(null==s?void 0:s.listPekerjaan))return void console.warn("[JadwalKegiatanApp] API endpoints belum dikonfigurasi.");const i=`[JadwalKegiatanApp] API Load (project ${n||"unknown"})`,o="function"==typeof console.groupCollapsed;o?console.groupCollapsed(i):console.log(i),console.log("GET tahapan URL:",s.tahapan),console.log("GET list-pekerjaan URL:",s.listPekerjaan),console.log("Loading data from API..."),this.state.isLoading=!0;try{const[e,t]=yield Promise.all([this._fetchJson(s.tahapan),this._fetchJson(s.listPekerjaan)]),a=Array.isArray(e)?e:e.tahapan||e.results||e.data||e.items||[],i=Array.isArray(t)?t:t.tree||t.klasifikasi||t.data||t.results||[];e&&"object"==typeof e?console.log("Tahapan payload keys:",Object.keys(e)):console.log("Tahapan payload type:",typeof e),console.log("Resolved tahapanList length:",a.length),a.length&&console.log("Sample tahapan item:",a[0]),t&&"object"==typeof t?console.log("Pekerjaan payload keys:",Object.keys(t)):console.log("Pekerjaan payload type:",typeof t),console.log("Resolved pekerjaanTree length:",i.length),i.length&&console.log("Sample pekerjaan branch:",i[0]),this.state.tahapanList=a,this.state.pekerjaanTree=i,this.state.timeColumns=this._buildTimeColumns(a),this.state.timeColumnIndex=this._createTimeColumnIndex(this.state.timeColumns),console.log(`[JadwalKegiatanApp] Loaded ${i.length} pekerjaan, ${a.length} tahapan for project ${n}`)}catch(l){console.error("Failed to load data:",l),this.state.error=l,this.showToast("Gagal memuat data","danger"),console.log("Generated timeColumns:",this.state.timeColumns.length)}finally{o&&console.groupEnd(),this.state.isLoading=!1,this._syncGridViews()}})}saveChanges(){return i(this,null,function*(){var e;if(!this.state.modifiedCells||0===this.state.modifiedCells.size)return void this.showToast("Tidak ada perubahan untuk disimpan","info");const t=this._buildAssignmentsPayload();if(0!==t.length){console.log(`[JadwalKegiatanApp] Saving ${t.length} assignments (${this.state.modifiedCells.size} cells)`);try{const a=(null==(e=this.state.apiEndpoints)?void 0:e.save)||this._getDefaultSaveEndpoint(),s={assignments:t,mode:this._getSaveMode(),week_end_day:this._getWeekEndDay()},n=yield fetch(a,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this._getCsrfToken()},credentials:"same-origin",body:JSON.stringify(s)});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=yield n.json();this.state.modifiedCells.clear(),this.state.isDirty=!1,this.showToast("Perubahan berhasil disimpan","success"),console.log("[JadwalKegiatanApp] Save successful:",i)}catch(a){console.error("Save failed:",a),this.showToast("Gagal menyimpan: "+a.message,"danger")}}else this.showToast("Tidak ada assignments valid untuk disimpan","warning")})}refresh(){return i(this,null,function*(){if(this.state.isDirty){if(!confirm("Ada perubahan yang belum disimpan. Yakin ingin refresh?"))return}console.log("Refreshing data..."),this.state.modifiedCells.clear(),this.state.isDirty=!1,yield this._loadInitialData(),this.showToast("Data berhasil di-refresh","success")})}showToast(e,t="info",a=3e3){if("function"==typeof window.showToast)return void window.showToast(e,t,a);console.log(`[${t.toUpperCase()}] ${e}`);const s=document.createElement("div");s.className=`toast toast-${t}`,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.classList.add("show")},10),setTimeout(()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),300)},a)}_buildTimeColumns(e=[]){return Array.isArray(e)?e.map((e,t)=>{var a;const s=null!=(a=null==e?void 0:e.id)?a:`tahapan-${t+1}`,n=`col_${String(s).replace(/[^a-zA-Z0-9_-]/g,"_")}`,i=(null==e?void 0:e.nama)||(null==e?void 0:e.name)||`Tahapan ${t+1}`,o="number"==typeof(null==e?void 0:e.urutan)?e.urutan:Number.parseInt(null==e?void 0:e.urutan,10)||t;return{id:s,fieldId:n,label:i,order:o,weekNumber:o+1,startDate:(null==e?void 0:e.tanggal_mulai)||(null==e?void 0:e.start_date)||(null==e?void 0:e.startDate)||null,endDate:(null==e?void 0:e.tanggal_selesai)||(null==e?void 0:e.end_date)||(null==e?void 0:e.endDate)||null,isAutoGenerated:Boolean(null==e?void 0:e.is_auto_generated),generationMode:(null==e?void 0:e.generation_mode)||null}}):[]}_createTimeColumnIndex(e=[]){const t={};return(e||[]).forEach(e=>{const a=e.fieldId||e.id;a&&(t[a]=e)}),t}_getDefaultSaveEndpoint(){var e;const t=null==(e=this.state)?void 0:e.projectId;return t?`/detail_project/api/v2/project/${t}/assign-weekly/`:""}_fetchJson(e){return i(this,arguments,function*(e,i={}){if(!e)throw new Error("URL tidak boleh kosong saat memanggil _fetchJson");const o=yield fetch(e,((e,i)=>{for(var o in i||(i={}))a.call(i,o)&&n(e,o,i[o]);if(t)for(var o of t(i))s.call(i,o)&&n(e,o,i[o]);return e})({credentials:"same-origin"},i));if(!o.ok){const e=yield o.text().catch(()=>"");throw new Error(e||`HTTP ${o.status}: ${o.statusText}`)}return o.json()})}_syncGridViews(){this.agGridManager&&this.agGridManager.updateData({tree:this.state.pekerjaanTree||[],timeColumns:this.state.timeColumns||[]})}_buildAssignmentsPayload(){if(!this.state.modifiedCells||0===this.state.modifiedCells.size)return[];const e=[],t=this.state.timeColumnIndex||{};return this.state.modifiedCells.forEach((a,s)=>{const n=this._parseCellKey(s);if(!(null==n?void 0:n.pekerjaanId)||!n.fieldId)return;const i=t[n.fieldId];if(!i)return void console.warn("[JadwalKegiatanApp] Column metadata not found for",n.fieldId);const o=parseFloat(a);if(Number.isNaN(o))return;const l=i.weekNumber||i.order+1||1;e.push({pekerjaan_id:Number(n.pekerjaanId),week_number:l,proportion:Number(o.toFixed(2)),tahapan_id:i.id||null})}),e}_getSaveMode(){var e;const t=((null==(e=this.state)?void 0:e.saveMode)||"weekly").toLowerCase();return new Set(["daily","weekly","monthly","custom"]).has(t)?t:"weekly"}_getWeekEndDay(){var e;const t=Number(null==(e=this.state)?void 0:e.weekEndDay);return Number.isFinite(t)&&t>=0&&t<=6?t:6}_parseCellKey(e){if(!e||"string"!=typeof e)return null;const t=e.indexOf("-");return-1===t?{pekerjaanId:e,fieldId:null}:{pekerjaanId:e.slice(0,t),fieldId:e.slice(t+1)}}_getCsrfToken(){const e="csrftoken";let t=null;if(document.cookie&&""!==document.cookie){const a=document.cookie.split(";");for(let s=0;s<a.length;s++){const n=a[s].trim();if(n.substring(0,10)===e+"="){t=decodeURIComponent(n.substring(10));break}}}return t}_handleAgGridCellChange({cellKey:e,value:t,columnMeta:a}){if(!e)return;let s=t;"string"==typeof s&&(s=parseFloat(s)),Number.isNaN(s)&&(s=0),this.state.modifiedCells=this.state.modifiedCells||new Map,this.state.modifiedCells.set(e,s),this.state.isDirty=!0,(null==a?void 0:a.fieldId)&&this.state.timeColumnIndex&&(this.state.timeColumnIndex[a.fieldId]=a||this.state.timeColumnIndex[a.fieldId])}destroy(){this.eventManager&&(this.eventManager.cleanup(),this.eventManager=null),this.agGridManager&&(this.agGridManager.destroy(),this.agGridManager=null),this.state=null,this.initialized=!1,console.log("JadwalKegiatanApp destroyed")}}if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{(new d).initialize()});else{(new d).initialize()}
//# sourceMappingURL=jadwal-kegiatan-BrF9QYSi.js.map
